<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Spring IOC | 守株阁</title><meta name="author" content="magicliang"><meta name="copyright" content="magicliang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="总体的类图 spring-Ioc     Bean 工厂提供 IOC 基本功能，Context 是全功能的 BeanFactory，是应用程序的全部上下文。 扩展点和生命周期钩子 Spring的扩展点.xmind    加载顺序：  获取工厂 准备工厂 后处理工厂 InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation，">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring IOC">
<meta property="og:url" content="https://magicliang.github.io/2020/07/19/Spring-IOC/index.html">
<meta property="og:site_name" content="守株阁">
<meta property="og:description" content="总体的类图 spring-Ioc     Bean 工厂提供 IOC 基本功能，Context 是全功能的 BeanFactory，是应用程序的全部上下文。 扩展点和生命周期钩子 Spring的扩展点.xmind    加载顺序：  获取工厂 准备工厂 后处理工厂 InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation，">
<meta property="og:locale">
<meta property="og:image" content="https://magicliang.github.io/2020/07/19/Spring-IOC/spring-ioc-hiarachy.jpg">
<meta property="article:published_time" content="2020-07-19T04:03:57.000Z">
<meta property="article:modified_time" content="2026-01-24T07:32:06.950Z">
<meta property="article:author" content="magicliang">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://magicliang.github.io/2020/07/19/Spring-IOC/spring-ioc-hiarachy.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Spring IOC",
  "url": "https://magicliang.github.io/2020/07/19/Spring-IOC/",
  "image": "https://magicliang.github.io/2020/07/19/Spring-IOC/spring-ioc-hiarachy.jpg",
  "datePublished": "2020-07-19T04:03:57.000Z",
  "dateModified": "2026-01-24T07:32:06.950Z",
  "author": [
    {
      "@type": "Person",
      "name": "magicliang",
      "url": "https://magicliang.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://magicliang.github.io/2020/07/19/Spring-IOC/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: magicliang","link":"Link: ","source":"Source: 守株阁","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring IOC',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="守株阁" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/2020/07/19/Spring-IOC/spring-ioc-hiarachy.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">守株阁</span></a><a class="nav-page-title" href="/"><span class="site-name">Spring IOC</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Spring IOC</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-07-19T04:03:57.000Z" title="Created 2020-07-19 12:03:57">2020-07-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-01-24T07:32:06.950Z" title="Updated 2026-01-24 15:32:06">2026-01-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">11.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>57mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>总体的类图</h1>
<p><a href="spring-Ioc.vpp">spring-Ioc</a><br>
<img src="spring-ioc-hiarachy.jpg" alt="spring-ioc-hiarachy"><br>
<img src="BeanFactory%E7%9A%84%E7%BB%A7%E6%89%BF%E6%A0%91.png" alt="BeanFactory的继承树"><br>
<img src="%E5%B7%A5%E5%8E%82%E5%92%8C%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB.png" alt="工厂和注册表之间的关系"><br>
<img src="%E5%B7%A5%E5%8E%82%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87.png" alt="工厂与上下文"></p>
<p>Bean 工厂提供 IOC 基本功能，Context 是全功能的 BeanFactory，是应用程序的全部上下文。</p>
<h1>扩展点和生命周期钩子</h1>
<p><a href="Spring%E7%9A%84%E6%89%A9%E5%B1%95%E7%82%B9.xmind">Spring的扩展点.xmind</a><br>
<img src="Spring%E7%9A%84%E6%89%A9%E5%B1%95%E7%82%B9.png" alt="Spring的扩展点"><br>
<img src="spring-bean-lifecycle-1.png" alt="spring-bean-lifecycle-1.png"><br>
<img src="spring-bean-lifecycle-2.png" alt="spring-bean-lifecycle-2.png"></p>
<p>加载顺序：</p>
<ol>
<li>获取工厂</li>
<li>准备工厂</li>
<li>后处理工厂</li>
<li>InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation，返回 object。</li>
<li>构造器</li>
<li>InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation，返回布尔值。</li>
<li>populateBean（注入 @Autowired，类内第一个方法），实际上调用的是 InstantiationAwareBeanPostProcessor.postProcessProperties</li>
<li>InitializingBean:
<ul>
<li>各类 aware 方法注入</li>
<li>BeanPostProcessor.postProcessBeforeInitialization 的后处理器(@PostConsstruct)</li>
<li>afterPropertiesSet，类内第二个方法</li>
<li>init 方法，类内第三个方法</li>
<li>BeanPostProcessor.postProcessAfterInitialization</li>
<li>InstantiationAwareBeanPostProcessor.postProcessAfterInitialization，比较容易被忽略，它继承了父类的方法</li>
</ul>
</li>
</ol>
<p>关闭顺序：ContextClosedEvent -&gt; @PreDestroy -&gt; DisposableBean -&gt; destroy-method</p>
<p><img src="Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="Bean生命周期"></p>
<p>容易被混淆的是实例化和初始化，而且很多人没有意识到，这两者之间还存在一个明确，但经常被忘记的“属性赋值”阶段。</p>
<h2 id="关闭的生命周期钩子">关闭的生命周期钩子</h2>
<p>基本的原则是：</p>
<p>make bean ready -&gt; start working -&gt; stop working -&gt; destroy bean</p>
<p>其中线程的协调在中间两步。</p>
<p>对应在一般实现里扩展点的使用应该是：</p>
<ol>
<li>make bean ready：@PostConstruct 及以前的钩子</li>
<li>start working 的钩子是：ContextRefreshedEvent</li>
<li>stop working 的钩子是：ConxtextClosedEvent</li>
<li>destroy bean 的钩子是：@Predestroy 及以后的钩子</li>
</ol>
<h3 id="jvm-的裸钩子">JVM 的裸钩子</h3>
<h4 id="用法">用法</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 注册关闭钩子应该写在主线程开始 working 以前</span><br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">1000L</span>);<br>                    log.info(<span class="hljs-string">&quot;关闭钩子：又活了一个周期&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>                    log.info(<span class="hljs-string">&quot;interrupted: &quot;</span>, ex);<br>                &#125;<br>            &#125;<br>        &#125;));<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000L</span>);<br>                log.info(<span class="hljs-string">&quot;又活了一个周期&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>                log.info(<span class="hljs-string">&quot;interrupted: &quot;</span>, ex);<br><span class="hljs-comment">//                break;</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>在运行时，不断循环打印<code>15:06:04.856 [main] INFO com.magicliang.TestHook - 又活了一个周期</code>，使用普通的 kill，得到交替的输入：</p>
<blockquote>
<p>15:06:06.206 [Thread-1] INFO<br>
com.magicliang.TestHook - 关闭钩子：又活了一个周期<br>
15:06:06.861 [main] INFO com.magicliang.TestHook</p>
<ul>
<li>又活了一个周期</li>
</ul>
</blockquote>
<p>这证明几件事：</p>
<ol>
<li>kill 不会触发 interrupt。我们需要显式地把线程池的shutdown和 JVM 的 shutdown hook 关联起来。</li>
<li>主线程和关闭钩子可以无限同步运行，阻塞 jvm 的关闭，所以它们自身应该是可以最终终止的流程。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">atomicBoolean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">true</span>);<br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            atomicBoolean.set(<span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">1000L</span>);<br>                    log.info(<span class="hljs-string">&quot;关闭钩子：又活了一个周期&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>                    log.info(<span class="hljs-string">&quot;interrupted: &quot;</span>, ex);<br>                &#125;<br>            &#125;<br>        &#125;));<br>        <span class="hljs-keyword">while</span> (atomicBoolean.get()) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000L</span>);<br>                log.info(<span class="hljs-string">&quot;又活了一个周期&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>                log.info(<span class="hljs-string">&quot;interrupted: &quot;</span>, ex);<br><span class="hljs-comment">//                break;</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>输出：</p>
<blockquote>
<p>15:15:36.893 [main] INFO com.magicliang.TestHook -<br>
又活了一个周期 15:15:37.896 [main] INFO<br>
com.magicliang.TestHook - 又活了一个周期 15:15:38.901<br>
[main] INFO com.magicliang.TestHook - 又活了一个周期<br>
15:15:39.904 [main] INFO com.magicliang.TestHook -<br>
又活了一个周期 15:15:40.572 [Thread-1] INFO<br>
com.magicliang.TestHook - 关闭钩子：又活了一个周期 15:15:41.575<br>
[Thread-1] INFO com.magicliang.TestHook -<br>
关闭钩子：又活了一个周期</p>
</blockquote>
<p>因为关闭钩子还在不断执行，即使工作线程关闭，JVM 会一直不关闭。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">atomicBoolean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">true</span>);<br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            log.info(<span class="hljs-string">&quot;我只活一次&quot;</span>);<br>        &#125;));<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000L</span>);<br>                log.info(<span class="hljs-string">&quot;又活了一个周期&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>                log.info(<span class="hljs-string">&quot;interrupted: &quot;</span>, ex);<br><span class="hljs-comment">//                break;</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>特别地，如果使用平凡的 kill 命令，是 SIGTERM 退出：</p>
<blockquote>
<p>15:26:53.515 [main] INFO leads.system.com.magicliang.TestHook -<br>
又活了一个周期 15:26:54.520 [main] INFO<br>
leads.system.SpringApplicationMultiStartup - 又活了一个周期 15:26:54.987<br>
[Thread-1] INFO leads.system.SpringApplicationMultiStartup - 我只活一次</p>
<p>进程已结束,退出代码143 (interrupted by signal 15: SIGTERM)</p>
</blockquote>
<p>如果使用 idea 的正方形按钮退出，是 SIGINT 退出：</p>
<blockquote>
<p>15:28:10.508 [main] INFO leads.system.SpringApplicationMultiStartup -<br>
又活了一个周期 15:28:11.518 [main] INFO<br>
leads.system.SpringApplicationMultiStartup - 又活了一个周期 15:28:12.521<br>
[main] INFO leads.system.SpringApplicationMultiStartup - 又活了一个周期<br>
15:28:13.266 [Thread-1] INFO<br>
leads.system.SpringApplicationMultiStartup - 我只活一次</p>
<p>进程已结束,退出代码130 (interrupted by signal 2: SIGINT)</p>
</blockquote>
<p>最终结论，主线程不会导致 JVM 无法退出，关闭钩子会。</p>
<p>这个实现机制见 <a href="https://magicliang.github.io/2023/01/13/Java-%E5%8E%9F%E7%94%9F-API/#exit">System.exit</a>。</p>
<h3 id="spring-的钩子">Spring 的钩子</h3>
<p>在 AbstractApplicationContext 中，注册 JVM 的钩子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// AbstractApplicationContext 里的钩子，所有的 ConfigurableApplicationContext（作为 SPI 的主接口） 如果可以 cast 成 AbstractApplicationContext</span><br><br><span class="hljs-comment">// 利用了 JVM 钩子来挂载自身的框架函数，但这个钩子不常被调用。从一般教程来看，需要持有特定 context 的代码主动调用，看起来不会被生命周期钩子调用</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerShutdownHook</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.shutdownHook == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// No shutdown hook registered yet.</span><br>        <span class="hljs-built_in">this</span>.shutdownHook = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(SHUTDOWN_HOOK_THREAD_NAME) &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">synchronized</span> (startupShutdownMonitor) &#123;<br>                    doClose();<br>                &#125;<br>            &#125;<br>        &#125;;<br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-built_in">this</span>.shutdownHook);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br>        <span class="hljs-comment">// 实际关闭的入口</span><br>        doClose();<br>        <span class="hljs-comment">// If we registered a JVM shutdown hook, we don&#x27;t need it anymore now:</span><br>        <span class="hljs-comment">// We&#x27;ve already explicitly closed the context.</span><br>        <span class="hljs-comment">// 如果关闭成功，则在这一步关闭钩子，一个 context 只有一个统一的 Thread 作为钩子</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.shutdownHook != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().removeShutdownHook(<span class="hljs-built_in">this</span>.shutdownHook);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br>                <span class="hljs-comment">// ignore - VM is already shutting down</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 真关闭实现，但不要直接用这个实现，不然会和 shutdownHook 的重复执行产生冲突。 理论上我们所有的关闭钩子：ContextClosedEvent、DisposalBean、@PreDestroy都是从这里发出的。子类可以覆盖这个方法，也可以覆盖 onClose（这是被推荐的）</span><br><span class="hljs-comment">// 这个模板方法是值得我们学习的典范，一个复杂的框架全面铺开，需要好几个扩展点和抽象，而且高层次的一致抽象原则在这行代码里运用得淋漓尽致</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doClose</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Check whether an actual close attempt is necessary...</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.active.get() &amp;&amp; <span class="hljs-built_in">this</span>.closed.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>            logger.debug(<span class="hljs-string">&quot;Closing &quot;</span> + <span class="hljs-built_in">this</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!NativeDetector.inNativeImage()) &#123;<br>            LiveBeansView.unregisterApplicationContext(<span class="hljs-built_in">this</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// Publish shutdown event.</span><br>            <span class="hljs-comment">// 可以直接使用当前上下文当做 source context，注意这是在关闭前发出的事件，这让很多的 bean 在被销毁以前可以得知销毁事件开始了。如果关闭线程池要在这里关闭，这样可以停止 working。make bean ready -&gt; start working -&gt; stop working -&gt; destroy bean。如果可以分离的话，让全部的 stop working 早于全部的 bean destroy，则在这里实现关闭线程池是一个好的地方（位置 1）</span><br>            publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextClosedEvent</span>(<span class="hljs-built_in">this</span>));<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>            logger.warn(<span class="hljs-string">&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;</span>, ex);<br>        &#125;<br><br>        <span class="hljs-comment">// Stop all Lifecycle beans, to avoid delays during individual destruction.</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.lifecycleProcessor != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 有一种 Lifecycle beans，我们目前很少用到，但确实要先关闭</span><br>                <span class="hljs-comment">// 在这里我们也可以实现关闭线程池（位置 2）</span><br>                <span class="hljs-built_in">this</span>.lifecycleProcessor.onClose();<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                logger.warn(<span class="hljs-string">&quot;Exception thrown from LifecycleProcessor on context close&quot;</span>, ex);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// Destroy all cached singletons in the context&#x27;s BeanFactory.</span><br>        <span class="hljs-comment">// 包括 InitDestroyAnnotationBeanPostProcessor 调用 DisposableBeanAdapter，这个 bean 会反射调用 @PostConstruct，和 Disposal 的 destroy。这里的 bean 其实大部分是 singletonBean，而且底层会穿越 registry，证明管理 bean 的层次实际上是 application -&gt; context -&gt; factory -&gt; registry</span><br>        destroyBeans();<br><br>        <span class="hljs-comment">// Close the state of this context itself.</span><br>        closeBeanFactory();<br><br>        <span class="hljs-comment">// Let subclasses do some final clean-up if they wish...</span><br>        <span class="hljs-comment">// 要区分给子类用的钩子和给订阅者用的钩子。比如 ServletWebServerApplicationContext 会实现该勾子函数关闭内嵌的WebServer(Tomcat)。注意这个顺序，是先关闭内部资源，再关闭外部内容</span><br>        onClose();<br><br>        <span class="hljs-comment">// Reset local application listeners to pre-refresh state.</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyApplicationListeners != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.applicationListeners.clear();<br>            <span class="hljs-built_in">this</span>.applicationListeners.addAll(<span class="hljs-built_in">this</span>.earlyApplicationListeners);<br>        &#125;<br><br>        <span class="hljs-comment">// Switch to inactive.</span><br>        <span class="hljs-comment">// context 在这一步才算初始化完成</span><br>        <span class="hljs-built_in">this</span>.active.set(<span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>一个 @PreDestroy 的栈帧：</p>
<blockquote>
<p>[java.lang.Thread.getStackTrace(Thread.java:1559),<br>
com.magicliang.transaction.sys.DomainDrivenTransactionSysApplication<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mi>x</mi><mi>e</mi><mi>c</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>s</mi><mi>M</mi><mi>a</mi><mi>n</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">.</mi><mi>d</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>y</mi><mo stretchy="false">(</mo><mi>D</mi><mi>o</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>D</mi><mi>r</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>n</mi><mi>T</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>S</mi><mi>y</mi><mi>s</mi><mi>A</mi><mi>p</mi><mi>p</mi><mi>l</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mo>:</mo><mn>117</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>s</mi><mi>u</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>N</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>r</mi><mi>I</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi mathvariant="normal">.</mi><mi>i</mi><mi>n</mi><mi>v</mi><mi>o</mi><mi>k</mi><mi>e</mi><mn>0</mn><mo stretchy="false">(</mo><mi>N</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>s</mi><mi>u</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>N</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>r</mi><mi>I</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi mathvariant="normal">.</mi><mi>i</mi><mi>n</mi><mi>v</mi><mi>o</mi><mi>k</mi><mi>e</mi><mo stretchy="false">(</mo><mi>N</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>r</mi><mi>I</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mo>:</mo><mn>62</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>s</mi><mi>u</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>D</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>g</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>r</mi><mi>I</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi mathvariant="normal">.</mi><mi>i</mi><mi>n</mi><mi>v</mi><mi>o</mi><mi>k</mi><mi>e</mi><mo stretchy="false">(</mo><mi>D</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>g</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi>A</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>r</mi><mi>I</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mo>:</mo><mn>43</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mi mathvariant="normal">.</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>r</mi><mi>e</mi><mi>f</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>i</mi><mi>n</mi><mi>v</mi><mi>o</mi><mi>k</mi><mi>e</mi><mo stretchy="false">(</mo><mi>M</mi><mi>e</mi><mi>t</mi><mi>h</mi><mi>o</mi><mi>d</mi><mi mathvariant="normal">.</mi><mi>j</mi><mi>a</mi><mi>v</mi><mi>a</mi><mo>:</mo><mn>498</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>o</mi><mi>r</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>f</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi mathvariant="normal">.</mi><mi>b</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>y</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>n</mi><mi>n</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>I</mi><mi>n</mi><mi>i</mi><mi>t</mi><mi>D</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>y</mi><mi>A</mi><mi>n</mi><mi>n</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>B</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mi>P</mi><mi>r</mi><mi>o</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>o</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">ExecutorsManager.destroy(DomainDrivenTransactionSysApplication.java:117),
sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method),
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62),
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43),
java.lang.reflect.Method.invoke(Method.java:498),
org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">x</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord">.</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault">s</span><span class="mord mathdefault">A</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">7</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault">n</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mord">0</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault">n</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">6</span><span class="mord">2</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault">n</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">3</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord">.</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">h</span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">9</span><span class="mord">8</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord">.</span><span class="mord mathdefault">s</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">.</span><span class="mord mathdefault">b</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">s</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord">.</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">n</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">n</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault">A</span><span class="mord mathdefault">n</span><span class="mord mathdefault">n</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span>LifecycleElement.invoke(InitDestroyAnnotationBeanPostProcessor.java:389),<br>
org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor$LifecycleMetadata.invokeDestroyMethods(InitDestroyAnnotationBeanPostProcessor.java:347),<br>
org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor.postProcessBeforeDestruction(InitDestroyAnnotationBeanPostProcessor.java:177),<br>
org.springframework.beans.factory.support.DisposableBeanAdapter.destroy(DisposableBeanAdapter.java:197),<br>
org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroyBean(DefaultSingletonBeanRegistry.java:587),<br>
org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroySingleton(DefaultSingletonBeanRegistry.java:559),<br>
org.springframework.beans.factory.support.DefaultListableBeanFactory.destroySingleton(DefaultListableBeanFactory.java:1163),<br>
org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroySingletons(DefaultSingletonBeanRegistry.java:520),<br>
org.springframework.beans.factory.support.DefaultListableBeanFactory.destroySingletons(DefaultListableBeanFactory.java:1156),<br>
org.springframework.context.support.AbstractApplicationContext.destroyBeans(AbstractApplicationContext.java:1106),<br>
org.springframework.context.support.AbstractApplicationContext.doClose(AbstractApplicationContext.java:1075),<br>
org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.doClose(ServletWebServerApplicationContext.java:174),<br>
org.springframework.context.support.AbstractApplicationContext.close(AbstractApplicationContext.java:1021),<br>
org.springframework.boot.SpringApplicationShutdownHook.closeAndWait(SpringApplicationShutdownHook.java:145),<br>
java.lang.Iterable.forEach(Iterable.java:75),<br>
org.springframework.boot.SpringApplicationShutdownHook.run(SpringApplicationShutdownHook.java:114),<br>
java.lang.Thread.run(Thread.java:748)]</p>
</blockquote>
<ol>
<li>registerShutdownHook 在非 web 程序下不一定会被调用。我们当时遇到的情况是有人在构造器里写了 new Thread(()-&gt; abc()).run()。abc 里有个无限循环，导致了主启动线程无限卡死在这个位置，也就意味着 ContextRefresh 不能成功。造成死锁。<code>synchronized (this.startupShutdownMonitor)</code> 有三个地方：refresh()、registerShutdownHook()、close()。遇到这个问题最好在进入 synchronized 以前设断点，跑到 synchronized 以后<strong>使用 idea debugger 做一个 thread dump</strong>（一般的调试模式在线程的 suspend all 断点里是不接收 jstack 的连接的，即使预先连上了，jconsole 等方案也不能解读出线程的细节，看不到锁怎么被持有，是不是守护线程），看看本线程是不是在持有一个被其他线程持有的锁。这也提醒了我们，<strong>如果需要使用关闭钩子，关闭钩子最好做好命名，这样遇到死锁问题容易排查</strong>。</li>
<li>即使手动调用，钩子里的 Thread 也不一定会被触发。</li>
<li>当最后一个非守护线程退出时、使用特殊的信号给 JVM （ 理论上 CTRL + C，等于<code>kill -s INT 71914</code>。理论上 Spring Boot 程序应该响应这个信号。但即使 kill -s TERM 46838 也无法触发 Spring Boot 自己注册的钩子）、调用 System.exit 钩子应该被执行。这可能是非交互式 shell 的 shebang 没有写成 bash 导致的。</li>
<li>理论上钩子和钩子之间会并行执行（如果还有非守护线程，也会以乱序并行），所以最好全局使用一个钩子入口，然后在那个钩子里安排顺序。钩子执行不完，JVM 是不会关闭的。</li>
<li>idea 本身的断点在点击停止（正方形按钮）以后就不可用，需要依赖于日志了。</li>
<li><code>@PreDestroy or implementing the destroy() of DisposableBean gets executed only when we do ctrl+c or docker stop &lt;&gt;. whereas it won't execute if we do docker kill &lt;&gt; or stopping it directly from intelij IDE</code>。触发 Predestroy 的根因是 close 方法被调用了，close 方法被调用既包括 JVM 钩子，也包括上下文初始化异常被捕获。</li>
</ol>
<h4 id="springapplicationshutdownhook">SpringApplicationShutdownHook</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// class SpringApplicationShutdownHook implements Runnable</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">registerApplicationContext</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> &#123;<br>    addRuntimeShutdownHookIfNecessary();<br>    <span class="hljs-keyword">synchronized</span> (SpringApplicationShutdownHook.class) &#123;<br>        assertNotInProgress();<br>        context.addApplicationListener(<span class="hljs-built_in">this</span>.contextCloseListener);<br>        <span class="hljs-built_in">this</span>.contexts.add(context);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addRuntimeShutdownHookIfNecessary</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.shutdownHookAdded.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) &#123;<br>        addRuntimeShutdownHook();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">addRuntimeShutdownHook</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;SpringApplicationShutdownHook&quot;</span>));<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (AccessControlException ex) &#123;<br>        <span class="hljs-comment">// Not allowed in some environments</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 自己作为一个线程运行的 run</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    Set&lt;ConfigurableApplicationContext&gt; contexts;<br>    Set&lt;ConfigurableApplicationContext&gt; closedContexts;<br>    Set&lt;Runnable&gt; actions;<br>    <span class="hljs-comment">// 单类加载器内的全局锁</span><br>    <span class="hljs-keyword">synchronized</span> (SpringApplicationShutdownHook.class) &#123;<br>        <span class="hljs-built_in">this</span>.inProgress = <span class="hljs-literal">true</span>;<br>        contexts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-built_in">this</span>.contexts);<br>        closedContexts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-built_in">this</span>.closedContexts);<br>        actions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-built_in">this</span>.handlers.getActions());<br>    &#125;<br>    <span class="hljs-comment">// 本方法被执行了两次，closedContexts 是被监听下来的。第一次调用会增加一部分 context 进入 closedContexts</span><br>    contexts.forEach(<span class="hljs-built_in">this</span>::closeAndWait);<br>    closedContexts.forEach(<span class="hljs-built_in">this</span>::closeAndWait);<br>    actions.forEach(Runnable::run);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextClosedListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;ContextClosedEvent&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ContextClosedEvent event)</span> &#123;<br>        <span class="hljs-comment">// The ContextClosedEvent is fired at the start of a call to &#123;@code close()&#125;</span><br>        <span class="hljs-comment">// and if that happens in a different thread then the context may still be</span><br>        <span class="hljs-comment">// active. Rather than just removing the context, we add it to a &#123;@code</span><br>        <span class="hljs-comment">// closedContexts&#125; set. This is weak set so that the context can be GC&#x27;d once</span><br>        <span class="hljs-comment">// the &#123;@code close()&#125; method returns.</span><br>        <span class="hljs-comment">// 为了防止这个开头事件，把它加入到 weak map 里，这样如果它还能被引用的时候，JVM 钩子还能关闭它；如果它被 gc 了，则 JVM 钩子不会再关闭它</span><br>        <span class="hljs-keyword">synchronized</span> (SpringApplicationShutdownHook.class) &#123;<br>            <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> event.getApplicationContext();<br>            SpringApplicationShutdownHook.<span class="hljs-built_in">this</span>.contexts.remove(applicationContext);<br>            SpringApplicationShutdownHook.<span class="hljs-built_in">this</span>.closedContexts<br>                    .add((ConfigurableApplicationContext) applicationContext);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// 这个方法不怕被重复调用</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeAndWait</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!context.isActive()) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    context.close();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">waited</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (context.isActive()) &#123;<br>            <span class="hljs-keyword">if</span> (waited &gt; TIMEOUT) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>();<br>            &#125;<br>            Thread.sleep(SLEEP);<br>            waited += SLEEP;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (InterruptedException ex) &#123;<br>        Thread.currentThread().interrupt();<br>        logger.warn(<span class="hljs-string">&quot;Interrupted waiting for application context &quot;</span> + context + <span class="hljs-string">&quot; to become inactive&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (TimeoutException ex) &#123;<br>        logger.warn(<span class="hljs-string">&quot;Timed out waiting for application context &quot;</span> + context + <span class="hljs-string">&quot; to become inactive&quot;</span>, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="lifecycleprocessor">LifecycleProcessor</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">// 它本质上是为了管理全部的 Lifecycle bean 存在的，但自身也是 Lifecycle，这又是一个组合模式</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LifecycleProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Lifecycle</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Notification of context refresh, e.g. for auto-starting components.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRefresh</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">      * Notification of context close phase, e.g. for auto-stopping components.</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClose</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>缺省实现是在 DefaultLifecycleProcessor，它在<code>AbstractApplicatioContext</code>里的注册流程是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initLifecycleProcessor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> getBeanFactory();<br>    <span class="hljs-keyword">if</span> (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;<br>        <span class="hljs-built_in">this</span>.lifecycleProcessor =<br>                beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>            logger.trace(<span class="hljs-string">&quot;Using LifecycleProcessor [&quot;</span> + <span class="hljs-built_in">this</span>.lifecycleProcessor + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">DefaultLifecycleProcessor</span> <span class="hljs-variable">defaultProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultLifecycleProcessor</span>();<br>        defaultProcessor.setBeanFactory(beanFactory);<br>        <span class="hljs-built_in">this</span>.lifecycleProcessor = defaultProcessor;<br>        beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, <span class="hljs-built_in">this</span>.lifecycleProcessor);<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>            logger.trace(<span class="hljs-string">&quot;No &#x27;&quot;</span> + LIFECYCLE_PROCESSOR_BEAN_NAME + <span class="hljs-string">&quot;&#x27; bean, using &quot;</span> +<br>                    <span class="hljs-string">&quot;[&quot;</span> + <span class="hljs-built_in">this</span>.lifecycleProcessor.getClass().getSimpleName() + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>扩展写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringApplicationMultiStartup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultLifecycleProcessor</span> &#123;<br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postConstruct</span><span class="hljs-params">()</span> &#123;<br>        initLifecycleProcessor();<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initLifecycleProcessor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> getBeanFactory();<br>        <span class="hljs-keyword">if</span> (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;<br>            <span class="hljs-built_in">this</span>.lifecycleProcessor =<br>                    beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(<span class="hljs-string">&quot;Using LifecycleProcessor [&quot;</span> + <span class="hljs-built_in">this</span>.lifecycleProcessor + <span class="hljs-string">&quot;]&quot;</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">DefaultLifecycleProcessor</span> <span class="hljs-variable">defaultProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultLifecycleProcessor</span>();<br>            defaultProcessor.setBeanFactory(beanFactory);<br>            <span class="hljs-built_in">this</span>.lifecycleProcessor = defaultProcessor;<br>            beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, <span class="hljs-built_in">this</span>.lifecycleProcessor);<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(<span class="hljs-string">&quot;No &#x27;&quot;</span> + LIFECYCLE_PROCESSOR_BEAN_NAME + <span class="hljs-string">&quot;&#x27; bean, using &quot;</span> +<br>                        <span class="hljs-string">&quot;[&quot;</span> + <span class="hljs-built_in">this</span>.lifecycleProcessor.getClass().getSimpleName() + <span class="hljs-string">&quot;]&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClose</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.info(<span class="hljs-string">&quot;context closed, stop SpringApplicationMultiStartup&quot;</span>);<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                <span class="hljs-keyword">if</span> (!isRunningNow()) &#123;<br>                    log.info(<span class="hljs-string">&quot;**************, already stop, skip!&quot;</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-built_in">this</span>.stop();<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">super</span>.onClose();<br>        &#125;<br>    &#125;<br>&#125;<br>    <br>    <br></code></pre></td></tr></table></figure>
<p>参考：</p>
<p>1.<a target="_blank" rel="noopener" href="http://loveshisong.cn/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-11-22-Spring%E7%9A%84%E6%89%A9%E5%B1%95%E7%82%B9.html">《Spring的扩展点》</a><br>
2.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zrtqsk/p/3735273.html">《Spring Bean的生命周期（非常详细）》</a></p>
<h1>基本类型</h1>
<p>ResourceLoader + BeanDefinition + BeanDefinitionRegistry = BeanDefinitionReader。ResourceLoader 只提供资源的访问功能（path、classPath、URL），BeanDefinition 是bean的前身（name、class、BeanFactory），Registry 是存放 BeanDefinition 的地方，而 BeanDefinitionReader 负责执行这些读、加载和生成的流程。</p>
<p>外部调用关系是：</p>
<p>context.refresh -&gt; context.invokeBeanFactoryPostProcessors -&gt; PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors()) -&gt; PostProcessorRegistrationDelegate.invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup()) -&gt; ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry -&gt; ConfigurationClassPostProcessor.loadBeanDefinitionsForConfigurationClass -&gt; ConfigurationClassBeanDefinitionReader.loadBeanDefinitions</p>
<h2 id="resource">Resource</h2>
<p>Spring 的基本获取 Bean 的形式是获取配置文件（通常是 xml），而读取配置文件，首先要解决资源抽象问题。</p>
<p>Resource 首先是一种抽象，这种抽象解决配置怎么可读，配置所在的资源怎么定位的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Resource</span> &#123;<br>    InputStream <span class="hljs-title function_">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathResource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Resource</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> String path;<br>    <br>    <span class="hljs-keyword">private</span> ClassLoader classLoader;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathResource</span><span class="hljs-params">(String path)</span> &#123;<br>        <span class="hljs-built_in">this</span>(path, (ClassLoader)<span class="hljs-literal">null</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathResource</span><span class="hljs-params">(String path, ClassLoader classLoader)</span> &#123;<br>        <span class="hljs-built_in">this</span>.path = path;<br>        <span class="hljs-built_in">this</span>.classLoader = (classLoader != <span class="hljs-literal">null</span> ? classLoader : Thread.currentThread().getContextClassLoader());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> InputStream <span class="hljs-title function_">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">return</span> classLoader.getResourceAsStream(path);<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 来自于父类</span><br><span class="hljs-comment">     * This implementation returns a File reference for the underlying class path</span><br><span class="hljs-comment">     * resource, provided that it refers to a file in the file system.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> org.springframework.util.ResourceUtils#getFile(java.net.URL, String)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> File <span class="hljs-title function_">getFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> getURL();<br>        <span class="hljs-keyword">if</span> (url.getProtocol().startsWith(ResourceUtils.URL_PROTOCOL_VFS)) &#123;<br>            <span class="hljs-keyword">return</span> VfsResourceDelegate.getResource(url).getFile();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ResourceUtils.getFile(url, getDescription());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>除了 Resource 以外，还有另一种获取资源的方式，那就是通过 ResourceLoader：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceLoader</span> &#123;<br>    <br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASSPATH_URL_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;classpath:&quot;</span>;<br>    <br>    <span class="hljs-keyword">public</span> Resource <span class="hljs-title function_">getResource</span><span class="hljs-params">(String location)</span>&#123;<br>        <span class="hljs-keyword">if</span> (location.startsWith(CLASSPATH_URL_PREFIX)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(location.substring(CLASSPATH_URL_PREFIX.length()));<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(location);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="beandefinition">BeanDefinition</h2>
<p><img src="RootBeanDefinition%E7%9A%84%E6%9E%84%E9%80%A0.png" alt="RootBeanDefinition的构造"></p>
<p>从配置文件里映射出来的数据结构，首先绑定到 BeanDefinition 上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanDefinition</span> &#123;<br>    <span class="hljs-comment">// bean名称</span><br>    <span class="hljs-keyword">private</span> String beanName;<br>    <span class="hljs-comment">// bean的class对象</span><br>    <span class="hljs-keyword">private</span> Class beanClass;<br>    <span class="hljs-comment">// bean的class的包路径</span><br>    <span class="hljs-keyword">private</span> String beanClassName;<br>    <span class="hljs-comment">// bean依赖属性，就这，似乎就足以表达复杂的 XML 了</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">PropertyValues</span> <span class="hljs-variable">propertyValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyValues</span>();<br><br>    <span class="hljs-comment">// 某些定义会带入 FactoryBean</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>存储属性的地方使用了一个包装器类型来包含属性值列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">private</span> List&lt;PropertyValue&gt; propertyValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;PropertyValue&gt;();<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPropertyValue</span><span class="hljs-params">(PropertyValue propertyValue)</span> &#123;<br>        propertyValues.add(propertyValue);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> List&lt;PropertyValue&gt; <span class="hljs-title function_">getPropertyValues</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.propertyValues;<br>    &#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 这个 kv 值是可以被直接使用的</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyValue</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object value;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PropertyValue</span><span class="hljs-params">(String name, Object value)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.value = value;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h2 id="xmlbeandefinitionreader">XmlBeanDefinitionReader</h2>
<p>事实上现在的 BeanDefinitionReader 接口只有几个子类：</p>
<ul>
<li>AbstractBeanDefinitionReader</li>
<li>GroovyBeanDefinitionReader</li>
<li>PropertiesBeanDefinitionReader</li>
<li>XmlBeanDefinitionReader</li>
</ul>
<p>还有非 BeanDefinitionReader 的子类的其他定义读取器：AnnotatedBeanDefinitionReader/AnnotatedBeanDefinitionReader/ClassPathBeanDefinitionScanner。</p>
<p>ClassPathBeanDefinitionScanner 会读取各种注解和配置，进行 registerBean 操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlBeanDefinitionReader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionReader</span> &#123;<br>    <span class="hljs-comment">// BeanDefinition注册到BeanFactory接口</span><br>    <span class="hljs-keyword">private</span> BeanDefinitionRegistry registry;<br>    <span class="hljs-comment">// 资源载入类</span><br>    <span class="hljs-keyword">private</span> ResourceLoader resourceLoader;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">XmlBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry, ResourceLoader resourceLoader)</span> &#123;<br>        <span class="hljs-built_in">this</span>.registry = registry;<br>        <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(String location)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> getResourceLoader().getResource(location).getInputStream();<br>        doLoadBeanDefinitions(is);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> BeanDefinitionRegistry <span class="hljs-title function_">getRegistry</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> registry;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> ResourceLoader <span class="hljs-title function_">getResourceLoader</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> resourceLoader;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doLoadBeanDefinitions</span><span class="hljs-params">(InputStream is)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1. 获取 document的 factory</span><br>        <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();<br>        <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> factory.newDocumentBuilder();<br>        <span class="hljs-comment">// 2. 把资源转化为 w3c 规定的 document</span><br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> builder.parse(is);<br>        <span class="hljs-comment">// 3. 注册 bean 定义</span><br>        registerBeanDefinitions(document);<br>        is.close();<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(Document document)</span> &#123;<br>        <span class="hljs-type">BeanDefinitionDocumentReader</span> <span class="hljs-variable">documentReader</span> <span class="hljs-operator">=</span> createBeanDefinitionDocumentReader();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">countBefore</span> <span class="hljs-operator">=</span> getRegistry().getBeanDefinitionCount();<br>        documentReader.registerBeanDefinitions(doc, createReaderContext(resource));<br>        <span class="hljs-keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;<br>    &#125;<br><br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinition</span><span class="hljs-params">(Element ele)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> ele.getAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> ele.getAttribute(<span class="hljs-string">&quot;class&quot;</span>);<br>        <span class="hljs-keyword">if</span>(className==<span class="hljs-literal">null</span> || className.length()==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Configuration exception: &lt;bean&gt; element must has class attribute.&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(name==<span class="hljs-literal">null</span>||name.length()==<span class="hljs-number">0</span>)&#123;<br>            name = className;<br>        &#125;<br>        <span class="hljs-comment">// 实际上也是用 new 方法来生成 beanDefinition，把 attribute 转换成为 BeanDefinition 的属性</span><br>        <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinition</span>();<br>        beanDefinition.setBeanClassName(className);<br>        processBeanProperty(ele,beanDefinition);<br>        getRegistry().registerBeanDefinition(name, beanDefinition);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanProperty</span><span class="hljs-params">(Element ele, BeanDefinition beanDefinition)</span> &#123;<br>        <span class="hljs-type">NodeList</span> <span class="hljs-variable">childs</span> <span class="hljs-operator">=</span> ele.getElementsByTagName(<span class="hljs-string">&quot;property&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; childs.getLength(); i++) &#123;<br>            <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> childs.item(i);<br>            <span class="hljs-keyword">if</span>(node <span class="hljs-keyword">instanceof</span> Element)&#123;<br>                <span class="hljs-type">Element</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> (Element)node;<br>                <span class="hljs-comment">// 把内部的 attribute 转换为 PropertyValues</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> property.getAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> property.getAttribute(<span class="hljs-string">&quot;value&quot;</span>);<br>                <span class="hljs-keyword">if</span>(value!=<span class="hljs-literal">null</span> &amp;&amp; value.length()&gt;<span class="hljs-number">0</span>) &#123;<br>                    beanDefinition.getPropertyValues().addPropertyValue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyValue</span>(name, value));<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> property.getAttribute(<span class="hljs-string">&quot;ref&quot;</span>);<br>                    <span class="hljs-keyword">if</span>(ref==<span class="hljs-literal">null</span> || ref.length()==<span class="hljs-number">0</span>)&#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Configuration problem: &lt;property&gt; element for &quot;</span>+<br>                                name+<span class="hljs-string">&quot; must specify a value or ref.&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-type">BeanReference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanReference</span>(ref);<br>                    beanDefinition.getPropertyValues().addPropertyValue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyValue</span>(name, reference));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h2 id="beandefinitionregistry">BeanDefinitionRegistry</h2>
<p>BeanDefinitionRegistry 则是另一个维护一大套 map 的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanDefinitionRegistry</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>通常 BeanDefinitionRegistry 和 BeanFactory 被实现在同一个实现里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultListableBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractBeanFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableListableBeanFactory</span>,BeanDefinitionRegistry &#123;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, BeanDefinition&gt; beanDefinitionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, BeanDefinition&gt;();<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; beanDefinitionNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinition</span><span class="hljs-params">(String beanName,BeanDefinition beanDefinition)</span> &#123;<br>        beanDefinitionMap.put(beanName, beanDefinition);<br>        beanDefinitionNames.add(beanName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="beanfactory">BeanFactory</h2>
<p>BeanFactory 自有其继承体系：</p>
<ul>
<li>SingletonBeanRegistry: 定义了对单例缓存池相关的操作，如将bean注册到单例缓存池中</li>
<li>ConfigurableBeanFactory: 可配置的BeanFactory，定义了各种各样的配置能力，如bean的作用域，bean的classLoader,添加bean的后置处理器，设置bean的创建状态，销毁bean等等</li>
<li>AutowireCapableBeanFactory: 能进行自动装配的BeanFactory,这可能是我们最为熟悉的BeanFactory，定义了自动装配的类型(byName/byType)，createBean, autowireBean, 自动装配属性, populateBean, initializeBean, 对于与bean生命周期相关的方法都将在这里体现</li>
<li>ListableBeanFactory: 对BeanFactory的增强，定义了一系列根据beanType获取bean或者beanName的方法</li>
<li>ConfigurableListableBeanFactory: 对ConfigurableBeanFactory的增强，定义了忽略bean的类型、缓存bean定义、预实例化单例bean等方法</li>
<li>BeanDefinitionRegistry: bean定义注册器，定义了与bean定义相关的方法</li>
<li>DefaultSingletonBeanRegistry: 单例bean注册器，定义了三级缓存，其实就是三个Map属性</li>
<li>FactoryBeanRegistrySupport: 提供对FactoryBean的支持</li>
<li>AbstractBeanFactory: 实现了一系列操作IOC容器的功能，但最终的createBean依旧交由子类AbstractAutowireCapableBeanFactory完成</li>
<li>AbstractAutowireCapableBeanFactory: 实现了创建bean的功能，所有与创建bean的相关的功能都在这里</li>
<li>DefaultListableBeanFactory: 在以上父类的功能基础上实现了ConfigurableBeanFactory和BeanDefinitionRegistry接口，定义了一些存放Bean定义相关信息的Map</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactory</span> &#123;<br><br>    Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String beanName)</span>;<br>&#125;<br><br><span class="hljs-comment">// 这个抽象类是整个模板方法里最重要的</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableListableBeanFactory</span> &#123;<br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; singleObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, Object&gt;();<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> BeanDefinition <span class="hljs-title function_">getBeanDefinitionByName</span><span class="hljs-params">(String beanName)</span>;<br><br>    <span class="hljs-comment">// 所有的创建 bean 的方法的入口</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createInstance</span><span class="hljs-params">(BeanDefinition beanDefinition)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span>(beanDefinition.getBeanClass() != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> beanDefinition.getBeanClass().newInstance();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(beanDefinition.getBeanClassName() != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(beanDefinition.getBeanClassName());<br>            beanDefinition.setBeanClass(clazz);<br>            <span class="hljs-keyword">return</span> clazz.newInstance();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;bean Class &quot;</span> + beanDefinition.getBeanClassName() + <span class="hljs-string">&quot; not found&quot;</span>);<br>        &#125;<br>    &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;create bean &quot;</span> + beanDefinition.getBeanName() + <span class="hljs-string">&quot; failed&quot;</span>);<br>    &#125; <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;bean name for &quot;</span> + beanDefinition.getBeanName() + <span class="hljs-string">&quot; not define bean class&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 从 bean definition 里生成 bean，这个方法在 getBean 里才执行，它可以被优化成一个惰性求值的方法</span><br><span class="hljs-comment"> * Return an instance, which may be shared or independent, of the specified bean.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> name the name of the bean to retrieve</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> requiredType the required type of the bean to retrieve</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> args arguments to use when creating a bean instance using explicit arguments</span><br><span class="hljs-comment"> * (only applied when creating a new instance as opposed to retrieving an existing one)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> typeCheckOnly whether the instance is obtained for a type check,</span><br><span class="hljs-comment"> * not for actual use</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> an instance of the bean</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> BeansException if the bean could not be created</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name, <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; requiredType,</span><br><span class="hljs-params">        <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException     &#123;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> transformedBeanName(name);<br>    Object bean;<br><br>    <span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br>    <span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>            <span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>                logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +<br>                        <span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            &#125;<br>        &#125;<br>        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Fail if we&#x27;re already creating this bean instance:</span><br>        <span class="hljs-comment">// We&#x27;re assumably within a circular reference.</span><br>        <span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>        &#125;<br><br>        <span class="hljs-comment">// Check if bean definition exists in this factory.</span><br>        <span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> getParentBeanFactory();<br>        <span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;<br>            <span class="hljs-comment">// Not found -&gt; check parent.</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">nameToLookup</span> <span class="hljs-operator">=</span> originalBeanName(name);<br>            <span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;<br>                <span class="hljs-keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(<br>                        nameToLookup, requiredType, args, typeCheckOnly);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// Delegation to parent with explicit args.</span><br>                <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span><br>                <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br>            markBeanAsCreated(beanName);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br>            checkMergedBeanDefinition(mbd, beanName, args);<br><br>            <span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span><br>            String[] dependsOn = mbd.getDependsOn();<br>            <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;<br>                    <span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>                                <span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                    &#125;<br>                    registerDependentBean(dep, beanName);<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        getBean(dep);<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>                                <span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// Create bean instance.</span><br>            <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>                sharedInstance = getSingleton(beanName, () -&gt; &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>                        <span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br>                        <span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br>                        <span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>                        destroySingleton(beanName);<br>                        <span class="hljs-keyword">throw</span> ex;<br>                    &#125;<br>                &#125;);<br>                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>            &#125;<br><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br>                <span class="hljs-comment">// It&#x27;s a prototype -&gt; create a new instance.</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">prototypeInstance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    beforePrototypeCreation(beanName);<br>                    prototypeInstance = createBean(beanName, mbd, args);<br>                &#125;<br>                <span class="hljs-keyword">finally</span> &#123;<br>                    afterPrototypeCreation(beanName);<br>                &#125;<br>                bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>            &#125;<br><br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopes.get(scopeName);<br>                <span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;<br>                        beforePrototypeCreation(beanName);<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>                        &#125;<br>                        <span class="hljs-keyword">finally</span> &#123;<br>                            afterPrototypeCreation(beanName);<br>                        &#125;<br>                    &#125;);<br>                    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>                &#125;<br>                <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,<br>                            <span class="hljs-string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +<br>                            <span class="hljs-string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,<br>                            ex);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>            cleanupAfterBeanCreationFailure(beanName);<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125;<br>    &#125;<br><br>        <span class="hljs-comment">// Check if required type matches the type of the actual bean instance.</span><br>        <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">T</span> <span class="hljs-variable">convertedBean</span> <span class="hljs-operator">=</span> getTypeConverter().convertIfNecessary(bean, requiredType);<br>                <span class="hljs-keyword">if</span> (convertedBean == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());<br>                &#125;<br>                <span class="hljs-keyword">return</span> convertedBean;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (TypeMismatchException ex) &#123;<br>                <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                    logger.trace(<span class="hljs-string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; to required type &#x27;&quot;</span> +<br>                        ClassUtils.getQualifiedName(requiredType) + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> (T) bean;<br>    &#125;<br>&#125;<br>    <span class="hljs-comment">// 选定一个特定的类，在注解注入的地方做好断点（字段上可以做访问和修改断点），就能知道在整个 Spring 体系里在哪里触发了某段初始化流程</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br>        <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><br>    <span class="hljs-comment">// Instantiate the bean.</span><br>    <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>        instanceWrapper = <span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-comment">// 我们常说的实例化，instantiation 在这里</span><br>        instanceWrapper = createBeanInstance(beanName, mbd, args);<br>    &#125;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br>    <span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>        mbd.resolvedTargetType = beanType;<br>    &#125;<br><br>    <span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span><br>    <span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br>        <span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>                        <span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>            &#125;<br>            mbd.postProcessed = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span><br>    <span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp;<br>            isSingletonCurrentlyInCreation(beanName));<br>    <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>            logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br>                    <span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>        &#125;<br>        addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>    &#125;<br><br>    <span class="hljs-comment">// Initialize the bean instance.</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// autowire 在这里实现</span><br>        populateBean(beanName, mbd, instanceWrapper);<br>        <span class="hljs-comment">// 在这里实现 initialization，所以 autowire 比各种 init 钩子要早</span><br>        exposedObject = initializeBean(beanName, exposedObject, mbd);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;<br>            <span class="hljs-keyword">throw</span> (BeanCreationException) ex;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>                    mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Initialization of bean failed&quot;</span>, ex);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">earlySingletonReference</span> <span class="hljs-operator">=</span> getSingleton(beanName, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>                exposedObject = earlySingletonReference;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;<br>                String[] dependentBeans = getDependentBeans(beanName);<br>                Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(dependentBeans.length);<br>                <span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;<br>                    <span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>                        actualDependentBeans.add(dependentBean);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName,<br>                            <span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> +<br>                            StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +<br>                            <span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +<br>                            <span class="hljs-string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +<br>                            <span class="hljs-string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +<br>                            <span class="hljs-string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Register bean as disposable.</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>                mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Initialize the given bean instance, applying factory callbacks</span><br><span class="hljs-comment"> * as well as init methods and bean post processors.</span><br><span class="hljs-comment"> * &lt;p&gt;Called from &#123;<span class="hljs-doctag">@link</span> #createBean&#125; for traditionally defined beans,</span><br><span class="hljs-comment"> * and from &#123;<span class="hljs-doctag">@link</span> #initializeBean&#125; for existing bean instances.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> beanName the bean name in the factory (for debugging purposes)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> bean the new bean instance we may need to initialize</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mbd the bean definition that the bean was created with</span><br><span class="hljs-comment"> * (can also be &#123;<span class="hljs-doctag">@code</span> null&#125;, if given an existing bean instance)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the initialized bean instance (potentially wrapped)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> BeanNameAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> BeanClassLoaderAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> BeanFactoryAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #applyBeanPostProcessorsBeforeInitialization</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #invokeInitMethods</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #applyBeanPostProcessorsAfterInitialization</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">initializeBean</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> &#123;<br>    <span class="hljs-comment">// 在这里调用各种 aware 方法</span><br>    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>        AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;<br>            invokeAwareMethods(beanName, bean);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;, getAccessControlContext());<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        invokeAwareMethods(beanName, bean);<br>    &#125;<br><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">wrappedBean</span> <span class="hljs-operator">=</span> bean;<br>    <span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>        <span class="hljs-comment">// 在这里使用 BeforeInitialization 的 BeanPostProcessor</span><br>        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        invokeInitMethods(beanName, wrappedBean, mbd);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>                (mbd != <span class="hljs-literal">null</span> ? mbd.getResourceDescription() : <span class="hljs-literal">null</span>),<br>                beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>        <span class="hljs-comment">// 在这里使用 AfterInitialization 的 BeanPostProcessor，通常 aop 的 bean 在这里被 wrap</span><br>        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> wrappedBean;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在 AbstractAutowireCapableBeanFactory 里有 createBean 的一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br>        <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>        logger.trace(<span class="hljs-string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbdToUse</span> <span class="hljs-operator">=</span> mbd;<br><br>    <span class="hljs-comment">// Make sure bean class is actually resolved at this point, and</span><br>    <span class="hljs-comment">// clone the bean definition in case of a dynamically resolved Class</span><br>    <span class="hljs-comment">// which cannot be stored in the shared merged bean definition.</span><br>    Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);<br>    <span class="hljs-keyword">if</span> (resolvedClass != <span class="hljs-literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="hljs-literal">null</span>) &#123;<br>        mbdToUse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(mbd);<br>        mbdToUse.setBeanClass(resolvedClass);<br>    &#125;<br><br>    <span class="hljs-comment">// Prepare method overrides.</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        mbdToUse.prepareMethodOverrides();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(mbdToUse.getResourceDescription(),<br>                beanName, <span class="hljs-string">&quot;Validation of method overrides failed&quot;</span>, ex);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 注意，这里可以给 InstantiationAwareBeanPostProcessor 之类的后处理器一个机会，进行实例化的一个拦截，可以在这里注册一系列的自己的处理器</span><br>        <span class="hljs-comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);<br>        <span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> bean;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbdToUse.getResourceDescription(), beanName,<br>                <span class="hljs-string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">beanInstance</span> <span class="hljs-operator">=</span> doCreateBean(beanName, mbdToUse, args);<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>            logger.trace(<span class="hljs-string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> beanInstance;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;<br>        <span class="hljs-comment">// A previously detected exception with proper bean creation context already,</span><br>        <span class="hljs-comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>                mbdToUse.getResourceDescription(), beanName, <span class="hljs-string">&quot;Unexpected exception during bean creation&quot;</span>, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="defaultsingletonbeanregistry">DefaultSingletonBeanRegistry</h3>
<h4 id="三级缓存与循环依赖">三级缓存与循环依赖</h4>
<p>三级缓存的一个典型应用，是用来解决“单例的循环依赖”。</p>
<p><img src="%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E8%87%AA%E6%9F%A5%E8%A1%A8.png" alt="循环依赖自查表"></p>
<p>我们可以看到，先初始化的 bean 如果构造器里依赖了另一个循环依赖 bean，则循环依赖问题无法被三级缓存解决。</p>
<p><img src="%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98%E6%A6%82%E5%86%B5.png" alt="三级缓存概况"></p>
<p><img src="AB%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.png" alt="AB循环依赖"></p>
<p>创建A实例，实例化的时候把A对象⼯⼚放⼊三级缓存，表示A开始实例化了，虽然我这个对象还不完整，但是先曝光出来让大家知道（exposedBean）。</p>
<p><img src="%E4%B8%BB%E5%AF%B9%E8%B1%A1%E8%A2%AB%E6%94%BE%E5%85%A5%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png" alt="主对象被放入三级缓存"></p>
<p>A注⼊属性时，发现依赖B，此时B还没有被创建出来，所以去实例化B</p>
<p>同样，B注⼊属性时发现依赖A，它就会从缓存里找A对象。依次从⼀级到三级缓存查询A，从三级缓存通过对象⼯⼚拿到A，发现A虽然不太完善，但是存在，把A放⼊⼆级缓存，同时删除三级缓存中的A，此时，B已经实例化并且初始化完成，把B放入⼀级缓存。</p>
<p><img src="%E4%B8%BB%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AF%B9%E8%B1%A1%E5%8F%AF%E4%BB%A5%E8%A2%AB%E6%94%BE%E5%85%A5%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%EF%BC%8C%E8%80%8C%E9%9D%9E%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5%E7%9A%84%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%8C%E6%95%B4%E7%9A%84%E6%88%90%E5%91%98%E6%9E%84%E9%80%A0%E8%87%AA%E5%B7%B1%EF%BC%8C%E8%BF%9B%E8%80%8C%E6%94%BE%E5%85%A5%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98%E9%87%8C.png" alt="主初始化对象可以被放入二级缓存，而非构造器注入的对象，可以使用不完整的成员构造自己，进而放入一级缓存里"></p>
<p>接着A继续属性赋值，顺利从⼀级缓存拿到实例化且初始化完成的B对象，A对象创建也完成，删除⼆级缓存中的A，同时把A放⼊⼀级缓存。</p>
<p>最后，⼀级缓存中保存着实例化、初始化都完成的A、B对象。</p>
<p><img src="%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98%E5%85%A8%E8%A3%85%E6%BB%A1.png" alt="一级缓存全装满"></p>
<p><img src="%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E8%A7%A3%E9%87%8A.jpeg" alt="三级缓存的工作模式的另一种解释"></p>
<p>[5][为什么一定要有三级缓存？]</p>
<h2 id="applicationcontext">ApplicationContext</h2>
<p>BeanFactory 是 Spring 早期设计的抽象，应该尽量不被直接使用，当代的 Spring 应该使用更加现代的抽象 ApplicationContext，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanFactory</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>我们常见的子类有：</p>
<ul>
<li>ClasspathXmlApplicationContext</li>
<li>AnnotationConfigApplicationContext</li>
<li>GenericWebApplicationContext</li>
<li>AnnotationConfigServletWebApplicationContext(现代 SpringBoot 的 web 上下文就是这个)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClasspathXmlApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractApplicationContext</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String location;<br>    <br>    <span class="hljs-comment">// 这个构造器有一个很特别的地方，那就是在构造器里直接 refresh</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClasspathXmlApplicationContext</span><span class="hljs-params">(String location)</span> &#123;<br>        <span class="hljs-built_in">this</span>.location = location;<br>        <span class="hljs-keyword">try</span> &#123;<br>            refresh();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里引用的最重要的 refresh 方法，就是所有谈到 Spring 的文档里都必然谈到的 AbstractApplicationContext 里的 refresh()（经典的模板方法模式，所有的扩展点的顺序要依照它设定的方法来实现）。</p>
<p>如果说 BeanFactory 主要是 IOC 的容器的话，提供的主要是生命周期管理的功能。Context 则给 BeanFactory 外部加上了 BeanDefinitionRegistry 的管理、消息机制和事件机制的处理。对于 Spring 而言，初始化也是一种刷新，上下文的内容的加载，就是一种刷新：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br>            <span class="hljs-comment">// Prepare this context for refreshing </span><br>            <span class="hljs-comment">// 主要是设置开始时间以及标识active标志位为true</span><br>            prepareRefresh();<br><br>            <span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.    </span><br>            <span class="hljs-comment">// 先获取一个 bean 工厂，注意，在它的子类（比如 GenericApplicationContext）的实现里，总是先刷新一下 BeanFactory，然后加载配置文件，把自己的成员的 beanFactory 返回到这一层。ConfigurableListableBeanFactory 这个类型就是 Spring源码里的最抽象类型了，不是简单的 BeanFactory 接口，而且只和 DefaultListableBeanFactory 差了两层。</span><br>            <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br><br>            <span class="hljs-comment">// 先装配这个 beanFactory，这是在填充基础属性。</span><br>            <span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br>            prepareBeanFactory(beanFactory);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 没有生成任何的 bean，就先后处理这个 beanFactory，所以这里就会直接触发 bean 工厂的后处理，如 web 项目中配置 ServletContext，还有更多的 addBeanPostProcessor 和 ignoreDependencyInterface，这里是不用任何后处理器的后处理</span><br>                <span class="hljs-comment">// 这一部是留给子类扩展用的。</span><br>                <span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br>                postProcessBeanFactory(beanFactory);<br>                <span class="hljs-comment">// 一般到这一步为止，只有 SpringApplication 作为一个外部 bean 初始化了，其他都是各种 internalProcessor</span><br><br>                <span class="hljs-comment">// 实例化 + 调用注册好的 BeanFactoryPostProcessors，这是一大段后处理：</span><br>                <span class="hljs-comment">// 1. parse 所有的 configuration Class。这会带来各种 BeanFactoryPostProcessor。</span><br>                <span class="hljs-comment">// 2. 执行各种 BeanDefinitionReader，实际上是对各种 bean definition 的 PropertyValue 进行后处理（具体一点，在这里进行加载）。注意，这里是利用之前注册的扩展点来实现后处理，后处理里才真正使用生成了各种各样的 beanDefinition。所以我们实际上是在 BeanFactory 的后处理里，先进行 BeanDefinitionReistry 的后处理。</span><br>                <span class="hljs-comment">// 3. 并且初始化了大部分的类似 EntityManager 之类的内部资源管控 Bean - meta service bean。</span><br>                <span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br>                invokeBeanFactoryPostProcessors(beanFactory);<br>                <br>                <span class="hljs-comment">// 只是实例化，并注册 bean 后处理器，但不执行。</span><br>                <span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br>                registerBeanPostProcessors(beanFactory);<br>                <br>                <span class="hljs-comment">// 初始化消息源</span><br>                <span class="hljs-comment">// Initialize message source for this context.</span><br>                initMessageSource();<br><br>                <span class="hljs-comment">// 初始化应用事件多播器（和listener 不同）</span><br>                <span class="hljs-comment">// Initialize event multicaster for this context.</span><br>                initApplicationEventMulticaster();<br>                    <br>                <span class="hljs-comment">// 调用子类的刷新生命周期的中间扩展点，如初始化特殊的bean，一般在这里创建 tomcat</span><br>                <span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br>                onRefresh();<br>                <br>                <span class="hljs-comment">// 注册监听器，所有的 bean 初始化完了，才会初始化监听器</span><br>                <span class="hljs-comment">// Check for listener beans and register them.</span><br>                registerListeners();<br>                <br>                <span class="hljs-comment">// 对 BeanFactory 初始化进行收尾，这一步内部做了大量的 getBean 工作，可以说主要的非 config 和非 PostProcessor 管理的bean，所有的 autowired 的 bean 都是在这一步被创建出来的。bean后处理器，是bean创建前后才调用的，也是 BeanFactoryInitialization 的一部分。</span><br>                <span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>                finishBeanFactoryInitialization(beanFactory);<br>                <br>                <span class="hljs-comment">// 对刷新进行收尾，初始化生命周期，发布容器事件（如 ContextRefreshedEvent 是在这一步被发出的）</span><br>                <span class="hljs-comment">// Last step: publish corresponding event.</span><br>                finishRefresh();<br>            &#125;<br><br>            <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>                <span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>                    logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br>                            <span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>                &#125;<br><br>                <span class="hljs-comment">// 销毁已经创建的单例bean</span><br>                <span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>                destroyBeans();<br>                <br>                <span class="hljs-comment">// 重置active标识</span><br>                <span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>                cancelRefresh(ex);<br><br>                <span class="hljs-comment">// Propagate exception to caller.</span><br>                <span class="hljs-keyword">throw</span> ex;<br>            &#125;<br><br>            <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br>                <span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>                resetCommonCaches();<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Prepare this context for refreshing, setting its startup date and</span><br><span class="hljs-comment">     * active flag as well as performing any initialization of property sources.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareRefresh</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// Switch to active. </span><br>        <span class="hljs-comment">// 先把容器状态设置起来</span><br>        <span class="hljs-built_in">this</span>.startupDate = System.currentTimeMillis();<br>        <span class="hljs-built_in">this</span>.closed.set(<span class="hljs-literal">false</span>);<br>        <span class="hljs-built_in">this</span>.active.set(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(<span class="hljs-string">&quot;Refreshing &quot;</span> + <span class="hljs-built_in">this</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                logger.debug(<span class="hljs-string">&quot;Refreshing &quot;</span> + getDisplayName());<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 在这一步初始化所有的属性源，自定义的属性源和 configurer 在这一步会生效</span><br>        <span class="hljs-comment">// Initialize any placeholder property sources in the context environment.</span><br>        initPropertySources();<br><br>        <span class="hljs-comment">// Validate that all properties marked as required are resolvable:</span><br>        <span class="hljs-comment">// see ConfigurablePropertyResolver#setRequiredProperties</span><br>        getEnvironment().validateRequiredProperties();<br><br>        <span class="hljs-comment">// 初始化应用监听器缓存</span><br>        <span class="hljs-comment">// Store pre-refresh ApplicationListeners...</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyApplicationListeners == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.earlyApplicationListeners = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(<span class="hljs-built_in">this</span>.applicationListeners);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Reset local application listeners to pre-refresh state.</span><br>            <span class="hljs-built_in">this</span>.applicationListeners.clear();<br>            <span class="hljs-built_in">this</span>.applicationListeners.addAll(<span class="hljs-built_in">this</span>.earlyApplicationListeners);<br>        &#125;<br><br>        <span class="hljs-comment">// Allow for the collection of early ApplicationEvents,</span><br>        <span class="hljs-comment">// to be published once the multicaster is available...</span><br>        <span class="hljs-built_in">this</span>.earlyApplicationEvents = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>    &#125;<br>    <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * beanfactory 的基础后处理器的加载就在这里实现，注意，这里只是“准备”，各种后处理器和 bean 的加载还没有生效，最多只是 registerSingleton。这个方法是 Spring 内部动态注册自身内部 bean 的常用方法，</span><br><span class="hljs-comment">     * Configure the factory&#x27;s standard context characteristics,</span><br><span class="hljs-comment">     * such as the context&#x27;s ClassLoader and post-processors.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beanFactory the BeanFactory to configure</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br>        <span class="hljs-comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span><br>        beanFactory.setBeanClassLoader(getClassLoader());<br>        <span class="hljs-keyword">if</span> (!shouldIgnoreSpel) &#123;<br>            beanFactory.setBeanExpressionResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));<br>        &#125;<br>        beanFactory.addPropertyEditorRegistrar(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceEditorRegistrar</span>(<span class="hljs-built_in">this</span>, getEnvironment()));<br><br>        <span class="hljs-comment">// Configure the bean factory with context callbacks.</span><br>        <span class="hljs-comment">// 有些 BeanPostProcessor 是需要一个 context 作为上下文的</span><br>        beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationContextAwareProcessor</span>(<span class="hljs-built_in">this</span>));<br>        <span class="hljs-comment">// 这些接口以后都由 beanFactory 自行注入（BeanFactoryAware or ApplicationContext through ApplicationContextAware.），而不由 autowiring 来注入</span><br>        beanFactory.ignoreDependencyInterface(EnvironmentAware.class);<br>        beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);<br>        beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);<br>        beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);<br>        beanFactory.ignoreDependencyInterface(MessageSourceAware.class);<br>        beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);<br>        beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class);<br><br>        <span class="hljs-comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span><br>        <span class="hljs-comment">// MessageSource registered (and found for autowiring) as a bean.</span><br>        beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);<br>        beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="hljs-built_in">this</span>);<br>        beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="hljs-built_in">this</span>);<br>        beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="hljs-built_in">this</span>);<br><br>        <span class="hljs-comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span><br>        beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationListenerDetector</span>(<span class="hljs-built_in">this</span>));<br>        <span class="hljs-comment">// 感知是否是 graalvm 的镜像正在构建，以及当前的 beanFactory 是否已经包含 loadTimeWeaver 这个 bean</span><br>        <span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span><br>        <span class="hljs-keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;<br>            beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));<br>            <span class="hljs-comment">// Set a temporary ClassLoader for type matching.</span><br>            beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));<br>        &#125;<br>        <span class="hljs-comment">// 临时注册各种各样的单例 bean 作为全局配置的一部分</span><br>        <span class="hljs-comment">// Register default environment beans.</span><br>        <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;<br>            <span class="hljs-comment">// 因为 beanFactory 本身也实现了BeanDefinitionRegistry，所以在 beanFactory 也会更新</span><br>            beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;<br>            beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;<br>            beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123;<br>            beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">            ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;<br>        <span class="hljs-comment">// getBean 可能无意中触发 processors 的实例化，这里面有非常细的初始化流程，严格保证 order 语义不被破坏。这里大量使用 beanFactory.isTypeMatch 来保障所有的类型注解能够帮我们过滤出不同的列表</span><br>        <span class="hljs-comment">// WARNING: Although it may appear that the body of this method can be easily</span><br>        <span class="hljs-comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span><br>        <span class="hljs-comment">// of multiple lists and multiple passes over the names of processors is</span><br>        <span class="hljs-comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span><br>        <span class="hljs-comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span><br>        <span class="hljs-comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span><br>        <span class="hljs-comment">// in the wrong order.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// Before submitting a pull request (PR) to change this method, please review the</span><br>        <span class="hljs-comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span><br>        <span class="hljs-comment">// to ensure that your proposal does not result in a breaking change:</span><br>        <span class="hljs-comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span><br><br>        <span class="hljs-comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><br>        Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry) &#123;<br>            <span class="hljs-comment">// 在这里我们可以看到我们内部包装的 beanFactory 也是个 BeanDefinition 注册表</span><br>            <span class="hljs-type">BeanDefinitionRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> (BeanDefinitionRegistry) beanFactory;<br>            List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <span class="hljs-comment">// 这里的 beanFactoryPostProcessors 是 context 的成员变量，证明注册也就是直接放在一个成员里而已</span><br>            <span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;<br>                <span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;<br>                    <span class="hljs-type">BeanDefinitionRegistryPostProcessor</span> <span class="hljs-variable">registryProcessor</span> <span class="hljs-operator">=</span><br>                            (BeanDefinitionRegistryPostProcessor) postProcessor;<br>                    registryProcessor.postProcessBeanDefinitionRegistry(registry);<br>                    registryProcessors.add(registryProcessor);<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    regularPostProcessors.add(postProcessor);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br>            <span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br>            <span class="hljs-comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span><br>            <span class="hljs-comment">// PriorityOrdered, Ordered, and the rest.</span><br>            List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <br>            <span class="hljs-comment">// 在这一步可以通过类型可以获取 beanNames</span><br>            <span class="hljs-comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><br>            String[] postProcessorNames =<br>                    beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>                <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>                    processedBeans.add(ppName);<br>                &#125;<br>            &#125;<br>             <span class="hljs-comment">// 对 Ordered 的注解缺省的比较器是 OrderComparator</span><br>            sortPostProcessors(currentRegistryProcessors, beanFactory);<br>            registryProcessors.addAll(currentRegistryProcessors);<br>            <span class="hljs-comment">// 在对 beanFactory 进行后处理之前，先对 registry 进行后处理，所以  BeanDefinitionRegistry、BeanFactory、Bean 的后处理是有严格顺序的。这个隐藏的 invoke 显示，没有单独的 BeanDefinitionRegistry post process</span><br>            <span class="hljs-comment">// 这里的各种 getApplicationStartup 是一种类似 Cat 的 business metric</span><br>            <span class="hljs-comment">// 我们在控制台里经常能看到的 doLoadBeanDefinitions 日志，都在这里面被打出来，各种 configuration bean 也是在这里面被生产出来的，第一个 currentRegistryProcessor 至少是 ConfigurationClassPostProcessor。在很多文献里，这里被称作“解析配置类”。我们对 configuration class 的解析，是通过执行这些类的 pp（后处理器）来实现的。</span><br>            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>            currentRegistryProcessors.clear();<br><br>            <span class="hljs-comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><br>            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>                <span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>                    processedBeans.add(ppName);<br>                &#125;<br>            &#125;<br>            sortPostProcessors(currentRegistryProcessors, beanFactory);<br>            registryProcessors.addAll(currentRegistryProcessors);<br>            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>            currentRegistryProcessors.clear();<br><br>            <span class="hljs-comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">reiterate</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">while</span> (reiterate) &#123;<br>                reiterate = <span class="hljs-literal">false</span>;<br>                postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>                    <span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) &#123;<br>                        currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>                        processedBeans.add(ppName);<br>                        reiterate = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br>                sortPostProcessors(currentRegistryProcessors, beanFactory);<br>                registryProcessors.addAll(currentRegistryProcessors);<br>                invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>                currentRegistryProcessors.clear();<br>            &#125;<br><br>            <span class="hljs-comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><br>            invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);<br>            invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);<br>        &#125;<br><br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Invoke factory processors registered with the context instance.</span><br>            invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);<br>        &#125;<br><br>        <span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br>        <span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span><br>        String[] postProcessorNames =<br>                beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><br>        <span class="hljs-comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span><br>        <span class="hljs-comment">// Ordered, and the rest.</span><br>        List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>            <span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) &#123;<br>                <span class="hljs-comment">// skip - already processed in first phase above</span><br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>                priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>                orderedPostProcessorNames.add(ppName);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                nonOrderedPostProcessorNames.add(ppName);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span><br>        sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>        invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);<br><br>        <span class="hljs-comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span><br>        List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());<br>        <span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;<br>            orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>        &#125;<br>        sortPostProcessors(orderedPostProcessors, beanFactory);<br>        <span class="hljs-comment">// 同样，invokeBeanFactoryPostProcessors 这个方法会被多次调用，有大量的基础 bean，比如各种 EntityManager 是在这里被 create 出来的</span><br>        invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);<br><br>        <span class="hljs-comment">// Finally, invoke all other BeanFactoryPostProcessors.</span><br>        List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());<br>        <span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;<br>            nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>        &#125;<br>        invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);<br><br>        <span class="hljs-comment">// Clear cached merged bean definitions since the post-processors might have</span><br>        <span class="hljs-comment">// modified the original metadata, e.g. replacing placeholders in values...</span><br>        beanFactory.clearMetadataCache();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>    processConfigBeanDefinitions(registry);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processConfigBeanDefinitions</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>    <span class="hljs-comment">// 放置候选配置类</span><br>    List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    String[] candidateNames = registry.getBeanDefinitionNames();<br>    <span class="hljs-comment">// 遍历之前注册的所有bean定义，找到其中的配置类，其实就是我们自己传进来的配置类</span><br>    <span class="hljs-keyword">for</span> (String beanName : candidateNames) &#123;<br>        <span class="hljs-comment">// ...省略校验过程...</span><br>        <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDef</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(beanName);<br>        <span class="hljs-comment">// 这里要注意，有 full 和 lite 两种类型</span><br>        <span class="hljs-comment">// 检查是否是有 @Configuration 注解的 BeanDifinition -&gt; full 类型的配置类 -&gt; 会把配置类替换成动态代理类</span><br>        <span class="hljs-comment">// 或者该类包含 @Component @ComponentScan @Import @ImportResource @Bean 注解的其中之一 -&gt; lite类型的配置类  -&gt; 不会替换成动态代理类。被 @Component 注解的类不能是接口。</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="hljs-built_in">this</span>.metadataReaderFactory)) &#123;<br>            configCandidates.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(beanDef, beanName));<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ....省略片段....</span><br>    <span class="hljs-comment">// 实例化一个配置类解析器</span><br>    <span class="hljs-type">ConfigurationClassParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>(<br>        <span class="hljs-built_in">this</span>.metadataReaderFactory, <span class="hljs-built_in">this</span>.problemReporter, <span class="hljs-built_in">this</span>.environment,<br>        <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.componentScanBeanNameGenerator, registry);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-comment">// 解析配置类</span><br>        parser.parse(candidates);<br>        parser.validate();<br>        <span class="hljs-comment">// parser.getConfigurationClasses()就是拿到刚刚解析完放到map中的配置类</span><br>        Set&lt;ConfigurationClass&gt; configClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(parser.getConfigurationClasses());<br>        configClasses.removeAll(alreadyParsed);<br><br>        <span class="hljs-comment">// 这里处理@Import导入的beanDefintion和配置类中的@Bean</span><br>        <span class="hljs-built_in">this</span>.reader.loadBeanDefinitions(configClasses);<br>        alreadyParsed.addAll(configClasses);<br>        <span class="hljs-comment">// 以下逻辑是找出未解析的配置类，如@Bean和ImportBeanDefinitionRegistrar所引入的</span><br>        candidates.clear();<br>        <span class="hljs-keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;<br>            String[] newCandidateNames = registry.getBeanDefinitionNames();<br>            Set&lt;String&gt; oldCandidateNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(candidateNames));<br>            Set&lt;String&gt; alreadyParsedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>            <span class="hljs-keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;<br>                alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());<br>            &#125;<br>            <span class="hljs-keyword">for</span> (String candidateName : newCandidateNames) &#123;<br>                <span class="hljs-keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;<br>                    <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(candidateName);<br>                    <span class="hljs-comment">// 将是配置类并且没有解析过的BeanDefinition放到候选集合中继续解析</span><br>                    <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="hljs-built_in">this</span>.metadataReaderFactory) &amp;&amp;<br>                        !alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;<br>                        candidates.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(bd, candidateName));<br>                    &#125;<br>                &#125;<br>            &#125;<br>            candidateNames = newCandidateNames;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">while</span> (!candidates.isEmpty());<br>    &#125;<br><br>    <span class="hljs-comment">// 一段自定义补完 BeanDefinitionRegistry 里缺少的本 bean 的定义的方法，这有点 visitor pattern 的味道</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>            <span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(BEAN_NAME)) &#123;<br>                <span class="hljs-comment">// 注意 rootBeanDefinition 和抽象 BeanDefinition 的关联关系</span><br>                <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">definition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder<br>                        .rootBeanDefinition(SharedMetadataReaderFactoryBean.class, SharedMetadataReaderFactoryBean::<span class="hljs-keyword">new</span>)<br>                        .getBeanDefinition();<br>                registry.registerBeanDefinition(BEAN_NAME, definition);<br>            &#125;<br>        &#125;<br>        <br>    <span class="hljs-comment">// 真正加载所有的 configuration 的地方，这内部会交叉运用各种 Reader 如：XmlBeanDefinitionReader</span><br>    <span class="hljs-built_in">this</span>.reader.loadBeanDefinitions(configClasses);<br><br>    <span class="hljs-comment">// 动态生成 tomcat 的方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> WebServer <span class="hljs-title function_">getWebServer</span><span class="hljs-params">(ServletContextInitializer... initializers)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.disableMBeanRegistry) &#123;<br>            Registry.disableRegistry();<br>        &#125;<br>        <span class="hljs-type">Tomcat</span> <span class="hljs-variable">tomcat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tomcat</span>();<br>        <span class="hljs-type">File</span> <span class="hljs-variable">baseDir</span> <span class="hljs-operator">=</span> (<span class="hljs-built_in">this</span>.baseDirectory != <span class="hljs-literal">null</span>) ? <span class="hljs-built_in">this</span>.baseDirectory : createTempDir(<span class="hljs-string">&quot;tomcat&quot;</span>);<br>        tomcat.setBaseDir(baseDir.getAbsolutePath());<br>        <span class="hljs-keyword">for</span> (LifecycleListener listener : <span class="hljs-built_in">this</span>.serverLifecycleListeners) &#123;<br>            tomcat.getServer().addLifecycleListener(listener);<br>        &#125;<br>        <span class="hljs-type">Connector</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Connector</span>(<span class="hljs-built_in">this</span>.protocol);<br>        connector.setThrowOnFailure(<span class="hljs-literal">true</span>);<br>        tomcat.getService().addConnector(connector);<br>        customizeConnector(connector);<br>        tomcat.setConnector(connector);<br>        tomcat.getHost().setAutoDeploy(<span class="hljs-literal">false</span>);<br>        configureEngine(tomcat.getEngine());<br>        <span class="hljs-keyword">for</span> (Connector additionalConnector : <span class="hljs-built_in">this</span>.additionalTomcatConnectors) &#123;<br>            tomcat.getService().addConnector(additionalConnector);<br>        &#125;<br>        prepareContext(tomcat.getHost(), initializers);<br>        <span class="hljs-keyword">return</span> getTomcatWebServer(tomcat);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在这里把所有的非 lazy 的单例给初始化了，我们的各种 Service、Component 在这里被初始化</span><br><span class="hljs-comment">     * Finish the initialization of this context&#x27;s bean factory,</span><br><span class="hljs-comment">     * initializing all remaining singleton beans.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br>        <span class="hljs-comment">// Initialize conversion service for this context.</span><br>        <span class="hljs-keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;<br>                beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;<br>            beanFactory.setConversionService(<br>                    beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));<br>        &#125;<br><br>        <span class="hljs-comment">// Register a default embedded value resolver if no BeanFactoryPostProcessor</span><br>        <span class="hljs-comment">// (such as a PropertySourcesPlaceholderConfigurer bean) registered any before:</span><br>        <span class="hljs-comment">// at this point, primarily for resolution in annotation attribute values.</span><br>        <span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;<br>            beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));<br>        &#125;<br><br>        <span class="hljs-comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br>        String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;<br>            getBean(weaverAwareName);<br>        &#125;<br><br>        <span class="hljs-comment">// Stop using the temporary ClassLoader for type matching.</span><br>        beanFactory.setTempClassLoader(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// Allow for caching all bean definition metadata, not expecting further changes.</span><br>        beanFactory.freezeConfiguration();<br><br>        <span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>        beanFactory.preInstantiateSingletons();<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>对 bean 的管理的全流程</h1>
<p><img src="bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="bean的生命周期"><br>
<a href="bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.xmind">bean的生命周期.xmind</a><br>
<img src="%E5%88%9B%E5%BB%BAbean.png" alt="创建bean"><br>
<img src="bean%E7%9A%84%E6%9E%84%E9%80%A0%E6%B5%81%E7%A8%8B.png" alt="bean的构造流程"><br>
<img src="%E9%94%80%E6%AF%81bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E6%89%A9%E5%B1%95%E7%82%B9.png" alt="销毁bean生命周期的扩展点"><br>
<img src="BeanFactory%E7%94%9F%E4%BA%A7Bean%E7%9A%84%E8%BF%87%E7%A8%8B%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84.png" alt="BeanFactory生产Bean的过程是怎样的"></p>
<h2 id="beanprostprocessor-体系">BeanProstProcessor 体系</h2>
<p>ApplicationContexts 可以在其 BeanDefinition 中自动检测 BeanPostProcessor Bean，并将其应用于随后创建的所有 Bean 实例。</p>
<p><img src="BeanProstProcessor%E7%BB%A7%E6%89%BF%E6%A0%91.jpeg" alt="BeanProstProcessor继承树"><br>
<img src="BeanProcessor%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B.jpeg" alt="BeanProcessor主要流程"><br>
<img src="MergedBeanDefinitionPostProcessor.jpeg" alt="MergedBeanDefinitionPostProcessor"><br>
<img src="SmartInstantiationAwareBeanPostProcessor.jpeg" alt="SmartInstantiationAwareBeanPostProcessor"><br>
<img src="DestructionAwareBeanPostProcessor.jpeg" alt="DestructionAwareBeanPostProcessor"></p>
<h2 id="如何实现自动装配？">如何实现自动装配？</h2>
<p>对于 AutoWired 而言，答案是使用 AutowiredAnnotationBeanPostProcessor 的生命周期钩子。可见，我们所有的 field injection 相关的注入，都要考虑 BeanPostProcessor 的钩子方法进行扩展。</p>
<p>对于 field injection，最关键的方法是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 它是被 populateBean 这个方法调用的</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title function_">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> &#123;<br>    <span class="hljs-type">InjectionMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findAutowiringMetadata(beanName, bean.getClass(), pvs);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 这里的 pvs 就是我们要注入的真正的值。这里的 InjectionMetadata 很容易实现为自己的一个子类，至少要实现里头类似 getResource之类的钩子</span><br>        metadata.inject(bean, beanName, pvs);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Injection of autowired dependencies failed&quot;</span>, ex);<br>    &#125;<br>    <span class="hljs-keyword">return</span> pvs;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>和之前我设计和实现的缓存注入的思路是一样的，实际上所有的动态注入的 annotation 都应该这样设计，才能满足 Spring 的依赖管理的布局。</p>
<p>这个流程需要看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title function_">createBeanInstance</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> &#123;<br>        <span class="hljs-comment">// Make sure bean class is actually resolved at this point.</span><br>        Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);<br><br>        <span class="hljs-keyword">if</span> (beanClass != <span class="hljs-literal">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>                    <span class="hljs-string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());<br>        &#125;<br><br>        Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();<br>        <span class="hljs-keyword">if</span> (instanceSupplier != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);<br>        &#125;<br>        <br>        <span class="hljs-comment">// @Bean 类型的工厂方法的调用入口在这里</span><br>        <span class="hljs-keyword">if</span> (mbd.getFactoryMethodName() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);<br>        &#125;<br><br>        <span class="hljs-comment">// Shortcut when re-creating the same bean...</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">resolved</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">autowireNecessary</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (args == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br>                <span class="hljs-keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="hljs-literal">null</span>) &#123;<br>                    resolved = <span class="hljs-literal">true</span>;<br>                    autowireNecessary = mbd.constructorArgumentsResolved;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (resolved) &#123;<br>            <span class="hljs-keyword">if</span> (autowireNecessary) &#123;<br>                <span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// Candidate constructors for autowiring?</span><br>        Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);<br>        <span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||<br>                mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;<br>            <span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);<br>        &#125;<br><br>        <span class="hljs-comment">// Preferred constructors for default construction?</span><br>        ctors = mbd.getPreferredConstructors();<br>        <span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="hljs-literal">null</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// No special handling: simply use no-arg constructor.</span><br>        <span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>    &#125;<br></code></pre></td></tr></table></figure>
<h1>Spring Boot 的初始化流程</h1>
<h2 id="application-视角">Application 视角</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-comment">// 注意，Application 本身是一个比 Context 更大的概念</span><br>    <span class="hljs-comment">// 生成一个 SpringApplication，通过 run 获得一个 ConfigurableApplicationContext</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConfigurableApplicationContext <span class="hljs-title function_">run</span><span class="hljs-params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(primarySources).run(args);<br>&#125;<br><br>    <span class="hljs-meta">@SuppressWarnings(&#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SpringApplication</span><span class="hljs-params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;<br>        <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;<br>        Assert.notNull(primarySources, <span class="hljs-string">&quot;PrimarySources must not be null&quot;</span>);<br>        <span class="hljs-built_in">this</span>.primarySources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));<br>        <span class="hljs-built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();<br>        <span class="hljs-built_in">this</span>.bootstrapRegistryInitializers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<br>                getSpringFactoriesInstances(BootstrapRegistryInitializer.class));<br>        setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));<br>        setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));<br>        <span class="hljs-comment">// spring boot 获取主类的方法很妙</span><br>        <span class="hljs-built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; deduceMainApplicationClass() &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            StackTraceElement[] stackTrace = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>().getStackTrace();<br>            <span class="hljs-keyword">for</span> (StackTraceElement stackTraceElement : stackTrace) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;main&quot;</span>.equals(stackTraceElement.getMethodName())) &#123;<br>                    <span class="hljs-keyword">return</span> Class.forName(stackTraceElement.getClassName());<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>            <span class="hljs-comment">// Swallow and continue</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Run the Spring application, creating and refreshing a new</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> ApplicationContext&#125;.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args the application arguments (usually passed from a Java main method)</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a running &#123;<span class="hljs-doctag">@link</span> ApplicationContext&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ConfigurableApplicationContext <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();<br>        <span class="hljs-type">DefaultBootstrapContext</span> <span class="hljs-variable">bootstrapContext</span> <span class="hljs-operator">=</span> createBootstrapContext();<br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 确定 awt 的相关无窗体配置</span><br>        configureHeadlessProperty();<br>        <span class="hljs-type">SpringApplicationRunListeners</span> <span class="hljs-variable">listeners</span> <span class="hljs-operator">=</span> getRunListeners(args);<br>        listeners.starting(bootstrapContext, <span class="hljs-built_in">this</span>.mainApplicationClass);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ApplicationArguments</span> <span class="hljs-variable">applicationArguments</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultApplicationArguments</span>(args);<br>            <span class="hljs-comment">// activeProfiles、defaultProfile、propertySource</span><br>            <span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> prepareEnvironment(listeners, bootstrapContext, applicationArguments);<br>            configureIgnoreBeanInfo(environment);<br>            <span class="hljs-type">Banner</span> <span class="hljs-variable">printedBanner</span> <span class="hljs-operator">=</span> printBanner(environment);<br>            context = createApplicationContext();<br>            context.setApplicationStartup(<span class="hljs-built_in">this</span>.applicationStartup);<br>            <span class="hljs-comment">// 设置一些基础的环境，给 context 增加一些单例 bean 的注册信息，增加一些 beanFactory 的后处理器和 bean 的后处理器</span><br>            prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);<br>            <span class="hljs-comment">// 这里可以说是 Spring 的真正初始化全流程了，是在 context自身的 refresh 方法调用以前，先装一个钩子：shutdownHook.registerApplicationContext(context); 关闭钩子一开始就是个本 Application 的成员变量</span><br>            refreshContext(context);<br>            afterRefresh(context, applicationArguments);<br>            <span class="hljs-type">Duration</span> <span class="hljs-variable">timeTakenToStartup</span> <span class="hljs-operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logStartupInfo) &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">StartupInfoLogger</span>(<span class="hljs-built_in">this</span>.mainApplicationClass).logStarted(getApplicationLog(), timeTakenToStartup);<br>            &#125;<br>            listeners.started(context, timeTakenToStartup);<br>            <span class="hljs-comment">// 我们自己定义的 runner 其实可以被分为两类，ApplicationRunner 和 CommandLineRunner，这里统一使用 applicationArguments 来运行了，底层有 getBean 的方法</span><br>            callRunners(context, applicationArguments);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>            handleRunFailure(context, ex, listeners);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(ex);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Duration</span> <span class="hljs-variable">timeTakenToReady</span> <span class="hljs-operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);<br>            listeners.ready(context, timeTakenToReady);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>            handleRunFailure(context, ex, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(ex);<br>        &#125;<br>        <span class="hljs-keyword">return</span> context;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>ServletWebServerApplicationContext 里有调用父类的刷新方法和创建 WebServer 的流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">super</span>.refresh();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (RuntimeException ex) &#123;<br>        <span class="hljs-type">WebServer</span> <span class="hljs-variable">webServer</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.webServer;<br>        <span class="hljs-keyword">if</span> (webServer != <span class="hljs-literal">null</span>) &#123;<br>            webServer.stop();<br>        &#125;<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// 这个方法是被父类 refresh 调用进来的</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRefresh</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">super</span>.onRefresh();<br>    <span class="hljs-keyword">try</span> &#123;<br>        createWebServer();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationContextException</span>(<span class="hljs-string">&quot;Unable to start web server&quot;</span>, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="context-refresh-的全流程">Context Refresh 的全流程</h2>
<p><img src="%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B%E6%8B%86%E8%A7%A3Context%E5%88%B7%E6%96%B0%E7%9A%84%E6%B5%81%E7%A8%8B.jpeg" alt="自顶向下拆解Context刷新的流程"></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/269086109?utm_id=0">出处</a>。讲 import 和 componentScan 讲得很好，这一流程实际上是 ConfigurationClassPostProcessorconfiguration.processConfigBeanDefinitions 的一部分。也要关注 ConfigurationClassParser/ConfigurationClassBeanDefinitionReader/ComponentScanAnnotationParser/ClassPathBeanDefinitionsScanner。这里面还讲了 @MapperScan 和 MapperScannerRegistrar 怎样利用 BeanDefinition机制，让 constructor 和 FactoryBean 把 interface class 生成 Spring Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">definition = (GenericBeanDefinition) holder.getBeanDefinition();<br><span class="hljs-comment">// 将原来的接口mapper放到beanDefintion的构造方法参数中，以指定的构造方法实例化。</span><br>definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); <br><span class="hljs-comment">// 注意这里：将原来的beanClass替换成FactoryBean了！ bean definition 的扩展点在这。</span><br>definition.setBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBean.getClass());<br></code></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://magicliang.github.io">magicliang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://magicliang.github.io/2020/07/19/Spring-IOC/">https://magicliang.github.io/2020/07/19/Spring-IOC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/Spring/">Spring</a></div><div class="post-share"><div class="social-share" data-image="/2020/07/19/Spring-IOC/spring-ioc-hiarachy.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2020/03/29/Java-%E6%B3%A8%E8%A7%A3%E5%92%8C%E9%85%8D%E7%BD%AE/" title="Java 注解和配置"><img class="cover" src="/img/wall-paper-169.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-29</div><div class="info-item-2">Java 注解和配置</div></div><div class="info-2"><div class="info-item-1">Java 的原生注解 meta annotation @Inherited @Inherited 是一个元注解（annotations applied to other annotations 注解其他注解的注解），也是一个标记注解，@Inherited阐述了某个被标注的类型是被继承的。 **@Inherited annotation类型是被标注过的class的子类所继承。类并不从它所实现的接口继承annotation，方法并不从它所重载的方法继承annotation。**其查找过程是：反射 API 会在查找 @Inherited 标注的注解的时候，自底向上往继承树上方查找。 12345678910111213141516171819202122@Inherited@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.TYPE)public @interface MyAnnotation &#123;    String value() default &quot;Default Value&quot;;&#125;@MyA...</div></div></div></a><a class="pagination-related" href="/2020/04/20/Spring-%E6%A6%82%E8%A7%88/" title="Spring 概览"><img class="cover" src="/2020/04/20/Spring-%E6%A6%82%E8%A7%88/spring-framework-architecture.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-20</div><div class="info-item-2">Spring 概览</div></div><div class="info-2"><div class="info-item-1">Spring 起源于 2003 年，它作为 Java EE 平台规范的补充，而不是完全拥抱 specification。 Spring 可以指的是 entire family of projects。也可以单指 Spring Framework（换言之，Spring Framework 本身也只是 family 的一部分）。 Spring Framework 被模块化了，它的核心只包括 core container（主要解决依赖注入问题）。但是针对不同的应用架构，它提供不同的支持，包括 messaging、transactionl、persistence 和 web。这些模块原本命名为 “spring-core” 和 “spring-context”，在 Java 9 的 jigsaw 项目来临之时，也开始支持 module path，生成“自动模块名”清单项，并且定义语言级别的模块名，如&quot;spring.core&quot;、“spring.context”。 Spring 支持的 JSR 有：  Servlet API (JSR 340) WebSocket API ...</div></div></div></a><a class="pagination-related" href="/2020/04/05/Spring-AOP-%E7%AC%94%E8%AE%B0/" title="Spring AOP 笔记"><img class="cover" src="/2020/04/05/Spring-AOP-%E7%AC%94%E8%AE%B0/spring-aop-proxy-creation.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-05</div><div class="info-item-2">Spring AOP 笔记</div></div><div class="info-2"><div class="info-item-1">AOP 全景概览 核心问题定义 面向切面编程（Aspect-Oriented Programming，AOP）的核心目标是将横切关注点（Cross-cutting Concerns）从业务逻辑中分离出来。横切关注点是指那些散布在系统多个模块中的通用功能，如日志记录、事务管理、安全检查、性能监控等。在传统的面向对象编程中，这些功能往往需要在多个类中重复实现，导致代码冗余和耦合度增加。AOP 通过将这些横切关注点模块化为切面（Aspect），在不修改原有业务逻辑代码的情况下，实现对目标对象的增强。 核心概念速查表    概念 定义     Aspect 切面，横跨多个类的模块化关注点，通常由多个 Pointcut 和 Advice 组成   JoinPoint 连接点，程序执行过程中的特定位置，在 Spring AOP 中通常指方法执行点   Pointcut 切点，匹配 JoinPoint 的谓词表达式，定义 Advice 在何处执行   Advice 通知，切面在特定 JoinPoint 执行的动作，包括 Before、After、Around、AfterReturning、Af...</div></div></div></a><a class="pagination-related" href="/2020/08/02/%E5%B8%B8%E8%A7%81%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88/" title="常见的服务器调用堆栈"><img class="cover" src="/img/wall-paper-173.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-02</div><div class="info-item-2">常见的服务器调用堆栈</div></div><div class="info-2"><div class="info-item-1">自顶向下调用 $是内部类的意思 $$是由 Lambda 生成的内部类的意思。当然 Spring 的 CGLIB 可以自己控制 naming pattern。 内部类生成的类名后往往带有一个数字，这个数字表示编译器生成这个内部类的顺序  Thread.run() ThreadPoolExecutor$Worker.run() ThreadPoolExecutor.runWorker() Netty.DefaultServerHandler.run() Netty.DefaultServerHandler.handleRequest() ThriftServerPublisher$MTProccessor.process() Thrift 接口$Processor.方法名() com.sun.proxy$Proxy 数字.方法名() XXXServiceImpl$$EnhancerBySpringCGLIB$$1fb0b39f.被拦截的方法 ThriftInvoker.invoker() RhinoLimiterFilter.filter() ThriftInvoker.invoke...</div></div></div></a><a class="pagination-related" href="/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" title="Spring 与数据库"><img class="cover" src="/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/TransactionAspectSupport.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-19</div><div class="info-item-2">Spring 与数据库</div></div><div class="info-2"><div class="info-item-1">Java 执行事务的过程  1.获取连接 Connection con = DriverManager.getConnection() 2.开启事务con.setAutoCommit(true/false); 在 Spring 事务里（如 DataSourceTransactionManager 的 doBegin 方法）里，总是会显式地 con.setAutoCommit(false);（不然哪有事务可言）。 3.执行CRUD 4.提交事务/回滚事务 con.commit() / con.rollback(); 5.关闭连接 conn.close();  本文涉及到的类型的类图    Spring 的事务管理核心类型和流程 DataSource 不同的数据源诞生不同的 DataSource。默认的 TransactionManager 本身是期待一个名叫“datasource”的数据源的。 FactoryBean 不同的 DataSource 装入不同的 FactoryBean，比如 JPA 的 EntityManagerFactory。 PlatformTransaction...</div></div></div></a><a class="pagination-related" href="/2022/01/25/Spring-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%8B%A5%E5%B9%B2%E7%A7%8D%E5%B0%8F%E6%8A%80%E5%B7%A7/" title="Spring 数据库的若干种小技巧"><img class="cover" src="/img/wall-paper-82.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-25</div><div class="info-item-2">Spring 数据库的若干种小技巧</div></div><div class="info-2"><div class="info-item-1">常用命令 12345678910111213141516171819202122232425262728#  登录服务器mysql -u username -pdev -h hostname databaseName# 如何重命名一个 dbmysqldump emp &gt; emp.outmysql -e &quot;CREATE DATABASE employees;&quot;mysql employees &lt; emp.outmysql -e &quot;DROP DATABASE emp;&quot;# mysqldump 的用法mysqldump -u username -h hostname -ppassword databaseName &gt; /exportpath/dump.sql# 使用 brew 控制 mysqlbrew install mysqlbrew services restart mysql# 登录本机 root 用户mysql -uroot# 使用密码登录本机 root 用户mysql -uroot -p# 标准格式mysql -u US...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">总体的类图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">扩展点和生命周期钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90"><span class="toc-number">2.1.</span> <span class="toc-text">关闭的生命周期钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jvm-%E7%9A%84%E8%A3%B8%E9%92%A9%E5%AD%90"><span class="toc-number">2.1.1.</span> <span class="toc-text">JVM 的裸钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">用法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-%E7%9A%84%E9%92%A9%E5%AD%90"><span class="toc-number">2.1.2.</span> <span class="toc-text">Spring 的钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#springapplicationshutdownhook"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">SpringApplicationShutdownHook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lifecycleprocessor"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">LifecycleProcessor</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">基本类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#resource"><span class="toc-number">3.1.</span> <span class="toc-text">Resource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#beandefinition"><span class="toc-number">3.2.</span> <span class="toc-text">BeanDefinition</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xmlbeandefinitionreader"><span class="toc-number">3.3.</span> <span class="toc-text">XmlBeanDefinitionReader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#beandefinitionregistry"><span class="toc-number">3.4.</span> <span class="toc-text">BeanDefinitionRegistry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#beanfactory"><span class="toc-number">3.5.</span> <span class="toc-text">BeanFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#defaultsingletonbeanregistry"><span class="toc-number">3.5.1.</span> <span class="toc-text">DefaultSingletonBeanRegistry</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98%E4%B8%8E%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">三级缓存与循环依赖</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#applicationcontext"><span class="toc-number">3.6.</span> <span class="toc-text">ApplicationContext</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">对 bean 的管理的全流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#beanprostprocessor-%E4%BD%93%E7%B3%BB"><span class="toc-number">4.1.</span> <span class="toc-text">BeanProstProcessor 体系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%EF%BC%9F"><span class="toc-number">4.2.</span> <span class="toc-text">如何实现自动装配？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">Spring Boot 的初始化流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#application-%E8%A7%86%E8%A7%92"><span class="toc-number">5.1.</span> <span class="toc-text">Application 视角</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#context-refresh-%E7%9A%84%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">Context Refresh 的全流程</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2017 - 2026 By magicliang</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">簡</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/js/tw_cn.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="/"></script></div></body></html>