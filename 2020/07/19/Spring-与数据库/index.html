<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>Spring 与数据库 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="Spring 与数据库 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="Java 执行事务的过程 1.获取连接 Connection con &#x3D; DriverManager.getConnection()2.开启事务con.setAutoCommit(true&#x2F;false); 在 Spring 事务里（如 DataSourceTransactionManager 的 doBegin 方法）里，总是会显式地 con.setAutoCommit(false);（不然哪有事 - magicliang - 守株阁"><meta name="keywords" content="Java, Spring"><meta property="og:image" content="http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8-class-diagram1.png"><meta property="og:image" content="http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/transaction-manager-hiarachy.png"><meta property="og:image" content="http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/TransactionAspectSupport.png"><meta property="article:published_time" content="2020-07-19T01:47:18.000Z"><meta property="article:modified_time" content="2021-03-01T12:15:20.000Z"><meta property="og:updated_time" content="2021-03-01T12:15:20.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="Java, Spring"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/"
    },
    "headline": "Spring 与数据库 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2020-07-19T01:47:18.000Z",
    "dateModified": "2021-03-01T12:15:20.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "Java, Spring",
    "description": "Java 执行事务的过程 1.获取连接 Connection con = DriverManager.getConnection()2.开启事务con.setAutoCommit(true/false); 在 Spring 事务里（如 DataSourceTransactionManager 的 doBegin 方法）里，总是会显式地 con.setAutoCommit(false);（不然哪有事 - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=Spring 与数据库" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=Spring 与数据库&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=Spring 与数据库" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACkCAAAAAA83tqdAAACJ0lEQVR42u3a0VKDQBBE0fz/T+urFaH7DsYyMpeXaJmEg7ULPbP7+PgHx0OkSJEi3wD5CMfX95y9Hv189N3fAOS8ItciDwftyQlPB3m5kLMLT+cVuRv5/EXPrwmfJhO5mLPPiBSZkEcDP8HoxBEp8hXINqla6BApkiDTTXcSaNPFthu9SJGkIPrN15dViyJvhaxNI1DYtwsmhdyPumoib4VMA/msMZACRiu+yPlEiowP+RAE0sSIYZY2yUSuRJIbdRrcR4AUhEngELkb2b6ghYIrBVpq8osU2YLGZDGJhIpJ0BApki4g0UnWwkWdlCLXI9OAPnt/KtTSZ9CClsiVSLppiW5wak0usrFJpEhaXLWCi0yqyeYokXuR7aZNG6JXFgJEipxMnIYgBRt9GNSAIXINkix4EhQJDmQjqUiRrZF69cR0YQotgIpchSTFOt3o2TaBtveLFNmKrFb8t4k2beajhpXI2yNJQUT+RiYT2VAqUiTBtoYVDR/pgmoKErkGSQJoa2q1TUuTYk+kyBZwJ7+34EweBrGrJnIdsgVZNNjLRpLWRK0TR+QqJC280mYSsrkTL+6LXImcTIS2ME+DCg7GIlciJ4uTtFlAg0f9J4hci2zNp1fg280erz6IXIMkhdVks8iVoIFTkMj1yNHmDth8bYtUIkUSzCRIpILupV01kbdFkg0dqZmQwsmkCBMpkj7waZNgEoLrjV/kSuQ7HyJFihT5h8cn86L1ZHFkyv4AAAAASUVORK5CYII=" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">Spring 与数据库</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2020-07-19</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=Spring 与数据库&url=http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=Spring 与数据库&url=http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACkCAAAAAA83tqdAAACJ0lEQVR42u3a0VKDQBBE0fz/T+urFaH7DsYyMpeXaJmEg7ULPbP7+PgHx0OkSJEi3wD5CMfX95y9Hv189N3fAOS8ItciDwftyQlPB3m5kLMLT+cVuRv5/EXPrwmfJhO5mLPPiBSZkEcDP8HoxBEp8hXINqla6BApkiDTTXcSaNPFthu9SJGkIPrN15dViyJvhaxNI1DYtwsmhdyPumoib4VMA/msMZACRiu+yPlEiowP+RAE0sSIYZY2yUSuRJIbdRrcR4AUhEngELkb2b6ghYIrBVpq8osU2YLGZDGJhIpJ0BApki4g0UnWwkWdlCLXI9OAPnt/KtTSZ9CClsiVSLppiW5wak0usrFJpEhaXLWCi0yqyeYokXuR7aZNG6JXFgJEipxMnIYgBRt9GNSAIXINkix4EhQJDmQjqUiRrZF69cR0YQotgIpchSTFOt3o2TaBtveLFNmKrFb8t4k2beajhpXI2yNJQUT+RiYT2VAqUiTBtoYVDR/pgmoKErkGSQJoa2q1TUuTYk+kyBZwJ7+34EweBrGrJnIdsgVZNNjLRpLWRK0TR+QqJC280mYSsrkTL+6LXImcTIS2ME+DCg7GIlciJ4uTtFlAg0f9J4hci2zNp1fg280erz6IXIMkhdVks8iVoIFTkMj1yNHmDth8bYtUIkUSzCRIpILupV01kbdFkg0dqZmQwsmkCBMpkj7waZNgEoLrjV/kSuQ7HyJFihT5h8cn86L1ZHFkyv4AAAAASUVORK5CYII=" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Java-%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="post-toc-number">1.</span> <span class="post-toc-text">Java 执行事务的过程</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%9C%AC%E6%96%87%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%B1%BB%E5%9B%BE"><span class="post-toc-number">2.</span> <span class="post-toc-text">本文涉及到的类型的类图</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Spring-%E7%9A%84%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%9E%8B%E5%92%8C%E6%B5%81%E7%A8%8B"><span class="post-toc-number">3.</span> <span class="post-toc-text">Spring 的事务管理核心类型和流程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#DataSource"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">DataSource</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#FactoryBean"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">FactoryBean</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#PlatformTransactionManager"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">PlatformTransactionManager</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#TransactionDefinition"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">TransactionDefinition</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#TransactionStatus"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">TransactionStatus</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#TxAdviceBeanDefinitionParser"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">TxAdviceBeanDefinitionParser</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ProxyTransactionManagementConfiguration"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">ProxyTransactionManagementConfiguration</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#TransactionInterceptor"><span class="post-toc-number">3.8.</span> <span class="post-toc-text">TransactionInterceptor</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#TransactionAspectSupport"><span class="post-toc-number">3.9.</span> <span class="post-toc-text">TransactionAspectSupport</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#AbstractPlatformTransactionManager"><span class="post-toc-number">3.10.</span> <span class="post-toc-text">AbstractPlatformTransactionManager</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#DataSourceTransactionManager"><span class="post-toc-number">3.11.</span> <span class="post-toc-text">DataSourceTransactionManager</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#MyBatis-%E7%9A%84%E4%BA%8B%E5%8A%A1%E8%BE%B9%E7%95%8C"><span class="post-toc-number">4.</span> <span class="post-toc-text">MyBatis 的事务边界</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Spring-Boot-%E7%9A%84%E5%A2%9E%E5%BC%BA%E8%AE%BE%E8%AE%A1"><span class="post-toc-number">5.</span> <span class="post-toc-text">Spring Boot 的增强设计</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Spring-%E7%9A%84%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="post-toc-number">6.</span> <span class="post-toc-text">Spring 的声明式事务</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%83%E4%B8%AA%E4%BC%A0%E6%92%AD%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">七个传播性配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%8D%E5%90%8C%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E7%AD%96%E7%95%A5%E4%B8%8B%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1%E7%9A%84%E8%A1%8C%E4%B8%BA"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">不同事务传播策略下嵌套事务的行为</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%8F%AA%E8%AF%BB%E5%B1%9E%E6%80%A7"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">事务只读属性</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8B%E5%8A%A1%E8%B6%85%E6%97%B6"><span class="post-toc-number">6.4.</span> <span class="post-toc-text">事务超时</span></a></li></ol></li></ol></div>
                        
                    
                    <article id="post-content">
                        <h1 id="Java-执行事务的过程"><a href="#Java-执行事务的过程" class="headerlink" title="Java 执行事务的过程"></a>Java 执行事务的过程</h1><blockquote>
<p>1.获取连接 Connection con = DriverManager.getConnection()<br>2.开启事务con.setAutoCommit(true/false); 在 Spring 事务里（如 DataSourceTransactionManager 的 doBegin 方法）里，总是会显式地 con.setAutoCommit(false);（不然哪有事务可言）。<br>3.执行CRUD<br>4.提交事务/回滚事务 con.commit() / con.rollback();<br>5.关闭连接 conn.close();</p>
</blockquote>
<h1 id="本文涉及到的类型的类图"><a href="#本文涉及到的类型的类图" class="headerlink" title="本文涉及到的类型的类图"></a>本文涉及到的类型的类图</h1><p><img src="%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8-class-diagram1.png" alt="事务管理器-class-diagram1.png"></p>
<p><img src="transaction-manager-hiarachy.png" alt="transaction-manager-hiarachy.png"><br><img src="TransactionAspectSupport.png" alt="TransactionAspectSupport.png"></p>
<h1 id="Spring-的事务管理核心类型和流程"><a href="#Spring-的事务管理核心类型和流程" class="headerlink" title="Spring 的事务管理核心类型和流程"></a>Spring 的事务管理核心类型和流程</h1><h2 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a>DataSource</h2><p>不同的数据源诞生不同的 DataSource。默认的 TransactionManager 本身是期待一个名叫“datasource”的数据源的。</p>
<h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><p>不同的 DataSource 装入不同的 FactoryBean，比如 JPA 的 EntityManagerFactory。</p>
<h2 id="PlatformTransactionManager"><a href="#PlatformTransactionManager" class="headerlink" title="PlatformTransactionManager"></a>PlatformTransactionManager</h2><p>桥接模式的实现端。</p>
<p>不同的 FactoryBean 装入不同的 PlatformTransactionManager，比如 JpaTransactionManager（实际上还可以被细分为 TransactionManager/EntityManager/SessionFactory/PersistenceUnit）。PlatformTransactionManager 管很多东西，如数据库方言、数据源（FactoryBean 也持有这个东西，但某些事务管理器宁愿自己冗余一份数据源方便自己处理）。</p>
<p>这个类型可以当做 API 用，但 Spring 官方推荐应该通过 AOP （所以它要被装入 Interceptor）或者 TransactionTemplate 使用。</p>
<p>它提供三个基本接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取事务</span></span><br><span class="line"><span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition definition)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交事务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回滚事务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br></pre></td></tr></table></figure>

<h2 id="TransactionDefinition"><a href="#TransactionDefinition" class="headerlink" title="TransactionDefinition"></a>TransactionDefinition</h2><p>事务定义 TransactionDefinition 包含很多属性：</p>
<ul>
<li>是否只读</li>
<li>事务隔离级别</li>
<li>事务传播级别</li>
<li>超时</li>
</ul>
<p>通过事务的定义，我们根据定义产生特定的事务实例 - 基本上 <code>@Transactional</code>注解里标记的信息都持有在这里。</p>
<h2 id="TransactionStatus"><a href="#TransactionStatus" class="headerlink" title="TransactionStatus"></a>TransactionStatus</h2><p>每个事务实例在 TransactionStatus 接口 里，事务管理器通过状态可以知道事务的状态信息，然后进行事务的控制。事务是否完成，是否是新的事务，是不是只能回滚等。</p>
<p>对于 TransactionDefinition 而言，transaction status object representing the new or current transaction。</p>
<h2 id="TxAdviceBeanDefinitionParser"><a href="#TxAdviceBeanDefinitionParser" class="headerlink" title="TxAdviceBeanDefinitionParser"></a>TxAdviceBeanDefinitionParser</h2><p>基于 xml的配置，由 TxAdviceBeanDefinitionParser 负责生成 TransactionInterceptor 对象。</p>
<h2 id="ProxyTransactionManagementConfiguration"><a href="#ProxyTransactionManagementConfiguration" class="headerlink" title="ProxyTransactionManagementConfiguration"></a>ProxyTransactionManagementConfiguration</h2><p>基于注解的配置，由 ProxyTransactionManagementConfiguration 负责生成 TransactionInterceptor 对象。</p>
<h2 id="TransactionInterceptor"><a href="#TransactionInterceptor" class="headerlink" title="TransactionInterceptor"></a>TransactionInterceptor</h2><p>TransactionInterceptor 继承了 TransactionAspectSupport（桥接模式的抽象端）。</p>
<p>它通过装入 PlatformTransactionManager ptm 来扩展 TransactionAspectSupport 的行为，类似桥接模式。</p>
<p>其事务执行关键代码是（注意，这段代码和 TransactionAspectSupport.invokeWithinTransaction是相互回调的关系）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// Work out the target class: may be &#123;@code null&#125;.</span></span><br><span class="line">        <span class="comment">// The TransactionAttributeSource should be passed the target class</span></span><br><span class="line">        <span class="comment">// as well as the method, which may be from an interface.</span></span><br><span class="line">        Class&lt;?&gt; targetClass = (invocation.getThis() != <span class="keyword">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Adapt to TransactionAspectSupport&#x27;s invokeWithinTransaction...</span></span><br><span class="line">        <span class="keyword">return</span> invokeWithinTransaction(invocation.getMethod(), targetClass, <span class="keyword">new</span> InvocationCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">proceedWithInvocation</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="TransactionAspectSupport"><a href="#TransactionAspectSupport" class="headerlink" title="TransactionAspectSupport"></a>TransactionAspectSupport</h2><p>TransactionAspectSupport 提供了 transaction infrastructure，是 Spring 的一切事务 Aspect 的重要祖先。</p>
<p>它使用一个 NamedThreadLocal 来保存当前的 TransactionInfo（包含了 TransactionStatus），所以每个事务就是线程隔离的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * General delegate for around-advice-based subclasses, delegating to several other template</span></span><br><span class="line"><span class="comment">     * methods on this class. Able to handle &#123;<span class="doctag">@link</span> CallbackPreferringPlatformTransactionManager&#125;</span></span><br><span class="line"><span class="comment">     * as well as regular &#123;<span class="doctag">@link</span> PlatformTransactionManager&#125; implementations.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method the Method being invoked</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetClass the target class that we&#x27;re invoking the method on</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invocation the callback to use for proceeding with the target invocation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the return value of the method, if any</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable propagated from the target invocation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">invokeWithinTransaction</span><span class="params">(Method method, Class&lt;?&gt; targetClass, <span class="keyword">final</span> InvocationCallback invocation)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the transaction attribute is null, the method is non-transactional.</span></span><br><span class="line">        <span class="keyword">final</span> TransactionAttribute txAttr = getTransactionAttributeSource().getTransactionAttribute(method, targetClass);</span><br><span class="line">        <span class="keyword">final</span> PlatformTransactionManager tm = determineTransactionManager(txAttr);</span><br><span class="line">        <span class="keyword">final</span> String joinpointIdentification = methodIdentification(method, targetClass, txAttr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绝大部分 @transactional 的代码会跑到这里来</span></span><br><span class="line">        <span class="keyword">if</span> (txAttr == <span class="keyword">null</span> || !(tm <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">            <span class="comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.</span></span><br><span class="line">            TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">            Object retVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 这是一个环绕的建议！真正的事务内的操作在这里。</span></span><br><span class="line">                <span class="comment">// This is an around advice: Invoke the next interceptor in the chain.</span></span><br><span class="line">                <span class="comment">// This will normally result in a target object being invoked.</span></span><br><span class="line">                retVal = invocation.proceedWithInvocation();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// target invocation exception</span></span><br><span class="line">                completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                cleanupTransactionInfo(txInfo);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 提交事务的地方！嵌套的 public 方法，只有最外层方法返回的时候，调到这里跑一次</span></span><br><span class="line">            commitTransactionAfterReturning(txInfo);</span><br><span class="line">            <span class="keyword">return</span> retVal;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ThrowableHolder throwableHolder = <span class="keyword">new</span> ThrowableHolder();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// It&#x27;s a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object result = ((CallbackPreferringPlatformTransactionManager) tm).execute(txAttr,</span><br><span class="line">                        <span class="keyword">new</span> TransactionCallback&lt;Object&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> Object <span class="title">doInTransaction</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">                                TransactionInfo txInfo = prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="keyword">return</span> invocation.proceedWithInvocation();</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (txAttr.rollbackOn(ex)) &#123;</span><br><span class="line">                                        <span class="comment">// A RuntimeException: will lead to a rollback.</span></span><br><span class="line">                                        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                                            <span class="keyword">throw</span> (RuntimeException) ex;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        <span class="keyword">else</span> &#123;</span><br><span class="line">                                            <span class="keyword">throw</span> <span class="keyword">new</span> ThrowableHolderException(ex);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="comment">// A normal return value: will lead to a commit.</span></span><br><span class="line">                                        throwableHolder.throwable = ex;</span><br><span class="line">                                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">finally</span> &#123;</span><br><span class="line">                                    cleanupTransactionInfo(txInfo);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check result state: It might indicate a Throwable to rethrow.</span></span><br><span class="line">                <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> throwableHolder.throwable;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (ThrowableHolderException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (TransactionSystemException ex2) &#123;</span><br><span class="line">                <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Application exception overridden by commit exception&quot;</span>, throwableHolder.throwable);</span><br><span class="line">                    ex2.initApplicationException(throwableHolder.throwable);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> ex2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex2) &#123;</span><br><span class="line">                <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Application exception overridden by commit exception&quot;</span>, throwableHolder.throwable);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> ex2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事务的入口</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute after successful completion of call, but not after an exception was handled.</span></span><br><span class="line"><span class="comment">     * Do nothing if we didn&#x27;t create a transaction.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> txInfo information about the current transaction</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">commitTransactionAfterReturning</span><span class="params">(<span class="meta">@Nullable</span> TransactionInfo txInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (txInfo != <span class="keyword">null</span> &amp;&amp; txInfo.getTransactionStatus() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Completing transaction for [&quot;</span> + txInfo.getJoinpointIdentification() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="AbstractPlatformTransactionManager"><a href="#AbstractPlatformTransactionManager" class="headerlink" title="AbstractPlatformTransactionManager"></a>AbstractPlatformTransactionManager</h2><p>所有的 应该从这个类型里派生出来，它提供了如下便利：</p>
<ol>
<li>定义了（事务）传播行为</li>
<li>提供了事务同步服务</li>
</ol>
<p>它的参考实现是<code>JtaTransactionManager</code>和<code>DataSourceTransactionManager</code>。</p>
<p>其中管理事务提交的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation of commit handles participating in existing</span></span><br><span class="line"><span class="comment">     * transactions and programmatic rollback requests.</span></span><br><span class="line"><span class="comment">     * Delegates to &#123;<span class="doctag">@code</span> isRollbackOnly&#125;, &#123;<span class="doctag">@code</span> doCommit&#125;</span></span><br><span class="line"><span class="comment">     * and &#123;<span class="doctag">@code</span> rollback&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> org.springframework.transaction.TransactionStatus#isRollbackOnly()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #doCommit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #rollback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">        <span class="comment">// 对快速失败的状态检查</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (status.isCompleted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line">                    <span class="string">&quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status;</span><br><span class="line">        <span class="keyword">if</span> (defStatus.isLocalRollbackOnly()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (defStatus.isDebug()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Transactional code has requested rollback&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            processRollback(defStatus, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!shouldCommitOnGlobalRollbackOnly() &amp;&amp; defStatus.isGlobalRollbackOnly()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (defStatus.isDebug()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Global transaction is marked as rollback-only but transactional code requested commit&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            processRollback(defStatus, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        processCommit(defStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最关键的代码！</span></span><br><span class="line"><span class="comment">     * Process an actual commit.</span></span><br><span class="line"><span class="comment">     * Rollback-only flags have already been checked and applied.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status object representing the transaction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> TransactionException in case of commit failure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processCommit</span><span class="params">(DefaultTransactionStatus status)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> beforeCompletionInvoked = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">boolean</span> unexpectedRollback = <span class="keyword">false</span>;</span><br><span class="line">                prepareForCommit(status);</span><br><span class="line">                triggerBeforeCommit(status);</span><br><span class="line">                triggerBeforeCompletion(status);</span><br><span class="line">                beforeCompletionInvoked = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (status.hasSavepoint()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">&quot;Releasing transaction savepoint&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    unexpectedRollback = status.isGlobalRollbackOnly();</span><br><span class="line">                    status.releaseHeldSavepoint();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (status.isNewTransaction()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">                        logger.debug(<span class="string">&quot;Initiating transaction commit&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    unexpectedRollback = status.isGlobalRollbackOnly();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 事务管理器在很多前后钩子里中间夹着一个真实的 commit</span></span><br><span class="line">                    doCommit(status);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (isFailEarlyOnGlobalRollbackOnly()) &#123;</span><br><span class="line">                    unexpectedRollback = status.isGlobalRollbackOnly();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Throw UnexpectedRollbackException if we have a global rollback-only</span></span><br><span class="line">                <span class="comment">// marker but still didn&#x27;t get a corresponding exception from commit.</span></span><br><span class="line">                <span class="keyword">if</span> (unexpectedRollback) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedRollbackException(</span><br><span class="line">                            <span class="string">&quot;Transaction silently rolled back because it has been marked as rollback-only&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (UnexpectedRollbackException ex) &#123;</span><br><span class="line">                <span class="comment">// can only be caused by doCommit</span></span><br><span class="line">                triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (TransactionException ex) &#123;</span><br><span class="line">                <span class="comment">// can only be caused by doCommit</span></span><br><span class="line">                <span class="keyword">if</span> (isRollbackOnCommitFailure()) &#123;</span><br><span class="line">                    doRollbackOnCommitException(status, ex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (RuntimeException | Error ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!beforeCompletionInvoked) &#123;</span><br><span class="line">                    triggerBeforeCompletion(status);</span><br><span class="line">                &#125;</span><br><span class="line">                doRollbackOnCommitException(status, ex);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Trigger afterCommit callbacks, with an exception thrown there</span></span><br><span class="line">            <span class="comment">// propagated to callers but the transaction still considered as committed.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                triggerAfterCommit(status);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                triggerAfterCompletion(status, TransactionSynchronization.STATUS_COMMITTED);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            cleanupAfterCompletion(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="DataSourceTransactionManager"><a href="#DataSourceTransactionManager" class="headerlink" title="DataSourceTransactionManager"></a>DataSourceTransactionManager</h2><p>MyBatis 的数据源实际上使用的事务管理器在这里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doCommit</span><span class="params">(DefaultTransactionStatus status)</span> </span>&#123;</span><br><span class="line">        DataSourceTransactionObject txObject = (DataSourceTransactionObject) status.getTransaction();</span><br><span class="line">        Connection con = txObject.getConnectionHolder().getConnection();</span><br><span class="line">        <span class="keyword">if</span> (status.isDebug()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Committing JDBC transaction on Connection [&quot;</span> + con + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            con.commit();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TransactionSystemException(<span class="string">&quot;Could not commit JDBC transaction&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="MyBatis-的事务边界"><a href="#MyBatis-的事务边界" class="headerlink" title="MyBatis 的事务边界"></a>MyBatis 的事务边界</h1><p>SqlSessionUtils<br>// 每一段 sql 执行的时候都会执行这个操作</p>
<blockquote>
<p>2020-03-31 23:30:30,056 [main] DEBUG (SqlSessionUtils:97) - Creating a<br>new SqlSession 2020-03-31 23:30:30,060 [main] DEBUG<br>(SqlSessionUtils:128) - Registering transaction synchronization for<br>SqlSession<br>[org.apache.ibatis.session.defaults.DefaultSqlSession@2cee1bcf] //<br>这里虽然 closeSession，并没有破坏事务的原子性 2020-03-31 23:30:30,307 [main] DEBUG<br>(SqlSessionUtils:186) - Releasing transactional SqlSession<br>[org.apache.ibatis.session.defaults.DefaultSqlSession@2cee1bcf]<br>2020-03-31 23:31:27,389 [main] DEBUG<br>(SqlSessionUtils$SqlSessionSynchronization:284) - Transaction<br>synchronization committing SqlSession</p>
<p>[org.apache.ibatis.session.defaults.DefaultSqlSession@2cee1bcf]<br>2020-03-31 23:31:27,398 [main] DEBUG<br>(SqlSessionUtils$SqlSessionSynchronization:310) - Transaction<br>synchronization deregistering SqlSession<br>[org.apache.ibatis.session.defaults.DefaultSqlSession@2cee1bcf]<br>// 但只有整个事务提交的时候会执行这个操作 commitTransactionAfterReturning -&gt;<br>Connection.commit</p>
</blockquote>
<h1 id="Spring-Boot-的增强设计"><a href="#Spring-Boot-的增强设计" class="headerlink" title="Spring Boot 的增强设计"></a>Spring Boot 的增强设计</h1><p>在 Spring-Boot 的<br>各种 spring-data-* 会根据 TransactionManagementConfigurationSelector 自动激活特定的 DataSource 以及相应的 TransactionManager。</p>
<h1 id="Spring-的声明式事务"><a href="#Spring-的声明式事务" class="headerlink" title="Spring 的声明式事务"></a>Spring 的声明式事务</h1><h2 id="七个传播性配置"><a href="#七个传播性配置" class="headerlink" title="七个传播性配置"></a>七个传播性配置</h2><ul>
<li>TransactionDefinition.PROPAGATION_REQUIRED：如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。这是默认值。</li>
<li>TransactionDefinition.PROPAGATION_REQUIRES_NEW：创建一个新的事务，如果当前存在事务，则把当前事务挂起。</li>
<li>TransactionDefinition.PROPAGATION_SUPPORTS：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。（注意这里，不要采坑）</li>
<li>TransactionDefinition.PROPAGATION_NOT_SUPPORTED：以非事务方式运行，如果当前存在事务，则把当前事务挂起。</li>
<li>TransactionDefinition.PROPAGATION_NEVER：以非事务方式运行，如果当前存在事务，则抛出异常。</li>
<li>TransactionDefinition.PROPAGATION_MANDATORY：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</li>
<li>TransactionDefinition.PROPAGATION_NESTED：如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于TransactionDefinition.PROPAGATION_REQUIRED。</li>
</ul>
<p>1 可以保证嵌套事务使用同一个事务。</p>
<p>2 则要考虑嵌套事务时，内层事务挂起外层事务的问题，只有内层事务退出（不管正常还是不正常），外层事务才会逐步进入自己的余下的步骤。2 生成的事务是全新的事务。它拥有自己独立的隔离级别，持有自己的锁。这种传播性是用于某类 sequence 生成 id 的嵌套，让 id 生成的嵌套事务不持有太久的数据库锁-因为数据库两段式提交的方式，如果嵌套事务被大事务套住了，嵌套事务的锁要最后才提交。</p>
<p>7 意味着创建的事务是嵌套的事务，它的提交受外部事务控制，而回滚是否影响外部事务由外部事务自己决定。它会产生 savepoint。默认的情况下，嵌套事务的回滚应该触发外部事务的回滚，但在某些大任务拆解，逐步执行嵌套事务的场景下，个别嵌套事务的回滚可以被吞掉，以有效地保证外部事务的部分成功。</p>
<p>具体说明见 Juergen Hoeller 的说明：</p>
<blockquote>
<p>PROPAGATION_REQUIRES_NEW starts a new, independent “inner” transaction<br>for the given scope. This transaction will be committed or rolled back<br>completely independent from the outer transaction, having its own<br>isolation scope, its own set of locks, etc. The outer transaction will<br>get suspended at the beginning of the inner one, and resumed once the<br>inner one has completed. </p>
<p>Such independent inner transactions are for example used for id<br>generation through manual sequences, where the access to the sequence<br>table should happen in its own transactions, to keep the lock there as<br>short as possible. The goal there is to avoid tying the sequence locks<br>to the (potentially much longer running) outer transaction, with the<br>sequence lock not getting released before completion of the outer<br>transaction. </p>
<p>PROPAGATION_NESTED on the other hand starts a “nested” transaction,<br>which is a true subtransaction of the existing one. What will happen<br>is that a savepoint will be taken at the start of the nested<br>transaction. íf the nested transaction fails, we will roll back to<br>that savepoint. The nested transaction is part of of the outer<br>transaction, so it will only be committed at the end of of the outer<br>transaction. </p>
<p>Nested transactions essentially allow to try some execution subpaths<br>as subtransactions: rolling back to the state at the beginning of the<br>failed subpath, continuing with another subpath or with the main<br>execution path there - all within one isolated transaction, and not<br>losing any previous work done within the outer transaction. </p>
<p>For example, consider parsing a very large input file consisting of<br>account transfer blocks: The entire file should essentially be parsed<br>within one transaction, with one single commit at the end. But if a<br>block fails, its transfers need to be rolled back, writing a failure<br>marker somewhere. You could either start over the entire transaction<br>every time a block fails, remembering which blocks to skip - or you<br>mark each block as a nested transaction, only rolling back that<br>specific set of operations, keeping the previous work of the outer<br>transaction. The latter is of course much more efficient, in<br>particular when a block at the end of the file fails.</p>
</blockquote>
<h2 id="不同事务传播策略下嵌套事务的行为"><a href="#不同事务传播策略下嵌套事务的行为" class="headerlink" title="不同事务传播策略下嵌套事务的行为"></a>不同事务传播策略下嵌套事务的行为</h2><blockquote>
<p>使用嵌套事务的场景有两点需求：</p>
<ul>
<li>需要事务BC与事务AD一起commit，即：作为事务AD的嵌套事务，事务BC只有在事务AD成功commit时（阶段3成功）才commit。这个需求简单称之为“联合成功”。这一点PROPAGATION_NESTED和PROPAGATION_REQUIRED可以做到。</li>
<li>需要事务BC的rollback不（无条件的）影响事务AD的commit。这个需求简单称之为“隔离失败”。这一点PROPAGATION_NESTED和PROPAGATION_REQUIRES_NEW可以做到。</li>
</ul>
</blockquote>
<p>换言之：</p>
<ol>
<li>默认的传播级别（PROPAGATION_REQUIRED），使得嵌套事务只要失败，外部事务也只能回滚-rollbackOnly。</li>
<li>使用 PROPAGATION_REQUIRES_NEW，嵌套事务会被独立提交，而且一定会发生隔离失败（即使没有发生外部的 catch）。</li>
<li>能够让嵌套事务和外部事务一起提交的，只有 PROPAGATION_NESTED了。PROPAGATION_NESTED在事务AD执行到B点时，<strong>设置了savePoint（关键）</strong>。而且如果嵌套事务失败，则外部事务不会失败。</li>
</ol>
<p>设置 savepoint 的关键流程在<code>AbstractTransactionStatus</code>里的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">createSavepoint</span><span class="params">()</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSavepointManager().createSavepoint();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>savepoint 是 jdbc 的 Connection 的概念，可被命名也可以不被命名（命名通常是 SAVEPOINT_计数器）。它代表着事务的一个位置，rollback 可以只 rollback 到 savepoint，然后当前事务自己决定是继续 rollback 还是继续 proceed。回滚到 savepoint 可以使用如下语句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">con.rollback(savepoint);</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/duanxz/p/4746892.html">《事务之六：spring 嵌套事务》</a></p>
<h2 id="事务只读属性"><a href="#事务只读属性" class="headerlink" title="事务只读属性"></a>事务只读属性</h2><blockquote>
<p>只读事务用于客户代码只读但不修改数据的情形，只读事务用于特定情景下的优化，比如使用Hibernate的时候。</p>
<p>“只读事务”并不是一个强制选项，它只是一个“暗示”，提示数据库驱动程序和数据库系统，这个事务并不包含更改数据的操作，那么JDBC驱动程序和数据库就有可能根据这种情况对该事务进行一些特定的优化，比方说不安排相应的数据库锁，以减轻事务对数据库的压力，毕竟事务也是要消耗数据库的资源的。</p>
<p>但是你非要在“只读事务”里面修改数据，也并非不可以，只不过对于数据一致性的保护不像“读写事务”那样保险而已。 </p>
<p>因此，“只读事务”仅仅是一个性能优化的推荐配置而已，并非强制你要这样做不可。</p>
</blockquote>
<h2 id="事务超时"><a href="#事务超时" class="headerlink" title="事务超时"></a>事务超时</h2><p>所谓事务超时，就是指一个事务所允许执行的最长时间，如果超过该时间限制但事务还没有完成，则自动回滚事务。在 TransactionDefinition 中以int 的值来表示超时时间，<strong>其单位是秒</strong>。</p>
<p>默认设置为底层事务系统的超时值（注解的默认值是-1），如果底层数据库事务系统没有设置超时值，那么就是none，没有超时限制。</p>
<p>其他设置事务超时的方法：</p>
<ul>
<li>在 jdbc 连接字符串里配置（这个方法最好）。</li>
<li>在数据库层面配置。</li>
<li>在中间件层面配置。</li>
</ul>
<p>参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5c6b71c4f265da2dc231dcbf">《Spring事务原理完全解析》</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ecf55d6f0118">《Spring事务原理分析》</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/data-jpa/docs/current/reference/html/#transactions">《Transactionality》</a></li>
</ol>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2021-03-01");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2020-07-19T01:47:18.000Z" itemprop="datePublished">2020-07-19</time>

    , Updated at&nbsp;<time datetime="2021-03-01T12:15:20.000Z" itemprop="dateModified">2021-03-01</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/Java/" rel="tag">#&nbsp;Java</a>

<a class="post-tags-list-item" href="/tags/Spring/" rel="tag">#&nbsp;Spring</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2020/07/19/Spring-IOC/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">Spring IOC</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2020/07/12/%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">软件方法</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>