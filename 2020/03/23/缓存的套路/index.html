<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>缓存的套路 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="缓存的套路 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="什么时候应该使用缓存？所有高耗时，需要吞吐量，而不太严格依赖强一致性的场景-不管是计算密集型还是 io 密集型，都可以使用缓存加速。 多级缓存问题大多数情况下不要使用多级缓存。多级缓存要严格设计差异化的冷热数据分离策略，还要考虑分布式的缓存失效+更新的问题，很复杂。 勉强可用的多级缓存应该是远端一级缓存，近端二级缓存。 本地多级缓存非常容易出一致性问题-慎用 MyBatis 和 Hibernate - magicliang - 守株阁"><meta name="keywords" content="系统架构, 缓存"><meta property="og:image" content="http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.png"><meta property="article:published_time" content="2020-03-23T06:17:03.000Z"><meta property="article:modified_time" content="2021-06-25T05:43:06.000Z"><meta property="og:updated_time" content="2021-06-25T05:43:06.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="系统架构, 缓存"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/"
    },
    "headline": "缓存的套路 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2020-03-23T06:17:03.000Z",
    "dateModified": "2021-06-25T05:43:06.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "系统架构, 缓存",
    "description": "什么时候应该使用缓存？所有高耗时，需要吞吐量，而不太严格依赖强一致性的场景-不管是计算密集型还是 io 密集型，都可以使用缓存加速。 多级缓存问题大多数情况下不要使用多级缓存。多级缓存要严格设计差异化的冷热数据分离策略，还要考虑分布式的缓存失效+更新的问题，很复杂。 勉强可用的多级缓存应该是远端一级缓存，近端二级缓存。 本地多级缓存非常容易出一致性问题-慎用 MyBatis 和 Hibernate - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=缓存的套路" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=缓存的套路&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=缓存的套路" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAAAAAAYplnuAAACtElEQVR42u3cSU4DQRBEUd//0rBCQqgr40e6QUL9vTGDh1ctpSuHgtfHP7y9RIsWLfqB6Ndw+/77r6/jC188/+p1vn9PHKJFN+jTm1/dXz2nXdTPRRCHaNEtmgbQ6f4UPCfA6UKcHKJF34VOmwEJuCkQpwsgWvRvoMkiSMJFkzHRou9Cp40gJfJN0TBdnFuyPNGPR6dg+av7W6tx0Y9FVw3AwxucCtVTopUC/tauqejHodsm4LTJnDakaaG0wBUteoNukpnpeen71FSvAlG06IvNZRskaQG0cT4lUKJFb9AkAFOQVQOfImBFi96gX+DWNBNTAzMlRrFZI1p0ORuf3qhZxLbJKVr0O2haiLY/T4P+tKiqASla9MXmMn3Qk4NWNADp78fhp2jRy9l407RJj6mS/ZNJtGiATgdE6AFZUgxMj0MFgWjRAD0NeKY/Qmg2pZQ0pWRLtOgW3Qx70nCIvma6WKJFb9HpwU1DhvycLuByQaJFA3Q60Eo2gxSgdKifkibRogl6GqaTIShpYtJG0FQgiBZN0U0SlA5qkyFnUxivDhOKfjyafPiTISW5AKdkCjeJRIsGaDKgnBrsU+L/TgGBOkyiRcO/3aJJPtlI2iCvNxfRokOzhhQD5PB2O1BChbFo0cvClg7qt4PP1LDHh75Fix76Hqnx3Tbh03PJQZZ48Eq0aDjQpx/8U4C1A6Xp9USL3qBTUKXFNI31tMBjUIoW/QaaLICiyca0Oi0mWvTi/zClBmJq7LSHUcaiWbRo+E9JaECk4XwqisnQtDpZI1o0OO/Rbg4kgW8P3R4fK1p0gU4NdHLoNQV1k6DhBqRo0Ut000AnQyJSDIsW/RvoNEjCyQ4cDNWTANGiy4RpkzS1DfMp8RIteoNuG4FTA4YUr00R/HY1Lvpx6P90Ey1atOgHoT8B0LLrCdCpwwAAAAAASUVORK5CYII=" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">缓存的套路</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2020-03-23</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=缓存的套路&url=http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=缓存的套路&url=http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAAAAAAYplnuAAACtElEQVR42u3cSU4DQRBEUd//0rBCQqgr40e6QUL9vTGDh1ctpSuHgtfHP7y9RIsWLfqB6Ndw+/77r6/jC188/+p1vn9PHKJFN+jTm1/dXz2nXdTPRRCHaNEtmgbQ6f4UPCfA6UKcHKJF34VOmwEJuCkQpwsgWvRvoMkiSMJFkzHRou9Cp40gJfJN0TBdnFuyPNGPR6dg+av7W6tx0Y9FVw3AwxucCtVTopUC/tauqejHodsm4LTJnDakaaG0wBUteoNukpnpeen71FSvAlG06IvNZRskaQG0cT4lUKJFb9AkAFOQVQOfImBFi96gX+DWNBNTAzMlRrFZI1p0ORuf3qhZxLbJKVr0O2haiLY/T4P+tKiqASla9MXmMn3Qk4NWNADp78fhp2jRy9l407RJj6mS/ZNJtGiATgdE6AFZUgxMj0MFgWjRAD0NeKY/Qmg2pZQ0pWRLtOgW3Qx70nCIvma6WKJFb9HpwU1DhvycLuByQaJFA3Q60Eo2gxSgdKifkibRogl6GqaTIShpYtJG0FQgiBZN0U0SlA5qkyFnUxivDhOKfjyafPiTISW5AKdkCjeJRIsGaDKgnBrsU+L/TgGBOkyiRcO/3aJJPtlI2iCvNxfRokOzhhQD5PB2O1BChbFo0cvClg7qt4PP1LDHh75Fix76Hqnx3Tbh03PJQZZ48Eq0aDjQpx/8U4C1A6Xp9USL3qBTUKXFNI31tMBjUIoW/QaaLICiyca0Oi0mWvTi/zClBmJq7LSHUcaiWbRo+E9JaECk4XwqisnQtDpZI1o0OO/Rbg4kgW8P3R4fK1p0gU4NdHLoNQV1k6DhBqRo0Ut000AnQyJSDIsW/RvoNEjCyQ4cDNWTANGiy4RpkzS1DfMp8RIteoNuG4FTA4YUr00R/HY1Lvpx6P90Ey1atOgHoT8B0LLrCdCpwwAAAAAASUVORK5CYII=" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%BA%94%E8%AF%A5%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9F"><span class="post-toc-number">1.</span> <span class="post-toc-text">什么时候应该使用缓存？</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="post-toc-number">2.</span> <span class="post-toc-text">多级缓存问题</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%A4%96%E9%83%A8%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="post-toc-number">3.</span> <span class="post-toc-text">外部缓存设计思路</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Redis"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">Redis</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%86%85%E9%83%A8%E7%BC%93%E5%AD%98%E7%9A%84%E7%94%A8%E6%B3%95"><span class="post-toc-number">4.</span> <span class="post-toc-text">内部缓存的用法</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Guava"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Guava</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Spring-Guava-%E4%B8%80%E8%88%AC%E7%9A%84%E7%9F%AD%E8%B7%AF%E5%99%A8%E5%BC%8F%E7%9A%84%E7%94%A8%E6%B3%95"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">Spring + Guava 一般的短路器式的用法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%8F%AA%E9%9C%80%E8%A6%81%E8%A6%86%E7%9B%96-load-%E6%96%B9%E6%B3%95"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">只需要覆盖 load 方法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%B8%A6%E6%9D%83%E9%87%8D%E7%9A%84%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="post-toc-number">4.1.3.</span> <span class="post-toc-text">带权重的缓存配置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%8C%87%E5%AE%9A%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="post-toc-number">4.1.4.</span> <span class="post-toc-text">指定过期时间</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%BC%B1%E5%BC%95%E7%94%A8%E5%92%8C%E8%BD%AF%E5%BC%95%E7%94%A8-key"><span class="post-toc-number">4.1.5.</span> <span class="post-toc-text">弱引用和软引用 key</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9A%E6%97%B6%E8%A7%A6%E5%8F%91-load-%E6%96%B9%E6%B3%95"><span class="post-toc-number">4.1.6.</span> <span class="post-toc-text">定时触发 load 方法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%BB%E5%8A%A8%E9%A2%84%E7%83%AD"><span class="post-toc-number">4.1.7.</span> <span class="post-toc-text">主动预热</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8-optional-%E6%9D%A5%E5%BA%94%E5%AF%B9-null-%E5%80%BC"><span class="post-toc-number">4.1.8.</span> <span class="post-toc-text">必须使用 optional 来应对 null 值</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AE%A2%E9%98%85%E5%88%A0%E9%99%A4%E4%BA%8B%E4%BB%B6"><span class="post-toc-number">4.1.9.</span> <span class="post-toc-text">订阅删除事件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Cache-Statistic"><span class="post-toc-number">4.1.10.</span> <span class="post-toc-text">Cache Statistic</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ECache"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">ECache</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Spring4-ECache-2"><span class="post-toc-number">4.2.1.</span> <span class="post-toc-text">Spring4 + ECache 2</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Spring-Boot-2-ECache3"><span class="post-toc-number">4.2.2.</span> <span class="post-toc-text">Spring Boot 2 + ECache3</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Caffeine"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">Caffeine</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%8D%E6%90%AD%E9%85%8D-Spring"><span class="post-toc-number">4.3.1.</span> <span class="post-toc-text">不搭配 Spring</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%90%AD%E9%85%8D-Spring"><span class="post-toc-number">4.3.2.</span> <span class="post-toc-text">搭配 Spring</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%BC%93%E5%AD%98-miss-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="post-toc-number">5.</span> <span class="post-toc-text">如何应对缓存 miss 的问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">如何应对缓存击穿</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">如何应对缓存雪崩</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">如何应对缓存穿透</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E8%BF%9C%E7%AB%AF%E7%BC%93%E5%AD%98%E4%B8%8E%E8%BF%91%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E8%BE%A8%E6%9E%90"><span class="post-toc-number">6.</span> <span class="post-toc-text">远端缓存与近端缓存的辨析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%BF%9C%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">远端缓存的好处</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%BF%9C%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%9D%8F%E5%A4%84"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">远端缓存的坏处</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%BF%91%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">近端缓存的好处</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%BF%91%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%9D%8F%E5%A4%84"><span class="post-toc-number">6.4.</span> <span class="post-toc-text">近端缓存的坏处</span></a></li></ol></li></ol></div>
                        
                    
                    <article id="post-content">
                        <h1 id="什么时候应该使用缓存？"><a href="#什么时候应该使用缓存？" class="headerlink" title="什么时候应该使用缓存？"></a>什么时候应该使用缓存？</h1><p>所有高耗时，需要吞吐量，而不太严格依赖强一致性的场景-不管是计算密集型还是 io 密集型，都可以使用缓存加速。</p>
<h1 id="多级缓存问题"><a href="#多级缓存问题" class="headerlink" title="多级缓存问题"></a>多级缓存问题</h1><p>大多数情况下不要使用多级缓存。<br>多级缓存要严格设计差异化的冷热数据分离策略，还要考虑分布式的缓存失效+更新的问题，很复杂。</p>
<p>勉强可用的多级缓存应该是远端一级缓存，近端二级缓存。</p>
<p>本地多级缓存非常容易出一致性问题-慎用 MyBatis 和 Hibernate 的二级缓存。</p>
<h1 id="外部缓存设计思路"><a href="#外部缓存设计思路" class="headerlink" title="外部缓存设计思路"></a>外部缓存设计思路</h1><p>外部缓存通常指的是分布式缓存组件或者中间件。</p>
<p>内文直接参考<a target="_blank" rel="noopener" href="https://coolshell.cn/articles/17416.html">《缓存更新的套路》</a></p>
<p><a href="%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.xmind">缓存更新的设计模式.xmind</a><br><img src="%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.png" alt="缓存更新的设计模式.png"></p>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h1 id="内部缓存的用法"><a href="#内部缓存的用法" class="headerlink" title="内部缓存的用法"></a>内部缓存的用法</h1><p>内部缓存通常指的是进程内缓存，in-memory-cache。</p>
<p>Spring Cache 依靠一个 CacheManager SPI 机制，来跟不同的 cache 实现打交道。大多数时候我们应该用 CacheManager 封装好的 wrapper api 来跟缓存打交道，极少数情况下我们应该 getNativeCache 来使用专有 API。</p>
<ol>
<li>Guava Cache 就是给 ConcurrentHashMap 加上了大量的 LRU 等 evict 操作和相应的管理策略。Guava在每次访问缓存的时候判断cache数据是否过期，如果过期，这时才将其删除，并没有另起一个线程专门来删除过期数据-类似 WeakHashMap。内部维护了2个队列 AccessQueue 和 WriteQueue 来记录缓存中数据访问和写入的顺序。访问缓存时，先用key计算出hash，从而找出所在的segment，然后再在segment中寻找具体问题，类似于使用ConcurrentHashMap数据结构来存放缓存数据。</li>
<li>Guava在每次访问缓存的时候判断cache数据是否过期，如果过期，这时才将其删除，并没有另起一个线程专门来删除过期数据。</li>
<li>ECache 支持本地磁盘缓存，甚至支持集群模式-使用到集群的时候，是不是可以考虑改用 Redis 更好。</li>
<li>Ecache 有内存占用大小统计，Guava Cache 没有。</li>
<li>Ecache 提供全面的缓存支持，Guava Cache 提供基本的缓存支持。</li>
<li>Ecache 允许 value 为 null；而 Guava Cache 允许 value 为 null，因为它根据value的值是否为null来判断是否需要load，所以不允许返回为null。这就意味着 Guava Cache 不易处理缓存穿透的问题，需要使用使用空对象替换 null。</li>
<li>Caffeine 是用 Java8 对 Guava Cache 的一种重写。</li>
<li>在更多的时候，一个简单的全局的 ConcurrentHashMap（注意，它作为全局可访问的状态，天然就应该做线程安全设计）就可以解决大部分缓存问题。只有加上各种细致的操作的时候，才有必要专门引入特定的缓存包。Guava Cache 实际上是由一个开源的 <a target="_blank" rel="noopener" href="https://github.com/ben-manes/concurrentlinkedhashmap">one-man project concurrentlinkedhashmap</a> 衍生出来，交给一个 dedicated team 维护的。</li>
</ol>
<h2 id="Guava"><a href="#Guava" class="headerlink" title="Guava"></a>Guava</h2><p>spring 的 cache 用的是 cachemanager。<br>guava 的 cache 用的是 cachebuilder。</p>
<h3 id="Spring-Guava-一般的短路器式的用法"><a href="#Spring-Guava-一般的短路器式的用法" class="headerlink" title="Spring + Guava 一般的短路器式的用法"></a>Spring + Guava 一般的短路器式的用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.concretepage&quot;)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfigA</span>  </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       GuavaCacheManager cacheManager = <span class="keyword">new</span> GuavaCacheManager(<span class="string">&quot;mycache&quot;</span>);</span><br><span class="line">       CacheBuilder&lt;Object, Object&gt; cacheBuilder = CacheBuilder.newBuilder()</span><br><span class="line">       .maximumSize(<span class="number">100</span>)</span><br><span class="line">       .expireAfterWrite(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">       cacheManager.setCacheBuilder(cacheBuilder);</span><br><span class="line">       <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.concretepage&quot;)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfigB</span>  </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       SimpleCacheManager cacheManager = <span class="keyword">new</span> SimpleCacheManager();</span><br><span class="line">       GuavaCache guavaCache1 = <span class="keyword">new</span> GuavaCache(<span class="string">&quot;book&quot;</span>, CacheBuilder.newBuilder()</span><br><span class="line">               .maximumSize(<span class="number">50</span>).build());</span><br><span class="line">       GuavaCache guavaCache2 = <span class="keyword">new</span> GuavaCache(<span class="string">&quot;bookstore&quot;</span>, CacheBuilder.newBuilder()</span><br><span class="line">               .maximumSize(<span class="number">100</span>).expireAfterAccess(<span class="number">5</span>, TimeUnit.MINUTES).build());</span><br><span class="line">       cacheManager.setCaches(Arrays.asList(guavaCache1, guavaCache2));</span><br><span class="line">       <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookAppA</span> </span>&#123;</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;mycache&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getBook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Executing getBook method...&quot;</span>);</span><br><span class="line">        book.setBookName(<span class="string">&quot;Mahabharat&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="只需要覆盖-load-方法"><a href="#只需要覆盖-load-方法" class="headerlink" title="只需要覆盖 load 方法"></a>只需要覆盖 load 方法</h3><p>load 和 evict 逻辑是解耦的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenCacheMiss_thenValueIsComputed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder().build(loader);</span><br><span class="line"> </span><br><span class="line">    assertEquals(<span class="number">0</span>, cache.size());</span><br><span class="line">    assertEquals(<span class="string">&quot;HELLO&quot;</span>, cache.getUnchecked(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    assertEquals(<span class="number">1</span>, cache.size());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// load 的用法，下次不会再计算 createExpensiveGraph 了。</span></span><br><span class="line">CacheLoader&lt;Key, Graph&gt; loader = <span class="keyword">new</span> CacheLoader&lt;Key, Graph&gt;() &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> Graph <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> AnyException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createExpensiveGraph(key);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;;</span><br><span class="line">LoadingCache&lt;Key, Graph&gt; cache = CacheBuilder.newBuilder().build(loader);&#125;</span><br></pre></td></tr></table></figure>

<h3 id="带权重的缓存配置"><a href="#带权重的缓存配置" class="headerlink" title="带权重的缓存配置"></a>带权重的缓存配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenCacheReachMaxWeight_thenEviction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    Weigher&lt;String, String&gt; weighByLength;</span><br><span class="line">    weighByLength = <span class="keyword">new</span> Weigher&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">weigh</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> value.length();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder()</span><br><span class="line">      .maximumWeight(<span class="number">16</span>)</span><br><span class="line">      .weigher(weighByLength)</span><br><span class="line">      .build(loader);</span><br><span class="line"> </span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;first&quot;</span>);</span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;third&quot;</span>);</span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;last&quot;</span>);</span><br><span class="line">    assertEquals(<span class="number">3</span>, cache.size());</span><br><span class="line">    assertNull(cache.getIfPresent(<span class="string">&quot;first&quot;</span>));</span><br><span class="line">    assertEquals(<span class="string">&quot;LAST&quot;</span>, cache.getIfPresent(<span class="string">&quot;last&quot;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="指定过期时间"><a href="#指定过期时间" class="headerlink" title="指定过期时间"></a>指定过期时间</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenEntryIdle_thenEviction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder()</span><br><span class="line">        <span class="comment">// remove records that have been idle for 2ms:</span></span><br><span class="line">      .expireAfterAccess(<span class="number">2</span>,TimeUnit.MILLISECONDS)</span><br><span class="line">      .build(loader);</span><br><span class="line"> </span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    assertEquals(<span class="number">1</span>, cache.size());</span><br><span class="line"> </span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    Thread.sleep(<span class="number">300</span>);</span><br><span class="line"> </span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    assertEquals(<span class="number">1</span>, cache.size());</span><br><span class="line">    assertNull(cache.getIfPresent(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenEntryLiveTimeExpire_thenEviction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder()</span><br><span class="line">    <span class="comment">// 这个策略更保守</span></span><br><span class="line">    <span class="comment">// evict records based on their total live time</span></span><br><span class="line">      .expireAfterWrite(<span class="number">2</span>,TimeUnit.MILLISECONDS)</span><br><span class="line">      .build(loader);</span><br><span class="line"> </span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    assertEquals(<span class="number">1</span>, cache.size());</span><br><span class="line">    Thread.sleep(<span class="number">300</span>);</span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    assertEquals(<span class="number">1</span>, cache.size());</span><br><span class="line">    assertNull(cache.getIfPresent(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="弱引用和软引用-key"><a href="#弱引用和软引用-key" class="headerlink" title="弱引用和软引用 key"></a>弱引用和软引用 key</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenWeakKeyHasNoRef_thenRemoveFromCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder().weakKeys().build(loader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenSoftValue_thenRemoveFromCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder().softValues().build(loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定时触发-load-方法"><a href="#定时触发-load-方法" class="headerlink" title="定时触发 load 方法"></a>定时触发 load 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenLiveTimeEnd_thenRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder()</span><br><span class="line">      .refreshAfterWrite(<span class="number">1</span>,TimeUnit.MINUTES)</span><br><span class="line">      .build(loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="主动预热"><a href="#主动预热" class="headerlink" title="主动预热"></a>主动预热</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void whenPreloadCache_thenUsePutAll() &#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = new CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public String load(String key) &#123;</span><br><span class="line">            return key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder().build(loader);</span><br><span class="line"> </span><br><span class="line">    Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span><br><span class="line">    map.put(&quot;first&quot;, &quot;FIRST&quot;);</span><br><span class="line">    map.put(&quot;second&quot;, &quot;SECOND&quot;);</span><br><span class="line">    cache.putAll(map);</span><br><span class="line"> </span><br><span class="line">    assertEquals(2, cache.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="必须使用-optional-来应对-null-值"><a href="#必须使用-optional-来应对-null-值" class="headerlink" title="必须使用 optional 来应对 null 值"></a>必须使用 optional 来应对 null 值</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void whenNullValue_thenOptional() &#123;</span><br><span class="line">    CacheLoader&lt;String, Optional&lt;String&gt;&gt; loader;</span><br><span class="line">    loader = new CacheLoader&lt;String, Optional&lt;String&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Optional&lt;String&gt; load(String key) &#123;</span><br><span class="line">            return Optional.fromNullable(getSuffix(key));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, Optional&lt;String&gt;&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder().build(loader);</span><br><span class="line"> </span><br><span class="line">    assertEquals(&quot;txt&quot;, cache.getUnchecked(&quot;text.txt&quot;).get());</span><br><span class="line">    assertFalse(cache.getUnchecked(&quot;hello&quot;).isPresent());</span><br><span class="line">&#125;</span><br><span class="line">private String getSuffix(final String str) &#123;</span><br><span class="line">    int lastIndex = str.lastIndexOf(&#x27;.&#x27;);</span><br><span class="line">    if (lastIndex == -1) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    return str.substring(lastIndex + 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="订阅删除事件"><a href="#订阅删除事件" class="headerlink" title="订阅删除事件"></a>订阅删除事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenEntryRemovedFromCache_thenNotify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CacheLoader&lt;String, String&gt; loader;</span><br><span class="line">    loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    RemovalListener&lt;String, String&gt; listener;</span><br><span class="line">    listener = <span class="keyword">new</span> RemovalListener&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;String, String&gt; n)</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (n.wasEvicted()) &#123;</span><br><span class="line">                String cause = n.getCause().name();</span><br><span class="line">                assertEquals(RemovalCause.SIZE.toString(),cause);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    LoadingCache&lt;String, String&gt; cache;</span><br><span class="line">    cache = CacheBuilder.newBuilder()</span><br><span class="line">      .maximumSize(<span class="number">3</span>)</span><br><span class="line">      .removalListener(listener)</span><br><span class="line">      .build(loader);</span><br><span class="line"> </span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;first&quot;</span>);</span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;third&quot;</span>);</span><br><span class="line">    cache.getUnchecked(<span class="string">&quot;last&quot;</span>);</span><br><span class="line">    assertEquals(<span class="number">3</span>, cache.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Cache-Statistic"><a href="#Cache-Statistic" class="headerlink" title="Cache Statistic"></a>Cache Statistic</h3><p>可以 logging cache statistic data</p>
<blockquote>
<p>Cache Stats= CacheStats{hitCount=3296628, missCount=1353372,<br>loadSuccessCount=1353138, loadExceptionCount=0,<br>totalLoadTime=2268064327604, evictionCount=1325410} Cache Stats=<br>CacheStats{hitCount=3334167, missCount=1365834,<br>loadSuccessCount=1365597, loadExceptionCount=0,<br>totalLoadTime=2287551024797, evictionCount=1337740} Cache Stats=<br>CacheStats{hitCount=3371463, missCount=1378536,<br>loadSuccessCount=1378296, loadExceptionCount=0,<br>totalLoadTime=2309012047459, evictionCount=1350990} Cache Stats=<br>CacheStats{hitCount=3407719, missCount=1392280,<br>loadSuccessCount=1392039, loadExceptionCount=0,<br>totalLoadTime=2331355983194, evictionCount=1364535} Cache Stats=<br>CacheStats{hitCount=3443848, missCount=1406152,<br>loadSuccessCount=1405908, loadExceptionCount=0,<br>totalLoadTime=2354162371299, evictionCount=1378654}</p>
</blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://guava.dev/releases/19.0/api/docs/com/google/common/cache/CacheBuilder.html#recordStats%28%29">recordStats</a></p>
<h2 id="ECache"><a href="#ECache" class="headerlink" title="ECache"></a>ECache</h2><h3 id="Spring4-ECache-2"><a href="#Spring4-ECache-2" class="headerlink" title="Spring4 + ECache 2"></a>Spring4 + ECache 2</h3><p>整个 namespace 的说明见<a target="_blank" rel="noopener" href="http://www.ehcache.org/ehcache.xml">这里</a>。</p>
<p>具体的配置选项见：</p>
<ul>
<li>name：缓存名称。</li>
<li>maxElementsInMemory：缓存最大个数。</li>
<li>eternal：缓存中对象是否为永久的，如果是，超时设置将被忽略，对象从不过期。</li>
<li>timeToIdleSeconds：置对象在失效前的允许闲置时间（单位：秒）。仅当eternal=false对象不是永久有效时使用，可选属性，默认值是0，也就是可闲置时间无穷大。</li>
<li>timeToLiveSeconds：缓存数据的生存时间（TTL），也就是一个元素从构建到消亡的最大时间间隔值，这只能在元素不是永久驻留时有效，如果该值是0就意味着元素可以停顿无穷长的时间。</li>
<li>maxEntriesLocalDisk：当内存中对象数量达到maxElementsInMemory时，Ehcache将会对象写到磁盘中。</li>
<li>overflowToDisk：内存不足时，是否启用磁盘缓存。</li>
<li>diskSpoolBufferSizeMB：这个参数设置DiskStore（磁盘缓存）的缓存区大小。默认是30MB。每个Cache都应该有自己的一个缓冲区。</li>
<li>maxElementsOnDisk：硬盘最大缓存个数。</li>
<li>diskPersistent：是否在VM重启时存储硬盘的缓存数据。默认值是false。</li>
<li>diskExpiryThreadIntervalSeconds：磁盘失效线程运行时间间隔，默认是120秒。</li>
<li>memoryStoreEvictionPolicy：当达到maxElementsInMemory限制时，Ehcache将会根据指定的策略去清理内存。默认策略是LRU（最近最少使用）。你可以设置为FIFO（先进先出）或是LFU（较少使用）。</li>
<li>clearOnFlush：内存数量最大时是否清除。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">&quot;ehcache.xsd&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">updateCheck</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">monitoring</span>=<span class="string">&quot;autodetect&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">dynamicConfig</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">&quot;java.io.tmpdir&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">&quot;movieFindCache&quot;</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">maxEntriesLocalHeap</span>=<span class="string">&quot;10000&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">maxEntriesLocalDisk</span>=<span class="string">&quot;1000&quot;</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">eternal</span>=<span class="string">&quot;false&quot;</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">diskSpoolBufferSizeMB</span>=<span class="string">&quot;20&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;300&quot;</span> <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;600&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">&quot;LFU&quot;</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">transactionalMode</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">persistence</span> <span class="attr">strategy</span>=<span class="string">&quot;localTempSwap&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的 java code：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mkyong.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.ehcache.EhCacheCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.ehcache.EhCacheManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123; &quot;com.mkyong.*&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EhCacheCacheManager(ehCacheCacheManager().getObject());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EhCacheManagerFactoryBean <span class="title">ehCacheCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EhCacheManagerFactoryBean cmfb = <span class="keyword">new</span> EhCacheManagerFactoryBean();</span><br><span class="line">        cmfb.setConfigLocation(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;ehcache.xml&quot;</span>));</span><br><span class="line">        cmfb.setShared(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> cmfb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.mkyong.movie;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository(&quot;movieDao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieDaoImpl</span> <span class="keyword">implements</span> <span class="title">MovieDao</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This &quot;movieFindCache&quot; is delcares in ehcache.xml</span></span><br><span class="line">    <span class="meta">@Cacheable(value=&quot;movieFindCache&quot;, key=&quot;#name&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Movie <span class="title">findByDirector</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        slowQuery(<span class="number">2000L</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;findByDirector is running...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Movie(<span class="number">1</span>,<span class="string">&quot;Forrest Gump&quot;</span>,<span class="string">&quot;Robert Zemeckis&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">slowQuery</span><span class="params">(<span class="keyword">long</span> seconds)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(seconds);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-Boot-2-ECache3"><a href="#Spring-Boot-2-ECache3" class="headerlink" title="Spring Boot 2 + ECache3"></a>Spring Boot 2 + ECache3</h3><p>ECache 是 Hibernate 中的默认缓存框架。</p>
<p>要引入 javax 的 cache api（JSR-107）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.cache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cache-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的缓存注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumberService</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 配置全都在 Cacheable 接口上</span></span><br><span class="line">    <span class="meta">@Cacheable(</span></span><br><span class="line"><span class="meta">      value = &quot;squareCache&quot;, </span></span><br><span class="line"><span class="meta">      key = &quot;#number&quot;, </span></span><br><span class="line"><span class="meta">      condition = &quot;#number&gt;10&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">square</span><span class="params">(Long number)</span> </span>&#123;</span><br><span class="line">        BigDecimal square = BigDecimal.valueOf(number)</span><br><span class="line">          .multiply(BigDecimal.valueOf(number));</span><br><span class="line">        log.info(<span class="string">&quot;square of &#123;&#125; is &#123;&#125;&quot;</span>, number, square);</span><br><span class="line">        <span class="keyword">return</span> square;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 注意，这里的配置，不需要自己再生成 cachemanager</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheEventLogger</span> </span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">CacheEventListener</span>&lt;<span class="title">Object</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      CacheEvent&lt;? extends Object, ? extends Object&gt; cacheEvent)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="comment">/* message */</span>,</span><br><span class="line">          cacheEvent.getKey(), cacheEvent.getOldValue(), cacheEvent.getNewValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">config</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.ehcache.org/v3&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jsr107</span>=<span class="string">&quot;http://www.ehcache.org/v3/jsr107&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.ehcache.org/v3 http://www.ehcache.org/schema/ehcache-core-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.ehcache.org/v3/jsr107 http://www.ehcache.org/schema/ehcache-107-ext-3.0.xsd&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">alias</span>=<span class="string">&quot;squareCache&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key-type</span>&gt;</span>java.lang.Long<span class="tag">&lt;/<span class="name">key-type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value-type</span>&gt;</span>java.math.BigDecimal<span class="tag">&lt;/<span class="name">value-type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">expiry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ttl</span> <span class="attr">unit</span>=<span class="string">&quot;seconds&quot;</span>&gt;</span>30<span class="tag">&lt;/<span class="name">ttl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">expiry</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">        <span class="tag">&lt;<span class="name">listeners</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.baeldung.cachetest.config.CacheEventLogger<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">event-firing-mode</span>&gt;</span>ASYNCHRONOUS<span class="tag">&lt;/<span class="name">event-firing-mode</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">event-ordering-mode</span>&gt;</span>UNORDERED<span class="tag">&lt;/<span class="name">event-ordering-mode</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">events-to-fire-on</span>&gt;</span>CREATED<span class="tag">&lt;/<span class="name">events-to-fire-on</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">events-to-fire-on</span>&gt;</span>EXPIRED<span class="tag">&lt;/<span class="name">events-to-fire-on</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">listeners</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">heap</span> <span class="attr">unit</span>=<span class="string">&quot;entries&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">heap</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">offheap</span> <span class="attr">unit</span>=<span class="string">&quot;MB&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">offheap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>具体的其他 cache 操作的注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @Cacheable可以设置多个缓存，形式如：@Cacheable(&#123;&quot;books&quot;, &quot;isbns&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@Cacheable(&#123;&quot;users&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> findUserInDB(user.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;users&quot;, condition = &quot;#user.getId() &lt;= 2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserInLimit</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> findUserInDB(user.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CachePut(value = &quot;users&quot;, key = &quot;#user.getId()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        updateUserInDB(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;users&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        removeUserInDB(user.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;users&quot;, allEntries = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        removeAllInDB();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Caching(evict = &#123; @CacheEvict(&quot;primary&quot;), @CacheEvict(cacheNames=&quot;secondary&quot;, key=&quot;#p0&quot;) &#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">importBooks</span><span class="params">(String deposit, Date date)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 与前面的缓存注解不同，这是一个类级别的注解。</span></span></span><br><span class="line"><span class="function">如果类的所有操作都是缓存操作，你可以使用@CacheConfig来指定类，省去一些配置。</span></span><br><span class="line"><span class="function">@<span class="title">CacheConfig</span><span class="params">(<span class="string">&quot;books&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> class BookRepositoryImpl implements BookRepository </span>&#123;</span><br><span class="line">    <span class="meta">@Cacheable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn)</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以考虑，定义自己的 KeyGenerator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyKeyGenerator</span> <span class="keyword">implements</span> <span class="title">KeyGenerator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.getName()+Arrays.toString(params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Cacheable(keyGenerator = &quot;myKeyGenerator&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setId(id);</span><br><span class="line">    user.setUsername(<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，可以用的 key 的缓存专用 SPEL 表达式，在<a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#cache-spel-context">这里</a>。</p>
<h2 id="Caffeine"><a href="#Caffeine" class="headerlink" title="Caffeine"></a>Caffeine</h2><p>它几个特别有意思的特性：time-based eviction、size-based eviction、异步加载、弱引用 key（不考虑 referenceQueue 的特性，WeakReference 是最适合我们用的）。</p>
<ul>
<li>automatic loading of entries into the cache, optionally asynchronously</li>
<li>size-based eviction when a maximum is exceeded based on frequency and recency</li>
<li>time-based expiration of entries, measured since last access or last write</li>
<li>asynchronously refresh when the first stale request for an entry occurs</li>
<li>keys automatically wrapped in weak references</li>
<li>values automatically wrapped in weak or soft references</li>
<li>notification of evicted (or otherwise removed) entries</li>
<li>writes propagated to an external resource</li>
<li>accumulation of cache access statistics</li>
</ul>
<h3 id="不搭配-Spring"><a href="#不搭配-Spring" class="headerlink" title="不搭配 Spring"></a>不搭配 Spring</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>caffeine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .expireAfterWrite(<span class="number">1</span>, TimeUnit.MINUTES)</span><br><span class="line">  .maximumSize(<span class="number">100</span>)</span><br><span class="line">  .build();</span><br><span class="line">  </span><br><span class="line">String key = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">DataObject dataObject = cache.getIfPresent(key);</span><br><span class="line"> </span><br><span class="line">assertNull(dataObject);</span><br><span class="line"></span><br><span class="line">cache.put(key, dataObject);</span><br><span class="line">dataObject = cache.getIfPresent(key);</span><br><span class="line"> </span><br><span class="line">assertNotNull(dataObject);</span><br><span class="line"></span><br><span class="line">dataObject = cache</span><br><span class="line">  .get(key, k -&gt; DataObject.get(<span class="string">&quot;Data for A&quot;</span>));</span><br><span class="line"> </span><br><span class="line">assertNotNull(dataObject);</span><br><span class="line">assertEquals(<span class="string">&quot;Data for A&quot;</span>, dataObject.getData());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步加载</span></span><br><span class="line">LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .maximumSize(<span class="number">100</span>)</span><br><span class="line">  .expireAfterWrite(<span class="number">1</span>, TimeUnit.MINUTES)</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"></span><br><span class="line">DataObject dataObject = cache.get(key);</span><br><span class="line"> </span><br><span class="line">assertNotNull(dataObject);</span><br><span class="line">assertEquals(<span class="string">&quot;Data for &quot;</span> + key, dataObject.getData());</span><br><span class="line"></span><br><span class="line">Map&lt;String, DataObject&gt; dataObjectMap </span><br><span class="line">  = cache.getAll(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>));</span><br><span class="line"> </span><br><span class="line">assertEquals(<span class="number">3</span>, dataObjectMap.size());</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 异步加载</span></span><br><span class="line">AsyncLoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .maximumSize(<span class="number">100</span>)</span><br><span class="line">  .expireAfterWrite(<span class="number">1</span>, TimeUnit.MINUTES)</span><br><span class="line">  .buildAsync(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"></span><br><span class="line">String key = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">cache.get(key).thenAccept(dataObject -&gt; &#123;</span><br><span class="line">    assertNotNull(dataObject);</span><br><span class="line">    assertEquals(<span class="string">&quot;Data for &quot;</span> + key, dataObject.getData());</span><br><span class="line">&#125;);</span><br><span class="line">cache.getAll(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>))</span><br><span class="line">  .thenAccept(dataObjectMap -&gt; assertEquals(<span class="number">3</span>, dataObjectMap.size()));</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于 size 的淘汰</span></span><br><span class="line">LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .maximumSize(<span class="number">1</span>)</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"> </span><br><span class="line">assertEquals(<span class="number">0</span>, cache.estimatedSize());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待异步淘汰完成才同步返回</span></span><br><span class="line">cache.cleanUp();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于权重的淘汰</span></span><br><span class="line">LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .maximumWeight(<span class="number">10</span>)</span><br><span class="line">  .weigher((k,v) -&gt; <span class="number">5</span>)</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"> </span><br><span class="line">assertEquals(<span class="number">0</span>, cache.estimatedSize());</span><br><span class="line"> </span><br><span class="line">cache.get(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">assertEquals(<span class="number">1</span>, cache.estimatedSize());</span><br><span class="line"> </span><br><span class="line">cache.get(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">assertEquals(<span class="number">2</span>, cache.estimatedSize());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于访问时间的淘汰</span></span><br><span class="line">LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .expireAfterAccess(<span class="number">5</span>, TimeUnit.MINUTES)</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于写时间的淘汰</span></span><br><span class="line">cache = Caffeine.newBuilder()</span><br><span class="line">  .expireAfterWrite(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">  .weakKeys()</span><br><span class="line">  .weakValues()</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义基于时间的淘汰策略</span></span><br><span class="line">cache = Caffeine.newBuilder().expireAfter(<span class="keyword">new</span> Expiry&lt;String, DataObject&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">expireAfterCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      String key, DataObject value, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value.getData().length() * <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">expireAfterUpdate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      String key, DataObject value, <span class="keyword">long</span> currentTime, <span class="keyword">long</span> currentDuration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentDuration;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">expireAfterRead</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      String key, DataObject value, <span class="keyword">long</span> currentTime, <span class="keyword">long</span> currentDuration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentDuration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"></span><br><span class="line"><span class="comment">// key 和 value 使用不同的引用。value 只能使用 softValues。</span></span><br><span class="line">LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .expireAfterWrite(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">  .weakKeys()</span><br><span class="line">  .weakValues()</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"> </span><br><span class="line">cache = Caffeine.newBuilder()</span><br><span class="line">  .expireAfterWrite(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">  .softValues()</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动 populate</span></span><br><span class="line">Caffeine.newBuilder()</span><br><span class="line">  .refreshAfterWrite(<span class="number">1</span>, TimeUnit.MINUTES)</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取统计数据</span></span><br><span class="line">LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()</span><br><span class="line">  .maximumSize(<span class="number">100</span>)</span><br><span class="line">  .recordStats()</span><br><span class="line">  .build(k -&gt; DataObject.get(<span class="string">&quot;Data for &quot;</span> + k));</span><br><span class="line">cache.get(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">cache.get(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="number">1</span>, cache.stats().hitCount());</span><br><span class="line">assertEquals(<span class="number">1</span>, cache.stats().missCount());</span><br></pre></td></tr></table></figure>

<h3 id="搭配-Spring"><a href="#搭配-Spring" class="headerlink" title="搭配 Spring"></a>搭配 Spring</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>caffeine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关的配置文件：</p>
<ul>
<li>initialCapacity: # 初始的缓存空间大小</li>
<li>maximumSize: # 缓存的最大条数</li>
<li>maximumWeight: # 缓存的最大权重</li>
<li>expireAfterAccess: # 最后一次写入或访问后经过固定时间过期</li>
<li>expireAfterWrite: # 最后一次写入后经过固定时间过期</li>
<li>refreshAfterWrite: # 创建缓存或者最近一次更新缓存后经过固定的时间间隔，刷新缓存</li>
<li>weakKeys: # 打开 key 的弱引用</li>
<li>weakValues:  # 打开 value 的弱引用</li>
<li>softValues: # 打开 value 的软引用</li>
<li>recordStats: # 开发统计功能</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">caffeine</span></span><br><span class="line">    <span class="attr">caffeine:</span></span><br><span class="line">      <span class="attr">spec:</span> <span class="string">maximumSize=1024</span></span><br><span class="line">    <span class="attr">cache-names:</span> <span class="string">cache1,cache2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaffeineCacheConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  CaffeineCacheManager cacheManager = <span class="keyword">new</span> CaffeineCacheManager(<span class="string">&quot;customer&quot;</span>);</span><br><span class="line">  cacheManager.setCaffeine(caffeineCacheBuilder());</span><br><span class="line">  <span class="keyword">return</span> cacheManager;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> Caffeine &lt; Object, Object &gt; caffeineCacheBuilder() &#123;</span><br><span class="line">  <span class="keyword">return</span> Caffeine.newBuilder()</span><br><span class="line">   .initialCapacity(<span class="number">100</span>)</span><br><span class="line">   .maximumSize(<span class="number">500</span>)</span><br><span class="line">   .expireAfterAccess(<span class="number">10</span>, TimeUnit.MINUTES)</span><br><span class="line">   .weakKeys()</span><br><span class="line">   .recordStats();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CustomerService</span> </span>&#123;</span><br><span class="line">    <span class="function">Customer <span class="title">getCustomer</span><span class="params">(<span class="keyword">final</span> Long customerID)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Implementation</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@CacheConfig(cacheNames = &#123;&quot;customer&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultCustomerService</span> <span class="keyword">implements</span> <span class="title">CustomerService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(DefaultCustomerService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Customer <span class="title">getCustomer</span><span class="params">(Long customerID)</span> </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Trying to get customer information for id &#123;&#125; &quot;</span>,customerID);</span><br><span class="line">        <span class="keyword">return</span> getCustomerData(customerID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Customer <span class="title">getCustomerData</span><span class="params">(<span class="keyword">final</span> Long id)</span></span>&#123;</span><br><span class="line">        Customer customer = <span class="keyword">new</span> Customer(id, <span class="string">&quot;testemail@test.com&quot;</span>, <span class="string">&quot;Test Customer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>  customer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="如何应对缓存-miss-的问题"><a href="#如何应对缓存-miss-的问题" class="headerlink" title="如何应对缓存 miss 的问题"></a>如何应对缓存 miss 的问题</h1><p>cache miss 在中文的语境里经常被人分为缓存击穿、缓存雪崩和缓存穿透，这三种类型并不完全互斥穷举，在概念上极其容易造成混淆。在这一段总结的时候姑且依照这三种类型分别加以论述。</p>
<h2 id="如何应对缓存击穿"><a href="#如何应对缓存击穿" class="headerlink" title="如何应对缓存击穿"></a>如何应对缓存击穿</h2><p>缓存击穿，指的是某个 key 应该访问缓存，却没有访问到，导致缓存通过兜底的策略去更下游的冷存储加载内容，给下游的系统造成了读压力。</p>
<p>应对这个问题的基本思路有：</p>
<ol>
<li><p>事前：</p>
</li>
<li><p>在可能热点数据的访问高峰到达以前，提前把数据预热。</p>
</li>
<li><p>永远不要让缓存失效-这样缓存 stale 以后，怎么保鲜是个巨大的问题，只能靠一个后端的主动更新机制来尽最大努力来更新缓存。这种方案是一致性最差的。</p>
</li>
<li><p>在缓存击穿以前，主动更新缓存，即不让缓存击穿发生，即同时才有 expireAfter(t1) + loadAfter(t2) 的策略。</p>
</li>
<li><p><strong>极端热的数据，不允许缓存被动失效，必须使用主动更新的模式。</strong></p>
</li>
<li><p>并发操作下更新缓存一定要注意顺序！如果有消息来更新更要注意顺序！</p>
</li>
<li><p>定时任务和广播刷新有时候可以互相补充-定时任务是超时的补充。</p>
</li>
<li><p>事中：</p>
</li>
<li><p>在缓存击穿的时候，严格限制读冷存储 + 预热缓存的流量，即有限降级，有损服务。</p>
</li>
<li><p>如果缓存更新是同步读写（Cache Aside 或者 Read/Write Through）的模式，则引入各种限流工具（限制线程数的线程池/信号量/SLA/Rhino/Redis 计数器/线程内计数器/Hystrix/Web 容器的限流器），保障可用性的同时保障吞吐量。</p>
</li>
<li><p>如果缓存更新可以异步主动更新，则考虑单线程执行或者使用消息队列进行低流量更新。能怎样在事中限制这个问题，取决于缓存和读写接入层之间本来的架构关系是如何设计的。</p>
</li>
<li><p>某类特别热的 key 可能一旦失效会导致大量的读，这种 key 的实际更新流程还要加上分布式锁-而且还要使用试锁而不能使用阻塞锁-facebook 的论文里没有提到这种策略，不知道是不是数据很均匀。</p>
</li>
<li><p>事后：</p>
</li>
<li><p>如果系统无法自愈，熔断拒绝服务以后（所以熔断、降级限流每一手准备都要准备好，可以用限流为 0 来制造熔断），手工预热缓存。</p>
</li>
</ol>
<h2 id="如何应对缓存雪崩"><a href="#如何应对缓存雪崩" class="headerlink" title="如何应对缓存雪崩"></a>如何应对缓存雪崩</h2><p>雪崩问题，指的是：大规模的缓存失效，再加上大规模的访问流量，造成对后端非高可用的冷存储（通常是 RDBMS）的大规模读写，导致 RDBMS 可用性下降，甚至整个系统级联崩溃。</p>
<p>从某种意义上，单一缓存的击穿并不可怕，缓存雪崩才是最可怕的。</p>
<p>应对缓存雪崩问题，基本思路是大规模使用应对缓存击穿的基础策略的基础上，把缓存预热的行为模式打散。</p>
<p>基于超时时间的思路是：不同的 key 设置不同的超时时间，让缓存失效不同时到来。但这样并不能完全解决问题，因为缓存并不是失效以后就直接可以被加载上，除非缓存自带异步自加载的机制（很多 in-memory cache 有，但 Redis 没有），否则不均匀的流量还是可能到达缓存后导致大规模击穿。对超时时间的方案的加强版是，采用一套主动更新缓存的机制。</p>
<p>基于预热的思路是：缓存一开始分好集群。允许某些集群的上游准备好熔断，然后集体停下流量以后，使用脚本批量预热整个集群数据。</p>
<h2 id="如何应对缓存穿透"><a href="#如何应对缓存穿透" class="headerlink" title="如何应对缓存穿透"></a>如何应对缓存穿透</h2><p>缓存穿透不同于缓存击穿。</p>
<p>缓存穿透指的是试图查询不存在的缓存数据。</p>
<p>可以针对缓存穿透来刷冷数据，导致整个集群频繁查询冷存储而崩溃。</p>
<p>解决方案有：</p>
<ol>
<li>对明显不符合要求的请求，直接返回 null。</li>
<li>使用一个大的 bitmap 或者布隆过滤器来拦截可能不存在的请求，直接返回 null。</li>
<li>缓存穿透一次，就在 cache 中存上 null - <strong>允许使用 null 的缓存能够天然抵挡缓存穿透问题。Guava 的缺点就在这里被体现出来了</strong></li>
</ol>
<p>以上措施混合使用的话，必须考虑缓存里的 null。 必须有超时时间，而且应该有对应的无 null。 以后主动更新的机制，否则这个空值就被污染了。</p>
<h1 id="远端缓存与近端缓存的辨析"><a href="#远端缓存与近端缓存的辨析" class="headerlink" title="远端缓存与近端缓存的辨析"></a>远端缓存与近端缓存的辨析</h1><p>缓存在哪端，哪端就能定制它的行为，但要供应它消耗的资源。近端缓存通常简单，但也就意味着没有什么功能。</p>
<h2 id="远端缓存的好处"><a href="#远端缓存的好处" class="headerlink" title="远端缓存的好处"></a>远端缓存的好处</h2><p>自带广播、同步和共识功能，能够对接写入服务。<br>自带独立的集群，有专业的运维人员，适合存储海量数据。</p>
<h2 id="远端缓存的坏处"><a href="#远端缓存的坏处" class="headerlink" title="远端缓存的坏处"></a>远端缓存的坏处</h2><p>制造了复杂的依赖，比如接入变复杂、流程变复杂。<br>所有的服务都依赖于一个服务，配置和流程不易于差异化，冲突比例增多。</p>
<h2 id="近端缓存的好处"><a href="#近端缓存的好处" class="headerlink" title="近端缓存的好处"></a>近端缓存的好处</h2><p>接入简单。<br>自己可以把控自己的缓存使用逻辑。</p>
<h2 id="近端缓存的坏处"><a href="#近端缓存的坏处" class="headerlink" title="近端缓存的坏处"></a>近端缓存的坏处</h2><p>相对于广播同步一致性难度大，通信成本高-易引起通信风暴。<br>占用内存变大，无法解决海量数据存储。</p>
<p>参考文献：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/guava-cache">《Guava Cache》</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1058203">美团技术团队的《缓存那些事》</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39639130">例子很多：《caffeine vs ehcache》</a></li>
</ol>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2021-06-25");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2020-03-23T06:17:03.000Z" itemprop="datePublished">2020-03-23</time>

    , Updated at&nbsp;<time datetime="2021-06-25T05:43:06.000Z" itemprop="dateModified">2021-06-25</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" rel="tag">#&nbsp;系统架构</a>

<a class="post-tags-list-item" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">#&nbsp;缓存</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2020/03/23/Optional-%E7%9A%84%E6%AD%A3%E7%A1%AE%E7%94%A8%E6%B3%95/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">Optional 的正确用法
</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2020/03/21/5why%E5%88%86%E6%9E%90%E6%B3%95/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">5why分析法</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>