<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ç¼“å­˜çš„å¥—è·¯ | å®ˆæ ªé˜</title><meta name="author" content="magicliang"><meta name="copyright" content="magicliang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ç¼“å­˜çš„å¥—è·¯ æœ¬æ–‡æ¢è®¨ç¼“å­˜è®¾è®¡çš„é€šç”¨æ¨¡å¼ï¼Œæ¶µç›–ä»é€‰å‹å†³ç­–ã€æ›´æ–°ç­–ç•¥åˆ°æ•…éšœé˜²æŠ¤çš„å®Œæ•´ä½“ç³»ã€‚ mindmap   root((ç¼“å­˜æ¶æ„))     ä½•æ—¶ä½¿ç”¨       è¯»å¤šå†™å°‘       çƒ­ç‚¹é›†ä¸­       å¯å®¹å¿æœ€ç»ˆä¸€è‡´æ€§     ç¼“å­˜å±‚æ¬¡       è¿‘ç«¯ç¼“å­˜         Guava         Caffeine         EhCache       è¿œç«¯ç¼“å­˜         R">
<meta property="og:type" content="article">
<meta property="og:title" content="ç¼“å­˜çš„å¥—è·¯">
<meta property="og:url" content="https://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/index.html">
<meta property="og:site_name" content="å®ˆæ ªé˜">
<meta property="og:description" content="ç¼“å­˜çš„å¥—è·¯ æœ¬æ–‡æ¢è®¨ç¼“å­˜è®¾è®¡çš„é€šç”¨æ¨¡å¼ï¼Œæ¶µç›–ä»é€‰å‹å†³ç­–ã€æ›´æ–°ç­–ç•¥åˆ°æ•…éšœé˜²æŠ¤çš„å®Œæ•´ä½“ç³»ã€‚ mindmap   root((ç¼“å­˜æ¶æ„))     ä½•æ—¶ä½¿ç”¨       è¯»å¤šå†™å°‘       çƒ­ç‚¹é›†ä¸­       å¯å®¹å¿æœ€ç»ˆä¸€è‡´æ€§     ç¼“å­˜å±‚æ¬¡       è¿‘ç«¯ç¼“å­˜         Guava         Caffeine         EhCache       è¿œç«¯ç¼“å­˜         R">
<meta property="og:locale">
<meta property="og:image" content="https://magicliang.github.io/img/wall-paper-137.jpg">
<meta property="article:published_time" content="2020-03-23T06:17:03.000Z">
<meta property="article:modified_time" content="2026-02-07T08:58:14.766Z">
<meta property="article:author" content="magicliang">
<meta property="article:tag" content="ç³»ç»Ÿæ¶æ„">
<meta property="article:tag" content="ç¼“å­˜">
<meta property="article:tag" content="é«˜æ€§èƒ½">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://magicliang.github.io/img/wall-paper-137.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ç¼“å­˜çš„å¥—è·¯",
  "url": "https://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/",
  "image": "https://magicliang.github.io/img/wall-paper-137.jpg",
  "datePublished": "2020-03-23T06:17:03.000Z",
  "dateModified": "2026-02-07T08:58:14.766Z",
  "author": [
    {
      "@type": "Person",
      "name": "magicliang",
      "url": "https://magicliang.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: magicliang","link":"Link: ","source":"Source: å®ˆæ ªé˜","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ç¼“å­˜çš„å¥—è·¯',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="å®ˆæ ªé˜" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/wall-paper-137.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">å®ˆæ ªé˜</span></a><a class="nav-page-title" href="/"><span class="site-name">ç¼“å­˜çš„å¥—è·¯</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">ç¼“å­˜çš„å¥—è·¯</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-03-23T06:17:03.000Z" title="Created 2020-03-23 14:17:03">2020-03-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-02-07T08:58:14.766Z" title="Updated 2026-02-07 16:58:14">2026-02-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">15.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>74mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>ç¼“å­˜çš„å¥—è·¯</h1>
<p>æœ¬æ–‡æ¢è®¨ç¼“å­˜è®¾è®¡çš„é€šç”¨æ¨¡å¼ï¼Œæ¶µç›–ä»é€‰å‹å†³ç­–ã€æ›´æ–°ç­–ç•¥åˆ°æ•…éšœé˜²æŠ¤çš„å®Œæ•´ä½“ç³»ã€‚</p>
<pre><code class="hljs mermaid">mindmap
  root((ç¼“å­˜æ¶æ„))
    ä½•æ—¶ä½¿ç”¨
      è¯»å¤šå†™å°‘
      çƒ­ç‚¹é›†ä¸­
      å¯å®¹å¿æœ€ç»ˆä¸€è‡´æ€§
    ç¼“å­˜å±‚æ¬¡
      è¿‘ç«¯ç¼“å­˜
        Guava
        Caffeine
        EhCache
      è¿œç«¯ç¼“å­˜
        Redis
        Memcached
    æ ¸å¿ƒæŒ‘æˆ˜
      æ›´æ–°ç­–ç•¥
        Cache Aside
        Read Through
        Write Through
        Write Behind
      ä¸€è‡´æ€§ä¿éšœ
      æ•…éšœé˜²æŠ¤
        å‡»ç©¿é˜²æŠ¤
        é›ªå´©é˜²æŠ¤
        ç©¿é€é˜²æŠ¤</code></pre>
<h2 id="æ¨¡å¼æ€»è§ˆ">æ¨¡å¼æ€»è§ˆ</h2>
<table>
<thead>
<tr>
<th>#</th>
<th>æ¨¡å¼åç§°</th>
<th>ä¸€å¥è¯å£è¯€</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>åˆ†å±‚é™çº§</td>
<td>æœ¬åœ°å…œåº•ï¼Œè¿œç¨‹æ‰©å±•</td>
<td>å¤šçº§ç¼“å­˜æ¶æ„</td>
</tr>
<tr>
<td>2</td>
<td>æƒ°æ€§å¡«å……</td>
<td>è§¦å‘åŠ è½½ï¼ŒæŒ‰éœ€æ‰©å®¹</td>
<td>å†·å¯åŠ¨ä¸é¢„çƒ­</td>
</tr>
<tr>
<td>3</td>
<td>æ—è·¯åŒæ­¥</td>
<td>å…ˆåº“ååˆ ï¼Œè¯»å†™äº’æ–¥</td>
<td>Cache Aside æ¨¡å¼</td>
</tr>
<tr>
<td>4</td>
<td>ç©ºå€¼é˜²å¾¡</td>
<td>å­˜ç©ºé˜²å‡»ï¼ŒçŸ­TTLæ§é™©</td>
<td>ç¼“å­˜ç©¿é€é˜²æŠ¤</td>
</tr>
<tr>
<td>5</td>
<td>éšæœºæ•£åˆ—</td>
<td>è¿‡æœŸåˆ†æ•£ï¼Œæ¸è¿›åˆ·æ–°</td>
<td>ç¼“å­˜é›ªå´©é˜²æŠ¤</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ä¸€-ç¼“å­˜çš„æœ¬è´¨ä¸é€‚ç”¨åœºæ™¯">ä¸€ã€ç¼“å­˜çš„æœ¬è´¨ä¸é€‚ç”¨åœºæ™¯</h2>
<h3 id="1-1-ä»€ä¹ˆæ˜¯ç¼“å­˜">1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜</h3>
<p>ç¼“å­˜æ˜¯ä¸€ç§ä»¥<strong>ç©ºé—´æ¢æ—¶é—´</strong>çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œé€šè¿‡åœ¨è®¡ç®—ä»£ä»·è¾ƒé«˜çš„æ•°æ®æºï¼ˆæ•°æ®åº“ã€å¤–éƒ¨æœåŠ¡ç­‰ï¼‰å’Œæ¶ˆè´¹æ–¹ä¹‹é—´æ’å…¥é«˜é€Ÿå­˜å‚¨å±‚ï¼Œå‡å°‘é‡å¤è®¡ç®—çš„æ‰§è¡Œæ¬¡æ•°ã€‚</p>
<h3 id="1-2-ä½•æ—¶ä½¿ç”¨ç¼“å­˜">1.2 ä½•æ—¶ä½¿ç”¨ç¼“å­˜</h3>
<p>æ»¡è¶³ä»¥ä¸‹å…¨éƒ¨æ¡ä»¶çš„åœºæ™¯é€‚åˆå¼•å…¥ç¼“å­˜ï¼š</p>
<ul>
<li><strong>è¯»å¤šå†™å°‘</strong>ï¼šè¯»æ“ä½œå æ¯”æ˜¾è‘—é«˜äºå†™æ“ä½œï¼ˆå…¸å‹æ¯”ä¾‹ &gt; 10:1ï¼‰</li>
<li><strong>çƒ­ç‚¹é›†ä¸­</strong>ï¼šå°éƒ¨åˆ†æ•°æ®æ‰¿æ‹…å¤§éƒ¨åˆ†è®¿é—®æµé‡ï¼ˆå¸•ç´¯æ‰˜åˆ†å¸ƒï¼‰</li>
<li><strong>å¯å®¹å¿æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šä¸šåŠ¡é€»è¾‘èƒ½æ¥å—çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´çª—å£</li>
<li><strong>è®¡ç®—ä»£ä»·é«˜</strong>ï¼šåŸå§‹æ•°æ®æºå“åº”æ…¢æˆ–èµ„æºæ¶ˆè€—å¤§</li>
</ul>
<h3 id="1-3-ä¸é€‚ç”¨ç¼“å­˜çš„åœºæ™¯">1.3 ä¸é€‚ç”¨ç¼“å­˜çš„åœºæ™¯</h3>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>åŸå› </th>
</tr>
</thead>
<tbody>
<tr>
<td>å®æ—¶æ€§è¦æ±‚æé«˜ï¼ˆå¦‚äº¤æ˜“æ’®åˆï¼‰</td>
<td>æ¯«ç§’çº§å»¶è¿Ÿæ— æ³•æ¥å—ä»»ä½•ç¼“å­˜å¤±æ•ˆ</td>
</tr>
<tr>
<td>å†™å¤šè¯»å°‘</td>
<td>åŒæ­¥æˆæœ¬è¶…è¿‡ç¼“å­˜æ”¶ç›Š</td>
</tr>
<tr>
<td>æ•°æ®å˜åŒ–æå¿«ï¼ˆå¦‚è‚¡ç¥¨è¡Œæƒ…ï¼‰</td>
<td>ç¼“å­˜å‘½ä¸­ç‡è¶‹è¿‘äºé›¶</td>
</tr>
<tr>
<td>æ•°æ®é‡æå¤§ä½†æ— çƒ­ç‚¹</td>
<td>ç¼“å­˜æ— æ³•æœ‰æ•ˆç¼©å‡æ•°æ®é›†</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="äºŒ-ç¼“å­˜çš„å±‚æ¬¡ä¸é€‰å‹">äºŒã€ç¼“å­˜çš„å±‚æ¬¡ä¸é€‰å‹</h2>
<h3 id="2-1-è¿‘ç«¯ç¼“å­˜-vs-è¿œç«¯ç¼“å­˜">2.1 è¿‘ç«¯ç¼“å­˜ vs è¿œç«¯ç¼“å­˜</h3>
<p>ç¼“å­˜æŒ‰éƒ¨ç½²ä½ç½®åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>è¿‘ç«¯ç¼“å­˜ (In-Memory)</th>
<th>è¿œç«¯ç¼“å­˜ (Remote)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å…¸å‹å®ç°</strong></td>
<td>Guava, Caffeine, EhCache</td>
<td>Redis, Memcached</td>
</tr>
<tr>
<td><strong>è®¿é—®å»¶è¿Ÿ</strong></td>
<td>å¾®ç§’çº§ï¼ˆ~100Î¼sï¼‰</td>
<td>æ¯«ç§’çº§ï¼ˆ~1-5msï¼‰</td>
</tr>
<tr>
<td><strong>å®¹é‡é™åˆ¶</strong></td>
<td>å—é™äºå•èŠ‚ç‚¹å†…å­˜</td>
<td>æ°´å¹³æ‰©å±•</td>
</tr>
<tr>
<td><strong>æ•°æ®å…±äº«</strong></td>
<td>è¿›ç¨‹ç§æœ‰</td>
<td>å¤šè¿›ç¨‹å…±äº«</td>
</tr>
<tr>
<td><strong>è¿ç»´å¤æ‚åº¦</strong></td>
<td>ä½ï¼ˆå†…ç½®ï¼‰</td>
<td>é«˜ï¼ˆç‹¬ç«‹é›†ç¾¤ï¼‰</td>
</tr>
</tbody>
</table>
<h3 id="2-2-å…³äºå¤šçº§ç¼“å­˜">2.2 å…³äºå¤šçº§ç¼“å­˜</h3>
<p>å¤šçº§ç¼“å­˜ï¼ˆæœ¬åœ° + è¿œç«¯ï¼‰çš„è®¾è®¡éœ€è°¨æ…è¯„ä¼°ï¼š</p>
<p><strong>å¯è¡Œåœºæ™¯</strong></p>
<ul>
<li>L1ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰â€”â€”å­˜å‚¨æçƒ­æ•°æ®</li>
<li>L2ï¼šè¿œç«¯ç¼“å­˜ï¼ˆRedisï¼‰â€”â€”å­˜å‚¨çƒ­æ•°æ®</li>
<li>å·®å¼‚åŒ– TTLï¼šL1 TTL &lt;&lt; L2 TTL</li>
</ul>
<p><strong>é£é™©ç‚¹</strong></p>
<ul>
<li>ä¸€è‡´æ€§é—®é¢˜ï¼šæ›´æ–°æ—¶éœ€è¦åŒæ—¶å¤±æ•ˆå¤šä¸ªå±‚çº§</li>
<li>å¤æ‚æ€§å€å¢ï¼šæ¯ä¸ªå±‚çº§éƒ½éœ€è¦ç‹¬ç«‹çš„å®¹é‡è§„åˆ’ã€ç›‘æ§ã€æ•…éšœé¢„æ¡ˆ</li>
</ul>
<p><strong>å»ºè®®</strong></p>
<ul>
<li>å¤šæ•°åº”ç”¨ä»å•ä¸€è¿œç«¯ç¼“å­˜èµ·æ­¥å³å¯</li>
<li>ä»…åœ¨ QPS &gt; 10ä¸‡ä¸” p99 å»¶è¿Ÿ &lt; 1ms ä¸ºç¡¬æ€§ SLA æ—¶è€ƒè™‘å¤šçº§ç¼“å­˜</li>
</ul>
<hr>
<h2 id="ä¸‰-ç¼“å­˜æ›´æ–°ç­–ç•¥">ä¸‰ã€ç¼“å­˜æ›´æ–°ç­–ç•¥</h2>
<p>ç¼“å­˜ä¸æ•°æ®æºçš„ä¸€è‡´æ€§ç»´æŠ¤æ˜¯æ ¸å¿ƒæŒ‘æˆ˜ï¼Œä¸šç•Œå½¢æˆäº†å››ç§ç»å…¸æ¨¡å¼ï¼š</p>
<h3 id="3-1-cache-aside-æ—è·¯ç¼“å­˜">3.1 Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰</h3>
<p>æœ€å¸¸ç”¨çš„æ¨¡å¼ï¼Œç”±åº”ç”¨ç¨‹åºæ˜¾å¼æ§åˆ¶ç¼“å­˜ä¸æ•°æ®åº“çš„äº¤äº’ã€‚</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xl">è¯»å–æµç¨‹ï¼š<br>  C<span class="hljs-function"><span class="hljs-title">lient</span> -&gt;</span> C<span class="hljs-function"><span class="hljs-title">ache</span> Miss? -&gt;</span> L<span class="hljs-function"><span class="hljs-title">oad</span> from DB -&gt;</span> P<span class="hljs-function"><span class="hljs-title">opulate</span> Cache -&gt;</span> Return Data<br>  <br>å†™å…¥æµç¨‹ï¼š<br>  C<span class="hljs-function"><span class="hljs-title">lient</span> -&gt;</span> U<span class="hljs-function"><span class="hljs-title">pdate</span> DB -&gt;</span> Delete Cache (éæ›´æ–°ç¼“å­˜)<br></code></pre></td></tr></table></figure>
<p><strong>ä¸ºä»€ä¹ˆå†™å…¥æ—¶æ˜¯ Delete è€Œé Updateï¼Ÿ</strong></p>
<p>Update æ¨¡å¼åœ¨å¹¶å‘åœºæ™¯ä¸‹å­˜åœ¨ç«æ€æ¡ä»¶ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">T1: æ›´æ–°æ•°æ®åº“ <span class="hljs-attribute">A</span>=1<br>T2: æ›´æ–°æ•°æ®åº“ <span class="hljs-attribute">A</span>=2, æ›´æ–°ç¼“å­˜ <span class="hljs-attribute">A</span>=2<br>T1: æ›´æ–°ç¼“å­˜ <span class="hljs-attribute">A</span>=1  (è¦†ç›–äº†T2çš„æ­£ç¡®å€¼ï¼Œå¯¼è‡´ä¸ä¸€è‡´)<br></code></pre></td></tr></table></figure>
<p>Delete æ¨¡å¼ä¸‹ï¼Œä¸‹æ¬¡è¯»å–ä¼šä»æ•°æ®åº“åŠ è½½æœ€æ–°å€¼ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<h3 id="3-2-read-through-write-through">3.2 Read Through / Write Through</h3>
<p>ç¼“å­˜ç»„ä»¶æ¥ç®¡æ•°æ®è®¿é—®ï¼Œå¯¹åº”ç”¨é€æ˜ã€‚</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xl">R<span class="hljs-function"><span class="hljs-title">ead</span> Through: Client -&gt;</span> C<span class="hljs-function"><span class="hljs-title">ache</span> -&gt;</span> (Missæ—¶Cacheè‡ªåŠ¨ä»DBåŠ è½½)<br>W<span class="hljs-function"><span class="hljs-title">rite</span> Through: Client -&gt;</span> C<span class="hljs-function"><span class="hljs-title">ache</span> -&gt;</span> C<span class="hljs-function"><span class="hljs-title">ache</span>åŒæ­¥å†™å…¥DB -&gt;</span> è¿”å›æˆåŠŸ<br></code></pre></td></tr></table></figure>
<p><strong>ç‰¹ç‚¹</strong></p>
<ul>
<li>ç®€åŒ–åº”ç”¨é€»è¾‘ï¼Œæ— éœ€å¤„ç†ç¼“å­˜ç»†èŠ‚</li>
<li>å¼ºè€¦åˆäºç‰¹å®šç¼“å­˜æ¡†æ¶</li>
<li>Write Through å†™å»¶è¿Ÿè¾ƒé«˜ï¼ˆéœ€ç­‰å¾…åŒå†™å®Œæˆï¼‰</li>
</ul>
<h3 id="3-3-write-behind-å¼‚æ­¥å›å†™">3.3 Write Behindï¼ˆå¼‚æ­¥å›å†™ï¼‰</h3>
<p>å†™å…¥æ“ä½œä»…æ›´æ–°ç¼“å­˜ï¼Œç”±åå°çº¿ç¨‹å¼‚æ­¥æ‰¹é‡åˆ·ç›˜åˆ°æ•°æ®åº“ã€‚</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xl">C<span class="hljs-function"><span class="hljs-title">lient</span> -&gt;</span> U<span class="hljs-function"><span class="hljs-title">pdate</span> Cache -&gt;</span> ç«‹å³è¿”å›æˆåŠŸ<br>                    â””-&gt; å¼‚æ­¥çº¿ç¨‹æ‰¹é‡ flush åˆ° DB<br></code></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿</strong></p>
<ul>
<li>å†™æ€§èƒ½æœ€ä¼˜ï¼ˆçº¯å†…å­˜æ“ä½œï¼‰</li>
<li>å¯åˆå¹¶å¤šæ¬¡æ›´æ–°ï¼Œé™ä½ DB å‹åŠ›</li>
</ul>
<p><strong>é£é™©</strong></p>
<ul>
<li>æ•°æ®ä¸¢å¤±çª—å£ï¼šå®•æœºæ—¶æœª flush çš„æ•°æ®ä¸¢å¤±</li>
<li>å®ç°å¤æ‚ï¼šéœ€å¤„ç†äº‹åŠ¡è¾¹ç•Œã€å¤±è´¥é‡è¯•ã€å¹‚ç­‰é—®é¢˜</li>
</ul>
<h3 id="3-4-ç­–ç•¥å¯¹æ¯”">3.4 ç­–ç•¥å¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>ä¸€è‡´æ€§</th>
<th>è¯»æ€§èƒ½</th>
<th>å†™æ€§èƒ½</th>
<th>å®ç°å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cache Aside</td>
<td>æœ€ç»ˆä¸€è‡´</td>
<td>é«˜</td>
<td>é«˜</td>
<td>ä½</td>
</tr>
<tr>
<td>Read Through</td>
<td>æœ€ç»ˆä¸€è‡´</td>
<td>é«˜</td>
<td>-</td>
<td>ä¸­</td>
</tr>
<tr>
<td>Write Through</td>
<td>å¼ºä¸€è‡´</td>
<td>-</td>
<td>ä½</td>
<td>ä¸­</td>
</tr>
<tr>
<td>Write Behind</td>
<td>å¼±ä¸€è‡´</td>
<td>-</td>
<td>æœ€é«˜</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å››-java-è¿›ç¨‹å†…ç¼“å­˜è¯¦è§£">å››ã€Java è¿›ç¨‹å†…ç¼“å­˜è¯¦è§£</h2>
<h3 id="4-1-guava-cache">4.1 Guava Cache</h3>
<p>Guava Cache æ˜¯ Google æä¾›çš„è½»é‡çº§ç¼“å­˜åº“ï¼Œè®¾è®¡ä¸Šæ˜¯å¯¹ <code>ConcurrentHashMap</code> çš„å¢å¼ºã€‚</p>
<p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœ€å¤§å®¹é‡é™åˆ¶</td>
<td>åŸºäºæ•°é‡æˆ–æƒé‡</td>
</tr>
<tr>
<td>è¿‡æœŸç­–ç•¥</td>
<td>expireAfterWrite / expireAfterAccess</td>
</tr>
<tr>
<td>åˆ·æ–°æœºåˆ¶</td>
<td>refreshAfterWriteï¼ˆå¼‚æ­¥åˆ·æ–°ï¼Œä¸é˜»å¡è¯»ï¼‰</td>
</tr>
<tr>
<td>å¼•ç”¨ç±»å‹</td>
<td>æ”¯æŒ weakKeys / weakValues / softValues</td>
</tr>
<tr>
<td>ç»Ÿè®¡ä¿¡æ¯</td>
<td>hit/miss/eviction è®¡æ•°</td>
</tr>
</tbody>
</table>
<p><strong>åŸºæœ¬ç”¨æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.cache.CacheBuilder;<br><span class="hljs-keyword">import</span> com.google.common.cache.LoadingCache;<br><span class="hljs-keyword">import</span> com.google.common.cache.CacheLoader;<br><br>LoadingCache&lt;String, User&gt; userCache = CacheBuilder.newBuilder()<br>    .maximumSize(<span class="hljs-number">10000</span>)<br>    .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)<br>    .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// å¼‚æ­¥åˆ·æ–°</span><br>    .recordStats()  <span class="hljs-comment">// å¼€å¯ç»Ÿè®¡</span><br>    .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, User&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> User <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-keyword">return</span> loadUserFromDatabase(key);  <span class="hljs-comment">// å›æºæ–¹æ³•</span><br>        &#125;<br>    &#125;);<br><br><span class="hljs-comment">// è·å–ï¼ˆå‘½ä¸­åˆ™è¿”å›ï¼Œæœªå‘½ä¸­åˆ™è°ƒç”¨ loadï¼‰</span><br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userCache.get(userId);<br></code></pre></td></tr></table></figure>
<p><strong>âš ï¸ é‡è¦é™åˆ¶ï¼šGuava Cache ä¸æ”¯æŒ null value</strong></p>
<p>Guava Cache çš„è®¾è®¡å“²å­¦å°† <code>null</code> è§†ä¸º&quot;è¯¥ key æ— å¯¹åº”æ•°æ®&quot;ï¼Œå› æ­¤ç¦æ­¢å­˜å…¥ nullã€‚è¿™å¯¼è‡´ä¸€ä¸ªå®é™…é—®é¢˜ï¼š<strong>å¦‚ä½•å¤„ç†ç¼“å­˜ç©¿é€ï¼Ÿ</strong></p>
<p>è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç©ºå¯¹è±¡æ¨¡å¼ï¼ˆNull Object Patternï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">User</span> <span class="hljs-variable">EMPTY_USER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();  <span class="hljs-comment">// æ ‡è®°ç©ºç”¨æˆ·</span><br><br>LoadingCache&lt;String, Optional&lt;User&gt;&gt; userCache = CacheBuilder.newBuilder()<br>    .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, Optional&lt;User&gt;&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Optional&lt;User&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> loadUserFromDatabase(key);<br>            <span class="hljs-keyword">return</span> Optional.ofNullable(user != <span class="hljs-literal">null</span> ? user : EMPTY_USER);<br>        &#125;<br>    &#125;);<br><br>Optional&lt;User&gt; result = userCache.get(userId);<br><span class="hljs-keyword">if</span> (result.isPresent() &amp;&amp; result.get() != EMPTY_USER) &#123;<br>    <span class="hljs-keyword">return</span> result.get();<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure>
<h3 id="4-2-caffeine">4.2 Caffeine</h3>
<p>Caffeine æ˜¯ Guava Cache çš„é«˜æ€§èƒ½æ›¿ä»£å“ï¼Œé‡‡ç”¨ Window-TinyLFU æ·˜æ±°ç®—æ³•ï¼Œæ€§èƒ½æ˜¾è‘—ä¼˜äº Guava çš„ LRUã€‚</p>
<p><strong>æ¼”è¿›å…³ç³»</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">concurrentlinkedhashmap (<span class="hljs-keyword">Ben </span>Manes)<br>        â†“<br>    Guava <span class="hljs-keyword">Cache </span>(Google)<br>        â†“<br>    Caffeine (<span class="hljs-keyword">Ben </span>Manes, <span class="hljs-keyword">Java </span><span class="hljs-number">8</span>)<br></code></pre></td></tr></table></figure>
<p><strong>å…³é”®æ”¹è¿›</strong></p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>Guava</th>
<th>Caffeine</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ·˜æ±°ç®—æ³•</td>
<td>Segmented LRU</td>
<td>W-TinyLFU</td>
</tr>
<tr>
<td>å¹¶å‘æ¨¡å‹</td>
<td>åˆ†æ®µé”</td>
<td>æ— é” + RingBuffer</td>
</tr>
<tr>
<td>åˆ·æ–°æœºåˆ¶</td>
<td>åŒæ­¥é˜»å¡</td>
<td>å…¨å¼‚æ­¥</td>
</tr>
<tr>
<td>ç»Ÿè®¡ç²¾åº¦</td>
<td>ç®€å•è®¡æ•°</td>
<td>é¢‘ç‡ç´ æ</td>
</tr>
</tbody>
</table>
<p><strong>å¼‚æ­¥åŠ è½½ç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;<br><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.AsyncLoadingCache;<br><br>AsyncLoadingCache&lt;String, User&gt; asyncCache = Caffeine.newBuilder()<br>    .maximumSize(<span class="hljs-number">10000</span>)<br>    .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)<br>    .executor(Executors.newFixedThreadPool(<span class="hljs-number">10</span>))  <span class="hljs-comment">// è‡ªå®šä¹‰æ‰§è¡Œå™¨</span><br>    .buildAsync((key, executor) -&gt; <br>        CompletableFuture.supplyAsync(() -&gt; loadUser(key), executor)<br>    );<br><br><span class="hljs-comment">// å¼‚æ­¥è·å–ï¼Œä¸é˜»å¡</span><br>CompletableFuture&lt;User&gt; future = asyncCache.get(userId);<br>future.thenAccept(user -&gt; System.out.println(user.getName()));<br></code></pre></td></tr></table></figure>
<h3 id="4-3-ehcache-3">4.3 EhCache 3</h3>
<p>EhCache æ˜¯å”¯ä¸€æ”¯æŒæŒä¹…åŒ–çš„æœ¬åœ°ç¼“å­˜ï¼Œé€‚åˆå¤§å®¹é‡ã€å¯å®¹å¿ç£ç›˜è®¿é—®å»¶è¿Ÿçš„åœºæ™¯ã€‚</p>
<p><strong>å †å†…å¤–åˆ†å±‚é…ç½®</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">config</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.ehcache.org/v3&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;largeDataCache&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">key-type</span>&gt;</span>java.lang.Long<span class="hljs-tag">&lt;/<span class="hljs-name">key-type</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">value-type</span>&gt;</span>java.io.Serializable<span class="hljs-tag">&lt;/<span class="hljs-name">value-type</span>&gt;</span><br>        <br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- å †å†…ç¼“å­˜ --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">heap</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">&quot;entries&quot;</span>&gt;</span>1000<span class="hljs-tag">&lt;/<span class="hljs-name">heap</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- å †å¤–å†…å­˜ï¼ˆé¿å… GC å‹åŠ›ï¼‰ --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">offheap</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">&quot;MB&quot;</span>&gt;</span>128<span class="hljs-tag">&lt;/<span class="hljs-name">offheap</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- ç£ç›˜æŒä¹…åŒ– --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">disk</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">&quot;GB&quot;</span>&gt;</span>10<span class="hljs-tag">&lt;/<span class="hljs-name">disk</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <br>        <span class="hljs-tag">&lt;<span class="hljs-name">expiry</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ttl</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">&quot;minutes&quot;</span>&gt;</span>60<span class="hljs-tag">&lt;/<span class="hljs-name">ttl</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">expiry</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">cache</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">config</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p><strong>ä¸ Spring Boot é›†æˆ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> &#123;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CachingProvider</span> <span class="hljs-variable">provider</span> <span class="hljs-operator">=</span> Caching.getCachingProvider();<br>        <span class="hljs-type">CacheManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> provider.getCacheManager();<br>        <br>        <span class="hljs-comment">// æˆ–é€šè¿‡ ehcache.xml é…ç½®</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JCacheCacheManager</span>(manager);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h2 id="äº”-åˆ†å¸ƒå¼ç¼“å­˜ï¼šredis">äº”ã€åˆ†å¸ƒå¼ç¼“å­˜ï¼šRedis</h2>
<p>Redis æ˜¯ç›®å‰æœ€æµè¡Œçš„åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæœ¬èŠ‚èšç„¦ Java å®¢æˆ·ç«¯çš„æœ€ä½³å®è·µã€‚</p>
<h3 id="5-1-å®¢æˆ·ç«¯é€‰æ‹©">5.1 å®¢æˆ·ç«¯é€‰æ‹©</h3>
<table>
<thead>
<tr>
<th>å®¢æˆ·ç«¯</th>
<th>è¿æ¥æ–¹å¼</th>
<th>ç‰¹æ€§</th>
<th>æ¨èåœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jedis</td>
<td>ç›´è¿</td>
<td>æˆç†Ÿç¨³å®šï¼ŒAPIä¸°å¯Œ</td>
<td>å•æœºæˆ–ç®€å•åˆ†ç‰‡</td>
</tr>
<tr>
<td>Lettuce</td>
<td>Netty + å¼‚æ­¥</td>
<td>å“åº”å¼ç¼–ç¨‹ï¼Œé›†ç¾¤å‹å¥½</td>
<td>é«˜å¹¶å‘ã€Reactive</td>
</tr>
<tr>
<td>Redisson</td>
<td>é«˜çº§å°è£…</td>
<td>åˆ†å¸ƒå¼é”ã€å¯¹è±¡æ˜ å°„</td>
<td>éœ€è¦åˆ†å¸ƒå¼åè°ƒ</td>
</tr>
</tbody>
</table>
<h3 id="5-2-spring-data-redis-é…ç½®">5.2 Spring Data Redis é…ç½®</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">50</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">3000ms</span><br>      <span class="hljs-attr">timeout:</span> <span class="hljs-string">2000ms</span><br></code></pre></td></tr></table></figure>
<h3 id="5-3-ç¼“å­˜åºåˆ—åŒ–">5.3 ç¼“å­˜åºåˆ—åŒ–</h3>
<p>é»˜è®¤ JDK åºåˆ—åŒ–å­˜åœ¨æ€§èƒ½å’Œç©ºé—´é—®é¢˜ï¼Œæ¨èé…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>    RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>    template.setConnectionFactory(factory);<br>    <br>    <span class="hljs-comment">// Key ä½¿ç”¨ String</span><br>    template.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>    template.setHashKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>    <br>    <span class="hljs-comment">// Value ä½¿ç”¨ JSON</span><br>    Jackson2JsonRedisSerializer&lt;Object&gt; jsonSerializer = <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);<br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    mapper.registerModule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaTimeModule</span>());  <span class="hljs-comment">// JDK8æ—¥æœŸæ”¯æŒ</span><br>    mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);<br>    jsonSerializer.setObjectMapper(mapper);<br>    <br>    template.setValueSerializer(jsonSerializer);<br>    template.afterPropertiesSet();<br>    <span class="hljs-keyword">return</span> template;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h2 id="å…­-ç¼“å­˜æ•…éšœé˜²æŠ¤">å…­ã€ç¼“å­˜æ•…éšœé˜²æŠ¤</h2>
<p>ç¼“å­˜ç³»ç»Ÿé¢ä¸´ä¸‰ç±»å…¸å‹æ•…éšœåœºæ™¯ï¼Œæ¯ç±»éƒ½æœ‰å¯¹åº”çš„é˜²æŠ¤æ¨¡å¼ã€‚</p>
<h3 id="6-1-ç¼“å­˜å‡»ç©¿-hot-key-expiration">6.1 ç¼“å­˜å‡»ç©¿ï¼ˆHot Key Expirationï¼‰</h3>
<p><strong>ç°è±¡</strong>ï¼šçƒ­ç‚¹ key è¿‡æœŸç¬é—´ï¼Œå¤§é‡è¯·æ±‚åŒæ—¶ç©¿é€åˆ°æ•°æ®åº“ã€‚</p>
<p><strong>é˜²æŠ¤æ¨¡å¼</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>åŸç†</th>
<th>å®ç°</th>
</tr>
</thead>
<tbody>
<tr>
<td>äº’æ–¥é‡å»º</td>
<td>å•çº¿ç¨‹å›æºï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…</td>
<td>åˆ†å¸ƒå¼é”æˆ–æœ¬åœ° synchronized</td>
</tr>
<tr>
<td>é€»è¾‘è¿‡æœŸ</td>
<td>ä¸è®¾ç½®ç‰©ç† TTLï¼Œé€šè¿‡é€»è¾‘å­—æ®µåˆ¤æ–­æ˜¯å¦è¿‡æœŸ</td>
<td>å»¶é•¿å®é™… TTLï¼Œåå°å¼‚æ­¥åˆ·æ–°</td>
</tr>
<tr>
<td>çƒ­ç‚¹è¯†åˆ«</td>
<td>é¢„åŠ è½½å³å°†è¿‡æœŸçš„çƒ­ key</td>
<td>è®¿é—®ç»Ÿè®¡ + ä¸»åŠ¨åˆ·æ–°</td>
</tr>
</tbody>
</table>
<p><strong>Guava äº’æ–¥é‡å»ºç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">LoadingCache&lt;String, User&gt; cache = CacheBuilder.newBuilder()<br>    .expireAfterWrite(<span class="hljs-number">5</span>, TimeUnit.MINUTES)<br>    .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// æå‰åˆ·æ–°ï¼Œé¿å…è¿‡æœŸ</span><br>    .build(CacheLoader.from(<span class="hljs-built_in">this</span>::loadUser));<br><br><span class="hljs-comment">// CacheLoader çš„ load æ–¹æ³•æ˜¯åŸå­æ€§çš„ï¼Œå¤©ç„¶é˜²æ­¢å¹¶å‘å‡»ç©¿</span><br></code></pre></td></tr></table></figure>
<h3 id="6-2-ç¼“å­˜é›ªå´©-mass-expiration">6.2 ç¼“å­˜é›ªå´©ï¼ˆMass Expirationï¼‰</h3>
<p><strong>ç°è±¡</strong>ï¼šå¤§é‡ key åŒæ—¶è¿‡æœŸï¼Œå¼•å‘æ•°æ®åº“æµé‡æ´ªå³°ã€‚</p>
<p><strong>é˜²æŠ¤æ¨¡å¼ï¼šéšæœºæ•£åˆ—</strong></p>
<p>åœ¨åŸºç¡€ TTL ä¸Šå¢åŠ éšæœºåç§»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">baseTtlSeconds</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span>;  <span class="hljs-comment">// 1å°æ—¶</span><br><span class="hljs-type">int</span> <span class="hljs-variable">randomOffset</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current().nextInt(<span class="hljs-number">600</span>);  <span class="hljs-comment">// 0-10åˆ†é’Ÿ</span><br>redisTemplate.opsForValue().set(key, value, <br>    baseTtlSeconds + randomOffset, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>
<p>å¯¹äºå®šæ—¶ä»»åŠ¡åˆ·æ–°çš„åœºæ™¯ï¼Œé‡‡ç”¨<strong>é˜¶æ¢¯è¿‡æœŸ</strong>ï¼šå°†æ•°æ®åˆ†æ‰¹ï¼Œæ¯æ‰¹åœ¨ä¸åŒæ—¶é—´ç‚¹åˆ·æ–°ã€‚</p>
<h3 id="6-3-ç¼“å­˜ç©¿é€-phantom-key">6.3 ç¼“å­˜ç©¿é€ï¼ˆPhantom Keyï¼‰</h3>
<p><strong>ç°è±¡</strong>ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œæ¯æ¬¡éƒ½ç©¿é€åˆ°æ•°æ®åº“ã€‚</p>
<p><strong>é˜²æŠ¤æ¨¡å¼ï¼šç©ºå€¼é˜²å¾¡</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String userId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + userId;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">cached</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);<br>    <br>    <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// ç©ºå¯¹è±¡æ ‡è®°ï¼Œé˜²æ­¢é‡å¤ç©¿é€</span><br>        <span class="hljs-keyword">if</span> (cached == EMPTY_USER) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> cached;<br>    &#125;<br>    <br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(userId);<br>    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) &#123;<br>        redisTemplate.opsForValue().set(cacheKey, user, <span class="hljs-number">1</span>, TimeUnit.HOURS);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ç¼“å­˜ç©ºå¯¹è±¡ï¼ŒçŸ­ TTL</span><br>        redisTemplate.opsForValue().set(cacheKey, EMPTY_USER, <span class="hljs-number">5</span>, TimeUnit.MINUTES);<br>    &#125;<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>è¿›é˜¶ï¼šå¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª</strong></p>
<p>å¯¹äºæŸ¥è¯¢æ¨¡å¼å›ºå®šçš„åœºæ™¯ï¼Œå¯ç”¨å¸ƒéš†è¿‡æ»¤å™¨å‰ç½®è¿‡æ»¤ï¼š</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Client -&gt; Bloom Filter Check? <br>   â””â”€ å¯èƒ½å­˜åœ¨ -&gt; Query Cache -&gt; <span class="hljs-function"><span class="hljs-params">(Miss)</span> -&gt;</span> Query DB<br>   â””â”€ è‚¯å®šä¸å­˜åœ¨ -&gt; ç›´æ¥è¿”å› Null<br></code></pre></td></tr></table></figure>
<hr>
<h2 id="ä¸ƒ-ğŸ”‘-æ¨¡å¼æç‚¼">ä¸ƒã€ğŸ”‘ æ¨¡å¼æç‚¼</h2>
<h3 id="æ¨¡å¼ä¸€ï¼šåˆ†å±‚é™çº§">æ¨¡å¼ä¸€ï¼šåˆ†å±‚é™çº§</h3>
<p><strong>å…¬å¼</strong>ï¼š<code>L1(é«˜é¢‘å°å®¹é‡) â†’ L2(ä¸­é¢‘å¤§å®¹é‡) â†’ Origin</code></p>
<p><strong>è¿ç§»è¡¨</strong></p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>L1</th>
<th>L2</th>
<th>Origin</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç”¨æˆ·ä¿¡æ¯</td>
<td>Caffeine (10s)</td>
<td>Redis (1h)</td>
<td>MySQL</td>
</tr>
<tr>
<td>é…ç½®é¡¹</td>
<td>Guava (1min)</td>
<td>Consul</td>
<td>Config Server</td>
</tr>
<tr>
<td>API é™æµçŠ¶æ€</td>
<td>Local Counter</td>
<td>Redis Cell</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>æ ¸å¿ƒæ´å¯Ÿ</strong>ï¼šæ¯ä¸€å±‚çš„èŒè´£æ˜¯&quot;æŒ¡ä½ä¸Šä¸€å±‚çš„ç©¿é€&quot;ï¼ŒTTL å¿…é¡»é€å±‚é€’å¢ï¼Œå¦åˆ™å¤±å»åˆ†å±‚æ„ä¹‰ã€‚</p>
<h3 id="æ¨¡å¼äºŒï¼šæƒ°æ€§å¡«å……">æ¨¡å¼äºŒï¼šæƒ°æ€§å¡«å……</h3>
<p><strong>å…¬å¼</strong>ï¼š<code>On-Demand = Trigger(Load(Key) -&gt; Store) -&gt; Return</code></p>
<p><strong>è¿ç§»è¡¨</strong></p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>è§¦å‘æ¡ä»¶</th>
<th>åŠ è½½æ¥æº</th>
<th>åº”ç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¼“å­˜é¢„çƒ­</td>
<td>ç³»ç»Ÿå¯åŠ¨/å®šæ—¶ä»»åŠ¡</td>
<td>æ•°æ®åº“å…¨é‡æ‰«æ</td>
<td>å•†å“ç±»ç›®</td>
</tr>
<tr>
<td>æ‡’åŠ è½½</td>
<td>é¦–æ¬¡è®¿é—® miss</td>
<td>å•æ¡æŸ¥è¯¢</td>
<td>ç”¨æˆ·èµ„æ–™</td>
</tr>
<tr>
<td>å¼‚æ­¥å›å¡«</td>
<td>æ¶ˆæ¯é˜Ÿåˆ—é€šçŸ¥</td>
<td>Kafka Topic</td>
<td>è®¢å•çŠ¶æ€</td>
</tr>
</tbody>
</table>
<h3 id="æ¨¡å¼ä¸‰ï¼šç©ºå€¼é˜²å¾¡">æ¨¡å¼ä¸‰ï¼šç©ºå€¼é˜²å¾¡</h3>
<p><strong>å…¬å¼</strong>ï¼š<code>Key â†’ {Value | EmptyMarker} with Short-TTL</code></p>
<p><strong>å…³é”®å‚æ•°</strong></p>
<ul>
<li>ç©ºå¯¹è±¡æ ‡è®° TTLï¼šé€šå¸¸ä¸ºæ­£å¸¸æ•°æ®çš„ 1/10 ~ 1/5</li>
<li>å¿…é¡»é…åˆæ‰‹åŠ¨æ¸…é™¤é€»è¾‘ï¼Œé˜²æ­¢çœŸå®æ•°æ®äº§ç”Ÿåä»è¿”å›ç©º</li>
</ul>
<hr>
<h2 id="å…«-ç”Ÿäº§ç¯å¢ƒå®è·µè¦ç‚¹">å…«ã€ç”Ÿäº§ç¯å¢ƒå®è·µè¦ç‚¹</h2>
<h3 id="8-1-ç›‘æ§æŒ‡æ ‡">8.1 ç›‘æ§æŒ‡æ ‡</h3>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>å¥åº·é˜ˆå€¼</th>
<th>æŠ¥è­¦æ¡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>å‘½ä¸­ç‡</td>
<td>&gt; 90%</td>
<td>&lt; 80%</td>
</tr>
<tr>
<td>å¹³å‡åŠ è½½æ—¶é—´</td>
<td>&lt; 100ms</td>
<td>&gt; 500ms</td>
</tr>
<tr>
<td>é©±é€ç‡</td>
<td>è§†å®¹é‡è€Œå®š</td>
<td>çªå¢ &gt; 200%</td>
</tr>
<tr>
<td>é”™è¯¯ç‡</td>
<td>0%</td>
<td>&gt; 0.1%</td>
</tr>
</tbody>
</table>
<h3 id="8-2-å®¹é‡è§„åˆ’">8.2 å®¹é‡è§„åˆ’</h3>
<p>ä¼°ç®—å…¬å¼ï¼š</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix">ç¼“å­˜æ¡ç›®æ•° â‰ˆ å³°å€¼ QPS Ã— å¹³å‡è®¿é—®é—´éš” <span class="hljs-symbol">/</span> (å‘½ä¸­ç‡ç›®æ ‡ <span class="hljs-symbol">/</span> (<span class="hljs-number">1</span> <span class="hljs-operator">-</span> å‘½ä¸­ç‡ç›®æ ‡))<br></code></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼šQPS=10000ï¼Œç”¨æˆ·å¹³å‡10åˆ†é’Ÿè®¿é—®ä¸€æ¬¡ï¼Œç›®æ ‡å‘½ä¸­ç‡95%ï¼š</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns">æ¡ç›®æ•° â‰ˆ <span class="hljs-number">10000</span> Ã— <span class="hljs-number">600</span>s Ã— (<span class="hljs-number">0.05/0.95</span>) â‰ˆ <span class="hljs-number">315,789</span><br></code></pre></td></tr></table></figure>
<h3 id="8-3-æ•…éšœæ¼”ç»ƒæ¸…å•">8.3 æ•…éšœæ¼”ç»ƒæ¸…å•</h3>
<ul>
<li>[ ] æ¨¡æ‹Ÿ Redis å®•æœºï¼ŒéªŒè¯é™çº§é€»è¾‘</li>
<li>[ ] æ¨¡æ‹Ÿå¤§ key è¿‡æœŸï¼Œè§‚å¯Ÿæ•°æ®åº“å‹åŠ›</li>
<li>[ ] æ¨¡æ‹Ÿç½‘ç»œåˆ†åŒºï¼Œæµ‹è¯•æœ€ç»ˆä¸€è‡´æ€§æ”¶æ•›æ—¶é—´</li>
<li>[ ] å‹æµ‹ç¼“å­˜æ»¡è½½æ—¶çš„é©±é€è¡Œä¸º</li>
</ul>
<hr>
<h2 id="ä¹-æ¨¡å¼é€ŸæŸ¥è¡¨">ä¹ã€æ¨¡å¼é€ŸæŸ¥è¡¨</h2>
<table>
<thead>
<tr>
<th>å¬åˆ°çš„éœ€æ±‚å…³é”®è¯</th>
<th>å¯¹åº”æ¨¡å¼</th>
<th>æ¨èæ–¹æ¡ˆ</th>
<th>å£è¯€</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœ¬åœ°ç¼“å­˜è¦é«˜æ€§èƒ½</td>
<td>åˆ†å±‚é™çº§</td>
<td>Caffeine + Redis</td>
<td>æœ¬åœ°å…œåº•ï¼Œè¿œç¨‹æ‰©å±•</td>
</tr>
<tr>
<td>å†·å¯åŠ¨åŠ è½½æ…¢</td>
<td>æƒ°æ€§å¡«å……</td>
<td>@PostConstruct é¢„åŠ è½½</td>
<td>è§¦å‘åŠ è½½ï¼ŒæŒ‰éœ€æ‰©å®¹</td>
</tr>
<tr>
<td>æ•°æ®æ›´æ–°åä¸ä¸€è‡´</td>
<td>æ—è·¯åŒæ­¥</td>
<td>Cache Aside + å»¶è¿ŸåŒåˆ </td>
<td>å…ˆåº“ååˆ ï¼Œè¯»å†™äº’æ–¥</td>
</tr>
<tr>
<td>æ¶æ„è¯·æ±‚å¯¼è‡´ DB å´©æºƒ</td>
<td>ç©ºå€¼é˜²å¾¡</td>
<td>ç©ºå¯¹è±¡ + å¸ƒéš†è¿‡æ»¤å™¨</td>
<td>å­˜ç©ºé˜²å‡»ï¼ŒçŸ­TTLæ§é™©</td>
</tr>
<tr>
<td>å¤§é‡ key åŒæ—¶è¿‡æœŸ</td>
<td>éšæœºæ•£åˆ—</td>
<td>TTL + Random Offset</td>
<td>è¿‡æœŸåˆ†æ•£ï¼Œæ¸è¿›åˆ·æ–°</td>
</tr>
<tr>
<td>çƒ­ç‚¹ key é¢‘ç¹å¤±æ•ˆ</td>
<td>äº’æ–¥é‡å»º</td>
<td>åˆ†å¸ƒå¼é” / é€»è¾‘è¿‡æœŸ</td>
<td>å•çº¿å›æºï¼Œæ’é˜Ÿç­‰å¾…</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/17416.html">é™ˆçš“ï¼šç¼“å­˜æ›´æ–°çš„å¥—è·¯</a></li>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2017/03/17/cache-about.html">ç¾å›¢æŠ€æœ¯å›¢é˜Ÿï¼šç¼“å­˜é‚£äº›äº‹</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/guava/wiki/CachesExplained">Guava Cache å®˜æ–¹æ–‡æ¡£</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ben-manes/caffeine/wiki">Caffeine Wiki</a></li>
</ol>
<h2 id="guava">Guava</h2>
<p>spring çš„ cache ç”¨çš„æ˜¯ cachemanagerã€‚<br>
guava çš„ cache ç”¨çš„æ˜¯ cachebuilderã€‚</p>
<h3 id="spring-guava-ä¸€èˆ¬çš„çŸ­è·¯å™¨å¼çš„ç”¨æ³•">Spring + Guava ä¸€èˆ¬çš„çŸ­è·¯å™¨å¼çš„ç”¨æ³•</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.concretepage&quot;)</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfigA</span>  &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">GuavaCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuavaCacheManager</span>(<span class="hljs-string">&quot;mycache&quot;</span>);<br>       CacheBuilder&lt;Object, Object&gt; cacheBuilder = CacheBuilder.newBuilder()<br>       .maximumSize(<span class="hljs-number">100</span>)<br>       .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES);<br>       cacheManager.setCacheBuilder(cacheBuilder);<br>       <span class="hljs-keyword">return</span> cacheManager;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.concretepage&quot;)</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfigB</span>  &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">SimpleCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCacheManager</span>();<br>       <span class="hljs-type">GuavaCache</span> <span class="hljs-variable">guavaCache1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuavaCache</span>(<span class="hljs-string">&quot;book&quot;</span>, CacheBuilder.newBuilder()<br>               .maximumSize(<span class="hljs-number">50</span>).build());<br>       <span class="hljs-type">GuavaCache</span> <span class="hljs-variable">guavaCache2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuavaCache</span>(<span class="hljs-string">&quot;bookstore&quot;</span>, CacheBuilder.newBuilder()<br>               .maximumSize(<span class="hljs-number">100</span>).expireAfterAccess(<span class="hljs-number">5</span>, TimeUnit.MINUTES).build());<br>       cacheManager.setCaches(Arrays.asList(guavaCache1, guavaCache2));<br>       <span class="hljs-keyword">return</span> cacheManager;<br>    &#125;<br>&#125; <br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookAppA</span> &#123;<br>    <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();<br>    <span class="hljs-meta">@Cacheable(value = &quot;mycache&quot;)</span><br>    <span class="hljs-keyword">public</span> Book <span class="hljs-title function_">getBook</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Executing getBook method...&quot;</span>);<br>        book.setBookName(<span class="hljs-string">&quot;Mahabharat&quot;</span>);<br>        <span class="hljs-keyword">return</span> book;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure>
<h3 id="åªéœ€è¦è¦†ç›–-load-æ–¹æ³•">åªéœ€è¦è¦†ç›– load æ–¹æ³•</h3>
<p>load å’Œ evict é€»è¾‘æ˜¯è§£è€¦çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenCacheMiss_thenValueIsComputed</span><span class="hljs-params">()</span> &#123;<br>Â Â Â Â CacheLoader&lt;String, String&gt; loader;<br>Â Â Â Â loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>Â Â Â Â Â Â Â Â <span class="hljs-meta">@Override</span><br>Â Â Â Â Â Â Â Â <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> key.toUpperCase();<br>Â Â Â Â Â Â Â Â &#125;<br>Â Â Â Â &#125;;<br>Â <br>Â Â Â Â LoadingCache&lt;String, String&gt; cache;<br>Â Â Â Â cache = CacheBuilder.newBuilder().build(loader);<br>Â <br>Â Â Â Â assertEquals(<span class="hljs-number">0</span>, cache.size());<br>Â Â Â Â assertEquals(<span class="hljs-string">&quot;HELLO&quot;</span>, cache.getUnchecked(<span class="hljs-string">&quot;hello&quot;</span>));<br>Â Â Â Â assertEquals(<span class="hljs-number">1</span>, cache.size());<br>&#125;<br><br><span class="hljs-comment">// load çš„ç”¨æ³•ï¼Œä¸‹æ¬¡ä¸ä¼šå†è®¡ç®— createExpensiveGraph äº†ã€‚</span><br>CacheLoader&lt;Key, Graph&gt; loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Key, Graph&gt;() &#123;<br>      <span class="hljs-keyword">public</span> Graph <span class="hljs-title function_">load</span><span class="hljs-params">(Key key)</span> <span class="hljs-keyword">throws</span> AnyException &#123;<br>        <span class="hljs-keyword">return</span> createExpensiveGraph(key);<br>      &#125;<br>&#125;;<br>LoadingCache&lt;Key, Graph&gt; cache = CacheBuilder.newBuilder().build(loader);&#125;<br></code></pre></td></tr></table></figure>
<h3 id="å¸¦æƒé‡çš„ç¼“å­˜é…ç½®">å¸¦æƒé‡çš„ç¼“å­˜é…ç½®</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenCacheReachMaxWeight_thenEviction</span><span class="hljs-params">()</span> &#123;<br>Â Â Â Â CacheLoader&lt;String, String&gt; loader;<br>Â Â Â Â loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>Â Â Â Â Â Â Â Â <span class="hljs-meta">@Override</span><br>Â Â Â Â Â Â Â Â <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> key.toUpperCase();<br>Â Â Â Â Â Â Â Â &#125;<br>Â Â Â Â &#125;;<br>Â <br>Â Â Â Â Weigher&lt;String, String&gt; weighByLength;<br>Â Â Â Â weighByLength = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Weigher</span>&lt;String, String&gt;() &#123;<br>Â Â Â Â Â Â Â Â <span class="hljs-meta">@Override</span><br>Â Â Â Â Â Â Â Â <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">weigh</span><span class="hljs-params">(String key, String value)</span> &#123;<br>Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> value.length();<br>Â Â Â Â Â Â Â Â &#125;<br>Â Â Â Â &#125;;<br>Â <br>Â Â Â Â LoadingCache&lt;String, String&gt; cache;<br>Â Â Â Â cache = CacheBuilder.newBuilder()<br>Â Â Â Â Â Â .maximumWeight(<span class="hljs-number">16</span>)<br>Â Â Â Â Â Â .weigher(weighByLength)<br>Â Â Â Â Â Â .build(loader);<br>Â <br>Â Â Â Â cache.getUnchecked(<span class="hljs-string">&quot;first&quot;</span>);<br>Â Â Â Â cache.getUnchecked(<span class="hljs-string">&quot;second&quot;</span>);<br>Â Â Â Â cache.getUnchecked(<span class="hljs-string">&quot;third&quot;</span>);<br>Â Â Â Â cache.getUnchecked(<span class="hljs-string">&quot;last&quot;</span>);<br>Â Â Â Â assertEquals(<span class="hljs-number">3</span>, cache.size());<br>Â Â Â Â assertNull(cache.getIfPresent(<span class="hljs-string">&quot;first&quot;</span>));<br>Â Â Â Â assertEquals(<span class="hljs-string">&quot;LAST&quot;</span>, cache.getIfPresent(<span class="hljs-string">&quot;last&quot;</span>));<br></code></pre></td></tr></table></figure>
<h3 id="æŒ‡å®šè¿‡æœŸæ—¶é—´">æŒ‡å®šè¿‡æœŸæ—¶é—´</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenEntryIdle_thenEviction</span><span class="hljs-params">()</span><br>  <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    CacheLoader&lt;String, String&gt; loader;<br>    loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>            <span class="hljs-keyword">return</span> key.toUpperCase();<br>        &#125;<br>    &#125;;<br> <br>    LoadingCache&lt;String, String&gt; cache;<br>    cache = CacheBuilder.newBuilder()<br>        <span class="hljs-comment">// remove records that have been idle for 2ms:</span><br>      .expireAfterAccess(<span class="hljs-number">2</span>,TimeUnit.MILLISECONDS)<br>      .build(loader);<br> <br>    cache.getUnchecked(<span class="hljs-string">&quot;hello&quot;</span>);<br>    assertEquals(<span class="hljs-number">1</span>, cache.size());<br> <br>    cache.getUnchecked(<span class="hljs-string">&quot;hello&quot;</span>);<br>    Thread.sleep(<span class="hljs-number">300</span>);<br> <br>    cache.getUnchecked(<span class="hljs-string">&quot;test&quot;</span>);<br>    assertEquals(<span class="hljs-number">1</span>, cache.size());<br>    assertNull(cache.getIfPresent(<span class="hljs-string">&quot;hello&quot;</span>));<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenEntryLiveTimeExpire_thenEviction</span><span class="hljs-params">()</span><br>  <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    CacheLoader&lt;String, String&gt; loader;<br>    loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>            <span class="hljs-keyword">return</span> key.toUpperCase();<br>        &#125;<br>    &#125;;<br> <br>    LoadingCache&lt;String, String&gt; cache;<br>    cache = CacheBuilder.newBuilder()<br>    <span class="hljs-comment">// è¿™ä¸ªç­–ç•¥æ›´ä¿å®ˆ</span><br>    <span class="hljs-comment">// evict records based on their total live time</span><br>      .expireAfterWrite(<span class="hljs-number">2</span>,TimeUnit.MILLISECONDS)<br>      .build(loader);<br> <br>    cache.getUnchecked(<span class="hljs-string">&quot;hello&quot;</span>);<br>    assertEquals(<span class="hljs-number">1</span>, cache.size());<br>    Thread.sleep(<span class="hljs-number">300</span>);<br>    cache.getUnchecked(<span class="hljs-string">&quot;test&quot;</span>);<br>    assertEquals(<span class="hljs-number">1</span>, cache.size());<br>    assertNull(cache.getIfPresent(<span class="hljs-string">&quot;hello&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨-key">å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ key</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenWeakKeyHasNoRef_thenRemoveFromCache</span><span class="hljs-params">()</span> &#123;<br>Â Â Â Â CacheLoader&lt;String, String&gt; loader;<br>Â Â Â Â loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>Â Â Â Â Â Â Â Â <span class="hljs-meta">@Override</span><br>Â Â Â Â Â Â Â Â <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> key.toUpperCase();<br>Â Â Â Â Â Â Â Â &#125;<br>Â Â Â Â &#125;;<br>Â <br>Â Â Â Â LoadingCache&lt;String, String&gt; cache;<br>Â Â Â Â cache = CacheBuilder.newBuilder().weakKeys().build(loader);<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenSoftValue_thenRemoveFromCache</span><span class="hljs-params">()</span> &#123;<br>    CacheLoader&lt;String, String&gt; loader;<br>    loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>            <span class="hljs-keyword">return</span> key.toUpperCase();<br>        &#125;<br>    &#125;;<br> <br>    LoadingCache&lt;String, String&gt; cache;<br>    cache = CacheBuilder.newBuilder().softValues().build(loader);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="å®šæ—¶è§¦å‘-load-æ–¹æ³•">å®šæ—¶è§¦å‘ load æ–¹æ³•</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenLiveTimeEnd_thenRefresh</span><span class="hljs-params">()</span> &#123;<br>    CacheLoader&lt;String, String&gt; loader;<br>    loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> &#123;<br>            <span class="hljs-keyword">return</span> key.toUpperCase();<br>        &#125;<br>    &#125;;<br> <br>    LoadingCache&lt;String, String&gt; cache;<br>    cache = CacheBuilder.newBuilder()<br>      .refreshAfterWrite(<span class="hljs-number">1</span>,TimeUnit.MINUTES)<br>      .build(loader);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="ä¸»åŠ¨é¢„çƒ­">ä¸»åŠ¨é¢„çƒ­</h3>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs lasso">@Test<br><span class="hljs-keyword">public</span> <span class="hljs-literal">void</span> whenPreloadCache_thenUsePutAll() &#123;<br>Â Â Â Â CacheLoader&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; loader;<br>Â Â Â Â loader = <span class="hljs-literal">new</span> CacheLoader&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt;() &#123;<br>Â Â Â Â Â Â Â Â @Override<br>Â Â Â Â Â Â Â Â <span class="hljs-keyword">public</span> <span class="hljs-built_in">String</span> load(<span class="hljs-built_in">String</span> key) &#123;<br>Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> key.toUpperCase();<br>Â Â Â Â Â Â Â Â &#125;<br>Â Â Â Â &#125;;<br>Â <br>Â Â Â Â LoadingCache&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; <span class="hljs-keyword">cache</span>;<br>Â Â Â Â <span class="hljs-keyword">cache</span> = CacheBuilder.newBuilder().build(loader);<br>Â <br>Â Â Â Â <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; <span class="hljs-built_in">map</span> = <span class="hljs-literal">new</span> HashMap&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt;();<br>Â Â Â Â <span class="hljs-built_in">map</span>.put(<span class="hljs-string">&quot;first&quot;</span>, <span class="hljs-string">&quot;FIRST&quot;</span>);<br>Â Â Â Â <span class="hljs-built_in">map</span>.put(<span class="hljs-string">&quot;second&quot;</span>, <span class="hljs-string">&quot;SECOND&quot;</span>);<br>Â Â Â Â <span class="hljs-keyword">cache</span>.putAll(<span class="hljs-built_in">map</span>);<br>Â <br>Â Â Â Â assertEquals(<span class="hljs-number">2</span>, <span class="hljs-keyword">cache</span>.size());<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="å¿…é¡»ä½¿ç”¨-optional-æ¥åº”å¯¹-null-å€¼">å¿…é¡»ä½¿ç”¨ optional æ¥åº”å¯¹ null å€¼</h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">whenNullValue_thenOptional</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">CacheLoader</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">String</span>&gt;&gt; loader;<br>    loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">String</span>&gt;&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">load</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> key</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Optional</span>.<span class="hljs-title function_">fromNullable</span>(<span class="hljs-title function_">getSuffix</span>(key));<br>        &#125;<br>    &#125;;<br> <br>    <span class="hljs-title class_">LoadingCache</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">String</span>&gt;&gt; cache;<br>    cache = <span class="hljs-title class_">CacheBuilder</span>.<span class="hljs-title function_">newBuilder</span>().<span class="hljs-title function_">build</span>(loader);<br> <br>    <span class="hljs-title function_">assertEquals</span>(<span class="hljs-string">&quot;txt&quot;</span>, cache.<span class="hljs-title function_">getUnchecked</span>(<span class="hljs-string">&quot;text.txt&quot;</span>).<span class="hljs-title function_">get</span>());<br>    <span class="hljs-title function_">assertFalse</span>(cache.<span class="hljs-title function_">getUnchecked</span>(<span class="hljs-string">&quot;hello&quot;</span>).<span class="hljs-title function_">isPresent</span>());<br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSuffix</span>(<span class="hljs-params">final <span class="hljs-title class_">String</span> str</span>) &#123;<br>    int lastIndex = str.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">&#x27;.&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (lastIndex == -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">substring</span>(lastIndex + <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="è®¢é˜…åˆ é™¤äº‹ä»¶">è®¢é˜…åˆ é™¤äº‹ä»¶</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">whenEntryRemovedFromCache_thenNotify</span><span class="hljs-params">()</span> &#123;<br>    CacheLoader&lt;String, String&gt; loader;<br>    loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String key)</span> &#123;<br>            <span class="hljs-keyword">return</span> key.toUpperCase();<br>        &#125;<br>    &#125;;<br> <br>    RemovalListener&lt;String, String&gt; listener;<br>    listener = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemovalListener</span>&lt;String, String&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onRemoval</span><span class="hljs-params">(RemovalNotification&lt;String, String&gt; n)</span>&#123;<br>            <span class="hljs-keyword">if</span> (n.wasEvicted()) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> n.getCause().name();<br>                assertEquals(RemovalCause.SIZE.toString(),cause);<br>            &#125;<br>        &#125;<br>    &#125;;<br> <br>    LoadingCache&lt;String, String&gt; cache;<br>    cache = CacheBuilder.newBuilder()<br>      .maximumSize(<span class="hljs-number">3</span>)<br>      .removalListener(listener)<br>      .build(loader);<br> <br>    cache.getUnchecked(<span class="hljs-string">&quot;first&quot;</span>);<br>    cache.getUnchecked(<span class="hljs-string">&quot;second&quot;</span>);<br>    cache.getUnchecked(<span class="hljs-string">&quot;third&quot;</span>);<br>    cache.getUnchecked(<span class="hljs-string">&quot;last&quot;</span>);<br>    assertEquals(<span class="hljs-number">3</span>, cache.size());<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="cache-statistic">Cache Statistic</h3>
<p>å¯ä»¥ logging cache statistic data</p>
<blockquote>
<p>Cache Stats= CacheStats{hitCount=3296628, missCount=1353372,<br>
loadSuccessCount=1353138, loadExceptionCount=0,<br>
totalLoadTime=2268064327604, evictionCount=1325410} Cache Stats=<br>
CacheStats{hitCount=3334167, missCount=1365834,<br>
loadSuccessCount=1365597, loadExceptionCount=0,<br>
totalLoadTime=2287551024797, evictionCount=1337740} Cache Stats=<br>
CacheStats{hitCount=3371463, missCount=1378536,<br>
loadSuccessCount=1378296, loadExceptionCount=0,<br>
totalLoadTime=2309012047459, evictionCount=1350990} Cache Stats=<br>
CacheStats{hitCount=3407719, missCount=1392280,<br>
loadSuccessCount=1392039, loadExceptionCount=0,<br>
totalLoadTime=2331355983194, evictionCount=1364535} Cache Stats=<br>
CacheStats{hitCount=3443848, missCount=1406152,<br>
loadSuccessCount=1405908, loadExceptionCount=0,<br>
totalLoadTime=2354162371299, evictionCount=1378654}</p>
</blockquote>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://guava.dev/releases/19.0/api/docs/com/google/common/cache/CacheBuilder.html#recordStats%28%29">recordStats</a></p>
<h2 id="ecache">ECache</h2>
<h3 id="spring4-ecache-2">Spring4 + ECache 2</h3>
<p>æ•´ä¸ª namespace çš„è¯´æ˜è§<a target="_blank" rel="noopener" href="http://www.ehcache.org/ehcache.xml">è¿™é‡Œ</a>ã€‚</p>
<p>å…·ä½“çš„é…ç½®é€‰é¡¹è§ï¼š</p>
<ul>
<li>nameï¼šç¼“å­˜åç§°ã€‚</li>
<li>maxElementsInMemoryï¼šç¼“å­˜æœ€å¤§ä¸ªæ•°ã€‚</li>
<li>eternalï¼šç¼“å­˜ä¸­å¯¹è±¡æ˜¯å¦ä¸ºæ°¸ä¹…çš„ï¼Œå¦‚æœæ˜¯ï¼Œè¶…æ—¶è®¾ç½®å°†è¢«å¿½ç•¥ï¼Œå¯¹è±¡ä»ä¸è¿‡æœŸã€‚</li>
<li>timeToIdleSecondsï¼šç½®å¯¹è±¡åœ¨å¤±æ•ˆå‰çš„å…è®¸é—²ç½®æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ã€‚ä»…å½“eternal=falseå¯¹è±¡ä¸æ˜¯æ°¸ä¹…æœ‰æ•ˆæ—¶ä½¿ç”¨ï¼Œå¯é€‰å±æ€§ï¼Œé»˜è®¤å€¼æ˜¯0ï¼Œä¹Ÿå°±æ˜¯å¯é—²ç½®æ—¶é—´æ— ç©·å¤§ã€‚</li>
<li>timeToLiveSecondsï¼šç¼“å­˜æ•°æ®çš„ç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå…ƒç´ ä»æ„å»ºåˆ°æ¶ˆäº¡çš„æœ€å¤§æ—¶é—´é—´éš”å€¼ï¼Œè¿™åªèƒ½åœ¨å…ƒç´ ä¸æ˜¯æ°¸ä¹…é©»ç•™æ—¶æœ‰æ•ˆï¼Œå¦‚æœè¯¥å€¼æ˜¯0å°±æ„å‘³ç€å…ƒç´ å¯ä»¥åœé¡¿æ— ç©·é•¿çš„æ—¶é—´ã€‚</li>
<li>maxEntriesLocalDiskï¼šå½“å†…å­˜ä¸­å¯¹è±¡æ•°é‡è¾¾åˆ°maxElementsInMemoryæ—¶ï¼ŒEhcacheå°†ä¼šå¯¹è±¡å†™åˆ°ç£ç›˜ä¸­ã€‚</li>
<li>overflowToDiskï¼šå†…å­˜ä¸è¶³æ—¶ï¼Œæ˜¯å¦å¯ç”¨ç£ç›˜ç¼“å­˜ã€‚</li>
<li>diskSpoolBufferSizeMBï¼šè¿™ä¸ªå‚æ•°è®¾ç½®DiskStoreï¼ˆç£ç›˜ç¼“å­˜ï¼‰çš„ç¼“å­˜åŒºå¤§å°ã€‚é»˜è®¤æ˜¯30MBã€‚æ¯ä¸ªCacheéƒ½åº”è¯¥æœ‰è‡ªå·±çš„ä¸€ä¸ªç¼“å†²åŒºã€‚</li>
<li>maxElementsOnDiskï¼šç¡¬ç›˜æœ€å¤§ç¼“å­˜ä¸ªæ•°ã€‚</li>
<li>diskPersistentï¼šæ˜¯å¦åœ¨VMé‡å¯æ—¶å­˜å‚¨ç¡¬ç›˜çš„ç¼“å­˜æ•°æ®ã€‚é»˜è®¤å€¼æ˜¯falseã€‚</li>
<li>diskExpiryThreadIntervalSecondsï¼šç£ç›˜å¤±æ•ˆçº¿ç¨‹è¿è¡Œæ—¶é—´é—´éš”ï¼Œé»˜è®¤æ˜¯120ç§’ã€‚</li>
<li>memoryStoreEvictionPolicyï¼šå½“è¾¾åˆ°maxElementsInMemoryé™åˆ¶æ—¶ï¼ŒEhcacheå°†ä¼šæ ¹æ®æŒ‡å®šçš„ç­–ç•¥å»æ¸…ç†å†…å­˜ã€‚é»˜è®¤ç­–ç•¥æ˜¯LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ã€‚ä½ å¯ä»¥è®¾ç½®ä¸ºFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰æˆ–æ˜¯LFUï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰ã€‚</li>
<li>clearOnFlushï¼šå†…å­˜æ•°é‡æœ€å¤§æ—¶æ˜¯å¦æ¸…é™¤ã€‚</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ehcache</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:noNamespaceSchemaLocation</span>=<span class="hljs-string">&quot;ehcache.xsd&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">updateCheck</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">monitoring</span>=<span class="hljs-string">&quot;autodetect&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">dynamicConfig</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">diskStore</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;java.io.tmpdir&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;movieFindCache&quot;</span> </span><br><span class="hljs-tag">        <span class="hljs-attr">maxEntriesLocalHeap</span>=<span class="hljs-string">&quot;10000&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">maxEntriesLocalDisk</span>=<span class="hljs-string">&quot;1000&quot;</span> </span><br><span class="hljs-tag">        <span class="hljs-attr">eternal</span>=<span class="hljs-string">&quot;false&quot;</span> </span><br><span class="hljs-tag">        <span class="hljs-attr">diskSpoolBufferSizeMB</span>=<span class="hljs-string">&quot;20&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">timeToIdleSeconds</span>=<span class="hljs-string">&quot;300&quot;</span> <span class="hljs-attr">timeToLiveSeconds</span>=<span class="hljs-string">&quot;600&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">memoryStoreEvictionPolicy</span>=<span class="hljs-string">&quot;LFU&quot;</span> </span><br><span class="hljs-tag">        <span class="hljs-attr">transactionalMode</span>=<span class="hljs-string">&quot;off&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">persistence</span> <span class="hljs-attr">strategy</span>=<span class="hljs-string">&quot;localTempSwap&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">cache</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ehcache</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ java codeï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mkyong.test;<br><br><span class="hljs-keyword">import</span> org.springframework.cache.CacheManager;<br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.EnableCaching;<br><span class="hljs-keyword">import</span> org.springframework.cache.ehcache.EhCacheCacheManager;<br><span class="hljs-keyword">import</span> org.springframework.cache.ehcache.EhCacheManagerFactoryBean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.core.io.ClassPathResource;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-meta">@ComponentScan(&#123; &quot;com.mkyong.*&quot; &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EhCacheCacheManager</span>(ehCacheCacheManager().getObject());<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> EhCacheManagerFactoryBean <span class="hljs-title function_">ehCacheCacheManager</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">EhCacheManagerFactoryBean</span> <span class="hljs-variable">cmfb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EhCacheManagerFactoryBean</span>();<br>        cmfb.setConfigLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;ehcache.xml&quot;</span>));<br>        cmfb.setShared(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> cmfb;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">package</span> com.mkyong.movie;<br><br><span class="hljs-keyword">import</span> org.springframework.cache.annotation.Cacheable;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;<br><br><span class="hljs-meta">@Repository(&quot;movieDao&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MovieDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MovieDao</span>&#123;<br><br>    <span class="hljs-comment">//This &quot;movieFindCache&quot; is delcares in ehcache.xml</span><br>    <span class="hljs-meta">@Cacheable(value=&quot;movieFindCache&quot;, key=&quot;#name&quot;)</span><br>    <span class="hljs-keyword">public</span> Movie <span class="hljs-title function_">findByDirector</span><span class="hljs-params">(String name)</span> &#123;<br>        slowQuery(<span class="hljs-number">2000L</span>);<br>        System.out.println(<span class="hljs-string">&quot;findByDirector is running...&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Movie</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;Forrest Gump&quot;</span>,<span class="hljs-string">&quot;Robert Zemeckis&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">slowQuery</span><span class="hljs-params">(<span class="hljs-type">long</span> seconds)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(seconds);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(e);<br>            &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="spring-boot-2-ecache3">Spring Boot 2 + ECache3</h3>
<p>ECache æ˜¯ Hibernate ä¸­çš„é»˜è®¤ç¼“å­˜æ¡†æ¶ã€‚</p>
<p>è¦å¼•å…¥ javax çš„ cache apiï¼ˆJSR-107ï¼‰ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.cache<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cache-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>Â Â Â Â <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ç¼“å­˜æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberService</span> &#123;<br> <br>    <span class="hljs-comment">// é…ç½®å…¨éƒ½åœ¨ Cacheable æ¥å£ä¸Š</span><br>    <span class="hljs-meta">@Cacheable(</span><br><span class="hljs-meta">      value = &quot;squareCache&quot;, </span><br><span class="hljs-meta">      key = &quot;#number&quot;, </span><br><span class="hljs-meta">      condition = &quot;#number&gt;10&quot;)</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">square</span><span class="hljs-params">(Long number)</span> &#123;<br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">square</span> <span class="hljs-operator">=</span> BigDecimal.valueOf(number)<br>          .multiply(BigDecimal.valueOf(number));<br>        log.info(<span class="hljs-string">&quot;square of &#123;&#125; is &#123;&#125;&quot;</span>, number, square);<br>        <span class="hljs-keyword">return</span> square;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„é…ç½®ï¼Œä¸éœ€è¦è‡ªå·±å†ç”Ÿæˆ cachemanager</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> &#123;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEventLogger</span> <br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CacheEventListener</span>&lt;Object, Object&gt; &#123;<br> <br>    <span class="hljs-comment">// ...</span><br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onEvent</span><span class="hljs-params">(</span><br><span class="hljs-params">      CacheEvent&lt;? extends Object, ? extends Object&gt; cacheEvent)</span> &#123;<br>        log.info(<span class="hljs-comment">/* message */</span>,<br>          cacheEvent.getKey(), cacheEvent.getOldValue(), cacheEvent.getNewValue());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">config</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.ehcache.org/v3&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:jsr107</span>=<span class="hljs-string">&quot;http://www.ehcache.org/v3/jsr107&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">            http://www.ehcache.org/v3 http://www.ehcache.org/schema/ehcache-core-3.0.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">            http://www.ehcache.org/v3/jsr107 http://www.ehcache.org/schema/ehcache-107-ext-3.0.xsd&quot;</span>&gt;</span><br> <br>    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;squareCache&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">key-type</span>&gt;</span>java.lang.Long<span class="hljs-tag">&lt;/<span class="hljs-name">key-type</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">value-type</span>&gt;</span>java.math.BigDecimal<span class="hljs-tag">&lt;/<span class="hljs-name">value-type</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">expiry</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ttl</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">&quot;seconds&quot;</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">ttl</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">expiry</span>&gt;</span><br> <br>        <span class="hljs-tag">&lt;<span class="hljs-name">listeners</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">class</span>&gt;</span>com.baeldung.cachetest.config.CacheEventLogger<span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">event-firing-mode</span>&gt;</span>ASYNCHRONOUS<span class="hljs-tag">&lt;/<span class="hljs-name">event-firing-mode</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">event-ordering-mode</span>&gt;</span>UNORDERED<span class="hljs-tag">&lt;/<span class="hljs-name">event-ordering-mode</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">events-to-fire-on</span>&gt;</span>CREATED<span class="hljs-tag">&lt;/<span class="hljs-name">events-to-fire-on</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">events-to-fire-on</span>&gt;</span>EXPIRED<span class="hljs-tag">&lt;/<span class="hljs-name">events-to-fire-on</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">listeners</span>&gt;</span><br> <br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">heap</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">&quot;entries&quot;</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">heap</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">offheap</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">&quot;MB&quot;</span>&gt;</span>10<span class="hljs-tag">&lt;/<span class="hljs-name">offheap</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">cache</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">config</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>å…·ä½“çš„å…¶ä»– cache æ“ä½œçš„æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-comment">// @Cacheableå¯ä»¥è®¾ç½®å¤šä¸ªç¼“å­˜ï¼Œå½¢å¼å¦‚ï¼š@Cacheable(&#123;&quot;books&quot;, &quot;isbns&quot;&#125;)</span><br>    <span class="hljs-meta">@Cacheable(&#123;&quot;users&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findUser</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> findUserInDB(user.getId());<br>    &#125;<br><br>    <span class="hljs-meta">@Cacheable(value = &quot;users&quot;, condition = &quot;#user.getId() &lt;= 2&quot;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findUserInLimit</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> findUserInDB(user.getId());<br>    &#125;<br><br>    <span class="hljs-meta">@CachePut(value = &quot;users&quot;, key = &quot;#user.getId()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> &#123;<br>        updateUserInDB(user);<br>    &#125;<br><br>    <span class="hljs-meta">@CacheEvict(value = &quot;users&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeUser</span><span class="hljs-params">(User user)</span> &#123;<br>        removeUserInDB(user.getId());<br>    &#125;<br><br>    <span class="hljs-meta">@CacheEvict(value = &quot;users&quot;, allEntries = true)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>        removeAllInDB();<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Caching(evict = &#123; @CacheEvict(&quot;primary&quot;), @CacheEvict(cacheNames=&quot;secondary&quot;, key=&quot;#p0&quot;) &#125;)</span><br><span class="hljs-keyword">public</span> Book <span class="hljs-title function_">importBooks</span><span class="hljs-params">(String deposit, Date date)</span><br><br><br><span class="hljs-comment">// ä¸å‰é¢çš„ç¼“å­˜æ³¨è§£ä¸åŒï¼Œè¿™æ˜¯ä¸€ä¸ªç±»çº§åˆ«çš„æ³¨è§£ã€‚</span><br>å¦‚æœç±»çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯ç¼“å­˜æ“ä½œï¼Œä½ å¯ä»¥ä½¿ç”¨<span class="hljs-meta">@CacheConfig</span>æ¥æŒ‡å®šç±»ï¼Œçœå»ä¸€äº›é…ç½®ã€‚<br><span class="hljs-meta">@CacheConfig(&quot;books&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookRepositoryImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookRepository</span> &#123;<br>    <span class="hljs-meta">@Cacheable</span><br>    <span class="hljs-keyword">public</span> Book <span class="hljs-title function_">findBook</span><span class="hljs-params">(ISBN isbn)</span> &#123;...&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>å¯ä»¥è€ƒè™‘ï¼Œå®šä¹‰è‡ªå·±çš„ KeyGenerator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyKeyGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KeyGenerator</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">generate</span><span class="hljs-params">(Object target, Method method, Object... params)</span> &#123;<br>        <span class="hljs-keyword">return</span> method.getName()+Arrays.toString(params);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Cacheable(keyGenerator = &quot;myKeyGenerator&quot;)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    user.setId(id);<br>    user.setUsername(<span class="hljs-string">&quot;lisi&quot;</span>);<br>    System.out.println(user);<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œå¯ä»¥ç”¨çš„ key çš„ç¼“å­˜ä¸“ç”¨ SPEL è¡¨è¾¾å¼ï¼Œåœ¨<a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#cache-spel-context">è¿™é‡Œ</a>ã€‚</p>
<h2 id="caffeine">Caffeine</h2>
<p>å®ƒå‡ ä¸ªç‰¹åˆ«æœ‰æ„æ€çš„ç‰¹æ€§ï¼štime-based evictionã€size-based evictionã€å¼‚æ­¥åŠ è½½ã€å¼±å¼•ç”¨ keyï¼ˆä¸è€ƒè™‘ referenceQueue çš„ç‰¹æ€§ï¼ŒWeakReference æ˜¯æœ€é€‚åˆæˆ‘ä»¬ç”¨çš„ï¼‰ã€‚</p>
<ul>
<li>automatic loading of entries into the cache, optionally asynchronously</li>
<li>size-based eviction when a maximum is exceeded based on frequency and recency</li>
<li>time-based expiration of entries, measured since last access or last write</li>
<li>asynchronously refresh when the first stale request for an entry occurs</li>
<li>keys automatically wrapped in weak references</li>
<li>values automatically wrapped in weak or soft references</li>
<li>notification of evicted (or otherwise removed) entries</li>
<li>writes propagated to an external resource</li>
<li>accumulation of cache access statistics</li>
</ul>
<h3 id="ä¸æ­é…-spring">ä¸æ­é… Spring</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs java">Cache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>Â Â .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)<br>Â Â .maximumSize(<span class="hljs-number">100</span>)<br>Â Â .build();<br>Â Â <br><span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;A&quot;</span>;<br><span class="hljs-type">DataObject</span> <span class="hljs-variable">dataObject</span> <span class="hljs-operator">=</span> cache.getIfPresent(key);<br> <br>assertNull(dataObject);<br><br>cache.put(key, dataObject);<br>dataObject = cache.getIfPresent(key);<br> <br>assertNotNull(dataObject);<br><br>dataObject = cache<br>  .get(key, k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for A&quot;</span>));<br> <br>assertNotNull(dataObject);<br>assertEquals(<span class="hljs-string">&quot;Data for A&quot;</span>, dataObject.getData());<br><br><span class="hljs-comment">// åŒæ­¥åŠ è½½</span><br>LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>Â Â .maximumSize(<span class="hljs-number">100</span>)<br>Â Â .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br><br><span class="hljs-type">DataObject</span> <span class="hljs-variable">dataObject</span> <span class="hljs-operator">=</span> cache.get(key);<br> <br>assertNotNull(dataObject);<br>assertEquals(<span class="hljs-string">&quot;Data for &quot;</span> + key, dataObject.getData());<br><br>Map&lt;String, DataObject&gt; dataObjectMap <br>Â Â = cache.getAll(Arrays.asList(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>));<br>Â <br>assertEquals(<span class="hljs-number">3</span>, dataObjectMap.size());<br>Â Â <br><span class="hljs-comment">// å¼‚æ­¥åŠ è½½</span><br>AsyncLoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>  .maximumSize(<span class="hljs-number">100</span>)<br>  .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)<br>  .buildAsync(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br><br><span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;A&quot;</span>;<br>cache.get(key).thenAccept(dataObject -&gt; &#123;<br>    assertNotNull(dataObject);<br>    assertEquals(<span class="hljs-string">&quot;Data for &quot;</span> + key, dataObject.getData());<br>&#125;);<br>cache.getAll(Arrays.asList(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>))<br>  .thenAccept(dataObjectMap -&gt; assertEquals(<span class="hljs-number">3</span>, dataObjectMap.size()));<br><br><span class="hljs-comment">// åŸºäº size çš„æ·˜æ±°</span><br>LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>Â Â .maximumSize(<span class="hljs-number">1</span>)<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br>Â <br>assertEquals(<span class="hljs-number">0</span>, cache.estimatedSize());<br><br><span class="hljs-comment">// ç­‰å¾…å¼‚æ­¥æ·˜æ±°å®Œæˆæ‰åŒæ­¥è¿”å›</span><br>cache.cleanUp();<br><br><span class="hljs-comment">// åŸºäºæƒé‡çš„æ·˜æ±°</span><br>LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>Â Â .maximumWeight(<span class="hljs-number">10</span>)<br>Â Â .weigher((k,v) -&gt; <span class="hljs-number">5</span>)<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br>Â <br>assertEquals(<span class="hljs-number">0</span>, cache.estimatedSize());<br>Â <br>cache.get(<span class="hljs-string">&quot;A&quot;</span>);<br>assertEquals(<span class="hljs-number">1</span>, cache.estimatedSize());<br>Â <br>cache.get(<span class="hljs-string">&quot;B&quot;</span>);<br>assertEquals(<span class="hljs-number">2</span>, cache.estimatedSize());<br><br><span class="hljs-comment">// åŸºäºè®¿é—®æ—¶é—´çš„æ·˜æ±°</span><br>LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>  .expireAfterAccess(<span class="hljs-number">5</span>, TimeUnit.MINUTES)<br>  .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br><br><span class="hljs-comment">// åŸºäºå†™æ—¶é—´çš„æ·˜æ±°</span><br>cache = Caffeine.newBuilder()<br>Â Â .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS)<br>Â Â .weakKeys()<br>Â Â .weakValues()<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br><br><span class="hljs-comment">// è‡ªå®šä¹‰åŸºäºæ—¶é—´çš„æ·˜æ±°ç­–ç•¥</span><br>cache = Caffeine.newBuilder().expireAfter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Expiry</span>&lt;String, DataObject&gt;() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">expireAfterCreate</span><span class="hljs-params">(</span><br><span class="hljs-params">      String key, DataObject value, <span class="hljs-type">long</span> currentTime)</span> &#123;<br>        <span class="hljs-keyword">return</span> value.getData().length() * <span class="hljs-number">1000</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">expireAfterUpdate</span><span class="hljs-params">(</span><br><span class="hljs-params">      String key, DataObject value, <span class="hljs-type">long</span> currentTime, <span class="hljs-type">long</span> currentDuration)</span> &#123;<br>        <span class="hljs-keyword">return</span> currentDuration;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">expireAfterRead</span><span class="hljs-params">(</span><br><span class="hljs-params">      String key, DataObject value, <span class="hljs-type">long</span> currentTime, <span class="hljs-type">long</span> currentDuration)</span> &#123;<br>        <span class="hljs-keyword">return</span> currentDuration;<br>    &#125;<br>&#125;).build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br><br><span class="hljs-comment">// key å’Œ value ä½¿ç”¨ä¸åŒçš„å¼•ç”¨ã€‚value åªèƒ½ä½¿ç”¨ softValuesã€‚</span><br>LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>Â Â .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS)<br>Â Â .weakKeys()<br>Â Â .weakValues()<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br>Â <br>cache = Caffeine.newBuilder()<br>Â Â .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS)<br>Â Â .softValues()<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br><br><span class="hljs-comment">// è‡ªåŠ¨ populate</span><br>Caffeine.newBuilder()<br>Â Â .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br><br><span class="hljs-comment">// è·å–ç»Ÿè®¡æ•°æ®</span><br>LoadingCache&lt;String, DataObject&gt; cache = Caffeine.newBuilder()<br>Â Â .maximumSize(<span class="hljs-number">100</span>)<br>Â Â .recordStats()<br>Â Â .build(k -&gt; DataObject.get(<span class="hljs-string">&quot;Data for &quot;</span> + k));<br>cache.get(<span class="hljs-string">&quot;A&quot;</span>);<br>cache.get(<span class="hljs-string">&quot;A&quot;</span>);<br><br>assertEquals(<span class="hljs-number">1</span>, cache.stats().hitCount());<br>assertEquals(<span class="hljs-number">1</span>, cache.stats().missCount());<br></code></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ get ç±»æ“ä½œçš„åŸå­æ€§ç‰¹åˆ«é‡è¦ï¼š</p>
<blockquote>
<p>method invocation is performed atomically, so the function is applied<br>
at most once per key. Some attempted update operations on this cache<br>
by other threads may be blocked while the computation is in progress,<br>
so the computation should be short and simple, and must not attempt to<br>
update any other mappings of this cache.</p>
</blockquote>
<p>è¿™æ ·å¯ä»¥ä¿è¯çº¿æ€§ä¸€è‡´æ€§ï¼Œå®ç°ç«‹å³å¯è§ï¼ˆç±»ä¼¼å¼ºå¹¿æ’­ï¼‰ï¼Œä½†ä¸­é—´æ’å…¥çš„è¿™ä¸ªåŸå­æ“ä½œå¿…é¡»çŸ­ï¼Œç±»ä¼¼ redis çš„ set æ‰å¯ä»¥ã€‚</p>
<h3 id="æ­é…-spring">æ­é… Spring</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>ç›¸å…³çš„é…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li>initialCapacity: # åˆå§‹çš„ç¼“å­˜ç©ºé—´å¤§å°</li>
<li>maximumSize: # ç¼“å­˜çš„æœ€å¤§æ¡æ•°</li>
<li>maximumWeight: # ç¼“å­˜çš„æœ€å¤§æƒé‡</li>
<li>expireAfterAccess: # æœ€åä¸€æ¬¡å†™å…¥æˆ–è®¿é—®åç»è¿‡å›ºå®šæ—¶é—´è¿‡æœŸ</li>
<li>expireAfterWrite: # æœ€åä¸€æ¬¡å†™å…¥åç»è¿‡å›ºå®šæ—¶é—´è¿‡æœŸ</li>
<li>refreshAfterWrite: # åˆ›å»ºç¼“å­˜æˆ–è€…æœ€è¿‘ä¸€æ¬¡æ›´æ–°ç¼“å­˜åç»è¿‡å›ºå®šçš„æ—¶é—´é—´éš”ï¼Œåˆ·æ–°ç¼“å­˜</li>
<li>weakKeys: # æ‰“å¼€ key çš„å¼±å¼•ç”¨</li>
<li>weakValues:  # æ‰“å¼€ value çš„å¼±å¼•ç”¨</li>
<li>softValues: # æ‰“å¼€ value çš„è½¯å¼•ç”¨</li>
<li>recordStats: # å¼€å‘ç»Ÿè®¡åŠŸèƒ½</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cache:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">caffeine</span><br>    <span class="hljs-attr">caffeine:</span><br>      <span class="hljs-attr">spec:</span> <span class="hljs-string">maximumSize=1024</span><br>    <span class="hljs-attr">cache-names:</span> <span class="hljs-string">cache1,cache2</span><br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineCacheConfig</span> &#123;<br><br> <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">CaffeineCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaffeineCacheManager</span>(<span class="hljs-string">&quot;customer&quot;</span>);<br>  cacheManager.setCaffeine(caffeineCacheBuilder());<br>  <span class="hljs-keyword">return</span> cacheManager;<br> &#125;<br><br> Caffeine &lt; Object, Object &gt; caffeineCacheBuilder() &#123;<br>  <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>   .initialCapacity(<span class="hljs-number">100</span>)<br>   .maximumSize(<span class="hljs-number">500</span>)<br>   .expireAfterAccess(<span class="hljs-number">10</span>, TimeUnit.MINUTES)<br>   .weakKeys()<br>   .recordStats();<br> &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomerService</span> &#123;<br>    Customer <span class="hljs-title function_">getCustomer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Long customerID)</span>;<br>&#125;<br><span class="hljs-comment">// Implementation</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@CacheConfig(cacheNames = &#123;&quot;customer&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultCustomerService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CustomerService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOG</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(DefaultCustomerService.class);<br><br>    <span class="hljs-meta">@Cacheable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Customer <span class="hljs-title function_">getCustomer</span><span class="hljs-params">(Long customerID)</span> &#123;<br>        LOG.info(<span class="hljs-string">&quot;Trying to get customer information for id &#123;&#125; &quot;</span>,customerID);<br>        <span class="hljs-keyword">return</span> getCustomerData(customerID);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Customer <span class="hljs-title function_">getCustomerData</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Long id)</span>&#123;<br>        <span class="hljs-type">Customer</span> <span class="hljs-variable">customer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(id, <span class="hljs-string">&quot;testemail@test.com&quot;</span>, <span class="hljs-string">&quot;Test Customer&quot;</span>);<br>        <span class="hljs-keyword">return</span>  customer;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h1>å¦‚ä½•åº”å¯¹ç¼“å­˜ miss çš„é—®é¢˜</h1>
<p>cache miss åœ¨ä¸­æ–‡çš„è¯­å¢ƒé‡Œç»å¸¸è¢«äººåˆ†ä¸ºç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©å’Œç¼“å­˜ç©¿é€ï¼Œè¿™ä¸‰ç§ç±»å‹å¹¶ä¸å®Œå…¨äº’æ–¥ç©·ä¸¾ï¼Œåœ¨æ¦‚å¿µä¸Šæå…¶å®¹æ˜“é€ æˆæ··æ·†ã€‚åœ¨è¿™ä¸€æ®µæ€»ç»“çš„æ—¶å€™å§‘ä¸”ä¾ç…§è¿™ä¸‰ç§ç±»å‹åˆ†åˆ«åŠ ä»¥è®ºè¿°ã€‚</p>
<h2 id="å¦‚ä½•åº”å¯¹ç¼“å­˜å‡»ç©¿-breakthrough">å¦‚ä½•åº”å¯¹ç¼“å­˜å‡»ç©¿ï¼ˆbreakthroughï¼‰</h2>
<p>ç¼“å­˜å‡»ç©¿ï¼ŒæŒ‡çš„æ˜¯æŸä¸ª key åº”è¯¥è®¿é—®ç¼“å­˜ï¼Œå´æ²¡æœ‰è®¿é—®åˆ°ï¼Œå¯¼è‡´ç¼“å­˜é€šè¿‡å…œåº•çš„ç­–ç•¥å»æ›´ä¸‹æ¸¸çš„å†·å­˜å‚¨åŠ è½½å†…å®¹ï¼Œç»™ä¸‹æ¸¸çš„ç³»ç»Ÿé€ æˆäº†è¯»å‹åŠ›ã€‚</p>
<p>åº”å¯¹è¿™ä¸ªé—®é¢˜çš„åŸºæœ¬æ€è·¯æœ‰ï¼š</p>
<ol>
<li>
<p>äº‹å‰ï¼š</p>
</li>
<li>
<p>åœ¨å¯èƒ½çƒ­ç‚¹æ•°æ®çš„è®¿é—®é«˜å³°åˆ°è¾¾ä»¥å‰ï¼Œæå‰æŠŠæ•°æ®é¢„çƒ­ã€‚</p>
</li>
<li>
<p>æ°¸è¿œä¸è¦è®©ç¼“å­˜å¤±æ•ˆ-è¿™æ ·ç¼“å­˜ stale ä»¥åï¼Œæ€ä¹ˆä¿é²œæ˜¯ä¸ªå·¨å¤§çš„é—®é¢˜ï¼Œåªèƒ½é ä¸€ä¸ªåç«¯çš„ä¸»åŠ¨æ›´æ–°æœºåˆ¶æ¥å°½æœ€å¤§åŠªåŠ›æ¥æ›´æ–°ç¼“å­˜ã€‚è¿™ç§æ–¹æ¡ˆæ˜¯ä¸€è‡´æ€§æœ€å·®çš„ã€‚</p>
</li>
<li>
<p>åœ¨ç¼“å­˜å‡»ç©¿ä»¥å‰ï¼Œä¸»åŠ¨æ›´æ–°ç¼“å­˜ï¼Œå³ä¸è®©ç¼“å­˜å‡»ç©¿å‘ç”Ÿï¼Œå³åŒæ—¶æ‰æœ‰ expireAfter(t1) + loadAfter(t2) çš„ç­–ç•¥ã€‚</p>
</li>
<li>
<p><strong>æç«¯çƒ­çš„æ•°æ®ï¼Œä¸å…è®¸ç¼“å­˜è¢«åŠ¨å¤±æ•ˆï¼Œå¿…é¡»ä½¿ç”¨ä¸»åŠ¨æ›´æ–°çš„æ¨¡å¼ã€‚</strong></p>
</li>
<li>
<p>å¹¶å‘æ“ä½œä¸‹æ›´æ–°ç¼“å­˜ä¸€å®šè¦æ³¨æ„é¡ºåºï¼å¦‚æœæœ‰æ¶ˆæ¯æ¥æ›´æ–°æ›´è¦æ³¨æ„é¡ºåºï¼</p>
</li>
<li>
<p>å®šæ—¶ä»»åŠ¡å’Œå¹¿æ’­åˆ·æ–°æœ‰æ—¶å€™å¯ä»¥äº’ç›¸è¡¥å……-å®šæ—¶ä»»åŠ¡æ˜¯è¶…æ—¶çš„è¡¥å……ã€‚</p>
</li>
<li>
<p>äº‹ä¸­ï¼š</p>
</li>
<li>
<p>åœ¨ç¼“å­˜å‡»ç©¿çš„æ—¶å€™ï¼Œä¸¥æ ¼é™åˆ¶è¯»å†·å­˜å‚¨ + é¢„çƒ­ç¼“å­˜çš„æµé‡ï¼Œå³æœ‰é™é™çº§ï¼Œæœ‰æŸæœåŠ¡ã€‚</p>
</li>
<li>
<p>å¦‚æœç¼“å­˜æ›´æ–°æ˜¯åŒæ­¥è¯»å†™ï¼ˆCache Aside æˆ–è€… Read/Write Throughï¼‰çš„æ¨¡å¼ï¼Œåˆ™å¼•å…¥å„ç§é™æµå·¥å…·ï¼ˆé™åˆ¶çº¿ç¨‹æ•°çš„çº¿ç¨‹æ± /ä¿¡å·é‡/SLA/Rhino/Redis è®¡æ•°å™¨/çº¿ç¨‹å†…è®¡æ•°å™¨/Hystrix/Web å®¹å™¨çš„é™æµå™¨ï¼‰ï¼Œä¿éšœå¯ç”¨æ€§çš„åŒæ—¶ä¿éšœååé‡ã€‚</p>
</li>
<li>
<p>å¦‚æœç¼“å­˜æ›´æ–°å¯ä»¥å¼‚æ­¥ä¸»åŠ¨æ›´æ–°ï¼Œåˆ™è€ƒè™‘å•çº¿ç¨‹æ‰§è¡Œæˆ–è€…ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œä½æµé‡æ›´æ–°ã€‚èƒ½æ€æ ·åœ¨äº‹ä¸­é™åˆ¶è¿™ä¸ªé—®é¢˜ï¼Œå–å†³äºç¼“å­˜å’Œè¯»å†™æ¥å…¥å±‚ä¹‹é—´æœ¬æ¥çš„æ¶æ„å…³ç³»æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚</p>
</li>
<li>
<p>æŸç±»ç‰¹åˆ«çƒ­çš„ key å¯èƒ½ä¸€æ—¦å¤±æ•ˆä¼šå¯¼è‡´å¤§é‡çš„è¯»ï¼Œè¿™ç§ key çš„å®é™…æ›´æ–°æµç¨‹è¿˜è¦åŠ ä¸Šåˆ†å¸ƒå¼é”-è€Œä¸”è¿˜è¦ä½¿ç”¨è¯•é”è€Œä¸èƒ½ä½¿ç”¨é˜»å¡é”-facebook çš„è®ºæ–‡é‡Œæ²¡æœ‰æåˆ°è¿™ç§ç­–ç•¥ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æ•°æ®å¾ˆå‡åŒ€ã€‚</p>
</li>
<li>
<p>äº‹åï¼š</p>
</li>
<li>
<p>å¦‚æœç³»ç»Ÿæ— æ³•è‡ªæ„ˆï¼Œç†”æ–­æ‹’ç»æœåŠ¡ä»¥åï¼ˆæ‰€ä»¥ç†”æ–­ã€é™çº§é™æµæ¯ä¸€æ‰‹å‡†å¤‡éƒ½è¦å‡†å¤‡å¥½ï¼Œå¯ä»¥ç”¨é™æµä¸º 0 æ¥åˆ¶é€ ç†”æ–­ï¼‰ï¼Œæ‰‹å·¥é¢„çƒ­ç¼“å­˜ã€‚</p>
</li>
</ol>
<h2 id="å¦‚ä½•åº”å¯¹ç¼“å­˜é›ªå´©">å¦‚ä½•åº”å¯¹ç¼“å­˜é›ªå´©</h2>
<p>é›ªå´©é—®é¢˜ï¼ŒæŒ‡çš„æ˜¯ï¼šå¤§è§„æ¨¡çš„ç¼“å­˜å¤±æ•ˆï¼Œå†åŠ ä¸Šå¤§è§„æ¨¡çš„è®¿é—®æµé‡ï¼Œé€ æˆå¯¹åç«¯éé«˜å¯ç”¨çš„å†·å­˜å‚¨ï¼ˆé€šå¸¸æ˜¯ RDBMSï¼‰çš„å¤§è§„æ¨¡è¯»å†™ï¼Œå¯¼è‡´ RDBMS å¯ç”¨æ€§ä¸‹é™ï¼Œç”šè‡³æ•´ä¸ªç³»ç»Ÿçº§è”å´©æºƒã€‚</p>
<p>ä»æŸç§æ„ä¹‰ä¸Šï¼Œå•ä¸€ç¼“å­˜çš„å‡»ç©¿å¹¶ä¸å¯æ€•ï¼Œç¼“å­˜é›ªå´©æ‰æ˜¯æœ€å¯æ€•çš„ã€‚</p>
<p>åº”å¯¹ç¼“å­˜é›ªå´©é—®é¢˜ï¼ŒåŸºæœ¬æ€è·¯æ˜¯å¤§è§„æ¨¡ä½¿ç”¨åº”å¯¹ç¼“å­˜å‡»ç©¿çš„åŸºç¡€ç­–ç•¥çš„åŸºç¡€ä¸Šï¼ŒæŠŠç¼“å­˜é¢„çƒ­çš„è¡Œä¸ºæ¨¡å¼æ‰“æ•£ã€‚</p>
<p>åŸºäºè¶…æ—¶æ—¶é—´çš„æ€è·¯æ˜¯ï¼šä¸åŒçš„ key è®¾ç½®ä¸åŒçš„è¶…æ—¶æ—¶é—´ï¼Œè®©ç¼“å­˜å¤±æ•ˆä¸åŒæ—¶åˆ°æ¥ã€‚ä½†è¿™æ ·å¹¶ä¸èƒ½å®Œå…¨è§£å†³é—®é¢˜ï¼Œå› ä¸ºç¼“å­˜å¹¶ä¸æ˜¯å¤±æ•ˆä»¥åå°±ç›´æ¥å¯ä»¥è¢«åŠ è½½ä¸Šï¼Œé™¤éç¼“å­˜è‡ªå¸¦å¼‚æ­¥è‡ªåŠ è½½çš„æœºåˆ¶ï¼ˆå¾ˆå¤š in-memory cache æœ‰ï¼Œä½† Redis æ²¡æœ‰ï¼‰ï¼Œå¦åˆ™ä¸å‡åŒ€çš„æµé‡è¿˜æ˜¯å¯èƒ½åˆ°è¾¾ç¼“å­˜åå¯¼è‡´å¤§è§„æ¨¡å‡»ç©¿ã€‚å¯¹è¶…æ—¶æ—¶é—´çš„æ–¹æ¡ˆçš„åŠ å¼ºç‰ˆæ˜¯ï¼Œé‡‡ç”¨ä¸€å¥—ä¸»åŠ¨æ›´æ–°ç¼“å­˜çš„æœºåˆ¶ã€‚</p>
<p>åŸºäºé¢„çƒ­çš„æ€è·¯æ˜¯ï¼šç¼“å­˜ä¸€å¼€å§‹åˆ†å¥½é›†ç¾¤ã€‚å…è®¸æŸäº›é›†ç¾¤çš„ä¸Šæ¸¸å‡†å¤‡å¥½ç†”æ–­ï¼Œç„¶åé›†ä½“åœä¸‹æµé‡ä»¥åï¼Œä½¿ç”¨è„šæœ¬æ‰¹é‡é¢„çƒ­æ•´ä¸ªé›†ç¾¤æ•°æ®ã€‚</p>
<h2 id="å¦‚ä½•åº”å¯¹ç¼“å­˜ç©¿é€-penetration">å¦‚ä½•åº”å¯¹ç¼“å­˜ç©¿é€ï¼ˆpenetrationï¼‰</h2>
<p>ç¼“å­˜ç©¿é€ä¸åŒäºç¼“å­˜å‡»ç©¿ã€‚</p>
<p>ç¼“å­˜ç©¿é€æŒ‡çš„æ˜¯è¯•å›¾æŸ¥è¯¢ä¸å­˜åœ¨çš„ç¼“å­˜æ•°æ®ã€‚</p>
<p>å¯ä»¥é’ˆå¯¹ç¼“å­˜ç©¿é€æ¥åˆ·å†·æ•°æ®ï¼Œå¯¼è‡´æ•´ä¸ªé›†ç¾¤é¢‘ç¹æŸ¥è¯¢å†·å­˜å‚¨è€Œå´©æºƒã€‚</p>
<p>è§£å†³æ–¹æ¡ˆæœ‰ï¼š</p>
<ol>
<li>å¯¹æ˜æ˜¾ä¸ç¬¦åˆè¦æ±‚çš„è¯·æ±‚ï¼Œç›´æ¥è¿”å› nullã€‚</li>
<li>ä½¿ç”¨ä¸€ä¸ªå¤§çš„ bitmap æˆ–è€…å¸ƒéš†è¿‡æ»¤å™¨æ¥æ‹¦æˆªå¯èƒ½ä¸å­˜åœ¨çš„è¯·æ±‚ï¼Œç›´æ¥è¿”å› nullã€‚</li>
<li>ç¼“å­˜ç©¿é€ä¸€æ¬¡ï¼Œå°±åœ¨ cache ä¸­å­˜ä¸Š null - <strong>å…è®¸ä½¿ç”¨ null çš„ç¼“å­˜èƒ½å¤Ÿå¤©ç„¶æŠµæŒ¡ç¼“å­˜ç©¿é€é—®é¢˜ã€‚Guava çš„ç¼ºç‚¹å°±åœ¨è¿™é‡Œè¢«ä½“ç°å‡ºæ¥äº†</strong></li>
</ol>
<p>ä»¥ä¸Šæªæ–½æ··åˆä½¿ç”¨çš„è¯ï¼Œå¿…é¡»è€ƒè™‘ç¼“å­˜é‡Œçš„ nullã€‚ å¿…é¡»æœ‰è¶…æ—¶æ—¶é—´ï¼Œè€Œä¸”åº”è¯¥æœ‰å¯¹åº”çš„æ—  nullã€‚ ä»¥åä¸»åŠ¨æ›´æ–°çš„æœºåˆ¶ï¼Œå¦åˆ™è¿™ä¸ªç©ºå€¼å°±è¢«æ±¡æŸ“äº†ã€‚</p>
<h1>è¿œç«¯ç¼“å­˜ä¸è¿‘ç«¯ç¼“å­˜çš„è¾¨æ</h1>
<p>ç¼“å­˜åœ¨å“ªç«¯ï¼Œå“ªç«¯å°±èƒ½å®šåˆ¶å®ƒçš„è¡Œä¸ºï¼Œä½†è¦ä¾›åº”å®ƒæ¶ˆè€—çš„èµ„æºã€‚è¿‘ç«¯ç¼“å­˜é€šå¸¸ç®€å•ï¼Œä½†ä¹Ÿå°±æ„å‘³ç€æ²¡æœ‰ä»€ä¹ˆåŠŸèƒ½ã€‚</p>
<h2 id="è¿œç«¯ç¼“å­˜çš„å¥½å¤„">è¿œç«¯ç¼“å­˜çš„å¥½å¤„</h2>
<p>è‡ªå¸¦å¹¿æ’­ã€åŒæ­¥å’Œå…±è¯†åŠŸèƒ½ï¼Œèƒ½å¤Ÿå¯¹æ¥å†™å…¥æœåŠ¡ã€‚<br>
è‡ªå¸¦ç‹¬ç«‹çš„é›†ç¾¤ï¼Œæœ‰ä¸“ä¸šçš„è¿ç»´äººå‘˜ï¼Œé€‚åˆå­˜å‚¨æµ·é‡æ•°æ®ã€‚</p>
<h2 id="è¿œç«¯ç¼“å­˜çš„åå¤„">è¿œç«¯ç¼“å­˜çš„åå¤„</h2>
<p>åˆ¶é€ äº†å¤æ‚çš„ä¾èµ–ï¼Œæ¯”å¦‚æ¥å…¥å˜å¤æ‚ã€æµç¨‹å˜å¤æ‚ã€‚<br>
æ‰€æœ‰çš„æœåŠ¡éƒ½ä¾èµ–äºä¸€ä¸ªæœåŠ¡ï¼Œé…ç½®å’Œæµç¨‹ä¸æ˜“äºå·®å¼‚åŒ–ï¼Œå†²çªæ¯”ä¾‹å¢å¤šã€‚</p>
<h2 id="è¿‘ç«¯ç¼“å­˜çš„å¥½å¤„">è¿‘ç«¯ç¼“å­˜çš„å¥½å¤„</h2>
<p>æ¥å…¥ç®€å•ã€‚<br>
è‡ªå·±å¯ä»¥æŠŠæ§è‡ªå·±çš„ç¼“å­˜ä½¿ç”¨é€»è¾‘ã€‚</p>
<h2 id="è¿‘ç«¯ç¼“å­˜çš„åå¤„">è¿‘ç«¯ç¼“å­˜çš„åå¤„</h2>
<p>ç›¸å¯¹äºå¹¿æ’­åŒæ­¥ä¸€è‡´æ€§éš¾åº¦å¤§ï¼Œé€šä¿¡æˆæœ¬é«˜-æ˜“å¼•èµ·é€šä¿¡é£æš´ã€‚<br>
å ç”¨å†…å­˜å˜å¤§ï¼Œæ— æ³•è§£å†³æµ·é‡æ•°æ®å­˜å‚¨ã€‚</p>
<h3 id="å-ç¼“å­˜ä¸æ•°æ®åº“ä¸€è‡´æ€§æ·±åº¦åˆ†æ">åã€ç¼“å­˜ä¸æ•°æ®åº“ä¸€è‡´æ€§æ·±åº¦åˆ†æ</h3>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç¼“å­˜ä¸æ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§æ˜¯æ°¸æ’çš„éš¾é¢˜ã€‚æœ¬èŠ‚æ·±å…¥åˆ†æå‡ ç§é«˜çº§ä¸€è‡´æ€§æ–¹æ¡ˆã€‚</p>
<h4 id="å»¶è¿ŸåŒåˆ ç­–ç•¥">å»¶è¿ŸåŒåˆ ç­–ç•¥</h4>
<p><strong>é—®é¢˜æè¿°</strong>ï¼šåœ¨ Cache Aside æ¨¡å¼ä¸‹ï¼Œå…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“ï¼Œåœ¨æ›´æ–°å®Œæˆä¹‹å‰ï¼Œå¦‚æœæœ‰è¯»è¯·æ±‚è¿›æ¥ï¼Œä¼šè¯»å–åˆ°æ—§æ•°æ®å¹¶å†™å…¥ç¼“å­˜ï¼Œå¯¼è‡´ç¼“å­˜ä¸æ•°æ®åº“ä¸ä¸€è‡´ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå»¶è¿ŸåŒåˆ ç­–ç•¥é€šè¿‡åœ¨æ•°æ®åº“æ›´æ–°åå†æ¬¡åˆ é™¤ç¼“å­˜æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedDoubleDeleteCacheService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å»¶è¿ŸåŒåˆ ç­–ç•¥</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key ç¼“å­˜key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value æ–°å€¼</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> delayMs å»¶è¿Ÿåˆ é™¤æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateWithDelayedDoubleDelete</span><span class="hljs-params">(String key, String value, <span class="hljs-type">long</span> delayMs)</span> &#123;<br>        <span class="hljs-comment">// ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜</span><br>        deleteCache(key);<br>        <br>        <span class="hljs-comment">// æ›´æ–°æ•°æ®åº“</span><br>        updateDatabase(key, value);<br>        <br>        <span class="hljs-comment">// å»¶è¿Ÿåå†æ¬¡åˆ é™¤ç¼“å­˜</span><br>        scheduleDelayedDelete(key, delayMs);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteCache</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            jedis.del(key);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateDatabase</span><span class="hljs-params">(String key, String value)</span> &#123;<br>        <span class="hljs-comment">// æ•°æ®åº“æ›´æ–°é€»è¾‘</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleDelayedDelete</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> delayMs)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(delayMs);<br>                deleteCache(key);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                Thread.currentThread().interrupt();<br>            &#125;<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>æ—¶åºåˆ†æ</strong>ï¼š</p>
<pre><code class="hljs mermaid">sequenceDiagram
    participant Client
    participant Cache
    participant DB
    participant AsyncDelete
    
    Client-&gt;&gt;Cache: 1. åˆ é™¤ç¼“å­˜
    Client-&gt;&gt;DB: 2. æ›´æ–°æ•°æ®åº“
    par å¹¶å‘è¯»è¯·æ±‚
        Client-&gt;&gt;Cache: 3a. è¯»å–ç¼“å­˜ï¼ˆmissï¼‰
        Client-&gt;&gt;DB: 3b. è¯»å–æ•°æ®åº“ï¼ˆæ—§å€¼ï¼‰
        Client-&gt;&gt;Cache: 3c. å†™å…¥ç¼“å­˜ï¼ˆæ—§å€¼ï¼‰
    end
    Client-&gt;&gt;AsyncDelete: 4. å»¶è¿ŸNç§’ååˆ é™¤ç¼“å­˜
    AsyncDelete-&gt;&gt;Cache: 5. åˆ é™¤ç¼“å­˜</code></pre>
<p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p>
<ul>
<li>å»¶è¿Ÿæ—¶é—´åº”å¤§äºæ•°æ®åº“ä¸»ä»åŒæ­¥å»¶è¿Ÿ + ä¸šåŠ¡è¯»è¯·æ±‚å¹³å‡è€—æ—¶</li>
<li>å»ºè®®å»¶è¿Ÿæ—¶é—´è®¾ç½®ä¸º 500ms-2s</li>
<li>é…åˆæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥åˆ é™¤ï¼Œé¿å…çº¿ç¨‹é˜»å¡</li>
</ul>
<h4 id="canal-binlog-è®¢é˜…æ–¹æ¡ˆ">Canal/Binlog è®¢é˜…æ–¹æ¡ˆ</h4>
<p><strong>é—®é¢˜æè¿°</strong>ï¼šä¸šåŠ¡ä»£ç ä¸­ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§é€»è¾‘å¤æ‚ï¼Œå®¹æ˜“é—æ¼ï¼Œä¸”ä¾µå…¥æ€§å¼ºã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šé€šè¿‡ç›‘å¬ MySQL binlogï¼Œå¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œå®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;<br><span class="hljs-keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;<br><span class="hljs-keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry;<br><span class="hljs-keyword">import</span> com.alibaba.otter.canal.protocol.Message;<br><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanalCacheSyncService</span> &#123;<br>    <span class="hljs-keyword">private</span> CanalConnector connector;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>        connector = CanalConnectors.newSingleConnector(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">11111</span>),<br>            <span class="hljs-string">&quot;example&quot;</span>, <br>            <span class="hljs-string">&quot;&quot;</span>, <br>            <span class="hljs-string">&quot;&quot;</span><br>        );<br>        connector.connect();<br>        connector.subscribe(<span class="hljs-string">&quot;.*\\..*&quot;</span>);<br>        connector.rollback();<br>        <br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> connector.getWithoutAck(<span class="hljs-number">100</span>);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">batchId</span> <span class="hljs-operator">=</span> message.getId();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> message.getEntries().size();<br>            <br>            <span class="hljs-keyword">if</span> (batchId != -<span class="hljs-number">1</span> &amp;&amp; size &gt; <span class="hljs-number">0</span>) &#123;<br>                processEntries(message.getEntries());<br>            &#125;<br>            <br>            connector.ack(batchId);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processEntries</span><span class="hljs-params">(List&lt;CanalEntry.Entry&gt; entries)</span> &#123;<br>        <span class="hljs-keyword">for</span> (CanalEntry.Entry entry : entries) &#123;<br>            <span class="hljs-keyword">if</span> (entry.getEntryType() == CanalEntry.EntryType.ROWDATA) &#123;<br>                CanalEntry.RowChange rowChange;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    rowChange = CanalEntry.RowChange.parseFrom(entry.getStoreValue());<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <br>                <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> entry.getHeader().getTableName();<br>                CanalEntry.<span class="hljs-type">EventType</span> <span class="hljs-variable">eventType</span> <span class="hljs-operator">=</span> rowChange.getEventType();<br>                <br>                <span class="hljs-keyword">for</span> (CanalEntry.RowData rowData : rowChange.getRowDatasList()) &#123;<br>                    <span class="hljs-keyword">if</span> (eventType == CanalEntry.EventType.INSERT || <br>                        eventType == CanalEntry.EventType.UPDATE) &#123;<br>                        <span class="hljs-comment">// å¤„ç†æ’å…¥å’Œæ›´æ–°</span><br>                        handleInsertOrUpdate(tableName, rowData.getAfterColumnsList());<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eventType == CanalEntry.EventType.DELETE) &#123;<br>                        <span class="hljs-comment">// å¤„ç†åˆ é™¤</span><br>                        handleDelete(tableName, rowData.getBeforeColumnsList());<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleInsertOrUpdate</span><span class="hljs-params">(String tableName, List&lt;CanalEntry.Column&gt; columns)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> buildCacheKey(tableName, columns);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheValue</span> <span class="hljs-operator">=</span> buildCacheValue(columns);<br>        <br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            jedis.setex(cacheKey, <span class="hljs-number">3600</span>, cacheValue);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelete</span><span class="hljs-params">(String tableName, List&lt;CanalEntry.Column&gt; columns)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> buildCacheKey(tableName, columns);<br>        <br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            jedis.del(cacheKey);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildCacheKey</span><span class="hljs-params">(String tableName, List&lt;CanalEntry.Column&gt; columns)</span> &#123;<br>        <span class="hljs-comment">// æ ¹æ®è¡¨åå’Œä¸»é”®æ„å»ºç¼“å­˜key</span><br>        <span class="hljs-keyword">return</span> tableName + <span class="hljs-string">&quot;:&quot;</span> + getColumnValue(columns, <span class="hljs-string">&quot;id&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildCacheValue</span><span class="hljs-params">(List&lt;CanalEntry.Column&gt; columns)</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;&#123;&quot;</span>);<br>        <span class="hljs-keyword">for</span> (CanalEntry.Column column : columns) &#123;<br>            sb.append(<span class="hljs-string">&quot;\&quot;&quot;</span>).append(column.getName()).append(<span class="hljs-string">&quot;\&quot;:\&quot;&quot;</span>)<br>              .append(column.getValue()).append(<span class="hljs-string">&quot;\&quot;,&quot;</span>);<br>        &#125;<br>        sb.deleteCharAt(sb.length() - <span class="hljs-number">1</span>);<br>        sb.append(<span class="hljs-string">&quot;&#125;&quot;</span>);<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getColumnValue</span><span class="hljs-params">(List&lt;CanalEntry.Column&gt; columns, String columnName)</span> &#123;<br>        <span class="hljs-keyword">return</span> columns.stream()<br>            .filter(c -&gt; c.getName().equals(columnName))<br>            .findFirst()<br>            .map(CanalEntry.Column::getValue)<br>            .orElse(<span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>æ¶æ„å›¾</strong>ï¼š</p>
<pre><code class="hljs mermaid">graph LR
    A[ä¸šåŠ¡åº”ç”¨] --&gt;|å†™æ“ä½œ| B[(MySQL)]
    B --&gt;|Binlog| C[Canal Server]
    C --&gt;|è®¢é˜…| D[Canal Client]
    D --&gt;|è§£æ| E[ç¼“å­˜æ›´æ–°æœåŠ¡]
    E --&gt;|æ›´æ–°/åˆ é™¤| F[(Redis)]
    A --&gt;|è¯»æ“ä½œ| F</code></pre>
<p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ Kafkaï¼‰ç¼“å†² binlog äº‹ä»¶ï¼Œæé«˜ååé‡</li>
<li>å®ç°å¹‚ç­‰æ€§ï¼Œé¿å…é‡å¤æ›´æ–°</li>
<li>ç›‘æ§ binlog å»¶è¿Ÿï¼ŒåŠæ—¶å‘ç°åŒæ­¥é—®é¢˜</li>
</ul>
<h4 id="åˆ†å¸ƒå¼äº‹åŠ¡ä¸ç¼“å­˜">åˆ†å¸ƒå¼äº‹åŠ¡ä¸ç¼“å­˜</h4>
<p><strong>é—®é¢˜æè¿°</strong>ï¼šåœ¨åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ä¸‹ï¼Œæ•°æ®åº“å’Œç¼“å­˜çš„æ“ä½œåŸå­æ€§éš¾ä»¥ä¿è¯ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨ TCCï¼ˆTry-Confirm-Cancelï¼‰æ¨¡å¼æˆ– Saga æ¨¡å¼ï¼Œç»“åˆç¼“å­˜è¡¥å¿æœºåˆ¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> redis.clients.jedis.Pipeline;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTransactionCacheService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * TCC æ¨¡å¼ä¸‹çš„ç¼“å­˜æ“ä½œ</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateWithTCC</span><span class="hljs-params">(String key, String value)</span> &#123;<br>        <span class="hljs-comment">// Try é˜¶æ®µï¼šé¢„ç•™èµ„æº</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            tryPhase(key, value);<br>            <br>            <span class="hljs-comment">// ç¡®è®¤é˜¶æ®µï¼šæäº¤äº‹åŠ¡</span><br>            confirmPhase(key, value);<br>            <br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// å–æ¶ˆé˜¶æ®µï¼šå›æ»šäº‹åŠ¡</span><br>            cancelPhase(key);<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tryPhase</span><span class="hljs-params">(String key, String value)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// è®¾ç½®ä¸´æ—¶æ ‡è®°</span><br>            jedis.setex(key + <span class="hljs-string">&quot;:try&quot;</span>, <span class="hljs-number">30</span>, <span class="hljs-string">&quot;processing&quot;</span>);<br>            <br>            <span class="hljs-comment">// è®°å½•åŸå§‹å€¼ï¼ˆç”¨äºå›æ»šï¼‰</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> jedis.get(key);<br>            <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-literal">null</span>) &#123;<br>                jedis.setex(key + <span class="hljs-string">&quot;:old&quot;</span>, <span class="hljs-number">30</span>, oldValue);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirmPhase</span><span class="hljs-params">(String key, String value)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> jedis.pipelined();<br>            <br>            <span class="hljs-comment">// æ›´æ–°ç¼“å­˜</span><br>            pipeline.setex(key, <span class="hljs-number">3600</span>, value);<br>            <br>            <span class="hljs-comment">// æ¸…ç†ä¸´æ—¶æ ‡è®°</span><br>            pipeline.del(key + <span class="hljs-string">&quot;:try&quot;</span>);<br>            pipeline.del(key + <span class="hljs-string">&quot;:old&quot;</span>);<br>            <br>            pipeline.sync();<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelPhase</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> jedis.pipelined();<br>            <br>            <span class="hljs-comment">// æ¢å¤åŸå§‹å€¼</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> jedis.get(key + <span class="hljs-string">&quot;:old&quot;</span>);<br>            <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-literal">null</span>) &#123;<br>                pipeline.setex(key, <span class="hljs-number">3600</span>, oldValue);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                pipeline.del(key);<br>            &#125;<br>            <br>            <span class="hljs-comment">// æ¸…ç†ä¸´æ—¶æ ‡è®°</span><br>            pipeline.del(key + <span class="hljs-string">&quot;:try&quot;</span>);<br>            pipeline.del(key + <span class="hljs-string">&quot;:old&quot;</span>);<br>            <br>            pipeline.sync();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ç‰ˆæœ¬å·-æ—¶é—´æˆ³æ–¹æ¡ˆ">ç‰ˆæœ¬å·/æ—¶é—´æˆ³æ–¹æ¡ˆ</h4>
<p><strong>é—®é¢˜æè¿°</strong>ï¼šå¹¶å‘æ›´æ–°æ—¶ï¼Œæ—§æ•°æ®å¯èƒ½è¦†ç›–æ–°æ•°æ®ï¼Œå¯¼è‡´ç¼“å­˜è„æ•°æ®ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³å®ç°ä¹è§‚é”æœºåˆ¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionedCacheService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä½¿ç”¨ç‰ˆæœ¬å·çš„ç¼“å­˜æ›´æ–°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateWithVersion</span><span class="hljs-params">(String key, String value, <span class="hljs-type">long</span> expectedVersion)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <br>                <span class="hljs-string">&quot;local currentVersion = redis.call(&#x27;HGET&#x27;, KEYS[1], &#x27;version&#x27;) &quot;</span> +<br>                <span class="hljs-string">&quot;if currentVersion == false then &quot;</span> +<br>                <span class="hljs-string">&quot;    return 0 &quot;</span> +<br>                <span class="hljs-string">&quot;end &quot;</span> +<br>                <span class="hljs-string">&quot;if tonumber(currentVersion) == tonumber(ARGV[1]) then &quot;</span> +<br>                <span class="hljs-string">&quot;    redis.call(&#x27;HMSET&#x27;, KEYS[1], &#x27;value&#x27;, ARGV[2], &#x27;version&#x27;, ARGV[3]) &quot;</span> +<br>                <span class="hljs-string">&quot;    return 1 &quot;</span> +<br>                <span class="hljs-string">&quot;else &quot;</span> +<br>                <span class="hljs-string">&quot;    return 0 &quot;</span> +<br>                <span class="hljs-string">&quot;end&quot;</span>;<br>            <br>            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (Long) jedis.eval(<br>                luaScript, <br>                <span class="hljs-number">1</span>, <br>                key + <span class="hljs-string">&quot;:versioned&quot;</span>, <br>                String.valueOf(expectedVersion), <br>                value, <br>                String.valueOf(expectedVersion + <span class="hljs-number">1</span>)<br>            );<br>            <br>            <span class="hljs-keyword">return</span> result == <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–å¸¦ç‰ˆæœ¬å·çš„æ•°æ®</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> VersionedValue <span class="hljs-title function_">getWithVersion</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.hget(key + <span class="hljs-string">&quot;:versioned&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> jedis.hget(key + <span class="hljs-string">&quot;:versioned&quot;</span>, <span class="hljs-string">&quot;version&quot;</span>);<br>            <br>            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VersionedValue</span>(value, Long.parseLong(version));<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionedValue</span> &#123;<br>        <span class="hljs-keyword">private</span> String value;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> version;<br>        <br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">VersionedValue</span><span class="hljs-params">(String value, <span class="hljs-type">long</span> version)</span> &#123;<br>            <span class="hljs-built_in">this</span>.value = value;<br>            <span class="hljs-built_in">this</span>.version = version;<br>        &#125;<br>        <br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <br>        <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getVersion</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> version;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="facebook-memcache-è®ºæ–‡è¦ç‚¹">Facebook Memcache è®ºæ–‡è¦ç‚¹</h4>
<p><strong>Lease æœºåˆ¶</strong>ï¼šé˜²æ­¢å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶ç¼“å­˜æœªå‘½ä¸­æ•°æ®ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›ã€‚</p>
<pre><code class="hljs mermaid">sequenceDiagram
    participant Client1
    participant Client2
    participant Cache
    participant DB
    
    Client1-&gt;&gt;Cache: 1. Get(key) miss
    Cache-&gt;&gt;Client1: 2. è¿”å› lease (1ç§’æœ‰æ•ˆ)
    Client1-&gt;&gt;DB: 3. ä»DBåŠ è½½æ•°æ®
    Client2-&gt;&gt;Cache: 4. Get(key) miss
    Cache-&gt;&gt;Client2: 5. è¿”å› lease (ç­‰å¾…ä¸­)
    Client1-&gt;&gt;Cache: 6. Set(key, value) with lease
    Cache-&gt;&gt;Client2: 7. é€šçŸ¥æ•°æ®å·²æ›´æ–°
    Client2-&gt;&gt;Cache: 8. Get(key) hit
    Cache-&gt;&gt;Client2: 9. è¿”å›æ•°æ®</code></pre>
<h3 id="åä¸€-çƒ­ç‚¹æ¢æµ‹ä¸çƒ­-key-æ²»ç†">åä¸€ã€çƒ­ç‚¹æ¢æµ‹ä¸çƒ­ Key æ²»ç†</h3>
<h4 id="çƒ­ç‚¹-key-çš„å®šä¹‰å’Œå±å®³">çƒ­ç‚¹ Key çš„å®šä¹‰å’Œå±å®³</h4>
<p><strong>å®šä¹‰</strong>ï¼šå•ä¸ª key çš„è®¿é—®é¢‘ç‡è¿œè¶…å¹³å‡æ°´å¹³ï¼Œå¯¼è‡´å•ä¸ªç¼“å­˜èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ã€‚</p>
<p><strong>å±å®³</strong>ï¼š</p>
<ul>
<li>å•èŠ‚ç‚¹ CPU/å†…å­˜èµ„æºè€—å°½</li>
<li>ç½‘ç»œå¸¦å®½ç“¶é¢ˆ</li>
<li>å½±å“å…¶ä»– key çš„è®¿é—®æ€§èƒ½</li>
<li>å¯èƒ½å¯¼è‡´æ•´ä¸ªç¼“å­˜é›†ç¾¤ä¸å¯ç”¨</li>
</ul>
<h4 id="çƒ­ç‚¹æ¢æµ‹æ–¹æ¡ˆ">çƒ­ç‚¹æ¢æµ‹æ–¹æ¡ˆ</h4>
<h5 id="å®¢æˆ·ç«¯ç»Ÿè®¡">å®¢æˆ·ç«¯ç»Ÿè®¡</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientSideHotKeyDetector</span> &#123;<br>    <span class="hljs-keyword">private</span> ConcurrentHashMap&lt;String, AtomicLong&gt; keyCounter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">hotThreshold</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>; <span class="hljs-comment">// QPS é˜ˆå€¼</span><br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClientSideHotKeyDetector</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// æ¯ç§’ç»Ÿè®¡ä¸€æ¬¡</span><br>        scheduler.scheduleAtFixedRate(<span class="hljs-built_in">this</span>::detectHotKeys, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordAccess</span><span class="hljs-params">(String key)</span> &#123;<br>        keyCounter.computeIfAbsent(key, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>)).incrementAndGet();<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">detectHotKeys</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        keyCounter.forEach((key, count) -&gt; &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">qps</span> <span class="hljs-operator">=</span> count.getAndSet(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (qps &gt; hotThreshold) &#123;<br>                System.out.println(<span class="hljs-string">&quot;æ£€æµ‹åˆ°çƒ­ç‚¹ Key: &quot;</span> + key + <span class="hljs-string">&quot;, QPS: &quot;</span> + qps);<br>                handleHotKey(key);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleHotKey</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-comment">// é€šçŸ¥æ²»ç†æœåŠ¡</span><br>        <span class="hljs-comment">// å¯ä»¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å‘é€çƒ­ç‚¹äº‹ä»¶</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="æœåŠ¡ç«¯ç»Ÿè®¡-redis-hotkeys">æœåŠ¡ç«¯ç»Ÿè®¡ï¼ˆRedis hotkeysï¼‰</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Redis 4.0+ æä¾› hotkeys å‘½ä»¤</span><br>redis-cli --hotkeys<br><br><span class="hljs-comment"># è¾“å‡ºç¤ºä¾‹ï¼š</span><br><span class="hljs-comment"># # Hotkeys</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># 1) &quot;user:profile:1001&quot;</span><br><span class="hljs-comment"># 2) (integer) 1234567</span><br><span class="hljs-comment"># 3) (integer) 1234567890.1234567890</span><br></code></pre></td></tr></table></figure>
<h5 id="äº¬ä¸œ-hotkey-æ¡†æ¶">äº¬ä¸œ HotKey æ¡†æ¶</h5>
<p><strong>æ¶æ„å›¾</strong>ï¼š</p>
<pre><code class="hljs mermaid">graph TB
    A[å®¢æˆ·ç«¯åº”ç”¨] --&gt;|ä¸ŠæŠ¥è®¿é—®| B[WorkerèŠ‚ç‚¹]
    A --&gt;|æŸ¥è¯¢çƒ­ç‚¹| C[æœ¬åœ°ç¼“å­˜]
    B --&gt;|èšåˆç»Ÿè®¡| D[Etcdé›†ç¾¤]
    D --&gt;|æ¨é€çƒ­ç‚¹| B
    B --&gt;|æ¨é€çƒ­ç‚¹| A
    D --&gt;|æŒä¹…åŒ–| E[(æ•°æ®åº“)]</code></pre>
<h4 id="çƒ­-key-æ²»ç†æ–¹æ¡ˆ">çƒ­ Key æ²»ç†æ–¹æ¡ˆ</h4>
<h5 id="æœ¬åœ°ç¼“å­˜å…œåº•-l1-cache">æœ¬åœ°ç¼“å­˜å…œåº•ï¼ˆL1 Cacheï¼‰</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Cache;<br><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;<br><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TwoLevelCacheService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool redisPool;<br>    <span class="hljs-keyword">private</span> Cache&lt;String, String&gt; localCache;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TwoLevelCacheService</span><span class="hljs-params">()</span> &#123;<br>        localCache = Caffeine.newBuilder()<br>            .maximumSize(<span class="hljs-number">1000</span>)<br>            .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS)<br>            .build();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-comment">// L1: æœ¬åœ°ç¼“å­˜</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> localCache.getIfPresent(key);<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <br>        <span class="hljs-comment">// L2: Redis ç¼“å­˜</span><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> redisPool.getResource()) &#123;<br>            value = jedis.get(key);<br>            <br>            <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// å†™å…¥æœ¬åœ°ç¼“å­˜</span><br>                localCache.put(key, value);<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String key, String value)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> redisPool.getResource()) &#123;<br>            jedis.setex(key, <span class="hljs-number">3600</span>, value);<br>        &#125;<br>        <br>        <span class="hljs-comment">// åŒæ—¶æ›´æ–°æœ¬åœ°ç¼“å­˜</span><br>        localCache.put(key, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="key-åˆ†æ•£-æ‰“æ•£">Key åˆ†æ•£/æ‰“æ•£</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyDistributeService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARD_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å†™å…¥ï¼šåˆ†ç‰‡å†™å…¥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeDistributed</span><span class="hljs-params">(String baseKey, String value)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardId</span> <span class="hljs-operator">=</span> random.nextInt(SHARD_COUNT);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">distributedKey</span> <span class="hljs-operator">=</span> baseKey + <span class="hljs-string">&quot;:&quot;</span> + shardId;<br>        <br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            jedis.setex(distributedKey, <span class="hljs-number">3600</span>, value);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¯»å–ï¼šéšæœºè¯»å–ä¸€ä¸ªåˆ†ç‰‡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readDistributed</span><span class="hljs-params">(String baseKey)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">shardId</span> <span class="hljs-operator">=</span> random.nextInt(SHARD_COUNT);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">distributedKey</span> <span class="hljs-operator">=</span> baseKey + <span class="hljs-string">&quot;:&quot;</span> + shardId;<br>        <br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-keyword">return</span> jedis.get(distributedKey);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¯»å–ï¼šå°è¯•è¯»å–æ‰€æœ‰åˆ†ç‰‡ï¼ˆæœ€æ–°æ•°æ®ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readAllShards</span><span class="hljs-params">(String baseKey)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; SHARD_COUNT; i++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">distributedKey</span> <span class="hljs-operator">=</span> baseKey + <span class="hljs-string">&quot;:&quot;</span> + i;<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(distributedKey);<br>                <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> value;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>å¯¹æ¯”è¡¨</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœ¬åœ°ç¼“å­˜</td>
<td>å“åº”å¿«ï¼Œå‡è½»Rediså‹åŠ›</td>
<td>æ•°æ®ä¸ä¸€è‡´ï¼Œå†…å­˜å ç”¨å¤§</td>
<td>è¯»å¤šå†™å°‘ï¼Œä¸€è‡´æ€§è¦æ±‚ä¸é«˜</td>
</tr>
<tr>
<td>Keyåˆ†æ•£</td>
<td>è´Ÿè½½å‡è¡¡ï¼Œæ— å•ç‚¹</td>
<td>è¯»å–å¤æ‚ï¼Œå¯èƒ½è¯»åˆ°æ—§æ•°æ®</td>
<td>å†™å¤šè¯»å°‘ï¼Œå¯æ¥å—æœ€ç»ˆä¸€è‡´</td>
</tr>
<tr>
<td>è¯»å†™åˆ†ç¦»</td>
<td>è¯»å†™åˆ†ç¦»ï¼Œæ€§èƒ½å¥½</td>
<td>æ¶æ„å¤æ‚ï¼Œä¸»ä»å»¶è¿Ÿ</td>
<td>è¯»å¤šå†™å°‘ï¼Œå¯æ¥å—å»¶è¿Ÿ</td>
</tr>
</tbody>
</table>
<h3 id="åäºŒ-å¤§-key-é—®é¢˜ä¸æ²»ç†">åäºŒã€å¤§ Key é—®é¢˜ä¸æ²»ç†</h3>
<h4 id="å¤§-key-çš„å®šä¹‰">å¤§ Key çš„å®šä¹‰</h4>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>å¤§ Key å®šä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>å€¼å¤§å° &gt; 10KB</td>
</tr>
<tr>
<td>Hash</td>
<td>å­—æ®µæ•° &gt; 5000</td>
</tr>
<tr>
<td>List</td>
<td>å…ƒç´ æ•° &gt; 5000</td>
</tr>
<tr>
<td>Set</td>
<td>å…ƒç´ æ•° &gt; 5000</td>
</tr>
<tr>
<td>Sorted Set</td>
<td>å…ƒç´ æ•° &gt; 5000</td>
</tr>
</tbody>
</table>
<h4 id="å¤§-key-çš„å±å®³">å¤§ Key çš„å±å®³</h4>
<ul>
<li><strong>ç½‘ç»œå¸¦å®½</strong>ï¼šå¤§ Key ä¼ è¾“å ç”¨å¤§é‡å¸¦å®½ï¼Œå½±å“å…¶ä»–è¯·æ±‚</li>
<li><strong>å†…å­˜ç¢ç‰‡</strong>ï¼šå¤§ Key ç”³è¯·å¤§å—å†…å­˜ï¼Œéš¾ä»¥é‡ç”¨ï¼Œå¯¼è‡´ç¢ç‰‡</li>
<li><strong>æ…¢æŸ¥è¯¢</strong>ï¼šå¤§ Key æ“ä½œè€—æ—¶ï¼Œé˜»å¡å…¶ä»–è¯·æ±‚</li>
<li><strong>ä¸»ä»åŒæ­¥å»¶è¿Ÿ</strong>ï¼šå¤§ Key åŒæ­¥åˆ°ä»èŠ‚ç‚¹æ…¢ï¼Œå¯¼è‡´ä¸»ä»å»¶è¿Ÿ</li>
<li><strong>é˜»å¡é£é™©</strong>ï¼šDELã€HDEL ç­‰å‘½ä»¤å¯èƒ½é˜»å¡ Redis</li>
</ul>
<h4 id="å‘ç°æ‰‹æ®µ">å‘ç°æ‰‹æ®µ</h4>
<h5 id="redis-cli-bigkeys">redis-cli --bigkeys</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">redis-cli --bigkeys<br><br><span class="hljs-comment"># è¾“å‡ºç¤ºä¾‹ï¼š</span><br><span class="hljs-comment"># -------- summary -------</span><br><span class="hljs-comment"># Sampled 1024 keys in the keyspace!</span><br><span class="hljs-comment"># Total key length in bytes is 123456 (avg len 120.56)</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># Biggest string found &#x27;big_key&#x27; has 102400 bytes</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># 1024 strings with 123456 bytes (100.00% of keys, avg size 120.56)</span><br><span class="hljs-comment"># 0 lists with 0 bytes (00.00% of keys, avg size 0.00)</span><br><span class="hljs-comment"># 0 sets with 0 bytes (00.00% of keys, avg size 0.00)</span><br><span class="hljs-comment"># 0 hashs with 0 bytes (00.00% of keys, avg size 0.00)</span><br><span class="hljs-comment"># 0 zsets with 0 bytes (00.00% of keys, avg size 0.00)</span><br></code></pre></td></tr></table></figure>
<h5 id="memory-usage">memory usage</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigKeyAnalyzer</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">analyzeKeySize</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> jedis.type(key);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> jedis.memoryUsage(key);<br>            <br>            System.out.println(<span class="hljs-string">&quot;Key: &quot;</span> + key);<br>            System.out.println(<span class="hljs-string">&quot;Type: &quot;</span> + type);<br>            System.out.println(<span class="hljs-string">&quot;Memory: &quot;</span> + memory + <span class="hljs-string">&quot; bytes (&quot;</span> + memory / <span class="hljs-number">1024</span> + <span class="hljs-string">&quot; KB)&quot;</span>);<br>            <br>            <span class="hljs-keyword">switch</span> (type) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;string&quot;</span>:<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> jedis.strlen(key);<br>                    System.out.println(<span class="hljs-string">&quot;Length: &quot;</span> + len);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hash&quot;</span>:<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">hlen</span> <span class="hljs-operator">=</span> jedis.hlen(key);<br>                    System.out.println(<span class="hljs-string">&quot;Hash fields: &quot;</span> + hlen);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;list&quot;</span>:<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">llen</span> <span class="hljs-operator">=</span> jedis.llen(key);<br>                    System.out.println(<span class="hljs-string">&quot;List elements: &quot;</span> + llen);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;set&quot;</span>:<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">scard</span> <span class="hljs-operator">=</span> jedis.scard(key);<br>                    System.out.println(<span class="hljs-string">&quot;Set members: &quot;</span> + scard);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;zset&quot;</span>:<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">zcard</span> <span class="hljs-operator">=</span> jedis.zcard(key);<br>                    System.out.println(<span class="hljs-string">&quot;Sorted set members: &quot;</span> + zcard);<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="æ²»ç†æ–¹æ¡ˆ">æ²»ç†æ–¹æ¡ˆ</h4>
<h5 id="æ‹†åˆ†å¤§-key">æ‹†åˆ†å¤§ Key</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigKeySplitService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_HASH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‹†åˆ†å¤§ Hash</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">splitBigHash</span><span class="hljs-params">(String bigKey)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            Map&lt;String, String&gt; bigHash = jedis.hgetAll(bigKey);<br>            <br>            <span class="hljs-keyword">if</span> (bigHash.size() &lt;= MAX_HASH_SIZE) &#123;<br>                <span class="hljs-keyword">return</span>; <span class="hljs-comment">// ä¸éœ€è¦æ‹†åˆ†</span><br>            &#125;<br>            <br>            <span class="hljs-comment">// æ‹†åˆ†æˆå¤šä¸ªå° Hash</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            Map&lt;String, String&gt; shard = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            <br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : bigHash.entrySet()) &#123;<br>                shard.put(entry.getKey(), entry.getValue());<br>                <br>                <span class="hljs-keyword">if</span> (shard.size() &gt;= MAX_HASH_SIZE) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">shardKey</span> <span class="hljs-operator">=</span> bigKey + <span class="hljs-string">&quot;:&quot;</span> + shardIndex;<br>                    jedis.hmset(shardKey, shard);<br>                    shard.clear();<br>                    shardIndex++;<br>                &#125;<br>            &#125;<br>            <br>            <span class="hljs-comment">// å¤„ç†å‰©ä½™æ•°æ®</span><br>            <span class="hljs-keyword">if</span> (!shard.isEmpty()) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">shardKey</span> <span class="hljs-operator">=</span> bigKey + <span class="hljs-string">&quot;:&quot;</span> + shardIndex;<br>                jedis.hmset(shardKey, shard);<br>            &#125;<br>            <br>            <span class="hljs-comment">// åˆ é™¤åŸå§‹å¤§ Key</span><br>            jedis.del(bigKey);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»æ‹†åˆ†åçš„ Hash ä¸­è¯»å–</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">getFromSplitHash</span><span class="hljs-params">(String baseKey, String field)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// è®¡ç®—å­—æ®µæ‰€åœ¨çš„åˆ†ç‰‡</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> Math.abs(field.hashCode()) % <span class="hljs-number">10</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">shardKey</span> <span class="hljs-operator">=</span> baseKey + <span class="hljs-string">&quot;:&quot;</span> + shardIndex;<br>            <br>            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.hget(shardKey, field);<br>            <br>            Map&lt;String, String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            result.put(field, value);<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="å¼‚æ­¥åˆ é™¤-unlink">å¼‚æ­¥åˆ é™¤ï¼ˆUNLINKï¼‰</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncDeleteService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä½¿ç”¨ UNLINK å¼‚æ­¥åˆ é™¤å¤§ Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncDelete</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// UNLINK æ˜¯ DEL çš„å¼‚æ­¥ç‰ˆæœ¬ï¼Œä¸ä¼šé˜»å¡ Redis</span><br>            jedis.unlink(key);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‰¹é‡å¼‚æ­¥åˆ é™¤</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchAsyncDelete</span><span class="hljs-params">(String pattern)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// ä½¿ç”¨ SCAN éå†åŒ¹é…çš„ key</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0&quot;</span>;<br>            <br>            <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-type">var</span> <span class="hljs-variable">scanResult</span> <span class="hljs-operator">=</span> jedis.scan(cursor);<br>                cursor = scanResult.getCursor();<br>                <br>                <span class="hljs-keyword">for</span> (String key : scanResult.getResult()) &#123;<br>                    jedis.unlink(key);<br>                &#125;<br>                <br>            &#125; <span class="hljs-keyword">while</span> (!cursor.equals(<span class="hljs-string">&quot;0&quot;</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="å‹ç¼©å­˜å‚¨">å‹ç¼©å­˜å‚¨</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.zip.Deflater;<br><span class="hljs-keyword">import</span> java.util.zip.Inflater;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompressedCacheService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å‹ç¼©å­˜å‚¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCompressed</span><span class="hljs-params">(String key, String value)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">byte</span>[] compressed = compress(value);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">encoded</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(compressed);<br>            <br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>                jedis.setex(key, <span class="hljs-number">3600</span>, encoded);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;å‹ç¼©å¤±è´¥&quot;</span>, e);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§£å‹ç¼©è¯»å–</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCompressed</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">encoded</span> <span class="hljs-operator">=</span> jedis.get(key);<br>            <span class="hljs-keyword">if</span> (encoded == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <br>            <span class="hljs-type">byte</span>[] compressed = Base64.getDecoder().decode(encoded);<br>            <span class="hljs-keyword">return</span> decompress(compressed);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;è§£å‹ç¼©å¤±è´¥&quot;</span>, e);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] compress(String data) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Deflater</span> <span class="hljs-variable">deflater</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Deflater</span>();<br>        deflater.setInput(data.getBytes());<br>        deflater.finish();<br>        <br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length()];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">compressedSize</span> <span class="hljs-operator">=</span> deflater.deflate(buffer);<br>        deflater.end();<br>        <br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[compressedSize];<br>        System.arraycopy(buffer, <span class="hljs-number">0</span>, result, <span class="hljs-number">0</span>, compressedSize);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">decompress</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Inflater</span> <span class="hljs-variable">inflater</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Inflater</span>();<br>        inflater.setInput(data);<br>        <br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length * <span class="hljs-number">10</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">resultSize</span> <span class="hljs-operator">=</span> inflater.inflate(buffer);<br>        inflater.end();<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer, <span class="hljs-number">0</span>, resultSize);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="åä¸‰-å¤šçº§ç¼“å­˜æ¶æ„å®æˆ˜">åä¸‰ã€å¤šçº§ç¼“å­˜æ¶æ„å®æˆ˜</h3>
<h4 id="ç»å…¸ä¸‰çº§æ¶æ„">ç»å…¸ä¸‰çº§æ¶æ„</h4>
<pre><code class="hljs mermaid">graph TB
    A[ç”¨æˆ·è¯·æ±‚] --&gt; B[Nginx Lua]
    B --&gt;|L1 Cache| C&#123;å‘½ä¸­?&#125;
    C --&gt;|æ˜¯| D[è¿”å›æ•°æ®]
    C --&gt;|å¦| E[æœ¬åœ°ç¼“å­˜ Caffeine]
    E --&gt;|L2 Cache| F&#123;å‘½ä¸­?&#125;
    F --&gt;|æ˜¯| D
    F --&gt;|å¦| G[Redis]
    G --&gt;|L3 Cache| H&#123;å‘½ä¸­?&#125;
    H --&gt;|æ˜¯| D
    H --&gt;|å¦| I[æ•°æ®åº“]
    I --&gt;|å›æº| G
    G --&gt;|å›æº| E
    E --&gt;|å›æº| B</code></pre>
<h4 id="openresty-lua-å®ç°æ¥å…¥å±‚ç¼“å­˜">OpenResty + Lua å®ç°æ¥å…¥å±‚ç¼“å­˜</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ngx_shared_dict å®šä¹‰åœ¨ nginx.conf ä¸­</span><br><span class="hljs-keyword">local</span> cache = ngx.shared.my_cache<br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_from_cache</span><span class="hljs-params">(key)</span></span><br>    <span class="hljs-keyword">local</span> cached_data = cache:get(key)<br>    <span class="hljs-keyword">if</span> cached_data <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> cached_data<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_to_cache</span><span class="hljs-params">(key, value, ttl)</span></span><br>    <span class="hljs-keyword">local</span> success, err = cache:set(key, value, ttl)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> success <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;failed to set cache: &quot;</span>, err)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch_from_upstream</span><span class="hljs-params">(key)</span></span><br>    <span class="hljs-keyword">local</span> http = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;resty.http&quot;</span><br>    <span class="hljs-keyword">local</span> httpc = http.new()<br>    <br>    <span class="hljs-keyword">local</span> res, err = httpc:request_uri(<span class="hljs-string">&quot;http://backend/api/data/&quot;</span> .. key, &#123;<br>        method = <span class="hljs-string">&quot;GET&quot;</span>,<br>        timeout = <span class="hljs-number">5000</span><br>    &#125;)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> res <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    <span class="hljs-keyword">end</span><br>    <br>    <span class="hljs-keyword">return</span> res.body<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> key = ngx.var.arg_key <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;default&quot;</span><br><span class="hljs-keyword">local</span> cached_data = get_from_cache(key)<br><br><span class="hljs-keyword">if</span> cached_data <span class="hljs-keyword">then</span><br>    ngx.say(cached_data)<br>    ngx.<span class="hljs-built_in">log</span>(ngx.INFO, <span class="hljs-string">&quot;cache hit for key: &quot;</span>, key)<br><span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">local</span> data, err = fetch_from_upstream(key)<br>    <span class="hljs-keyword">if</span> data <span class="hljs-keyword">then</span><br>        set_to_cache(key, data, <span class="hljs-number">300</span>) <span class="hljs-comment">-- ç¼“å­˜5åˆ†é’Ÿ</span><br>        ngx.say(data)<br>        ngx.<span class="hljs-built_in">log</span>(ngx.INFO, <span class="hljs-string">&quot;cache miss, fetched from upstream&quot;</span>)<br>    <span class="hljs-keyword">else</span><br>        ngx.<span class="hljs-built_in">status</span> = <span class="hljs-number">500</span><br>        ngx.say(<span class="hljs-string">&quot;failed to fetch data&quot;</span>)<br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;failed to fetch from upstream: &quot;</span>, err)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<h4 id="jetcache-æ¡†æ¶">JetCache æ¡†æ¶</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alicp.jetcache.Cache;<br><span class="hljs-keyword">import</span> com.alicp.jetcache.anno.CacheType;<br><span class="hljs-keyword">import</span> com.alicp.jetcache.anno.CacheInvalidate;<br><span class="hljs-keyword">import</span> com.alicp.jetcache.anno.CachePut;<br><span class="hljs-keyword">import</span> com.alicp.jetcache.anno.CacheRefresh;<br><span class="hljs-keyword">import</span> com.alicp.jetcache.anno.Cached;<br><span class="hljs-keyword">import</span> com.alicp.jetcache.anno.CreateCache;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JetCacheUserService</span> &#123;<br>    <br>    <span class="hljs-comment">// åˆ›å»ºä¸¤çº§ç¼“å­˜</span><br>    <span class="hljs-meta">@CreateCache(name = &quot;userCache&quot;, expire = 3600, cacheType = CacheType.BOTH, localLimit = 1000)</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, User&gt; userCache;<br>    <br>    <span class="hljs-meta">@Cached(name = &quot;userCache:&quot;, key = &quot;#userId&quot;, expire = 3600)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long userId)</span> &#123;<br>        <span class="hljs-comment">// ä»æ•°æ®åº“åŠ è½½</span><br>        <span class="hljs-keyword">return</span> userRepository.findById(userId);<br>    &#125;<br>    <br>    <span class="hljs-meta">@CachePut(name = &quot;userCache:&quot;, key = &quot;#user.id&quot;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.save(user);<br>    &#125;<br>    <br>    <span class="hljs-meta">@CacheInvalidate(name = &quot;userCache:&quot;, key = &quot;#userId&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long userId)</span> &#123;<br>        userRepository.deleteById(userId);<br>    &#125;<br>    <br>    <span class="hljs-comment">// å®šæ—¶åˆ·æ–°çƒ­ç‚¹æ•°æ®</span><br>    <span class="hljs-meta">@Cached(name = &quot;userCache:&quot;, key = &quot;#userId&quot;, expire = 3600, cacheRefreshInterval = 60)</span><br>    <span class="hljs-meta">@CacheRefresh(refreshInterval = 60, stopRefreshAfterLastAccess = 3600)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getHotUserById</span><span class="hljs-params">(Long userId)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findById(userId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="å¤šçº§ç¼“å­˜çš„ä¸€è‡´æ€§æŒ‘æˆ˜">å¤šçº§ç¼“å­˜çš„ä¸€è‡´æ€§æŒ‘æˆ˜</h4>
<p><strong>å¹¿æ’­å¤±æ•ˆæ–¹æ¡ˆ</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.listener.ChannelTopic;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.listener.adapter.MessageListenerAdapter;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheInvalidationService</span> &#123;<br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;<br>    <span class="hljs-keyword">private</span> RedisMessageListenerContainer listenerContainer;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å‘å¸ƒç¼“å­˜å¤±æ•ˆæ¶ˆæ¯</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishInvalidation</span><span class="hljs-params">(String cacheKey)</span> &#123;<br>        redisTemplate.convertAndSend(<span class="hljs-string">&quot;cache:invalidation&quot;</span>, cacheKey);<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è®¢é˜…ç¼“å­˜å¤±æ•ˆæ¶ˆæ¯</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribeInvalidation</span><span class="hljs-params">(List&lt;String&gt; localCacheKeys)</span> &#123;<br>        <span class="hljs-type">MessageListenerAdapter</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerAdapter</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheInvalidationListener</span>(localCacheKeys)<br>        );<br>        <br>        listenerContainer.addMessageListener(listener, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelTopic</span>(<span class="hljs-string">&quot;cache:invalidation&quot;</span>));<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheInvalidationListener</span> &#123;<br>        <span class="hljs-keyword">private</span> List&lt;String&gt; localCacheKeys;<br>        <br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheInvalidationListener</span><span class="hljs-params">(List&lt;String&gt; localCacheKeys)</span> &#123;<br>            <span class="hljs-built_in">this</span>.localCacheKeys = localCacheKeys;<br>        &#125;<br>        <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(String message)</span> &#123;<br>            <span class="hljs-comment">// åˆ é™¤æœ¬åœ°ç¼“å­˜</span><br>            localCacheKeys.remove(message);<br>            System.out.println(<span class="hljs-string">&quot;Local cache invalidated: &quot;</span> + message);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ç¼“å­˜é¢„çƒ­ç­–ç•¥">ç¼“å­˜é¢„çƒ­ç­–ç•¥</h4>
<table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…¨é‡é¢„çƒ­</td>
<td>å¯åŠ¨åç«‹å³å¯ç”¨</td>
<td>è€—æ—¶é•¿ï¼Œå ç”¨èµ„æº</td>
<td>æ•°æ®é‡å°ï¼Œå¯åŠ¨æ—¶é—´ä¸æ•æ„Ÿ</td>
</tr>
<tr>
<td>å¢é‡é¢„çƒ­</td>
<td>å¿«é€Ÿå¯åŠ¨</td>
<td>å¯èƒ½ç¼“å­˜ç©¿é€</td>
<td>æ•°æ®é‡å¤§ï¼Œå¯æ¥å—æ¸è¿›å¼åŠ è½½</td>
</tr>
<tr>
<td>æ‡’åŠ è½½</td>
<td>æ— éœ€é¢„çƒ­</td>
<td>é¦–æ¬¡è®¿é—®æ…¢</td>
<td>æ•°æ®é‡å¤§ï¼Œè®¿é—®æ¨¡å¼ä¸ç¡®å®š</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Cache;<br><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheWarmupService</span> &#123;<br>    <span class="hljs-keyword">private</span> Cache&lt;String, String&gt; cache;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheWarmupService</span><span class="hljs-params">()</span> &#123;<br>        cache = Caffeine.newBuilder()<br>            .maximumSize(<span class="hljs-number">10000</span>)<br>            .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)<br>            .build();<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å…¨é‡é¢„çƒ­</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fullWarmup</span><span class="hljs-params">()</span> &#123;<br>        List&lt;String&gt; hotKeys = getHotKeysFromDatabase();<br>        <br>        hotKeys.parallelStream().forEach(key -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> loadFromDatabase(key);<br>            cache.put(key, value);<br>        &#125;);<br>        <br>        System.out.println(<span class="hljs-string">&quot;Full warmup completed, &quot;</span> + hotKeys.size() + <span class="hljs-string">&quot; keys loaded&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¢é‡é¢„çƒ­ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Scheduled(fixedDelay = 300000)</span> <span class="hljs-comment">// æ¯5åˆ†é’Ÿ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incrementalWarmup</span><span class="hljs-params">()</span> &#123;<br>        List&lt;String&gt; recentlyAccessedKeys = getRecentlyAccessedKeys();<br>        <br>        recentlyAccessedKeys.forEach(key -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (cache.getIfPresent(key) == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> loadFromDatabase(key);<br>                cache.put(key, value);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">getHotKeysFromDatabase</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// ä»æ•°æ®åº“è·å–çƒ­ç‚¹ key</span><br>        <span class="hljs-keyword">return</span> List.of(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-string">&quot;key3&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">getRecentlyAccessedKeys</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// è·å–æœ€è¿‘è®¿é—®çš„ key</span><br>        <span class="hljs-keyword">return</span> List.of(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;key4&quot;</span>, <span class="hljs-string">&quot;key5&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">loadFromDatabase</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-comment">// ä»æ•°æ®åº“åŠ è½½æ•°æ®</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;value_for_&quot;</span> + key;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="åå››-redis-é›†ç¾¤æ¨¡å¼ä¸‹çš„ç¼“å­˜è®¾è®¡">åå››ã€Redis é›†ç¾¤æ¨¡å¼ä¸‹çš„ç¼“å­˜è®¾è®¡</h3>
<h4 id="redis-cluster-çš„æ•°æ®åˆ†ç‰‡">Redis Cluster çš„æ•°æ®åˆ†ç‰‡</h4>
<p>Redis Cluster ä½¿ç”¨ <strong>CRC16</strong> ç®—æ³•å¯¹ key è¿›è¡Œå“ˆå¸Œï¼Œè®¡ç®—ç»“æœå¯¹ <strong>16384</strong> å–æ¨¡ï¼Œç¡®å®š key æ‰€åœ¨çš„ slotã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.ClusterCRC16;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClusterSlotCalculator</span> &#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è®¡ç®— key æ‰€åœ¨çš„ slot</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateSlot</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-comment">// æå– hash tagï¼ˆå¦‚æœæœ‰ï¼‰</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">hashTag</span> <span class="hljs-operator">=</span> extractHashTag(key);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">keyToHash</span> <span class="hljs-operator">=</span> hashTag != <span class="hljs-literal">null</span> ? hashTag : key;<br>        <br>        <span class="hljs-comment">// ä½¿ç”¨ CRC16 è®¡ç®—</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">slot</span> <span class="hljs-operator">=</span> ClusterCRC16.getSlot(keyToHash);<br>        <span class="hljs-keyword">return</span> slot;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æå– hash tag</span><br><span class="hljs-comment">     * ä¾‹å¦‚ï¼š&#123;user&#125;:profile -&gt; user</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">extractHashTag</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> key.indexOf(<span class="hljs-string">&#x27;&#123;&#x27;</span>);<br>        <span class="hljs-keyword">if</span> (start == -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <br>        <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> key.indexOf(<span class="hljs-string">&#x27;&#125;&#x27;</span>, start);<br>        <span class="hljs-keyword">if</span> (end == -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> key.substring(start + <span class="hljs-number">1</span>, end);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:1001:profile&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;user:1001&#125;:profile&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;user:1001&#125;:orders&quot;</span>;<br>        <br>        System.out.println(<span class="hljs-string">&quot;Slot for &quot;</span> + key1 + <span class="hljs-string">&quot;: &quot;</span> + calculateSlot(key1));<br>        System.out.println(<span class="hljs-string">&quot;Slot for &quot;</span> + key2 + <span class="hljs-string">&quot;: &quot;</span> + calculateSlot(key2));<br>        System.out.println(<span class="hljs-string">&quot;Slot for &quot;</span> + key3 + <span class="hljs-string">&quot;: &quot;</span> + calculateSlot(key3));<br>        <br>        <span class="hljs-comment">// key2 å’Œ key3 ä½¿ç”¨ç›¸åŒçš„ hash tagï¼Œä¼šåœ¨åŒä¸€ä¸ª slot</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="è·¨-slot-æ“ä½œçš„é™åˆ¶">è·¨ slot æ“ä½œçš„é™åˆ¶</h4>
<p>åœ¨ Redis Cluster ä¸­ï¼Œ<strong>ä¸æ”¯æŒè·¨ slot çš„å¤š key æ“ä½œ</strong>ï¼Œå¦‚ <code>MGET</code>ã€<code>MSET</code>ã€<code>SUNION</code> ç­‰ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ol>
<li><strong>ä½¿ç”¨ HashTag</strong>ï¼šç¡®ä¿ç›¸å…³ key åœ¨åŒä¸€ä¸ª slot</li>
<li><strong>å®¢æˆ·ç«¯åˆ†ç‰‡</strong>ï¼šåœ¨å®¢æˆ·ç«¯æŒ‰ slot åˆ†ç»„ï¼Œæ‰¹é‡æ‰§è¡Œ</li>
<li><strong>ä½¿ç”¨ Hash ç»“æ„</strong>ï¼šå°†ç›¸å…³æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ª Hash ä¸­</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.JedisCluster;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClusterMultiKeyService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisCluster jedisCluster;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ–¹æ¡ˆ1ï¼šä½¿ç”¨ HashTag</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithHashTag</span><span class="hljs-params">(String userId, String profile, String orders)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">profileKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;user:&quot;</span> + userId + <span class="hljs-string">&quot;&#125;:profile&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ordersKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;user:&quot;</span> + userId + <span class="hljs-string">&quot;&#125;:orders&quot;</span>;<br>        <br>        jedisCluster.set(profileKey, profile);<br>        jedisCluster.set(ordersKey, orders);<br>        <br>        <span class="hljs-comment">// è¿™ä¸¤ä¸ª key åœ¨åŒä¸€ä¸ª slotï¼Œå¯ä»¥ä½¿ç”¨ MGET</span><br>        List&lt;String&gt; values = jedisCluster.mget(profileKey, ordersKey);<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ–¹æ¡ˆ2ï¼šå®¢æˆ·ç«¯åˆ†ç‰‡æ‰§è¡Œ MGET</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">smartMget</span><span class="hljs-params">(List&lt;String&gt; keys)</span> &#123;<br>        <span class="hljs-comment">// æŒ‰ slot åˆ†ç»„</span><br>        Map&lt;Integer, List&lt;String&gt;&gt; slotGroups = keys.stream()<br>            .collect(Collectors.groupingBy(RedisClusterSlotCalculator::calculateSlot));<br>        <br>        Map&lt;String, String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <br>        <span class="hljs-comment">// æ¯ä¸ª slot å•ç‹¬æ‰§è¡Œ MGET</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, List&lt;String&gt;&gt; entry : slotGroups.entrySet()) &#123;<br>            List&lt;String&gt; slotKeys = entry.getValue();<br>            List&lt;String&gt; values = jedisCluster.mget(slotKeys.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]));<br>            <br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; slotKeys.size(); i++) &#123;<br>                result.put(slotKeys.get(i), values.get(i));<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ–¹æ¡ˆ3ï¼šä½¿ç”¨ Hash ç»“æ„</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAsHash</span><span class="hljs-params">(String userId, Map&lt;String, String&gt; fields)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hashKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + userId;<br>        <br>        Map&lt;String, String&gt; hashData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashData.put(<span class="hljs-string">&quot;profile&quot;</span>, fields.get(<span class="hljs-string">&quot;profile&quot;</span>));<br>        hashData.put(<span class="hljs-string">&quot;orders&quot;</span>, fields.get(<span class="hljs-string">&quot;orders&quot;</span>));<br>        hashData.put(<span class="hljs-string">&quot;preferences&quot;</span>, fields.get(<span class="hljs-string">&quot;preferences&quot;</span>));<br>        <br>        jedisCluster.hmset(hashKey, hashData);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">getAsHash</span><span class="hljs-params">(String userId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hashKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:&quot;</span> + userId;<br>        <span class="hljs-keyword">return</span> jedisCluster.hgetAll(hashKey);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="hashtag-çš„ä½¿ç”¨">HashTag çš„ä½¿ç”¨</h4>
<p><strong>åœºæ™¯</strong>ï¼šéœ€è¦åŸå­æ“ä½œå¤šä¸ªç›¸å…³çš„ keyï¼Œå¦‚ç”¨æˆ·èµ„æ–™å’Œè®¢å•ã€‚</p>
<pre><code class="hljs mermaid">graph LR
    A[ç”¨æˆ·è¯·æ±‚] --&gt; B&#123;HashTag?&#125;
    B --&gt;|æ˜¯| C[è®¡ç®— hash tag å€¼]
    B --&gt;|å¦| D[è®¡ç®— key å€¼]
    C --&gt; E[CRC16 å“ˆå¸Œ]
    D --&gt; E
    E --&gt; F[å–æ¨¡ 16384]
    F --&gt; G[ç¡®å®š slot]
    G --&gt; H[è·¯ç”±åˆ°å¯¹åº”èŠ‚ç‚¹]</code></pre>
<p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p>
<ul>
<li>åªåœ¨éœ€è¦å¤š key åŸå­æ“ä½œæ—¶ä½¿ç”¨ HashTag</li>
<li>HashTag ä¼šç ´åæ•°æ®åˆ†å¸ƒå‡åŒ€æ€§ï¼Œä¸è¦æ»¥ç”¨</li>
<li>HashTag åº”è¯¥æ˜¯ä¸šåŠ¡ç›¸å…³çš„æ ‡è¯†ï¼Œå¦‚ç”¨æˆ· IDã€è®¢å• ID</li>
</ul>
<h4 id="é›†ç¾¤æ‰©ç¼©å®¹å¯¹ç¼“å­˜çš„å½±å“">é›†ç¾¤æ‰©ç¼©å®¹å¯¹ç¼“å­˜çš„å½±å“</h4>
<p><strong>Slot è¿ç§»è¿‡ç¨‹</strong>ï¼š</p>
<pre><code class="hljs mermaid">sequenceDiagram
    participant Client
    participant SourceNode
    participant TargetNode
    participant MigrateTool
    
    Client-&gt;&gt;SourceNode: è¯»å†™ keyï¼ˆslot 1000ï¼‰
    MigrateTool-&gt;&gt;SourceNode: å¼€å§‹è¿ç§» slot 1000
    SourceNode-&gt;&gt;TargetNode: è¿ç§»æ•°æ®
    SourceNode-&gt;&gt;Client: è¿”å› ASK é‡å®šå‘
    Client-&gt;&gt;TargetNode: å‘é€ ASKING å‘½ä»¤
    Client-&gt;&gt;TargetNode: è¯»å†™ key
    MigrateTool-&gt;&gt;SourceNode: è¿ç§»å®Œæˆ
    MigrateTool-&gt;&gt;TargetNode: slot 1000 å½’å±æ›´æ–°
    Client-&gt;&gt;TargetNode: æ­£å¸¸è¯»å†™</code></pre>
<p><strong>åº”å¯¹ç­–ç•¥</strong>ï¼š</p>
<ol>
<li><strong>è¿ç§»æœŸé—´</strong>ï¼šå®¢æˆ·ç«¯æ”¯æŒ ASK é‡å®šå‘</li>
<li><strong>ç¼“å­˜é¢„çƒ­</strong>ï¼šè¿ç§»å®Œæˆåé¢„çƒ­æ–°èŠ‚ç‚¹</li>
<li><strong>ç›‘æ§</strong>ï¼šç›‘æ§è¿ç§»è¿›åº¦å’Œæ€§èƒ½æŒ‡æ ‡</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisAskDataException;<br><span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisMovedDataException;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisCluster;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClusterMigrationAwareClient</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisCluster jedisCluster;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getWithRetry</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">maxRetries</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxRetries; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> jedisCluster.get(key);<br>            &#125; <span class="hljs-keyword">catch</span> (JedisMovedDataException e) &#123;<br>                <span class="hljs-comment">// æ§½å·²æ°¸ä¹…è¿ç§»ï¼Œæ›´æ–°é›†ç¾¤æ‹“æ‰‘</span><br>                System.out.println(<span class="hljs-string">&quot;Slot moved, retrying...&quot;</span>);<br>                jedisCluster.renewSlotCache();<br>            &#125; <span class="hljs-keyword">catch</span> (JedisAskDataException e) &#123;<br>                <span class="hljs-comment">// æ§½æ­£åœ¨è¿ç§»ï¼Œå°è¯•ä»ç›®æ ‡èŠ‚ç‚¹è·å–</span><br>                System.out.println(<span class="hljs-string">&quot;Slot migrating, asking target node...&quot;</span>);<br>                <span class="hljs-comment">// JedisCluster ä¼šè‡ªåŠ¨å¤„ç† ASK é‡å®šå‘</span><br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Failed to get key after &quot;</span> + maxRetries + <span class="hljs-string">&quot; retries&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="redis-sentinel-vs-cluster-çš„é€‰å‹">Redis Sentinel vs Cluster çš„é€‰å‹</h4>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Redis Sentinel</th>
<th>Redis Cluster</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®åˆ†ç‰‡</td>
<td>å¦</td>
<td>æ˜¯ï¼ˆ16384 slotsï¼‰</td>
</tr>
<tr>
<td>æ°´å¹³æ‰©å±•</td>
<td>éœ€è¦å®¢æˆ·ç«¯åˆ†ç‰‡</td>
<td>åŸç”Ÿæ”¯æŒ</td>
</tr>
<tr>
<td>æœ€å¤§å†…å­˜</td>
<td>å•èŠ‚ç‚¹é™åˆ¶</td>
<td>é›†ç¾¤æ€»å†…å­˜</td>
</tr>
<tr>
<td>æ•…éšœè½¬ç§»</td>
<td>è‡ªåŠ¨</td>
<td>è‡ªåŠ¨</td>
</tr>
<tr>
<td>å¤æ‚åº¦</td>
<td>è¾ƒä½</td>
<td>è¾ƒé«˜</td>
</tr>
<tr>
<td>å¤š key æ“ä½œ</td>
<td>æ”¯æŒ</td>
<td>å—é™ï¼ˆéœ€ HashTagï¼‰</td>
</tr>
<tr>
<td>é€‚ç”¨åœºæ™¯</td>
<td>ä¸­å°è§„æ¨¡ï¼Œç®€å•æ¶æ„</td>
<td>å¤§è§„æ¨¡ï¼Œé«˜æ€§èƒ½éœ€æ±‚</td>
</tr>
</tbody>
</table>
<h3 id="åäº”-ç¼“å­˜çš„å®‰å…¨ä¸è¿ç»´">åäº”ã€ç¼“å­˜çš„å®‰å…¨ä¸è¿ç»´</h3>
<h4 id="ç¼“å­˜æ•°æ®å®‰å…¨">ç¼“å­˜æ•°æ®å®‰å…¨</h4>
<p><strong>æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> javax.crypto.Cipher;<br><span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecureCacheService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECRET_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;my-secret-key-123&quot;</span>; <span class="hljs-comment">// 16/24/32 bytes</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ALGORITHM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;AES&quot;</span>;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åŠ å¯†å­˜å‚¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSecure</span><span class="hljs-params">(String key, String sensitiveValue)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">encrypted</span> <span class="hljs-operator">=</span> encrypt(sensitiveValue);<br>            <br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>                jedis.setex(key, <span class="hljs-number">3600</span>, encrypted);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;åŠ å¯†å¤±è´¥&quot;</span>, e);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§£å¯†è¯»å–</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSecure</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">encrypted</span> <span class="hljs-operator">=</span> jedis.get(key);<br>            <span class="hljs-keyword">if</span> (encrypted == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <br>            <span class="hljs-keyword">return</span> decrypt(encrypted);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;è§£å¯†å¤±è´¥&quot;</span>, e);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String data)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(SECRET_KEY.getBytes(), ALGORITHM);<br>        <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(ALGORITHM);<br>        cipher.init(Cipher.ENCRYPT_MODE, keySpec);<br>        <br>        <span class="hljs-type">byte</span>[] encrypted = cipher.doFinal(data.getBytes());<br>        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(encrypted);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">decrypt</span><span class="hljs-params">(String encrypted)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(SECRET_KEY.getBytes(), ALGORITHM);<br>        <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(ALGORITHM);<br>        cipher.init(Cipher.DECRYPT_MODE, keySpec);<br>        <br>        <span class="hljs-type">byte</span>[] decoded = Base64.getDecoder().decode(encrypted);<br>        <span class="hljs-type">byte</span>[] decrypted = cipher.doFinal(decoded);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decrypted);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>TTL æ§åˆ¶æœ€ä½³å®è·µ</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TTLManagementService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è®¾ç½®ä¸åŒçš„ TTL ç­–ç•¥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithTTLStrategy</span><span class="hljs-params">(String key, String value, TTLStrategy strategy)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> strategy.getTTL();<br>            jedis.setex(key, ttl, value);<br>            <br>            <span class="hljs-comment">// è®°å½• TTL è®¾ç½®æ—¥å¿—</span><br>            System.out.println(<span class="hljs-string">&quot;Set key &quot;</span> + key + <span class="hljs-string">&quot; with TTL: &quot;</span> + ttl + <span class="hljs-string">&quot;s, strategy: &quot;</span> + strategy);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TTLStrategy</span> &#123;<br>        SHORT(<span class="hljs-number">60</span>),           <span class="hljs-comment">// çŸ­æœŸç¼“å­˜ï¼š1åˆ†é’Ÿ</span><br>        MEDIUM(<span class="hljs-number">300</span>),         <span class="hljs-comment">// ä¸­æœŸç¼“å­˜ï¼š5åˆ†é’Ÿ</span><br>        LONG(<span class="hljs-number">3600</span>),          <span class="hljs-comment">// é•¿æœŸç¼“å­˜ï¼š1å°æ—¶</span><br>        VERY_LONG(<span class="hljs-number">86400</span>);    <span class="hljs-comment">// è¶…é•¿æœŸç¼“å­˜ï¼š1å¤©</span><br>        <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> seconds;<br>        <br>        TTLStrategy(<span class="hljs-type">int</span> seconds) &#123;<br>            <span class="hljs-built_in">this</span>.seconds = seconds;<br>        &#125;<br>        <br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTTL</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> seconds;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç›‘æ§å³å°†è¿‡æœŸçš„ key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorExpiringKeys</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// æŸ¥æ‰¾å³å°†åœ¨ 10 åˆ†é’Ÿå†…è¿‡æœŸçš„ key</span><br>            <span class="hljs-comment">// æ³¨æ„ï¼šRedis æ²¡æœ‰ç›´æ¥æŒ‰ TTL æŸ¥æ‰¾çš„å‘½ä»¤ï¼Œéœ€è¦ç»“åˆä¸šåŠ¡è®¾è®¡</span><br>            <br>            <span class="hljs-comment">// æ–¹æ¡ˆ1ï¼šä½¿ç”¨æœ‰åºé›†åˆè®°å½•è¿‡æœŸæ—¶é—´</span><br>            <span class="hljs-comment">// æ–¹æ¡ˆ2ï¼šå®šæœŸæ‰«æå¹¶æ£€æŸ¥ TTL</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ç¼“å­˜å®¹é‡å‘Šè­¦">ç¼“å­˜å®¹é‡å‘Šè­¦</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> redis.clients.jedis.info.Info;<br><span class="hljs-keyword">import</span> redis.clients.jedis.info.ServerInfo;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheMonitoringService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç›‘æ§ç¼“å­˜å®¹é‡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorCapacity</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// è·å–å†…å­˜ä½¿ç”¨ä¿¡æ¯</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> jedis.info(<span class="hljs-string">&quot;memory&quot;</span>);<br>            Map&lt;String, String&gt; memoryInfo = parseInfo(info);<br>            <br>            <span class="hljs-type">long</span> <span class="hljs-variable">usedMemory</span> <span class="hljs-operator">=</span> Long.parseLong(memoryInfo.get(<span class="hljs-string">&quot;used_memory&quot;</span>));<br>            <span class="hljs-type">long</span> <span class="hljs-variable">maxMemory</span> <span class="hljs-operator">=</span> Long.parseLong(memoryInfo.get(<span class="hljs-string">&quot;maxmemory&quot;</span>));<br>            <span class="hljs-type">double</span> <span class="hljs-variable">usagePercent</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) usedMemory / maxMemory * <span class="hljs-number">100</span>;<br>            <br>            System.out.println(<span class="hljs-string">&quot;Memory Usage: &quot;</span> + String.format(<span class="hljs-string">&quot;%.2f&quot;</span>, usagePercent) + <span class="hljs-string">&quot;%&quot;</span>);<br>            <br>            <span class="hljs-comment">// è·å–é©±é€ç»Ÿè®¡</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> jedis.info(<span class="hljs-string">&quot;stats&quot;</span>);<br>            Map&lt;String, String&gt; statsInfo = parseInfo(stats);<br>            <br>            <span class="hljs-type">long</span> <span class="hljs-variable">evictedKeys</span> <span class="hljs-operator">=</span> Long.parseLong(statsInfo.get(<span class="hljs-string">&quot;evicted_keys&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Evicted Keys: &quot;</span> + evictedKeys);<br>            <br>            <span class="hljs-comment">// å‘Šè­¦åˆ¤æ–­</span><br>            <span class="hljs-keyword">if</span> (usagePercent &gt; <span class="hljs-number">80</span>) &#123;<br>                sendAlert(<span class="hljs-string">&quot;å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: &quot;</span> + String.format(<span class="hljs-string">&quot;%.2f&quot;</span>, usagePercent) + <span class="hljs-string">&quot;%&quot;</span>);<br>            &#125;<br>            <br>            <span class="hljs-keyword">if</span> (evictedKeys &gt; <span class="hljs-number">1000</span>) &#123;<br>                sendAlert(<span class="hljs-string">&quot;é©±é€æ¬¡æ•°è¿‡å¤š: &quot;</span> + evictedKeys);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; <span class="hljs-title function_">parseInfo</span><span class="hljs-params">(String info)</span> &#123;<br>        Map&lt;String, String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        String[] lines = info.split(<span class="hljs-string">&quot;\r?\n&quot;</span>);<br>        <br>        <span class="hljs-keyword">for</span> (String line : lines) &#123;<br>            <span class="hljs-keyword">if</span> (line.contains(<span class="hljs-string">&quot;:&quot;</span>) &amp;&amp; !line.startsWith(<span class="hljs-string">&quot;#&quot;</span>)) &#123;<br>                String[] parts = line.split(<span class="hljs-string">&quot;:&quot;</span>);<br>                result.put(parts[<span class="hljs-number">0</span>], parts[<span class="hljs-number">1</span>]);<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendAlert</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-comment">// å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶ã€é’‰é’‰ã€çŸ­ä¿¡ç­‰ï¼‰</span><br>        System.out.println(<span class="hljs-string">&quot;ALERT: &quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="æ…¢æŸ¥è¯¢æ’æŸ¥">æ…¢æŸ¥è¯¢æ’æŸ¥</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SlowQueryAnalyzer</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">analyzeSlowQueries</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// è·å–æ…¢æŸ¥è¯¢åˆ—è¡¨ï¼ˆæœ€å¤š 10 æ¡ï¼‰</span><br>            <span class="hljs-type">var</span> <span class="hljs-variable">slowLog</span> <span class="hljs-operator">=</span> jedis.slowlogGet(<span class="hljs-number">10</span>);<br>            <br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> entry : slowLog) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> entry.getId();<br>                <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> entry.getTimeStamp();<br>                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> entry.getDuration(); <span class="hljs-comment">// å¾®ç§’</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> entry.getArguments().toString();<br>                <br>                System.out.println(<span class="hljs-string">&quot;Slow Query ID: &quot;</span> + id);<br>                System.out.println(<span class="hljs-string">&quot;Time: &quot;</span> + timestamp);<br>                System.out.println(<span class="hljs-string">&quot;Duration: &quot;</span> + duration + <span class="hljs-string">&quot; Î¼s&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;Command: &quot;</span> + command);<br>                System.out.println(<span class="hljs-string">&quot;---&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é…ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureSlowLog</span><span class="hljs-params">(<span class="hljs-type">long</span> thresholdMicros)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</span><br>            jedis.configSet(<span class="hljs-string">&quot;slowlog-log-slower-than&quot;</span>, String.valueOf(thresholdMicros));<br>            <br>            <span class="hljs-comment">// è®¾ç½®æ…¢æŸ¥è¯¢æ—¥å¿—æœ€å¤§é•¿åº¦</span><br>            jedis.configSet(<span class="hljs-string">&quot;slowlog-max-len&quot;</span>, <span class="hljs-string">&quot;128&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ç¼“å­˜ç¾å¤‡">ç¼“å­˜ç¾å¤‡</h4>
<p><strong>ä¸»ä»åˆ‡æ¢</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheFailoverService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool masterPool;<br>    <span class="hljs-keyword">private</span> JedisPool slavePool;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> JedisPool currentPool;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheFailoverService</span><span class="hljs-params">(JedisPool masterPool, JedisPool slavePool)</span> &#123;<br>        <span class="hljs-built_in">this</span>.masterPool = masterPool;<br>        <span class="hljs-built_in">this</span>.slavePool = slavePool;<br>        <span class="hljs-built_in">this</span>.currentPool = masterPool;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getWithFailover</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">maxRetries</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxRetries; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> getFromCurrentPool(key);<br>            &#125; <span class="hljs-keyword">catch</span> (JedisConnectionException e) &#123;<br>                System.out.println(<span class="hljs-string">&quot;Connection failed, switching pool...&quot;</span>);<br>                switchPool();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                System.out.println(<span class="hljs-string">&quot;Error getting key: &quot;</span> + e.getMessage());<br>                <span class="hljs-keyword">if</span> (i == maxRetries - <span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> e;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getFromCurrentPool</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> currentPool.getResource()) &#123;<br>            <span class="hljs-keyword">return</span> jedis.get(key);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">switchPool</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (currentPool == masterPool) &#123;<br>            currentPool = slavePool;<br>            System.out.println(<span class="hljs-string">&quot;Switched to slave pool&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            currentPool = masterPool;<br>            System.out.println(<span class="hljs-string">&quot;Switched to master pool&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>è·¨æœºæˆ¿å®¹ç¾æ¶æ„</strong>ï¼š</p>
<pre><code class="hljs mermaid">graph TB
    A[ç”¨æˆ·è¯·æ±‚] --&gt; B[è´Ÿè½½å‡è¡¡]
    B --&gt; C[æœºæˆ¿A - Redis Master]
    B --&gt; D[æœºæˆ¿B - Redis Slave]
    C --&gt;|åŒæ­¥| D
    C --&gt; E[æœºæˆ¿A - åº”ç”¨]
    D --&gt; F[æœºæˆ¿B - åº”ç”¨]
    C --&gt;|å¼‚æ­¥å¤åˆ¶| G[æœºæˆ¿C - å†·å¤‡]
    D --&gt;|å¼‚æ­¥å¤åˆ¶| G</code></pre>
<p><strong>å†·å¤‡æ¢å¤æ–¹æ¡ˆ</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheBackupRestoreService</span> &#123;<br>    <span class="hljs-keyword">private</span> JedisPool jedisPool;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åˆ›å»º RDB å¿«ç…§å¤‡ä»½</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createSnapshot</span><span class="hljs-params">(String backupPath)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) &#123;<br>            <span class="hljs-comment">// è§¦å‘ BGSAVE</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.bgsave();<br>            System.out.println(<span class="hljs-string">&quot;BGSAVE command sent: &quot;</span> + result);<br>            <br>            <span class="hljs-comment">// ç­‰å¾…å¤‡ä»½å®Œæˆ</span><br>            waitForBackupComplete(jedis);<br>            <br>            <span class="hljs-comment">// å¤åˆ¶ RDB æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•</span><br>            <span class="hljs-type">File</span> <span class="hljs-variable">rdbFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/var/lib/redis/dump.rdb&quot;</span>);<br>            <span class="hljs-type">File</span> <span class="hljs-variable">backupFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(backupPath + <span class="hljs-string">&quot;/dump_&quot;</span> + System.currentTimeMillis() + <span class="hljs-string">&quot;.rdb&quot;</span>);<br>            <br>            copyFile(rdbFile, backupFile);<br>            System.out.println(<span class="hljs-string">&quot;Backup created: &quot;</span> + backupFile.getAbsolutePath());<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">waitForBackupComplete</span><span class="hljs-params">(Jedis jedis)</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> jedis.info(<span class="hljs-string">&quot;persistence&quot;</span>);<br>            <span class="hljs-keyword">if</span> (info.contains(<span class="hljs-string">&quot;rdb_bgsave_in_progress:0&quot;</span>)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                Thread.currentThread().interrupt();<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">copyFile</span><span class="hljs-params">(File source, File dest)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(source);<br>             <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(dest)) &#123;<br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> length;<br>            <span class="hljs-keyword">while</span> ((length = fis.read(buffer)) &gt; <span class="hljs-number">0</span>) &#123;<br>                fos.write(buffer, <span class="hljs-number">0</span>, length);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»å¤‡ä»½æ¢å¤</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">restoreFromBackup</span><span class="hljs-params">(String backupPath)</span> &#123;<br>        <span class="hljs-comment">// æ³¨æ„ï¼šæ¢å¤éœ€è¦åœæœºï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒè°¨æ…æ“ä½œ</span><br>        System.out.println(<span class="hljs-string">&quot;Restore operation requires Redis restart&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;Steps:&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;1. Stop Redis server&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;2. Replace dump.rdb with backup file&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;3. Start Redis server&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å‚è€ƒæ–‡çŒ®ï¼š</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/guava-cache">ã€ŠGuava Cacheã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1058203">ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„ã€Šç¼“å­˜é‚£äº›äº‹ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39639130">ä¾‹å­å¾ˆå¤šï¼šã€Šcaffeine vs ehcacheã€‹</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://magicliang.github.io">magicliang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/">https://magicliang.github.io/2020/03/23/%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%97%E8%B7%AF/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">ç³»ç»Ÿæ¶æ„</a><a class="post-meta__tags" href="/tags/%E7%BC%93%E5%AD%98/">ç¼“å­˜</a><a class="post-meta__tags" href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD/">é«˜æ€§èƒ½</a></div><div class="post-share"><div class="social-share" data-image="/img/wall-paper-137.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2018/01/30/%E5%87%A0%E7%A7%8D%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95/" title="å‡ ç§å…±è¯†ç®—æ³•"><img class="cover" src="/img/wall-paper-17.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-01-30</div><div class="info-item-2">å‡ ç§å…±è¯†ç®—æ³•</div></div><div class="info-2"><div class="info-item-1">è¾¾æˆå…±è¯†çš„è‹±æ–‡åŸæ–‡æ˜¯ come to consensusã€‚è¾¾æˆå…±è¯†ä»¥åï¼Œä¹Ÿæœªå¿…ä»£è¡¨æ•°æ®æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼ˆRaft ç®—æ³•ä¸­ leader å‘å‡º append log çš„ commit å‘½ä»¤å³ç®—è¾¾æˆå…±è¯†ï¼Ÿä½†å¦‚æœä¸­é€”æ•°æ®ä¸¢å¤±ï¼Œåˆ™è¿˜æ˜¯ä¼šæœ‰å­èŠ‚ç‚¹æ•°æ®ä¸ä¸€è‡´ï¼‰ã€‚ åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¤šä¸ªç³»ç»ŸååŒå·¥ä½œçš„æ•ˆç‡ï¼Œå—åˆ¶äºç³»ç»Ÿäº¤å‰ç‚¹çš„æ€§èƒ½ã€‚åœ¨éœ€è¦è¾¾æˆåˆ†å¸ƒå¼å…±è¯†çš„åœºæ™¯ä¸‹ï¼Œåˆ†å¸ƒå¼å…±è¯†ç®—æ³•åœ¨ä¿è¯ç³»ç»Ÿå®‰å…¨æ€§çš„åŒæ—¶ï¼Œé™åˆ¶äº†å…¨ç³»ç»Ÿæ¨ªå‘æ‰©å±•çš„æ€§èƒ½æå‡ã€‚ æ ¹æ®ç¯å¢ƒçš„ä¸åŒï¼Œå¯ä»¥åº”ç”¨ä¸åŒçš„å…±è¯†ç®—æ³•ã€‚ åœ¨å®Œå…¨äº’ä¿¡çš„ç¯å¢ƒä¸‹-ç§æœ‰é“¾ã€ç§æœ‰çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯ä»¥ä½¿ç”¨ Paxos æˆ–è€… Raft è¿™ç§ leader ç›¸å¯¹å›ºå®šçš„ç®—æ³•ã€‚ åœ¨æœ‰é™äº’ä¿¡çš„ç¯å¢ƒä¸‹-è”ç›Ÿé“¾ï¼Œå¯ä»¥ä½¿ç”¨ PBFTã€‚PBFT ç®—æ³•æ˜¯ä¾æ®ç¡®å®šæ€§çš„æŠ•ç¥¨ï¼ˆå¯èƒ½æ˜¯æ¼«é•¿çš„æŠ•ç¥¨ï¼Œä¹Ÿå¯èƒ½è¿›å…¥æ­»å¾ªç¯ï¼‰è¾¾åˆ°ç¡®å®šæ€§ä¸€è‡´çš„ç®—æ³•ã€‚ åœ¨æ²¡æœ‰äº’ä¿¡çš„æƒ…å†µä¸‹-å…¬æœ‰é“¾ï¼Œå¯ä»¥ä½¿ç”¨ POW/POS/DPOS/POAã€‚è¿™ç±»ç®—æ³•æ˜¯åŸºäºæ¦‚ç‡å¾—åˆ°æ­£ç¡®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ€§èƒ½æ¯” PBFT è¦ç¨å¾®å¥½ç‚¹ã€‚ æœ€å¥½çš„å…±è¯†ç®—æ³•åº”è¯¥æ¨¡å—åŒ–ï¼Œä¾‹å¦‚ Corda ä¸­çš„ notaryï¼ŒHyperledger fabric ä¸­çš„ solo/k...</div></div></div></a><a class="pagination-related" href="/2018/04/02/%E4%B8%80%E4%B8%AA%E6%BB%9A%E5%8A%A8%E9%87%8D%E5%90%AF%E7%9A%84%E7%8A%B6%E6%80%81%E4%BF%9D%E5%AD%98%E9%97%AE%E9%A2%98/" title="ä¸€ä¸ªæ»šåŠ¨é‡å¯çš„çŠ¶æ€ä¿å­˜é—®é¢˜"><img class="cover" src="/img/wall-paper-116.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-02</div><div class="info-item-2">ä¸€ä¸ªæ»šåŠ¨é‡å¯çš„çŠ¶æ€ä¿å­˜é—®é¢˜</div></div><div class="info-2"><div class="info-item-1">å¾ˆå¤šæ—¶å€™æ»šåŠ¨é‡å¯ï¼Œéƒ½ä¼šå¯¼è‡´çŠ¶æ€ä¸¢å¤±ã€‚æ¯”è¾ƒå¥½çš„è®¾è®¡æ–¹æ³•æ˜¯æŠŠæœåŠ¡æœ¬èº«è®¾è®¡æˆæ— çŠ¶æ€çš„ï¼Œç„¶ååœ¨ä¸Šæ¸¸çš„æœåŠ¡ä¸Šåšå¥½ failoverï¼Œç„¶åå¢åŠ  standby serverï¼Œè®© sticky æ•°æ® transmit åˆ° standby æœºå™¨ä¸Šï¼Œè®© request å¤±è´¥ä»¥åå¯ä»¥è‡ªå·±ç”±ä¸Šæ¸¸é‡ä¼ åˆ° standby serverã€‚ç„¶åå°±å¯ä»¥æ»šåŠ¨é‡å¯äº†ã€‚ è¿™å¤§éƒ¨åˆ†åœºæ™¯ä¸‹è¿˜è¦è€ƒè™‘å¹‚ç­‰çš„é—®é¢˜ã€‚ è¿™å°±çœ‹å¾—å‡ºçƒ­é…ç½®çƒ­æ›¿æ¢çš„é‡è¦æ€§äº†ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé™¤äº†å‘å¸ƒæ–°çš„ feature å‡çº§ä»¥å¤–ï¼Œéƒ½åº”è¯¥å°½é‡ç”¨çƒ­é…ç½®æ¥é¿å…é‡å¯ã€‚ </div></div></div></a><a class="pagination-related" href="/2018/11/28/%E6%AD%A3%E4%BA%A4%E6%80%A7/" title="æ­£äº¤æ€§"><img class="cover" src="/img/wall-paper-52.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-28</div><div class="info-item-2">æ­£äº¤æ€§</div></div><div class="info-2"><div class="info-item-1">æ‰€è°“æ­£äº¤æ€§ï¼ˆorthogonal æ„ä¸ºæ­£äº¤çš„ï¼‰ï¼Œå°±æ˜¯è®¾è®¡çš„ç»´åº¦ä¸å…¶ä»–ç»´åº¦å®Œå…¨éš”ç¦»ï¼Œä¸€ä¸ªæ­£äº¤çš„è®¾è®¡/å€¼åŸŸè®¾è®¡ï¼Œå…¶å˜åŒ–ç»ä¸ä¼šå—å…¶ä»–æ­£äº¤ç»´åº¦å½±å“ï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–æ­£äº¤ç»´åº¦ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠ API è®¾è®¡æˆæ­£äº¤çš„ã€‚è¿™æ · API æœ‰ç‹¬ç«‹å˜åŒ–çš„ç©ºé—´çš„ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠé—®é¢˜åŸŸåˆ‡åˆ†æ¸…æ¥šã€‚é—®é¢˜åŸŸä¹‹é—´å®Œå…¨ä¸ç›¸äº’å¹²æ¶‰ï¼ˆæ³¨æ„è·¨é—®é¢˜åŸŸé—®é¢˜ï¼‰ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠå˜é‡ã€å­—æ®µã€åˆ—è®¾è®¡æˆæ­£äº¤çš„ã€‚è¿™æ ·ä¸åŒä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œåˆ—ä¹‹é—´çš„èµ‹å€¼ä¸ä¼šç›¸äº’è¦†ç›–ã€‚ </div></div></div></a><a class="pagination-related" href="/2019/08/30/%E3%80%8A%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%80%9D%E8%B7%AF%E3%80%8B%E7%AC%94%E8%AE%B0/" title="ã€Šé«˜å¯ç”¨æ¢å¤æ€è·¯ã€‹ç¬”è®°"><img class="cover" src="/img/wall-paper-13.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-08-30</div><div class="info-item-2">ã€Šé«˜å¯ç”¨æ¢å¤æ€è·¯ã€‹ç¬”è®°</div></div><div class="info-2"><div class="info-item-1">é‡åˆ°çº¿ä¸Šé—®é¢˜ï¼Œç»å¸¸é™·å…¥ä¸€ä¸ªè¯¯åŒºï¼šä¸€å®šè¦æ‰¾åˆ°é—®é¢˜çš„æ ¹å› ï¼ˆroot causeï¼‰ã€‚ä½†å®é™…ä¸Šå¯¹çº¿ä¸Šåº”ç”¨è€Œè¨€ï¼Œæœ€é‡è¦çš„æ˜¯æ¢å¤å¯ç”¨æ€§ï¼Œæ‰€ä»¥åœ¨å¼€å‘è®¾è®¡ç¯å¢ƒé™¤äº†å®ŒæˆåŠŸèƒ½æ€§éœ€æ±‚ä»¥å¤–ï¼Œè¿˜éœ€è¦åŠ å…¥éåŠŸèƒ½æ€§è®¾è®¡çš„éœ€æ±‚ï¼š  é™æµä¿æŠ¤ã€‚æŠµæŒ¡æ¥è‡ªçªå‘æµé‡å†²å®æ•´ä¸ªé›†ç¾¤ã€‚ é™çº§ä¿æŠ¤ï¼Œå¯¹è°ƒç”¨çš„æœåŠ¡æ¥å£ä¿æŒè­¦æƒ•ï¼Œå…¶å„ç§å› ç´ å¯¼è‡´ä¸å¯ç”¨ï¼Œå¯ä»¥å¯¹é½é™çº§ï¼Œä»è€Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½å¯ç”¨ã€‚ å‰Šå³°å¡«è°·ï¼ˆtraffic shapingï¼‰ï¼Œä¸å› çªå‘æ•°æ®æ¥è¢­ï¼Œé€ æˆä»»åŠ¡æ¶ˆè´¹é™¡å¢ï¼Œé€ æˆè°ƒç”¨ç³»ç»Ÿçš„è¿ä¸²æŠ–åŠ¨ã€‚  è¿™äº›åŸºæœ¬çš„ç³»ç»Ÿä¿æŠ¤ï¼Œæ˜¯åº”å¯¹æœªæ¥çš„å„ç§çªå‘ä¸ç¡®å®šäº‹ä»¶çš„é«˜å¯ç”¨æ€è€ƒã€‚ ä»¥ä¸Šæè¿°çš„æ˜¯é—®é¢˜çš„åº”å¯¹æœºåˆ¶è®¾è®¡ï¼Œé—®é¢˜çš„å‘ç°æœºåˆ¶ï¼Œä¹Ÿéœ€è¦ç»“æ„åŒ–åœ°è€ƒè™‘ï¼Œä½“ç³»åŒ–åœ°å»ºè®¾ï¼š  å‘ç°æœºåˆ¶ï¼Œæ˜¯æˆ‘ä»¬çš„çœ¼ç›ï¼Œä¹Ÿæ˜¯åŸºç¡€ã€‚ ç›‘æ§ä¸»æŒ‡æ ‡ï¼Œéœ€è¦æ‰¾å¯¹ä¸šåŠ¡çš„ä¸»è¦æŒ‡æ ‡ï¼Œå¸¸è§çš„ä¸»æŒ‡æ ‡ä¸€èˆ¬æ˜¯ï¼šRTï¼ˆå“åº”æ—¶é—´ï¼‰ã€æ€»é‡ã€æˆåŠŸé‡ã€å¤±è´¥é‡ã€æˆåŠŸç‡ã€‚ ä¸»æŒ‡æ ‡æœ‰å¼‚å¸¸ï¼Œè¿˜è¦æœ‰ç»†åˆ†ç»´åº¦ï¼ˆå³ç»“æœè¿˜å¯ä»¥å†…éƒ¨ group by aggregationï¼‰ã€‚ å¿«é€Ÿæ¢å¤ æ ¹æ®ç›‘æ§å¿«é€Ÿå¯»æ‰¾é—®é¢˜å‘ç”Ÿçš„æ–¹å‘å’Œä½ç½®ã€‚ æ‰¾å¯¹æ¢å¤çš„äººã€æ¢å¤çš„é¢„æ¡ˆã€‚ å€¾å‘äºé€‰æ‹©æˆæœ¬ä½çš„æ¢å¤æ‰‹æ®µã€‚---- å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ¢å¤éƒ½ç”¨å¤§æ‹›ï¼ˆç†”æ–­ã€é™æµï¼‰ï¼Œå¤§æ‹›...</div></div></div></a><a class="pagination-related" href="/2019/09/05/%E3%80%8A%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84%E4%B9%8B%E9%81%93%E3%80%8B%E7%AC%94%E8%AE%B0/" title="ã€Šåº”ç”¨æ¶æ„ä¹‹é“ã€‹ç¬”è®°"><img class="cover" src="/img/wall-paper-61.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-05</div><div class="info-item-2">ã€Šåº”ç”¨æ¶æ„ä¹‹é“ã€‹ç¬”è®°</div></div><div class="info-2"><div class="info-item-1">æ¶æ„å¸ˆçš„èŒè´£ åŒ–ç¹ä¸ºç®€ã€‚æ¶æ„å¸ˆæ˜¯èŒè´£å°±æ˜¯æŠŠå¤æ‚çš„é—®é¢˜ç®€å•åŒ–ï¼Œä½¿å¾—å…¶ä»–äººèƒ½å¤Ÿæ›´å¥½åœ°åœ¨æ¶æ„é‡Œå·¥ä½œã€‚ æ¶æ„å¸ˆè¦åŠªåŠ›è®­ç»ƒè‡ªå·±çš„æ€ç»´ï¼Œç”¨å®ƒå»ç†è§£å¤æ‚çš„ç³»ç»Ÿï¼Œé€šè¿‡åˆç†çš„åˆ†è§£å’ŒæŠ½è±¡ï¼Œåšå‡ºåˆç†çš„è®¾è®¡ã€‚ è½¯ä»¶æ¶æ„ è½¯ä»¶æ¶æ„æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„è‰å›¾ã€‚è½¯ä»¶æ¶æ„æè¿°çš„å¯¹è±¡æ˜¯ç›´æ¥æ„æˆç³»ç»Ÿçš„æŠ½è±¡ç»„ä»¶ã€‚å„ä¸ªç»„ä»¶çš„é“¾æ¥åˆ™æ˜ç¡®å’Œç›¸å¯¹ç»†è‡´åœ°æè¿°ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ã€‚  è½¯ä»¶æ¶æ„ä¸ºè½¯ä»¶ç³»ç»Ÿæä¾›äº†ç»“æ„ã€è¡Œä¸ºå’Œå±æ€§çš„é«˜çº§æŠ½è±¡ã€‚ï¼Œç”±æ„ä»¶çš„æè¿°ã€æ„ä»¶çš„ç›¸äº’ä½œç”¨ã€æŒ‡å¯¼æ„ä»¶é›†æˆçš„æ¨¡å¼ä»¥åŠè¿™äº›æ¨¡å¼çš„çº¦æŸç»„æˆã€‚è½¯ä»¶æ¶æ„ä¸ä»…æ˜¾ç¤ºäº†è½¯ä»¶éœ€æ±‚å’Œè½¯ä»¶ç»“æ„ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œè€Œä¸”æŒ‡å®šäº†æ•´ä¸ªè½¯ä»¶ç³»ç»Ÿçš„ç»„ç»‡å’Œæ‹“æ‰‘ç»“æ„ï¼Œæä¾›äº†ä¸€äº›è®¾è®¡å†³ç­–çš„åŸºæœ¬åŸç†ã€‚ è½¯ä»¶æ¶æ„çš„æ ¸å¿ƒä»·å€¼åº”è¯¥åªå›´ç»•ä¸€ä¸ªæ ¸å¿ƒå‘½é¢˜ï¼šæ§åˆ¶å¤æ‚æ€§ã€‚  è½¯ä»¶æ¶æ„åˆ†ç±»  ä¸šåŠ¡æ¶æ„ï¼šç”±ä¸šåŠ¡æ¶æ„å¸ˆè´Ÿè´£ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºä¸šåŠ¡é¢†åŸŸä¸“å®¶ã€è¡Œä¸šä¸“å®¶ã€‚ä¸šåŠ¡æ¶æ„å±äºé¡¶å±‚è®¾è®¡ï¼Œå…¶å¯¹ä¸šåŠ¡çš„å®šä¹‰å’Œåˆ’åˆ†ä¼šå½±å“ç»„ç»‡ç»“æ„å’ŒæŠ€æœ¯æ¶æ„ã€‚ åº”ç”¨æ¶æ„ï¼šç”±åº”ç”¨æ¶æ„å¸ˆè´Ÿè´£ï¼Œä»–éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯çš„éœ€è¦ï¼Œè®¾è®¡åº”ç”¨çš„å±‚æ¬¡ç»“æ„ï¼Œåˆ¶å®šåº”ç”¨è§„èŒƒã€å®šä¹‰æ¥å£å’Œæ•°æ®äº¤äº’åè®®ç­‰ã€‚å¹¶å°½é‡å°†åº”ç”¨çš„å¤æ‚åº¦æ§åˆ¶åœ¨ä¸€ä¸ªå¯ä»¥æ¥å—çš„æ°´å¹³ï¼Œä»è€Œåœ¨å¿«é€Ÿçš„æ”¯æ’‘ä¸šåŠ¡å‘å±•çš„åŒæ—¶ï¼Œåœ¨ä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¯ç»´...</div></div></div></a><a class="pagination-related" href="/2019/09/26/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E7%AC%94%E8%AE%B0/" title="æ¶æ„æ•´æ´ä¹‹é“ç¬”è®°"><img class="cover" src="/img/wall-paper-107.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-26</div><div class="info-item-2">æ¶æ„æ•´æ´ä¹‹é“ç¬”è®°</div></div><div class="info-2"><div class="info-item-1">æœ€æ—©çš„ã€ŠThe Clean Architectureã€‹è¯ç”Ÿäº 2012å¹´ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆæ—©å°±è¢«è®¨è®ºæ¸…æ¥šäº†ã€‚ æ€ç»´å¯¼å›¾ï¼š   æ³¨æ„ï¼Œæ‰€æœ‰çš„æ¥å£éƒ½æ˜¯åœ¨é«˜å±‚å£°æ˜çš„ï¼šUseCase Input Port å’Œ UseCase Output portï¼Œæ‰€ä»¥é«˜å±‚å¯ä»¥å®ç°é«˜å±‚çš„æ¥å£ï¼Œä½å±‚ä¹Ÿå¯ä»¥å®ç°é«˜å±‚çš„æ¥å£ã€‚ æ³¨æ„ï¼Œsofaçš„åˆ†å±‚å°±æ˜¯åœ¨ä¸€ä¸ªæ¨ªå‘çš„æ¨¡å—é‡Œå£°æ˜äº†ä¸šåŠ¡ç”¨ä¾‹çš„æ¥å£å’Œ core-model çš„æ¥å£ï¼Œè¿™æ ·æºä»£ç çº§çš„ä¾èµ–éƒ½é›†ä¸­åœ¨æŠ½è±¡ä¸Šï¼š   Use Case Interactor å’Œ Presenter åº”è¯¥æ˜¯å¯æµ‹è¯•çš„ï¼Œè€Œ Data Access Interfaceã€Viewã€ORM åº”è¯¥æ˜¯ humble objectã€‚æ‰€ä»¥ä¸€ä¸ªåº”ç”¨çš„ä½å±‚ï¼ˆå¤–å±‚ï¼‰åº”è¯¥æ˜¯è¢«æ’é™¤æ‰ä¸åšæµ‹è¯•çš„ã€‚ é™„ä»¶ä¸‹è½½ï¼š xmind å…³äºæºä»£ç ä¸­çš„ä¾èµ–å…³ç³»çš„ä¸€äº›æ¾„æ¸…ï¼š  â€œä½¿ç”¨â€å¹¶ä¸æ„å‘³ç€â€œå®šä¹‰â€ï¼Œè€Œåªæ˜¯å¼•ç”¨  dashed outline ä»£è¡¨è™šçº¿æ¡†ï¼Œä¹Ÿä»£è¡¨æŠ½è±¡ã€‚           </div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">ç¼“å­˜çš„å¥—è·¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E6%80%BB%E8%A7%88"><span class="toc-number">1.1.</span> <span class="toc-text">æ¨¡å¼æ€»è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E7%BC%93%E5%AD%98%E7%9A%84%E6%9C%AC%E8%B4%A8%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.</span> <span class="toc-text">ä¸€ã€ç¼“å­˜çš„æœ¬è´¨ä¸é€‚ç”¨åœºæ™¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 ä½•æ—¶ä½¿ç”¨ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%B8%8D%E9%80%82%E7%94%A8%E7%BC%93%E5%AD%98%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 ä¸é€‚ç”¨ç¼“å­˜çš„åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E7%BC%93%E5%AD%98%E7%9A%84%E5%B1%82%E6%AC%A1%E4%B8%8E%E9%80%89%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">äºŒã€ç¼“å­˜çš„å±‚æ¬¡ä¸é€‰å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E8%BF%91%E7%AB%AF%E7%BC%93%E5%AD%98-vs-%E8%BF%9C%E7%AB%AF%E7%BC%93%E5%AD%98"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 è¿‘ç«¯ç¼“å­˜ vs è¿œç«¯ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%85%B3%E4%BA%8E%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 å…³äºå¤šçº§ç¼“å­˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.</span> <span class="toc-text">ä¸‰ã€ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-cache-aside-%E6%97%81%E8%B7%AF%E7%BC%93%E5%AD%98"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-read-through-write-through"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 Read Through &#x2F; Write Through</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-write-behind-%E5%BC%82%E6%AD%A5%E5%9B%9E%E5%86%99"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 Write Behindï¼ˆå¼‚æ­¥å›å†™ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E7%AD%96%E7%95%A5%E5%AF%B9%E6%AF%94"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4 ç­–ç•¥å¯¹æ¯”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-java-%E8%BF%9B%E7%A8%8B%E5%86%85%E7%BC%93%E5%AD%98%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.5.</span> <span class="toc-text">å››ã€Java è¿›ç¨‹å†…ç¼“å­˜è¯¦è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-guava-cache"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 Guava Cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-caffeine"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 Caffeine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-ehcache-3"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 EhCache 3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%EF%BC%9Aredis"><span class="toc-number">1.6.</span> <span class="toc-text">äº”ã€åˆ†å¸ƒå¼ç¼“å­˜ï¼šRedis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%89%E6%8B%A9"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 å®¢æˆ·ç«¯é€‰æ‹©</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-spring-data-redis-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 Spring Data Redis é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E7%BC%93%E5%AD%98%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.6.3.</span> <span class="toc-text">5.3 ç¼“å­˜åºåˆ—åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E7%BC%93%E5%AD%98%E6%95%85%E9%9A%9C%E9%98%B2%E6%8A%A4"><span class="toc-number">1.7.</span> <span class="toc-text">å…­ã€ç¼“å­˜æ•…éšœé˜²æŠ¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF-hot-key-expiration"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1 ç¼“å­˜å‡»ç©¿ï¼ˆHot Key Expirationï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9-mass-expiration"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 ç¼“å­˜é›ªå´©ï¼ˆMass Expirationï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F-phantom-key"><span class="toc-number">1.7.3.</span> <span class="toc-text">6.3 ç¼“å­˜ç©¿é€ï¼ˆPhantom Keyï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%F0%9F%94%91-%E6%A8%A1%E5%BC%8F%E6%8F%90%E7%82%BC"><span class="toc-number">1.8.</span> <span class="toc-text">ä¸ƒã€ğŸ”‘ æ¨¡å¼æç‚¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%80%EF%BC%9A%E5%88%86%E5%B1%82%E9%99%8D%E7%BA%A7"><span class="toc-number">1.8.1.</span> <span class="toc-text">æ¨¡å¼ä¸€ï¼šåˆ†å±‚é™çº§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%BA%8C%EF%BC%9A%E6%83%B0%E6%80%A7%E5%A1%AB%E5%85%85"><span class="toc-number">1.8.2.</span> <span class="toc-text">æ¨¡å¼äºŒï¼šæƒ°æ€§å¡«å……</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%89%EF%BC%9A%E7%A9%BA%E5%80%BC%E9%98%B2%E5%BE%A1"><span class="toc-number">1.8.3.</span> <span class="toc-text">æ¨¡å¼ä¸‰ï¼šç©ºå€¼é˜²å¾¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%AE%9E%E8%B7%B5%E8%A6%81%E7%82%B9"><span class="toc-number">1.9.</span> <span class="toc-text">å…«ã€ç”Ÿäº§ç¯å¢ƒå®è·µè¦ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">1.9.1.</span> <span class="toc-text">8.1 ç›‘æ§æŒ‡æ ‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92"><span class="toc-number">1.9.2.</span> <span class="toc-text">8.2 å®¹é‡è§„åˆ’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E6%95%85%E9%9A%9C%E6%BC%94%E7%BB%83%E6%B8%85%E5%8D%95"><span class="toc-number">1.9.3.</span> <span class="toc-text">8.3 æ•…éšœæ¼”ç»ƒæ¸…å•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-%E6%A8%A1%E5%BC%8F%E9%80%9F%E6%9F%A5%E8%A1%A8"><span class="toc-number">1.10.</span> <span class="toc-text">ä¹ã€æ¨¡å¼é€ŸæŸ¥è¡¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.11.</span> <span class="toc-text">å‚è€ƒæ–‡çŒ®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#guava"><span class="toc-number">1.12.</span> <span class="toc-text">Guava</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-guava-%E4%B8%80%E8%88%AC%E7%9A%84%E7%9F%AD%E8%B7%AF%E5%99%A8%E5%BC%8F%E7%9A%84%E7%94%A8%E6%B3%95"><span class="toc-number">1.12.1.</span> <span class="toc-text">Spring + Guava ä¸€èˆ¬çš„çŸ­è·¯å™¨å¼çš„ç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E9%9C%80%E8%A6%81%E8%A6%86%E7%9B%96-load-%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.2.</span> <span class="toc-text">åªéœ€è¦è¦†ç›– load æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E6%9D%83%E9%87%8D%E7%9A%84%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="toc-number">1.12.3.</span> <span class="toc-text">å¸¦æƒé‡çš„ç¼“å­˜é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">1.12.4.</span> <span class="toc-text">æŒ‡å®šè¿‡æœŸæ—¶é—´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%B1%E5%BC%95%E7%94%A8%E5%92%8C%E8%BD%AF%E5%BC%95%E7%94%A8-key"><span class="toc-number">1.12.5.</span> <span class="toc-text">å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E8%A7%A6%E5%8F%91-load-%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.6.</span> <span class="toc-text">å®šæ—¶è§¦å‘ load æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E9%A2%84%E7%83%AD"><span class="toc-number">1.12.7.</span> <span class="toc-text">ä¸»åŠ¨é¢„çƒ­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8-optional-%E6%9D%A5%E5%BA%94%E5%AF%B9-null-%E5%80%BC"><span class="toc-number">1.12.8.</span> <span class="toc-text">å¿…é¡»ä½¿ç”¨ optional æ¥åº”å¯¹ null å€¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E5%88%A0%E9%99%A4%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.12.9.</span> <span class="toc-text">è®¢é˜…åˆ é™¤äº‹ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cache-statistic"><span class="toc-number">1.12.10.</span> <span class="toc-text">Cache Statistic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ecache"><span class="toc-number">1.13.</span> <span class="toc-text">ECache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring4-ecache-2"><span class="toc-number">1.13.1.</span> <span class="toc-text">Spring4 + ECache 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-boot-2-ecache3"><span class="toc-number">1.13.2.</span> <span class="toc-text">Spring Boot 2 + ECache3</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#caffeine"><span class="toc-number">1.14.</span> <span class="toc-text">Caffeine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E6%90%AD%E9%85%8D-spring"><span class="toc-number">1.14.1.</span> <span class="toc-text">ä¸æ­é… Spring</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E9%85%8D-spring"><span class="toc-number">1.14.2.</span> <span class="toc-text">æ­é… Spring</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">å¦‚ä½•åº”å¯¹ç¼“å­˜ miss çš„é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF-breakthrough"><span class="toc-number">2.1.</span> <span class="toc-text">å¦‚ä½•åº”å¯¹ç¼“å­˜å‡»ç©¿ï¼ˆbreakthroughï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">2.2.</span> <span class="toc-text">å¦‚ä½•åº”å¯¹ç¼“å­˜é›ªå´©</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F-penetration"><span class="toc-number">2.3.</span> <span class="toc-text">å¦‚ä½•åº”å¯¹ç¼“å­˜ç©¿é€ï¼ˆpenetrationï¼‰</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">è¿œç«¯ç¼“å­˜ä¸è¿‘ç«¯ç¼“å­˜çš„è¾¨æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">3.1.</span> <span class="toc-text">è¿œç«¯ç¼“å­˜çš„å¥½å¤„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%9D%8F%E5%A4%84"><span class="toc-number">3.2.</span> <span class="toc-text">è¿œç«¯ç¼“å­˜çš„åå¤„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%91%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">3.3.</span> <span class="toc-text">è¿‘ç«¯ç¼“å­˜çš„å¥½å¤„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%91%E7%AB%AF%E7%BC%93%E5%AD%98%E7%9A%84%E5%9D%8F%E5%A4%84"><span class="toc-number">3.4.</span> <span class="toc-text">è¿‘ç«¯ç¼“å­˜çš„åå¤„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81-%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%80%E8%87%B4%E6%80%A7%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90"><span class="toc-number">3.4.1.</span> <span class="toc-text">åã€ç¼“å­˜ä¸æ•°æ®åº“ä¸€è‡´æ€§æ·±åº¦åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E5%8F%8C%E5%88%A0%E7%AD%96%E7%95%A5"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">å»¶è¿ŸåŒåˆ ç­–ç•¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#canal-binlog-%E8%AE%A2%E9%98%85%E6%96%B9%E6%A1%88"><span class="toc-number">3.4.1.2.</span> <span class="toc-text">Canal&#x2F;Binlog è®¢é˜…æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B8%8E%E7%BC%93%E5%AD%98"><span class="toc-number">3.4.1.3.</span> <span class="toc-text">åˆ†å¸ƒå¼äº‹åŠ¡ä¸ç¼“å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7-%E6%97%B6%E9%97%B4%E6%88%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.4.1.4.</span> <span class="toc-text">ç‰ˆæœ¬å·&#x2F;æ—¶é—´æˆ³æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#facebook-memcache-%E8%AE%BA%E6%96%87%E8%A6%81%E7%82%B9"><span class="toc-number">3.4.1.5.</span> <span class="toc-text">Facebook Memcache è®ºæ–‡è¦ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-%E7%83%AD%E7%82%B9%E6%8E%A2%E6%B5%8B%E4%B8%8E%E7%83%AD-key-%E6%B2%BB%E7%90%86"><span class="toc-number">3.4.2.</span> <span class="toc-text">åä¸€ã€çƒ­ç‚¹æ¢æµ‹ä¸çƒ­ Key æ²»ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E7%82%B9-key-%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E5%8D%B1%E5%AE%B3"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">çƒ­ç‚¹ Key çš„å®šä¹‰å’Œå±å®³</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E6%8E%A2%E6%B5%8B%E6%96%B9%E6%A1%88"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">çƒ­ç‚¹æ¢æµ‹æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BB%9F%E8%AE%A1"><span class="toc-number">3.4.2.2.1.</span> <span class="toc-text">å®¢æˆ·ç«¯ç»Ÿè®¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BB%9F%E8%AE%A1-redis-hotkeys"><span class="toc-number">3.4.2.2.2.</span> <span class="toc-text">æœåŠ¡ç«¯ç»Ÿè®¡ï¼ˆRedis hotkeysï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%AC%E4%B8%9C-hotkey-%E6%A1%86%E6%9E%B6"><span class="toc-number">3.4.2.2.3.</span> <span class="toc-text">äº¬ä¸œ HotKey æ¡†æ¶</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD-key-%E6%B2%BB%E7%90%86%E6%96%B9%E6%A1%88"><span class="toc-number">3.4.2.3.</span> <span class="toc-text">çƒ­ Key æ²»ç†æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E5%85%9C%E5%BA%95-l1-cache"><span class="toc-number">3.4.2.3.1.</span> <span class="toc-text">æœ¬åœ°ç¼“å­˜å…œåº•ï¼ˆL1 Cacheï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#key-%E5%88%86%E6%95%A3-%E6%89%93%E6%95%A3"><span class="toc-number">3.4.2.3.2.</span> <span class="toc-text">Key åˆ†æ•£&#x2F;æ‰“æ•£</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-%E5%A4%A7-key-%E9%97%AE%E9%A2%98%E4%B8%8E%E6%B2%BB%E7%90%86"><span class="toc-number">3.4.3.</span> <span class="toc-text">åäºŒã€å¤§ Key é—®é¢˜ä¸æ²»ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7-key-%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">å¤§ Key çš„å®šä¹‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7-key-%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">å¤§ Key çš„å±å®³</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E6%89%8B%E6%AE%B5"><span class="toc-number">3.4.3.3.</span> <span class="toc-text">å‘ç°æ‰‹æ®µ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#redis-cli-bigkeys"><span class="toc-number">3.4.3.3.1.</span> <span class="toc-text">redis-cli --bigkeys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#memory-usage"><span class="toc-number">3.4.3.3.2.</span> <span class="toc-text">memory usage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B2%BB%E7%90%86%E6%96%B9%E6%A1%88"><span class="toc-number">3.4.3.4.</span> <span class="toc-text">æ²»ç†æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%86%E5%88%86%E5%A4%A7-key"><span class="toc-number">3.4.3.4.1.</span> <span class="toc-text">æ‹†åˆ†å¤§ Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%88%A0%E9%99%A4-unlink"><span class="toc-number">3.4.3.4.2.</span> <span class="toc-text">å¼‚æ­¥åˆ é™¤ï¼ˆUNLINKï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%AD%98%E5%82%A8"><span class="toc-number">3.4.3.4.3.</span> <span class="toc-text">å‹ç¼©å­˜å‚¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%89-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E5%AE%9E%E6%88%98"><span class="toc-number">3.4.4.</span> <span class="toc-text">åä¸‰ã€å¤šçº§ç¼“å­˜æ¶æ„å®æˆ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E4%B8%89%E7%BA%A7%E6%9E%B6%E6%9E%84"><span class="toc-number">3.4.4.1.</span> <span class="toc-text">ç»å…¸ä¸‰çº§æ¶æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openresty-lua-%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%85%A5%E5%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">3.4.4.2.</span> <span class="toc-text">OpenResty + Lua å®ç°æ¥å…¥å±‚ç¼“å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jetcache-%E6%A1%86%E6%9E%B6"><span class="toc-number">3.4.4.3.</span> <span class="toc-text">JetCache æ¡†æ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E6%8C%91%E6%88%98"><span class="toc-number">3.4.4.4.</span> <span class="toc-text">å¤šçº§ç¼“å­˜çš„ä¸€è‡´æ€§æŒ‘æˆ˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD%E7%AD%96%E7%95%A5"><span class="toc-number">3.4.4.5.</span> <span class="toc-text">ç¼“å­˜é¢„çƒ­ç­–ç•¥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B-redis-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.4.5.</span> <span class="toc-text">åå››ã€Redis é›†ç¾¤æ¨¡å¼ä¸‹çš„ç¼“å­˜è®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-cluster-%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="toc-number">3.4.5.1.</span> <span class="toc-text">Redis Cluster çš„æ•°æ®åˆ†ç‰‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%A8-slot-%E6%93%8D%E4%BD%9C%E7%9A%84%E9%99%90%E5%88%B6"><span class="toc-number">3.4.5.2.</span> <span class="toc-text">è·¨ slot æ“ä½œçš„é™åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hashtag-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.4.5.3.</span> <span class="toc-text">HashTag çš„ä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%89%A9%E7%BC%A9%E5%AE%B9%E5%AF%B9%E7%BC%93%E5%AD%98%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">3.4.5.4.</span> <span class="toc-text">é›†ç¾¤æ‰©ç¼©å®¹å¯¹ç¼“å­˜çš„å½±å“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-sentinel-vs-cluster-%E7%9A%84%E9%80%89%E5%9E%8B"><span class="toc-number">3.4.5.5.</span> <span class="toc-text">Redis Sentinel vs Cluster çš„é€‰å‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%BA%94-%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%89%E5%85%A8%E4%B8%8E%E8%BF%90%E7%BB%B4"><span class="toc-number">3.4.6.</span> <span class="toc-text">åäº”ã€ç¼“å­˜çš„å®‰å…¨ä¸è¿ç»´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8"><span class="toc-number">3.4.6.1.</span> <span class="toc-text">ç¼“å­˜æ•°æ®å®‰å…¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%AE%B9%E9%87%8F%E5%91%8A%E8%AD%A6"><span class="toc-number">3.4.6.2.</span> <span class="toc-text">ç¼“å­˜å®¹é‡å‘Šè­¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%8E%92%E6%9F%A5"><span class="toc-number">3.4.6.3.</span> <span class="toc-text">æ…¢æŸ¥è¯¢æ’æŸ¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%81%BE%E5%A4%87"><span class="toc-number">3.4.6.4.</span> <span class="toc-text">ç¼“å­˜ç¾å¤‡</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2017 - 2026 By magicliang</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">ç°¡</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/js/tw_cn.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="/"></script></div></body></html>