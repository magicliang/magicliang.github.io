<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Java 注解和配置 | 守株阁</title><meta name="author" content="magicliang"><meta name="copyright" content="magicliang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Java 的原生注解 meta annotation @Inherited @Inherited 是一个元注解（annotations applied to other annotations 注解其他注解的注解），也是一个标记注解，@Inherited阐述了某个被标注的类型是被继承的。 **@Inherited annotation类型是被标注过的class的子类所继承。类并不从它所实现的接口继">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 注解和配置">
<meta property="og:url" content="https://magicliang.github.io/2020/03/29/Java-%E6%B3%A8%E8%A7%A3%E5%92%8C%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="守株阁">
<meta property="og:description" content="Java 的原生注解 meta annotation @Inherited @Inherited 是一个元注解（annotations applied to other annotations 注解其他注解的注解），也是一个标记注解，@Inherited阐述了某个被标注的类型是被继承的。 **@Inherited annotation类型是被标注过的class的子类所继承。类并不从它所实现的接口继">
<meta property="og:locale">
<meta property="og:image" content="https://magicliang.github.io/img/wall-paper-179.jpeg">
<meta property="article:published_time" content="2020-03-29T15:12:07.000Z">
<meta property="article:modified_time" content="2026-01-24T07:32:06.871Z">
<meta property="article:author" content="magicliang">
<meta property="article:tag" content="JPA">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://magicliang.github.io/img/wall-paper-179.jpeg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Java 注解和配置",
  "url": "https://magicliang.github.io/2020/03/29/Java-%E6%B3%A8%E8%A7%A3%E5%92%8C%E9%85%8D%E7%BD%AE/",
  "image": "https://magicliang.github.io/img/wall-paper-179.jpeg",
  "datePublished": "2020-03-29T15:12:07.000Z",
  "dateModified": "2026-01-24T07:32:06.871Z",
  "author": [
    {
      "@type": "Person",
      "name": "magicliang",
      "url": "https://magicliang.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://magicliang.github.io/2020/03/29/Java-%E6%B3%A8%E8%A7%A3%E5%92%8C%E9%85%8D%E7%BD%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: magicliang","link":"Link: ","source":"Source: 守株阁","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java 注解和配置',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="守株阁" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/wall-paper-179.jpeg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">守株阁</span></a><a class="nav-page-title" href="/"><span class="site-name">Java 注解和配置</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Java 注解和配置</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-03-29T15:12:07.000Z" title="Created 2020-03-29 23:12:07">2020-03-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-01-24T07:32:06.871Z" title="Updated 2026-01-24 15:32:06">2026-01-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>43mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>Java 的原生注解</h1>
<h2 id="meta-annotation">meta annotation</h2>
<h3 id="inherited">@Inherited</h3>
<p>@Inherited 是<strong>一个元注解</strong>（annotations applied to other annotations 注解其他注解的注解），也是一个标记注解，@Inherited阐述了某个被标注的类型是被继承的。 **@Inherited annotation类型是被标注过的class的子类所继承。类并不从它所实现的接口继承annotation，方法并不从它所重载的方法继承annotation。**其查找过程是：反射 API 会在查找 @Inherited 标注的注解的时候，自底向上往继承树上方查找。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyAnnotation &#123;<br>    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;Default Value&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@MyAnnotation(value = &quot;Parent Class&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentClass</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChildClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ParentClass</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-type">ChildClass</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChildClass</span>();<br><span class="hljs-type">MyAnnotation</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> ChildClass.class.getAnnotation(MyAnnotation.class);<br><span class="hljs-keyword">if</span> (annotation != <span class="hljs-literal">null</span>) &#123;<br>    System.out.println(annotation.value()); <span class="hljs-comment">// 输出 &quot;Parent Class&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>@Inherited 仅适用于类，对方法、属性或构造函数的注解无效。</li>
<li>子类可以定义同名注解来覆盖继承的注解。在上面的例子里面，@MyAnnotation(value = “Parent Class”)在子类里应该可以重新赋值成 @MyAnnotation(value = “Child Class”)</li>
<li>接口中的注解不会被子类继承，即使注解使用了 @Inherited。</li>
<li>如果一个类实现了一个接口，那么这个类不会继承接口中定义的任何注解。</li>
</ul>
<h4 id="websocket-注解相关的争论">WebSocket 注解相关的争论</h4>
<p><a target="_blank" rel="noopener" href="https://download.oracle.com/javaee-archive/websocket-spec.java.net/jsr356-experts/2013/01/0296.html">[jsr356-experts] Annotation inheritance: was: Re: Potpourri of smaller issues</a></p>
<p>这个争论的问题是：</p>
<ul>
<li>@WebSocketMessage 可被继承吗？看起来是不可以的，因为这不是一个类注解</li>
<li>@WebSocketEndpoint(/“chat”) 是一个类注解，这个类注解被子类覆盖 @WebSocketEndpoint(/“superchat”) 以后。有几个 endpoint？实际上可能是只有1个（覆盖的 semantics）就是这样，但也许 chat 是一个必须存在的endpoint，不能被覆盖，那么是不是无意中覆盖它会有问题，这是不是带来了一个不能扩展但又不是 final 的类型？</li>
</ul>
<h3 id="其他元注解">其他元注解</h3>
<ul>
<li>@Target: Describes the targets to which an annotation can be applied; this directly corresponds to the nine contexts above</li>
<li>@Retention: Describes how long the annotation should be retained by the compiler</li>
<li>@Inherited: Denotes that an annotation should be inherited by a subtype if applied to a supertype</li>
<li>@Deprecated: Denotes that an annotation (or any other type) should no longer be used</li>
<li>@Repeatable: Denotes that an annotation can be applied multiple times in the same context; i.e. a class can have the same annotation applied to it two or more times 这一种注解最有意思，但平时没有什么用例，其大部分使用场景可以被一个复合值的 values 代替。</li>
</ul>
<p>注意，直接在注解上加入注解，实际上就产生了组合注解，会让配置集体生效，但这和继承元注解不一样。</p>
<h1>Spring 原生的功能</h1>
<h2 id="xml-的模式">xml 的模式</h2>
<p>spring 的配置总是：</p>
<ul>
<li>有固定值的 w3c 的 xsi</li>
<li>beans ns 它属于 spring org 的 schema 的一个子目录</li>
<li>多个 attribute ns （它实际上是一个目录）</li>
<li>一个 attirbute schemaLocation（它是目录里面的真正方定义的地方） 它也属于 spring org 的 schema 的一个子目录，通常是一段 xsd</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- beans 的空间，这样我们就可以使用 beans 元素 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">        &lt;!<span class="hljs-attr">--</span>  <span class="hljs-attr">w3c</span> <span class="hljs-attr">的</span> <span class="hljs-attr">xsi</span>，<span class="hljs-attr">默认总有</span> <span class="hljs-attr">--</span>&gt;</span><br>       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>       <span class="hljs-comment">&lt;!-- 可以使用 context attribute --&gt;</span><br>       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;<br>       <span class="hljs-comment">&lt;!-- 可以使用 mvc attribute --&gt;</span><br>       xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;<br>       <span class="hljs-comment">&lt;!-- 可以使用 aop attribute --&gt;</span><br>       xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;<br>       <span class="hljs-comment">&lt;!-- 具体的 attribute 元素的定义 --&gt;</span><br>       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans<br>            http://www.springframework.org/schema/beans/spring-beans.xsd<br>            http://www.springframework.org/schema/context<br>            http://www.springframework.org/schema/context/spring-context.xsd<br>            http://www.springframework.org/schema/mvc<br>            http://www.springframework.org/schema/mvc/spring-mvc.xsd<br>            http://www.springframework.org/schema/aop<br>            http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;<br></code></pre></td></tr></table></figure>
<h2 id="带有-name-的注解">带有 name 的注解</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository(&quot;movieDao&quot;)</span><br><br><span class="hljs-meta">@Bean(&quot;writer2&quot;)</span><br><br><span class="hljs-meta">@Transactional(value=&quot;txManager1&quot;)</span><br></code></pre></td></tr></table></figure>
<h2 id="configuration">@Configuration</h2>
<p>@Configuration 注解本质上还是 @Component，但又不同于 @Component，详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/isea533/article/details/78072133">《Spring @Configuration 和 @Component 区别<br>
》</a>。@Configuration 里的 @Bean 方法可以嵌套使用，而@Component 里的 @Bean 方法不可以。<br>
它天然可以被加载，还可以触发其他 bean 的加载。<br>
它只能被放置在类型上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Component</span><br><br><span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyBean <span class="hljs-title function_">myBean</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// instantiate, configure and return bean ...</span><br>     &#125;<br> &#125;<br><br><span class="hljs-comment">// Bootstrapping @Configuration classes</span><br><span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>();<br> ctx.register(AppConfig.class);<br> ctx.refresh();<br> <span class="hljs-type">MyBean</span> <span class="hljs-variable">myBean</span> <span class="hljs-operator">=</span> ctx.getBean(MyBean.class);<br> <span class="hljs-comment">// use myBean ...</span><br><br><span class="hljs-comment">// 除了它可以被  &lt;context:component-scan/&gt; 扫到，还可以自己配置 ComponentScan</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(value = &quot;com.acme.app.services&quot;,excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="hljs-meta">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br>     <span class="hljs-comment">// various @Bean definitions ...</span><br> &#125;<br> <br> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-comment">// 可以定义多个源</span><br> <span class="hljs-meta">@PropertySource(&quot;classpath:/com/acme/app.properties&quot;)</span><br> <span class="hljs-meta">@PropertySource(&quot;classpath:bar.properties&quot;)</span><br> <span class="hljs-comment">// 甚至这样</span><br><span class="hljs-meta">@PropertySources(&#123;</span><br><span class="hljs-meta">    @PropertySource(&quot;classpath:foo.properties&quot;),</span><br><span class="hljs-meta">    @PropertySource(&quot;classpath:bar.properties&quot;)</span><br><span class="hljs-meta">&#125;)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br><span class="hljs-comment">// 带有缺省值的 value，不要用对象初始值了</span><br><span class="hljs-meta">@Value( &quot;$&#123;jdbc.url:aDefaultUrl&#125;&quot; )</span><br><span class="hljs-keyword">private</span> String jdbcUrl;<br><br>     <span class="hljs-meta">@Value(&quot;$&#123;bean.name&#125;&quot;)</span> String beanName;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyBean <span class="hljs-title function_">myBean</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBean</span>(beanName);<br>     &#125;<br> &#125;<br> <br><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">// 等同于 &lt;import/&gt;，需要用 AnnotationConfigApplicationContext 来 bootstrap。</span><br><span class="hljs-meta">@Import(DatabaseConfig.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>     <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DatabaseConfig dataConfig;<br><br>     <span class="hljs-keyword">public</span> <span class="hljs-title function_">AppConfig</span><span class="hljs-params">(DatabaseConfig dataConfig)</span> &#123;<br>         <span class="hljs-built_in">this</span>.dataConfig = dataConfig;<br>     &#125;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyBean <span class="hljs-title function_">myBean</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// reference the dataSource() bean method</span><br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBean</span>(dataConfig.dataSource());<br>     &#125;<br> &#125;<br> <br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">// 等同于 &lt;import/&gt;，需要用 AnnotationConfigApplicationContext 来 bootstrap。</span><br><span class="hljs-meta">@ImportResource(locations=&#123;&quot;classpath:applicationContext.xml&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlConfiguration</span> &#123;<br><br>&#125;<br><br><span class="hljs-meta">@Profile(&quot;development&quot;)</span><br> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddedDatabaseConfig</span> &#123;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// instantiate, configure and return embedded DataSource</span><br>     &#125;<br> &#125;<br><br> <span class="hljs-meta">@Profile(&quot;production&quot;)</span><br> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductionDatabaseConfig</span> &#123;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// instantiate, configure and return production DataSource</span><br>     &#125;<br> &#125;<br> <br><span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileDatabaseConfig</span> &#123;<br><br>     <span class="hljs-meta">@Bean(&quot;dataSource&quot;)</span><br>     <span class="hljs-meta">@Profile(&quot;development&quot;)</span><br>     <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">embeddedDatabase</span><span class="hljs-params">()</span> &#123; ... &#125;<br><br>     <span class="hljs-meta">@Bean(&quot;dataSource&quot;)</span><br>     <span class="hljs-meta">@Profile(&quot;production&quot;)</span><br>     <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">productionDatabase</span><span class="hljs-params">()</span> &#123; ... &#125;<br> &#125;<br><br> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>     <span class="hljs-meta">@Inject</span> DataSource dataSource;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyBean <span class="hljs-title function_">myBean</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBean</span>(dataSource);<br>     &#125;<br><br>     <span class="hljs-meta">@Configuration</span><br>     <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConfig</span> &#123;<br>         <span class="hljs-meta">@Bean</span><br>         DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> &#123;<br>             <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedDatabaseBuilder</span>().build();<br>         &#125;<br>     &#125;<br> &#125;<br><br><span class="hljs-comment">// When we put @Lazy annotation over the @Configuration class, it indicates that all the methods with @Bean annotation should be loaded lazily.</span><br><span class="hljs-comment">// 这个注解当然也可以和 Component 一起用。相对应的是 eager initialization。</span><br><span class="hljs-meta">@Lazy</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(basePackages = &quot;com.baeldung.lazy&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br> <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Region <span class="hljs-title function_">getRegion</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Region</span>();<br>    &#125;<br> <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Country <span class="hljs-title function_">getCountry</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Country</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="enableasync">@EnableAsync</h2>
<p>激活异步拦截器，类似美团的 mole。</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-async">《How To Do @Async in Spring》</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// By default, Spring will be searching for an associated thread pool definition: either a unique TaskExecutor bean in the context, or an Executor bean named &quot;taskExecutor&quot; otherwise. If neither of the two is resolvable, a SimpleAsyncTaskExecutor will be used to process async method invocations.</span><br> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-meta">@EnableAsync</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span> &#123;<br> <br>    <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();<br>         executor.setCorePoolSize(<span class="hljs-number">7</span>);<br>         executor.setMaxPoolSize(<span class="hljs-number">42</span>);<br>         executor.setQueueCapacity(<span class="hljs-number">11</span>);<br>         executor.setThreadNamePrefix(<span class="hljs-string">&quot;MyExecutor-&quot;</span>);<br>         executor.initialize();<br>         <span class="hljs-keyword">return</span> executor;<br>     &#125;<br><br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> AsyncUncaughtExceptionHandler <span class="hljs-title function_">getAsyncUncaughtExceptionHandler</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAsyncUncaughtExceptionHandler</span>();<br>     &#125;<br>     <br>  <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyAsyncBean <span class="hljs-title function_">asyncBean</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAsyncBean</span>();<br>     &#125;<br>     <br> &#125;<br> <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAsyncBean</span> &#123;<br> <span class="hljs-comment">// First – let&#x27;s go over the rules – @Async has two limitations:</span><br><span class="hljs-comment">// it must be applied to public methods only</span><br><span class="hljs-comment">// self-invocation – calling the async method from within the same class – won&#x27;t work</span><br><span class="hljs-comment">// The reasons are simple – the method needs to be public so that it can be proxied. And self-invocation doesn&#x27;t work because it bypasses the proxy and calls the underlying method directly.</span><br><span class="hljs-comment">// 这个注解会让 Spring 生成一个 aspect 方面</span><br> <span class="hljs-meta">@Async(&quot;threadPoolTaskExecutor&quot;)</span><br><span class="hljs-comment">// 无参数异步方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncMethodWithConfiguredExecutor</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;Execute method with configured executor - &quot;</span><br>      + Thread.currentThread().getName());<br>    &#125;<br><br><span class="hljs-comment">// 有返回值的方法。Future.get() 会抛出 ExecutionException。从这个异常里可以取出原有的异常-不管是受检异常还是非受检异常。</span><br><span class="hljs-meta">@Async</span><br><span class="hljs-keyword">public</span> Future&lt;String&gt; <span class="hljs-title function_">asyncMethodWithReturnType</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;Execute method asynchronously - &quot;</span><br>      + Thread.currentThread().getName());<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">5000</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncResult</span>&lt;String&gt;(<span class="hljs-string">&quot;hello world !!!!&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        <span class="hljs-comment">//</span><br>    &#125;<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br> &#125;<br> <br><span class="hljs-comment">// 自定义异常处理器，这要求在 AsyncConfigurer 里专门使用工厂方法生成相应的 bean。</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomAsyncExceptionHandler</span><br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncUncaughtExceptionHandler</span> &#123;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleUncaughtException</span><span class="hljs-params">(</span><br><span class="hljs-params">      Throwable throwable, Method method, Object... obj)</span> &#123;<br>  <br>        System.out.println(<span class="hljs-string">&quot;Exception message - &quot;</span> + throwable.getMessage());<br>        System.out.println(<span class="hljs-string">&quot;Method name - &quot;</span> + method.getName());<br>        <span class="hljs-keyword">for</span> (Object param : obj) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Parameter value - &quot;</span> + param);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对应的 xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">task:annotation-driven</span> <span class="hljs-attr">executor</span>=<span class="hljs-string">&quot;myExecutor&quot;</span> <span class="hljs-attr">exception-handler</span>=<span class="hljs-string">&quot;exceptionHandler&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">task:executor</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;myExecutor&quot;</span> <span class="hljs-attr">pool-size</span>=<span class="hljs-string">&quot;7-42&quot;</span> <span class="hljs-attr">queue-capacity</span>=<span class="hljs-string">&quot;11&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;asyncBean&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.foo.MyAsyncBean&quot;</span>/&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;exceptionHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.foo.MyAsyncUncaughtExceptionHandler&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h2 id="enablescheduling">@EnableScheduling</h2>
<p>激活任务调度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-meta">@Configuration</span><br> <span class="hljs-meta">@EnableScheduling</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br>    <span class="hljs-comment">// 1.cron是设置定时执行的表达式，如 0 0/5 * * * ?每隔五分钟执行一次</span><br>    <span class="hljs-comment">// 2.zone表示执行时间的时区</span><br>    <span class="hljs-comment">// 3.fixedDelay 和fixedDelayString 表示一个固定延迟时间执行，上个任务完成后，延迟多长时间执行</span><br>    <span class="hljs-comment">// 4.fixedRate 和fixedRateString表示一个固定频率执行，上个任务开始后，多长时间后开始执行</span><br>     <span class="hljs-comment">// 5.initialDelay 和initialDelayString表示一个初始延迟时间，第一次被调用前延迟的时间</span><br>     <span class="hljs-comment">// 每 1000 毫秒运行一次</span><br>     <span class="hljs-meta">@Scheduled(fixedRate=1000)</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// task execution logic</span><br>     &#125;<br> &#125;<br> <br> <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> &#123;<br><br>     <span class="hljs-meta">@Scheduled(fixedRate=1000)</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// task execution logic</span><br>     &#125;<br> &#125;<br> <br><span class="hljs-meta">@Configuration</span><br> <span class="hljs-meta">@EnableScheduling</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SchedulingConfigurer</span> &#123;<br><br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureTasks</span><span class="hljs-params">(ScheduledTaskRegistrar taskRegistrar)</span> &#123;<br>         taskRegistrar.setScheduler(taskExecutor());<br>     &#125;<br><br>     <span class="hljs-meta">@Bean(destroyMethod=&quot;shutdown&quot;)</span><br>     <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> Executors.newScheduledThreadPool(<span class="hljs-number">100</span>);<br>     &#125;<br> &#125;<br> <br> <span class="hljs-comment">// 自定义任务执行</span><br> <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureTasks</span><span class="hljs-params">(ScheduledTaskRegistrar taskRegistrar)</span> &#123;<br>         taskRegistrar.setScheduler(taskScheduler());<br>         taskRegistrar.addTriggerTask(<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                 <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                     myTask().work();<br>                 &#125;<br>             &#125;,<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomTrigger</span>()<br>         );<br>     &#125;<br><br>     <span class="hljs-meta">@Bean(destroyMethod=&quot;shutdown&quot;)</span><br>     <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">taskScheduler</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> Executors.newScheduledThreadPool(<span class="hljs-number">42</span>);<br>     &#125;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyTask <span class="hljs-title function_">myTask</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask</span>();<br>     &#125;<br></code></pre></td></tr></table></figure>
<p>对应的 xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xmlns:task</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/task&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/context/spring-context-3.2.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/task</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/task/spring-task-3.2.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">task:annotation-driven</span> <span class="hljs-attr">executor</span>=<span class="hljs-string">&quot;jobExecutor&quot;</span> <span class="hljs-attr">scheduler</span>=<span class="hljs-string">&quot;jobScheduler&quot;</span> /&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">task:executor</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;jobExecutor&quot;</span> <span class="hljs-attr">pool-size</span>=<span class="hljs-string">&quot;5&quot;</span>/&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">task:scheduler</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;jobScheduler&quot;</span> <span class="hljs-attr">pool-size</span>=<span class="hljs-string">&quot;10&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h2 id="enabletransactionmanagement">@EnableTransactionManagement</h2>
<p>TransactionInterceptor 是被 proxy 或者 advice 加入到调用栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">// In both of the scenarios above, @EnableTransactionManagement and &lt;tx:annotation-driven/&gt; are responsible for registering the necessary Spring components that power annotation-driven transaction management, such as the TransactionInterceptor and the proxy- or AspectJ-based advice that weave the interceptor into the call stack when JdbcFooRepository&#x27;s @Transactional methods are invoked.</span><br> <span class="hljs-meta">@EnableTransactionManagement</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> FooRepository <span class="hljs-title function_">fooRepository</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// configure and return a class having @Transactional methods</span><br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcFooRepository</span>(dataSource());<br>     &#125;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// configure and return the necessary JDBC DataSource</span><br>     &#125;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">txManager</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(dataSource());<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span>/&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;fooRepository&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.foo.JdbcFooRepository&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>/&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.vendor.VendorDataSource&quot;</span>/&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.sfwk...DataSourceTransactionManager&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>/&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>Please note that proxy mode allows for interception of calls through the proxy only; local calls within the same class cannot get intercepted that way.</p>
<p>Note that if the mode() is set to AdviceMode.ASPECTJ, then the value of the proxyTargetClass() attribute will be ignored. Note also that in this case the spring-aspects module JAR must be present on the classpath, with compile-time weaving or load-time weaving applying the aspect to the affected classes. There is no proxy involved in such a scenario; local calls will be intercepted as well.</p>
<p>aspectj 的织入可以增强本地调用，默认的 proxy mode 不可以。</p>
<p>AdviceMode.PROXY<br>
AdviceMode.ASPECTJ</p>
<p>各种 mode 的解释见<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/22569438/optimal-enabletransactionmanagement-configuration">《Optimal @EnableTransactionManagement Configuration》</a>，必须配合<code>proxyTargetClass</code>配置使用：</p>
<blockquote>
<p>This configuration says how the transaction aspect will be applied.<br>
Briefly:</p>
<p>adviceMode=proxy, proxyTargetClass=true Cglib is used as proxy<br>
mechanism. If you use this, cglib must be on classpath, your proxied<br>
classes must have nonparametric constructor and they can’t be final<br>
(cglib creates a child class as the proxy).</p>
<p>adviceMode=proxy, proxyTargetClass=false Jdk proxy mechanism is used.<br>
You only can proxy classes that implements a interface for methods<br>
that should be transactional. Jdk proxy can be type casted to the<br>
interfaces but can’t be type casted as the original proxied class.</p>
<p>So, for adviceMode=proxy, the decision relies more on how are your<br>
code standards and what constraints result from used proxy mechanism.</p>
<p>adviceMode=aspectJ uses aspectJ library, which does byte code<br>
intrumentation instead of proxying.</p>
<p>adviceMode=aspectJ, compile-time weaving You should incorporate<br>
aspectJ instrumentation during a build process in your build scripts.</p>
<p>adviceMode=aspectJ, load-time weaving Instrumentation is performed on<br>
runtime. You have to put the aspectj agent as jvm parameter.</p>
<p>Using aspectJ is more powerful and probably more performant. It is<br>
also less invasive in terms of restrictions put on the classes you<br>
want to be transactional. However, proxy mode is simple Spring’s out<br>
of the box solution.</p>
</blockquote>
<p>基本上静态织入的 AspectJ 的性能最好（我们大多数时候都习惯使用 compile-time-weaving，但其实 AspectJ 还支持 load-time-weaving），但平时我们用得最多的还是 cglib 生成的 proxy（因为 Spring 会自动帮我们决策最优的方案）。</p>
<h2 id="enableaspectjautoproxy">@EnableAspectJAutoProxy</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">// 这个注解本身和 aspectj 没什么必然关系（使用它并不一定带来编译时增强），倒是没有它 @Aspect 注解不能生效</span><br><span class="hljs-meta">@EnableAspectJAutoProxy</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> FooService <span class="hljs-title function_">fooService</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FooService</span>();<br>     &#125;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyAspect <span class="hljs-title function_">myAspect</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAspect</span>();<br>     &#125;<br> &#125;<br><br><br><span class="hljs-comment">// 如果没有 @bean 工厂方法，则这里必须加上 @Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAspect</span> &#123;<br>     <span class="hljs-meta">@Before(&quot;execution(* FooService+.*(..))&quot;)</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">advice</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-comment">// advise FooService methods as appropriate</span><br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure>
<p>web application context 和 DispatcherServlet application contexts 是两个 context，需要单独声明 @EnableAspectJAutoProxy at multiple levels。</p>
<h2 id="enablewebmvc">@EnableWebMvc</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebMvc</span><br><span class="hljs-meta">@ComponentScan(</span><br><span class="hljs-meta">       basePackageClasses = &#123; MyConfiguration.class &#125;,</span><br><span class="hljs-meta">       excludeFilters = &#123; @Filter(type = FilterType.ANNOTATION, value = Configuration.class) &#125;</span><br><span class="hljs-meta">)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebMvcConfigurerAdapter</span> &#123;<br><br>       <span class="hljs-meta">@Override</span><br>       <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addFormatters</span><span class="hljs-params">(FormatterRegistry formatterRegistry)</span> &#123;<br>               formatterRegistry.addConverter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyConverter</span>());<br>       &#125;<br><br>       <span class="hljs-meta">@Override</span><br>       <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureMessageConverters</span><span class="hljs-params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;<br>               converters.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyHttpMessageConverter</span>());<br>       &#125;<br><br>       <span class="hljs-comment">// @Override methods ...</span><br><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="contextconfiguration">ContextConfiguration</h2>
<p><code>spring-test</code>特有,<code>ContextConfiguration</code> 要和<code>@Configuration</code>或者<code>@Component</code>配合使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@TestPropertySource(&quot;/foo.properties&quot;)</span><br><span class="hljs-meta">@ContextConfiguration(classes = &#123;AppConfig.class, DatabaseConfig.class&#125;)</span><br><span class="hljs-meta">@TestPropertySource(properties = &#123;&quot;foo=bar&quot;&#125;)</span><br><span class="hljs-comment">// SpringBoot 特有</span><br><span class="hljs-meta">@SpringBootTest(properties = &#123;&quot;foo=bar&quot;&#125;, classes = SpringBootPropertiesTestApplication.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span> MyBean myBean;<br><br>    <span class="hljs-meta">@Autowired</span> DataSource dataSource;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// assertions against myBean ...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="propertysource">@PropertySource</h2>
<p>property 跨上下文继承的关系见<a target="_blank" rel="noopener" href="https://www.baeldung.com/properties-with-spring">《Properties with Spring and Spring Boot》</a>。<br>
<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config">《官方的列表》</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br> <span class="hljs-meta">@PropertySource(&quot;classpath:/com/acme/app.properties&quot;)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>     <span class="hljs-meta">@Inject</span> Environment env;<br><br>     <span class="hljs-meta">@Bean</span><br>     <span class="hljs-keyword">public</span> MyBean <span class="hljs-title function_">myBean</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBean</span>(env.getProperty(<span class="hljs-string">&quot;bean.name&quot;</span>));<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure>
<h2 id="componentscan">@ComponentScan</h2>
<p>它指定的扫描属性依赖于 basePackageClasses()/basePackages() (or its alias value()。</p>
<h2 id="环境-api">环境 API</h2>
<p>环境 API 意味着对 properties 和 profile 的建模，<code>Environment</code>接口扩展了<code>PropertyResolver</code>接口。</p>
<p>参考<a target="_blank" rel="noopener" href="http://blog.zollty.com/b/archive/spring-property-configuration-loading-and-use-process-and-the-initialization-process-of-environment.html">《Spring的Property配置加载和使用过程及Environment的初始化过程<br>
》</a>：</p>
<blockquote>
<p>首先，PropertySource其实就是包装的具体配置，跟Properties差不多。</p>
<p>而PropertyResolver，就是用于对PropertySource进行特殊处理，比如解析holder、转换值的类型等。</p>
<p>Spring启动时，默认会new一个StandardEnvironment，这个类里面就默认添加了两个PropertySource（SystemProperties和SystemEnvironment，分别对应System.getenv和System.getProperty）</p>
<p>注意，可能是为了使用方便，Environment实现了PropertyResolver接口。</p>
</blockquote>
<p>每一个参数，但凡可以用-D 动态传入，也应该可以使用环境变量，甚至 JNDI 的配置，其相对顺序参考<a target="_blank" rel="noopener" href="https://topic.alibabacloud.com/a/spring-boot-configuration-priority-order_8_8_30371727.html">《Spring Boot Configuration Priority order》</a>：</p>
<ol>
<li>command-line arguments.</li>
<li>The Java system parameters obtained through System.getproperties ().</li>
<li>Operating system environment variables.</li>
<li>The JNDI attribute obtained from java:comp/env.</li>
<li>The “random.*” property generated by Randomvaluepropertysource.</li>
<li>Apply the properties file outside of the Jar file . (via</li>
<li>spring.config.location parameter)</li>
<li>Apply the properties file inside the Jar file.</li>
<li>A property file that is declared through the “@PropertySource”</li>
<li>annotation in the application Configuration Java class (the Java</li>
<li>class that contains the “@Configuration” annotations).</li>
<li>The default property declared by the “Springapplication.setdefaultproperties”.</li>
</ol>
<h3 id="在-java-中获取环境变量：环境变量system-getenv-或者-environment-getenv">在 java 中获取环境变量：环境变量System.getenv() 或者 environment.getenv()</h3>
<p>System.getenv() 方法是获取指定的环境变量的值。它有两种方法，一种是接收参数为任意字符串，当存在指定环境变量时即返回环境变量的值，否则返回null。另外一种是不接受参数，那么返回的是所有的环境变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 接收参数为任意字符串</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getenv</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">sm</span> <span class="hljs-operator">=</span> getSecurityManager();<br>        <span class="hljs-keyword">if</span> (sm != <span class="hljs-literal">null</span>) &#123;<br>            sm.checkPermission(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimePermission</span>(<span class="hljs-string">&quot;getenv.&quot;</span>+name));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ProcessEnvironment.getenv(name);<br>    &#125;<br><br><span class="hljs-comment">// 不接受参数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> java.util.Map&lt;String,String&gt; <span class="hljs-title function_">getenv</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">sm</span> <span class="hljs-operator">=</span> getSecurityManager();<br>        <span class="hljs-keyword">if</span> (sm != <span class="hljs-literal">null</span>) &#123;<br>            sm.checkPermission(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimePermission</span>(<span class="hljs-string">&quot;getenv.*&quot;</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ProcessEnvironment.getenv();<br>    &#125;<br></code></pre></td></tr></table></figure>
<h3 id="在-java-中获取属性：system-getproperty-或者-environment-getproperty">在 java 中获取属性：System.getProperty() 或者 environment.getProperty()</h3>
<p>获取系统的相关属性，包括文件编码、操作系统名称、区域、用户名等，此属性一般由jvm自动获取，不能设置。这个必须接受一个String类型的参数，返回值的类型也是String，如果想获取所有的系统的相关属性值可以使用System.getProperties（）</p>
<blockquote>
<p>java.version    Java 运行时环境版本<br>
java.vendor Java 运行时环境供应商<br>
java.vendor.url Java 供应商的 URL<br>
java.home   Java 安装目录<br>
java.vm.specification.version   Java 虚拟机规范版本<br>
java.vm.specification.vendor    Java 虚拟机规范供应商<br>
<a target="_blank" rel="noopener" href="http://java.vm.specification.name">java.vm.specification.name</a>  Java 虚拟机规范名称<br>
java.vm.version Java 虚拟机实现版本<br>
java.vm.vendor  Java 虚拟机实现供应商<br>
<a target="_blank" rel="noopener" href="http://java.vm.name">java.vm.name</a>    Java 虚拟机实现名称<br>
java.specification.version  Java 运行时环境规范版本<br>
java.specification.vendor   Java 运行时环境规范供应商<br>
<a target="_blank" rel="noopener" href="http://java.specification.name">java.specification.name</a> Java 运行时环境规范名称<br>
java.class.version  Java 类格式版本号<br>
java.class.path Java 类路径<br>
java.library.path   加载库时搜索的路径列表<br>
java.io.tmpdir  默认的临时文件路径<br>
java.compiler   要使用的 JIT 编译器的名称<br>
java.ext.dirs   一个或多个扩展目录的路径<br>
<a target="_blank" rel="noopener" href="http://os.name">os.name</a> 操作系统的名称<br>
os.arch 操作系统的架构<br>
os.version  操作系统的版本<br>
file.separator  文件分隔符（在 UNIX 系统中是“/” ）<br>
path.separator  路径分隔符（在 UNIX 系统中是“:” ）<br>
line.separator  行分隔符（在 UNIX 系统中是“/n” ）<br>
<a target="_blank" rel="noopener" href="http://user.name">user.name</a>   用户的账户名称<br>
user.home   用户的主目录<br>
user.dir    用户的当前工作目录</p>
</blockquote>
<p>对应的命令行用法是<code>java -jar jarName -DpropertyName=value</code>，如<code>java -Djavadoop.database.password=admin4321 -jar app.jar</code>。</p>
<p>参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/javJoker/p/7262840.html">《System.getenv()和System.getProperty() 的区别》</a>。</p>
<h3 id="profile-的定义">profile 的定义</h3>
<blockquote>
<p>a named, logical group of bean definitions to be registered with the<br>
container only if the given profile is active</p>
</blockquote>
<p>和 Configuration 类似，用来聚合 bean。<strong>与之相对应地，maven 中的 profile 就是用来聚合配置用的</strong>。一旦被注册进了某个 profile，则 bean 不会轻易地被默认激活。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Profile(&quot;dev&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DevDatasourceConfig</span><br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Profile(&quot;!dev&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DevDatasourceConfig</span><br><br><span class="hljs-comment">// 程序式地激活 profile 的方法</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyWebApplicationInitializer</span> <br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebApplicationInitializer</span> &#123;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStartup</span><span class="hljs-params">(ServletContext servletContext)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>  <br>        servletContext.setInitParameter(<br>          <span class="hljs-string">&quot;spring.profiles.active&quot;</span>, <span class="hljs-string">&quot;dev&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ConfigurableEnvironment env;<br>...<br>env.setActiveProfiles(<span class="hljs-string">&quot;someProfile&quot;</span>);<br><br>&lt;context-param&gt;<br>    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;<br>    &lt;param-value&gt;/WEB-INF/app-config.xml&lt;/param-value&gt;<br>&lt;/context-param&gt;<br>&lt;context-param&gt;<br>    &lt;param-name&gt;spring.profiles.active&lt;/param-name&gt;<br>    &lt;param-value&gt;dev&lt;/param-value&gt;<br>&lt;/context-param&gt;<br><br>-Dspring.profiles.active=dev<br>export spring_profiles_active=dev<br></code></pre></td></tr></table></figure>
<h3 id="properties-的例子">properties 的例子</h3>
<blockquote>
<p>properties files, JVM system properties, system environment variables,<br>
JNDI, servlet context parameters, ad-hoc Properties objects, Maps, and<br>
so on.</p>
</blockquote>
<p>所有的 properties 都由<code>PropertySourcesPlaceholderConfigurer</code>对<code>${}</code>进行注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span> Environment env;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MyBean <span class="hljs-title function_">myBean</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MyBean</span> <span class="hljs-variable">myBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyBean</span>();<br>        myBean.setName(env.getProperty(<span class="hljs-string">&quot;bean.name&quot;</span>));<br>        <span class="hljs-keyword">return</span> myBean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="aware-接口">Aware 接口</h2>
<ul>
<li>ApplicationContextAware</li>
<li>ApplicationEventPublisherAware</li>
<li>BeanClassLoaderAware</li>
<li>BeanFactoryAware</li>
<li>BeanNameAware</li>
<li>BootstrapContextAware</li>
<li>EmbeddedValueResolverAware</li>
<li>EnvironmentAware</li>
<li>ImportAware</li>
<li>LoadTimeWeaverAware</li>
<li>MessageSourceAware</li>
<li>NotificationPublisherAware</li>
<li>ResourceLoaderAware</li>
<li>SchedulerContextAware</li>
<li>ServletConfigAware</li>
<li>ServletContextAware</li>
</ul>
<h2 id="propertysourcesplaceholderconfigurer">PropertySourcesPlaceholderConfigurer</h2>
<p>其中PropertyPlaceholderConfigurer是Spring3.1之前使用的。<br>
PropertySourcesPlaceholderConfigurer是Spring3.1之后使用的。</p>
<p>有了这个机制，才能让特定的 .properties 注入到特定的 xml 占位符里面。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-comment">&lt;!-- bean 形式 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;propertyConfigurer&quot;</span><span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;location&quot;</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>conf/sqlmap/jdbc.properties<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;fileEncoding&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;propertyConfigurer&quot;</span><span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;locations&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/WEB-INF/mail.properties<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>  <br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>classpath: conf/sqlmap/jdbc.properties<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>//注意这两种value值的写法<br>     <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- spring容器中最多只能定义一个context:property-placeholder!(spring和springmvc不是同一容器，PropertyPlaceholderConfigurer可以同时存在于spring和springmvc中 --&gt;</span><br><span class="hljs-comment">&lt;!-- context attribute 形式，这种形式更优于 bean 的形式 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath*:/WEB-INF/mail.properties&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>
<p>PropertySourcesPlaceholderConfigurer本质上是一个BeanFactoryPostProcessor。解析XML的流程在BeanFactoryPostProcessor之前， 优先将配置文件的路径以及名字通过Setter传入PropertySourcesPlaceholderConfigurer。</p>
<p>如上BeanFactoryPostProcessor的优先级又优于其余的Bean。因此可以实现在bean初始化之前的注入。</p>
<p>参考：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qyp199312/article/details/54313784">《Spring PropertySourcesPlaceholderConfigurer工作原理》</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a3c7ff0de5ac">《Spring 常用的两种PropertyPlaceholderConfigurer》</a> 基本还是 MergedProperties 那一套。</li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ba84993d2f06">《Spring Properties Loader》</a></li>
</ol>
<h2 id="xml-配置">xml 配置</h2>
<p><code>annotation-config</code>等字符串实际上指的是一个 element 的 attribute。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:mvc</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">            http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">            http://www.springframework.org/schema/mvc</span></span><br><span class="hljs-string"><span class="hljs-tag">            http://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>  <span class="hljs-attr">profile</span>=<span class="hljs-string">&quot;dev&quot;</span>&gt;</span><br><br>     <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.xh.spring.aop&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">context:include-filter</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;annotation&quot;</span> </span><br><span class="hljs-tag">                 <span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;org.aspectj.lang.annotation.Aspect&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">context:exclude-filter</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;annotation&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;org.springframework.stereotype.Controller&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">context:exclude-filter</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;annotation&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;org.springframework.web.bind.annotation.RestController&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">context:component-scan</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">ignore-unresolvable</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath*:/base.properties,classpath:database.properties&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:annotation-driven</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!-- proxy-target-class属性值决定是基于接口的还是基于类的代理被创建。如果proxy-target-class 属性值被设置为true，那么基于类的代理将起作用（这时需要cglib库）。如果proxy-target-class属值被设置为false或者这个属性被省略，那么标准的JDK 基于接口的代理。高版本spring自动根据运行类有没有实现特定接口选择JDK或CGLIB代理，我们无需设置proxy-target-class属性，JDK动态代理是模拟接口实现的方式，cglib是模拟子类继承的方式，一般采用前者，因为前者效率高。后者不建议使用。--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">aop:config</span> <span class="hljs-attr">proxy-target-class</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">aop:aspect</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;log&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;logHandler&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;printLog&quot;</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">&quot;execution(* cn.sw.study.common.test.spring.aop.service..*(..))&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">aop:before</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;LogBefore&quot;</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">&quot;printLog&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">aop:after</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;LogAfter&quot;</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">&quot;printLog&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">aop:aspect</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">aop:config</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.acme.AppConfig&quot;</span>/&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- PropertiesFactoryBean 也可以支持 @Value：@Value(&quot;#&#123;propBean[&#x27;filePath&#x27;]&#125;&quot;)或者@Value(&quot;#&#123;propBean.filePath&#125;&quot;) --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;propBean&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.beans.factory.config.PropertiesFactoryBean&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;locations&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 事务管理 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">&quot;transactionManager&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transactionManager&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">&quot;routingDatasource&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 引用其它配置文件 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;a.xml&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;b.xml&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;springmvc-web.xml&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span>/&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span>/&gt;</span><br><span class="hljs-comment">&lt;!-- @Value(&quot;$&#123;filePath&#125;&quot;) --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;classpath*:/WEB-INF/mail.properties&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>
<h2 id="responsebody">@ResponseBody</h2>
<p>表示该方法的返回结果直接写入HTTP response body中，一般在异步获取数据时使用，在使用@RequestMapping后，返回值通常解析为跳转路径，</p>
<p>加上@responsebody后返回结果不会被解析为跳转路径，而是直接写入HTTP response body中；比如异步获取json数据，加上@responsebody后，会直接返回json数据；</p>
<h2 id="requestbody">@RequestBody</h2>
<p>参数前加上这个注解之后，认为该参数必填。表示接受json字符串转为对象 List等；</p>
<h2 id="qualifier">@Qualifier</h2>
<p>当有多个同一类型的Bean时，可以用@Qualifier(“name”)来指定。与@Autowired配合使用</p>
<h2 id="autowired">@Autowired</h2>
<p>按照类型（byType）装配依赖对象，默认情况下它要求依赖对象必须存在，如果允许null值，可以设置它的required属性为false。如果我们想使用按照名称（byName）来装配，可以结合@Qualifier注解一起使用。(通过类型匹配找到多个candidate,在没有@Qualifier、@Primary注解的情况下，会使用对象名作为最后的fallback匹配)。</p>
<h2 id="resource">@Resource</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource(name=”name”,type=”type”)</span><br></code></pre></td></tr></table></figure>
<p>默认按照ByName自动注入，由J2EE提供，需要导入包javax.annotation.Resource。@Resource有两个重要的属性：name和type，而Spring将@Resource注解的name属性解析为bean的名字，而type属性则解析为bean的类型。所以，如果使用name属性，则使用byName的自动注入策略，而使用type属性时则使用byType自动注入策略。如果既不制定name也不制定type属性，这时将通过反射机制使用byName自动注入策略。</p>
<h2 id="requestmapping">@RequestMapping</h2>
<p>RequestMapping是一个用来处理请求地址映射的注解，可用于类或方法上。用于类上，表示类中的所有响应请求的方法都是以该地址作为父路径；</p>
<p>params:指定request中必须包含某些参数值是，才让该方法处理。<br>
headers:指定request中必须包含某些指定的header值，才能让该方法处理请求。<br>
value:指定请求的实际地址，指定的地址可以是URI Template 模式<br>
method:指定请求的method类型， GET、POST、PUT、DELETE等<br>
consumes:指定处理请求的提交内容类型（Content-Type），如application/json,text/html;<br>
produces:指定返回的内容类型，仅当request请求头中的(Accept)类型中包含该指定类型才返回。</p>
<p>它还有其他语法糖：@GetMapping、@PostMapping</p>
<h2 id="requestparam">@RequestParam</h2>
<p>用在方法的参数前面。相当于 request.getParameter；</p>
<h2 id="pathvariable">@PathVariable</h2>
<p>路径变量。如 RequestMapping(“user/get/mac/{macAddress}”) ；</p>
<p>public String getByMacAddress(<br>
@PathVariable(“macAddress”) String macAddress){<br>
//do something;<br>
}<br>
参数与大括号里的名字相同的话，注解后括号里的内容可以不填。</p>
<h2 id="controlleradvice">@ControllerAdvice</h2>
<p>@ControllerAdvice是一个特殊的 @Component，用于标识一个类，这个类中被以下三种注解标识的方法：@ExceptionHandler，@InitBinder，@ModelAttribute，将作用于所有的@Controller类的接口上。这三种方法，可以被认为是三种 advice。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@ControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionAdvice</span> &#123;<br>    <span class="hljs-comment">// 注册属性编辑器，对HTTP请求参数进行处理，再绑定到对应的接口，比如格式化的时间转换等。应用于单个@Controller类的方法上时，仅对该类里的接口有效。与@ControllerAdvice组合使用可全局生效。</span><br>    <span class="hljs-meta">@InitBinder</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleException</span><span class="hljs-params">(WebDataBinder binder)</span> &#123;<br>        binder.addCustomFormatter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateFormatter</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br>    &#125;<br>    <br>    <span class="hljs-comment">// 统一异常处理，也可以指定要处理的异常类型</span><br>    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.OK)</span><br>    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception ex)</span> &#123;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-number">400</span>);<br>        map.put(<span class="hljs-string">&quot;msg&quot;</span>, ex.toString());<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 一个 advice 类里可以有多个 handleException 映射</span><br>&#125;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicController</span> &#123;<br>    <br>    <span class="hljs-meta">@GetMapping(value = &quot;index&quot;)</span><br>    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">index</span><span class="hljs-params">(<span class="hljs-meta">@ModelAttribute(&quot;user&quot;)</span> String user)</span> &#123;<br>        <span class="hljs-comment">//...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="delegatingfilterproxy">DelegatingFilterProxy</h2>
<p>过滤器，它指向一个bean，这个bean在spring中的名字为testBean，testBean也必需实现javax.servlet.Filter。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>testFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>  <br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>targetBeanName<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>  <br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>testBean<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>  <br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextAttribute<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>  <br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>session<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>  <br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>targetFilterLifecycle<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>  <br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>        <br><span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>testFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h1>JPA 特性</h1>
<p><img src="JPA%E6%B3%A8%E8%A7%A3%E5%BC%8F%E9%85%8D%E7%BD%AE.png" alt="JPA注解式配置"><br>
<a href="JPA%E6%B3%A8%E8%A7%A3%E5%BC%8F%E9%85%8D%E7%BD%AE.xmind">JPA注解式配置.xmind</a></p>
<h2 id="table">@Table</h2>
<p>@Table(name=”“)<br>
表明这是一个实体类。一般用于jpa ，这两个注解一般一块使用，但是如果表名和实体类名相同的话，@Table可以省略；</p>
<h2 id="mappedsuperclass">@MappedSuperClass</h2>
<p>用在确定是父类的entity上。父类的属性子类可以继承；</p>
<h2 id="norepositorybean">@NoRepositoryBean</h2>
<p>一般用作父类的repository，有这个注解，spring不会去实例化该repository；</p>
<h2 id="column">@Column</h2>
<p>如果字段名与列名相同，则可以省略；</p>
<h2 id="id">@Id</h2>
<p>表示该属性为主键；</p>
<h2 id="generatedvalue">@GeneratedValue</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GeneratedValue(strategy=GenerationType.SEQUENCE,generator = “repair_seq”)</span><br></code></pre></td></tr></table></figure>
<p>表示主键生成策略是sequence（可以为Auto、IDENTITY、native等，Auto表示可在多个数据库间切换），指定sequence的名字是repair_seq；</p>
<p>参考<a href="https://magicliang.github.io/2018/05/29/JPA-%E7%9A%84-id-%E7%94%9F%E6%88%90%E7%AD%96%E7%95%A5/">《JPA 的 id 生成策略》</a>。</p>
<h2 id="sequencegeneretor">@SequenceGeneretor</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SequenceGeneretor(name = “repair_seq”, sequenceName = “seq_repair”, allocationSize = 1)</span><br></code></pre></td></tr></table></figure>
<p>name为sequence的名称，以便使用，sequenceName为数据库的 sequence 名称，两个名称可以一致；</p>
<p>要底层的 RDBMS 能够支持 sequence 功能。</p>
<h2 id="transient">@Transient</h2>
<p>表示该属性并非一个到数据库表的字段的映射,ORM框架将忽略该属性.</p>
<p>如果一个属性并非数据库表的字段映射,就务必将其标示为@Transient,否则,ORM框架默认其注解为@Basic；</p>
<h2 id="basic-fetch-fetchtype-lazy">@Basic(fetch=FetchType.LAZY)</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Basic(fetch=FetchType.LAZY)</span><br></code></pre></td></tr></table></figure>
<p>标记可以指定实体属性的加载方式；</p>
<h2 id="jsonignore">@JsonIgnore</h2>
<p>作用是json序列化时将java bean中的一些属性忽略掉,序列化和反序列化都受影响</p>
<h2 id="joincolumn-name-loginid">@JoinColumn(name=”loginId”)</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@JoinColumn(name=”loginId”)</span><br></code></pre></td></tr></table></figure>
<p>一对一：本表中指向另一个表的外键。<br>
一对多：另一个表指向本表的外键。</p>
<h2 id="表之间的映射">表之间的映射</h2>
<p>对应Hibernate配置文件中的一对一，一对多，多对一。</p>
<p>哪一边是 owning side 很重要。</p>
<h3 id="onetoone">OneToOne</h3>
<h4 id="implementing-with-a-foreign-key-in-jpa">Implementing with a Foreign Key in JPA</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;users&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>     <br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.AUTO)</span><br>    <span class="hljs-meta">@Column(name = &quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">//... </span><br> <br>    <span class="hljs-meta">@OneToOne(cascade = CascadeType.ALL)</span><br>    <span class="hljs-meta">@JoinColumn(name = &quot;address_id&quot;, referencedColumnName = &quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Address address;<br> <br>    <span class="hljs-comment">// ... getters and setters</span><br>&#125;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;address&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> &#123;<br> <br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.AUTO)</span><br>    <span class="hljs-comment">// The address side of the relationship is called the non-owning side. </span><br>    <span class="hljs-meta">@Column(name = &quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">//...</span><br> <br>    <span class="hljs-meta">@OneToOne(mappedBy = &quot;address&quot;)</span><br>    <span class="hljs-keyword">private</span> User user;<br> <br>    <span class="hljs-comment">//... getters and setters</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="implementing-with-a-shared-primary-key-in-jpa">Implementing with a Shared Primary Key in JPA</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;users&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br> <br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.AUTO)</span><br>    <span class="hljs-meta">@Column(name = &quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br> <br>    <span class="hljs-comment">//...</span><br> <br>    <span class="hljs-meta">@OneToOne(mappedBy = &quot;user&quot;, cascade = CascadeType.ALL)</span><br>    <span class="hljs-keyword">private</span> Address address;<br> <br>    <span class="hljs-comment">//... getters and setters</span><br>&#125;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;address&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> &#123;<br> <br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@Column(name = &quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br> <br>    <span class="hljs-comment">//...</span><br> <br>    <span class="hljs-meta">@OneToOne</span><br>    <span class="hljs-comment">// @MapsId tells Hibernate to use the id column of address as both primary key and foreign key. Also, notice that the @Id column of the Address entity no longer uses the @GeneratedValue annotation.</span><br>    <span class="hljs-meta">@MapsId</span><br>    <span class="hljs-keyword">private</span> User user;<br>    <br>    <span class="hljs-comment">//... getters and setters</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="modeling-with-a-join-table">Modeling with a Join Table</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;employee&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> &#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.AUTO)</span><br>    <span class="hljs-meta">@Column(name = &quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br> <br>    <span class="hljs-comment">//...</span><br> <br>    <span class="hljs-meta">@OneToOne(cascade = CascadeType.ALL)</span><br>    <span class="hljs-meta">@JoinTable(name = &quot;emp_workstation&quot;, </span><br><span class="hljs-meta">      joinColumns = </span><br><span class="hljs-meta">        &#123; @JoinColumn(name = &quot;employee_id&quot;, referencedColumnName = &quot;id&quot;) &#125;,</span><br><span class="hljs-meta">      inverseJoinColumns = </span><br><span class="hljs-meta">        &#123; @JoinColumn(name = &quot;workstation_id&quot;, referencedColumnName = &quot;id&quot;) &#125;)</span><br>    <span class="hljs-keyword">private</span> WorkStation workStation;<br> <br>    <span class="hljs-comment">//... getters and setters</span><br>&#125;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name = &quot;workstation&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkStation</span> &#123;<br> <br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.AUTO)</span><br>    <span class="hljs-meta">@Column(name = &quot;id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long id;<br> <br>    <span class="hljs-comment">//...</span><br> <br>    <span class="hljs-meta">@OneToOne(mappedBy = &quot;workStation&quot;)</span><br>    <span class="hljs-keyword">private</span> Employee employee;<br> <br>    <span class="hljs-comment">//... getters and setters</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="onetomany">@OneToMany</h3>
<p>As stated in the JPA specification under section 2.9, <strong>it’s a good practice to mark many-to-one side as the owning side.</strong></p>
<h4 id="平凡解决方案">平凡解决方案</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name=&quot;CART&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cart</span> &#123;<br> <br>    <span class="hljs-comment">//...</span><br> <br>    <span class="hljs-meta">@OneToMany(mappedBy=&quot;cart&quot;)</span><br>    <span class="hljs-keyword">private</span> Set&lt;Items&gt; items;<br>     <br>    <span class="hljs-comment">// getters and setters</span><br>&#125;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-meta">@Table(name=&quot;ITEMS&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Items</span> &#123;<br>     <br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-meta">@ManyToOne</span><br>    <span class="hljs-meta">@JoinColumn(name=&quot;cart_id&quot;, nullable=false)</span><br>    <span class="hljs-keyword">private</span> Cart cart;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Items</span><span class="hljs-params">()</span> &#123;&#125;<br>     <br>    <span class="hljs-comment">// getters and setters</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="cart-as-the-owning-side">Cart as the Owning Side</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemsOIO</span> &#123;<br>    <span class="hljs-comment">//  ...</span><br>    <span class="hljs-meta">@ManyToOne</span><br>    <span class="hljs-meta">@JoinColumn(name = &quot;cart_id&quot;, insertable = false, updatable = false)</span><br>    <span class="hljs-keyword">private</span> CartOIO cart;<br>    <span class="hljs-comment">//..</span><br>&#125;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CartOIO</span> &#123;<br>    <span class="hljs-comment">//..  </span><br>    <span class="hljs-meta">@OneToMany</span><br>    <span class="hljs-meta">@JoinColumn(name = &quot;cart_id&quot;)</span> <span class="hljs-comment">// we need to duplicate the physical information</span><br>    <span class="hljs-keyword">private</span> Set&lt;ItemsOIO&gt; items;<br>    <span class="hljs-comment">//..</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="manytoone">@ManyToOne</h3>
<p>缺，来日补上</p>
<h3 id="manytomany">@ManyToMany</h3>
<h4 id="普通映射">普通映射</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Entity</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br> <br>    <span class="hljs-meta">@Id</span><br>    Long id;<br> <br>    <span class="hljs-meta">@ManyToMany</span><br>    <span class="hljs-meta">@JoinTable(</span><br><span class="hljs-meta">  name = &quot;course_like&quot;, </span><br><span class="hljs-meta">  joinColumns = @JoinColumn(name = &quot;student_id&quot;), </span><br><span class="hljs-meta">  inverseJoinColumns = @JoinColumn(name = &quot;course_id&quot;))</span><br>    Set&lt;Course&gt; likedCourses;<br> <br>    <span class="hljs-comment">// additional properties</span><br>    <span class="hljs-comment">// standard constructors, getters, and setters</span><br>&#125;<br> <br><span class="hljs-meta">@Entity</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Course</span> &#123;<br> <br>    <span class="hljs-meta">@Id</span><br>    Long id;<br> <br>    <span class="hljs-meta">@ManyToMany</span><br>    Set&lt;Student&gt; likes;<br> <br>    <span class="hljs-comment">// additional properties</span><br>    <span class="hljs-comment">// standard constructors, getters, and setters</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="joining-table">Joining Table</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Embeddable</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseRatingKey</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br> <br>    <span class="hljs-meta">@Column(name = &quot;student_id&quot;)</span><br>    Long studentId;<br> <br>    <span class="hljs-meta">@Column(name = &quot;course_id&quot;)</span><br>    Long courseId;<br> <br>    <span class="hljs-comment">// standard constructors, getters, and setters</span><br>    <span class="hljs-comment">// hashcode and equals implementation</span><br>&#125;<br><br><span class="hljs-meta">@Entity</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseRating</span> &#123;<br> <br>    <span class="hljs-meta">@EmbeddedId</span><br>    CourseRatingKey id;<br> <br>    <span class="hljs-meta">@ManyToOne</span><br>    <span class="hljs-meta">@MapsId(&quot;student_id&quot;)</span><br>    <span class="hljs-meta">@JoinColumn(name = &quot;student_id&quot;)</span><br>    Student student;<br> <br>    <span class="hljs-meta">@ManyToOne</span><br>    <span class="hljs-meta">@MapsId(&quot;course_id&quot;)</span><br>    <span class="hljs-meta">@JoinColumn(name = &quot;course_id&quot;)</span><br>    Course course;<br> <br>    <span class="hljs-type">int</span> rating;<br>     <br>    <span class="hljs-comment">// standard constructors, getters, and setters</span><br>    <br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br> <br>    <span class="hljs-comment">// ...</span><br> <br>    <span class="hljs-meta">@OneToMany(mappedBy = &quot;student&quot;)</span><br>    Set&lt;CourseRating&gt; ratings;<br> <br>    <span class="hljs-comment">// ...</span><br>&#125;<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Course</span> &#123;<br> <br>    <span class="hljs-comment">// ...</span><br> <br>    <span class="hljs-meta">@OneToMany(mappedBy = &quot;course&quot;)</span><br>    Set&lt;CourseRating&gt; ratings;<br> <br>    <span class="hljs-comment">// ...</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1>Spring Boot 特性</h1>
<p>Spring Boot 在扫描类路径的时候扫到特定的包的时候，会自动激活事务管理、Spring MVC 等功能。</p>
<h2 id="springbootapplication">@SpringBootApplication</h2>
<p>自带其他自动化配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@SpringBootConfiguration</span><br><span class="hljs-meta">@EnableAutoConfiguration</span><br><span class="hljs-meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="hljs-meta">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SpringBootApplication &#123;&#125;<br></code></pre></td></tr></table></figure>
<h2 id="enableautoconfiguration">@EnableAutoConfiguration</h2>
<p>打开这个配置后，可以通过扫描类路径、配置文件自动打开某些配置。<br>
必须配合 @Configuration 使用。</p>
<h2 id="transactionautoconfiguration">TransactionAutoConfiguration</h2>
<p>spring-boot 不需要打开 @EnableTransactionManagement。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">// 一个隐藏起来的 @Configuration 也可以激活事务管理</span><br><span class="hljs-meta">@ConditionalOnMissingBean(AbstractTransactionManagementConfiguration.class)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionManagementConfiguration</span> &#123;<br>&#125;<br><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnClass(PlatformTransactionManager.class)</span><br><span class="hljs-meta">@AutoConfigureAfter(&#123; JtaAutoConfiguration.class, HibernateJpaAutoConfiguration.class,</span><br><span class="hljs-meta">        DataSourceTransactionManagerAutoConfiguration.class, Neo4jDataAutoConfiguration.class &#125;)</span><br><span class="hljs-meta">@EnableConfigurationProperties(TransactionProperties.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionAutoConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-keyword">public</span> TransactionManagerCustomizers <span class="hljs-title function_">platformTransactionManagerCustomizers</span><span class="hljs-params">(</span><br><span class="hljs-params">            ObjectProvider&lt;PlatformTransactionManagerCustomizer&lt;?&gt;&gt; customizers)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionManagerCustomizers</span>(customizers.orderedStream().collect(Collectors.toList()));<br>    &#125;<br><br>    <span class="hljs-meta">@Configuration</span><br>    <span class="hljs-meta">@ConditionalOnSingleCandidate(PlatformTransactionManager.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionTemplateConfiguration</span> &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PlatformTransactionManager transactionManager;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">TransactionTemplateConfiguration</span><span class="hljs-params">(PlatformTransactionManager transactionManager)</span> &#123;<br>            <span class="hljs-built_in">this</span>.transactionManager = transactionManager;<br>        &#125;<br><br>        <span class="hljs-meta">@Bean</span><br>        <span class="hljs-meta">@ConditionalOnMissingBean(TransactionOperations.class)</span><br>        <span class="hljs-keyword">public</span> TransactionTemplate <span class="hljs-title function_">transactionTemplate</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionTemplate</span>(<span class="hljs-built_in">this</span>.transactionManager);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Configuration</span><br>    <span class="hljs-meta">@ConditionalOnBean(PlatformTransactionManager.class)</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean(AbstractTransactionManagementConfiguration.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnableTransactionManagementConfiguration</span> &#123;<br><br>        <span class="hljs-meta">@Configuration</span><br>        <span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = false)</span><br>        <span class="hljs-meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;,</span><br><span class="hljs-meta">                matchIfMissing = false)</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkDynamicAutoProxyConfiguration</span> &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Configuration</span><br>        <span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = true)</span><br>        <span class="hljs-meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;,</span><br><span class="hljs-meta">                matchIfMissing = true)</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibAutoProxyConfiguration</span> &#123;<br><br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="org-springframework-boot-autoconfigure-condition">org.springframework.boot.autoconfigure.condition</h2>
<p>这个包下面的注解都带有一个元注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Conditional(OnJavaCondition.class)</span><br></code></pre></td></tr></table></figure>
<p>Spring 自己有一套条件体系：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">OnJavaCondition <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SpringBootCondition</span><br>SpringBootCondition <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Condition</span><br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://www.1024sky.cn/blog/article/615">《自定义 condition 的例子》</a></p>
<p>这些注解可以放在 @Bean、@Component、乃至于一堆 bean （@Configuration）上。</p>
<h3 id="conditionalonbean">@ConditionalOnBean</h3>
<p>在早期版本有 bug，参考<a target="_blank" rel="noopener" href="http://hengyunabc.github.io/spring-placeholder-inject-failed-cases/">《深入Spring Boot：那些注入不了的Spring占位符（${}表达式）》</a>。</p>
<p>仅仅在当前上下文中存在某个 bean 时，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConditionalOnBean(name=&quot;redisTemplate&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisOperBean</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisTemplate redisTemplate;<br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisOperBean</span><span class="hljs-params">(RedisTemplate redisTemplate)</span> &#123;<br>      <span class="hljs-comment">// ...</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonclass">@ConditionalOnClass</h3>
<p>只有类路径里存在特定的 class 的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnClass(DependedClz.class)</span><br><span class="hljs-keyword">public</span> LoadIfClzExists <span class="hljs-title function_">loadIfClzExists</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadIfClzExists</span>(<span class="hljs-string">&quot;dependedClz&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionaloncloudplatform">@ConditionalOnCloudPlatform</h3>
<p>只在特定的云平台是活动的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">CLOUD_FOUNDRY<br>HEROKU<br>KUBERNETES<br>SAP<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonexpression">@ConditionalOnExpression</h3>
<p>当表达式为true的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.roytuts.spring.conditional.on.expression;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnExpression(value = &quot;$&#123;module.enabled&#125; and $&#123;module.submodule.enabled&#125;&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Module <span class="hljs-title function_">module</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Module</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">module.enabled</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">module.submodule.enabled</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure>
<h3 id="conditionalonjava">@ConditionalOnJava</h3>
<p>只有遇到特定的 JVM version，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean(name = &quot;websocketContainerCustomizer&quot;)</span><br><span class="hljs-meta">@ConditionalOnJava(JavaVersion.SEVEN)</span><br><span class="hljs-keyword">public</span> TomcatWebSocketContainerCustomizer <span class="hljs-title function_">websocketContainerCustomizer</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TomcatWebSocketContainerCustomizer</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonjndi">@ConditionalOnJndi</h3>
<p>只有 jndi 路径上有特定的资源的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnJndi(&quot;java:comp/env/foo&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OnJndiModule</span> &#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonmissingbean">@ConditionalOnMissingBean</h3>
<p>仅仅在当前上下文中不存在某个 bean 时，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean(name = &quot;notExistsBean&quot;)</span><br><span class="hljs-keyword">public</span> LoadIfBeanNotExists <span class="hljs-title function_">loadIfBeanNotExists</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadIfBeanNotExists</span>(<span class="hljs-string">&quot;notExistsBean&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonmissingclass">@ConditionalOnMissingClass</h3>
<p>class不存在时，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingClass(&quot;com.git.hui.boot.conditionbean.example.depends.clz.DependedClz&quot;)</span><br><span class="hljs-keyword">public</span> LoadIfClzNotExists <span class="hljs-title function_">loadIfClzNotExists</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadIfClzNotExists</span>(<span class="hljs-string">&quot;com.git.hui.boot.conditionbean.example.depends.clz.DependedClz&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonnotwebapplication">@ConditionalOnNotWebApplication</h3>
<p>只有 application context 不是一个 web application context 时，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.roytuts.spring.conditional.on.web.notweb.application;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnWebApplication</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfigOnWebNotWebApp</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Module <span class="hljs-title function_">module</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Module</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonproperty">@ConditionalOnProperty</h3>
<p>特定的属性有特定的值的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">//在application.properties配置&quot;mf.assert&quot;，对应的值为true</span><br><span class="hljs-meta">@ConditionalOnProperty(prefix=&quot;mf&quot;,name = &quot;assert&quot;, havingValue = &quot;true&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AssertConfig</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HelloServiceProperties helloServiceProperties;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> HelloService <span class="hljs-title function_">helloService</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">HelloService</span> <span class="hljs-variable">helloService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelloService</span>();<br>        helloService.setMsg(helloServiceProperties.getMsg());<br>        <span class="hljs-keyword">return</span> helloService;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonresource">@ConditionalOnResource</h3>
<p>只有特定的（非 JNDI）资源存在的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConditionalOnResource(resources = &quot;classpath:example.json&quot;)</span><br><span class="hljs-meta">@Bean</span><br>ExampleService <span class="hljs-title function_">exampleService</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    System.out.println(<span class="hljs-string">&quot;Creating bean of example json from example.json...&quot;</span>);<br><br>    File file=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;example.json&quot;</span>, <span class="hljs-built_in">this</span>.getClass().getClassLoader()).getFile();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExampleService</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Files.readAllBytes(Paths.get(file.toURI()))));<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonsinglecandidate">@ConditionalOnSingleCandidate</h3>
<p>类似 ConditionalOnBean，但要求全局只有一个 bean，或者可以决策出 primary bean 的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnEnabledInfoContributor(&quot;git&quot;)</span><br><span class="hljs-meta">@ConditionalOnSingleCandidate(GitProperties.class)</span><br><span class="hljs-meta">@ConditionalOnMissingBean</span><br><span class="hljs-meta">@Order(DEFAULT_ORDER)</span><br><span class="hljs-keyword">public</span> GitInfoContributor <span class="hljs-title function_">gitInfoContributor</span><span class="hljs-params">(GitProperties gitProperties)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GitInfoContributor</span>(gitProperties, <span class="hljs-built_in">this</span>.properties.getGit().getMode());<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonwebapplication">@ConditionalOnWebApplication</h3>
<p>和 @ConditionalOnNotWebApplication 正相反。<br>
只有 application context 是一个 web application context 时，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConditionalOnWebApplication</span><br>HealthCheckController <span class="hljs-title function_">healthCheckController</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="conditionalonclass">@ConditionalOnClass</h3>
<p>只有存在一个特定的类的时候，才会初始化一个 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnClass(DataSource.class)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLAutoconfiguration</span> &#123;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="configurationproperties">@ConfigurationProperties</h2>
<p>Spring Boot 有个更复杂的属性加载顺序，见<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config">《2. Externalized Configuration》</a>：</p>
<ol>
<li>Devtools global settings properties in the $HOME/.config/spring-boot folder when devtools is active.</li>
<li>@TestPropertySource annotations on your tests.</li>
<li>properties attribute on your tests. Available on @SpringBootTest and the test annotations for testing a particular slice of your application.</li>
<li>Command line arguments</li>
<li>Properties from SPRING_APPLICATION_JSON (inline JSON embedded in an environment variable or system property).</li>
<li>ServletConfig init parameters.</li>
<li>ServletContext init parameters.</li>
<li>JNDI attributes from java:comp/env.</li>
<li>Java System properties (System.getProperties()).</li>
<li>OS environment variables.</li>
<li>A RandomValuePropertySource that has properties only in random.*.</li>
<li>Profile-specific application properties outside of your packaged jar (application-{profile}.properties and YAML variants).</li>
<li>Profile-specific application properties packaged inside your jar (application-{profile}.properties and YAML variants).</li>
<li>Application properties outside of your packaged jar (application.properties and YAML variants).</li>
<li>Application properties packaged inside your jar (application.properties and YAML variants).</li>
<li>@PropertySource annotations on your @Configuration classes. Please note that such property sources are not added to the Environment until the application context is being refreshed. This is too late to configure certain properties such as logging.* and spring.main.* which are read before refresh begins.</li>
<li>Default properties (specified by setting SpringApplication.setDefaultProperties).</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;javadoop.database&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataBase</span> &#123;<br>String url;<br>String username;<br>String password;<br><span class="hljs-comment">// getters and setters</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="惰性加载">惰性加载</h2>
<blockquote>
<p>By default, ApplicationContext implementations eagerly create and<br>
configure all singleton beans as part of the initialization process.<br>
Generally, this pre-instantiation is desirable, because errors in the<br>
configuration or surrounding environment are discovered immediately,<br>
as opposed to hours or even days later. When this behavior is not<br>
desirable, you can prevent pre-instantiation of a singleton bean by<br>
marking the bean definition as lazy-initialized. A lazy-initialized<br>
bean tells the IoC container to create a bean instance when it is<br>
first requested, rather than at startup.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">lazy-initialization:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<h3 id="随机值">随机值</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 由 RandomValuePropertySource 提供</span><br><span class="hljs-string">random.number=$&#123;random.int&#125;</span><br><span class="hljs-string">random.long=$&#123;random.long&#125;</span><br><span class="hljs-string">random.uuid=$&#123;random.uuid&#125;</span><br></code></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://magicliang.github.io">magicliang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://magicliang.github.io/2020/03/29/Java-%E6%B3%A8%E8%A7%A3%E5%92%8C%E9%85%8D%E7%BD%AE/">https://magicliang.github.io/2020/03/29/Java-%E6%B3%A8%E8%A7%A3%E5%92%8C%E9%85%8D%E7%BD%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/JPA/">JPA</a><a class="post-meta__tags" href="/tags/Spring/">Spring</a></div><div class="post-share"><div class="social-share" data-image="/img/wall-paper-179.jpeg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2018/05/29/JPA-%E7%9A%84-id-%E7%94%9F%E6%88%90%E7%AD%96%E7%95%A5/" title="JPA 的 id 生成策略"><img class="cover" src="/img/wall-paper-149.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-05-29</div><div class="info-item-2">JPA 的 id 生成策略</div></div><div class="info-2"><div class="info-item-1">JPA 有一个@GeneratedValue注解，有一个strategy attribute，如 @GeneratedValue(strategy = GenerationType.IDENTITY)。 常见的可选策略主要有IDENTITY和SEQUENCE。 GenerationType.IDENTITY 要求底层有一个 integer 或者 bigint 类型的自增列（ auto-incremented column)。自增列的赋值必须在插入操作之后发生，因为这个原因，Hibernate 无法进行各种优化（特别是 JDBC 的 batch 处理，一次 flush 操作会产生很多条insert 语句，分别执行）。如果事务回滚，自增列的值就会被丢弃。数据库在这个自增操作上有个高度优化的轻量级锁机制，性能非常棒。 MySQL 支持这种 id 生成策略， 使用 MySQL 应该尽量使用这个策略，即使它无法优化。 JPA 用它生成 id，会一条一条地插入新的 entity。 GenerationType.SEQUENCE 数据库有一个所谓的 sequence 对象，可以通过 selec...</div></div></div></a><a class="pagination-related" href="/2020/04/05/Spring-AOP-%E7%AC%94%E8%AE%B0/" title="Spring AOP 笔记"><img class="cover" src="/2020/04/05/Spring-AOP-%E7%AC%94%E8%AE%B0/spring-aop-proxy-creation.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-05</div><div class="info-item-2">Spring AOP 笔记</div></div><div class="info-2"><div class="info-item-1">AOP 全景概览 核心问题定义 面向切面编程（Aspect-Oriented Programming，AOP）的核心目标是将横切关注点（Cross-cutting Concerns）从业务逻辑中分离出来。横切关注点是指那些散布在系统多个模块中的通用功能，如日志记录、事务管理、安全检查、性能监控等。在传统的面向对象编程中，这些功能往往需要在多个类中重复实现，导致代码冗余和耦合度增加。AOP 通过将这些横切关注点模块化为切面（Aspect），在不修改原有业务逻辑代码的情况下，实现对目标对象的增强。 核心概念速查表    概念 定义     Aspect 切面，横跨多个类的模块化关注点，通常由多个 Pointcut 和 Advice 组成   JoinPoint 连接点，程序执行过程中的特定位置，在 Spring AOP 中通常指方法执行点   Pointcut 切点，匹配 JoinPoint 的谓词表达式，定义 Advice 在何处执行   Advice 通知，切面在特定 JoinPoint 执行的动作，包括 Before、After、Around、AfterReturning、Af...</div></div></div></a><a class="pagination-related" href="/2020/04/20/Spring-%E6%A6%82%E8%A7%88/" title="Spring 概览"><img class="cover" src="/2020/04/20/Spring-%E6%A6%82%E8%A7%88/spring-framework-architecture.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-20</div><div class="info-item-2">Spring 概览</div></div><div class="info-2"><div class="info-item-1">Spring 起源于 2003 年，它作为 Java EE 平台规范的补充，而不是完全拥抱 specification。 Spring 可以指的是 entire family of projects。也可以单指 Spring Framework（换言之，Spring Framework 本身也只是 family 的一部分）。 Spring Framework 被模块化了，它的核心只包括 core container（主要解决依赖注入问题）。但是针对不同的应用架构，它提供不同的支持，包括 messaging、transactionl、persistence 和 web。这些模块原本命名为 “spring-core” 和 “spring-context”，在 Java 9 的 jigsaw 项目来临之时，也开始支持 module path，生成“自动模块名”清单项，并且定义语言级别的模块名，如&quot;spring.core&quot;、“spring.context”。 Spring 支持的 JSR 有：  Servlet API (JSR 340) WebSocket API ...</div></div></div></a><a class="pagination-related" href="/2020/07/19/Spring-IOC/" title="Spring IOC"><img class="cover" src="/2020/07/19/Spring-IOC/spring-ioc-hiarachy.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-19</div><div class="info-item-2">Spring IOC</div></div><div class="info-2"><div class="info-item-1">总体的类图 spring-Ioc     Bean 工厂提供 IOC 基本功能，Context 是全功能的 BeanFactory，是应用程序的全部上下文。 扩展点和生命周期钩子 Spring的扩展点.xmind    加载顺序：  获取工厂 准备工厂 后处理工厂 InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation，返回 object。 构造器 InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation，返回布尔值。 populateBean（注入 @Autowired，类内第一个方法），实际上调用的是 InstantiationAwareBeanPostProcessor.postProcessProperties InitializingBean:  各类 aware 方法注入 BeanPostProcessor.postProcessBeforeInitialization 的后处理器(@PostConsstruct) a...</div></div></div></a><a class="pagination-related" href="/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" title="Spring 与数据库"><img class="cover" src="/2020/07/19/Spring-%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93/TransactionAspectSupport.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-19</div><div class="info-item-2">Spring 与数据库</div></div><div class="info-2"><div class="info-item-1">Java 执行事务的过程  1.获取连接 Connection con = DriverManager.getConnection() 2.开启事务con.setAutoCommit(true/false); 在 Spring 事务里（如 DataSourceTransactionManager 的 doBegin 方法）里，总是会显式地 con.setAutoCommit(false);（不然哪有事务可言）。 3.执行CRUD 4.提交事务/回滚事务 con.commit() / con.rollback(); 5.关闭连接 conn.close();  本文涉及到的类型的类图    Spring 的事务管理核心类型和流程 DataSource 不同的数据源诞生不同的 DataSource。默认的 TransactionManager 本身是期待一个名叫“datasource”的数据源的。 FactoryBean 不同的 DataSource 装入不同的 FactoryBean，比如 JPA 的 EntityManagerFactory。 PlatformTransaction...</div></div></div></a><a class="pagination-related" href="/2020/08/02/%E5%B8%B8%E8%A7%81%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88/" title="常见的服务器调用堆栈"><img class="cover" src="/img/wall-paper-48.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-02</div><div class="info-item-2">常见的服务器调用堆栈</div></div><div class="info-2"><div class="info-item-1">自顶向下调用 $是内部类的意思 $$是由 Lambda 生成的内部类的意思。当然 Spring 的 CGLIB 可以自己控制 naming pattern。 内部类生成的类名后往往带有一个数字，这个数字表示编译器生成这个内部类的顺序  Thread.run() ThreadPoolExecutor$Worker.run() ThreadPoolExecutor.runWorker() Netty.DefaultServerHandler.run() Netty.DefaultServerHandler.handleRequest() ThriftServerPublisher$MTProccessor.process() Thrift 接口$Processor.方法名() com.sun.proxy$Proxy 数字.方法名() XXXServiceImpl$$EnhancerBySpringCGLIB$$1fb0b39f.被拦截的方法 ThriftInvoker.invoker() RhinoLimiterFilter.filter() ThriftInvoker.invoke...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Java 的原生注解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#meta-annotation"><span class="toc-number">1.1.</span> <span class="toc-text">meta annotation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#inherited"><span class="toc-number">1.1.1.</span> <span class="toc-text">@Inherited</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#websocket-%E6%B3%A8%E8%A7%A3%E7%9B%B8%E5%85%B3%E7%9A%84%E4%BA%89%E8%AE%BA"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">WebSocket 注解相关的争论</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%85%83%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.1.2.</span> <span class="toc-text">其他元注解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Spring 原生的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#xml-%E7%9A%84%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">xml 的模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%A6%E6%9C%89-name-%E7%9A%84%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.2.</span> <span class="toc-text">带有 name 的注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configuration"><span class="toc-number">2.3.</span> <span class="toc-text">@Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enableasync"><span class="toc-number">2.4.</span> <span class="toc-text">@EnableAsync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enablescheduling"><span class="toc-number">2.5.</span> <span class="toc-text">@EnableScheduling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enabletransactionmanagement"><span class="toc-number">2.6.</span> <span class="toc-text">@EnableTransactionManagement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enableaspectjautoproxy"><span class="toc-number">2.7.</span> <span class="toc-text">@EnableAspectJAutoProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enablewebmvc"><span class="toc-number">2.8.</span> <span class="toc-text">@EnableWebMvc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#contextconfiguration"><span class="toc-number">2.9.</span> <span class="toc-text">ContextConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#propertysource"><span class="toc-number">2.10.</span> <span class="toc-text">@PropertySource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#componentscan"><span class="toc-number">2.11.</span> <span class="toc-text">@ComponentScan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83-api"><span class="toc-number">2.12.</span> <span class="toc-text">环境 API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-java-%E4%B8%AD%E8%8E%B7%E5%8F%96%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%9A%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fsystem-getenv-%E6%88%96%E8%80%85-environment-getenv"><span class="toc-number">2.12.1.</span> <span class="toc-text">在 java 中获取环境变量：环境变量System.getenv() 或者 environment.getenv()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-java-%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7%EF%BC%9Asystem-getproperty-%E6%88%96%E8%80%85-environment-getproperty"><span class="toc-number">2.12.2.</span> <span class="toc-text">在 java 中获取属性：System.getProperty() 或者 environment.getProperty()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#profile-%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">2.12.3.</span> <span class="toc-text">profile 的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#properties-%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">2.12.4.</span> <span class="toc-text">properties 的例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aware-%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.13.</span> <span class="toc-text">Aware 接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#propertysourcesplaceholderconfigurer"><span class="toc-number">2.14.</span> <span class="toc-text">PropertySourcesPlaceholderConfigurer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xml-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.15.</span> <span class="toc-text">xml 配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#responsebody"><span class="toc-number">2.16.</span> <span class="toc-text">@ResponseBody</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requestbody"><span class="toc-number">2.17.</span> <span class="toc-text">@RequestBody</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qualifier"><span class="toc-number">2.18.</span> <span class="toc-text">@Qualifier</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#autowired"><span class="toc-number">2.19.</span> <span class="toc-text">@Autowired</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#resource"><span class="toc-number">2.20.</span> <span class="toc-text">@Resource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requestmapping"><span class="toc-number">2.21.</span> <span class="toc-text">@RequestMapping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requestparam"><span class="toc-number">2.22.</span> <span class="toc-text">@RequestParam</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pathvariable"><span class="toc-number">2.23.</span> <span class="toc-text">@PathVariable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controlleradvice"><span class="toc-number">2.24.</span> <span class="toc-text">@ControllerAdvice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#delegatingfilterproxy"><span class="toc-number">2.25.</span> <span class="toc-text">DelegatingFilterProxy</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">JPA 特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#table"><span class="toc-number">3.1.</span> <span class="toc-text">@Table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mappedsuperclass"><span class="toc-number">3.2.</span> <span class="toc-text">@MappedSuperClass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#norepositorybean"><span class="toc-number">3.3.</span> <span class="toc-text">@NoRepositoryBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#column"><span class="toc-number">3.4.</span> <span class="toc-text">@Column</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#id"><span class="toc-number">3.5.</span> <span class="toc-text">@Id</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#generatedvalue"><span class="toc-number">3.6.</span> <span class="toc-text">@GeneratedValue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sequencegeneretor"><span class="toc-number">3.7.</span> <span class="toc-text">@SequenceGeneretor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#transient"><span class="toc-number">3.8.</span> <span class="toc-text">@Transient</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#basic-fetch-fetchtype-lazy"><span class="toc-number">3.9.</span> <span class="toc-text">@Basic(fetch&#x3D;FetchType.LAZY)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jsonignore"><span class="toc-number">3.10.</span> <span class="toc-text">@JsonIgnore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#joincolumn-name-loginid"><span class="toc-number">3.11.</span> <span class="toc-text">@JoinColumn(name&#x3D;”loginId”)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E6%98%A0%E5%B0%84"><span class="toc-number">3.12.</span> <span class="toc-text">表之间的映射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#onetoone"><span class="toc-number">3.12.1.</span> <span class="toc-text">OneToOne</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#implementing-with-a-foreign-key-in-jpa"><span class="toc-number">3.12.1.1.</span> <span class="toc-text">Implementing with a Foreign Key in JPA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#implementing-with-a-shared-primary-key-in-jpa"><span class="toc-number">3.12.1.2.</span> <span class="toc-text">Implementing with a Shared Primary Key in JPA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#modeling-with-a-join-table"><span class="toc-number">3.12.1.3.</span> <span class="toc-text">Modeling with a Join Table</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onetomany"><span class="toc-number">3.12.2.</span> <span class="toc-text">@OneToMany</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E5%87%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.12.2.1.</span> <span class="toc-text">平凡解决方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cart-as-the-owning-side"><span class="toc-number">3.12.2.2.</span> <span class="toc-text">Cart as the Owning Side</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#manytoone"><span class="toc-number">3.12.3.</span> <span class="toc-text">@ManyToOne</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#manytomany"><span class="toc-number">3.12.4.</span> <span class="toc-text">@ManyToMany</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%98%A0%E5%B0%84"><span class="toc-number">3.12.4.1.</span> <span class="toc-text">普通映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#joining-table"><span class="toc-number">3.12.4.2.</span> <span class="toc-text">Joining Table</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">Spring Boot 特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#springbootapplication"><span class="toc-number">4.1.</span> <span class="toc-text">@SpringBootApplication</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enableautoconfiguration"><span class="toc-number">4.2.</span> <span class="toc-text">@EnableAutoConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#transactionautoconfiguration"><span class="toc-number">4.3.</span> <span class="toc-text">TransactionAutoConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#org-springframework-boot-autoconfigure-condition"><span class="toc-number">4.4.</span> <span class="toc-text">org.springframework.boot.autoconfigure.condition</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonbean"><span class="toc-number">4.4.1.</span> <span class="toc-text">@ConditionalOnBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonclass"><span class="toc-number">4.4.2.</span> <span class="toc-text">@ConditionalOnClass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionaloncloudplatform"><span class="toc-number">4.4.3.</span> <span class="toc-text">@ConditionalOnCloudPlatform</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonexpression"><span class="toc-number">4.4.4.</span> <span class="toc-text">@ConditionalOnExpression</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonjava"><span class="toc-number">4.4.5.</span> <span class="toc-text">@ConditionalOnJava</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonjndi"><span class="toc-number">4.4.6.</span> <span class="toc-text">@ConditionalOnJndi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonmissingbean"><span class="toc-number">4.4.7.</span> <span class="toc-text">@ConditionalOnMissingBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonmissingclass"><span class="toc-number">4.4.8.</span> <span class="toc-text">@ConditionalOnMissingClass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonnotwebapplication"><span class="toc-number">4.4.9.</span> <span class="toc-text">@ConditionalOnNotWebApplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonproperty"><span class="toc-number">4.4.10.</span> <span class="toc-text">@ConditionalOnProperty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonresource"><span class="toc-number">4.4.11.</span> <span class="toc-text">@ConditionalOnResource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonsinglecandidate"><span class="toc-number">4.4.12.</span> <span class="toc-text">@ConditionalOnSingleCandidate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonwebapplication"><span class="toc-number">4.4.13.</span> <span class="toc-text">@ConditionalOnWebApplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditionalonclass"><span class="toc-number">4.4.14.</span> <span class="toc-text">@ConditionalOnClass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configurationproperties"><span class="toc-number">4.5.</span> <span class="toc-text">@ConfigurationProperties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%83%B0%E6%80%A7%E5%8A%A0%E8%BD%BD"><span class="toc-number">4.6.</span> <span class="toc-text">惰性加载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E5%80%BC"><span class="toc-number">4.6.1.</span> <span class="toc-text">随机值</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2017 - 2026 By magicliang</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">簡</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/js/tw_cn.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="/"></script></div></body></html>