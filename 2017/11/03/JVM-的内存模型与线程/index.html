<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>JVM 的内存模型与线程 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="JVM 的内存模型与线程 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="1.性能何处寻&amp;emsp;&amp;emsp;计算机的CPU比起其他所有的设备，都快得多，所以怎样尽量复用 CPU 的时间片，是压榨计算机性能的目标。多核和并发，使得阿姆达尔定律大显神威，超越摩尔定律成为提升系统性能的金科玉律 - 现在单核计算能力已经无法垂直提升，要水平提升核数来提升整体性能。 2.缓存一致性问题（Cache Coherence）&amp;emsp;&amp;emsp;软件缓存，不过是硬件缓存的模仿，真 - magicliang - 守株阁"><meta name="keywords" content="JVM, 多线程, 内存"><meta property="article:published_time" content="2017-11-03T15:11:14.000Z"><meta property="article:modified_time" content="2021-10-09T08:25:22.000Z"><meta property="og:updated_time" content="2021-10-09T08:25:22.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="JVM, 多线程, 内存"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/"
    },
    "headline": "JVM 的内存模型与线程 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2017-11-03T15:11:14.000Z",
    "dateModified": "2021-10-09T08:25:22.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "JVM, 多线程, 内存",
    "description": "1.性能何处寻&amp;amp;emsp;&amp;amp;emsp;计算机的CPU比起其他所有的设备，都快得多，所以怎样尽量复用 CPU 的时间片，是压榨计算机性能的目标。多核和并发，使得阿姆达尔定律大显神威，超越摩尔定律成为提升系统性能的金科玉律 - 现在单核计算能力已经无法垂直提升，要水平提升核数来提升整体性能。 2.缓存一致性问题（Cache Coherence）&amp;amp;emsp;&amp;amp;emsp;软件缓存，不过是硬件缓存的模仿，真 - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=JVM 的内存模型与线程" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=JVM 的内存模型与线程&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=JVM 的内存模型与线程" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMQAAADECAAAAADlzdG3AAADJ0lEQVR42u3a207DMBBF0f7/T8MTEgI8Z4+dSQDtvlQ0TeOF5MtcXm//4PUSIUKECBHjiFfx+rj+7WbwnfLhxf2fP6vGJULEJGL1IIpIg/vpfTVwOi4RIqYRabJ9vbYaUJqgBIPHJULEA4jV9QpKN7LVgiFCxG9GrDaf1d8VZudQKULEU4jqoJUOZ6ughQY35PlHp1gRIpoIkih44v3ybIcIEQBBEl1VgiBN2M4iMJYVFyGiWZ9YBf80cba6t/pe9WwaTIkQMYGoJlsKcNKkpwMnC0nc7ESIuAjRnWidBFv3N2hiWoSISQTFkKIInZQpiZauiRBxJyIFLXTzqgIkUshEm6EIEcMIUjTsFEVS0b7zz8ITW4SIQ0RKepEfqw5w3SYw0tgiQsQkoirydTaidACsDpmrz+L3RYgYRHSD/J1mLLJhthqARYgYQJDCYWoWSSiSXEsJtR/HJkLEEKJTNE8P6CbKOhNbhIg7Eal5kQ4wLQ47z8AdBSJEXIQgzYOdZAFt9q2CsJQkECFiCtFJAKTGQ4rdWRS2u2xEiNhApMQAmdCdxpMqoZbuFyHiLkRnYpFmLIomB8Tl4iBCxBAiHQA7DVXpAFglpenhU4SIOxBVwqBTpKebGMHEBUKEiAFEt2EkFSNJo0kKrEiwJkLEFKJKKqfJmAZKC4pkgREh4m4ESeB2mk1IwFUtDqmgKULEFAIFH/BQtpNISAmGdoeyCBEXItIEJc0pJImWmrrS90SImESkpC0t2FcFGdLUQgIltGOLEHGIoMmrhKIFfJJcw0lsESIGEZ0CSqd4SJu76AExBkUiRBwiukUUWoRJTS4k8RZ/X4SIIQRtZEwFwxRodYqQqCAjQsQAIh3EOgXHkwaV1KgSk2ciRFyEoMXxVCAkxZedxsdqAxQhYgKRmgd3BkYGSoMfESKeQHQmdGcBSAUVsjlud56JEHGIqA5bKaFGBkUbV9L9ywygCBE3IbrBPmk6IQEQOhCKEPEw4rSoUi0K9MC5tdmJELGBSMUS2oSbCuydRsa4eIgQMYSgSdy0me0kjKuiTUxMixAxgPjLLxEiRIgQMfZ6B0ZSXlussVt2AAAAAElFTkSuQmCC" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">JVM 的内存模型与线程</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2017-11-03</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=JVM 的内存模型与线程&url=http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=JVM 的内存模型与线程&url=http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2017/11/03/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMQAAADECAAAAADlzdG3AAADJ0lEQVR42u3a207DMBBF0f7/T8MTEgI8Z4+dSQDtvlQ0TeOF5MtcXm//4PUSIUKECBHjiFfx+rj+7WbwnfLhxf2fP6vGJULEJGL1IIpIg/vpfTVwOi4RIqYRabJ9vbYaUJqgBIPHJULEA4jV9QpKN7LVgiFCxG9GrDaf1d8VZudQKULEU4jqoJUOZ6ughQY35PlHp1gRIpoIkih44v3ybIcIEQBBEl1VgiBN2M4iMJYVFyGiWZ9YBf80cba6t/pe9WwaTIkQMYGoJlsKcNKkpwMnC0nc7ESIuAjRnWidBFv3N2hiWoSISQTFkKIInZQpiZauiRBxJyIFLXTzqgIkUshEm6EIEcMIUjTsFEVS0b7zz8ITW4SIQ0RKepEfqw5w3SYw0tgiQsQkoirydTaidACsDpmrz+L3RYgYRHSD/J1mLLJhthqARYgYQJDCYWoWSSiSXEsJtR/HJkLEEKJTNE8P6CbKOhNbhIg7Eal5kQ4wLQ47z8AdBSJEXIQgzYOdZAFt9q2CsJQkECFiCtFJAKTGQ4rdWRS2u2xEiNhApMQAmdCdxpMqoZbuFyHiLkRnYpFmLIomB8Tl4iBCxBAiHQA7DVXpAFglpenhU4SIOxBVwqBTpKebGMHEBUKEiAFEt2EkFSNJo0kKrEiwJkLEFKJKKqfJmAZKC4pkgREh4m4ESeB2mk1IwFUtDqmgKULEFAIFH/BQtpNISAmGdoeyCBEXItIEJc0pJImWmrrS90SImESkpC0t2FcFGdLUQgIltGOLEHGIoMmrhKIFfJJcw0lsESIGEZ0CSqd4SJu76AExBkUiRBwiukUUWoRJTS4k8RZ/X4SIIQRtZEwFwxRodYqQqCAjQsQAIh3EOgXHkwaV1KgSk2ciRFyEoMXxVCAkxZedxsdqAxQhYgKRmgd3BkYGSoMfESKeQHQmdGcBSAUVsjlud56JEHGIqA5bKaFGBkUbV9L9ywygCBE3IbrBPmk6IQEQOhCKEPEw4rSoUi0K9MC5tdmJELGBSMUS2oSbCuydRsa4eIgQMYSgSdy0me0kjKuiTUxMixAxgPjLLxEiRIgQMfZ6B0ZSXlussVt2AAAAAElFTkSuQmCC" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-%E6%80%A7%E8%83%BD%E4%BD%95%E5%A4%84%E5%AF%BB"><span class="post-toc-number">1.</span> <span class="post-toc-text">1.性能何处寻</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%EF%BC%88Cache-Coherence%EF%BC%89"><span class="post-toc-number">2.</span> <span class="post-toc-text">2.缓存一致性问题（Cache Coherence）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-JVM-%E7%9A%84%E5%AF%B9%E8%B1%A1%E4%BF%A1%E6%81%AF"><span class="post-toc-number">3.</span> <span class="post-toc-text">3.JVM 的对象信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-%E5%86%85%E5%AD%98%E9%97%B4%EF%BC%88%E4%B8%BB%E5%86%85%E5%AD%98%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AD%98%EF%BC%89%E7%9B%B8%E4%BA%92%E6%93%8D%E4%BD%9C"><span class="post-toc-number">4.</span> <span class="post-toc-text">4.内存间（主内存与工作内存）相互操作</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-volatile%E5%85%B3%E9%94%AE%E5%AD%97"><span class="post-toc-number">5.</span> <span class="post-toc-text">5.volatile关键字</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%9A%84%EF%BC%88Java%EF%BC%89%E7%9A%84%E7%89%B9%E6%80%A7"><span class="post-toc-number">6.</span> <span class="post-toc-text">6.Java内存模型的（Java）的特性</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-1-%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%88Atomicity%EF%BC%89"><span class="post-toc-number">7.</span> <span class="post-toc-text">6.1 原子性（Atomicity）##</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-2-%E5%8F%AF%E8%A7%81%E6%80%A7%EF%BC%88Visibility%EF%BC%89"><span class="post-toc-number">8.</span> <span class="post-toc-text">6.2 可见性（Visibility）##</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-3-%E6%9C%89%E5%BA%8F%E6%80%A7%EF%BC%88Ordering%EF%BC%89"><span class="post-toc-number">9.</span> <span class="post-toc-text">6.3 有序性（Ordering）##</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-4-volatile-%E5%92%8C%E5%90%8C%E6%AD%A5%E5%9D%97%E6%AF%94%E8%BE%83"><span class="post-toc-number">10.</span> <span class="post-toc-text">6.4 volatile 和同步块比较##</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-5-%E5%85%88%E8%A1%8C%E5%8F%91%E7%94%9F%E5%8E%9F%E5%88%99%EF%BC%88happens-before%EF%BC%89"><span class="post-toc-number">11.</span> <span class="post-toc-text">6.5 先行发生原则（happens-before）##</span></a></li></ol></div>
                        
                    
                    <article id="post-content">
                        <h2 id="1-性能何处寻"><a href="#1-性能何处寻" class="headerlink" title="1.性能何处寻"></a>1.性能何处寻</h2><p>&emsp;&emsp;计算机的CPU比起其他所有的设备，都快得多，所以怎样尽量复用 CPU 的时间片，是压榨计算机性能的目标。多核和并发，使得阿姆达尔定律大显神威，超越摩尔定律成为提升系统性能的金科玉律 - 现在单核计算能力已经无法垂直提升，要水平提升核数来提升整体性能。</p>
<h2 id="2-缓存一致性问题（Cache-Coherence）"><a href="#2-缓存一致性问题（Cache-Coherence）" class="headerlink" title="2.缓存一致性问题（Cache Coherence）"></a>2.缓存一致性问题（Cache Coherence）</h2><p>&emsp;&emsp;软件缓存，不过是硬件缓存的模仿，真正的缓存，早已存在于计算机的多级存储体系结构中。JVM 里，我们可以认为每个处理器都会在主内存（Main Memory）之外有高速缓存作为工作内存（Working memory）。除此之外，处理器和 JVM 都可能出现指令重排（Instruction Reorder）的的情况。工作内存是线程 Save 和 Load 的主要场所，主内存则是他们沟通的场所。</p>
<h2 id="3-JVM-的对象信息"><a href="#3-JVM-的对象信息" class="headerlink" title="3.JVM 的对象信息"></a>3.JVM 的对象信息</h2><p>&emsp;&emsp;Java Object 除了基本的内存轮廓以外，还有：</p>
<ol>
<li>Mark Word（对象的 Hash Code 的缓存值、GC标志、GC年龄、同步锁等信息）。</li>
<li>Klass Point（指向对象元数据信息的指针，指向 .class  的指针吗？不是，是指向方法区的类型元数据的指针。.Class文件实际上是那个区域的另一个入口了。）。</li>
<li>padding。如果对象是8位对齐的（也就是最长标量类型对齐的），则不存在padding。</li>
</ol>
<h2 id="4-内存间（主内存与工作内存）相互操作"><a href="#4-内存间（主内存与工作内存）相互操作" class="headerlink" title="4.内存间（主内存与工作内存）相互操作"></a>4.内存间（主内存与工作内存）相互操作</h2><p>&emsp;&emsp;Java内存模型（Java Memory Model）定义了八种内存操作（而不是字节码）。虚拟机在是现实必须保证每一种操作都是原子的、不可再分的（对于 double 和 long 类型的变量来说，load、store、read 和 write 操作在某些平台上可以例外）：</p>
<ol>
<li>lock 把主内存变量为一个线程锁定起来。</li>
<li>unlock 把主内存的变量解锁，这样其他线程才能锁定。</li>
<li>read 把一个变量的值，从主内存读到工作内存里。是 load 指令的前置动作。</li>
<li>load 把read出来的变量，放到工作内存的副本里。</li>
<li>use 把工作内存的值传给工作执行引擎。</li>
<li>assign 把执行引擎里得到的值传给工作内存的变量副本。<strong>它是一种工作内存的局部写。</strong></li>
<li>store 把工作内存中的变量的值传递给主内存。</li>
</ol>
<p>&emsp;&emsp;实际上的执行顺序恐怕是 read-&gt;load-&gt;use-&gt;assign-&gt;store-&gt; write。</p>
<p>&emsp;&emsp;如果要把一个变量从主内存复制到工作内存，那就要按顺序地执行 read 和load 操作，如果要把变量从工作内存同不会主内存，就要执行 store 和 write 操作。 JMM 只要求上述两类操作必须按顺序执行，没有保证必须是连续执行，也就是说在 read 和 load之间、store 和 write 之间是可插入其他指令的。如对主内存的变量 a、b 进行访问的时候，可能出现 read a、read b、load b、load a 的操作顺序。</p>
<p>&emsp;&emsp;除此之外， JVM 还规定了额外的指令执行的偏序规则(正好也有八条)：</p>
<ul>
<li>不允许 read 和 load、store 和 write 操作之一单独出现，即不允许一个变量从主内存读取了但工作内存不接受，或者从工作内存发起了写回但工作内存不接受的情况。</li>
<li>不允许一个线程丢弃它的最近的 assign 操作，即变量在工作内存中发生了改变必须（最终）把该变化同步回主内存里去。</li>
<li>不允许一个线程无原因地（没有发生过任何 assign 操作）把数据从线程的工作内存同步回主内存中。</li>
<li>一个新的变量只能在主内存中“诞生”，不允许在工作内存中直接使用一个未被初始化（load 或者 assign）的变量，换句话说就是对一个变量实施 use 和 store操作之前，必须经过 assign 和 load 的操作。</li>
<li>一个变量在同一个时刻只允许一条线程对它进行 lock 操作，且 lock 操作可以被同一个线程执行多次（多种可重入锁的底层机制就在这里了）。而且只有执行相同数量的 unlock 操作，才能彻底解锁该变量。</li>
<li>如果对一个变量进行 lock 操作，会清空工作内存中此变量的值，在执行引擎使用这个变量前，需要重新执行 load 和 assign 操作。<strong>也就是说，这是一个 flush 加上 reload的过程。</strong></li>
<li>如果一个变量没有被 lock 锁住，则 unlock 非法，只有本线程才能unlock。</li>
<li>对一个变量进行unlock操作之前，必须先把变量同步回主内存中（执行 store 和 write 操作）。也就是说，变量被线程锁住以后，不是在主内存上工作，而是在自己的工作内存里被使用的，<strong>这也印证了上面的八种指令中的 use 必须在 load 之后工作，执行引擎必须使用 use 的印象</strong>。</li>
</ul>
<h2 id="5-volatile关键字"><a href="#5-volatile关键字" class="headerlink" title="5.volatile关键字"></a>5.volatile关键字</h2><p>&emsp;&emsp;volatile 关键字具有可见性，会使得每次写操作，都会导致全flush 的出现（assign必然导致 store 和 write 回主内存），读操作必须read + load至工作内存， use 到执行引擎（而不能只是use上次留在工作内存里的值），必然总是得到最新的值，不管中间是否有不一致的暂时情况发生，读的语义必然是一致正确的。而如果没有这条语义，use得到的值，可能是之前 use 和 assign 得到的值。</p>
<p>&emsp;&emsp;注意，如果使用字节码分析多线程操作，即使只出现一条指令，也不能认为实际执行的机器指令是原子化的，<strong>但如果出现多条字节码指令，那么必然操作没有原子性。</strong>这也是 volatile 修饰的变量只是轻量级同步，不能做到真正互斥原子化的原因。<strong>它只保证了可见性。</strong></p>
<p>&emsp;&emsp;因此，只有两种情况，不必然要使用标准同步机制：</p>
<ol>
<li>远算结果不依赖指定非栈上变量的当前值，或者能够确保单线程修改指定变量的当前值。</li>
<li>变量不需要与其他变量参与同一个不变性约束。</li>
</ol>
<p>&emsp;&emsp;此外，volatile关键字还可以通过插入内存屏障（memory barier）阻止内存指令重排（instruction reorder），阻止特定的赋值顺序被打乱。这点在 Java 5以前是做不到的，也就会经常性导致 Double Check Lock 在 Java 5以前失败。具体地说，相关联的操作是不可重排序的。相关联的read-&gt;load-&gt;use/assign-&gt;store-&gt;write可以看做是不可被重排插入中间指令的，一个指令 read 先于另一个指令 read，那么所有相关联的指令都是前者先于后者。这被称为“线程内表现为穿行语义”（Within-Thread As-If-Serial Semantics）。</p>
<h2 id="6-Java内存模型的（Java）的特性"><a href="#6-Java内存模型的（Java）的特性" class="headerlink" title="6.Java内存模型的（Java）的特性"></a>6.Java内存模型的（Java）的特性</h2><h2 id="6-1-原子性（Atomicity）"><a href="#6-1-原子性（Atomicity）" class="headerlink" title="6.1 原子性（Atomicity）##"></a>6.1 原子性（Atomicity）##</h2><p>&emsp;&emsp;8个操作，read、load、use、assign、store、write这六个操作是必须原子的（64字节的 long、double 非原子性是可以由lock 和 unlock 的更强原子语义包裹起来规避掉的）。lock 和 unlock 操作虽然不是字节码，但几乎同意的 monitoerenter和monitorexit却是字节码指令。</p>
<h2 id="6-2-可见性（Visibility）"><a href="#6-2-可见性（Visibility）" class="headerlink" title="6.2 可见性（Visibility）##"></a>6.2 可见性（Visibility）##</h2><p>&emsp;&emsp;一个线程的修改，立刻可以被另一个线程看到，方法主要有三个：</p>
<ul>
<li>同步块</li>
<li>final （final 并不是不可更改的，所以依然有工作内存修改后flush的问题）</li>
<li>volatile</li>
</ul>
<h2 id="6-3-有序性（Ordering）"><a href="#6-3-有序性（Ordering）" class="headerlink" title="6.3 有序性（Ordering）##"></a>6.3 有序性（Ordering）##</h2><p>&emsp;&emsp;volatile和同步块可以保证这点。方法内的指令不会被重排，是一个特别重要的不会产生特别副作用的保证。</p>
<h2 id="6-4-volatile-和同步块比较"><a href="#6-4-volatile-和同步块比较" class="headerlink" title="6.4 volatile 和同步块比较##"></a>6.4 volatile 和同步块比较##</h2><p>&emsp;&emsp;volatile不具有原子性，其他场景volatile和同步块都可以使用。</p>
<h2 id="6-5-先行发生原则（happens-before）"><a href="#6-5-先行发生原则（happens-before）" class="headerlink" title="6.5 先行发生原则（happens-before）##"></a>6.5 先行发生原则（happens-before）##</h2><p>&emsp;&emsp;JVM 为程序中所有的操作定义了一个偏序关系（偏序关系 π 是集合上的一种关系，据有反对称、自反和传递属性。但对于任意两个元素x，y来说，并不需要一定满足 x π y， y π x的关系。我们每天都在使用偏序关系表达喜好。），称之为 Happens-Before。只有操作 A 和操作 B 之间满足 Happens-Before 关系，才能保证<br>保证操作 B 一定能够看到操作 A 的结果。</p>
<p>&emsp;&emsp;Happens-Before 的八条原则包括：</p>
<ul>
<li>程序顺序原则（Program Order Rule）：在一个线程内，按照程序代码顺序，书写在前面的操作线性发生于书写在后面的操作。这一条并不绝对，首先要考虑控制流循环跳转的问题，其次是，如果后操作无法感知前操作（即不存在依赖关系），则指令重排仍然可能发生。</li>
<li>监视器锁定原则（Monitor Lock Rule）：一个 unlock 操作时间顺序上先行发生于后面对同一个锁的 lock 操作。（单纯的lock 操作语义只提供了可见性，这条原则还保证了有序性。）</li>
<li>volatile 变量原则（volatile variable rule）：对 volatile 变量的写入操作，必须要在读取操作时间顺序之前进行。</li>
<li>线程启动规则（Thread Start Rule）：Thread对象的 start()方法先行发生于此线程的每一个动作。</li>
<li>线程终止规则（Thread Termination Rule）：线程中所有操作，都先行发生于线程的终止检测。常见终止检测是 Thread.join() 的返回，Thread.isAlive()的返回。</li>
<li>线程中断原则（Thread Interruption）：对线程 interrupt() 方法的调用先行发生于被中断线程检测中断事件的发生。常见检测事件的方法是 Thread.interrupted()。</li>
<li>对象终结原则（Finalizer Rule）：一个对象的初始化完成（构造函数执行结束）先行发生于它的 finalize()方法的开始。</li>
<li>传递性（Transitivity） 操作 A 先行发生于操作 B，操作 B 先行发生于操作 C，操作 A 先行发生于操作 C。</li>
</ul>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2021-10-09");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2017-11-03T15:11:14.000Z" itemprop="datePublished">2017-11-03</time>

    , Updated at&nbsp;<time datetime="2021-10-09T08:25:22.000Z" itemprop="dateModified">2021-10-09</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/JVM/" rel="tag">#&nbsp;JVM</a>

<a class="post-tags-list-item" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">#&nbsp;多线程</a>

<a class="post-tags-list-item" href="/tags/%E5%86%85%E5%AD%98/" rel="tag">#&nbsp;内存</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2017/11/09/Java-%E4%B8%8E%E7%BA%BF%E7%A8%8B/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">Java 与线程</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2017/11/02/%E5%A6%82%E4%BD%95%E6%8A%8A-composer-%E9%94%9A%E5%AE%9A%E5%88%B0-e2e-%E7%9A%84%E5%A4%8D%E6%9D%82%E7%BD%91%E7%BB%9C/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">如何把 composer 锚定到 e2e 的复杂网络</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>