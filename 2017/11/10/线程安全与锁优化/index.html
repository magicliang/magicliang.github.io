<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>线程安全与锁优化 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="线程安全与锁优化 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="线程安全什么是线程安全“当多个线程访问一个对象时，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，或者在调用方法进行任何其他的协调操作，调用这个对象的行为都可以获得正确的结果，那么这个对象就是线程安全的。” 相对的线程安全，可以分成五个等级： 线程安全的分类不可变不可变的数据，都是线程安全的。不可变的对象引用，加上所有field都是不可变的。如果有得选，尽量连方法都是f - magicliang - 守株阁"><meta name="keywords" content="JVM, 多线程"><meta property="og:image" content="https://ws1.sinaimg.cn/large/66dd581fly1flsf4024taj20h40a5q5u.jpg"><meta property="og:image" content="https://ws1.sinaimg.cn/large/66dd581fly1flsf43kk1vj20d40abtb2.jpg"><meta property="og:image" content="https://ws1.sinaimg.cn/large/66dd581fly1flsf7eso0hj21380jdn6j.jpg"><meta property="article:published_time" content="2017-11-10T11:51:43.000Z"><meta property="article:modified_time" content="2022-01-08T09:47:07.000Z"><meta property="og:updated_time" content="2022-01-08T09:47:07.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="JVM, 多线程"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/"
    },
    "headline": "线程安全与锁优化 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2017-11-10T11:51:43.000Z",
    "dateModified": "2022-01-08T09:47:07.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "JVM, 多线程",
    "description": "线程安全什么是线程安全“当多个线程访问一个对象时，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，或者在调用方法进行任何其他的协调操作，调用这个对象的行为都可以获得正确的结果，那么这个对象就是线程安全的。” 相对的线程安全，可以分成五个等级： 线程安全的分类不可变不可变的数据，都是线程安全的。不可变的对象引用，加上所有field都是不可变的。如果有得选，尽量连方法都是f - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=线程安全与锁优化" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=线程安全与锁优化&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=线程安全与锁优化" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMQAAADECAAAAADlzdG3AAADLUlEQVR42u3b0U7rQAxF0f7/T8MTUkEdn+3JOBS0+wI3NGlWJWc8tu/j4x+8HiJEiBAhYhzxKF5ff/924o+/Pf87fujivOfzX73n1X2JEDGJIB/48/dX56cvYAWvMKv7EiFiGpGCjVx09SVU11jdOLovESJ+AVEtgCSoV+dXNyxCxDsjSKCuksLqPVWSJ0LEOyDIIlRdeLVBSpAqUTyWxYoQ0UTQALv75/FqhwgRAEEKXmShqwKbBGzafF2qiosQ0exPkEIxWfwSamfjVRUbRIiYRqw28atjpFBMjpECNWqyiBBxANG9QEoOO8ljtzAtQsQdCNJITI3y6oFAE8udZqQIEROICpOKwp3GSQeJF0MRIoYQVUMlNUk6N50Wus6DQYSIOxCkaVIF8S6MNm7KxU6EiIMIMmSYBq/IYkm/MDxEKULEjQg6WJU+qHOcJIuo2iFCxAFESvCqonN380MTvvZiJ0LEIUS6KB0AToUxMtCVitoiREwj0gYo4WiznQzCpIYMnjwTIeICot0ABwsieXUanajJIkLEIQRNwjrB1x1c6SSWsRkvQsRFBFl0aBOeDK90ig6xeC1CxAAibsYf/f8sm4axyLVQY16EiAFECl7SEKyaJrtNGbRZEyFiAEEa62SjT76M3SbN8gEhQsQgIhV36fHOQGQcykoPCBEiBhApiHcbKmng5cowmAgRk4juwBQN4p2hrrQwtgsFIkRsIMhgFdn4kGSOJHiXKoAiRBxAdIdHqqStCsidDVgckBQhYghBApgka6QRSZM78l4RIiYQpBBGbpI2HLsBXxaxRYgYQpDNedUcpI11NHQCG5oiREwiUhKXmiadpgu9UbTAihAxhCBBRoteZCiXBDnahIkQMYCgSR4NxFRQo4knOV+EiAlE56KpKUMbl1XhrhqEFCHiDgRplqTmIkWlJktsNIoQcROCbI5OBHZKNDsNfhEiphFVQNOhFVpQSENd1fmxUyRCxDCCHE8w8hChTUsRIt4BkW6KJHXVDdFic0wARYg4iKgCKDXJaYGgOyzZnrIRIeIQghQKaFJHCwLpwUCuJ0LEBOIvv0SIECFCxNjrE3TzH4wwGiUcAAAAAElFTkSuQmCC" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">线程安全与锁优化</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2017-11-10</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=线程安全与锁优化&url=http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=线程安全与锁优化&url=http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2017/11/10/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMQAAADECAAAAADlzdG3AAADLUlEQVR42u3b0U7rQAxF0f7/T8MTUkEdn+3JOBS0+wI3NGlWJWc8tu/j4x+8HiJEiBAhYhzxKF5ff/924o+/Pf87fujivOfzX73n1X2JEDGJIB/48/dX56cvYAWvMKv7EiFiGpGCjVx09SVU11jdOLovESJ+AVEtgCSoV+dXNyxCxDsjSKCuksLqPVWSJ0LEOyDIIlRdeLVBSpAqUTyWxYoQ0UTQALv75/FqhwgRAEEKXmShqwKbBGzafF2qiosQ0exPkEIxWfwSamfjVRUbRIiYRqw28atjpFBMjpECNWqyiBBxANG9QEoOO8ljtzAtQsQdCNJITI3y6oFAE8udZqQIEROICpOKwp3GSQeJF0MRIoYQVUMlNUk6N50Wus6DQYSIOxCkaVIF8S6MNm7KxU6EiIMIMmSYBq/IYkm/MDxEKULEjQg6WJU+qHOcJIuo2iFCxAFESvCqonN380MTvvZiJ0LEIUS6KB0AToUxMtCVitoiREwj0gYo4WiznQzCpIYMnjwTIeICot0ABwsieXUanajJIkLEIQRNwjrB1x1c6SSWsRkvQsRFBFl0aBOeDK90ig6xeC1CxAAibsYf/f8sm4axyLVQY16EiAFECl7SEKyaJrtNGbRZEyFiAEEa62SjT76M3SbN8gEhQsQgIhV36fHOQGQcykoPCBEiBhApiHcbKmng5cowmAgRk4juwBQN4p2hrrQwtgsFIkRsIMhgFdn4kGSOJHiXKoAiRBxAdIdHqqStCsidDVgckBQhYghBApgka6QRSZM78l4RIiYQpBBGbpI2HLsBXxaxRYgYQpDNedUcpI11NHQCG5oiREwiUhKXmiadpgu9UbTAihAxhCBBRoteZCiXBDnahIkQMYCgSR4NxFRQo4knOV+EiAlE56KpKUMbl1XhrhqEFCHiDgRplqTmIkWlJktsNIoQcROCbI5OBHZKNDsNfhEiphFVQNOhFVpQSENd1fmxUyRCxDCCHE8w8hChTUsRIt4BkW6KJHXVDdFic0wARYg4iKgCKDXJaYGgOyzZnrIRIeIQghQKaFJHCwLpwUCuJ0LEBOIvv0SIECFCxNjrE3TzH4wwGiUcAAAAAElFTkSuQmCC" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="post-toc-number">1.</span> <span class="post-toc-text">线程安全</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">什么是线程安全</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E5%88%86%E7%B1%BB"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">线程安全的分类</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">不可变</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BB%9D%E5%AF%B9%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">绝对线程安全</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%9B%B8%E5%AF%B9%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">相对线程安全</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%85%BC%E5%AE%B9"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">线程兼容</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AF%B9%E7%AB%8B"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">线程对立</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">线程安全的实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BA%92%E6%96%A5%E5%90%8C%E6%AD%A5%EF%BC%88Mutual-Exclusion-amp-Synchronization"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">互斥同步（Mutual Exclusion &amp; Synchronization)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5%EF%BC%88Non-Blocking-Synchronization"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">非阻塞同步（Non-Blocking Synchronization)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%97%A0%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88"><span class="post-toc-number">1.3.3.</span> <span class="post-toc-text">无同步方案</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E4%BB%A3%E7%A0%81%EF%BC%88Reentrant-Code%EF%BC%89"><span class="post-toc-number">1.3.3.1.</span> <span class="post-toc-text">可重入代码（Reentrant Code）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8"><span class="post-toc-number">1.3.3.2.</span> <span class="post-toc-text">线程本地存储</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E9%94%81%E4%BC%98%E5%8C%96"><span class="post-toc-number">2.</span> <span class="post-toc-text">锁优化</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%EF%BC%88Spinning-Lock%EF%BC%89"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">自旋锁（Spinning Lock）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%94%81%E6%B6%88%E9%99%A4%EF%BC%88Lock-Elimination%EF%BC%89"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">锁消除（Lock Elimination）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%94%81%E7%B2%97%E5%8C%96%EF%BC%88Lock-Coarsening%EF%BC%89"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">锁粗化（Lock Coarsening）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%EF%BC%88Lightweight-Lock%EF%BC%89"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">轻量级锁（Lightweight Lock）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81%EF%BC%88Biased-Lock%EF%BC%89"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">偏向锁（Biased Lock）</span></a></li></ol></li></ol></div>
                        
                    
                    <article id="post-content">
                        <h1 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h1><h2 id="什么是线程安全"><a href="#什么是线程安全" class="headerlink" title="什么是线程安全"></a>什么是线程安全</h2><p>“当多个线程访问一个对象时，如果不用考虑这些线程在运行时环境下的调度和交替执行，也不需要进行额外的同步，或者在调用方法进行任何其他的协调操作，调用这个对象的行为都可以获得正确的结果，那么这个对象就是线程安全的。”</p>
<p>相对的线程安全，可以分成五个等级：</p>
<h2 id="线程安全的分类"><a href="#线程安全的分类" class="headerlink" title="线程安全的分类"></a>线程安全的分类</h2><h3 id="不可变"><a href="#不可变" class="headerlink" title="不可变"></a>不可变</h3><p>不可变的数据，都是线程安全的。不可变的对象引用，加上所有field都是不可变的。如果有得选，尽量连方法都是final的。</p>
<h3 id="绝对线程安全"><a href="#绝对线程安全" class="headerlink" title="绝对线程安全"></a>绝对线程安全</h3><p>Vector不是线程安全的。它也会出现并发修改时 Out of Range 的异常（注意，不是 ConcurrentModification 的异常）。</p>
<h3 id="相对线程安全"><a href="#相对线程安全" class="headerlink" title="相对线程安全"></a>相对线程安全</h3><p>需要保证对这个对象的单独操作是线程安全的，在调用的时候不需要加上额外的保障措施。对于特定顺序的连续操作，就需要额外的同步来保证调用的正确性了。</p>
<h3 id="线程兼容"><a href="#线程兼容" class="headerlink" title="线程兼容"></a>线程兼容</h3><p>可以通过特殊手段做到线程安全的普通类，绝大部分类都属于相对线程安全的。</p>
<h3 id="线程对立"><a href="#线程对立" class="headerlink" title="线程对立"></a>线程对立</h3><p>线程对立，是不管调用端是否采取了同步措施，都无法在多线程环境中使用的代码。常见的线程对立的操作还有 suspend()，resume()， System.setIn()，System.setOut()和System.runFinalizerOnExit()。</p>
<h2 id="线程安全的实现"><a href="#线程安全的实现" class="headerlink" title="线程安全的实现"></a>线程安全的实现</h2><h3 id="互斥同步（Mutual-Exclusion-amp-Synchronization"><a href="#互斥同步（Mutual-Exclusion-amp-Synchronization" class="headerlink" title="互斥同步（Mutual Exclusion &amp; Synchronization)"></a>互斥同步（Mutual Exclusion &amp; Synchronization)</h3><p>这是最常见（也是我们在考虑并发问题的时候，首先应该考虑的万能解决方案，也是《Java并发编程实践》和《Thinking in Java 》中最推荐的做法。）的保障并发正确性的手段。同步是指在多个线程并发访问共享数据的时候，保证共享数据在同一个时刻只被一条（使用信号量的话，多条）线程访问。而互斥是实现同步的一种手段，临界区（Critical Section）、互斥量（Mutex）和信号量都是实现互斥的常见方式。互斥是因，同步是果，互斥是方法，同步是目的。这些同步的手段，同样也会出现在 OS 层面上。同步的终极目标，应该是化并发的乱序，转化为类型无并发时的有序。</p>
<p>在 Java 里面，最基本的互斥手段就是 synchronized 关键字。它经过编译后，会转化为 moniterenter 和 moniterexit 这两个字节码指令（bytecode instructions）。这两个字节码都需要一个 reference 类型的参数来指明加锁和解锁的对象。我们当然都知道，这个reference，不是一个平凡对象实例，就是一个 Class 对象了。</p>
<p>根据虚拟机规范，在执行 monitorenter 指令时，首先尝试获取对象的锁（实际上就是去用线程信息写 markword）。如果这个对象没有被锁定，或者当前线程已经拥有了那个对象的锁，那么把锁的计数器加1。相应地，在执行 monitorexit 时，会对计数器减1，当计数器为0时，锁就被释放了。从某种意义上来讲，这种设计可以在分布式场景下用 Redis 实现。如果获取锁失败了，那么就会进入阻塞状态，直到对象锁被释放为止。虚拟机规范对 monitorenter 和 monitorexit 两条指令的行为描述中，有两点是需要特别注意的。<strong>首先，synchronized同步块对同一条线程来说是可重入的，不会出现自己把自己锁死（阻塞）的情况。其次，同步块在已进入的线程执行完之前，会阻塞后面其他线程的进入</strong>对于映射到操作系统原生进程的实现，不管是阻塞还是唤醒线程，都需要操作系统的调用帮忙，也就会牵涉到用户态转变入核心态的问题（系统控制权从用户空间转入内核空间）。<strong>这种切换需要消耗很多 CPU 时间。这也是为什么它是昂贵的原因，时间是最昂贵的。对于很多简单的getter()、setter（）操作，花在状态切换上的时间，甚至会多过用户代码执行的时间。甚至可以认为，这样的状态切换需要使用很多的汇编指令代码，以至于要使用很多的 cpu 时钟周期</strong>。因此synchronized本身是一种重量级（Heavyweight）操作。JVM（注意，不是Java语言） 本身可能会对重量锁进行优化，使用自旋来避免频繁地切入核心态之中（自旋难道就不浪费CPU 时间了吗？）。</p>
<p>J.U.C包里专门提供了Reentrantlock来实现同步。它同样具有 syncrhonized具有的可重入、阻塞其他求锁者的特性。但它还具有三个额外的特点：</p>
<ol>
<li>等待可中断。Lock接口有实现类可以实现试锁，超时试锁等功能。这样synchronized中，其他求索线程傻等的情况可以避免。</li>
<li>公平锁。公平锁指的是按照求锁顺序来分配锁（求锁也是有顺序的）。默认的锁（synchronized 和 ReentrantLock 的默认构造函数）是非公平的，随机给予锁，这样性能更好。</li>
<li>绑定多个条件。在 synchronized 的时代，多个 condition 就意味着多层 synchronized。</li>
</ol>
<p>synchronized 的性能屡屡被 JVM 的实现者改进，因此还是优先要使用synchronized（《TIJ》、《Java 并发实践》和《深入理解 Java 虚拟机》到此达到了同一结论）。</p>
<h3 id="非阻塞同步（Non-Blocking-Synchronization"><a href="#非阻塞同步（Non-Blocking-Synchronization" class="headerlink" title="非阻塞同步（Non-Blocking Synchronization)"></a>非阻塞同步（Non-Blocking Synchronization)</h3><p>也就是我们常说的乐观策略。不需要加锁，也就不需要负担线程状态切换的代价。但代价是，如果真的发生了冲突，乐观操作需要付出的代价就是补偿（compensation）。最常见的补偿，应该就是不断重试（又要引入自旋了）。乐观锁的核心基石，实际上是 CAS（CompareAndSet或者 CompareAndSwap），这两个操作必须是原子化操作，这就要求现代的处理器提供这样的指令原语（instruction primitive）。JVM 虚拟机里，专门通过  Unsafe 包来向上层提供这种原语的语义。</p>
<p>CAS操作有一个很讨厌的 ABA 问题。虽然 ABA 问题本身在大部分情况下不会引起问题，但J.U.C还是提供了一个 AtomicStampedReference操作来避免这个问题（所以说，<strong>带版本的原子值才是最安全的</strong>）。在大多数情况下，进入互斥同步，还比用这些鸡肋功能要高效（为什么？）。</p>
<h3 id="无同步方案"><a href="#无同步方案" class="headerlink" title="无同步方案"></a>无同步方案</h3><h4 id="可重入代码（Reentrant-Code）"><a href="#可重入代码（Reentrant-Code）" class="headerlink" title="可重入代码（Reentrant Code）"></a>可重入代码（Reentrant Code）</h4><p>也叫纯代码（Pure Code）。在它执行的任意时刻中断它，转而去执行另一端代码，再切换上下文回来以后，不会发生任何错误。所有可重入的代码都是线程安全的，但并非所有线程安全的代码都是可重入的。可重入性是基本的特性。</p>
<p>其实这就是函数式编程里的纯函数，<strong>所有的状态都由输入参数决定，结果可预测</strong>，不依赖其他global状态。这也是为什么函数式编程在高并发下是安全的，他们天然满足栈封闭的标准。</p>
<h4 id="线程本地存储"><a href="#线程本地存储" class="headerlink" title="线程本地存储"></a>线程本地存储</h4><p>Thread中含有 ThreadLocalMap，而 ThreadLocal 的变量反而是 ThreadLocalMap 的 key，ThreadLocal 对应的 value <strong>，被ThreadLocalMap强引用。所以单单让 ThreadLocal 被回收，反而会因为无法再摸到 value 而造成内存泄露。</strong> </p>
<p>Thread -&gt; ThreadLocalMap -&gt; 弱引用 key（也就是我们的 ThreadLocal）<br>                         -&gt;  强引用 value（也就是 ThreadLocal 自己的 value，经常被 init 操作的那个）</p>
<p>key 经常被声明为静态变量，这个静态变量如果泄露，就是方法区泄露。但 ThreadLocalMap 对 ThreadLocal 的弱引用与它无关，所以它自身的泄露和对静态变量生命周期的管理有关。</p>
<p>value 可能被跨线程混用，所以每个线程处理完以后都要及时 remove。它被 ThreadLocalMap 强引用，但只要频繁使用 ThreadLocalMap，它内部的自带方法都会隐式地 expunge 掉这些过期的 key-也就是说，只要 key 设为 null 了，entry 会被自动消灭。所以 value 的泄露实际上是由 key 的泄露导致的。<strong>value 本身并不被 key referenced，它是被 map referenced。</strong></p>
<p>因此，我们需要至少做几件事：<br>1.尽可能手动地 remove ThreadLocal 的value。<br>2. 尽可能关掉线程（在使用线程池的方案里，这恐怕很难做到）。<br>3. 尽量触发一些 get/set/remove 操作，让 ThreadLocal 的内部操作把的 stale 的 给去除引用。</p>
<h1 id="锁优化"><a href="#锁优化" class="headerlink" title="锁优化"></a>锁优化</h1><h2 id="自旋锁（Spinning-Lock）"><a href="#自旋锁（Spinning-Lock）" class="headerlink" title="自旋锁（Spinning Lock）"></a>自旋锁（Spinning Lock）</h2><p>一个已经拥有 CPU 执行时间的线程，在求锁的时候，如果直接被阻塞，其实是会降低操作系统的并发性能。所以这种时候可以让线程执行一个忙循环（busy waiting，怎么做到的？ PC jump 到一个一段被插入的代码上吗？）。循环的次数通常是不是很多，也就是10次而已。这个次数可以通过 -XX:PreBlockSpin 调整。当前版本的 JVM 还引入了自适应自旋锁（Adaptive Spinning）。自旋锁不适合长时间等待，那种情况下浪费的 CPU 时间实在太多了。CAS 这种非常小的 Set 值操作适合使用自旋锁。</p>
<h2 id="锁消除（Lock-Elimination）"><a href="#锁消除（Lock-Elimination）" class="headerlink" title="锁消除（Lock Elimination）"></a>锁消除（Lock Elimination）</h2><p>如果 JVM 通过逃逸分析，可以去除掉不必要的同步。<br>可以消除掉 Reentrantlock吗？根据<a target="_blank" rel="noopener" href="http://www.cs.cmu.edu/~aldrich/papers/scp-camera.pdf">这篇文</a>，是可以的。</p>
<h2 id="锁粗化（Lock-Coarsening）"><a href="#锁粗化（Lock-Coarsening）" class="headerlink" title="锁粗化（Lock Coarsening）"></a>锁粗化（Lock Coarsening）</h2><p>多个连续的频繁加锁，可能被虚拟机优化为一把大锁。</p>
<h2 id="轻量级锁（Lightweight-Lock）"><a href="#轻量级锁（Lightweight-Lock）" class="headerlink" title="轻量级锁（Lightweight Lock）"></a>轻量级锁（Lightweight Lock）</h2><p>轻量级锁本身是 JDK 1.6 以后才加入的新型锁机制，它名字中的“轻量级”是相对于使用操作系统互斥量来实现的传统锁而言的（<strong>Mutex等于重量锁。可以认为OS的系统调用提供了并发机制-线程，就会必然提供互斥量机制。</strong>）。它不是用来代替重量级锁的，用意是在多线程竞争不激烈的情况下，减少重量级锁的使用，来减少性能消耗。</p>
<p>我们已经知道，对象头（Object Header）分成两个部分（不算Padding的话），“Mark Word” 与 Klass Point。Mark Word 的大小取决于虚拟机的版本，分别是32bits 和 64bits（总之总是字长对齐）。数组对象的 Klass Point 还有一个额外的部分存储数组长度。轻量级锁和偏向锁的关键是“Mark Word”。</p>
<p>“Mark Word”被设计成一个非固定的数据结构，以便在极小的空间内存储尽量多的信息。因此，它的内存布局是可变的。</p>
<p>在代码进入同步块的时候，如果此同步对象没有被锁定（锁标志位为“01”），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（Lock Record）的空间，用于存储所对象目前的 Mark Word的拷贝（实际上被命名为 Displaced Markd Word）。<strong>也就是说，试图求锁的线程局部栈帧可能是不一样的。</strong></p>
<p>然后虚拟机试图使用 CAS 操作尝试将对象的Mark Word 更新为指向 Lock Record 的指针（<strong>注意是整个Mark Word</strong>）。如果更新成功了，那么线程就拥有了该对象的锁，并且 Mark Word 的<strong>锁标志位（Markword的最后两位）</strong>转变为“00”。如果这个更新失败了，虚拟机首先会检查对象的 Mark Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，可以直接进入同步块继续执行，否则说明这个锁对象已经被其他线程抢占了。如果有两条以上的线程争用同一个锁，那轻量级锁就不再有效，要膨胀为重量级锁，锁标志的状态值变为“10”，Mark Word也就变成指向重量级锁的指针（<strong>也就是说，不再指向 Lock Record</strong>）。</p>
<p>轻量级锁的解锁过程，也必须借助 CAS 操作，把 Displaced Mark Word 的值写到 Mark Word 上。如果替换完成，同步结束。如果替换失败，证明有其他线程常识获取过该锁，那就要在释放锁的同时（<strong>可以看出此时锁已经膨胀过了，也就意味着要去释放 mutex，岂不是不对称的操作？</strong>），唤醒被挂起的线程。</p>
<p><img src="https://ws1.sinaimg.cn/large/66dd581fly1flsf4024taj20h40a5q5u.jpg"></p>
<p><img src="https://ws1.sinaimg.cn/large/66dd581fly1flsf43kk1vj20d40abtb2.jpg"></p>
<p>轻量级锁在发生竞争时，依然会出现锁膨胀，而且还加上了CAS的开销，反而比直接使用重量级锁更慢。使用偏向锁只能根据一种经验假定，“绝大部分锁，在同步周期内是不存在竞争的”。</p>
<p>从这个过程我们可以看出来，mark word里并不是存了线程号，而是直接把mark word指向了目标线程的栈帧，轻量级锁和重量级锁的差别就在于底层是不是会触发 Mutex。</p>
<h2 id="偏向锁（Biased-Lock）"><a href="#偏向锁（Biased-Lock）" class="headerlink" title="偏向锁（Biased Lock）"></a>偏向锁（Biased Lock）</h2><p>偏向锁也是 JDK 1.6 中引入的一项锁优化。它的目的是消除数据在无竞争情况下的同步原语，进一步提高程序的运行性能。如果说轻量级锁在无竞争的情况下使用 CAS操作去消除同步使用的互斥量，偏向锁就是在无竞争的情况下，把整个同步过程都消除掉，连 CAS 都不做了。</p>
<p>偏向锁的偏，是偏心的。这个锁会偏向于第一个获得它的线程，如果接下来的执行过程中，该锁没有被其他线程获取，则持有偏向锁的线程将永远不需要再进行同步。从这点来看，<strong>偏向锁导致同步消除了，等同于锁消除了。但锁消除并不等同于偏向锁，可能有JIT自己去掉同步代码的优化</strong>。</p>
<p>当对象在第一次被线程锁定的时候，虚拟机会把标志位设置为“01”（<strong>至此标志位已经被用尽了</strong>）。同时使用 CAS 模式（<strong>因为此时还不能保证没有竞争</strong>）试图把线程 ID 写入 Mark Word中（<strong>此处就真的写入线程号了</strong>）。如果CAS成功，那么以后再进入同步块，都不需要执行任何同步操作。</p>
<p>如果这个时候发生锁竞争，则会发生撤销偏向（Revoke Bias），对象回到未锁定状态，然后进入轻量级锁的竞争阶段（难道不是直接进入重量级锁的竞争阶段吗？）。偏向锁是默认打开的，很多推荐的JVM配置都关掉它，因为多线程竞争很激烈的情况下，偏向锁的假定往往会失效（轻量级锁实际上也会失效）。所以可以用 -XX:-UseBiasedLocking 来关闭偏向锁。</p>
<p>所以锁的变化过程就是无锁-&gt;偏向锁-&gt;轻量级锁-&gt;重量级锁。</p>
<p><img src="https://ws1.sinaimg.cn/large/66dd581fly1flsf7eso0hj21380jdn6j.jpg"></p>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2022-01-08");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2017-11-10T11:51:43.000Z" itemprop="datePublished">2017-11-10</time>

    , Updated at&nbsp;<time datetime="2022-01-08T09:47:07.000Z" itemprop="dateModified">2022-01-08</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/JVM/" rel="tag">#&nbsp;JVM</a>

<a class="post-tags-list-item" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">#&nbsp;多线程</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2017/11/14/KOA-%E5%88%9D%E6%8E%A2/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle"> KOA 初探</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2017/11/09/Java-%E4%B8%8E%E7%BA%BF%E7%A8%8B/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">Java 与线程</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>