<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>Java中的幽灵类型 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="Java中的幽灵类型 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="&amp;emsp;&amp;emsp;先上结论：幽灵类型（Phantom Type）是一种可以把有些运行时才能检测到的错误，在编译时检测出来的技巧。按照有些老外的观点，就是“Making Wrong Code Look Wrong”。在面向对象的编程语言之中，幽灵类型的实现，往往与状态模式较为接近，但比状态模式提供了更强的纠错功能。在Java 5 以后的版本里，程序员可以使用泛型。通过泛型的类型参数，Java  - magicliang - 守株阁"><meta name="keywords" content="Java"><meta property="article:published_time" content="2017-11-30T06:45:28.000Z"><meta property="article:modified_time" content="2019-09-09T13:35:42.000Z"><meta property="og:updated_time" content="2019-09-09T13:35:42.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="Java"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/"
    },
    "headline": "Java中的幽灵类型 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2017-11-30T06:45:28.000Z",
    "dateModified": "2019-09-09T13:35:42.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "Java",
    "description": "&amp;amp;emsp;&amp;amp;emsp;先上结论：幽灵类型（Phantom Type）是一种可以把有些运行时才能检测到的错误，在编译时检测出来的技巧。按照有些老外的观点，就是“Making Wrong Code Look Wrong”。在面向对象的编程语言之中，幽灵类型的实现，往往与状态模式较为接近，但比状态模式提供了更强的纠错功能。在Java 5 以后的版本里，程序员可以使用泛型。通过泛型的类型参数，Java  - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=Java中的幽灵类型" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=Java中的幽灵类型&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=Java中的幽灵类型" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAAAAAAYplnuAAACsUlEQVR42u3c3U7CUBBFYd7/pfXKxGC795qhkpAubjRtgY/Gw5m/+Pj6wMdDtGjRom+IfoTHz/nf1/55oV/XPf9+9prP1+PniBYN0Yd/9OUNzqDpevr7qUO06AGaLsDn82fPOzqeFjpyiBZ9AXr6odJzzo6JFv1udFuICT+5KaJFX4luwT0N4NP5sw90eZQn+vZokti+4+fl2bjoW6Jr0S8skLMN5izZTQHTpVVT0bdGk2CcFhdpAXNaqBQteoJOi+rompYU0BvQbtZhUCVaNECTAnkL5NPm0m5O2mxEi96g24JqxcO0+WxvCtpcRIsGBUiyYFpznzRBp8V50aKn6Bb0kEI63iBCoFQHCUSLBugWiLeNJS6cxRBLTDhEiwboaWO+FWbahkIK96PulmjRIQmgbzBdcLRogwMm0aIBOhUf23DhNDkgAVMcUhEtGg5eTSGvNpjoF4Fo0VN0+rInGwVJJjaDtrGhL1p0mfeYDETRAcG20EnhBn17iBZ90NCnG0YrntdBE1iArFGeaNEgCdg069tCa3iy4EWLnqDbhpGOkw2FJBntdUSL3qA3gya0QUQDonqDRIsGaLJgaAKQGpgtoU3nRYueoFOTfTugQouOrfGJiuqiRYOiOh26IouSLFCcOIgWPUTTZk5KeEkBqA2AoyRAtGiQI9IiIWkk0YbnqPkvWjRAp8GTDYgUKVvwhIvqokUP/78HTU7JUEtqPNFhGNGiaY5ImzV0mIoW0McDs6JFAzRZjC1YnzQxSaL80uYi+vboTfG7FWRIMrHZqESLntTyaEBOjreEeVSgES16id4ESXST2AZMokX/B5o2gFLRpyUb42KNaNEXoGlzhzSfaJNJtOhX0JsAflKEJw3WmhCIFg3RLbElCS1JjCcL9fBDixYN0J/0EC1atOgbob8BxlRcitdB2OgAAAAASUVORK5CYII=" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">Java中的幽灵类型</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2017-11-30</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=Java中的幽灵类型&url=http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=Java中的幽灵类型&url=http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2017/11/30/Java%E4%B8%AD%E7%9A%84%E5%B9%BD%E7%81%B5%E7%B1%BB%E5%9E%8B/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAAAAAAYplnuAAACsUlEQVR42u3c3U7CUBBFYd7/pfXKxGC795qhkpAubjRtgY/Gw5m/+Pj6wMdDtGjRom+IfoTHz/nf1/55oV/XPf9+9prP1+PniBYN0Yd/9OUNzqDpevr7qUO06AGaLsDn82fPOzqeFjpyiBZ9AXr6odJzzo6JFv1udFuICT+5KaJFX4luwT0N4NP5sw90eZQn+vZokti+4+fl2bjoW6Jr0S8skLMN5izZTQHTpVVT0bdGk2CcFhdpAXNaqBQteoJOi+rompYU0BvQbtZhUCVaNECTAnkL5NPm0m5O2mxEi96g24JqxcO0+WxvCtpcRIsGBUiyYFpznzRBp8V50aKn6Bb0kEI63iBCoFQHCUSLBugWiLeNJS6cxRBLTDhEiwboaWO+FWbahkIK96PulmjRIQmgbzBdcLRogwMm0aIBOhUf23DhNDkgAVMcUhEtGg5eTSGvNpjoF4Fo0VN0+rInGwVJJjaDtrGhL1p0mfeYDETRAcG20EnhBn17iBZ90NCnG0YrntdBE1iArFGeaNEgCdg069tCa3iy4EWLnqDbhpGOkw2FJBntdUSL3qA3gya0QUQDonqDRIsGaLJgaAKQGpgtoU3nRYueoFOTfTugQouOrfGJiuqiRYOiOh26IouSLFCcOIgWPUTTZk5KeEkBqA2AoyRAtGiQI9IiIWkk0YbnqPkvWjRAp8GTDYgUKVvwhIvqokUP/78HTU7JUEtqPNFhGNGiaY5ImzV0mIoW0McDs6JFAzRZjC1YnzQxSaL80uYi+vboTfG7FWRIMrHZqESLntTyaEBOjreEeVSgES16id4ESXST2AZMokX/B5o2gFLRpyUb42KNaNEXoGlzhzSfaJNJtOhX0JsAflKEJw3WmhCIFg3RLbElCS1JjCcL9fBDixYN0J/0EC1atOgbob8BxlRcitdB2OgAAAAASUVORK5CYII=" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                    
                    <article id="post-content">
                        <p>&emsp;&emsp;先上结论：<strong>幽灵类型（Phantom Type）是一种可以把有些运行时才能检测到的错误，在编译时检测出来的技巧</strong>。按照有些老外的观点，就是“Making Wrong Code Look Wrong”。在面向对象的编程语言之中，幽灵类型的实现，往往与状态模式较为接近，但比状态模式提供了更强的纠错功能。在Java 5 以后的版本里，程序员可以使用泛型。通过泛型的类型参数，Java 中也拥有了幽灵类型的能力。</p>
<p>&emsp;&emsp;上面的阐述是不是很难看懂？我也觉得拗口，让我们直接进入具体的例子。假设我们要写一个飞机控制程序，操作飞机起飞或者落地。这个程序有一个非常强的业务约束，就是必须保证<strong>飞机一开始必须出现在的地上，只有在地上的飞机可以起飞，只有起飞的飞机可以落地</strong>，那么我们应该怎样设计我们的程序（主要是类型关系），来保证这个约束必然成立呢？</p>
<p>&emsp;&emsp;让我们先来定义一组状态接口:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FlightStatus.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liangchuan</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FlightStatus</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flying.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liangchuan</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Flying</span> <span class="keyword">extends</span> <span class="title">FlightStatus</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Landed.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liangchuan</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Landed</span> <span class="keyword">extends</span> <span class="title">FlightStatus</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;从字面上即可看出，这是三个接口表示状态的接口类型。Flying 与 Landed 分别是 FlightStatus 的子类型，它们全都不包含任何可以使用的内容，完全通过类型名称来进行识别和区分。在 Java 这种指称类型（Nominal Typing） 的语言中，这通常被称为 Tagging Interface 或者叫 Mark Interface。</p>
<p>&emsp;&emsp;接下来我们来定义一个飞机类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Plane.java</span></span><br><span class="line"><span class="comment"> * 这个类型可以被用类型参数具体化为任何 FlightStatus 的 飞机。即 Plane&lt;Landed&gt; 与 Plane&lt;Flying&gt;。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liangchuan</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Plane</span>&lt;<span class="title">Status</span> <span class="keyword">extends</span> <span class="title">FlightStatus</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> passenger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPassenger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> passenger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁掉了除工厂方法和指定的状态构造方法以外的所有其他构造方法。当然，防不了反射攻击（reflection attack）。</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Plane</span><span class="params">(<span class="keyword">int</span> passenger)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.passenger = passenger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工厂方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Plane&lt;Landed&gt; <span class="title">newPlane</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Plane&lt;Landed&gt;(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态构造方法</span></span><br><span class="line"><span class="comment">     * 在这里每次飞机从一个状态转成另一个飞机状态，都产生了一个新的对象，类似 Value Object 的模式。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Plane</span><span class="params">(Plane&lt;? extends FlightStatus &gt; p)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在这里，我们可以使用装饰器模式。也可以使用 clone 模式，把乘客（也就是内部状态）移交过去。这取决于我们要不要把旧飞机实例的状态迁移到新飞机实例上。</span></span><br><span class="line">        <span class="keyword">this</span>.passenger = p.getPassenger();</span><br><span class="line">        <span class="comment">// 做任何想要做的事情</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AirTrafficController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Plane&lt;Landed&gt; <span class="title">land</span><span class="params">(Plane&lt;Flying&gt; p)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Plane&lt;Landed&gt;(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Plane&lt;Flying&gt; <span class="title">takeOff</span><span class="params">(Plane&lt;Landed&gt; p)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Plane&lt;Flying&gt;(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这个 Plane 类型有什么特别的地方呢？</p>
<ol>
<li>它只能使用有限的构造器来构造飞机,除此之外，<strong>都会因为方法签名带来编译错误</strong>。</li>
<li>实际上，一开始只有用工厂方法才能构造出落地的飞机，无法一开始就制造出在天上飞的飞机，否则，<strong>也会因为方法签名带来编译错误</strong>。</li>
<li>只有有状态的飞机，才能产生新的有状态的飞机。而这个有状态的飞机的转换构造函数（类似 CPP 的拷贝构造函数），只有 AirTrafficController 可以访问。</li>
<li>AirTrafficController 提供了两个状态转换方法: land 与 takeOff 。这两个方法会根据一个输入飞机的状态，来切换出另一个状态的飞机。而它们因为方法签名的关系，只能接受有限的飞机状态，<strong>否则会产生编译错误</strong>。</li>
</ol>
<p>&emsp;&emsp;到此我们的类库已经写完了。试试写一个应用程序来测试它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * AirPlaneApp.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liangchuan</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AirPlaneApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Plane&lt;Landed&gt; p = Plane.newPlane();</span><br><span class="line"></span><br><span class="line">        Plane&lt;Flying&gt; fly= Plane.AirTrafficController.takeOff(p);</span><br><span class="line">        Plane&lt;Landed&gt; land= Plane.AirTrafficController.land(fly);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 无法编译通过:</span></span><br><span class="line">        <span class="comment">///Plane&lt;Landed&gt; reallyLanded =  Plane.AirTrafficController.land(land);</span></span><br><span class="line">        <span class="comment">//Plane&lt;Flying&gt; reallyFlying =  Plane.AirTrafficController.takeOff(fly);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;想一想，如果我们把我们的程序当做类库发布出去给其他的程序员用。类库使用者因为加班上线已经写代码到了凌晨一点，错误地试图把一架正在起飞的飞机再次起飞，立刻就会得到编译器的错误提醒。这种预先设计的防呆类型系统，成功地降低了系统在变得复杂的以后，出现低级错误的可能。</p>
<p>&emsp;&emsp;为什么这种技巧叫幽灵类型呢？因为我们只在方法的签名的类型参数（type parameter）里指定了一个具体类型，并没有实际在方法体内部真的使用到这种类型的任何具体内容。诚如我们在代码中所见，FlightStatus 这种接口只是一种编译时类型识别的 type witness（类型见证人），帮助编译器推导当前的代码的合法性，其本身及其子类型，都不包含任何可以使用的内容。</p>
<p>&emsp;&emsp;可能有读者会问，这种方法很像状态模式，它和状态模式的区别在哪里呢？</p>
<ol>
<li>一个最显著的区别就是，状态模式里面，表示 state 的是实例里的一个 state 变量，而不是写在实例类型参数里的 state 类型见证人。使用状态模式，很容易让程序员写出 <code>if(state == flying) throw new Exception()</code> 之类的代码，这种代码即使写错了，编译器也检测不出来，因为这是运行时检测（是不是很讽刺，检测出错的代码，自己也会出错）。</li>
<li>更重要的是，类型参数的出现，使得一段代码里 plane 的状态表面化了。想一想，一个使用状态模式的 plane，我们在客户端代码里未必就能在当前上下文里知道它内部的 state 现在变成什么样了。但如果我们使用幽灵类型，那么我们只要看看当前上下文的方法签名的类型参数，就能明确理解当前飞机的 state。</li>
</ol>
<p>&emsp;&emsp;我们应该什么时候使用幽灵类型呢？这是一个很难把控的问题。读者已经看到了，实际上这个飞机的例子也是非常精巧，需要仔细思考才能明白其中奥妙的，所以幽灵类型在 Java 的世界里长久不为人知。笔者的愚见是，在像飞机这类例子里面，有需要严格区分状态（或者子类型）和方法的匹配的需求，可以考虑使用幽灵类型。</p>
<p>&emsp;&emsp; 这篇文章缘于知乎上的一个有意思的问答<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/37760140/answer/73987190">《你见过哪些让你瞠目结舌的 Java 代码技巧？》</a>。当时看到这种用法，我就觉得这是一种很有意思的利用编译器进行防御性编程的例子。此外，本文的飞机例子基本源自于<a target="_blank" rel="noopener" href="http://gabrielsw.blogspot.com/2012/09/phantom-types-in-java.html">此</a>，但加上了一些w=我自己的注释和修改，便于读者理解（在原文的例子中，原作者似乎意识不到 <code>Plane(Plane&lt;? extends FlightStatus &gt; p)</code>不应该是个公有方法，而 <code>AirTrafficController</code> 应该是个内部类。请读者自行思考为什么。 ）。实际上还有更多的例子，可以在<a target="_blank" rel="noopener" href="http://mgampkay.github.io/posts/java-generic-and-phantom-type.html">这里</a>看到。在函数式编程语言的世界，如 Haskell、Scala、OCaml 里，幽灵类型是天然被支持的，但在 Java 的世界里，必须要到提供泛型能力的 Java 5 版本以后，才能这种技巧。</p>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2019-09-09");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2017-11-30T06:45:28.000Z" itemprop="datePublished">2017-11-30</time>

    , Updated at&nbsp;<time datetime="2019-09-09T13:35:42.000Z" itemprop="dateModified">2019-09-09</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/Java/" rel="tag">#&nbsp;Java</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2017/12/01/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%8C%83%E5%BC%8F%E7%9A%84%E5%8E%86%E5%8F%B2/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">面向对象范式的历史</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2017/11/29/%E4%B8%80%E6%AE%B5%E6%94%B9%E5%86%99%E7%9A%84%E8%B6%85%E7%BA%A7%E8%B4%A6%E6%9C%AC%E7%9A%84%E9%93%BE%E7%A0%81/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">一段改写的超级账本的链码</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>