<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>Docker 与网络 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="Docker 与网络 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="docker 操纵网络是无形的，它通过修改路由规则来让某些包在特定的 network 里面流动。在 Linux 下，它是通过操纵 iptables 来做到这件事的(windows下通过其他机制)。 docker 的网络是可插拔的，因为使用了驱动。默认就自动携带的驱动是: bridge默认的网络驱动。当所有的容器都在一个宿主机的时候，应该使用这个驱动。 在计算机网络的范畴里，一个桥接网络是一个链路层 - magicliang - 守株阁"><meta name="keywords" content="Docker"><meta property="article:published_time" content="2018-09-07T09:07:59.000Z"><meta property="article:modified_time" content="2019-09-09T13:35:42.000Z"><meta property="og:updated_time" content="2019-09-09T13:35:42.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="Docker"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/"
    },
    "headline": "Docker 与网络 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2018-09-07T09:07:59.000Z",
    "dateModified": "2019-09-09T13:35:42.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "Docker",
    "description": "docker 操纵网络是无形的，它通过修改路由规则来让某些包在特定的 network 里面流动。在 Linux 下，它是通过操纵 iptables 来做到这件事的(windows下通过其他机制)。 docker 的网络是可插拔的，因为使用了驱动。默认就自动携带的驱动是: bridge默认的网络驱动。当所有的容器都在一个宿主机的时候，应该使用这个驱动。 在计算机网络的范畴里，一个桥接网络是一个链路层 - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=Docker 与网络" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=Docker 与网络&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=Docker 与网络" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACkCAAAAAA83tqdAAACOElEQVR42u3b227CQAxF0fz/T7dPlSoU+2xHICDevCA10Fmt8MSX4fj5gschUqRIkR+APJrH3/X/rxst8vC7qmtn64rcjawWSLgK0S788MdX64oUWQXM2aIVnrxntK5IkcUmnj7w6X0pgESKvBI43aabkon0TxApcpJgVCASHGeBNVpX5FokLcSe/fySalHk1yNJgZ82ZBJsL+2qibwV8qyw6oouAqQNhNSIELkXST/k3YbfNRVIwnz6c5EiYQJQQaprV+Ai9yJTIZUWJps8ae6LFEma8V2C2zWdusSlS2bQAFTk7ZG0CCO4Lrmd3BxE7kbShnuX3JJgoYOBeHhJ5EokGXpOBlGk+YWaAyJXIOmhj67oStdTslsWZyLXI2mjnhRno4NzqYkqchWyWoA2pboF6ZD18h1H5C2R0w90Kqwmja2uCBO5F3llI+8arxSHglDkWmS1EZMNfdLkJxs/auyLXIEkBz/SwWK6OD3gJHInkgzWJ4OldDMgNweRu5EU1x1kIoeduiEAHsqLXIFMA84rA3hyIyBJsMi9yGkyOwmUdKipLQZFrkTS5CCh6SCqa6KOMnORt0VWH/zusCZJLCZN/lFjX+QqZAcnr5ts7qhIE7kSmYaT3SFk8mUh8oxOR4tchaTFGBk40eH+OHBErkOmL2SkACEBNU5URIoMG/bV5LhrBDwlcESuQ5LifhJA6bCISJF0yN4FTULTJFikSLL5poFmCqb0HjSUF7kG+ckPkSJFinzj4xdj4VQiu7iO5QAAAABJRU5ErkJggg==" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">Docker 与网络</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2018-09-07</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=Docker 与网络&url=http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=Docker 与网络&url=http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2018/09/07/Docker-%E4%B8%8E%E7%BD%91%E7%BB%9C/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACkCAAAAAA83tqdAAACOElEQVR42u3b227CQAxF0fz/T7dPlSoU+2xHICDevCA10Fmt8MSX4fj5gschUqRIkR+APJrH3/X/rxst8vC7qmtn64rcjawWSLgK0S788MdX64oUWQXM2aIVnrxntK5IkcUmnj7w6X0pgESKvBI43aabkon0TxApcpJgVCASHGeBNVpX5FokLcSe/fySalHk1yNJgZ82ZBJsL+2qibwV8qyw6oouAqQNhNSIELkXST/k3YbfNRVIwnz6c5EiYQJQQaprV+Ai9yJTIZUWJps8ae6LFEma8V2C2zWdusSlS2bQAFTk7ZG0CCO4Lrmd3BxE7kbShnuX3JJgoYOBeHhJ5EokGXpOBlGk+YWaAyJXIOmhj67oStdTslsWZyLXI2mjnhRno4NzqYkqchWyWoA2pboF6ZD18h1H5C2R0w90Kqwmja2uCBO5F3llI+8arxSHglDkWmS1EZMNfdLkJxs/auyLXIEkBz/SwWK6OD3gJHInkgzWJ4OldDMgNweRu5EU1x1kIoeduiEAHsqLXIFMA84rA3hyIyBJsMi9yGkyOwmUdKipLQZFrkTS5CCh6SCqa6KOMnORt0VWH/zusCZJLCZN/lFjX+QqZAcnr5ts7qhIE7kSmYaT3SFk8mUh8oxOR4tchaTFGBk40eH+OHBErkOmL2SkACEBNU5URIoMG/bV5LhrBDwlcESuQ5LifhJA6bCISJF0yN4FTULTJFikSLL5poFmCqb0HjSUF7kG+ckPkSJFinzj4xdj4VQiu7iO5QAAAABJRU5ErkJggg==" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#bridge"><span class="post-toc-number">1.</span> <span class="post-toc-text">bridge</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">自定义网络的优势</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%93%8D%E7%BA%B5%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">操纵自定义网络</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8-IP-V6"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">使用 IP V6</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#host"><span class="post-toc-number">2.</span> <span class="post-toc-text">host</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#overlay"><span class="post-toc-number">3.</span> <span class="post-toc-text">overlay</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%A4%E4%B8%AA%E5%86%85%E9%83%A8%E7%BD%91%E7%BB%9C%EF%BC%88%E8%BF%99%E4%B8%AA%E4%B8%BB%E9%A2%98%E4%BC%BC%E4%B9%8E%E5%92%8C%E5%B1%82%E5%8F%A0%E7%BD%91%E7%BB%9C%E4%B8%8D%E6%98%AF%E5%BE%88%E6%9C%89%E5%85%B3%E7%B3%BB%EF%BC%8C%E8%80%8C%E5%92%8C-swarm-%E6%9C%AC%E8%BA%AB%E6%9C%89%E5%85%B3%E7%B3%BB%EF%BC%89"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">两个内部网络（这个主题似乎和层叠网络不是很有关系，而和 swarm 本身有关系）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%B1%82%E5%8F%A0%E7%BD%91%E7%BB%9C%E6%93%8D%E4%BD%9C"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">层叠网络操作</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B1%82%E5%8F%A0%E7%BD%91%E7%BB%9C"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">创建层叠网络</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%B1%82%E5%8F%A0%E7%BD%91%E7%BB%9C%E9%87%8C%E7%9A%84%E5%8A%A0%E5%AF%86"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">层叠网络里的加密</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9A%E5%88%B6%E7%BC%BA%E7%9C%81%E7%9A%84-ingress-%E7%BD%91%E7%BB%9C"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">定制缺省的 ingress 网络</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9A%E5%88%B6-docker-gwbridge"><span class="post-toc-number">3.2.4.</span> <span class="post-toc-text">定制 docker_gwbridge</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BB%95%E8%BF%87%E8%B7%AF%E7%94%B1%E7%BD%91%E6%A0%BC%EF%BC%88routing-mesh%EF%BC%89"><span class="post-toc-number">3.2.5.</span> <span class="post-toc-text">绕过路由网格（routing mesh）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#macvlan"><span class="post-toc-number">4.</span> <span class="post-toc-text">macvlan</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#none"><span class="post-toc-number">5.</span> <span class="post-toc-text">none</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%85%B6%E4%BB%96%E7%AC%AC%E4%B8%89%E6%96%B9%E9%A9%B1%E5%8A%A8"><span class="post-toc-number">6.</span> <span class="post-toc-text">其他第三方驱动</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%AE%9A-ip-%E5%9C%B0%E5%9D%80"><span class="post-toc-number">7.</span> <span class="post-toc-text">创建容器的时候可以指定 ip 地址</span></a></li></ol></div>
                        
                    
                    <article id="post-content">
                        <p>docker 操纵网络是无形的，它通过修改路由规则来让某些包在特定的 network 里面流动。在 Linux 下，它是通过操纵 iptables 来做到这件事的(windows下通过其他机制)。</p>
<p>docker 的网络是可插拔的，因为使用了驱动。默认就自动携带的驱动是:</p>
<h2 id="bridge"><a href="#bridge" class="headerlink" title="bridge"></a>bridge</h2><p>默认的网络驱动。<br>当所有的容器都在一个宿主机的时候，应该使用这个驱动。</p>
<p>在计算机网络的范畴里，一个桥接网络是一个链路层设备，转发网络片段。一个桥可以一个硬件设备或者宿主机内核里的软件设备。<br>在 Docker的范畴里，桥接网络使用一个软件桥来让容器连在同一座桥上，通过桥通信。同一个宿主机里，不同桥网络是不能相互通信的（实际上不同的网络就不应该彼此通信）。</p>
<p>启动 docker 的时候，一个默认的桥接网络就被创建了。如果没有其他网络被创建，则默认大家都使用这个网络。所有新创建的容器，都会自动在这个名称为 bridge 网络里互连。用户也可以创建自定义的桥接网络，自定义的桥接网络拥有更高的优先级。</p>
<h3 id="自定义网络的优势"><a href="#自定义网络的优势" class="headerlink" title="自定义网络的优势"></a>自定义网络的优势</h3><ul>
<li>用户自定义网络在容器化应用程序里，提供了更好的隔离和互操作性。在同一个桥接网络里的容器，默认向彼此打开了所有端口，但却不向网络外开放端口。如果使用自定义的桥接网络，则可以指定开放哪些端口给网络外部，如果使用缺省桥接网络；则开放时必须默认全部开放端口（可以有其他迂回策略做到部分开放）。细想一下，这种网络隔离免去了网络内部容器之间鉴权的必要。</li>
<li>用户自定义的桥接网络提供网络内容器间自动的 DNS 解析。这让我们可以免于使用 –link 这样的遗留选项（这个选项本质上 必须和缺省桥接网络共生），使我们可以用容器名或者别名直接访问网络。我们当然也可以采用 hack 容器内的 /etc/hosts 的方法来解决这个问题。然而，这产生了难以 debug 的问题，特别是容器每次重建这个文件都会被刷新。</li>
<li>可以动态对用户自定义桥接网络添加容器和解绑，而对默认桥接网络这么做，就需要停下整个网络。</li>
<li>可以动态修改用户自定义桥接网络的配置，但缺省网络配置就难以修改，因为又涉及到重启。</li>
<li>使用缺省网络，所有容器共享环境变量。</li>
</ul>
<h3 id="操纵自定义网络"><a href="#操纵自定义网络" class="headerlink" title="操纵自定义网络"></a>操纵自定义网络</h3><p>基础的 CRUD：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 缺省的 docker network create 命令创造出的就是桥接网络</span></span><br><span class="line">docker network create my-net</span><br><span class="line">docker network rm my-net</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以一个来自于 nginx 镜像的名为 my-nginx 的容器建立一个名为 my-net 的网络，并开放80端口。</span></span><br><span class="line">docker create --name my-nginx \</span><br><span class="line">  --network my-net \</span><br><span class="line">  --publish 8080:80 \</span><br><span class="line">  nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把一个已经运行的容器，加入到一个已经存在的网络里  </span></span><br><span class="line">docker network connect my-net my-nginx</span><br><span class="line"><span class="comment"># 切断连接</span></span><br><span class="line">docker network disconnect my-net my-nginx</span><br></pre></td></tr></table></figure>

<p>允许 docker 容器内的流量转发到外部世界：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 相当于本来内网也是不能访问外网的</span><br><span class="line"></span><br><span class="line">sysctl net.ipv4.conf.all.forwarding=1</span><br><span class="line"></span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>

<p>配置缺省桥接网络，要求 docker 守护进程重启：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.1.5/24&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fixed-cidr&quot;</span>: <span class="string">&quot;192.168.1.5/25&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fixed-cidr-v6&quot;</span>: <span class="string">&quot;2001:db8::/64&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mtu&quot;</span>: <span class="number">1500</span>,</span><br><span class="line">  <span class="string">&quot;default-gateway&quot;</span>: <span class="string">&quot;10.20.1.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;default-gateway-v6&quot;</span>: <span class="string">&quot;2001:db8:abcd::89&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dns&quot;</span>: [<span class="string">&quot;10.20.1.2&quot;</span>,<span class="string">&quot;10.20.1.3&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>容器加入自定义网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker run -dit --name alpine1 --network alpine-net alpine ash</span><br><span class="line"></span><br><span class="line">docker run -dit --name alpine2 --network alpine-net alpine ash</span><br><span class="line"></span><br><span class="line">docker run -dit --name alpine3 alpine ash</span><br><span class="line"></span><br><span class="line">docker run -dit --name alpine4 --network alpine-net alpine ash</span><br><span class="line"></span><br><span class="line">docker network connect bridge alpine4</span><br><span class="line"></span><br><span class="line"># 使用 attach 而不是 exec 来进入容器内部</span><br><span class="line">docker container attach alpine1</span><br></pre></td></tr></table></figure>



<h3 id="使用-IP-V6"><a href="#使用-IP-V6" class="headerlink" title="使用 IP V6"></a>使用 IP V6</h3><p>需要单独配置。参考<a target="_blank" rel="noopener" href="https://docs.docker.com/network/bridge/#use-ipv6">《Use IPv6》</a>。</p>
<h2 id="host"><a href="#host" class="headerlink" title="host"></a>host</h2><p>移除单个容器和宿主机之间的网络间隔，并直接使用宿主机网络。这个驱动只在高于等于版本  17.06 的 swarm 服务上可用。</p>
<p>当网络栈部分不与宿主机隔离，而容器的其他部分需要与宿主机隔离的时候，应该使用这个驱动。</p>
<p>这个驱动只真对 Linux。</p>
<p>使用这个驱动，容器开放的端口和宿主机开放的端口号一致。比如容器内应用绑定了80端口，在宿主机上可以看到是 docker 进程占用了该端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netstat -tulpn | grep :80</span><br></pre></td></tr></table></figure>

<p>创建网络：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container create --network host</span><br></pre></td></tr></table></figure>

<h2 id="overlay"><a href="#overlay" class="headerlink" title="overlay"></a>overlay</h2><p>层叠网络虽然最被我们所熟悉，但却不是缺省网络。</p>
<p>层叠网络可以让多个 docker 守护进程（注意，每个 宿主机上实际上只有一个 docker 守护进程）连接到一起，也让 swarm 服务与他们一一通信。</p>
<p>层叠网络可以让 swarm 服务和单独的容器一起通信。</p>
<p>层叠网络可以让多个 docker 守护进程里的单一容器通信。</p>
<p>层叠网络消除了 OS 级别的容器间路由。</p>
<p>当多个宿主机上的容器需要通信，或者需要使用 swarm 服务让多重应用一起工作时，应该使用这个驱动。</p>
<p>层叠网络创建的是一个分布式网络，构建在多个宿主专属网络上。</p>
<h3 id="两个内部网络（这个主题似乎和层叠网络不是很有关系，而和-swarm-本身有关系）"><a href="#两个内部网络（这个主题似乎和层叠网络不是很有关系，而和-swarm-本身有关系）" class="headerlink" title="两个内部网络（这个主题似乎和层叠网络不是很有关系，而和 swarm 本身有关系）"></a>两个内部网络（这个主题似乎和层叠网络不是很有关系，而和 swarm 本身有关系）</h3><p>当我们初始化一个 swarm，或者让一个已经存在的容器加入一个已经存在的 swarm 服务时，每一个节点（manager 或者 worker 都有）产生了两个内部网络：</p>
<ul>
<li>ingress 负责处理 swarm 相关的流量</li>
<li>docker_gwbridge 这是一个桥接网络，连接不同的 docker 守护进程。</li>
</ul>
<p>容器和服务可以连接多个网络，但每次只能在一个它们连上的网络里相互通信。</p>
<h3 id="层叠网络操作"><a href="#层叠网络操作" class="headerlink" title="层叠网络操作"></a>层叠网络操作</h3><h4 id="创建层叠网络"><a href="#创建层叠网络" class="headerlink" title="创建层叠网络"></a>创建层叠网络</h4><p>先决条件：</p>
<ul>
<li>打开以下端口</li>
<li>TCP port 2377 for cluster management communications</li>
<li>TCP and UDP port 7946 for communication among nodes</li>
<li>UDP port 4789 for overlay network traffic</li>
<li>成为 swarm manager 或者加入一个 swarm 集群。这样才能初始化 ingress 网络。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给 swarm 用</span></span><br><span class="line">docker network create -d overlay my-overlay</span><br><span class="line"><span class="comment"># 给 swarm 或者单独的容器通信用</span></span><br><span class="line">docker network create -d overlay --attachable my-attachable-overlay</span><br></pre></td></tr></table></figure>

<p>实际上这些操作，还是在 swarm manager 节点上执行最好，详情见<a target="_blank" rel="noopener" href="https://docs.docker.com/network/network-tutorial-overlay/">《Networking with overlay networks》</a>。</p>
<h4 id="层叠网络里的加密"><a href="#层叠网络里的加密" class="headerlink" title="层叠网络里的加密"></a>层叠网络里的加密</h4><p>swarm 的管理流量默认就是被 AES  算法 GCM 模式加密过的。</p>
<p>创建层叠网络时使用 –opt encrypted 会让普通的应用流量也加密。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --opt encrypted --driver overlay --attachable my-attachable-multi-host-network</span><br></pre></td></tr></table></figure>

<p>不要让 windows 节点加入加密的 swarm 网络，有错也检验不出来。</p>
<h4 id="定制缺省的-ingress-网络"><a href="#定制缺省的-ingress-网络" class="headerlink" title="定制缺省的 ingress 网络"></a>定制缺省的 ingress 网络</h4><p>修改有服务存在的 ingress 网络是很麻烦的：</p>
<ol>
<li><code>docker network inspect ingress</code>，然后移除网络中的服务。</li>
<li>去除现存的 ingress 网络，<code>docker network rm ingress</code>。</li>
<li>使用新的 opption 来创建新的 ingress 网络：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker network create \</span><br><span class="line">  --driver overlay \</span><br><span class="line">  --ingress \</span><br><span class="line">  --subnet=10.11.0.0/16 \</span><br><span class="line">  --gateway=10.11.0.2 \</span><br><span class="line">  --opt com.docker.network.driver.mtu=1200 \</span><br><span class="line">  my-ingress</span><br></pre></td></tr></table></figure>
<h4 id="定制-docker-gwbridge"><a href="#定制-docker-gwbridge" class="headerlink" title="定制 docker_gwbridge"></a>定制 docker_gwbridge</h4></li>
</ol>
<p>也是类似的操作。</p>
<h4 id="绕过路由网格（routing-mesh）"><a href="#绕过路由网格（routing-mesh）" class="headerlink" title="绕过路由网格（routing mesh）"></a>绕过路由网格（routing mesh）</h4><p>swarm 默认会帮我们做服务级的负载均衡，这样应用程序就获得了 VIP。</p>
<p>我们可以关闭这种模式，通过</p>
<blockquote>
<p>To bypass the routing mesh, you can start a service using DNS Round<br>Robin (DNSRR) mode, by setting the –endpoint-mode flag to dnsrr.</p>
</blockquote>
<p>让 docker 宿主机成为一个 DNS 服务器，用自己的负载均衡来查询这个 IP 列表。docker 守护进程本身也可以像一个 DHCP server 一样工作。</p>
<h2 id="macvlan"><a href="#macvlan" class="headerlink" title="macvlan"></a>macvlan</h2><p>这个驱动让容器可以得到一个虚拟的 MAC 地址，让它表现得好像一个物理设备一样。而 docker 守护进程按照 Mac 地址往 docker 容器发流量。</p>
<p>这个驱动是面对要直连物理设备的遗留程序（比如一些网络监控程序）的最好选择。</p>
<p>详情见<a target="_blank" rel="noopener" href="https://docs.docker.com/network/macvlan/">《Use Macvlan networks》</a>。</p>
<h2 id="none"><a href="#none" class="headerlink" title="none"></a>none</h2><p>这个驱动必须可以第三方驱动配合使用。</p>
<p>也可以用来完全禁止一个容器的网络栈部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -dit \</span><br><span class="line">  --network none \</span><br><span class="line">  --name no-net-alpine \</span><br><span class="line">  alpine:latest \</span><br><span class="line">  ash</span><br></pre></td></tr></table></figure>

<h2 id="其他第三方驱动"><a href="#其他第三方驱动" class="headerlink" title="其他第三方驱动"></a>其他第三方驱动</h2><p>这些驱动可以在 docker 商店里找到。</p>
<h2 id="创建容器的时候可以指定-ip-地址"><a href="#创建容器的时候可以指定-ip-地址" class="headerlink" title="创建容器的时候可以指定 ip 地址"></a>创建容器的时候可以指定 ip 地址</h2><p>可以指定网络中的 ip。具体可以看文档：</p>
<blockquote>
<p>When you connect an existing container to a different network using<br>docker network connect, you can use the –ip or –ip6 flags on that<br>command to specify the container’s IP address on the additional<br>network.</p>
</blockquote>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2019-09-09");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2018-09-07T09:07:59.000Z" itemprop="datePublished">2018-09-07</time>

    , Updated at&nbsp;<time datetime="2019-09-09T13:35:42.000Z" itemprop="dateModified">2019-09-09</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/Docker/" rel="tag">#&nbsp;Docker</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2018/09/10/OOM-%E8%B0%83%E6%9F%A5%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84%E5%B7%A5%E5%85%B7/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">OOM 调查使用到的工具</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2018/09/07/%E6%97%A5%E6%9C%9F%E4%B8%8E%E6%97%B6%E9%97%B4/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">日期与时间</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>