<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Hyperledger Fabric 的配置文件解读 | 守株阁</title><meta name="author" content="magicliang"><meta name="copyright" content="magicliang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Crypto Generator x.509 相关的文件主要包含两个东西：证书和 signing keys。 cryptogen 使用的配置文件是crypto-config.yaml。 x.509 的根证书是ca-cert。它把 peers 和 orderers 绑定到一个 Org 里面。在这个网络里，每个组织都有签发自己的证书的能力，可以用这个 ca 来签发其他证书给节点和 client。 签发">
<meta property="og:type" content="article">
<meta property="og:title" content="Hyperledger Fabric 的配置文件解读">
<meta property="og:url" content="https://magicliang.github.io/2018/03/15/Hyperledger-Fabric-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB/index.html">
<meta property="og:site_name" content="守株阁">
<meta property="og:description" content="Crypto Generator x.509 相关的文件主要包含两个东西：证书和 signing keys。 cryptogen 使用的配置文件是crypto-config.yaml。 x.509 的根证书是ca-cert。它把 peers 和 orderers 绑定到一个 Org 里面。在这个网络里，每个组织都有签发自己的证书的能力，可以用这个 ca 来签发其他证书给节点和 client。 签发">
<meta property="og:locale">
<meta property="og:image" content="https://magicliang.github.io/img/wall-paper-157.jpg">
<meta property="article:published_time" content="2018-03-15T06:38:14.000Z">
<meta property="article:modified_time" content="2026-01-24T07:32:06.482Z">
<meta property="article:author" content="magicliang">
<meta property="article:tag" content="Hyperledger Fabric">
<meta property="article:tag" content="区块链">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://magicliang.github.io/img/wall-paper-157.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Hyperledger Fabric 的配置文件解读",
  "url": "https://magicliang.github.io/2018/03/15/Hyperledger-Fabric-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB/",
  "image": "https://magicliang.github.io/img/wall-paper-157.jpg",
  "datePublished": "2018-03-15T06:38:14.000Z",
  "dateModified": "2026-01-24T07:32:06.482Z",
  "author": [
    {
      "@type": "Person",
      "name": "magicliang",
      "url": "https://magicliang.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://magicliang.github.io/2018/03/15/Hyperledger-Fabric-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: magicliang","link":"Link: ","source":"Source: 守株阁","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Hyperledger Fabric 的配置文件解读',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="守株阁" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/wall-paper-157.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">守株阁</span></a><a class="nav-page-title" href="/"><span class="site-name">Hyperledger Fabric 的配置文件解读</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Hyperledger Fabric 的配置文件解读</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2018-03-15T06:38:14.000Z" title="Created 2018-03-15 14:38:14">2018-03-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-01-24T07:32:06.482Z" title="Updated 2026-01-24 15:32:06">2026-01-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">8.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>46mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="crypto-generator">Crypto Generator</h2>
<p>x.509 相关的文件主要包含两个东西：证书和 signing keys。</p>
<p>cryptogen 使用的配置文件是<code>crypto-config.yaml</code>。</p>
<p>x.509 的根证书是<code>ca-cert</code>。它把 peers 和 orderers 绑定到一个 Org 里面。在这个网络里，每个组织都有签发自己的证书的能力，可以用这个 ca 来签发其他证书给节点和 client。</p>
<p>签发交易用的是私钥（keystore），验证交易用的是公钥（signcerts）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 注意这个文件里一点指定 MSP 的 ID 的地方都没有。</span><br><span class="hljs-comment"># ---------------------------------------------------------------------------</span><br><span class="hljs-comment"># &quot;OrdererOrgs&quot; - Definition of organizations managing orderer nodes</span><br><span class="hljs-comment"># ---------------------------------------------------------------------------</span><br><span class="hljs-attr">OrdererOrgs:</span><br>  <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>  <span class="hljs-comment"># Orderer</span><br>  <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>  <span class="hljs-comment"># 这里的 Name 是 MemberShip 的 ID，大致就是一个法律实体作为会员。</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">Name:</span> <span class="hljs-string">Orderer</span><br>    <span class="hljs-attr">Domain:</span> <span class="hljs-string">ORDERER_DOMAIN</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># &quot;Specs&quot; - See PeerOrgs below for complete description</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-attr">Specs:</span><br>      <span class="hljs-comment"># orderer docker 容器的名字 </span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">Hostname:</span> <span class="hljs-string">orderer</span><br><span class="hljs-comment"># ---------------------------------------------------------------------------</span><br><span class="hljs-comment"># &quot;PeerOrgs&quot; - Definition of organizations managing peer nodes</span><br><span class="hljs-comment"># ---------------------------------------------------------------------------</span><br><span class="hljs-attr">PeerOrgs:</span><br>  <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>  <span class="hljs-comment"># Org1</span><br>  <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">Name:</span> <span class="hljs-string">Org1</span><br>      <span class="hljs-comment"># 组织1的完整 domain</span><br>    <span class="hljs-attr">Domain:</span> <span class="hljs-string">ORG1_DOMAIN</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># &quot;Specs&quot;</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># Uncomment this section to enable the explicit definition of hosts in your</span><br>    <span class="hljs-comment"># configuration.  Most users will want to use Template, below</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Specs is an array of Spec entries.  Each Spec entry consists of two fields:</span><br>    <span class="hljs-comment">#   - Hostname:   (Required) The desired hostname, sans the domain.</span><br>    <span class="hljs-comment">#   - CommonName: (Optional) Specifies the template or explicit override for</span><br>    <span class="hljs-comment">#                 the CN.  By default, this is the template:</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#                              &quot;&#123;&#123;.Hostname&#125;&#125;.&#123;&#123;.Domain&#125;&#125;&quot;</span><br>    <span class="hljs-comment">#                 这个 CommonName 搞不好是拼出来的完整容器名，比如peer0.org1.com 之类的。</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#                 which obtains its values from the Spec.Hostname and</span><br>    <span class="hljs-comment">#                 Org.Domain, respectively.</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># Specs:</span><br>    <span class="hljs-comment">#   - Hostname: foo # implicitly &quot;foo.ORG1_DOMAIN&quot;</span><br>    <span class="hljs-comment">#     CommonName: foo27.org5.example.com # overrides Hostname-based FQDN set above</span><br>    <span class="hljs-comment">#   - Hostname: bar</span><br>    <span class="hljs-comment">#   - Hostname: baz</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># &quot;Template&quot;</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># Allows for the definition of 1 or more hosts that are created sequentially</span><br>    <span class="hljs-comment"># from a template. By default, this looks like &quot;peer%d&quot; from 0 to Count-1.</span><br>    <span class="hljs-comment"># You may override the number of nodes (Count), the starting index (Start)</span><br>    <span class="hljs-comment"># or the template used to construct the name (Hostname).</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># <span class="hljs-doctag">Note:</span> Template and Specs are not mutually exclusive.  You may define both</span><br>    <span class="hljs-comment"># sections and the aggregate nodes will be created for you.  Take care with</span><br>    <span class="hljs-comment"># name collisions</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># 这里的容器名就不是用 Hostname 指定出来的，而是用 spec 推导出来的了。具体还是看文档，这里就是规定这个组织里有多少个 peer，peer 用什么名字。现在这个名字就是 peer0，peer1 的形式。当然都可以改。</span><br>    <span class="hljs-attr">Template:</span><br>      <span class="hljs-attr">Count:</span> <span class="hljs-number">2</span><br>      <span class="hljs-comment"># Start: 5</span><br>      <span class="hljs-comment"># Hostname: &#123;&#123;.Prefix&#125;&#125;&#123;&#123;.Index&#125;&#125; # default</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># &quot;Users&quot;</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># Count: The number of user accounts _in addition_ to Admin</span><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># 这个users 本身就是指的非 admin 的 user 要创建出多少套 identity 证书来。</span><br>    <span class="hljs-attr">Users:</span><br>      <span class="hljs-attr">Count:</span> <span class="hljs-number">1</span><br>  <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>  <span class="hljs-comment"># Org2: See &quot;Org1&quot; for full specification</span><br>  <span class="hljs-comment"># ---------------------------------------------------------------------------</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">Name:</span> <span class="hljs-string">Org2</span><br>    <span class="hljs-attr">Domain:</span> <span class="hljs-string">ORG2_DOMAIN</span><br>    <span class="hljs-attr">Template:</span><br>      <span class="hljs-attr">Count:</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">Users:</span><br>      <span class="hljs-attr">Count:</span> <span class="hljs-number">1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">Name:</span> <span class="hljs-string">Org3</span><br>    <span class="hljs-attr">Domain:</span> <span class="hljs-string">ORG3_DOMAIN</span><br>    <span class="hljs-attr">Template:</span><br>      <span class="hljs-attr">Count:</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">Users:</span><br>      <span class="hljs-attr">Count:</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
<p>跑完这个工具生成的材料都在<code>crypto-config</code>这个文件夹下，它总会归属于 ordererOrganzations 和 peerOrganizations。这两个文件夹下的子文件夹就是由拓扑决定的几个域文件夹。每个域下必有 ca、msp、peers/orderers、tlsca 和 users 五个文件夹。每个user，peer和orderer还必然有自己的MSP。</p>
<h2 id="configtxgen-相关">configtxgen 相关</h2>
<p><code>configtxgen</code>需要使用的配置文件是<code>configtx.yaml</code>，解说文件大致如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   Profile</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   - Different configuration profiles may be encoded here to be specified</span><br><span class="hljs-comment">#   as parameters to the configtxgen tool</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-attr">Profiles:</span><br>    <span class="hljs-comment"># 这个 profile 是用来定义 consortium 的。远在产生频道以前，就定义 orderer 和组织之间的关系。</span><br>    <span class="hljs-attr">TwoOrgsOrdererGenesis:</span><br>        <span class="hljs-attr">Orderer:</span><br>            <span class="hljs-comment"># 按照 YAML 的语法，&lt;&lt;: * 是对 anchor 的引用</span><br>            <span class="hljs-string">&lt;&lt;:</span> <span class="hljs-meta">*OrdererDefaults</span><br>            <span class="hljs-attr">Organizations:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-meta">*OrdererOrg</span><br>        <span class="hljs-attr">Consortiums:</span><br>            <span class="hljs-comment"># 这个名称似乎是默认的样例联盟，在没有联盟的时候会被拿出来用</span><br>            <span class="hljs-attr">SampleConsortium:</span><br>                <span class="hljs-attr">Organizations:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org1</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org2</span><br>    <span class="hljs-comment"># 这两个 profile 则是产生频道用的。换言之，一套 orderer 和多个组织，可以产生多个 consortium。</span><br>    <span class="hljs-attr">TwoOrgsChannel:</span><br>        <span class="hljs-attr">Consortium:</span> <span class="hljs-string">SampleConsortium</span><br>        <span class="hljs-attr">Application:</span><br>            <span class="hljs-string">&lt;&lt;:</span> <span class="hljs-meta">*ApplicationDefaults</span><br>            <span class="hljs-attr">Organizations:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org1</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org2</span><br><br>    <span class="hljs-comment"># 因为增加了 profile，所以要去改使用 profile 的地方。</span><br>    <span class="hljs-attr">ThreeOrgsOrdererGenesis:</span><br>        <span class="hljs-attr">Orderer:</span><br>            <span class="hljs-comment"># 按照 YAML 的语法，这是对 anchor 的引用</span><br>            <span class="hljs-string">&lt;&lt;:</span> <span class="hljs-meta">*OrdererDefaults</span><br>            <span class="hljs-attr">Organizations:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-meta">*OrdererOrg</span><br>        <span class="hljs-attr">Consortiums:</span><br>            <span class="hljs-comment"># 这里换了一个联盟来跑这个 network。</span><br>            <span class="hljs-attr">BusinessConsortium:</span><br>                <span class="hljs-attr">Organizations:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org1</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org2</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org3</span><br>    <span class="hljs-attr">ThreeOrgsChannel:</span><br>        <span class="hljs-attr">Consortium:</span> <span class="hljs-string">BusinessConsortium</span><br>        <span class="hljs-attr">Application:</span><br>            <span class="hljs-string">&lt;&lt;:</span> <span class="hljs-meta">*ApplicationDefaults</span><br>            <span class="hljs-attr">Organizations:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org1</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-meta">*Org2</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">*Org3</span> <br><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   Section: Organizations</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   - This section defines the different organizational identities which will</span><br><span class="hljs-comment">#   be referenced later in the configuration.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-attr">Organizations:</span><br><br>    <span class="hljs-comment"># SampleOrg defines an MSP using the sampleconfig.  It should never be used</span><br>    <span class="hljs-comment"># in production but may be used as a template for other definitions</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-meta">&amp;OrdererOrg</span><br>        <span class="hljs-comment"># DefaultOrg defines the organization which is used in the sampleconfig</span><br>        <span class="hljs-comment"># of the fabric.git development environment</span><br>        <span class="hljs-attr">Name:</span> <span class="hljs-string">OrdererOrg</span><br><br>        <span class="hljs-comment"># ID to load the MSP definition as</span><br>        <span class="hljs-attr">ID:</span> <span class="hljs-string">OrdererMSP</span><br><br>        <span class="hljs-comment"># MSPDir is the filesystem path which contains the MSP configuration</span><br>        <span class="hljs-attr">MSPDir:</span> <span class="hljs-string">crypto-config/ordererOrganizations/ORDERER_DOMAIN/msp</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-meta">&amp;Org1</span><br>        <span class="hljs-comment"># DefaultOrg defines the organization which is used in the sampleconfig</span><br>        <span class="hljs-comment"># of the fabric.git development environment</span><br>        <span class="hljs-attr">Name:</span> <span class="hljs-string">Org1MSP</span><br><br>        <span class="hljs-comment"># ID to load the MSP definition as</span><br>        <span class="hljs-attr">ID:</span> <span class="hljs-string">Org1MSP</span><br><br>        <span class="hljs-attr">MSPDir:</span> <span class="hljs-string">crypto-config/peerOrganizations/ORG1_DOMAIN/msp</span><br><br>        <span class="hljs-attr">AnchorPeers:</span><br>            <span class="hljs-comment"># AnchorPeers defines the location of peers which can be used</span><br>            <span class="hljs-comment"># for cross org gossip communication.  Note, this value is only</span><br>            <span class="hljs-comment"># encoded in the genesis block in the Application section context</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">Host:</span> <span class="hljs-string">peer0.ORG1_DOMAIN</span><br>              <span class="hljs-attr">Port:</span> <span class="hljs-number">7051</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-meta">&amp;Org2</span><br>        <span class="hljs-comment"># DefaultOrg defines the organization which is used in the sampleconfig</span><br>        <span class="hljs-comment"># of the fabric.git development environment</span><br>        <span class="hljs-attr">Name:</span> <span class="hljs-string">Org2MSP</span><br><br>        <span class="hljs-comment"># ID to load the MSP definition as</span><br>        <span class="hljs-attr">ID:</span> <span class="hljs-string">Org2MSP</span><br><br>        <span class="hljs-attr">MSPDir:</span> <span class="hljs-string">crypto-config/peerOrganizations/ORG2_DOMAIN/msp</span><br><br>        <span class="hljs-attr">AnchorPeers:</span><br>            <span class="hljs-comment"># AnchorPeers defines the location of peers which can be used</span><br>            <span class="hljs-comment"># for cross org gossip communication.  Note, this value is only</span><br>            <span class="hljs-comment"># encoded in the genesis block in the Application section context</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">Host:</span> <span class="hljs-string">peer0.ORG2_DOMAIN</span><br>              <span class="hljs-attr">Port:</span> <span class="hljs-number">7051</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-meta">&amp;Org3</span><br>        <span class="hljs-comment"># 这个组织 name取什么名字，完全无碍于MSP ID。但会影响 configtxgen 的 -asOrg 参数，进而影响 anchor 节点 configtx 的生成。</span><br>        <span class="hljs-attr">Name:</span> <span class="hljs-string">Org3MSP</span><br>        <span class="hljs-comment"># 这里这个 MSP ID 完全可以不按照惯例来，也完全不影响整个网络的启动，也完全不受 crypto-config.yaml 的配置文件影响。</span><br>        <span class="hljs-attr">ID:</span> <span class="hljs-string">Org3-MSP</span><br>        <span class="hljs-attr">MSPDir:</span> <span class="hljs-string">crypto-config/peerOrganizations/ORG3_DOMAIN/msp</span><br>        <span class="hljs-comment"># 锚节点可以是数组 </span><br>        <span class="hljs-attr">AnchorPeers:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">Host:</span> <span class="hljs-string">peer0.ORG3_DOMAIN</span><br>              <span class="hljs-attr">Port:</span> <span class="hljs-number">7051</span><br><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   SECTION: Orderer</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   - This section defines the values to encode into a config transaction or</span><br><span class="hljs-comment">#   genesis block for orderer related parameters</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-comment"># 这里就是 anchor 了。</span><br><span class="hljs-attr">Orderer:</span> <span class="hljs-meta">&amp;OrdererDefaults</span><br><br>    <span class="hljs-comment"># Orderer Type: The orderer implementation to start</span><br>    <span class="hljs-comment"># Available types are &quot;solo&quot; and &quot;kafka&quot;</span><br>    <span class="hljs-attr">OrdererType:</span> <span class="hljs-string">solo</span><br><br>    <span class="hljs-attr">Addresses:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">orderer.ORDERER_DOMAIN:7050</span><br><br>    <span class="hljs-comment"># Batch Timeout: The amount of time to wait before creating a batch</span><br>    <span class="hljs-attr">BatchTimeout:</span> <span class="hljs-string">2s</span><br><br>    <span class="hljs-comment"># Batch Size: Controls the number of messages batched into a block</span><br>    <span class="hljs-attr">BatchSize:</span><br><br>        <span class="hljs-comment"># Max Message Count: The maximum number of messages to permit in a batch</span><br>        <span class="hljs-attr">MaxMessageCount:</span> <span class="hljs-number">10</span><br><br>        <span class="hljs-comment"># Absolute Max Bytes: The absolute maximum number of bytes allowed for</span><br>        <span class="hljs-comment"># the serialized messages in a batch.</span><br>        <span class="hljs-attr">AbsoluteMaxBytes:</span> <span class="hljs-number">99</span> <span class="hljs-string">MB</span><br><br>        <span class="hljs-comment"># Preferred Max Bytes: The preferred maximum number of bytes allowed for</span><br>        <span class="hljs-comment"># the serialized messages in a batch. A message larger than the preferred</span><br>        <span class="hljs-comment"># max bytes will result in a batch larger than preferred max bytes.</span><br>        <span class="hljs-attr">PreferredMaxBytes:</span> <span class="hljs-number">512</span> <span class="hljs-string">KB</span><br><br>    <span class="hljs-attr">Kafka:</span><br>        <span class="hljs-comment"># Brokers: A list of Kafka brokers to which the orderer connects</span><br>        <span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> Use IP:port notation</span><br>        <span class="hljs-attr">Brokers:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9092</span><br><br>    <span class="hljs-comment"># Organizations is the list of orgs which are defined as participants on</span><br>    <span class="hljs-comment"># the orderer side of the network</span><br>    <span class="hljs-attr">Organizations:</span><br><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   SECTION: Application</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#   - This section defines the values to encode into a config transaction or</span><br><span class="hljs-comment">#   genesis block for application related parameters</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">################################################################################</span><br><span class="hljs-attr">Application:</span> <span class="hljs-meta">&amp;ApplicationDefaults</span><br><br>    <span class="hljs-comment"># Organizations is the list of orgs which are defined as participants on</span><br>    <span class="hljs-comment"># the application side of the network</span><br>    <span class="hljs-attr">Organizations:</span><br></code></pre></td></tr></table></figure>
<h2 id="docker-compose-的配置文件分析">docker-compose 的配置文件分析</h2>
<p>服务的定义依赖关系大概是 peer-base.yaml -&gt; docker-compose-base.yaml -&gt; docker-compose-cli.yaml。</p>
<h3 id="常见环境变量前缀">常见环境变量前缀</h3>
<p>Orderer 相关的环境变量开头是<code>ORDERER_GENERAL_</code>。</p>
<p>Peer 相关的环境变量开头是<code>CORE_PEER_</code>。</p>
<p>其他环境变量开头是<code>CORE_</code>。</p>
<h3 id="peer-base-yaml">peer-base.yaml</h3>
<p>启动 chaincode 容器都是在本<strong>网桥</strong>网络里启动的。</p>
<p>它的工作目录是<code>/opt/gopath/src/github.com/hyperledger/fabric/peer</code>。二进制的可执行文件应该都在 gopath 下。</p>
<p>它的工作路径里有二进制的 peer 文件，所以可以直接<code>peer node start</code>启动。</p>
<p>它的所谓的 vm enpoint 看起来就是容器服务治理的思路，用 port 来做 endpoint 的端点<code>CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 这个文件夹是纯净的，与 example 组织无关。</span><br><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">peer-base:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">hyperledger/fabric-peer:$IMAGE_TAG</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span><br>      <span class="hljs-comment"># 用默认的网桥网络来启动链码容器。</span><br>      <span class="hljs-comment"># the following setting starts chaincode containers on the same</span><br>      <span class="hljs-comment"># bridge network as the peers</span><br>      <span class="hljs-comment"># https://docs.docker.com/compose/networking/</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=$&#123;COMPOSE_PROJECT_NAME&#125;_byfn</span><br>      <span class="hljs-comment">#- CORE_LOGGING_LEVEL=ERROR</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_LOGGING_LEVEL=DEBUG</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_ENABLED=true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_USELEADERELECTION=true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_ORGLEADER=false</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_PROFILE_ENABLED=true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt</span><br>    <span class="hljs-attr">working_dir:</span> <span class="hljs-string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">peer</span> <span class="hljs-string">node</span> <span class="hljs-string">start</span><br></code></pre></td></tr></table></figure>
<h3 id="docker-compose-base-yaml">docker-compose-base.yaml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-comment"># orderer 的配置</span><br>  <span class="hljs-attr">orderer.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">orderer.example.com</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">hyperledger/fabric-orderer:$IMAGE_TAG</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_LOGLEVEL=debug</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_LISTENADDRESS=0.0.0.0</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_GENESISMETHOD=file</span><br>      <span class="hljs-comment"># 这个给 orderer 准备的创世区块，看下面的 volumes 的映射</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_LOCALMSPID=OrdererMSP</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp</span><br>      <span class="hljs-comment"># enabled TLS</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_TLS_ENABLED=true</span><br>      <span class="hljs-comment"># 服务器的 key</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key</span><br>      <span class="hljs-comment"># 服务器的证书</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt</span><br>      <span class="hljs-comment"># ca 的证书</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]</span><br>    <span class="hljs-attr">working_dir:</span> <span class="hljs-string">/opt/gopath/src/github.com/hyperledger/fabric</span><br>    <span class="hljs-comment"># 启动命令，不像 peer，不再需要加参数了。</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">orderer</span><br>    <span class="hljs-attr">volumes:</span><br>    <span class="hljs-comment"># 对创世区块的映射  </span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block</span><br>    <span class="hljs-comment"># 对 msp 文件夹的映射</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp</span><br>    <span class="hljs-comment"># 对 tls 文件夹的映射</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls</span><br>    <span class="hljs-comment"># 注意，这一步需要的命名卷，实际上就是要在 docker-compose-cli 里被顶层 volume 实例化</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">orderer.example.com:/var/hyperledger/production/orderer</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">7050</span><span class="hljs-string">:7050</span><br><br>  <span class="hljs-attr">peer0.org1.example.com:</span><br>    <span class="hljs-comment"># 经典的继承语法</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer0.org1.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">peer-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer-base</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ID=peer0.org1.example.com</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><br>      <span class="hljs-comment"># 外部的流言地址，和本机的 peer 地址一样</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_LOCALMSPID=Org1MSP</span><br>    <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/:/host/var/run/</span><br>        <span class="hljs-comment"># peer 容器必备：MSP 与 TLS 文件夹</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">peer0.org1.example.com:/var/hyperledger/production</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">7051</span><span class="hljs-string">:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">7053</span><span class="hljs-string">:7053</span><br><br>  <span class="hljs-attr">peer1.org1.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer1.org1.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">peer-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer-base</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ID=peer1.org1.example.com</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ADDRESS=peer1.org1.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_LOCALMSPID=Org1MSP</span><br>    <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/:/host/var/run/</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp:/etc/hyperledger/fabric/msp</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls:/etc/hyperledger/fabric/tls</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">peer1.org1.example.com:/var/hyperledger/production</span><br><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">8051</span><span class="hljs-string">:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">8053</span><span class="hljs-string">:7053</span><br><br>  <span class="hljs-attr">peer0.org2.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer0.org2.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">peer-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer-base</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ID=peer0.org2.example.com</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ADDRESS=peer0.org2.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org2.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org2.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_LOCALMSPID=Org2MSP</span><br>    <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/:/host/var/run/</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/msp:/etc/hyperledger/fabric/msp</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls:/etc/hyperledger/fabric/tls</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">peer0.org2.example.com:/var/hyperledger/production</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">9051</span><span class="hljs-string">:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">9053</span><span class="hljs-string">:7053</span><br>  <span class="hljs-comment"># 所有节点的变化：</span><br>  <span class="hljs-comment"># 1 修改 service name。</span><br>  <span class="hljs-comment"># 2 修改 container_name</span><br>  <span class="hljs-comment"># 3 修改本 peer 地址</span><br>  <span class="hljs-comment"># 4 修改 gossip 相关，实际上还是本机地址</span><br>  <span class="hljs-attr">peer1.org2.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer1.org2.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">peer-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer-base</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ID=peer1.org2.example.com</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ADDRESS=peer1.org2.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org2.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_GOSSIP_BOOTSTRAP=peer1.org2.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_LOCALMSPID=Org2MSP</span><br>    <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/:/host/var/run/</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/msp:/etc/hyperledger/fabric/msp</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls:/etc/hyperledger/fabric/tls</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">peer1.org2.example.com:/var/hyperledger/production</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">10051</span><span class="hljs-string">:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">10053</span><span class="hljs-string">:7053</span><br></code></pre></td></tr></table></figure>
<h3 id="docker-compose-cli-yaml">docker-compose-cli.yaml</h3>
<p>在cli 容器内的的Gopath 就是普通的 /opt/gopath。</p>
<p>在容器内有四个已经写好的目录，要映射到本地目录上才能用，映射关系大致是：</p>
<p>./…/chaincode/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go<br>
./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/：脚本的位置，这里应该可以放一些让容器外的控制命令操纵整个 fabric 的脚本。<br>
./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts：当然这就是 channel 的器物所在地了。 本身的相关文件的放置地。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 当前 compose 语法已经升级到了 version 3了。</span><br><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2&#x27;</span><br><br><span class="hljs-comment"># 官方文档的释义，大义是顶级的 volume 元素是为了在不同的 service 之间共享 volume 而准备的。</span><br><span class="hljs-comment"># You can mount a host path as part of a definition for a single service, and there is no need to define it in the top level volumes key.</span><br><span class="hljs-comment"># But, if you want to reuse a volume across multiple services, then define a named volume in the top-level volumes key. Use named volumes with services, swarms, and stack files.</span><br><span class="hljs-attr">volumes:</span><br>  <span class="hljs-comment"># 这个语法相当于声明了若干个命名卷。不同的容器之间把相同的卷挂载到自己本地的路径里，就相当于打通了两个容器的数据共享。</span><br>  <span class="hljs-comment"># 注意，命名卷的开头并不是路径形式的，所以不要求当前的 host 有这个名字的绝对路径或者相对路径。</span><br>  <span class="hljs-attr">orderer.ORDERER_DOMAIN:</span><br>  <span class="hljs-attr">peer0.org1.example.com:</span><br>  <span class="hljs-attr">peer1.org1.example.com:</span><br>  <span class="hljs-attr">peer0.org2.example.com:</span><br>  <span class="hljs-attr">peer1.org2.example.com:</span><br><br><span class="hljs-comment"># 一个顶级网络名称，供服务之间引用</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">byfn:</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">orderer.ORDERER_DOMAIN:</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>   <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">orderer.ORDERER_DOMAIN</span><br>    <span class="hljs-comment"># 在这里虽然可以覆盖 container name，但有必要么？</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">orderer.ORDERER_DOMAIN</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-comment"># 这是要加入的网络名称</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer0.org1.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer0.org1.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer0.org1.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer1.org1.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer1.org1.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer1.org1.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer0.org2.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer0.org2.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer0.org2.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer1.org2.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer1.org2.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer1.org2.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">cli:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">cli</span><br>    <span class="hljs-comment"># 这里不继承任何配置文件，而是直接使用镜像初始化容器</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">hyperledger/fabric-tools:$IMAGE_TAG</span><br>    <span class="hljs-attr">tty:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">GOPATH=/opt/gopath</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_LOGGING_LEVEL=DEBUG</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ID=cli</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_LOCALMSPID=Org1MSP</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_ENABLED=true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span><br>    <span class="hljs-attr">working_dir:</span> <span class="hljs-string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span><br>    <span class="hljs-comment"># 容器运行的时候，就会在内部的 console 里启动这段命令。类似我们经常 docker run 使用的 /bin/bash 一样。</span><br>    <span class="hljs-comment"># 在这里我们传导了两个关键的环境变量进去，一个频道名，一个延迟。这也是目前唯二的还能在 cli 容器启动时改变的东西了。</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/bash</span> <span class="hljs-string">-c</span> <span class="hljs-string">&#x27;./scripts/script.sh $&#123;CHANNEL_NAME&#125; $&#123;DELAY&#125;; sleep $TIMEOUT&#x27;</span><br>    <span class="hljs-attr">volumes:</span><br>        <span class="hljs-comment"># host 上路径: 容器内路径</span><br>        <span class="hljs-comment"># 映射本机的运行时配置文件到容器内。</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/:/host/var/run/</span><br>        <span class="hljs-comment"># ：这就是链码的主要位置了，看来这个目录也是镜像里就写死的，要写自定义的链码也只能从这里安装进去。</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./../chaincode/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-comment"># 等这些 service 启动完了，再启动自己这个 service。</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">orderer.ORDERER_DOMAIN</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">peer0.org1.example.com</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">peer1.org1.example.com</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">peer0.org2.example.com</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">peer1.org2.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br></code></pre></td></tr></table></figure>
<h3 id="docker-compose-e2e-template-yaml">docker-compose-e2e-template.yaml</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Copyright IBM Corp. All Rights Reserved.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># 这个文件会被 byfn.sh 的 replacePrivateKey() 函数生成实际的 docker-compose-e2e.yaml。</span><br><span class="hljs-comment"># 然后被 sed 命令另作他用。</span><br><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2&#x27;</span><br><br><span class="hljs-attr">volumes:</span><br>  <span class="hljs-attr">orderer.example.com:</span><br>  <span class="hljs-attr">peer0.org1.example.com:</span><br>  <span class="hljs-attr">peer1.org1.example.com:</span><br>  <span class="hljs-attr">peer0.org2.example.com:</span><br>  <span class="hljs-attr">peer1.org2.example.com:</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">byfn:</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">ca0:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">hyperledger/fabric-ca:$IMAGE_TAG</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_CA_NAME=ca-org1</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_TLS_ENABLED=true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_TLS_CERTFILE=/etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_TLS_KEYFILE=/etc/hyperledger/fabric-ca-server-config/CA1_PRIVATE_KEY</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;7054:7054&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">sh</span> <span class="hljs-string">-c</span> <span class="hljs-string">&#x27;fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/CA1_PRIVATE_KEY -b admin:adminpw -d&#x27;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./crypto-config/peerOrganizations/org1.example.com/ca/:/etc/hyperledger/fabric-ca-server-config</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ca_peerOrg1</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">ca1:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">hyperledger/fabric-ca:$IMAGE_TAG</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_CA_NAME=ca-org2</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_TLS_ENABLED=true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_TLS_CERTFILE=/etc/hyperledger/fabric-ca-server-config/ca.org2.example.com-cert.pem</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">FABRIC_CA_SERVER_TLS_KEYFILE=/etc/hyperledger/fabric-ca-server-config/CA2_PRIVATE_KEY</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8054:7054&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">sh</span> <span class="hljs-string">-c</span> <span class="hljs-string">&#x27;fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org2.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/CA2_PRIVATE_KEY -b admin:adminpw -d&#x27;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./crypto-config/peerOrganizations/org2.example.com/ca/:/etc/hyperledger/fabric-ca-server-config</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ca_peerOrg2</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">orderer.example.com:</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>   <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">orderer.example.com</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">orderer.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer0.org1.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer0.org1.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer0.org1.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer1.org1.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer1.org1.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer1.org1.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer0.org2.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer0.org2.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer0.org2.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br><br>  <span class="hljs-attr">peer1.org2.example.com:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">peer1.org2.example.com</span><br>    <span class="hljs-attr">extends:</span><br>      <span class="hljs-attr">file:</span>  <span class="hljs-string">base/docker-compose-base.yaml</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">peer1.org2.example.com</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">byfn</span><br></code></pre></td></tr></table></figure>
<h3 id="byfn-sh"><a target="_blank" rel="noopener" href="http://byfn.sh">byfn.sh</a></h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Copyright IBM Corp All Rights Reserved</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-comment"># This script will orchestrate a sample end-to-end execution of the Hyperledger</span><br><span class="hljs-comment"># Fabric network.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># The end-to-end verification provisions a sample Fabric network consisting of</span><br><span class="hljs-comment"># two organizations, each maintaining two peers, and a “solo” ordering service.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This verification makes use of two fundamental tools, which are necessary to</span><br><span class="hljs-comment"># create a functioning transactional network with digital signature validation</span><br><span class="hljs-comment"># and access control:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># * cryptogen - generates the x509 certificates used to identify and</span><br><span class="hljs-comment">#   authenticate the various components in the network.</span><br><span class="hljs-comment"># * configtxgen - generates the requisite configuration artifacts for orderer</span><br><span class="hljs-comment">#   bootstrap and channel creation.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Each tool consumes a configuration yaml file, within which we specify the topology</span><br><span class="hljs-comment"># of our network (cryptogen) and the location of our certificates for various</span><br><span class="hljs-comment"># configuration operations (configtxgen).  Once the tools have been successfully run,</span><br><span class="hljs-comment"># we are able to launch our network.  More detail on the tools and the structure of</span><br><span class="hljs-comment"># the network will be provided later in this document.  For now, let&#x27;s get going...</span><br><br><span class="hljs-comment"># prepending $PWD/../bin to PATH to ensure we are picking up the correct binaries</span><br><span class="hljs-comment"># this may be commented out to resolve installed version of tools if desired</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$&#123;PWD&#125;</span>/../bin:<span class="hljs-variable">$&#123;PWD&#125;</span>:<span class="hljs-variable">$PATH</span><br><span class="hljs-comment"># 这个环境变量很重要，这里的 export 保证这个变量是在 environment 里。可以被子进程（另一个 shell 脚本继承）。</span><br><span class="hljs-comment"># 并不是所有的父进程里的 variable 都会被子进程看到的。</span><br><span class="hljs-built_in">export</span> FABRIC_CFG_PATH=<span class="hljs-variable">$&#123;PWD&#125;</span><br><br><span class="hljs-comment"># Print the usage message</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">printHelp</span></span> () &#123;<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: &quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m up|down|restart|generate [-c &lt;channel name&gt;] [-t &lt;timeout&gt;] [-d &lt;delay&gt;] [-f &lt;docker-compose-file&gt;] [-s &lt;dbtype&gt;] [-i &lt;imagetag&gt;]&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -h|--help (print this message)&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;    -m &lt;mode&gt; - one of &#x27;up&#x27;, &#x27;down&#x27;, &#x27;restart&#x27; or &#x27;generate&#x27;&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;      - &#x27;up&#x27; - bring up the network with docker-compose up&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;      - &#x27;down&#x27; - clear the network with docker-compose down&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;      - &#x27;restart&#x27; - restart the network&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;      - &#x27;generate&#x27; - generate required certificates and genesis block&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;    -c &lt;channel name&gt; - channel name to use (defaults to \&quot;mychannel\&quot;)&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;    -t &lt;timeout&gt; - CLI timeout duration in microseconds (defaults to 10000)&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;    -d &lt;delay&gt; - delay duration in seconds (defaults to 3)&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;    -f &lt;docker-compose-file&gt; - specify which docker-compose file use (defaults to docker-compose-cli.yaml)&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;    -s &lt;dbtype&gt; - the database backend to use: goleveldb (default) or couchdb&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;    -i &lt;imagetag&gt; - pass the image tag to launch the network using the tag: 1.0.1, 1.0.2, 1.0.3, 1.0.4 (defaults to latest)&quot;</span><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Typically, one would first generate the required certificates and &quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;genesis block, then bring up the network. e.g.:&quot;</span><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m generate -c mychannel&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m up -c mychannel -s couchdb&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m up -c mychannel -s couchdb -i 1.0.6&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m down -c mychannel&quot;</span><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Taking all defaults:&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m generate&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m up&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  byfn.sh -m down&quot;</span><br>&#125;<br><br><span class="hljs-comment"># Ask user for confirmation to proceed</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">askProceed</span></span> () &#123;<br>  <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;Continue (y/n)? &quot;</span> ans<br>  <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$ans</span>&quot;</span> <span class="hljs-keyword">in</span><br>    y|Y )<br>      <span class="hljs-comment"># 只有这个地方会正常走下去</span><br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;proceeding ...&quot;</span><br>    <span class="hljs-comment"># 这个双分号是 case 的休止符</span><br>    ;;<br>    n|N )<br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;exiting...&quot;</span><br>      <span class="hljs-built_in">exit</span> 1<br>    ;;<br>    * )<br>      <span class="hljs-comment"># 这里会递归</span><br>      <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;invalid response&quot;</span><br>      askProceed<br>    ;;<br>  <span class="hljs-keyword">esac</span><br>&#125;<br><br><span class="hljs-comment"># Obtain CONTAINER_IDS and remove them</span><br><span class="hljs-comment"># TODO Might want to make this optional - could clear other containers</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">clearContainers</span></span> () &#123;<br>  <span class="hljs-comment"># -a 表示输出全部容器，-q 表示只输出容器 id，这样就可以迭代使用了</span><br>  <span class="hljs-comment"># 结果大概是这样</span><br>  <span class="hljs-comment"># 8a25b455f05e</span><br>  <span class="hljs-comment"># d2d84545a902</span><br>  <span class="hljs-comment"># c67d337e5bd9</span><br>  <span class="hljs-comment"># e5cbd8457caf</span><br>  <span class="hljs-comment"># 9ee6a1cb33c1</span><br>  <span class="hljs-comment"># a0df580d4633</span><br>  <span class="hljs-comment"># cb6b441b083f</span><br>  <span class="hljs-comment"># 0c87d55710c8</span><br>  <span class="hljs-comment"># c24f3eb2e0e0</span><br>  CONTAINER_IDS=$(docker ps -aq)<br>  <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$CONTAINER_IDS</span>&quot;</span> -o <span class="hljs-string">&quot;<span class="hljs-variable">$CONTAINER_IDS</span>&quot;</span> == <span class="hljs-string">&quot; &quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;---- No containers available for deletion ----&quot;</span><br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-comment"># 直接拿这个列表来 rm，而不用再 xargs 了。</span><br>    docker <span class="hljs-built_in">rm</span> -f <span class="hljs-variable">$CONTAINER_IDS</span><br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-comment"># Delete any images that were generated as a part of this setup</span><br><span class="hljs-comment"># specifically the following images are often left behind:</span><br><span class="hljs-comment"># TODO list generated image naming patterns</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">removeUnwantedImages</span></span>() &#123;<br>  <span class="hljs-comment"># 用 awk 来截取多段输出的好例子。</span><br>  <span class="hljs-comment"># 注意在这里我们可以看到不要乱改 peer 的名字，不然不能在这里搞到所有的 image_id。</span><br>  <span class="hljs-comment"># $()的形式可以把命令求和为一个匿名变量。</span><br>  DOCKER_IMAGE_IDS=$(docker images | grep <span class="hljs-string">&quot;dev\|none\|test-vp\|peer[0-9]-&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span>)<br>  <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$DOCKER_IMAGE_IDS</span>&quot;</span> -o <span class="hljs-string">&quot;<span class="hljs-variable">$DOCKER_IMAGE_IDS</span>&quot;</span> == <span class="hljs-string">&quot; &quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;---- No images available for deletion ----&quot;</span><br>  <span class="hljs-keyword">else</span><br>    docker rmi -f <span class="hljs-variable">$DOCKER_IMAGE_IDS</span><br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-comment"># Generate the needed certificates, the genesis block and start the network.</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">networkUp</span></span> () &#123;<br>  <span class="hljs-comment"># generate artifacts if they don&#x27;t exist</span><br>  <span class="hljs-comment"># 确认一个目录是否存在的命令</span><br>  <span class="hljs-keyword">if</span> [ ! -d <span class="hljs-string">&quot;crypto-config&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-comment"># 第一步，生成证书。其实不只是生成证书，还生成证书相关的东西。</span><br>    generateCerts<br>    replacePrivateKey<br>    generateChannelArtifacts<br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;IF_COUCHDB&#125;</span>&quot;</span> == <span class="hljs-string">&quot;couchdb&quot;</span> ]; <span class="hljs-keyword">then</span><br>      IMAGE_TAG=<span class="hljs-variable">$IMAGETAG</span> CHANNEL_NAME=<span class="hljs-variable">$CHANNEL_NAME</span> TIMEOUT=<span class="hljs-variable">$CLI_TIMEOUT</span> DELAY=<span class="hljs-variable">$CLI_DELAY</span> docker-compose -f <span class="hljs-variable">$COMPOSE_FILE</span> -f <span class="hljs-variable">$COMPOSE_FILE_COUCH</span> up -d 2&gt;&amp;1<br>  <span class="hljs-keyword">else</span><br>      <span class="hljs-comment"># 这一行让 Docker-Compose 来按照配置文件装配容器配置，生成由容器组成的项目网络</span><br>      <span class="hljs-comment"># cli 容器起来以后，会自己去创建频道、一个一个地把容器加入网络中。一个一个地初始化链码，一个一个地测试链码。</span><br>      IMAGE_TAG=<span class="hljs-variable">$IMAGETAG</span> CHANNEL_NAME=<span class="hljs-variable">$CHANNEL_NAME</span> TIMEOUT=<span class="hljs-variable">$CLI_TIMEOUT</span> DELAY=<span class="hljs-variable">$CLI_DELAY</span> docker-compose -f <span class="hljs-variable">$COMPOSE_FILE</span> up -d 2&gt;&amp;1<br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ERROR !!!! Unable to start network&quot;</span><br>    <span class="hljs-comment"># 这个命令就是去读一个容器启动的 command 在 console 里的输出。</span><br>    docker logs -f cli<br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br>  docker logs -f cli<br>&#125;<br><br><span class="hljs-comment"># Tear down running network</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">networkDown</span></span> () &#123;<br>  docker-compose -f <span class="hljs-variable">$COMPOSE_FILE</span> down --volumes<br>  docker-compose -f <span class="hljs-variable">$COMPOSE_FILE</span> -f <span class="hljs-variable">$COMPOSE_FILE_COUCH</span> down --volumes<br>  <span class="hljs-comment"># Don&#x27;t remove the generated artifacts -- note, the ledgers are always removed</span><br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> != <span class="hljs-string">&quot;restart&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-comment"># Bring the containers down deleting their volumes</span><br>    <span class="hljs-comment">#Cleanup the chaincode containers</span><br>    clearContainers<br>    <span class="hljs-comment">#Cleanup images</span><br>    removeUnwantedImages<br>    <span class="hljs-comment"># remove orderer block and other channel configuration transactions and certs</span><br>    <span class="hljs-built_in">rm</span> -rf channel-artifacts/*.block channel-artifacts/*.tx crypto-config<br>    <span class="hljs-comment"># remove the docker-compose yaml file that was customized to the example</span><br>    <span class="hljs-built_in">rm</span> -f docker-compose-e2e.yaml<br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-comment"># 但这个文件有什么用呢？docker-compose-e2e-template.yaml </span><br><span class="hljs-comment"># Using docker-compose-e2e-template.yaml, replace constants with private key file names</span><br><span class="hljs-comment"># generated by the cryptogen tool and output a docker-compose.yaml specific to this</span><br><span class="hljs-comment"># configuration</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">replacePrivateKey</span></span> () &#123;<br>  <span class="hljs-comment"># sed on MacOSX does not support -i flag with a null extension. We will use</span><br>  <span class="hljs-comment"># &#x27;t&#x27; for our back-up&#x27;s extension and depete it at the end of the function</span><br>  ARCH=`<span class="hljs-built_in">uname</span> -s | grep Darwin`<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$ARCH</span>&quot;</span> == <span class="hljs-string">&quot;Darwin&quot;</span> ]; <span class="hljs-keyword">then</span><br>    OPTS=<span class="hljs-string">&quot;-it&quot;</span><br>  <span class="hljs-keyword">else</span><br>    OPTS=<span class="hljs-string">&quot;-i&quot;</span><br>  <span class="hljs-keyword">fi</span><br><br>  <span class="hljs-comment"># Copy the template to the file that will be modified to add the private key</span><br>  <span class="hljs-built_in">cp</span> docker-compose-e2e-template.yaml docker-compose-e2e.yaml<br><br>  <span class="hljs-comment"># The next steps will replace the template&#x27;s contents with the</span><br>  <span class="hljs-comment"># actual values of the private key file names for the two CAs.</span><br>  <span class="hljs-comment"># 把当前的父文件夹记住</span><br>  CURRENT_DIR=<span class="hljs-variable">$PWD</span><br>  <span class="hljs-built_in">cd</span> crypto-config/peerOrganizations/org1.example.com/ca/<br>  PRIV_KEY=$(<span class="hljs-built_in">ls</span> *_sk)<br>  <span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-variable">$CURRENT_DIR</span>&quot;</span><br>  sed <span class="hljs-variable">$OPTS</span> <span class="hljs-string">&quot;s/CA1_PRIVATE_KEY/<span class="hljs-variable">$&#123;PRIV_KEY&#125;</span>/g&quot;</span> docker-compose-e2e.yaml<br>  <span class="hljs-built_in">cd</span> crypto-config/peerOrganizations/org2.example.com/ca/<br>  PRIV_KEY=$(<span class="hljs-built_in">ls</span> *_sk)<br>  <span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-variable">$CURRENT_DIR</span>&quot;</span><br>  sed <span class="hljs-variable">$OPTS</span> <span class="hljs-string">&quot;s/CA2_PRIVATE_KEY/<span class="hljs-variable">$&#123;PRIV_KEY&#125;</span>/g&quot;</span> docker-compose-e2e.yaml<br>  <span class="hljs-comment"># If MacOSX, remove the temporary backup of the docker-compose file</span><br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$ARCH</span>&quot;</span> == <span class="hljs-string">&quot;Darwin&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">rm</span> docker-compose-e2e.yamlt<br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-comment"># X.509只是 PKI 密码学架构的一个实现。</span><br><span class="hljs-comment"># ca-cert 是根证书。</span><br><span class="hljs-comment"># 为什么 count 必须放在这个文件里面。</span><br><span class="hljs-comment"># 这个函数不止生成证书，还有 keystore。</span><br><span class="hljs-comment"># 私钥签署，公钥验证！而不是公钥签署，私钥验证！</span><br><span class="hljs-comment"># We will use the cryptogen tool to generate the cryptographic material (x509 certs)</span><br><span class="hljs-comment"># for our various network entities.  The certificates are based on a standard PKI</span><br><span class="hljs-comment"># implementation where validation is achieved by reaching a common trust anchor.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Cryptogen consumes a file - ``crypto-config.yaml`` - that contains the network</span><br><span class="hljs-comment"># topology and allows us to generate a library of certificates for both the</span><br><span class="hljs-comment"># Organizations and the components that belong to those Organizations.  Each</span><br><span class="hljs-comment"># Organization is provisioned a unique root certificate (``ca-cert``), that binds</span><br><span class="hljs-comment"># specific components (peers and orderers) to that Org.  Transactions and communications</span><br><span class="hljs-comment"># within Fabric are signed by an entity&#x27;s private key (``keystore``), and then verified</span><br><span class="hljs-comment"># by means of a public key (``signcerts``).  You will notice a &quot;count&quot; variable within</span><br><span class="hljs-comment"># this file.  We use this to specify the number of peers per Organization; in our</span><br><span class="hljs-comment"># case it&#x27;s two peers per Org.  The rest of this template is extremely</span><br><span class="hljs-comment"># self-explanatory.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># After we run the tool, the certs will be parked in a folder titled ``crypto-config``.</span><br><br><span class="hljs-comment"># Generates Org certs using cryptogen tool</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">generateCerts</span></span> ()&#123;<br>  <span class="hljs-built_in">which</span> cryptogen<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;cryptogen tool not found. exiting&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;##########################################################&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;##### Generate certificates using cryptogen tool #########&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;##########################################################&quot;</span><br>  <span class="hljs-keyword">if</span> [ -d <span class="hljs-string">&quot;crypto-config&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">rm</span> -Rf crypto-config<br>  <span class="hljs-keyword">fi</span><br>  cryptogen generate --config=./crypto-config.yaml<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Failed to generate certificates...&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-comment"># 每一个新的 org 都要有一个 anchor 节点。这也就意味着不仅配置文件里要有相关的配置，也意味着初始化步骤里</span><br><span class="hljs-comment"># 要有相关的配置命令。</span><br><span class="hljs-comment"># 把三件事做起来：</span><br><span class="hljs-comment"># 1 生成创世区块。 2 生成频道配置 3 配置锚节点。</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># The `configtxgen tool is used to create four artifacts: orderer **bootstrap</span><br><span class="hljs-comment"># block**, fabric **channel configuration transaction**, and two **anchor</span><br><span class="hljs-comment"># peer transactions** - one for each Peer Org.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># The orderer block is the genesis block for the ordering service, and the</span><br><span class="hljs-comment"># channel transaction file is broadcast to the orderer at channel creation</span><br><span class="hljs-comment"># time.  The anchor peer transactions, as the name might suggest, specify each</span><br><span class="hljs-comment"># Org&#x27;s anchor peer on this channel.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Configtxgen consumes a file - ``configtx.yaml`` - that contains the definitions</span><br><span class="hljs-comment"># for the sample network. There are three members - one Orderer Org (``OrdererOrg``)</span><br><span class="hljs-comment"># and two Peer Orgs (``Org1`` &amp; ``Org2``) each managing and maintaining two peer nodes.</span><br><span class="hljs-comment"># This file also specifies a consortium - ``SampleConsortium`` - consisting of our</span><br><span class="hljs-comment"># two Peer Orgs.  Pay specific attention to the &quot;Profiles&quot; section at the top of</span><br><span class="hljs-comment"># this file.  You will notice that we have two unique headers. One for the orderer genesis</span><br><span class="hljs-comment"># block - ``TwoOrgsOrdererGenesis`` - and one for our channel - ``TwoOrgsChannel``.</span><br><span class="hljs-comment"># These headers are important, as we will pass them in as arguments when we create</span><br><span class="hljs-comment"># our artifacts.  This file also contains two additional specifications that are worth</span><br><span class="hljs-comment"># noting.  Firstly, we specify the anchor peers for each Peer Org</span><br><span class="hljs-comment"># (``peer0.org1.example.com`` &amp; ``peer0.org2.example.com``).  Secondly, we point to</span><br><span class="hljs-comment"># the location of the MSP directory for each member, in turn allowing us to store the</span><br><span class="hljs-comment"># root certificates for each Org in the orderer genesis block.  This is a critical</span><br><span class="hljs-comment"># concept. Now any network entity communicating with the ordering service can have</span><br><span class="hljs-comment"># its digital signature verified.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This function will generate the crypto material and our four configuration</span><br><span class="hljs-comment"># artifacts, and subsequently output these files into the ``channel-artifacts``</span><br><span class="hljs-comment"># folder.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># If you receive the following warning, it can be safely ignored:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># [bccsp] GetDefault -&gt; WARN 001 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># You can ignore the logs regarding intermediate certs, we are not using them in</span><br><span class="hljs-comment"># this crypto implementation.</span><br><br><span class="hljs-comment"># Generate orderer genesis block, channel configuration transaction and</span><br><span class="hljs-comment"># anchor peer update transactions</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">generateChannelArtifacts</span></span>() &#123;<br>  <span class="hljs-comment"># 检测一个命令是不是存在</span><br>  <span class="hljs-built_in">which</span> configtxgen<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;configtxgen tool not found. exiting&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;##########################################################&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#########  Generating Orderer Genesis block ##############&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;##########################################################&quot;</span><br>  <span class="hljs-comment"># Note: For some unknown reason (at least for now) the block file can&#x27;t be</span><br>  <span class="hljs-comment"># named orderer.genesis.block or the orderer will fail to launch!</span><br>  <span class="hljs-comment"># 1 生成创世区块</span><br>  configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Failed to generate orderer genesis block...&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#################################################################&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;### Generating channel configuration transaction &#x27;channel.tx&#x27; ###&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#################################################################&quot;</span><br>  <span class="hljs-comment"># 2 生成频道配置，实际上就是 channel 事务。</span><br>  configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID <span class="hljs-variable">$CHANNEL_NAME</span><br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Failed to generate channel configuration transaction...&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#################################################################&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#######    Generating anchor peer update for Org1MSP   ##########&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#################################################################&quot;</span><br>  <span class="hljs-comment"># configtxgen -help 可以看到它的各种 options。其中 outputAnchorPeersUpdate 只能在创建缺省频道（实际上自定义频道也可以），和最初建 anchor 时才可以使用。</span><br>  <span class="hljs-comment"># 这个 channel 名和 asOrg 参数共同决定 Org1MSPanchors.tx 的内容。</span><br>  configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID <span class="hljs-variable">$CHANNEL_NAME</span> -asOrg Org1MSP<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Failed to generate anchor peer update for Org1MSP...&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#################################################################&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#######    Generating anchor peer update for Org2MSP   ##########&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#################################################################&quot;</span><br>  configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate \<br>  ./channel-artifacts/Org2MSPanchors.tx -channelID <span class="hljs-variable">$CHANNEL_NAME</span> -asOrg Org2MSP<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$?&quot;</span> -ne 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Failed to generate anchor peer update for Org2MSP...&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-comment"># 定义完函数以后，这里才是程序的起点</span><br><span class="hljs-comment"># Obtain the OS and Architecture string that will be used to select the correct</span><br><span class="hljs-comment"># native binaries for your platform</span><br>OS_ARCH=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(uname -s|tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;|sed &#x27;s/mingw64_nt.*/windows/&#x27;)</span>-<span class="hljs-subst">$(uname -m | sed &#x27;s/x86_64/amd64/g&#x27;)</span>&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print tolower($0)&#125;&#x27;</span>)<br><span class="hljs-comment"># timeout duration - the duration the CLI should wait for a response from</span><br><span class="hljs-comment"># another container before giving up</span><br>CLI_TIMEOUT=10<br><span class="hljs-comment">#default for delay</span><br>CLI_DELAY=3<br><span class="hljs-comment"># channel name defaults to &quot;mychannel&quot;</span><br>CHANNEL_NAME=<span class="hljs-string">&quot;mychannel&quot;</span><br><span class="hljs-comment"># use this as the default docker-compose yaml definition</span><br>COMPOSE_FILE=docker-compose-cli.yaml<br><span class="hljs-comment">#</span><br>COMPOSE_FILE_COUCH=docker-compose-couch.yaml<br><span class="hljs-comment"># default image tag</span><br>IMAGETAG=<span class="hljs-string">&quot;latest&quot;</span><br><span class="hljs-comment"># Parse commandline args</span><br><span class="hljs-keyword">while</span> <span class="hljs-built_in">getopts</span> <span class="hljs-string">&quot;h?m:c:t:d:f:s:i:&quot;</span> opt; <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$opt</span>&quot;</span> <span class="hljs-keyword">in</span><br>    h|\?)<br>      printHelp<br>      <span class="hljs-built_in">exit</span> 0<br>    ;;<br>    m)  MODE=<span class="hljs-variable">$OPTARG</span><br>    ;;<br>    c)  CHANNEL_NAME=<span class="hljs-variable">$OPTARG</span><br>    ;;<br>    t)  CLI_TIMEOUT=<span class="hljs-variable">$OPTARG</span><br>    ;;<br>    d)  CLI_DELAY=<span class="hljs-variable">$OPTARG</span><br>    ;;<br>    f)  COMPOSE_FILE=<span class="hljs-variable">$OPTARG</span><br>    ;;<br>    s)  IF_COUCHDB=<span class="hljs-variable">$OPTARG</span><br>    ;;<br>    i)  IMAGETAG=`<span class="hljs-built_in">uname</span> -m`<span class="hljs-string">&quot;-&quot;</span><span class="hljs-variable">$OPTARG</span><br>    ;;<br>  <span class="hljs-keyword">esac</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># Determine whether starting, stopping, restarting or generating for announce</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> == <span class="hljs-string">&quot;up&quot;</span> ]; <span class="hljs-keyword">then</span><br>  EXPMODE=<span class="hljs-string">&quot;Starting&quot;</span><br>  <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> == <span class="hljs-string">&quot;down&quot;</span> ]; <span class="hljs-keyword">then</span><br>  EXPMODE=<span class="hljs-string">&quot;Stopping&quot;</span><br>  <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> == <span class="hljs-string">&quot;restart&quot;</span> ]; <span class="hljs-keyword">then</span><br>  EXPMODE=<span class="hljs-string">&quot;Restarting&quot;</span><br>  <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$MODE</span>&quot;</span> == <span class="hljs-string">&quot;generate&quot;</span> ]; <span class="hljs-keyword">then</span><br>  EXPMODE=<span class="hljs-string">&quot;Generating certs and genesis block for&quot;</span><br><span class="hljs-keyword">else</span><br>  printHelp<br>  <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># Announce what was requested</span><br><br>  <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;IF_COUCHDB&#125;</span>&quot;</span> == <span class="hljs-string">&quot;couchdb&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;EXPMODE&#125;</span> with channel &#x27;<span class="hljs-variable">$&#123;CHANNEL_NAME&#125;</span>&#x27; and CLI timeout of &#x27;<span class="hljs-variable">$&#123;CLI_TIMEOUT&#125;</span>&#x27; using database &#x27;<span class="hljs-variable">$&#123;IF_COUCHDB&#125;</span>&#x27;&quot;</span><br>  <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;EXPMODE&#125;</span> with channel &#x27;<span class="hljs-variable">$&#123;CHANNEL_NAME&#125;</span>&#x27; and CLI timeout of &#x27;<span class="hljs-variable">$&#123;CLI_TIMEOUT&#125;</span>&#x27;&quot;</span><br>  <span class="hljs-keyword">fi</span><br><span class="hljs-comment"># ask for confirmation to proceed</span><br>askProceed<br><br><span class="hljs-comment">#Create the network using docker compose</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="hljs-string">&quot;up&quot;</span> ]; <span class="hljs-keyword">then</span><br>  networkUp<br>  <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="hljs-string">&quot;down&quot;</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">## Clear the network</span><br>  networkDown<br>  <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="hljs-string">&quot;generate&quot;</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">## Generate Artifacts</span><br>  generateCerts<br>  replacePrivateKey<br>  generateChannelArtifacts<br>  <span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="hljs-string">&quot;restart&quot;</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">## Restart the network</span><br>  networkDown<br>  networkUp<br><span class="hljs-keyword">else</span><br>  printHelp<br>  <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>
<h3 id="script-script-sh">script/script.sh</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">echo</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; ____    _____      _      ____    _____ &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/ ___|  |_   _|    / \    |  _ \  |_   _|&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;\___ \    | |     / _ \   | |_) |   | |  &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; ___) |   | |    / ___ \  |  _ &lt;    | |  &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;|____/    |_|   /_/   \_\ |_| \_\   |_|  &quot;</span><br><span class="hljs-built_in">echo</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Build your first network (BYFN) end-to-end test&quot;</span><br><span class="hljs-built_in">echo</span><br>CHANNEL_NAME=<span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span><br>DELAY=<span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span><br>: <span class="hljs-variable">$&#123;CHANNEL_NAME:=&quot;mychannel&quot;&#125;</span><br>: <span class="hljs-variable">$&#123;TIMEOUT:=&quot;60&quot;&#125;</span><br>COUNTER=1<br>MAX_RETRY=5<br><span class="hljs-comment"># 是不是使用 TLS，其实只与 orderer 和 channel 有关。</span><br>ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/ORDERER_DOMAIN/orderers/orderer.ORDERER_DOMAIN/msp/tlscacerts/tlsca.ORDERER_DOMAIN-cert.pem<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Channel name : &quot;</span><span class="hljs-variable">$CHANNEL_NAME</span><br><br><span class="hljs-comment"># verify the result of the end-to-end test</span><br><span class="hljs-function"><span class="hljs-title">verifyResult</span></span> () &#123;<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> -ne 0 ] ; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;!!!!!!!!!!!!!!! &quot;</span><span class="hljs-variable">$2</span><span class="hljs-string">&quot; !!!!!!!!!!!!!!!!&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;========= ERROR !!! FAILED to execute End-2-End Scenario ===========&quot;</span><br>    <span class="hljs-built_in">echo</span><br>      <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">setGlobals</span></span> () &#123;<br><br>  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> -eq 0 -o <span class="hljs-variable">$1</span> -eq 1 ] ; <span class="hljs-keyword">then</span><br>    CORE_PEER_LOCALMSPID=<span class="hljs-string">&quot;Org1MSP&quot;</span><br>    CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt<br>    CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp<br>    <span class="hljs-comment"># 传进来不同的命令，更改的核心环境变量指标是容器的 endpoint 地址。也就是CORE_PEER_ADDRESS。相同组织的 enpoint 使用的是相同的 MSP 密码学目录。</span><br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> -eq 0 ]; <span class="hljs-keyword">then</span><br>      CORE_PEER_ADDRESS=peer0.org1.example.com:7051<br>    <span class="hljs-keyword">else</span><br>      CORE_PEER_ADDRESS=peer1.org1.example.com:7051<br>      <span class="hljs-comment"># 此处有重复，疑为错误。但 github 上原版的代码就是这样写的。</span><br>      CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp<br>    <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">else</span><br>    CORE_PEER_LOCALMSPID=<span class="hljs-string">&quot;Org2MSP&quot;</span><br>    CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt<br>    CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp<br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> -eq 2 ]; <span class="hljs-keyword">then</span><br>      CORE_PEER_ADDRESS=peer0.org2.example.com:7051<br>    <span class="hljs-keyword">else</span><br>      CORE_PEER_ADDRESS=peer1.org2.example.com:7051<br>    <span class="hljs-keyword">fi</span><br>  <span class="hljs-keyword">fi</span><br><br>  <span class="hljs-built_in">env</span> |grep CORE<br>&#125;<br><br><span class="hljs-comment"># 创建频道是第一步</span><br><span class="hljs-function"><span class="hljs-title">createChannel</span></span>() &#123;<br>  <span class="hljs-comment"># 把 cli 内的全局变量设置为0系列</span><br>  setGlobals 0<br><br>  <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> -o <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> = <span class="hljs-string">&quot;false&quot;</span> ]; <span class="hljs-keyword">then</span><br>      <span class="hljs-comment"># 1 -o 是 orderer string，实际上就是从cli 容器出发，可以读到的容器地址，这里还要考虑容器网络连通性问题。-c 是频道名。channel.tx是不可读文件。</span><br>      <span class="hljs-comment"># 换言之，如果我们有足够多的创世区块，和 channel.tx。我们可以在一个 cli 容器里面生成多个频道。</span><br>      <span class="hljs-comment"># 2 实际上我们从这一步开始，就知道了 orderer 才是最先 join 进这个 channel 里的一个节点。</span><br>      <span class="hljs-comment"># 3 几乎所有的频道、peer、orderer 节点相关的操作，都要依靠这个 peer channel 命令开头的系列命令。</span><br>      <span class="hljs-comment"># 4 channel id 就是 channel name。</span><br>    peer channel create -o orderer.ORDERER_DOMAIN:7050 -c <span class="hljs-variable">$CHANNEL_NAME</span> -f ./channel-artifacts/channel.tx &gt;&amp;log.txt<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-comment"># 注意，如果需要打开 tls，那么这个--cafile选项特别特别重要。</span><br>    peer channel create -o orderer.ORDERER_DOMAIN:7050 -c <span class="hljs-variable">$CHANNEL_NAME</span> -f ./channel-artifacts/channel.tx --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> &gt;&amp;log.txt<br>  <span class="hljs-keyword">fi</span><br>  res=$?<br>  <span class="hljs-built_in">cat</span> log.txt<br>  verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">&quot;Channel creation failed&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== Channel \&quot;<span class="hljs-variable">$CHANNEL_NAME</span>\&quot; is created successfully ===================== &quot;</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">updateAnchorPeers</span></span>() &#123;<br>  PEER=<span class="hljs-variable">$1</span><br>  setGlobals <span class="hljs-variable">$PEER</span><br><br>  <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> -o <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> = <span class="hljs-string">&quot;false&quot;</span> ]; <span class="hljs-keyword">then</span><br>      <span class="hljs-comment"># 生成的 anchor artifact 到这里才有用。这样才算真的把锚节点注册上去了。</span><br>    peer channel update -o orderer.ORDERER_DOMAIN:7050 -c <span class="hljs-variable">$CHANNEL_NAME</span> -f ./channel-artifacts/<span class="hljs-variable">$&#123;CORE_PEER_LOCALMSPID&#125;</span>anchors.tx &gt;&amp;log.txt<br>  <span class="hljs-keyword">else</span><br>    peer channel update -o orderer.ORDERER_DOMAIN:7050 -c <span class="hljs-variable">$CHANNEL_NAME</span> -f ./channel-artifacts/<span class="hljs-variable">$&#123;CORE_PEER_LOCALMSPID&#125;</span>anchors.tx --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> &gt;&amp;log.txt<br>  <span class="hljs-keyword">fi</span><br>  res=$?<br>  <span class="hljs-built_in">cat</span> log.txt<br>  verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">&quot;Anchor peer update failed&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== Anchor peers for org \&quot;<span class="hljs-variable">$CORE_PEER_LOCALMSPID</span>\&quot; on \&quot;<span class="hljs-variable">$CHANNEL_NAME</span>\&quot; is updated successfully ===================== &quot;</span><br>  <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$DELAY</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-comment">## Sometimes Join takes time hence RETRY atleast for 5 times</span><br><span class="hljs-function"><span class="hljs-title">joinWithRetry</span></span> () &#123;<br>  <span class="hljs-comment"># peer channel join 实际上是消耗四个环境变量作为把 peer 加入 channel 的依据，所以外部传进来的环境变量到此几乎可说是无用的。</span><br>  <span class="hljs-comment"># CORE_PEER_MSPCONFIGPATH</span><br>  <span class="hljs-comment"># CORE_PEER_ADDRESS</span><br>  <span class="hljs-comment"># CORE_PEER_LOCALMSPID</span><br>  <span class="hljs-comment"># CORE_PEER_TLS_ROOTCERT_FILE</span><br>  peer channel <span class="hljs-built_in">join</span> -b <span class="hljs-variable">$CHANNEL_NAME</span>.block  &gt;&amp;log.txt<br>  res=$?<br>  <span class="hljs-built_in">cat</span> log.txt<br>  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$res</span> -ne 0 -a <span class="hljs-variable">$COUNTER</span> -lt <span class="hljs-variable">$MAX_RETRY</span> ]; <span class="hljs-keyword">then</span><br>    COUNTER=` <span class="hljs-built_in">expr</span> <span class="hljs-variable">$COUNTER</span> + 1`<br>    <span class="hljs-comment"># 这的 peer 是顺序 peer，和实际的容器名是不一样的。</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;PEER<span class="hljs-variable">$1</span> failed to join the channel, Retry after 2 seconds&quot;</span><br>    <span class="hljs-comment"># bash sleep 的妙用</span><br>    <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$DELAY</span><br>    <span class="hljs-comment"># 递归重试</span><br>    joinWithRetry <span class="hljs-variable">$1</span><br>  <span class="hljs-keyword">else</span><br>    COUNTER=1<br>  <span class="hljs-keyword">fi</span><br>  verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">&quot;After <span class="hljs-variable">$MAX_RETRY</span> attempts, PEER<span class="hljs-variable">$ch</span> has failed to Join the Channel&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">joinChannel</span></span> () &#123;<br>  <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> 0 1 2 3; <span class="hljs-keyword">do</span><br>    setGlobals <span class="hljs-variable">$ch</span><br>    joinWithRetry <span class="hljs-variable">$ch</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== PEER<span class="hljs-variable">$ch</span> joined on the channel \&quot;<span class="hljs-variable">$CHANNEL_NAME</span>\&quot; ===================== &quot;</span><br>    <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$DELAY</span><br>    <span class="hljs-built_in">echo</span><br>  <span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">installChaincode</span></span> () &#123;<br>  PEER=<span class="hljs-variable">$1</span><br>  setGlobals <span class="hljs-variable">$PEER</span><br>  <span class="hljs-comment"># 这里这个 p 就是在cli 容器内可以看到的 chaincode 的 go 文件路径了。n 则是链码的合约名字。</span><br>  <span class="hljs-comment"># 这个链码为什么不需要经过编译，真是奇也怪哉。</span><br>  peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt<br>  res=$?<br>  <span class="hljs-built_in">cat</span> log.txt<br>        verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">&quot;Chaincode installation on remote peer PEER<span class="hljs-variable">$PEER</span> has Failed&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== Chaincode is installed on remote peer PEER<span class="hljs-variable">$PEER</span> ===================== &quot;</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">instantiateChaincode</span></span> () &#123;<br>  PEER=<span class="hljs-variable">$1</span><br>  setGlobals <span class="hljs-variable">$PEER</span><br>  <span class="hljs-comment"># 用硬编码的方式好过用接口的方式来读写 orderer endpoint 的位置。</span><br>  <span class="hljs-comment"># while &#x27;peer chaincode&#x27; command can get the orderer endpoint from the peer (if join was successful),</span><br>  <span class="hljs-comment"># lets supply it directly as we know it using the &quot;-o&quot; option</span><br>  <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> -o <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> = <span class="hljs-string">&quot;false&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-comment"># 在链码初始化的时候，制定背书策略。</span><br>    <span class="hljs-comment"># 供反射调用</span><br>    peer chaincode instantiate -o orderer.ORDERER_DOMAIN:7050 -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -v 1.0 -c <span class="hljs-string">&#x27;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]&#125;&#x27;</span> -P <span class="hljs-string">&quot;OR (&#x27;Org1MSP.member&#x27;,&#x27;Org2MSP.member&#x27;)&quot;</span> &gt;&amp;log.txt<br>  <span class="hljs-keyword">else</span><br>    peer chaincode instantiate -o orderer.ORDERER_DOMAIN:7050 --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -v 1.0 -c <span class="hljs-string">&#x27;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]&#125;&#x27;</span> -P <span class="hljs-string">&quot;OR (&#x27;Org1MSP.member&#x27;,&#x27;Org2MSP.member&#x27;)&quot;</span> &gt;&amp;log.txt<br>  <span class="hljs-keyword">fi</span><br>  res=$?<br>  <span class="hljs-built_in">cat</span> log.txt<br>  verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">&quot;Chaincode instantiation on PEER<span class="hljs-variable">$PEER</span> on channel &#x27;<span class="hljs-variable">$CHANNEL_NAME</span>&#x27; failed&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== Chaincode Instantiation on PEER<span class="hljs-variable">$PEER</span> on channel &#x27;<span class="hljs-variable">$CHANNEL_NAME</span>&#x27; is successful ===================== &quot;</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">chaincodeQuery</span></span> () &#123;<br>  PEER=<span class="hljs-variable">$1</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== Querying on PEER<span class="hljs-variable">$PEER</span> on channel &#x27;<span class="hljs-variable">$CHANNEL_NAME</span>&#x27;... ===================== &quot;</span><br>  setGlobals <span class="hljs-variable">$PEER</span><br>  <span class="hljs-built_in">local</span> rc=1<br>  <span class="hljs-built_in">local</span> starttime=$(<span class="hljs-built_in">date</span> +%s)<br><br>  <span class="hljs-comment"># continue to poll</span><br>  <span class="hljs-comment"># we either get a successful response, or reach TIMEOUT</span><br>  <span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> <span class="hljs-string">&quot;<span class="hljs-subst">$(($(date +%s)</span>-starttime))&quot;</span> -lt <span class="hljs-string">&quot;<span class="hljs-variable">$TIMEOUT</span>&quot;</span> -a <span class="hljs-variable">$rc</span> -ne 0<br>  <span class="hljs-keyword">do</span><br>     <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$DELAY</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Attempting to Query PEER<span class="hljs-variable">$PEER</span> ...<span class="hljs-subst">$(($(date +%s)</span>-starttime)) secs&quot;</span><br>     peer chaincode query -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -c <span class="hljs-string">&#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#x27;</span> &gt;&amp;log.txt<br>     <span class="hljs-built_in">test</span> $? -eq 0 &amp;&amp; VALUE=$(<span class="hljs-built_in">cat</span> log.txt | awk <span class="hljs-string">&#x27;/Query Result/ &#123;print $NF&#125;&#x27;</span>)<br>     <span class="hljs-built_in">test</span> <span class="hljs-string">&quot;<span class="hljs-variable">$VALUE</span>&quot;</span> = <span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span> &amp;&amp; <span class="hljs-built_in">let</span> rc=0<br>  <span class="hljs-keyword">done</span><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">cat</span> log.txt<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$rc</span> -eq 0 ; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== Query on PEER<span class="hljs-variable">$PEER</span> on channel &#x27;<span class="hljs-variable">$CHANNEL_NAME</span>&#x27; is successful ===================== &quot;</span><br>  <span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;!!!!!!!!!!!!!!! Query result on PEER<span class="hljs-variable">$PEER</span> is INVALID !!!!!!!!!!!!!!!!&quot;</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot;</span><br>  <span class="hljs-built_in">echo</span><br>  <span class="hljs-built_in">exit</span> 1<br>  <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">chaincodeInvoke</span></span> () &#123;<br>  PEER=<span class="hljs-variable">$1</span><br>  setGlobals <span class="hljs-variable">$PEER</span><br>  <span class="hljs-comment"># while &#x27;peer chaincode&#x27; command can get the orderer endpoint from the peer (if join was successful),</span><br>  <span class="hljs-comment"># lets supply it directly as we know it using the &quot;-o&quot; option</span><br>  <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> -o <span class="hljs-string">&quot;<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>&quot;</span> = <span class="hljs-string">&quot;false&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-comment"># -c 是调用的消息的构造函数的参数。后台基本上是用反射什么的来执行调用的。</span><br>    peer chaincode invoke -o orderer.ORDERER_DOMAIN:7050 -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -c <span class="hljs-string">&#x27;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&#x27;</span> &gt;&amp;log.txt<br>  <span class="hljs-keyword">else</span><br>    peer chaincode invoke -o orderer.ORDERER_DOMAIN:7050  --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -c <span class="hljs-string">&#x27;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&#x27;</span> &gt;&amp;log.txt<br>  <span class="hljs-keyword">fi</span><br>  res=$?<br>  <span class="hljs-built_in">cat</span> log.txt<br>  verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">&quot;Invoke execution on PEER<span class="hljs-variable">$PEER</span> failed &quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================== Invoke transaction on PEER<span class="hljs-variable">$PEER</span> on channel &#x27;<span class="hljs-variable">$CHANNEL_NAME</span>&#x27; is successful ===================== &quot;</span><br>  <span class="hljs-built_in">echo</span><br>&#125;<br><br><span class="hljs-comment">## Create channel</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Creating channel...&quot;</span><br>createChannel<br><br><span class="hljs-comment">## Join all the peers to the channel</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Having all peers join the channel...&quot;</span><br>joinChannel<br><br><span class="hljs-comment">## Set the anchor peers for each org in the channel</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Updating anchor peers for org1...&quot;</span><br><span class="hljs-comment"># 这两个函数调用，要仔细更改当前的核心环境变量为两个组织预先生成好的 anchor 节点的 endpoint。</span><br>updateAnchorPeers 0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Updating anchor peers for org2...&quot;</span><br>updateAnchorPeers 2<br><br><span class="hljs-comment"># 只在 peer0 和 peer2上安装合约</span><br><span class="hljs-comment">## Install chaincode on Peer0/Org1 and Peer2/Org2</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Installing chaincode on org1/peer0...&quot;</span><br>installChaincode 0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Install chaincode on org2/peer2...&quot;</span><br>installChaincode 2<br><br><span class="hljs-comment"># 只在 peer2上初始化合约</span><br><span class="hljs-comment">#Instantiate chaincode on Peer2/Org2</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Instantiating chaincode on org2/peer2...&quot;</span><br>instantiateChaincode 2<br><br><span class="hljs-comment"># 只在 peer0 上查询合约</span><br><span class="hljs-comment">#Query on chaincode on Peer0/Org1</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Querying chaincode on org1/peer0...&quot;</span><br>chaincodeQuery 0 100<br><br><span class="hljs-comment"># 只在 peer0 上调用合约</span><br><span class="hljs-comment">#Invoke on chaincode on Peer0/Org1</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Sending invoke transaction on org1/peer0...&quot;</span><br>chaincodeInvoke 0<br><br><span class="hljs-comment"># 在 peer3 上追加安装合约 </span><br><span class="hljs-comment">## Install chaincode on Peer3/Org2</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Installing chaincode on org2/peer3...&quot;</span><br>installChaincode 3<br><br><span class="hljs-comment"># 在 peer3 上追加查询合约。可见追加进来的合约调用结果可以被明确查询到。</span><br><span class="hljs-comment">#Query on chaincode on Peer3/Org2, check if the result is 90</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Querying chaincode on org2/peer3...&quot;</span><br>chaincodeQuery 3 90<br><br><span class="hljs-built_in">echo</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;========= All GOOD, BYFN execution completed =========== &quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-built_in">echo</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; _____   _   _   ____   &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;| ____| | \ | | |  _ \  &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;|  _|   |  \| | | | | | &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;| |___  | |\  | | |_| | &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;|_____| |_| \_| |____/  &quot;</span><br><span class="hljs-built_in">echo</span><br><br><span class="hljs-built_in">exit</span> 0<br></code></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://magicliang.github.io">magicliang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://magicliang.github.io/2018/03/15/Hyperledger-Fabric-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB/">https://magicliang.github.io/2018/03/15/Hyperledger-Fabric-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a><a class="post-meta__tags" href="/tags/Hyperledger-Fabric/">Hyperledger Fabric</a></div><div class="post-share"><div class="social-share" data-image="/img/wall-paper-157.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2018/03/15/Hyperledger-Fabric-MSP-%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/" title="Hyperledger Fabric MSP 相关问题"><img class="cover" src="/img/wall-paper-74.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-15</div><div class="info-item-2">Hyperledger Fabric MSP 相关问题</div></div><div class="info-2"><div class="info-item-1">Fabric要求所有的 paticipant 有相关的 identity。identity是由x509证书认证的（大致上也就是各种signcert），每个 identity 有自己的 principal，包含了大量的 property，包括但不仅限于组织名。 PKI 生成 identity，而 MSP 表达治理组织的规则，包括哪些 identity 属于哪些组织，且参与网络中。 PKI PKI 是一种标准，一般由四个元素组成：  Digital Certificates Public and Private Keys Certificate Authorities Certificate Revocation Lists  数字证书 一个持有一个组织的系列属性的数字文件。常见的数字证书是X509标准的，很像一个国家发放的身份证（有名称，省份，国家，还有组织的名字）。  For example, John Doe of Accounting division in FOO Corporation in Detroit, Michigan might have a digital c...</div></div></div></a><a class="pagination-related" href="/2018/04/09/Fabric-%E4%B8%AD%E7%9A%84-peer/" title="Fabric 中的 peer"><img class="cover" src="/img/wall-paper-30.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-09</div><div class="info-item-2">Fabric 中的 peer</div></div><div class="info-2"><div class="info-item-1">每个 peer 可以拥有若干个 chaincode，也可以拥有若干个 ledger，但并不是一开始就拥有的，而是逐渐被创建出来的。chaincode 一定会定义一个 asset，也就生成了 ledger。一个peer 可以拥有 ledger 而无 chaincode，可见也并不是必然由 chaincode 生成 ledger。比如同一个组织里面多个 peer，只有一个安装了 chaincode（只有这个 peer 可以当作 endorser），其它的peer一样可以拿到 ledger。 peer 的流程架构图大致上是：  为了预防有 peer 的数据不一致，有可能需要 client application 向多个 peer 进行查询。 channel 可以认为是一系列 peers 的逻辑组合，orderer 可以被认为是跨channel的。同一个 channel 的 peers 共享完全一样的账本。  不同的组织完全可以基于同样的账本copy，产生不同的 application。 Fabric 有 identity，identity 有 principal。 transactio...</div></div></div></a><a class="pagination-related" href="/2018/04/10/Fabric-%E6%96%87%E6%A1%A3%E6%8B%BE%E9%81%97/" title="Fabric 文档拾遗"><img class="cover" src="/img/wall-paper-12.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-10</div><div class="info-item-2">Fabric 文档拾遗</div></div><div class="info-2"><div class="info-item-1">基本名词解释 ledger 账本上一系列由事务驱动的状态迁移的记录。状态迁移是链码调用（调用即事务）的结果。这些记录是不可修改顺序的，因此也上抗篡改的。 每个channel有一个账本，但恐怕不只一个账本。 理论上账本是由产生它的链码的命名空间隔离开来的，不能直接被其他链码访问到。 chain 由包含一系列 transaction 的 block 通过hash-link（由散列值作为前驱指针的一种连接方式）组成的数据结构。 state database 记录各种 key 的 latest value。可以被认为上chain的indexed view，可以随时被从链上重建出来。 所以 Fabric 自己就有双层数据结构。 读写集语义 读集和写集搞不好是同一个事务里的数据结构（待查）。 12345678910111213&lt;TxReadWriteSet&gt;  &lt;NsReadWriteSet name=&quot;chaincode1&quot;&gt;    &lt;read-set&gt;      &lt;read key=&quot;K1&quot;, versio...</div></div></div></a><a class="pagination-related" href="/2018/04/09/Hyperledger-Fabric-%E5%90%84%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%86%85%E7%8E%AF%E5%A2%83/" title="Hyperledger Fabric 各个容器内环境"><img class="cover" src="/img/wall-paper-125.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-09</div><div class="info-item-2">Hyperledger Fabric 各个容器内环境</div></div><div class="info-2"><div class="info-item-1">peer 容器 /opt/gopath/src/github.com/hyperledger/fabric/peer 虽然是WORKING_DIR，什么都没有。这个目录是/bin/bash永远的进入路径，不管在哪个目录退出，重新进入还是会进入这个路径。 /etc/hyperledger/fabric 12345678910# 原生的三个配置文件。所以修改peer的行为要通过环境变量来修改，让docker用COMMAND启动peer进程的时候吸收这几个配置文件和环境变量core.yaml# 这两个文件似乎不关peer的事情configtx.yamlorderer.yaml# 这两个文件夹要被外部的数据卷映射修改过来，实际上只能依赖于外部# 这个文件夹本质上还是 core.yaml 默认的 mspConfigPath 的值msptls /var/hyperledger/production 这个文件夹存放unix系统里面的动态程序数据。 123456# 它下面有打包好的CIP（chaincode install package）格式的链码 chaincodes/mycc.1.0。ch...</div></div></div></a><a class="pagination-related" href="/2017/10/27/Hyperledger-Fabric-%E7%BD%91%E7%BB%9C%E7%9A%84%E5%90%AF%E5%8A%A8%E6%AD%A5%E9%AA%A4/" title="Hyperledger Fabric 网络的启动步骤"><img class="cover" src="/img/wall-paper-20.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2017-10-27</div><div class="info-item-2">Hyperledger Fabric 网络的启动步骤</div></div><div class="info-2"><div class="info-item-1">  本文是截至日前（2017.10.27）时对官方教程和自我实验的重新梳理。   Hyperledger Fabric 可以说是 Hyperledger 的拳头项目。虽然同为  Apache 的顶级项目，但大部分其他项目都以 Fabric 为基础。它是顶级项目中的顶级项目，可以认为是0级项目。   docker 要有高于 17.06.2-ce 的版本。docker-compose 要有 1.14.0 及以上的版本。当然当前的高版本的 docker 已经自带了高版本的 docker-compose，这通常不用担心。   安装1.9+ 的 Golang。应该预期这样的结果：    echo $GOPATH   /Users/xxx/go   如果这个结果出不来，考虑当前 Shell 的环境变量没有正确设置：   export GOPATH=$HOME/go   export PATH=$PATH:$GOPATH/bin   要用一个很特别的 nodejs 版本。6.9以上，却不能用8.x。npm 也有特别的版本要求：   npm install npm@3.10.10 -g   要用...</div></div></div></a><a class="pagination-related" href="/2017/10/31/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9B%B8%E5%85%B3%E7%A0%94%E7%A9%B6%E8%B5%84%E6%96%99/" title="以太坊相关研究资料"><img class="cover" src="/img/wall-paper-4.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2017-10-31</div><div class="info-item-2">以太坊相关研究资料</div></div><div class="info-2"><div class="info-item-1"> 《以太坊的 gas 费率一览表》 《以太坊学习笔记：私有链搭建操作指南》 《以太坊中的账户、交易、Gas和区块Gas Limit》 StackOverflow 上的问答：以太坊主链到底需要多大空间？ StackOverflow 上的问答：怎样提供无限次数的智能合约操作？ 《区块链技术-智能合约-以太坊 （译文）》 《以太坊官方文档》 《以太坊私有链搭建指南》 《以太坊关于搭建私有网络的 wiki》 《预充值以太坊资金的方法》。注意看 carchrae 的回复，这里面也提供了拷贝私钥复用私钥的方法，可以考虑在多节点的情况下使用。 《一本与参数有关的介绍怎样搭建私链的 gitbook》。 StackOverflow 上的问答：以太坊的网络难度是否可以静态锁死？注意看它还有个相关的子问题。如果网络算力的稳定的话，应该不会出现难度增长才对。 值得大读特读的 geth 的文档。特别是挖矿、账户管理的部分。 geth 的命令行选项。注意，有些选项在当前版本中已经消失了，如（gpomin、gpomax）。 StackOverflow 上的问答：如何降低测试网络中的难度。感觉没多大用。 搜索以...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#crypto-generator"><span class="toc-number">1.</span> <span class="toc-text">Crypto Generator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configtxgen-%E7%9B%B8%E5%85%B3"><span class="toc-number">2.</span> <span class="toc-text">configtxgen 相关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-compose-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">docker-compose 的配置文件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%89%8D%E7%BC%80"><span class="toc-number">3.1.</span> <span class="toc-text">常见环境变量前缀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#peer-base-yaml"><span class="toc-number">3.2.</span> <span class="toc-text">peer-base.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose-base-yaml"><span class="toc-number">3.3.</span> <span class="toc-text">docker-compose-base.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose-cli-yaml"><span class="toc-number">3.4.</span> <span class="toc-text">docker-compose-cli.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose-e2e-template-yaml"><span class="toc-number">3.5.</span> <span class="toc-text">docker-compose-e2e-template.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#byfn-sh"><span class="toc-number">3.6.</span> <span class="toc-text">byfn.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#script-script-sh"><span class="toc-number">3.7.</span> <span class="toc-text">script&#x2F;script.sh</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2017 - 2026 By magicliang</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">簡</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/js/tw_cn.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="/"></script></div></body></html>