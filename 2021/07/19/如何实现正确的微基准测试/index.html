<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>如何实现正确的微基准测试 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="如何实现正确的微基准测试 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="原问题FROM：《How do I write a correct micro-benchmark in Java?》 Tips about writing micro benchmarks from the creators of Java HotSpot: Rule 0: Read a reputable paper on JVMs and micro-benchmarking. A good - magicliang - 守株阁"><meta name="keywords" content="JVM, Java"><meta property="article:published_time" content="2021-07-19T07:20:11.000Z"><meta property="article:modified_time" content="2021-12-23T05:19:21.000Z"><meta property="og:updated_time" content="2021-12-23T05:19:21.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="JVM, Java"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/"
    },
    "headline": "如何实现正确的微基准测试 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2021-07-19T07:20:11.000Z",
    "dateModified": "2021-12-23T05:19:21.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "JVM, Java",
    "description": "原问题FROM：《How do I write a correct micro-benchmark in Java?》 Tips about writing micro benchmarks from the creators of Java HotSpot: Rule 0: Read a reputable paper on JVMs and micro-benchmarking. A good - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=如何实现正确的微基准测试" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=如何实现正确的微基准测试&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=如何实现正确的微基准测试" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANQAAADUCAAAAADBtVLEAAADq0lEQVR42u3awW7jMAxF0f7/T8+sZlPYfPc5E5sJbjYtWsf2ESCJIvnz5ws/P6JEiRIl6utQP8Pn3/+Prpu++/vev38/uu/RNdPzD58nStQS1OGkO3m5NBjpZY7uPQ3C0XdO31OUqEWo9OArC0Ca4GffPXtOfE9Roj4A1fwk8GmDPRsYUaK+ETVtfG2w24BFifpUVLpJCninSX62kaZNelpMXorSRYl6M4omXp7++ZZskihR/xkVk+5DkrKZ2G2yMy0QL1U9RIl6I+pKQn4KPOnikwYLLw4kohAl6kYULYg1SUYSpE6HUFJ8i6ufKFEPoeimNz18KiokbJu8HOGiRC1CkcaQlGRpig1Ng8mlZKYoUQtQU1BKEpe0uYMWC+qEpyhRC1B0E04Fa9Lk0R4eyQFSlKiNKPpAAkmNWHRDJUkadPIVJepmVEqGtAW4qwEyubY6JIoS9RCKJPdJ4wgtgJOAmS5YuJIoStSNKNIQQg+FqVCQmq/aAgFOZooSdTMqJfdT4yJp6iWDlgY6Fg1EiVqCmi5uN1OSlEzNKE0iSJSojSja9JGaScjBsin0tY1fokRtQJEgMi0aJFCdBoUW49LiI0rUBhRt1Lj6N/qdtnh9KaIQJeoGVAoUU5KFHhinJGTa+OuAVpSoB1G0wJYKCM1G3TRc0fuIErUFRSZmE4ympsiUmLmyCIkStQlFGw4JsGlUbDZkvDiJErUAdaVw3TR1NIVwmjg9XaxEiVqGag+LtPmQFKXT5l8nXkSJehjVTlK6sabEfmpKoQVuUaK2oJrglTR4pEaqJvFCDq2iRG1GXdmMSUFgGqBUFEgbsihR21DNBKZJT5KUvJK8jA2XokQtQNFmJjrB6UDQQgNt1hIlaiOKFsCaBsTpIEgXqqkJS5SojSjaCEWSMWky04aqGLzShitRoh5A0YMZaVRMh82rAS0q0IkStQCVGgbRBC2aGZuDKdm4cXVelKgHUCQ4JTBSSGgA9LAoStQmVNsUPG2EzWLSFNrwIVGUqAdRzSEsJR6nZsfUZDIFArQ5WJSoDSj64mQAUmDbXEcWr3H1EyXqIRSdiE0QSg+eU2NWel5V9RAl6mbUlMSfEiikeEYK16n4RxI5okRtQzUTsym8paIcaahKm7EoUZ+EIokSUpRLm/aV9xkriaJELUbRQ1q7iabBGQtsqTovStTDqBTQNs1XbVA7Tv7QQPxSlC5K1JtQOAEPg1ZaqKMHTQoWJWoD6ps+okSJEiXqaz5/ATLLFiIvCxHNAAAAAElFTkSuQmCC" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">如何实现正确的微基准测试</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2021-07-19</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=如何实现正确的微基准测试&url=http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=如何实现正确的微基准测试&url=http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2021/07/19/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%BE%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANQAAADUCAAAAADBtVLEAAADq0lEQVR42u3awW7jMAxF0f7/T8+sZlPYfPc5E5sJbjYtWsf2ESCJIvnz5ws/P6JEiRIl6utQP8Pn3/+Prpu++/vev38/uu/RNdPzD58nStQS1OGkO3m5NBjpZY7uPQ3C0XdO31OUqEWo9OArC0Ca4GffPXtOfE9Roj4A1fwk8GmDPRsYUaK+ETVtfG2w24BFifpUVLpJCninSX62kaZNelpMXorSRYl6M4omXp7++ZZskihR/xkVk+5DkrKZ2G2yMy0QL1U9RIl6I+pKQn4KPOnikwYLLw4kohAl6kYULYg1SUYSpE6HUFJ8i6ufKFEPoeimNz18KiokbJu8HOGiRC1CkcaQlGRpig1Ng8mlZKYoUQtQU1BKEpe0uYMWC+qEpyhRC1B0E04Fa9Lk0R4eyQFSlKiNKPpAAkmNWHRDJUkadPIVJepmVEqGtAW4qwEyubY6JIoS9RCKJPdJ4wgtgJOAmS5YuJIoStSNKNIQQg+FqVCQmq/aAgFOZooSdTMqJfdT4yJp6iWDlgY6Fg1EiVqCmi5uN1OSlEzNKE0iSJSojSja9JGaScjBsin0tY1fokRtQJEgMi0aJFCdBoUW49LiI0rUBhRt1Lj6N/qdtnh9KaIQJeoGVAoUU5KFHhinJGTa+OuAVpSoB1G0wJYKCM1G3TRc0fuIErUFRSZmE4ympsiUmLmyCIkStQlFGw4JsGlUbDZkvDiJErUAdaVw3TR1NIVwmjg9XaxEiVqGag+LtPmQFKXT5l8nXkSJehjVTlK6sabEfmpKoQVuUaK2oJrglTR4pEaqJvFCDq2iRG1GXdmMSUFgGqBUFEgbsihR21DNBKZJT5KUvJK8jA2XokQtQNFmJjrB6UDQQgNt1hIlaiOKFsCaBsTpIEgXqqkJS5SojSjaCEWSMWky04aqGLzShitRoh5A0YMZaVRMh82rAS0q0IkStQCVGgbRBC2aGZuDKdm4cXVelKgHUCQ4JTBSSGgA9LAoStQmVNsUPG2EzWLSFNrwIVGUqAdRzSEsJR6nZsfUZDIFArQ5WJSoDSj64mQAUmDbXEcWr3H1EyXqIRSdiE0QSg+eU2NWel5V9RAl6mbUlMSfEiikeEYK16n4RxI5okRtQzUTsym8paIcaahKm7EoUZ+EIokSUpRLm/aV9xkriaJELUbRQ1q7iabBGQtsqTovStTDqBTQNs1XbVA7Tv7QQPxSlC5K1JtQOAEPg1ZaqKMHTQoWJWoD6ps+okSJEiXqaz5/ATLLFiIvCxHNAAAAAElFTkSuQmCC" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%8E%9F%E9%97%AE%E9%A2%98"><span class="post-toc-number">1.</span> <span class="post-toc-text">原问题</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%A0%B7%E4%BE%8B%E5%B7%A5%E7%A8%8B"><span class="post-toc-number">2.</span> <span class="post-toc-text">样例工程</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#JMH-%E6%95%99%E7%A8%8B"><span class="post-toc-number">3.</span> <span class="post-toc-text">JMH 教程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">基本概念</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#API"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">API</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#BenchmarkMode"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">@BenchmarkMode</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Warmup"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">@Warmup</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Measurement"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">@Measurement</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Threads"><span class="post-toc-number">3.2.4.</span> <span class="post-toc-text">@Threads</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Fork"><span class="post-toc-number">3.2.5.</span> <span class="post-toc-text">@Fork</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#OutputTimeUnit"><span class="post-toc-number">3.2.6.</span> <span class="post-toc-text">@OutputTimeUnit</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Benchmark"><span class="post-toc-number">3.2.7.</span> <span class="post-toc-text">@Benchmark</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Param"><span class="post-toc-number">3.2.8.</span> <span class="post-toc-text">@Param</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Setup"><span class="post-toc-number">3.2.9.</span> <span class="post-toc-text">@Setup</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TearDown"><span class="post-toc-number">3.2.10.</span> <span class="post-toc-text">@TearDown</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#State"><span class="post-toc-number">3.2.11.</span> <span class="post-toc-text">@State</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%A7%A3%E8%AF%BB%E8%BE%93%E5%87%BA%E6%8A%A5%E5%91%8A"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">解读输出报告</span></a></li></ol></li></ol></div>
                        
                    
                    <article id="post-content">
                        <h1 id="原问题"><a href="#原问题" class="headerlink" title="原问题"></a>原问题</h1><p>FROM：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/504103/how-do-i-write-a-correct-micro-benchmark-in-java">《How do I write a correct micro-benchmark in Java?》</a></p>
<p>Tips about writing micro benchmarks <a target="_blank" rel="noopener" href="https://wiki.openjdk.java.net/display/HotSpot/Main">from the creators of Java HotSpot</a>:</p>
<p>Rule 0: Read a reputable paper on JVMs and micro-benchmarking. A good one is <a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/java/library/j-jtp02225">Brian Goetz, 2005</a>. Do not expect too much from micro-benchmarks; they measure only a limited range of JVM performance characteristics.</p>
<p>Rule 1: Always include a warmup phase which runs your test kernel all the way through, enough to trigger all initializations and compilations before timing phase(s). (Fewer iterations is OK on the warmup phase. The rule of thumb is several tens of thousands of inner loop iterations.)</p>
<p>Rule 2: Always run with -XX:+PrintCompilation, -verbose:gc, etc., so you can verify that the compiler and other parts of the JVM are not doing unexpected work during your timing phase.</p>
<p>Rule 2.1: Print messages at the beginning and end of timing and warmup phases, so you can verify that there is no output from Rule 2 during the timing phase.</p>
<p>Rule 3: Be aware of the difference between -client and -server, and OSR and regular compilations. The -XX:+PrintCompilation flag reports OSR compilations with an at-sign to denote the non-initial entry point, for example: Trouble$1::run @ 2 (41 bytes). Prefer server to client, and regular to OSR, if you are after best performance.</p>
<p>Rule 4: Be aware of initialization effects. Do not print for the first time during your timing phase, since printing loads and initializes classes. Do not load new classes outside of the warmup phase (or final reporting phase), unless you are testing class loading specifically (and in that case load only the test classes). Rule 2 is your first line of defense against such effects.</p>
<p>Rule 5: Be aware of deoptimization and recompilation effects. Do not take any code path for the first time in the timing phase, because the compiler may junk and recompile the code, based on an earlier optimistic assumption that the path was not going to be used at all. Rule 2 is your first line of defense against such effects.</p>
<p>Rule 6: Use appropriate tools to read the compiler’s mind, and expect to be surprised by the code it produces. Inspect the code yourself before forming theories about what makes something faster or slower.</p>
<p>Rule 7: Reduce noise in your measurements. Run your benchmark on a quiet machine, and run it several times, discarding outliers. Use -Xbatch to serialize the compiler with the application, and consider setting -XX:CICompilerCount=1 to prevent the compiler from running in parallel with itself. Try your best to reduce GC overhead, set Xmx(large enough) equals Xms and use UseEpsilonGC if it is available.</p>
<p>Rule 8: Use a library for your benchmark as it is probably more efficient and was already debugged for this sole purpose. Such as JMH, <a target="_blank" rel="noopener" href="https://github.com/google/caliper">Caliper</a> or <a target="_blank" rel="noopener" href="http://cseweb.ucsd.edu/~wgg/JavaProf/javaprof.html">Bill and Paul’s Excellent UCSD Benchmarks for Java</a>.</p>
<p>规则 0：阅读有关 JVM 和微基准测试的知名论文。 <a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/java/library/j-jtp02225">Brian Goetz, 2005</a> 是一个很好的例子。不要对微基准期望过高；它们仅测量有限范围的 JVM 性能特征。</p>
<p>规则 1：始终包含一个预热阶段，它会一直运行您的测试内核，足以在计时阶段之前触发所有初始化和编译。 （预热阶段的迭代次数较少。经验法则是数万次内循环迭代。）<strong>几万次足以预热大部分东西</strong>。</p>
<p>规则 2：始终使用 -XX:+PrintCompilation、-verbose:gc 等运行，这样您就可以验证编译器和 JVM 的其他部分在您的计时阶段没有做预期之外的工作。<strong>如果做了它会打印出来</strong>。</p>
<p>规则 2.1：在计时和预热阶段的开始和结束时打印消息，以便您可以验证在计时阶段没有规则 2 的输出。<strong>如何做到呢，依靠 JMH 吧</strong>。</p>
<p>规则 3：注意<code>-client</code>和<code>-server</code>之间的区别，以及 OSR 和常规编译之间的区别。 <code>-XX:+PrintCompilation</code>标志用 at 符号报告 OSR 编译，以表示非初始入口点，例如：<code>Trouble$1::run@2（41 bytes）</code>。如果您追求最佳性能，则更喜欢服务器而不是客户端，并且更喜欢 OSR。<strong>我真的看得懂 OSR 的日志吗</strong>？</p>
<p>规则 4：注意初始化效果。不要在计时阶段第一次打印，因为打印会加载和初始化类。不要在预热阶段（或最终报告阶段）之外加载新类，除非您专门测试类加载（在这种情况下只加载测试类）。规则 2 是您抵御此类影响的第一道防线。<strong>类加载是一种容易被忽略的性能瓶颈，打印是另一种</strong>。</p>
<p>规则 5：注意反优化和重新编译的影响。不要在计时阶段才第一次使用任何代码路径，因为编译器可能会根据早先的乐观假设，即根本不会使用该路径，而重新编译代码。规则 2 是您抵御此类影响的第一道防线。</p>
<p>规则 6：使用适当的工具来读懂编译器的想法，并期望对它生成的代码感到惊讶。在形成关于什么使某事更快或更慢的理论之前，自己检查代码。<strong>不要以为自己懂编译器</strong>。</p>
<p>规则 7：减少测量中的噪声。在安静的机器上运行您的基准测试，并运行几次，丢弃异常值。使用 -Xbatch 将编译器与应用程序序列化，并考虑设置 -XX:CICompilerCount=1 以防止编译器与自身并行运行。尽量减少 GC 开销，设置 Xmx（足够大）等于 Xms 并在可用时使用 UseEpsilonGC。<strong>可以使用无操作垃圾收集器</strong>。</p>
<p>规则 8：为您的基准测试使用一个库，因为它可能更有效，并且已经为此目的进行了调试。例如 JMH、<a target="_blank" rel="noopener" href="https://github.com/google/caliper">Caliper</a> 或 <a target="_blank" rel="noopener" href="http://cseweb.ucsd.edu/~wgg/JavaProf/javaprof.html">Bill and Paul’s Better UCSD Benchmarks for Java</a>。</p>
<p>Also, never use System.currentTimeMillis() unless you are OK with + or - 15 ms accuracy, which is typical on most OS + JVM combinations. </p>
<p>不要使用 System.nanoTime() 和 System.currentTimeMillis() 这两个 api。但 System.nanoTime() 始终是单调钟，虽然不精确，总是向前的。</p>
<h1 id="样例工程"><a href="#样例工程" class="headerlink" title="样例工程"></a>样例工程</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-generator-annprocess --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-generator-annprocess<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参考 https://github.com/openjdk/jmh/blob/master/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_03_States.java</span></span><br><span class="line"><span class="meta">@State(Scope.Benchmark)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonUtilBenchMark</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@State(Scope.Thread)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyState</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在每一个 Invocation 级别做一次 setup。参数随机化要这一步做</span></span><br><span class="line">        <span class="meta">@Setup(Level.Invocation)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSetup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> boundedRandomValue = ThreadLocalRandom.current().nextInt(-<span class="number">10000000</span>, <span class="number">10000000</span>);</span><br><span class="line">                map.put(boundedRandomValue + <span class="string">&quot;&quot;</span>, boundedRandomValue + <span class="number">1</span> + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mapStr = JsonUtils.toJson(map);</span><br><span class="line">            System.out.println(<span class="string">&quot;Do Setup&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@TearDown(Level.Invocation)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doTearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Do TearDown&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String mapStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="meta">@BenchmarkMode(Mode.All)</span> <span class="comment">// 吞吐量、耗时、采样、冷启动这些模式都跑一遍</span></span><br><span class="line">    <span class="meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureToObj</span><span class="params">(MyState state)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(JsonUtils.toObj(state.mapStr, Map.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="meta">@BenchmarkMode(Mode.All)</span></span><br><span class="line">    <span class="meta">@OutputTimeUnit(TimeUnit.NANOSECONDS)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureToObj2</span><span class="params">(MyState state)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(JsonUtils.toObj2(state.mapStr, Map.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RunnerException </span>&#123;</span><br><span class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder()</span><br><span class="line">                .include(JsonUtilBenchMark.class.getSimpleName())</span><br><span class="line">                .threads(<span class="number">80</span>)</span><br><span class="line">                <span class="comment">// 4 * 500 秒 = 33.3333333333 分(分钟)</span></span><br><span class="line">                .warmupIterations(<span class="number">500</span>)</span><br><span class="line">                <span class="comment">// 每个循环每个模式跑 1s，如果开 all mode，实际上要跑 4 * 50000 秒等于55.5555555556 时(小时)</span></span><br><span class="line">                .measurementIterations(<span class="number">50000</span>)</span><br><span class="line">                <span class="comment">// https://stackoverflow.com/questions/35046745/what-is-the-purpose-of-jmh-fork</span></span><br><span class="line">                <span class="comment">// fork 是为了实现 JVM 级的隔离</span></span><br><span class="line">                .measurementIterations(<span class="number">50000</span>)</span><br><span class="line">                .forks(<span class="number">20</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">new</span> Runner(opt).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="JMH-教程"><a href="#JMH-教程" class="headerlink" title="JMH 教程"></a>JMH 教程</h1><p>参考<a target="_blank" rel="noopener" href="https://hezhiqiang8909.gitbook.io/java/docs/javalib/jmh">《JMH 应用指南》</a>。</p>
<p><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/9d8c81113a978540cc5793139">《基准测试神器 JMH —— 详解 36 个官方例子》</a></p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul>
<li>Iteration - iteration 是 JMH 进行测试的最小单位，包含一组 invocations。</li>
<li>Invocation - 一次 benchmark 方法调用。</li>
<li>Operation - benchmark 方法中，被测量操作的执行。如果被测试的操作在 benchmark 方法中循环执行，可以使用@OperationsPerInvocation表明循环次数，使测试结果为单次 operation 的性能。</li>
<li>Warmup - 在实际进行 benchmark 前先进行预热。因为某个函数被调用多次之后，JIT 会对其进行编译，通过预热可以使测量结果更加接近真实情况。</li>
</ul>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="BenchmarkMode"><a href="#BenchmarkMode" class="headerlink" title="@BenchmarkMode"></a>@BenchmarkMode</h3><ul>
<li>Throughput - 整体吞吐量，例如“1 秒内可以执行多少次调用”。</li>
<li>AverageTime - 调用的平均时间，例如“每次调用平均耗时 xxx 毫秒”。</li>
<li>SampleTime - 随机取样，最后输出取样结果的分布，例如“99%的调用在 xxx 毫秒以内，99.99%的调用在 xxx 毫秒以内”</li>
<li>SingleShotTime - <strong>以上模式都是默认一次 iteration 是 1s</strong>，唯有 SingleShotTime 是只运行一次。往往同时把 warmup 次数设为 0，<strong>用于测试冷启动时的性能</strong>。</li>
<li>All - 所有模式</li>
</ul>
<h3 id="Warmup"><a href="#Warmup" class="headerlink" title="@Warmup"></a>@Warmup</h3><p>上面我们提到了，进行基准测试前需要进行预热。一般我们前几次进行程序测试的时候都会比较慢， 所以要让程序进行几轮预热，保证测试的准确性。其中的参数 iterations 也就非常好理解了，就是预热轮数。<br>为什么需要预热？因为 JVM 的 JIT 机制的存在，如果某个函数被调用多次之后，JVM 会尝试将其编译成为机器码从而提高执行速度。所以为了让 benchmark 的结果更加接近真实情况就需要进行预热。</p>
<h3 id="Measurement"><a href="#Measurement" class="headerlink" title="@Measurement"></a>@Measurement</h3><ul>
<li>iterations - 进行测试的轮次</li>
<li>time - 每轮进行的时长</li>
<li>timeUnit - 时长单位</li>
</ul>
<h3 id="Threads"><a href="#Threads" class="headerlink" title="@Threads"></a>@Threads</h3><p>每个进程中的测试线程，这个非常好理解，根据具体情况选择，一般为 cpu 乘以 2。</p>
<h3 id="Fork"><a href="#Fork" class="headerlink" title="@Fork"></a>@Fork</h3><p>进行 fork 的次数。如果 fork 数是 2 的话，则 JMH 会 fork 出两个进程来进行测试。</p>
<h3 id="OutputTimeUnit"><a href="#OutputTimeUnit" class="headerlink" title="@OutputTimeUnit"></a>@OutputTimeUnit</h3><p>这个比较简单了，基准测试结果的时间类型。一般选择秒、毫秒、微秒。</p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="@Benchmark"></a>@Benchmark</h3><p>方法级注解，表示该方法是需要进行 benchmark 的对象，用法和 JUnit 的 @Test 类似。</p>
<h3 id="Param"><a href="#Param" class="headerlink" title="@Param"></a>@Param</h3><p>属性级注解，@Param 可以用来指定某项参数的多种情况。特别适合用来测试一个函数在不同的参数输入的情况下的性能。</p>
<h3 id="Setup"><a href="#Setup" class="headerlink" title="@Setup"></a>@Setup</h3><p>方法级注解，这个注解的作用就是我们需要在测试之前进行一些准备工作，比如对一些数据的初始化之类的。我们可以在每一次 Invocation 以前做一次 Setup。</p>
<h3 id="TearDown"><a href="#TearDown" class="headerlink" title="@TearDown"></a>@TearDown</h3><p>方法级注解，这个注解的作用就是我们需要在测试之后进行一些结束工作，比如关闭线程池，数据库连接等的，主要用于资源的回收等。这个东西需要很慎重。</p>
<h3 id="State"><a href="#State" class="headerlink" title="@State"></a>@State</h3><p>当使用 @Setup 参数的时候，必须在类上加这个参数，不然会提示无法运行。<br>State 用于声明某个类是一个“状态”，然后接受一个 Scope 参数用来表示该状态的共享范围。 因为很多 benchmark 会需要一些表示状态的类，JMH 允许你把这些类以依赖注入的方式注入到 benchmark 函数里。Scope 主要分为三种。</p>
<ul>
<li>Thread - 该状态为每个线程独享。</li>
<li>Group - 该状态为同一个组里面所有线程共享。</li>
<li>Benchmark - 该状态在所有线程间共享。</li>
</ul>
<h2 id="解读输出报告"><a href="#解读输出报告" class="headerlink" title="解读输出报告"></a>解读输出报告</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">255195.938 ±(99.9%) 48484.059 ns/op</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Result <span class="string">&quot;类名.方法名&quot;</span>:</span><br><span class="line">  N = 20</span><br><span class="line">  mean = 324719.516 ±(99.9%) 302945.897 ns/op</span><br><span class="line"></span><br><span class="line">  Histogram, ns/op:</span><br><span class="line">    [      0.000,  125000.000) = 0 </span><br><span class="line">    <span class="comment"># 有 14 个 iteration 在 125 微秒中执行完成</span></span><br><span class="line">    [ 125000.000,  250000.000) = 14 </span><br><span class="line">    [ 250000.000,  375000.000) = 5 </span><br><span class="line">    [ 375000.000,  500000.000) = 0 </span><br><span class="line">    [ 500000.000,  625000.000) = 0 </span><br><span class="line">    [ 625000.000,  750000.000) = 0 </span><br><span class="line">    [ 750000.000,  875000.000) = 0 </span><br><span class="line">    [ 875000.000, 1000000.000) = 0 </span><br><span class="line">    [1000000.000, 1125000.000) = 0 </span><br><span class="line">    [1125000.000, 1250000.000) = 0 </span><br><span class="line">    [1250000.000, 1375000.000) = 0 </span><br><span class="line">    [1375000.000, 1500000.000) = 0 </span><br><span class="line">    [1500000.000, 1625000.000) = 0 </span><br><span class="line">    [1625000.000, 1750000.000) = 0 </span><br><span class="line">    <span class="comment"># 有一个 iteration 在1.75 毫秒内执行完成</span></span><br><span class="line">    [1750000.000, 1875000.000) = 1 </span><br><span class="line"></span><br><span class="line"> <span class="comment"># 有若干个点在这些 p(50.0000)分位被执行出来。</span></span><br><span class="line">  Percentiles, ns/op:</span><br><span class="line">      p(0.0000) = 224220.638 ns/op</span><br><span class="line">     p(50.0000) = 237448.319 ns/op</span><br><span class="line">     p(90.0000) = 331986.035 ns/op</span><br><span class="line">     p(95.0000) = 1728070.972 ns/op</span><br><span class="line">     p(99.0000) = 1801399.338 ns/op</span><br><span class="line">     p(99.9000) = 1801399.338 ns/op</span><br><span class="line">     p(99.9900) = 1801399.338 ns/op</span><br><span class="line">     p(99.9990) = 1801399.338 ns/op</span><br><span class="line">     p(99.9999) = 1801399.338 ns/op</span><br><span class="line">    p(100.0000) = 1801399.338 ns/op</span><br><span class="line"></span><br><span class="line"><span class="comment"># 总共花了 4 分 46 秒执行基准测试</span></span><br><span class="line"><span class="comment"># Run complete. Total time: 00:04:46</span></span><br><span class="line"></span><br><span class="line">Benchmark                                                                        Mode      Cnt       Score     Error   Units</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson                                         thrpt       20       0.057 ±   0.008  ops/us</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat                                thrpt       20       0.057 ±   0.009  ops/us</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin                                       thrpt       20       0.066 ±   0.007  ops/us</span><br><span class="line"><span class="comment"># 注意，在 avg time 模式下，我们会发现 avg 都很高，主要是因为 tp 的长尾线拉高了 avg</span></span><br><span class="line">RiskOutServiceImplBenchMark.measureJson                                          avgt       20    1420.907 ± 176.300   us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat                                 avgt       20    1191.810 ± 142.301   us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin                                        avgt       20    1170.264 ± 119.390   us/op</span><br><span class="line"><span class="comment"># 在采样模式下看分位线</span></span><br><span class="line">RiskOutServiceImplBenchMark.measureJson                                        sample  1420574    1175.533 ±  17.038   us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p0.00                      sample               38.976             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p0.50                      sample               78.720             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p0.90                      sample              144.640             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p0.95                      sample              831.488             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p0.99                      sample            34537.472             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p0.999                     sample            65142.784             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p0.9999                    sample           100524.687             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureJson:measureJson·p1.00                      sample           249823.232             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat                               sample  1490803    1109.570 ±  18.395   us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p0.00    sample               37.440             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p0.50    sample               74.624             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p0.90    sample              115.072             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p0.95    sample              376.730             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p0.99    sample            40566.784             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p0.999   sample            78118.912             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p0.9999  sample           123590.358             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat:measureMessageFormat·p1.00    sample           216268.800             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin                                      sample  1426009    1184.753 ±  20.095   us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p0.00                  sample               36.480             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p0.50                  sample               73.088             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p0.90                  sample              114.816             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p0.95                  sample              376.320             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p0.99                  sample            38666.240             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p0.999                 sample            90570.752             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p0.9999                sample           148111.360             us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin:measureOrigin·p1.00                  sample           318767.104             us/op</span><br><span class="line"><span class="comment"># 下面是冷启动的分数，冷启动时单个操作 525 微秒，高于 5p50，但低于 tp 99</span></span><br><span class="line">RiskOutServiceImplBenchMark.measureJson                                            ss       20     525.691 ± 294.527   us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureMessageFormat                                   ss       20     489.662 ± 514.746   us/op</span><br><span class="line">RiskOutServiceImplBenchMark.measureOrigin                                          ss       20     341.841 ± 215.144   us/op</span><br></pre></td></tr></table></figure>

<p>注意标准差： STDEV 基于样本估算标准偏差。标准偏差反映数值相对于平均值(mean) 的离散程度。 </p>
<ul>
<li>ops/us - operations (benchmark method executions) per microsecond</li>
<li>Cnt - total number of trials (forks*iterations)</li>
<li>Score - benchmark result</li>
<li>Error - standard error value. Means how much different trials results differ<br>Also:</li>
<li>thrpt - Throughput mode (how much full benchmark method executions were made in a trial)</li>
<li>avgt - Average Time mode (how much measuring units took benchmark method execution on average)</li>
</ul>
<p>有兴趣还可以试试这两个网站：<br><a target="_blank" rel="noopener" href="http://deepoove.com/jmh-visual-chart/">JMH Visual Chart</a><br><a target="_blank" rel="noopener" href="https://jmh.morethan.io/">JMH Visualizer</a></p>
<p>另外一种解释，参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/cndmss/article/details/93771981">《使用JMH进行基准性能测试》</a>：</p>
<p><strong>数字只能告诉我们 what，通常不能告诉我们 when、where、how 和 why。搞懂 why 是人的工作</strong>：</p>
<blockquote>
<p>REMEMBER: The numbers below are just data. To gain reusable insights,<br>you need to follow up on why the numbers are the way they are. Use<br>profilers (see -prof, -lprof), design factorial experiments, perform<br>baseline and negative tests that provide experimental control, make<br>sure the benchmarking environment is safe on JVM/OS/HW level, ask for<br>reviews from the domain experts. Do not assume the numbers tell you<br>what you want them to tell.</p>
<p>记住：下面的数字只是数据。要获得可重复使用的见解，您需要跟进 为什么数字是这样的。使用分析器（参见 -prof、-lprof），设计因子<br>实验，执行提供实验控制的基线和负面测试，确保 基准测试环境在 JVM/OS/HW 级别是安全的，请咨询领域专家。<br>不要假设数字告诉您您希望他们告诉您的内容。</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">块</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">参数信息（1-10行）</td>
<td align="center">1：jmh版本<br>2：jvm版本信息<br>3：jvm程序（jdk安装路径）<br>4：jvm参数配置<br>5：预热参数：预热次数、每次持续时间<br>6：测试参数：测试次数、每次持续时间<br>7：每次测试迭代超时时间<br>8：每个测试进程的测试线程数<br>9: 测试的模式<br>10:测试的方法</td>
</tr>
<tr>
<td align="center">测试过程（12-75行）</td>
<td align="center">12-23：第1次fork测试 （fork可以理解为1个独立的进程）<br>12：测试完成进度，预计剩余需要时间<br>13：当前第几次fork<br>14-18：预热执行，每次预热执行耗时<br>19-23：正式测试执行，每次测试执行耗时<br>25-36：第2次fork测试<br>38-49：第3次fork测试<br>51-62：第4次fork测试<br>64-75：第5次fork测试</td>
</tr>
<tr>
<td align="center">测试结果（78-95行）</td>
<td align="center">78-81：测试结果，包括测试的方法、平均耗时[平局耗时的比例]、最大最小 耗时、测试结果数据离散度（stdev）等<br>84：测试总耗时<br>86-90：对测试结果的解释<br>92-93：测试结论{测试的方法、测试类型（Mode）、测试总次数(Cnt)、测试结果(Score)、误差(Error)、单位(Units)}<br>95：结束</td>
</tr>
</tbody></table>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2021-12-23");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2021-07-19T07:20:11.000Z" itemprop="datePublished">2021-07-19</time>

    , Updated at&nbsp;<time datetime="2021-12-23T05:19:21.000Z" itemprop="dateModified">2021-12-23</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/JVM/" rel="tag">#&nbsp;JVM</a>

<a class="post-tags-list-item" href="/tags/Java/" rel="tag">#&nbsp;Java</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2021/07/19/%E5%A6%82%E4%BD%95%E5%81%9A%E4%B8%80%E4%B8%AA%E4%BC%98%E7%A7%80%E7%9A%84%E7%B3%BB%E7%BB%9F-owner/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">如何做一个优秀的系统 owner</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2021/07/11/%E6%BC%AB%E9%95%BF%E7%9A%84%E9%81%93%E5%88%AB/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">漫长的道别</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>