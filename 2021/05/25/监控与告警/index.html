<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>监控与告警 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="监控与告警 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="如何设计监控系统监控系统设计得好，我们就能够用图表说话。最通常意义上的指标，是 Metric 系统。 日志收集和指标收集不一样我们的监控系统需要监控整个技术栈。指标是由技术栈决定的，我们有多少技术层次，就有多少类指标。 多套监控系统是有问题的，需要尽量考虑技术体系的融合。然而，基于“一切可监控”的技术原则，移动端、浏览器端、应用层、系统层以及网络层的指标采集、计算、存储、展示以及告警可以集中在一个 - magicliang - 守株阁"><meta name="keywords" content="监控"><meta property="article:published_time" content="2021-05-25T12:58:50.000Z"><meta property="article:modified_time" content="2021-12-23T05:43:53.000Z"><meta property="og:updated_time" content="2021-12-23T05:43:53.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="监控"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/"
    },
    "headline": "监控与告警 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2021-05-25T12:58:50.000Z",
    "dateModified": "2021-12-23T05:43:53.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "监控",
    "description": "如何设计监控系统监控系统设计得好，我们就能够用图表说话。最通常意义上的指标，是 Metric 系统。 日志收集和指标收集不一样我们的监控系统需要监控整个技术栈。指标是由技术栈决定的，我们有多少技术层次，就有多少类指标。 多套监控系统是有问题的，需要尽量考虑技术体系的融合。然而，基于“一切可监控”的技术原则，移动端、浏览器端、应用层、系统层以及网络层的指标采集、计算、存储、展示以及告警可以集中在一个 - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=监控与告警" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=监控与告警&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=监控与告警" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAAAAAAYplnuAAACrElEQVR42u3azU4DMQxF4b7/S8OGBVSJ77mZEQLN6YafTjtfEG4c26+Pf/h4iRYtWvQD0a/h8eMFXz+vfv/+3Pev789/f/3798khWjRFL//pN29Ob766frXAyiFadIHevekuuFagFHxpsZNDtOg70btrdoEzYabgFi36t9BpEdPi/tynh+jHoHeJCgGQxTbXXc7yRD8ePR0of/Prbadx0Y9Gx6LfkCClzYEkW1PydVw1Ff1odLrZVIAhz5NCTbq/aNEtOl4MDqtXcPQQLVo0Qe8S9NQ0Ig2faYHpQLss6IgWXaKboEu/S8X3k01ItGiKJo11ErApKNNrdn840aIbNEnupwVMDdE0zJKaqXhIRbToIRBpwJ0W4Wmjf7lw0aJLdNO0mYYMScEnFfFj1VS0aJh70OR+CqT0x7g9YRItOhwCmmL5BCRJUrXpiBYN0WSYpCk0koJ62nSqCpNo0YtATMOrJKGZDso0QRoL9qJFAzQpEqah1lTkocnZ0TChaNGwqE4OrWkDSgFKhm1Fi74L3TSB0sEhFRZJUUi0aIqmg1ckgE4PB3RRokVTdApCMmhFk/7UcB0DVLRogJ6ChAxbpUIiOeimYS7Rolt0c1NyKN0tPg1dxURKtOgSfdK8bIrnZCEoYRItugxEOthKFkAXjTYm0aIBmtzsKrDZjMbgFS0aoklBnSZG9FqygVWncdGiwwc/TXJookSHb6tAFC06oJvkhQykNI1PVPgULRqgYyEbFCBTAWYqyEw/ixZ9gm4bQ2RDoJtOW4gULbrtjaeGzlRkoQ1RukGJFn0V3TYjm0SKJFeXsjzRoi+i06ZCDsC0yHNbIIoWDZo6JBFqG0NVwiRa9EHC1Cb86T1pER83ikSLLg+2ZBilOURMCVUcfhEtGqD/00O0aNGiH4T+BHhx2xmKcA8qAAAAAElFTkSuQmCC" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">监控与告警</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2021-05-25</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=监控与告警&url=http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=监控与告警&url=http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2021/05/25/%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAAAAAAYplnuAAACrElEQVR42u3azU4DMQxF4b7/S8OGBVSJ77mZEQLN6YafTjtfEG4c26+Pf/h4iRYtWvQD0a/h8eMFXz+vfv/+3Pev789/f/3798khWjRFL//pN29Ob766frXAyiFadIHevekuuFagFHxpsZNDtOg70btrdoEzYabgFi36t9BpEdPi/tynh+jHoHeJCgGQxTbXXc7yRD8ePR0of/Prbadx0Y9Gx6LfkCClzYEkW1PydVw1Ff1odLrZVIAhz5NCTbq/aNEtOl4MDqtXcPQQLVo0Qe8S9NQ0Ig2faYHpQLss6IgWXaKboEu/S8X3k01ItGiKJo11ErApKNNrdn840aIbNEnupwVMDdE0zJKaqXhIRbToIRBpwJ0W4Wmjf7lw0aJLdNO0mYYMScEnFfFj1VS0aJh70OR+CqT0x7g9YRItOhwCmmL5BCRJUrXpiBYN0WSYpCk0koJ62nSqCpNo0YtATMOrJKGZDso0QRoL9qJFAzQpEqah1lTkocnZ0TChaNGwqE4OrWkDSgFKhm1Fi74L3TSB0sEhFRZJUUi0aIqmg1ckgE4PB3RRokVTdApCMmhFk/7UcB0DVLRogJ6ChAxbpUIiOeimYS7Rolt0c1NyKN0tPg1dxURKtOgSfdK8bIrnZCEoYRItugxEOthKFkAXjTYm0aIBmtzsKrDZjMbgFS0aoklBnSZG9FqygVWncdGiwwc/TXJookSHb6tAFC06oJvkhQykNI1PVPgULRqgYyEbFCBTAWYqyEw/ixZ9gm4bQ2RDoJtOW4gULbrtjaeGzlRkoQ1RukGJFn0V3TYjm0SKJFeXsjzRoi+i06ZCDsC0yHNbIIoWDZo6JBFqG0NVwiRa9EHC1Cb86T1pER83ikSLLg+2ZBilOURMCVUcfhEtGqD/00O0aNGiH4T+BHhx2xmKcA8qAAAAAElFTkSuQmCC" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F"><span class="post-toc-number">1.</span> <span class="post-toc-text">如何设计监控系统</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%92%8C%E6%8C%87%E6%A0%87%E6%94%B6%E9%9B%86%E4%B8%8D%E4%B8%80%E6%A0%B7"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">日志收集和指标收集不一样</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%8D%E5%90%8C%E7%AB%AF%E4%B8%8A%E7%9A%84%E6%8C%87%E6%A0%87"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">不同端上的指标</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%9C%89%E5%A4%9A%E5%B0%91%E7%A7%8D%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">有多少种方法可以获取监控数据</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%9B%91%E6%8E%A7%E9%87%87%E6%A0%B7%E9%97%AE%E9%A2%98"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">监控采样问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="post-toc-number">2.</span> <span class="post-toc-text">基础模型设计</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Transaction"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">Transaction</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Transaction-%E7%9A%84-Show-%E5%9B%BE%E8%A1%A8"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">Transaction 的 Show 图表</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Event"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">Event</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Event-%E7%9A%84-Show-%E5%9B%BE%E8%A1%A8"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">Event 的 Show 图表</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Metric-Tag"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">Metric&#x2F;Tag</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Problem"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">Problem</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Problem-%E7%9A%84-Show-%E5%9B%BE%E8%A1%A8"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">Problem 的 Show 图表</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E6%89%93%E7%82%B9"><span class="post-toc-number">3.</span> <span class="post-toc-text">如何选择打点</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%91%8A%E8%AD%A6%E7%AD%96%E7%95%A5%E8%AE%BE%E8%AE%A1"><span class="post-toc-number">4.</span> <span class="post-toc-text">告警策略设计</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%9B%BE%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="post-toc-number">5.</span> <span class="post-toc-text">图表设计</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9B%BE%E8%A1%A8"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">常见的图表</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%8A%98%E7%BA%BF%E5%9B%BE"><span class="post-toc-number">5.1.1.</span> <span class="post-toc-text">折线图</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%A5%BC%E5%9B%BE"><span class="post-toc-number">5.1.2.</span> <span class="post-toc-text">饼图</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%8E%92%E5%90%8D%E5%9B%BE"><span class="post-toc-number">5.1.3.</span> <span class="post-toc-text">排名图</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BB%9F%E8%AE%A1%E6%96%87%E6%9C%AC"><span class="post-toc-number">5.1.4.</span> <span class="post-toc-text">统计文本</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%BC%8F%E6%96%97%E5%9B%BE"><span class="post-toc-number">5.1.5.</span> <span class="post-toc-text">漏斗图</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%97%B6%E5%BA%8F%E8%A1%A8%E6%A0%BC"><span class="post-toc-number">5.1.6.</span> <span class="post-toc-text">时序表格</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%A4%A7%E7%9B%98"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">大盘</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9F%BA%E7%A1%80%E5%A4%A7%E7%9B%98"><span class="post-toc-number">5.2.1.</span> <span class="post-toc-text">基础大盘</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%A0%B8%E5%BF%83%E5%A4%A7%E7%9B%98"><span class="post-toc-number">5.2.2.</span> <span class="post-toc-text">核心大盘</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%91%8A%E8%AD%A6%E6%9D%A1%E4%BB%B6"><span class="post-toc-number">5.2.3.</span> <span class="post-toc-text">告警条件</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="post-toc-number">6.</span> <span class="post-toc-text">监控系统的缺陷</span></a></li></ol></div>
                        
                    
                    <article id="post-content">
                        <h1 id="如何设计监控系统"><a href="#如何设计监控系统" class="headerlink" title="如何设计监控系统"></a>如何设计监控系统</h1><p>监控系统设计得好，我们就能够用图表说话。<br>最通常意义上的指标，是 Metric 系统。</p>
<h2 id="日志收集和指标收集不一样"><a href="#日志收集和指标收集不一样" class="headerlink" title="日志收集和指标收集不一样"></a>日志收集和指标收集不一样</h2><p>我们的监控系统需要监控整个技术栈。指标是由技术栈决定的，我们有多少技术层次，就有多少<strong>类</strong>指标。</p>
<p>多套监控系统是有问题的，需要尽量考虑技术体系的融合。然而，基于“一切可监控”的技术原则，移动端、浏览器端、应用层、系统层以及网络层的指标<strong>采集、计算、存储、展示</strong>以及告警可以集中在一个系统里。但应用层的日志需要 Kafka、ELK 等日志中心的支持。但某些错误日志、慢事务日志，是可以以 logview 的形式被抽样保留下来的。在 logview 里，L代表最新一条请求（L for Latest）的 Log，S代表耗时最久请求（S for Slowest）的 Log。</p>
<p>这样可以：</p>
<p>1、让系统在配置监控时只有一个入口和一套配置，降低学习成本和使用成本，也会消除设计上的概念不完整。实现产品上的融合。<br>2、整合需要整合的存储空间，实现技术上的融合。</p>
<p>正常指标和异常指标是不一样的。异常指标的上报可能包含上下文（在某些场景下叫 NameValuePairs），需要单独设计。</p>
<h2 id="不同端上的指标"><a href="#不同端上的指标" class="headerlink" title="不同端上的指标"></a>不同端上的指标</h2><ul>
<li><p>移动端：端到端网络质量、Crash错误、代码级日志、性能等。</p>
</li>
<li><p>Web端：JS错误、Ajax接口监控、性能等。</p>
</li>
<li><p>应用层：异常、接口性能、依赖拓扑，堆栈等。</p>
</li>
<li><p>系统层：CPU、Memory。</p>
</li>
<li><p>网络层：流量，丢包等。</p>
</li>
</ul>
<p>作为业务团队的研发人员，应当关注应用层、系统层和网络层的指标、监控和告警。</p>
<h2 id="有多少种方法可以获取监控数据"><a href="#有多少种方法可以获取监控数据" class="headerlink" title="有多少种方法可以获取监控数据"></a>有多少种方法可以获取监控数据</h2><ul>
<li><p>小规模在线场景，只能支持简单的应用：提供标准的数据 API，下游业务可以基于 API 做一些定制的报表，比如汇总监控数据作为团队周报、问题看板的数据补充等场景。</p>
</li>
<li><p>大规模在线场景，需要利用消息中间件的堆积能力：提供监控数据MQ的下游消费能力，满足吞吐量较高的下游系统实时消费需求，比如说下游业务系统数据分析诊断。</p>
</li>
<li><p>大规模离线场景，如果需要支持复杂计算，如机器学习，则需要建立另一个 L1 层：建立自己的离线数仓，把关键业务数据导入离线计算平台，这数据用于一些大规模机器学习等任务，比如说智能预测计算。（直接让这些大规模机器学习任务访问实时系统存储，会影响在线系统的SLA）。</p>
</li>
</ul>
<h2 id="监控采样问题"><a href="#监控采样问题" class="headerlink" title="监控采样问题"></a>监控采样问题</h2><p>大 qps 的场景下大量的请求生成会导致生产端网卡超载，所以 api 自己要有高负载的时候把全量采样转成部分采样的策略（采样率低的时候甚至可以低到 0.03%），同样，消费端自己要有流控抛弃请求的策略。但，所有的系统异常的消息是不能因为采样而被丢弃的。</p>
<p>采样率最好做成不可调节，服务自己计算自适应调节。</p>
<p>可以把监控指标做个转换：监控数据是全量统计，客户端预计算；链路数据是采样计算，大约有5%的项目链路是采样统计。这样只要保证客户端或者近端的负载可控即可-这是一个类似 log4j2 的 logger 怎样炒高性能响应的问题。</p>
<h1 id="基础模型设计"><a href="#基础模型设计" class="headerlink" title="基础模型设计"></a>基础模型设计</h1><p>所有的模型都有 type 和 name，理论上 messageTree 可以支持好几层的细分的 messageTree。Transaction 和 Event 都有的 data 的参数（addData），这里面的数据主要用于在查看请求的logview里面用到，这个参数一般传入一些参数值等。</p>
<p>Transaction 和 Event 都记录成功和失败，可以存储抽样的 logview。Transaction 可以嵌套，Event 是不能嵌套的。</p>
<p>Metric 就不记录 logview，纯粹记打点，可以被用来记录 count 和 duration。</p>
<p>建议埋点 Transaction、Event、Metric 等的 type 和 name，都是用英文小写（免得各个环节出现奇奇怪怪的问题），然后分隔符用.表示。比如如下的例子jvm.gc.count，jvm.memory.used 这类表达方式。</p>
<p>通常能够表达成功和失败的节点的 status 都是 0 为成功，非 0 为失败。</p>
<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p>事务是一种：</p>
<ol>
<li>可嵌套</li>
<li>有时间</li>
<li>有成败</li>
<li>可聚合</li>
</ol>
<p>的监控指标。</p>
<p>缺点是：</p>
<ol>
<li>状态只有成败两种。</li>
</ol>
<p>有 type、name、success 和 time，因此可以算出 avg、max、min、tp50、tp99、tp999、tp9999、qps。</p>
<p>主要记录一些边界信息（跨项目、跨模块的调用），记录一些复杂的比较耗时代码统计。</p>
<p>建议如果是本地代码的 Transaction，建议平均执行时间要相对比较长，比如至少超过5ms。错误的用法：不少业务方用了 Transaction，<strong>基本平均耗时基本都是1ms都不到，可能仅仅只是用统计功能，这个可以用 Event 来代替，Event 相比 Transaction 开销要很低，并且埋点的代码也更加精简</strong>。</p>
<p>Transaction 支持服务 key、IP、Type、Name 四个维度的聚合，统计指标有总数、失败数、成功率、TP90、TP95、TP99等丰富的性能指标。注意 Transaction 有 IP 维度的聚合，这样可以根据单台机器看性能指标，很多场景下，机器维度数据是非常有用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Transaction transaction = Monitor.newTransaction(<span class="string">&quot;MVC&quot;</span>, <span class="string">&quot;InboundPhase&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// business logic</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">// successStatus = &quot;0&quot;</span></span><br><span class="line">       transaction.setSuccessStatus();</span><br><span class="line">   &#125; Monitorch (Exception e) &#123;</span><br><span class="line">       <span class="comment">// 任意其他 status 为失败</span></span><br><span class="line">       transaction.setStatus(e); <span class="comment">// Monitor 到异常，设置状态，代表此请求失败</span></span><br><span class="line">       Monitor.logError(e); <span class="comment">// 将异常上报到 Monitor 上</span></span><br><span class="line">       <span class="comment">// 也可以选择向上抛出： throw e;</span></span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       <span class="comment">// 这个地方最好在本线程内确保关闭，否则可能导致消息树常驻内存中，会造成消息不准，OOM 等问题。</span></span><br><span class="line">       transaction.complete();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Transaction-的-Show-图表"><a href="#Transaction-的-Show-图表" class="headerlink" title="Transaction 的 Show 图表"></a>Transaction 的 Show 图表</h3><ul>
<li>统计表格：<table>
<thead>
<tr>
<th align="center">Total</th>
<th align="center">Failure</th>
<th align="center">Failure%</th>
<th align="center">LogView</th>
<th align="center">Max</th>
<th align="center">Avg</th>
<th align="center">TP50</th>
<th align="center">TP90</th>
<th align="center">TP95</th>
<th align="center">TP99</th>
<th align="center">TP999</th>
<th align="center">TP9999</th>
<th align="center">QPS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">23,450</td>
<td align="center">33</td>
<td align="center">0.1407%</td>
<td align="center">Latest Logview 的链接、Slowest Logview 的链接</td>
<td align="center">97.0</td>
<td align="center">15.5</td>
<td align="center">15.4</td>
<td align="center">18.3</td>
<td align="center">19.3</td>
<td align="center">33.0</td>
<td align="center">58.5</td>
<td align="center">59.4</td>
<td align="center">6.5</td>
</tr>
</tbody></table>
</li>
<li>耗时分布直方图：x 轴耗时分布区间，y 轴请求 count。</li>
<li>请求个数直方图（Hits Over time）：x 轴分钟分布，y 轴请求 count。</li>
<li>平均耗时直方图：x 轴分钟时分布，y 轴平均耗时。</li>
<li>成功率曲线图：x 轴分钟时分布，y 轴成功率。</li>
<li>最大耗时直方图：x 轴分钟时分布，y 轴最大耗时。</li>
<li>失败次数直方图（Failures Over Time）：x 轴耗时分布区间，y 轴失败次数 count。</li>
<li>50/90/95/99/99.9/99.99 Line Over Time 曲线图：x 轴分钟分布，y 轴每条分位线的分位点。</li>
<li>机器分布统计：|序号|HostName|IP| + 上方统计表格</li>
<li>总量统计分布饼图</li>
<li>错误统计分布饼图</li>
<li>Status Code 饼图</li>
</ul>
<h2 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h2><blockquote>
<p><strong>“需要计时用 Transaction，仅需要计数用 Event。”</strong> Event 性能更好。</p>
</blockquote>
<p>Event 和 Transaction 有个固有的缺点，就是不能很好地支持多分支的指标监控。只能通过一个 name - show 的“错误分布统计”和“status code 分布统计”来做一些小时级的饼图监控。</p>
<p>主要记录用于记录事件。最常见的场景就是当埋 Transaction 时候，<strong>需要 event作为补充</strong>（如<code>Monitor.logEvent(&quot;Config1&quot;, &quot;Value1&quot;);</code>），比如记录当时访问参数等、代码一些特殊诡异路径的分析（branch 分析），还有异常信息记录。Event 可以解决一些业务统计问题，它更加侧重于业务一些简单统计。Event 埋点支持 Appkey、IP、Type、Name 四个维度的聚合，统计指标相比 Transaction 少一些，只有总数、失败、以及成功率，Event也支持机器维度的统计。</p>
<p>每个 event 都包含 type 和 name，<strong>可以被认为是不带执行时间的 Transaction</strong>。</p>
<p>event 可以当做 metric 用，记录分布的 tag 值，也可以记录配置（配置也可以是一种 tag），他们记录值的方法有：把值写进 type 的名称路径里，把 type 写成 name 的一部分，或者直接写成 name-<strong>这是中间件使用 Event 的主要思路！</strong>。常见的 event type 有：</p>
<ul>
<li>数据库相关，包括： rows、length、method（insert 等语句的统计）（有时候需要理解事务，需要去看 transaction，这个特别重要，可以看到各种的实际 sql）、database（实际的物理 jdbc url，从这里可以看到实际负载均衡和读写分离的分布）。分库分表模式下的逻辑数据源、物理数据源、实际的工作权重。</li>
<li>ShardSQL.xxx 分布式 sql 的请求路由和结果归并是它们的 name，如：物理数据源的名称、操作的事件。</li>
<li>对下游的 rpc call：下游的服务名称、上下游 ip 地址、是否同异步调用。</li>
<li>rpc 类型：是否已经 mesh 化。</li>
<li>泳道/Cell/环境：环境标记。</li>
<li>请求类型、协议类型、请求响应的 size。</li>
<li>是否使用鉴权、是否灰度了鉴权。</li>
<li>限流/熔断相关的配置：到底多少个请求被命中了限流。限流组件.限流模式.log。</li>
<li>缓存：缓存集群、缓存连接、缓存配置、缓存事件、缓存的超时事件。</li>
<li>kms：是否正确地使用了 kms。</li>
<li>是否存在特定的异常。</li>
<li>内部服务调用：这通常需要 aop 来做普遍拦截。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 想知道一个函数的分支执行了多少次，需要一个 type 的 event 下发若干个 name</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            Transaction t = Monitor.newTransaction(<span class="string">&quot;Trans&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">6000</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j % <span class="number">3</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    func1();</span><br><span class="line">                    <span class="comment">// type 为 func，name 为 Func1</span></span><br><span class="line">                    Monitor.logEvent(<span class="string">&quot;Func&quot;</span>, <span class="string">&quot;Func1&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> result = func2();</span><br><span class="line">                    Event e = Monitor.newEvent(<span class="string">&quot;Func&quot;</span>, <span class="string">&quot;Func2&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                        <span class="comment">// successStatus = &quot;0&quot;</span></span><br><span class="line">                        e.setSuccessStatus();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 任意其他 status 为失败</span></span><br><span class="line">                        e.setStatus(<span class="string">&quot;False&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    e.complete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            t.setStatus(Transaction.SUCCESS);</span><br><span class="line">            t.complete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一个例子，通常 success 为代表成功，其他值为失败。只有小时级的监控可以看到 status 的细分饼图，天级就看不到了。nameValuePairs，是任意的字符串（如a=1&amp;b=2&amp;c=....，此处使用此类型的数据。字符限制 1024）。不会在event报表里体现，在调用链logview里可以查看，这种场景一般是在定位问题的时候，查看附加的参数等。</span></span><br><span class="line">Cat.logEvent(MonitorConstants.RISK_CAT_EVENT_RISK_RESULT, catEventString, Event.SUCCESS, <span class="keyword">null</span>); <span class="comment">// 第四个参数是 nameValuePairs</span></span><br></pre></td></tr></table></figure>

<p>有些设计里面，单独的 event 埋点不会生成消息树（消息树等于 LogView），event埋点本身不包含耗时等指标。可以直接使用 transaction埋点。</p>
<p>有非常多的 Event 比 Error 更适合拿来做告警，但专门的异常情况还是适合使用 Problem。</p>
<h3 id="Event-的-Show-图表"><a href="#Event-的-Show-图表" class="headerlink" title="Event 的 Show 图表"></a>Event 的 Show 图表</h3><p>Event 是没有时间的 Transaction，所以没有任何 top percentiles 统计数据。</p>
<ul>
<li><p>统计表格：</p>
<table>
<thead>
<tr>
<th align="center">Total</th>
<th align="center">Failure</th>
<th align="center">Failure%</th>
<th align="center">LogView</th>
<th align="center">QPS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">79,712,728</td>
<td align="center">354,372</td>
<td align="center">0.4446%</td>
<td align="center">最新请求的 LogView 的采样（因为谈不上 Slowest）</td>
<td align="center">6.5</td>
</tr>
</tbody></table>
</li>
<li><p>请求个数直方图（Hits Over time）：x 轴分钟分布，y 轴请求 count。</p>
</li>
<li><p>失败次数直方图（Failures Over Time）：x 轴耗时分布区间，y 轴失败次数 count。</p>
</li>
</ul>
<h2 id="Metric-Tag"><a href="#Metric-Tag" class="headerlink" title="Metric/Tag"></a>Metric/Tag</h2><p>主要用于记录了一些实际的业务指标，用于运维监控，比如订单量，支付等这类case：</p>
<ol>
<li>metric侧重于实时监控，<strong>侧重于非常重要关键业务指标，不做统计分析</strong>。所以不适合看跨很长时间的图表，不容易产生分级聚合（只适合按照 tagName 下钻）。</li>
<li>metric 不适合记录失败，<strong>应该想办法把它变成  problem 的指标</strong>。</li>
<li>Metric 通常有乘积限制，有的 metric 实现允许的多维度的 tag 乘积总数限制是一万（比如一个 metric name 名字叫 pay，有一个 tag 叫 channel，一个 tag 叫 status，如果 channel 有 500 个，status 最多有 20 个，笛卡尔积不能超过一万个）。</li>
</ol>
<p>通常 metric 实现有两个 API，logMetricForCount 以及 logMetricForDuration，logMetricForCount 主要用于 counter 类的业务指标，logMetricForDuration 主要用于 timer 类的业务指标。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">metricDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 业务代码</span></span><br><span class="line">        String status = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">        String channel = <span class="string">&quot;weixin&quot;</span>;</span><br><span class="line">        <span class="comment">//通过业务代码自己统计出来</span></span><br><span class="line">        <span class="keyword">long</span> duration = <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建多维度指标tag并赋值</span></span><br><span class="line">        Map&lt;String, String&gt; tags = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        tags.put(<span class="string">&quot;status&quot;</span>, status);</span><br><span class="line">        tags.put(<span class="string">&quot;channel&quot;</span>, channel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 埋次数统计的点，每调用一次，次数加1，paystatus 是 metric 的 name。每动态拼接出一个 name，会有一个单独的 metric 的 graph。</span></span><br><span class="line">        Monitor.logMetricForCount(<span class="string">&quot;paystatus&quot;</span>, tags);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 埋次数统计的点，每调用一次，次数加3</span></span><br><span class="line">        Monitor.logMetricForCount(<span class="string">&quot;paystatus&quot;</span>, <span class="number">3</span>,  tags);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 埋一个耗时统计的点,duration接口参数为毫秒，Monitor会统计每分钟上报的duration的平均值。</span></span><br><span class="line">        Monitor.logMetricForDuration(<span class="string">&quot;payduration&quot;</span>, duration, tags);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>另一种简化版本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 业务代码</span></span><br><span class="line">String status = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">String channel = <span class="string">&quot;weixin&quot;</span>;</span><br><span class="line"><span class="keyword">long</span> duration = <span class="number">1000L</span>;    </span><br><span class="line"></span><br><span class="line"><span class="comment">//埋次数统计的点，每调用一次，次数加1</span></span><br><span class="line">MetricHelper.build().name(<span class="string">&quot;paystatus&quot;</span>).tag(<span class="string">&quot;status&quot;</span>, status).tag(<span class="string">&quot;channel&quot;</span>, channel).count();</span><br><span class="line"></span><br><span class="line"><span class="comment">//埋次数统计的点，每调用一次，次数加3。如果要对支付金额之类的 metric 做统计，此处可以 count 金额（不支持小数的话比较麻烦）</span></span><br><span class="line">MetricHelper.build().name(<span class="string">&quot;paystatus&quot;</span>).tag(<span class="string">&quot;status&quot;</span>, status).tag(<span class="string">&quot;channel&quot;</span>, channel).count(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//埋一个耗时统计的点,duration接口参数为毫秒，Monitor会统计每分钟上报的duration的平均值。</span></span><br><span class="line">MetricHelper.build().name(<span class="string">&quot;payduration&quot;</span>).tag(<span class="string">&quot;status&quot;</span>, status).tag(<span class="string">&quot;channel&quot;</span>, channel).duration(duration);</span><br></pre></td></tr></table></figure>

<p>Metric 和 Transaction/Event 的区别是：</p>
<ol>
<li>Metric 一开始就是一个个 Graph，Transaction/Event 一开始就是一个 Type、Name 聚合的 Table，下钻到单一指标上才能看到 graph。</li>
<li>Metric 可以按照单独的 Tag 维度再下钻，但 Transaction/Event 只能按照 status 维度再分类一下。</li>
</ol>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>通常异常的 Problem type 是 error，但又可以不只是 error。<br>程序内部的 error 打点是一种 error，exception 是另一种。</p>
<h3 id="Problem-的-Show-图表"><a href="#Problem-的-Show-图表" class="headerlink" title="Problem 的 Show 图表"></a>Problem 的 Show 图表</h3><ul>
<li><p>统计表格：</p>
<table>
<thead>
<tr>
<th align="center">Type</th>
<th align="center">Category</th>
<th align="center">Name</th>
<th align="center">Count</th>
</tr>
</thead>
<tbody><tr>
<td align="center">error（一般是 error、long-call、long-service、long-sql、long-cache、long-mq、long-url，也可以有中间件/业务自定义的 type，每种介质一种 type）</td>
<td align="center">未分类（一般都不分类）</td>
<td align="center">java.lang.InterruptedException（通常是异常名）</td>
<td align="center">最新请求的 LogView 的采样（因为谈不上 Slowest）</td>
</tr>
</tbody></table>
</li>
<li><p>可移动的时间轴：调节时间轴会导致统计数据变更</p>
</li>
<li><p>Minutely Distribution 直方图：x 轴分钟分布，y 轴 problem count。</p>
</li>
<li><p>Machine Distribution 饼图：机器和本 Problem 的分布。</p>
</li>
<li><p>Machine Group 饼图：机房和本 Problem 的分布。</p>
</li>
</ul>
<h1 id="如何选择打点"><a href="#如何选择打点" class="headerlink" title="如何选择打点"></a>如何选择打点</h1><ol>
<li>如果要做 profiling，优先选 Transaction。因为带有成功失败和百分位分布。</li>
<li>如果仅看配置或者操作成败，优先选 Event。业务监控首选 Event。</li>
<li>选 Event 的时候，可以在 Type 上做文章，如果一种业务有好几种结果，可以产生好几个 name。但这种情况下，基于不同 Name 的比例做告警很不合适。</li>
<li>如果选一个 Event 的 Type 和 Name 表达一种业务，则只能选一种 status 作为 success，其他 status 为失败。则可以针对这种 status 的比例设置告警。</li>
<li>如果一个业务产出好几个维度的结果，只能只用一个 metric name 配上多个 tag kv 对的解法了。这种解法的缺点是，不容易配置基于 tagValue 这种【可枚举值】的告警。</li>
</ol>
<h1 id="告警策略设计"><a href="#告警策略设计" class="headerlink" title="告警策略设计"></a>告警策略设计</h1><ul>
<li>可选的主题：Transaction、Event、Problem、Business。</li>
<li>机器：All、或者指定机器 ip、指定正则表达式匹配、枚举若干个机器标签。</li>
<li>指标：qps、请求次数（这里就是单个点的 count 的意思）、失败次数、失败率。有时间的指标还可以看最大耗时、最小耗时、平均耗时、执行总耗时、tp50、tp99、tp999、tp9999。</li>
<li>Type：可以枚举若干个 Type 标签。</li>
<li>Name：All 或者枚举若干个 Name 标签。</li>
<li>GroupBy：All（全集群的意思）、ip、type、name。</li>
</ul>
<h1 id="图表设计"><a href="#图表设计" class="headerlink" title="图表设计"></a>图表设计</h1><p>此处专指 Graph，而不是 Show 的基本图表。</p>
<p>任何一个指标都有单独的统一的 name、type、发生时间加上环境指标（机器、机房、单元、线程、traceId），所以总可以做总聚合，也可以下钻以后再局部聚合。</p>
<p>所以总能进行 sum，进而得到时间维度的曲线图，然后可以按照某一个环境维度再聚合出饼图，或者对时间进行聚合得到柱状图。这一层的分布主要是进行统计分析用。</p>
<p>除此之外，图表应该还能提供相关的 legend，让我们提供足够好的洞察。</p>
<h2 id="常见的图表"><a href="#常见的图表" class="headerlink" title="常见的图表"></a>常见的图表</h2><h3 id="折线图"><a href="#折线图" class="headerlink" title="折线图"></a>折线图</h3><p><strong>最有用</strong></p>
<ul>
<li>主轴（y 轴）：单个点的 count/sum/avg/max/min</li>
<li>副轴（右侧 y 轴）</li>
<li>同环比：</li>
<li>周同比有一条折线</li>
<li>日环比有一条折线</li>
</ul>
<h3 id="饼图"><a href="#饼图" class="headerlink" title="饼图"></a>饼图</h3><ul>
<li>主环、周同比环、日环比环</li>
<li>采样方法：单个点的 count/sum/avg/max/min</li>
</ul>
<h3 id="排名图"><a href="#排名图" class="headerlink" title="排名图"></a>排名图</h3><p>纵轴：排名顺序，可以由大到小，也可以由小到大。<br>横轴：采样方法：单个点的 count/sum/avg/max/min<br>topN：可以定制 N</p>
<h3 id="统计文本"><a href="#统计文本" class="headerlink" title="统计文本"></a>统计文本</h3><ul>
<li>同环比：周同环、日环比</li>
<li>采样方法：单个点的 count/sum/avg/max/min</li>
<li>固定列数：N</li>
</ul>
<h3 id="漏斗图"><a href="#漏斗图" class="headerlink" title="漏斗图"></a>漏斗图</h3><p>一层一层</p>
<ul>
<li>同环比：周同比半梯形、日环比半梯形</li>
<li>采样方法：sum/avg/max/min</li>
<li>排序方法：指标顺序、数值大小</li>
</ul>
<h3 id="时序表格"><a href="#时序表格" class="headerlink" title="时序表格"></a>时序表格</h3><ul>
<li>第一列：时间</li>
<li>第二列：采样方法：单个点的 count/sum/avg/max/min</li>
</ul>
<h2 id="大盘"><a href="#大盘" class="headerlink" title="大盘"></a>大盘</h2><p>大盘是一个监控系统核心可视化模块，是向用户展示度量信息和关键指标现状的工具。Dashboard中文称“仪表盘”或“大盘”，一般由多个图表组成，以满足特定监控主题或场景下，展示整体情况的需求（多个指标数据在时间序列上的展示工具）。</p>
<p>大盘要具有以下特点：</p>
<ol>
<li>汇总多端数据。</li>
<li>用户个性化定义报表</li>
</ol>
<h3 id="基础大盘"><a href="#基础大盘" class="headerlink" title="基础大盘"></a>基础大盘</h3><p>基础的指标关注大盘。</p>
<p>关键步骤：</p>
<ol>
<li>选择空间和目录（如果有必要就新建）。</li>
<li>新建大盘。</li>
<li>新建指标-新增图表（选择折线图、曲线图等类型）。</li>
<li>选择需要 theme、监控的项目（或者服务 key）、目标指标、显示名称、维度、分组（基础 group by 选项）。</li>
<li>新增子指标以后，可以产生聚合指标大盘（<strong>指标经过四则运算可以产生比例指标监控</strong>）。</li>
</ol>
<h3 id="核心大盘"><a href="#核心大盘" class="headerlink" title="核心大盘"></a>核心大盘</h3><p>从基础大盘相关指标衍生出的大盘。很多公司的核心大盘是由 SRE 配置的。</p>
<p>生成核心指标的过程是一个指标提炼上报的过程：</p>
<ol>
<li>页面型业务的指标应该访问成功率和 PV。</li>
<li>查询型服务的指标应该是 qps，交易型服务的指标应该是单量（要对单据产生深刻的理解）和金额。</li>
<li>风控型服务的指标应该是拦截率。</li>
<li>供应链型的服务的指标应该是吞吐量。</li>
</ol>
<p>核心大盘往往可以引入智能告警，智能告警受波动影响，要么限制时间，要么限制阈值。</p>
<h3 id="告警条件"><a href="#告警条件" class="headerlink" title="告警条件"></a>告警条件</h3><ol>
<li>什么指标（count、value）</li>
<li>多少个上报周期（3 分钟、5 分钟、1 小时）</li>
<li>聚合方法（avg、sum、max）</li>
<li>运算符</li>
<li>阈值</li>
<li>条件执行时间</li>
<li>条件间与或非关系</li>
</ol>
<h1 id="监控系统的缺陷"><a href="#监控系统的缺陷" class="headerlink" title="监控系统的缺陷"></a>监控系统的缺陷</h1><p>通常 APM 系统因为结构复杂，流量大，能保证 99.9% 的可用性就很不容易了。基于监控发出的 mq 可以做事件驱动架构，实现告警驱动的自动降级。但如果告警 db 有自动清零机制，自动清零的错误可能导致自动降级出巨大故障。</p>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2021-12-23");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2021-05-25T12:58:50.000Z" itemprop="datePublished">2021-05-25</time>

    , Updated at&nbsp;<time datetime="2021-12-23T05:43:53.000Z" itemprop="dateModified">2021-12-23</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/%E7%9B%91%E6%8E%A7/" rel="tag">#&nbsp;监控</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2021/05/27/%E6%95%85%E9%9A%9C%E6%BC%94%E7%BB%83%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">故障演练平台设计</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2021/05/25/CRM-%E5%B9%B3%E5%8F%B0%E5%8C%96%E7%9A%84%E6%80%9D%E8%B7%AF/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">CRM 平台化的思路</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>