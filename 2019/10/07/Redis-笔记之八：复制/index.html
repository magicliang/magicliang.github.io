<!DOCTYPE html>

<html lang="zh-Hans">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>Redis 笔记之八：复制 | 守株阁</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="守株阁"><meta name="msapplication-starturl" content="http://magicliang.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="守株阁"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="Redis 笔记之八：复制 | 守株阁"><meta property="og:site_name" content="守株阁"><meta property="og:type" content="article"><meta property="og:url" content="http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/"><meta property="og:locale" content="zh-Hans"><meta name="description" content="在分布式系统中为了解决单点问题，必须建立副本复制机制，以解决容灾和负载均衡问题。 配置建立复制建立复制共有三种方法：  在配置文件中使用如下的配置：slaveof localhost 6379 在启动时使用如下命令：redis-server –slaveof localhost 6379 在 redis-cli 中对服务端使用 slaveof localhost 6379  而在主节点里可以查看自 - magicliang - 守株阁"><meta name="keywords" content="Redis"><meta property="og:image" content="https://s2.ax1x.com/2019/10/07/u2ashj.png"><meta property="og:image" content="https://s2.ax1x.com/2019/10/07/u2a2j0.png"><meta property="og:image" content="https://s2.ax1x.com/2019/10/07/u2afBT.png"><meta property="og:image" content="https://s2.ax1x.com/2019/10/07/u2weL6.jpg"><meta property="og:image" content="https://s2.ax1x.com/2019/10/16/KFrtPS.png"><meta property="og:image" content="https://s2.ax1x.com/2019/10/07/u2q6w6.jpg"><meta property="og:image" content="https://s2.ax1x.com/2019/10/07/u2XYwt.jpg"><meta property="article:published_time" content="2019-10-07T08:05:24.000Z"><meta property="article:modified_time" content="2022-01-13T06:36:44.000Z"><meta property="og:updated_time" content="2022-01-13T06:36:44.000Z"><meta property="article:author" content="magicliang"><meta property="article:tag" content="Redis"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/">

    <meta name="generator" content="Hexo 6.0.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/",
    "@type": "BlogPosting",
    "logo": "http://magicliang.github.io/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/"
    },
    "headline": "Redis 笔记之八：复制 | 守株阁",
    
    "image": {
        "@type": "ImageObject",
        "url": "http://magicliang.github.io/img/suka-favicon.ico"
    },
    
    "datePublished": "2019-10-07T08:05:24.000Z",
    "dateModified": "2022-01-13T06:36:44.000Z",
    "author": {
        "@type": "Person",
        "name": "magicliang",
        "image": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/default_avatar.png"
        },
        "description": "Hi, nice to meet you."
    },
    "publisher": {
        "@type": "Organization",
        "name": "守株阁",
        "logo": {
            "@type": "ImageObject",
            "url": "http://magicliang.github.io/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "http://magicliang.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "Redis",
    "description": "在分布式系统中为了解决单点问题，必须建立副本复制机制，以解决容灾和负载均衡问题。 配置建立复制建立复制共有三种方法：  在配置文件中使用如下的配置：slaveof localhost 6379 在启动时使用如下命令：redis-server –slaveof localhost 6379 在 redis-cli 中对服务端使用 slaveof localhost 6379  而在主节点里可以查看自 - magicliang - 守株阁"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">守株阁</a></h1>

    <p class="text-center header-slogan">
        
            
                Hi, nice to meet you.
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search" class="navbar-link">Search</a>
    
    
    
        <div class="dropdown dropdown-right">
    <a class="navbar-link dropdown-toggle" tabindex="0">Share</a>
    <ul class="menu share-menu">

        <!-- Share Weibo -->
        
        <li class="menu-item">
            <a href="http://service.weibo.com/share/share.php?appkey=&title=守株阁&url=http://magicliang.github.io&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
        </li>
        

        <!-- Share Twitter -->
        
        <li class="menu-item">
            <a href="https://twitter.com/intent/tweet?text=守株阁&url=http://magicliang.github.io&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
        </li>
        

        <!-- Share Facebook -->
        
        <li class="menu-item">
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
        </li>
        

        <!-- Share Google+ -->
        
        <li class="menu-item">
            <a href="https://plus.google.com/share?url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
        </li>
        

        <!-- Share LinkedIn -->
        
        <li class="menu-item">
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io&title=Redis 笔记之八：复制" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
        </li>
        

        <!-- Share QQ -->
        
        <li class="menu-item">
            <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=Redis 笔记之八：复制&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
        </li>
        

        <!-- Share Telegram -->
        
        <li class="menu-item">
            <a href="https://t.me/share/url?url=http://magicliang.github.io&text=Redis 笔记之八：复制" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
        </li>
        

        <!-- QRCode -->
        
        <li class="menu-item">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMQAAADECAAAAADlzdG3AAADKUlEQVR42u3a207DMBBF0f7/T8MTUlXiOXtcT1vQ7gsCkjQrkuO53b7+wecmQoQIESLGEbfi8/P/++Puz3u8xur4x2uS66b7EiFiEnG5aMLFyM1f/b76jqsHU50jQsQ0olrQjxe5uslq4a+OI4jVOSJEvAtR3WjCpetULwERIj4VQQM0eqPVIhch4pMQVaC1Oq4KBNOmV22ox6NYESKaCFooePXPkWqHCBEBgYu3zYJBN4lKRYUjVXERImB/gizyVOCqFmQK/qoHURalRYgYQJAiASkYn0ieukGhCBETiLTprJKcKpFPxWVSZEbNSxEiBhCrxV1taKQA1imapRfBKjAUIWIaQRqONEhcbVadl0C16EWImEKk5IQUiqvknjTryYvh8kUhQsQAogq0UmMwLdDdYjVJxkSImEJUiwc1/wC6WwhIwaMIEdOIauN5ZlglJVvdoRQRIl6BSF9Gi8pkAKVTJGs3WUSIOIigBazOQAkdMknBpAgR70J0N6RUECsDt2ZytLw/ESIGELRI3BnY3R1QIUmWCBHTiJ3CMSl2dW6u09wRIWIakZoqZBGnhCg1TGhz/teDEyFiCEE3MtpAr85Piz0dG5ssIkQ8iegOoHQSmBODXeULQYSIIQQdmkoLnjZKaJMxBpciRAwg0sKjGyJtonQGwKqHKELEFILeFN0YU2DX+dtWp0iEiCcR3WSENutJE4ZsauULQYSIQUQqAtDiV/pissG2m/EiRBxEdIpeu4t390UQH7AIEQOI3S8mBeKdJiUZ6hIh4hUI2jCniUsKLGlSVp4nQsQAYqchT4cYaeOFFqiXC1uEiMMIEpzRRdpNlOjgIopiRYg4hKADt2RDq26w23SPG6cIEQOIaqCQLurOUEsVTHYDSBEiJhDpQ5IYMrRIi9e0eCBCxBRid/CwGkZJjUv6vxiAihAxhCDJUaepSF4MpKFZFexEiJhG0GFceoM7iX9KlkSI+BQEaYLQAlxKiNLgmAgR70aQgZUKnq5DigexySJCxACi2sjoYG5KcHaGtlCTRYSIwwg6XEs2pjRkQoK+tNmKEDGJ+MsfESJEiBAx9vkGkbQDcPv/uIMAAAAASUVORK5CYII=" alr="QRCode">
        </li>
        

    </ul>
</div>
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">Redis 笔记之八：复制</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="/img/default_avatar.png" src="/img/suka-lazyload.gif" alt="magicliang's Avatar">
        <span>2019-10-07</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">Share the post</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=Redis 笔记之八：复制&url=http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/&pic=http://magicliang.github.io/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">Share to Weibo</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=Redis 笔记之八：复制&url=http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/&via=magicliang" target="_blank" rel="external noopener noreferrer nofollow">Share to Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/" target="_blank" rel="external noopener noreferrer nofollow">Share to Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/" target="_blank" rel="external noopener noreferrer nofollow">Share to Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/&title=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=守株阁&title=守株阁&summary=关于技术以及人生&pics=http://magicliang.github.io/img/suka-favicon.ico&url=http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/" target="_blank" rel="external noopener noreferrer nofollow"> Share to QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=http://magicliang.github.io/2019/10/07/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%85%AB%EF%BC%9A%E5%A4%8D%E5%88%B6/&text=守株阁" target="_blank" rel="external noopener noreferrer nofollow">Share to Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMQAAADECAAAAADlzdG3AAADKUlEQVR42u3a207DMBBF0f7/T8MTUlXiOXtcT1vQ7gsCkjQrkuO53b7+wecmQoQIESLGEbfi8/P/++Puz3u8xur4x2uS66b7EiFiEnG5aMLFyM1f/b76jqsHU50jQsQ0olrQjxe5uslq4a+OI4jVOSJEvAtR3WjCpetULwERIj4VQQM0eqPVIhch4pMQVaC1Oq4KBNOmV22ox6NYESKaCFooePXPkWqHCBEBgYu3zYJBN4lKRYUjVXERImB/gizyVOCqFmQK/qoHURalRYgYQJAiASkYn0ieukGhCBETiLTprJKcKpFPxWVSZEbNSxEiBhCrxV1taKQA1imapRfBKjAUIWIaQRqONEhcbVadl0C16EWImEKk5IQUiqvknjTryYvh8kUhQsQAogq0UmMwLdDdYjVJxkSImEJUiwc1/wC6WwhIwaMIEdOIauN5ZlglJVvdoRQRIl6BSF9Gi8pkAKVTJGs3WUSIOIigBazOQAkdMknBpAgR70J0N6RUECsDt2ZytLw/ESIGELRI3BnY3R1QIUmWCBHTiJ3CMSl2dW6u09wRIWIakZoqZBGnhCg1TGhz/teDEyFiCEE3MtpAr85Piz0dG5ssIkQ8iegOoHQSmBODXeULQYSIIQQdmkoLnjZKaJMxBpciRAwg0sKjGyJtonQGwKqHKELEFILeFN0YU2DX+dtWp0iEiCcR3WSENutJE4ZsauULQYSIQUQqAtDiV/pissG2m/EiRBxEdIpeu4t390UQH7AIEQOI3S8mBeKdJiUZ6hIh4hUI2jCniUsKLGlSVp4nQsQAYqchT4cYaeOFFqiXC1uEiMMIEpzRRdpNlOjgIopiRYg4hKADt2RDq26w23SPG6cIEQOIaqCQLurOUEsVTHYDSBEiJhDpQ5IYMrRIi9e0eCBCxBRid/CwGkZJjUv6vxiAihAxhCDJUaepSF4MpKFZFexEiJhG0GFceoM7iX9KlkSI+BQEaYLQAlxKiNLgmAgR70aQgZUKnq5DigexySJCxACi2sjoYG5KcHaGtlCTRYSIwwg6XEs2pjRkQoK+tNmKEDGJ+MsfESJEiBAx9vkGkbQDcPv/uIMAAAAASUVORK5CYII=" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="post-toc-number">1.</span> <span class="post-toc-text">配置</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%BB%BA%E7%AB%8B%E5%A4%8D%E5%88%B6"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">建立复制</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%96%AD%E5%BC%80%E5%A4%8D%E5%88%B6"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">断开复制</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">安全性</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8F%AA%E8%AF%BB"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">只读</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BC%A0%E8%BE%93%E5%BB%B6%E8%BF%9F"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">传输延迟</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%8B%93%E6%89%91"><span class="post-toc-number">2.</span> <span class="post-toc-text">拓扑</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">一主一从</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">一主多从</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%A0%91%E7%8A%B6%E7%BB%93%E6%9E%84"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">树状结构</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%8E%9F%E7%90%86"><span class="post-toc-number">3.</span> <span class="post-toc-text">原理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%BF%87%E7%A8%8B"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">过程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">同步数据集</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6%EF%BC%88Full-resync%EF%BC%89"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">全量复制（Full resync）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E5%88%86%E5%A4%8D%E5%88%B6%EF%BC%88partial-replication%EF%BC%89"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">部分复制（partial replication）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%A4%8D%E5%88%B6%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="post-toc-number">3.2.2.1.</span> <span class="post-toc-text">复制偏移量</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%A4%8D%E5%88%B6%E5%86%99%E5%91%BD%E4%BB%A4%E5%88%B0%E5%A4%8D%E5%88%B6%E7%A7%AF%E5%8E%8B%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="post-toc-number">3.2.2.2.</span> <span class="post-toc-text">复制写命令到复制积压缓冲区</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E8%BF%90%E8%A1%8C-id"><span class="post-toc-number">3.2.2.3.</span> <span class="post-toc-text">主节点运行 id</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#psync-%E5%91%BD%E4%BB%A4"><span class="post-toc-number">3.2.2.4.</span> <span class="post-toc-text">psync 命令</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="post-toc-number">3.2.2.5.</span> <span class="post-toc-text">全流程</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%BF%83%E8%B7%B3"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">心跳</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%EF%BC%88%E5%90%8E%E7%BB%AD%EF%BC%89%E5%91%BD%E4%BB%A4%E6%8C%81%E7%BB%AD%EF%BC%88%E5%BC%82%E6%AD%A5%EF%BC%89%E5%A4%8D%E5%88%B6"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">（后续）命令持续（异步）复制</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%BC%80%E5%8F%91%E8%BF%90%E7%BB%B4%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98"><span class="post-toc-number">4.</span> <span class="post-toc-text">开发运维中的问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">读写分离</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BB%B6%E8%BF%9F"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">数据延迟</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AF%BB%E5%88%B0%E8%BF%87%E6%9C%9F%E6%95%B0%E6%8D%AE"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">读到过期数据</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%83%B0%E6%80%A7%E5%88%A0%E9%99%A4%EF%BC%88%E7%94%A8%E6%97%B6-%E8%AF%BB%E6%97%B6%E5%88%A0%E9%99%A4%EF%BC%89"><span class="post-toc-number">4.1.2.1.</span> <span class="post-toc-text">惰性删除（用时&#x2F;读时删除）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9A%E6%97%B6%E5%88%A0%E9%99%A4"><span class="post-toc-number">4.1.2.2.</span> <span class="post-toc-text">定时删除</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BB%8E%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="post-toc-number">4.1.2.3.</span> <span class="post-toc-text">从节点故障</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">主从配置不一致</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%A7%84%E9%81%BF%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">规避全量复制</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%A7%84%E9%81%BF%E5%A4%8D%E5%88%B6%E9%A3%8E%E6%9A%B4"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">规避复制风暴</span></a></li></ol></li></ol></div>
                        
                    
                    <article id="post-content">
                        <p>在分布式系统中为了解决单点问题，必须建立副本复制机制，以解决容灾和负载均衡问题。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="建立复制"><a href="#建立复制" class="headerlink" title="建立复制"></a>建立复制</h2><p>建立复制共有三种方法：</p>
<ol>
<li>在配置文件中使用如下的配置：slaveof localhost 6379</li>
<li>在启动时使用如下命令：redis-server –slaveof localhost 6379</li>
<li>在 redis-cli 中对服务端使用 slaveof localhost 6379</li>
</ol>
<p>而在主节点里可以查看自己的主从信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info replication</span><br></pre></td></tr></table></figure>

<p>可以看到自己的角色：</p>
<blockquote>
<p>role:master</p>
</blockquote>
<p>而从节点则会看到：</p>
<blockquote>
<p>role:slave</p>
</blockquote>
<h2 id="断开复制"><a href="#断开复制" class="headerlink" title="断开复制"></a>断开复制</h2><p>可以使用如下命令断掉与 master 的联系：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof no one</span><br></pre></td></tr></table></figure>

<ol>
<li>本节点断开和 master 的连接。</li>
<li>本节点自己上升为 master。</li>
</ol>
<p>也可以使用如下命令切换 master：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof localhost 6379</span><br></pre></td></tr></table></figure>

<p><strong>如果新 master 不同于老 master，老 master 的数据会被清理掉。</strong></p>
<h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><p>主节点可以设置 requirepass 参数进行验证，这时所有的客户端访问必须使用 auth 命令进行校验。</p>
<h2 id="只读"><a href="#只读" class="headerlink" title="只读"></a>只读</h2><p>从节点（默认）使用 slave-read-only = yes 来保证从节点是只读模式的。在生产上最好保持这种不能允许从节点写的模式，否则会导致数据不一致。</p>
<h2 id="传输延迟"><a href="#传输延迟" class="headerlink" title="传输延迟"></a>传输延迟</h2><p>关闭 repl-disable-tcp-nodelay 可以降低延迟，但整体带宽使用比较大。</p>
<h1 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h1><h2 id="一主一从"><a href="#一主一从" class="headerlink" title="一主一从"></a>一主一从</h2><p><img src="https://s2.ax1x.com/2019/10/07/u2ashj.png" alt="一主一从"></p>
<p>这种思路是把 slave 当做 standby，只在从节点打开持久化（RDB 或 AOF）。这种场景如果主节点重启，则主节点会自动清空数据（因为没有打开持久化-实际上如果没有打开 AOF 持久化，Redis 的优雅关闭也会回退到 RDB 持久化），从节点也可能清空数据。为了预防这种情况出现，在主节点重启以前从节点要<code>slaveof no one</code>断开主从复制-但这种措施无法阻挡主节点宕机引起的数据丢失。</p>
<p><strong>这种一主一从的架构设计和 MySQL 的主从复制很相似，但只打开一端持久化的思路还是比较特别的，不那么安全。而且主节点 flush 数据会导致从节点也 flush 数据，本身也是一种很危险的行为</strong></p>
<h2 id="一主多从"><a href="#一主多从" class="headerlink" title="一主多从"></a>一主多从</h2><p><img src="https://s2.ax1x.com/2019/10/07/u2a2j0.png" alt="一主多从"></p>
<p>这种拓扑又被叫做星形拓扑。这种拓扑比较像 MySQL 的读写分离设计，主节点承担写命令的操作，而从节点也分担读命令的操作，。其中还可以设计一些特殊的读节点，专门执行 keys，sort 操作。但这种操作会占用太多的网络带宽。</p>
<h2 id="树状结构"><a href="#树状结构" class="headerlink" title="树状结构"></a>树状结构</h2><p><img src="https://s2.ax1x.com/2019/10/07/u2afBT.png" alt="此处输入图片的描述"></p>
<p>这种树形架构通过<strong>分层架构来分层放大流量</strong>，平衡了带宽和冗余复制的需要，但下层的节点的同步时延变大了。</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p><img src="https://s2.ax1x.com/2019/10/07/u2weL6.jpg" alt="主从复制过程流程"><br><img src="https://s2.ax1x.com/2019/10/16/KFrtPS.png" alt="主从复制过程流程"><br>[Redis 内存划分.xmind](Redis 内存划分.xmind)</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>1 如果使用配置文件配置主从关系，这一步几乎可以说是一闪而过。这一步只保存 master 的 ip 和 port 。如果这个时候从 master 节点去看 client 信息的话，会看到一个刚刚建立的 client（从主节点的角度来看，从节点实际上也是client，类似某些 kafka 的数据迁移方案迁移的端点把自己伪装成一个 consumer）。</p>
<p>2 从节点内部有个每秒运行的定时任务（大致上是一个定时线程）维护复制相关逻辑，当定时任务发现新的主节点后，会尝试与该节点建立网络连接。从节点会单独打开一个 port（而不是当前从节点的 server 的 port），尝试建立新的 socket。<strong>所以 Redis 的主从复制的连接建立是一个拉过程。</strong></p>
<blockquote>
<p>34020:S 06 Oct 2019 23:09:28.709 * Connecting to MASTER localhost:6379<br>34020:S 06 Oct 2019 23:09:28.712 * MASTER &lt;-&gt; REPLICA sync started</p>
</blockquote>
<p>这个过程如果失败，可以在日志中看到以下错误：</p>
<blockquote>
<p>34020:S 06 Oct 2019 23:09:38.086 * MASTER &lt;-&gt; REPLICA sync started<br>34020:S 06 Oct 2019 23:09:38.086 # Error condition on socket for SYNC: Connection refused</p>
</blockquote>
<p>从节点会无限重试，直到成功或者主从关系被切断为止。</p>
<p>3 从节点会发送 ping，验证：</p>
<ul>
<li>连接的 socket 是否正常</li>
<li>主节点是否能正确响应命令</li>
</ul>
<p>如果验证成功，能收到：</p>
<blockquote>
<p>Master replied to PING, replication can continue…</p>
</blockquote>
<p>4 权限验证 如果 master 配置了 requirepass 参数的话，从节点要配置 masterauth 参数来保证密码一致。</p>
<p>5 同步数据集 分为全量同步和部分同步两种策略。<br>6 命令持续复制 数据集同步完成后。主节点会把自己收到的写命令，持续发给从节点。</p>
<h2 id="同步数据集"><a href="#同步数据集" class="headerlink" title="同步数据集"></a>同步数据集</h2><p>注意，全量复制和部分复制都属于同步数据集的一部分，<strong>后续的写命令持续发送不是部分复制</strong>。</p>
<h3 id="全量复制（Full-resync）"><a href="#全量复制（Full-resync）" class="headerlink" title="全量复制（Full resync）"></a>全量复制（Full resync）</h3><p>在初次复制的场景下，Redis 会使用全量复制策略（对应 Redis 旧版本唯一用于复制的 sync 命令）。主节点的数据会被一次性全部发送给从节点，造成主从节点和网络的很大开销。</p>
<p>一般从节点会打印如下的日志：</p>
<blockquote>
<p>34020:S 06 Oct 2019 23:09:39.128 * MASTER &lt;-&gt; REPLICA sync started<br>34020:S 06 Oct 2019 23:09:39.128 * Non blocking connect for SYNC fired the event.<br>34020:S 06 Oct 2019 23:09:39.128 * Master replied to PING, replication can continue…<br>34020:S 06 Oct 2019 23:09:39.129 * Partial resynchronization not possible (no cached master)<br>34020:S 06 Oct 2019 23:09:39.130 * Full resync from master: 3e6a48b3ce0d87851c0882f4120145a0d7611f0d:0<br>34020:S 06 Oct 2019 23:09:39.181 * MASTER &lt;-&gt; REPLICA sync: receiving 175 bytes from master<br>34020:S 06 Oct 2019 23:09:39.182 * MASTER &lt;-&gt; REPLICA sync: Flushing old data<br>34020:S 06 Oct 2019 23:09:39.182 * MASTER &lt;-&gt; REPLICA sync: Loading DB in memory<br>34020:S 06 Oct 2019 23:09:39.182 * MASTER &lt;-&gt; REPLICA sync: Finished with success</p>
</blockquote>
<p>证明了部分复制不可能，必须打开全量复制。注意PID 34020:S意味着当前 节点是个 Slave（M意味着 Master 而 C 意味着子进程）。</p>
<p>其全流程如下：</p>
<p><img src="https://s2.ax1x.com/2019/10/07/u2q6w6.jpg" alt="全量复制全流程"></p>
<p>注意：</p>
<ul>
<li>主节点和从节点之间的 复制超时时间一般为 60s，如果数据量很大要调高这个超时阈值，否则从节点会放弃全量复制。- 不要复制太大的数据量！否则就要调高超时</li>
<li>主节点在生成 rdb 的过程中，还在不断接受新的命令（因为 bgsave 是由子进程进行操作的），这些新的命令会被保存在一个单独的客户端复制缓冲区里面（<strong>注意，和部分复制的replication-backlog 不一样，这里的 buffer 属于未被发送的命令的 buffer</strong>）。在 send RDB 以后还要单独再 send buffer 一遍。</li>
<li>从节点得到了一个完整的 RDB 文件以后要先 flush old data，然后再进行 load，这个全过程都是阻塞的-这也是 MySQL 不具有，Redis 独有的。</li>
<li>如果从节点自己开启了 AOF 功能，为了保证同步完成以后 AOF 文件立刻可用，先启动一段 bgrewriteaof，子进程 rewrite 完成以后全量复制才算收尾-<strong>增加了阻塞点</strong>。</li>
<li>全量复制过程中，子节点的数据可以算是 stale 的。如果关闭了 slave-serve-stale-data，则全量复制过程中从节点是不接受读命令的（写命令更加不会被接受），<strong>属于完全阻塞状态</strong>。</li>
</ul>
<h3 id="部分复制（partial-replication）"><a href="#部分复制（partial-replication）" class="headerlink" title="部分复制（partial replication）"></a>部分复制（partial replication）</h3><p>在出现网络闪断等情况时，主节点可以只发送一部分数据给从节点以弥补丢失，效率会很高。</p>
<p>普通的主从建立时，会出现若干次部分复制失败的日志，最终会直接通过全量复制成功-<strong>Redis 会优先考虑部分复制的策略</strong>。</p>
<p><code>psync</code>命令需要组件支持以下特性：</p>
<ul>
<li>主从节点各自复制、保存偏移量</li>
<li>主节点复制积压缓冲区</li>
<li>主节点运行 id</li>
</ul>
<h4 id="复制偏移量"><a href="#复制偏移量" class="headerlink" title="复制偏移量"></a>复制偏移量</h4><p>主节点在自己完成写入后，会累加并保存自己的本地 offset。从节点每次完成复制后，也会上报自己的 offset 到主节点中。所以主节点保存了所有节点的偏移量。</p>
<p>而同步了写命令后，从节点也会累加并保存自己的 offset。</p>
<p>对比主从节点的 offset 的差值可以知道<strong>复制延迟多大，从而判定系统健康程度</strong>。</p>
<h4 id="复制写命令到复制积压缓冲区"><a href="#复制写命令到复制积压缓冲区" class="headerlink" title="复制写命令到复制积压缓冲区"></a>复制写命令到复制积压缓冲区</h4><p>Redis 会针对每个 client 准备一个固定长度的队列- replication-backlog，默认大小为 1mb 作为复制积压缓冲区。所有写命令在被发送给从节点的同时，也会被发送到这个队列里。这个队列实际上记录了已被复制的命令，可以作为日后补偿部分丢失写命令的依据。</p>
<p><strong>注意，这个缓冲区是已被发送的命令数据的缓冲区，只是为了重放闪断数据用的，和全量复制里的 send buffer 用到的 buffer，也不保存复制完以后持续同步的后续命令。</strong></p>
<h4 id="主节点运行-id"><a href="#主节点运行-id" class="headerlink" title="主节点运行 id"></a>主节点运行 id</h4><p>每个 Redis 节点都会有一个 40 位的 16 进制字符串来唯一识别节点。</p>
<p>如果主节点重启（必然？）替换了 RDB/AOF 文件（比如两种文件的重写？）的时候会导致节点 id 变化，从节点已经不适用老的 offset， 从节点会重新进行全量复制。-<strong>所以尽量不要随便重启主节点</strong></p>
<h4 id="psync-命令"><a href="#psync-命令" class="headerlink" title="psync 命令"></a>psync 命令</h4><p>psync 命令要求 Redis 2.8 以上版本，<strong>它同时兼容全量复制和部分复制</strong>。</p>
<p>其格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psync runId offset</span><br></pre></td></tr></table></figure>

<p>runId 为待复制的主节点 id，offset 为已复制的数据偏移量（如果是全量复制，其值为-1）。</p>
<p>从节点发送 psync 命令给主节点，主节点回复不同内容的响应给从节点：</p>
<ul>
<li>FULLSYCN {runId} {offset} 从节点将开始全量复制</li>
<li>+CONTINUE 从节点触发部分复制</li>
<li>+ERR 主节点的版本低于 2.8，要从 sync 命令开始重新触发全量复制。</li>
</ul>
<h4 id="全流程"><a href="#全流程" class="headerlink" title="全流程"></a>全流程</h4><p><img src="https://s2.ax1x.com/2019/10/07/u2XYwt.jpg" alt="此处输入图片的描述"></p>
<p>普通的全量复制，一旦遇到网络闪断，肯定会触发超时复制失败，浪费大量的系统开销。但拥有部分复制的流程，在网络中断后，可以尝试用部分复制来修复小部分数据（默认 1MB）。</p>
<p><strong>部分复制只能发送 replication-backlog 里的数据，如果超出了这个缓冲区的范围，复制就会直接像普通的全量复制超时一样失败，然后重启一个新的全量复制。</strong></p>
<h2 id="心跳"><a href="#心跳" class="headerlink" title="心跳"></a>心跳</h2><p>主从会相互维护心跳监测：</p>
<ol>
<li>主从会互相模拟成各自的客户端进行通信，也就是会出现在对方的 client list 里。只不过主节点的 flags=M，而从节点的 flags=S。</li>
<li>主节点定时发送 ping 命令到各个从节点。</li>
<li>从节点定时上报自己的复制偏移量（<strong>实际上主从节点都会保存很详细的彼此的进度信息，特别lastest、last 之类的信息，这点同 hdfs、 MySQL 一样，值得学习</strong>）。</li>
</ol>
<h2 id="（后续）命令持续（异步）复制"><a href="#（后续）命令持续（异步）复制" class="headerlink" title="（后续）命令持续（异步）复制"></a>（后续）命令持续（异步）复制</h2><p>主节点接下来响应写命令，直接返回客户端写结果，而不受从节点复制结果的影响-如何防止这一步数据丢失？应该还存在若干 offset 回溯的功能来预防这个问题。</p>
<h1 id="开发运维中的问题"><a href="#开发运维中的问题" class="headerlink" title="开发运维中的问题"></a>开发运维中的问题</h1><h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><h3 id="数据延迟"><a href="#数据延迟" class="headerlink" title="数据延迟"></a>数据延迟</h3><p>这个问题是由架构和网络通信的特性决定的，不可避免。我们能够做的就是设立多种监控措施，不断用轮询的方式来发现超高的 lag 及时报警人工干预。</p>
<h3 id="读到过期数据"><a href="#读到过期数据" class="headerlink" title="读到过期数据"></a>读到过期数据</h3><p><strong>低版本的从节点不会主动删除数据，除非它收到主节点的 del 命令。</strong>高版本的从节点在读取数据的时候也会检查数据是否已经超时，如果没有超时则</p>
<p>主节点删除超时数据有两种策略。实际上现实中的系统必须混合使用两种策略才能安全删除。</p>
<h4 id="惰性删除（用时-读时删除）"><a href="#惰性删除（用时-读时删除）" class="headerlink" title="惰性删除（用时/读时删除）"></a>惰性删除（用时/读时删除）</h4><p>在收到读命令的时候检查超时阈值，如果已超时则主动删除，且返回 nil 给客户端，并同步 del 命令到从节点。</p>
<p><strong>实际上 Java 的 weakHashMap 也是采用这种策略来维护自己的数据集的。</strong></p>
<h4 id="定时删除"><a href="#定时删除" class="headerlink" title="定时删除"></a>定时删除</h4><p>主节点内部有一个定时任务循环采样数据，发现采样的键过期执行 del 命令，之后再同步到从节点。</p>
<h4 id="从节点故障"><a href="#从节点故障" class="headerlink" title="从节点故障"></a>从节点故障</h4><p>如果自己做水平扩展，则故障转移方案（特别是从节点失效的问题）要自己做。所以可以上 Redis-Cluster 这样的现成方案。</p>
<h2 id="主从配置不一致"><a href="#主从配置不一致" class="headerlink" title="主从配置不一致"></a>主从配置不一致</h2><p>如果主从的配置不一致，从节点可能无法像主节点一样正常工作。特别是从节点的 maxmemory 不如主节点大的时候，从节点可能会发生内存淘汰而丢失部分数据。-<strong>主从节点最好有一样的容量</strong>。</p>
<h2 id="规避全量复制"><a href="#规避全量复制" class="headerlink" title="规避全量复制"></a>规避全量复制</h2><p>全量复制非常耗费资源，应该注意几个问题：</p>
<ul>
<li>首次复制应该与业务高峰期错开。</li>
<li><strong>避免主节点重启</strong>导致从节点全量复制，这种情况可以考虑提升从节点为主节点。</li>
<li>合理规划配置，避免挤压缓冲区不足，部分复制失败回退回全量复制。</li>
</ul>
<h2 id="规避复制风暴"><a href="#规避复制风暴" class="headerlink" title="规避复制风暴"></a>规避复制风暴</h2><p>Redis 针对主节点做过专门优化，使得多个从节点可以共用针对第一个从节点生成的 RDB 文件。但还存在其他问题，值得注意：</p>
<ul>
<li>应该尽量避免单一主节点复制多个从节点，使用树形架构来节约主节点的带宽。</li>
<li>打散多个主节点，避免多个节点一起容灾（同时重启开始复制会拖垮CPU、内存、硬盘和带宽）。</li>
</ul>

                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">This article was last updated on <span id="date-expire-num"></span> days ago, and the information described in the article may have changed.</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2022-01-13");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2019-10-07T08:05:24.000Z" itemprop="datePublished">2019-10-07</time>

    , Updated at&nbsp;<time datetime="2022-01-13T06:36:44.000Z" itemprop="dateModified">2022-01-13</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/Redis/" rel="tag">#&nbsp;Redis</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2019/10/18/JDK-%E6%94%B6%E8%B4%B9%E9%97%AE%E9%A2%98/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">JDK 收费问题</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2019/10/06/Redis-%E7%AC%94%E8%AE%B0%E4%B9%8B%E4%B8%83%EF%BC%9A%E6%8C%81%E4%B9%85%E5%8C%96/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">Redis 笔记之七：持久化</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="http://magicliang.github.io">守株阁</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>