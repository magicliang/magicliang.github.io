<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹ | å®ˆæ ªé˜</title><meta name="author" content="magicliang"><meta name="copyright" content="magicliang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹ Java å†…å­˜æ¨¡å‹ï¼ˆJava Memory Model, JMMï¼‰å®šä¹‰äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å…±äº«å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œæ˜¯ç†è§£å¹¶å‘ç¼–ç¨‹çš„åŸºçŸ³ã€‚æœ¬æ–‡ä»ç¡¬ä»¶æ¶æ„å‡ºå‘ï¼Œé€æ­¥æ·±å…¥åˆ° JMM çš„æ ¸å¿ƒæœºåˆ¶ä¸å®è·µæ¨¡å¼ã€‚ mindmap   root((JMM))     ç¡¬ä»¶åŸºç¡€       CPUç¼“å­˜å±‚æ¬¡       ç¼“å­˜ä¸€è‡´æ€§åè®®     JMM æŠ½è±¡       ä¸»å†…å­˜ vs å·¥ä½œå†…å­˜">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹">
<meta property="og:url" content="https://magicliang.github.io/2026/02/07/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/index.html">
<meta property="og:site_name" content="å®ˆæ ªé˜">
<meta property="og:description" content="JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹ Java å†…å­˜æ¨¡å‹ï¼ˆJava Memory Model, JMMï¼‰å®šä¹‰äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å…±äº«å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œæ˜¯ç†è§£å¹¶å‘ç¼–ç¨‹çš„åŸºçŸ³ã€‚æœ¬æ–‡ä»ç¡¬ä»¶æ¶æ„å‡ºå‘ï¼Œé€æ­¥æ·±å…¥åˆ° JMM çš„æ ¸å¿ƒæœºåˆ¶ä¸å®è·µæ¨¡å¼ã€‚ mindmap   root((JMM))     ç¡¬ä»¶åŸºç¡€       CPUç¼“å­˜å±‚æ¬¡       ç¼“å­˜ä¸€è‡´æ€§åè®®     JMM æŠ½è±¡       ä¸»å†…å­˜ vs å·¥ä½œå†…å­˜">
<meta property="og:locale">
<meta property="og:image" content="https://magicliang.github.io/img/wall-paper-112.jpg">
<meta property="article:published_time" content="2026-02-07T15:11:14.000Z">
<meta property="article:modified_time" content="2026-02-12T12:01:40.584Z">
<meta property="article:author" content="magicliang">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="Javaå†…å­˜æ¨¡å‹">
<meta property="article:tag" content="happens-before">
<meta property="article:tag" content="å†…å­˜">
<meta property="article:tag" content="å¤šçº¿ç¨‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://magicliang.github.io/img/wall-paper-112.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹",
  "url": "https://magicliang.github.io/2026/02/07/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/",
  "image": "https://magicliang.github.io/img/wall-paper-112.jpg",
  "datePublished": "2026-02-07T15:11:14.000Z",
  "dateModified": "2026-02-12T12:01:40.584Z",
  "author": [
    {
      "@type": "Person",
      "name": "magicliang",
      "url": "https://magicliang.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://magicliang.github.io/2026/02/07/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: magicliang","link":"Link: ","source":"Source: å®ˆæ ªé˜","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="å®ˆæ ªé˜" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/wall-paper-112.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">å®ˆæ ªé˜</span></a><a class="nav-page-title" href="/"><span class="site-name">JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2026-02-07T15:11:14.000Z" title="Created 2026-02-07 23:11:14">2026-02-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-02-12T12:01:40.584Z" title="Updated 2026-02-12 20:01:40">2026-02-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">6.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>23mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹</h1>
<p>Java å†…å­˜æ¨¡å‹ï¼ˆJava Memory Model, JMMï¼‰å®šä¹‰äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å…±äº«å˜é‡çš„è®¿é—®è§„åˆ™ï¼Œæ˜¯ç†è§£å¹¶å‘ç¼–ç¨‹çš„åŸºçŸ³ã€‚æœ¬æ–‡ä»ç¡¬ä»¶æ¶æ„å‡ºå‘ï¼Œé€æ­¥æ·±å…¥åˆ° JMM çš„æ ¸å¿ƒæœºåˆ¶ä¸å®è·µæ¨¡å¼ã€‚</p>
<pre><code class="hljs mermaid">mindmap
  root((JMM))
    ç¡¬ä»¶åŸºç¡€
      CPUç¼“å­˜å±‚æ¬¡
      ç¼“å­˜ä¸€è‡´æ€§åè®®
    JMM æŠ½è±¡
      ä¸»å†…å­˜ vs å·¥ä½œå†…å­˜
      å…«ç§å†…å­˜æ“ä½œ
      happens-before å…³ç³»
    å…³é”®ä¿è¯
      åŸå­æ€§
      å¯è§æ€§
      æœ‰åºæ€§
    å®è·µå·¥å…·
      volatile
      synchronized
      final</code></pre>
<h2 id="æ¨¡å¼æ€»è§ˆ">æ¨¡å¼æ€»è§ˆ</h2>
<table>
<thead>
<tr>
<th>#</th>
<th>æ¨¡å¼åç§°</th>
<th>ä¸€å¥è¯å£è¯€</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>å†™åˆ·è¯»æ¸…</td>
<td>å†™å…¥å³åˆ·ç›˜ï¼Œè¯»å–å…ˆæ¸…ç©º</td>
<td>volatile / unlock åçš„å¯è§æ€§</td>
</tr>
<tr>
<td>2</td>
<td>é¡ºåºé”</td>
<td>åŒæŠŠé”å†…ï¼Œä¸²è¡Œæ‰§è¡Œ</td>
<td>synchronized ä¸´ç•ŒåŒºä¿æŠ¤</td>
</tr>
<tr>
<td>3</td>
<td>ååºä¼ é€’</td>
<td>Aå…ˆäºBï¼ŒBå…ˆäºCï¼Œåˆ™Aå…ˆäºC</td>
<td>happens-before é“¾å¼æ¨ç†</td>
</tr>
<tr>
<td>4</td>
<td>ä¸å¯å˜å®‰å…¨</td>
<td>æ„é€ å®Œæˆå‰ä¸é€ƒé€¸ï¼Œå®Œæˆåä¸ä¿®æ”¹</td>
<td>final å­—æ®µçš„å®‰å…¨å‘å¸ƒ</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ä¸€-ä»ç¡¬ä»¶åˆ°æŠ½è±¡ï¼šä¸ºä»€ä¹ˆéœ€è¦-jmm">ä¸€ã€ä»ç¡¬ä»¶åˆ°æŠ½è±¡ï¼šä¸ºä»€ä¹ˆéœ€è¦ JMM</h2>
<h3 id="1-1-cpu-æ¶æ„çš„æ€§èƒ½é¸¿æ²Ÿ">1.1 CPU æ¶æ„çš„æ€§èƒ½é¸¿æ²Ÿ</h3>
<p>ç°ä»£ CPU çš„å¤„ç†é€Ÿåº¦è¿œè¶…ä¸»å†…å­˜ï¼ˆDRAMï¼‰çš„å“åº”èƒ½åŠ›ã€‚ä»¥ Intel Skylake æ¶æ„ä¸ºä¾‹ï¼š</p>
<table>
<thead>
<tr>
<th>å±‚çº§</th>
<th>å…¸å‹å»¶è¿Ÿ</th>
<th>å®¹é‡èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td>L1 Cache</td>
<td>~4 cycles</td>
<td>32KB</td>
</tr>
<tr>
<td>L2 Cache</td>
<td>~12 cycles</td>
<td>256KB</td>
</tr>
<tr>
<td>L3 Cache</td>
<td>~40 cycles</td>
<td>8-32MB</td>
</tr>
<tr>
<td>ä¸»å†…å­˜</td>
<td>~200+ cycles</td>
<td>GB çº§</td>
</tr>
</tbody>
</table>
<p>è¿™ç§æ•°é‡çº§çš„å·®å¼‚è¿«ä½¿ CPU å¼•å…¥å¤šçº§ç¼“å­˜ã€‚ä½†ç¼“å­˜å¸¦æ¥äº†æ–°çš„é—®é¢˜ï¼š<strong>å¤šä¸ªå¤„ç†å™¨çš„ç¼“å­˜å¦‚ä½•ä¿æŒä¸€è‡´ï¼Ÿ</strong></p>
<h3 id="1-2-ç¼“å­˜ä¸€è‡´æ€§åè®®-mesi">1.2 ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰</h3>
<p>ç°ä»£å¤„ç†å™¨ä½¿ç”¨ MESI åè®®ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§ï¼Œå…¶å››ä¸ªçŠ¶æ€ä¸ºï¼š</p>
<table>
<thead>
<tr>
<th>çŠ¶æ€</th>
<th>å«ä¹‰</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>M</strong>odified</td>
<td>å·²ä¿®æ”¹</td>
<td>ä»…å½“å‰ç¼“å­˜æ‹¥æœ‰è¯¥æ•°æ®ï¼Œä¸”ä¸å†…å­˜ä¸ä¸€è‡´</td>
</tr>
<tr>
<td><strong>E</strong>xclusive</td>
<td>ç‹¬å </td>
<td>ä»…å½“å‰ç¼“å­˜æ‹¥æœ‰è¯¥æ•°æ®ï¼Œä¸å†…å­˜ä¸€è‡´</td>
</tr>
<tr>
<td><strong>S</strong>hared</td>
<td>å…±äº«</td>
<td>å¤šä¸ªç¼“å­˜æ‹¥æœ‰è¯¥æ•°æ®ï¼Œä¸å†…å­˜ä¸€è‡´</td>
</tr>
<tr>
<td><strong>I</strong>nvalid</td>
<td>å¤±æ•ˆ</td>
<td>å½“å‰ç¼“å­˜è¯¥æ•°æ®æ— æ•ˆï¼Œéœ€é‡æ–°åŠ è½½</td>
</tr>
</tbody>
</table>
<p>çŠ¶æ€è½¬æ¢ç¤ºæ„ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">åˆå§‹ï¼šCPU0(E) â† å†…å­˜<span class="hljs-attribute">X</span>=0<br><br>CPU0 å†™å…¥ <span class="hljs-attribute">X</span>=1ï¼š<br>  E â†’ M ï¼ˆç‹¬å â†’ä¿®æ”¹ï¼Œé€šçŸ¥å…¶ä»– CPU è¯¥åœ°å€ä¸º Iï¼‰<br><br>CPU1 è¯»å– Xï¼š<br>  CPU0 å°† X å†™å›å†…å­˜ï¼ŒçŠ¶æ€å˜ä¸º S<br>  CPU1 ä»å†…å­˜åŠ è½½ Xï¼ŒçŠ¶æ€ä¸º S<br>  ç»“æœï¼šCPU0(S) â†â†’ å†…å­˜<span class="hljs-attribute">X</span>=1 â†’ CPU1(S)<br></code></pre></td></tr></table></figure>
<h3 id="1-3-ä¸ºä½•éœ€è¦-jmm">1.3 ä¸ºä½•éœ€è¦ JMM</h3>
<p>ç¡¬ä»¶å±‚é¢çš„ç¼“å­˜ä¸€è‡´æ€§ç”±å¤„ç†å™¨è‡ªåŠ¨ä¿è¯ï¼Œä½†è¿™å¯¹ä¸Šå±‚ç¨‹åºå‘˜æ˜¯ä¸é€æ˜çš„ã€‚ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶å¯èƒ½è¿›è¡Œä»¥ä¸‹ä¼˜åŒ–ï¼š</p>
<ul>
<li><strong>ç¼–è¯‘å™¨é‡æ’åº</strong>ï¼šä¸æ”¹å˜å•çº¿ç¨‹è¯­ä¹‰çš„å‰æä¸‹è°ƒæ•´æŒ‡ä»¤é¡ºåº</li>
<li><strong>å¤„ç†å™¨ä¹±åºæ‰§è¡Œ</strong>ï¼šåˆ©ç”¨æµæ°´çº¿å¹¶è¡Œæ‰§è¡Œæ— ä¾èµ–çš„æŒ‡ä»¤</li>
<li><strong>ç¼“å­˜å¯è§æ€§å»¶è¿Ÿ</strong>ï¼šå†™æ“ä½œå¯¹å…¶ä»– CPU ç«‹å³å¯è§å¹¶éä¿è¯</li>
</ul>
<p>JMM çš„ä½œç”¨æ˜¯åœ¨è¿™äº›åº•å±‚ä¼˜åŒ–ä¹‹ä¸Šï¼Œæä¾›ä¸€ä¸ª<strong>å¯é¢„æµ‹çš„ç¼–ç¨‹æ¨¡å‹</strong>ï¼Œæ˜ç¡®å‘ŠçŸ¥ç¨‹åºå‘˜ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥å®‰å…¨åœ°æ¨æ–­å¤šçº¿ç¨‹é—´çš„æ‰§è¡Œé¡ºåºã€‚</p>
<hr>
<h2 id="äºŒ-jmm-æ ¸å¿ƒæŠ½è±¡">äºŒã€JMM æ ¸å¿ƒæŠ½è±¡</h2>
<h3 id="2-1-ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜">2.1 ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜</h3>
<p>JMM å®šä¹‰äº†ä¸€å¥—æŠ½è±¡çš„å†…å­˜æ¨¡å‹ï¼ˆJLS Â§17.4ï¼‰ï¼š</p>
<ul>
<li><strong>ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰</strong>ï¼šæ‰€æœ‰å˜é‡å­˜å‚¨çš„åœ°æ–¹ï¼Œå¯¹åº”ç‰©ç†å†…å­˜</li>
<li><strong>å·¥ä½œå†…å­˜ï¼ˆWorking Memoryï¼‰</strong>ï¼šæ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„ç¼“å­˜åŒºåŸŸï¼Œå¯¹åº” CPU å¯„å­˜å™¨ + L1/L2/L3 ç¼“å­˜</li>
</ul>
<p>çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œå¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">çº¿ç¨‹Aå·¥ä½œå†…å­˜ â† <span class="hljs-built_in">read</span>/load â†’ ä¸»å†…å­˜ â†’ <span class="hljs-built_in">read</span>/load â†’ çº¿ç¨‹Bå·¥ä½œå†…å­˜<br>       â†“                                       â†‘<br>     use â†’ assign                          assign â†’ use<br></code></pre></td></tr></table></figure>
<h3 id="2-2-å…«ç§å†…å­˜æ“ä½œ-jls-17-4-1">2.2 å…«ç§å†…å­˜æ“ä½œï¼ˆJLS Â§17.4.1ï¼‰</h3>
<p>JMM å®šä¹‰äº† 8 ç§åŸå­æ“ä½œæè¿°ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜çš„äº¤äº’ï¼š</p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>ä½œç”¨åŸŸ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lock</code></td>
<td>ä¸»å†…å­˜</td>
<td>å°†å˜é‡æ ‡è®°ä¸ºçº¿ç¨‹ç‹¬å çŠ¶æ€</td>
</tr>
<tr>
<td><code>unlock</code></td>
<td>ä¸»å†…å­˜</td>
<td>é‡Šæ”¾å˜é‡çš„çº¿ç¨‹ç‹¬å çŠ¶æ€</td>
</tr>
<tr>
<td><code>read</code></td>
<td>ä¸»å†…å­˜â†’å·¥ä½œå†…å­˜</td>
<td>å°†å˜é‡å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°å·¥ä½œå†…å­˜</td>
</tr>
<tr>
<td><code>load</code></td>
<td>å·¥ä½œå†…å­˜</td>
<td>å°† <code>read</code> çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜å‰¯æœ¬</td>
</tr>
<tr>
<td><code>use</code></td>
<td>å·¥ä½œå†…å­˜â†’æ‰§è¡Œå¼•æ“</td>
<td>å°†å˜é‡å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“</td>
</tr>
<tr>
<td><code>assign</code></td>
<td>æ‰§è¡Œå¼•æ“â†’å·¥ä½œå†…å­˜</td>
<td>å°†æ‰§è¡Œç»“æœèµ‹å€¼ç»™å·¥ä½œå†…å­˜å˜é‡</td>
</tr>
<tr>
<td><code>store</code></td>
<td>å·¥ä½œå†…å­˜â†’ä¸»å†…å­˜</td>
<td>å°†å˜é‡å€¼ä»å·¥ä½œå†…å­˜ä¼ è¾“åˆ°ä¸»å†…å­˜</td>
</tr>
<tr>
<td><code>write</code></td>
<td>ä¸»å†…å­˜</td>
<td>å°† <code>store</code> çš„å€¼å†™å…¥ä¸»å†…å­˜å˜é‡</td>
</tr>
</tbody>
</table>
<p><strong>åŸºæœ¬æ‰§è¡Œçº¦æŸ</strong>ï¼ˆJLS Â§17.4.2ï¼‰ï¼š</p>
<ol>
<li><code>read</code> ä¸ <code>load</code> å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†å¯ä¸è¿ç»­ï¼ˆä¸­é—´å¯æ’å…¥å…¶ä»–æŒ‡ä»¤ï¼‰</li>
<li><code>store</code> ä¸ <code>write</code> å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†å¯ä¸è¿ç»­</li>
<li>ä¸å…è®¸ä¸¢å¼ƒæœ€è¿‘çš„ <code>assign</code>ï¼Œå˜é‡æ”¹å˜å¿…é¡»åŒæ­¥å›ä¸»å†…å­˜</li>
<li>æ–°å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜è¯ç”Ÿï¼Œä¸å¯ç›´æ¥ä½¿ç”¨æœªåˆå§‹åŒ–å˜é‡</li>
</ol>
<p>å…¸å‹çš„å®Œæ•´æ“ä½œåºåˆ—ï¼š</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos"><span class="hljs-keyword">read</span> â†’ load â†’ <span class="hljs-keyword">use</span> â†’ ... (ä¸šåŠ¡è®¡ç®—) ... â†’ assign â†’ store â†’ <span class="hljs-keyword">write</span><br></code></pre></td></tr></table></figure>
<h3 id="2-3-æŒ‡ä»¤é‡æ’åº">2.3 æŒ‡ä»¤é‡æ’åº</h3>
<h4 id="2-3-1-é‡æ’åºçš„æœ¬è´¨">2.3.1 é‡æ’åºçš„æœ¬è´¨</h4>
<p>æŒ‡ä»¤é‡æ’åºæ˜¯ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æå‡æ€§èƒ½è€Œè¿›è¡Œçš„ä¼˜åŒ–æ‰‹æ®µã€‚å…¶æ ¸å¿ƒåŸåˆ™æ˜¯ï¼š</p>
<blockquote>
<p><strong>As-If-Serial è¯­ä¹‰</strong>ï¼šåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œé‡æ’åºåçš„æ‰§è¡Œç»“æœä¸é¡ºåºæ‰§è¡Œçš„ç»“æœå®Œå…¨ä¸€è‡´ã€‚</p>
</blockquote>
<p>è¿™æ„å‘³ç€é‡æ’åº<strong>ä¸ä¼šæ”¹å˜å•çº¿ç¨‹çš„æ­£ç¡®æ€§</strong>ï¼Œä½†<strong>æ— æ³•ä¿è¯å¤šçº¿ç¨‹é—´çš„å¯è§æ€§å’Œæœ‰åºæ€§</strong>ã€‚</p>
<h4 id="2-3-2-é‡æ’åºçš„ä¸‰ä¸ªå±‚æ¬¡">2.3.2 é‡æ’åºçš„ä¸‰ä¸ªå±‚æ¬¡</h4>
<table>
<thead>
<tr>
<th>å±‚æ¬¡</th>
<th>æ‰§è¡Œä¸»ä½“</th>
<th>é‡æ’åºç±»å‹</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç¼–è¯‘å™¨é‡æ’åº</strong></td>
<td>JIT ç¼–è¯‘å™¨</td>
<td>è°ƒæ•´å­—èŠ‚ç æŒ‡ä»¤é¡ºåº</td>
<td>å¾ªç¯å±•å¼€ã€å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤</td>
</tr>
<tr>
<td><strong>å¤„ç†å™¨é‡æ’åº</strong></td>
<td>CPU ç¡¬ä»¶</td>
<td>ä¹±åºæ‰§è¡Œï¼ˆOut-of-Order Executionï¼‰</td>
<td>æŒ‡ä»¤çº§å¹¶è¡Œã€æµæ°´çº¿ä¼˜åŒ–</td>
</tr>
<tr>
<td><strong>å†…å­˜ç³»ç»Ÿé‡æ’åº</strong></td>
<td>ç¼“å­˜ç³»ç»Ÿ</td>
<td>æ”¹å˜å†™æ“ä½œçš„å¯è§é¡ºåº</td>
<td>Store Buffer å»¶è¿Ÿå†™å…¥</td>
</tr>
</tbody>
</table>
<h4 id="2-3-3-é‡æ’åºç¤ºä¾‹">2.3.3 é‡æ’åºç¤ºä¾‹</h4>
<p><strong>ç¼–è¯‘å™¨é‡æ’åºç¤ºä¾‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æºä»£ç </span><br><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;        <span class="hljs-comment">// A</span><br><span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;        <span class="hljs-comment">// B</span><br><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;    <span class="hljs-comment">// C</span><br><br><span class="hljs-comment">// ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–ä¸ºï¼š</span><br><span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;        <span class="hljs-comment">// Bï¼ˆå…ˆæ‰§è¡Œï¼‰</span><br><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;        <span class="hljs-comment">// A</span><br><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;    <span class="hljs-comment">// C</span><br><br><span class="hljs-comment">// åŸå› ï¼šAå’ŒBæ— ä¾èµ–å…³ç³»ï¼Œè°å…ˆæ‰§è¡Œä¸å½±å“Cçš„ç»“æœ</span><br><span class="hljs-comment">// è¿™ç§é‡æ’åºåœ¨å•çº¿ç¨‹ä¸­å®Œå…¨é€æ˜</span><br></code></pre></td></tr></table></figure>
<p><strong>å¤„ç†å™¨é‡æ’åºç¤ºä¾‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æºä»£ç </span><br>x = <span class="hljs-number">1</span>;    <span class="hljs-comment">// A</span><br>y = <span class="hljs-number">1</span>;    <span class="hljs-comment">// B</span><br>r1 = y;   <span class="hljs-comment">// C</span><br>r2 = x;   <span class="hljs-comment">// D</span><br><br><span class="hljs-comment">// å¤„ç†å™¨å¯èƒ½ä¹±åºæ‰§è¡Œä¸ºï¼š</span><br>x = <span class="hljs-number">1</span>;    <span class="hljs-comment">// A</span><br>r1 = y;   <span class="hljs-comment">// Cï¼ˆyå¯èƒ½è¿˜æ˜¯æ—§å€¼ï¼‰</span><br>y = <span class="hljs-number">1</span>;    <span class="hljs-comment">// B</span><br>r2 = x;   <span class="hljs-comment">// D</span><br></code></pre></td></tr></table></figure>
<p><strong>å¤šçº¿ç¨‹ç¯å¢ƒçš„é—®é¢˜</strong>ï¼š</p>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œé‡æ’åºä¼šå¯¼è‡´<strong>ä¸å¯é¢„æµ‹çš„æ‰§è¡Œç»“æœ</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// çº¿ç¨‹A</span><br>x = <span class="hljs-number">1</span>;          <span class="hljs-comment">// A</span><br>flag = <span class="hljs-literal">true</span>;    <span class="hljs-comment">// B</span><br><br><span class="hljs-comment">// çº¿ç¨‹B</span><br><span class="hljs-keyword">while</span> (!flag);  <span class="hljs-comment">// C</span><br>print(x);       <span class="hljs-comment">// D</span><br><br><span class="hljs-comment">// å¯èƒ½çš„é‡æ’åºï¼šçº¿ç¨‹Aä¸­ B è¢«é‡æ’åºåˆ° A ä¹‹å‰</span><br><span class="hljs-comment">// ç»“æœï¼šçº¿ç¨‹Bçœ‹åˆ° flag=trueï¼Œä½† x=0</span><br></code></pre></td></tr></table></figure>
<h4 id="2-3-4-é‡æ’åºçš„ä»£ä»·ä¸æ”¶ç›Š">2.3.4 é‡æ’åºçš„ä»£ä»·ä¸æ”¶ç›Š</h4>
<table>
<thead>
<tr>
<th>æ”¶ç›Š</th>
<th>ä»£ä»·</th>
</tr>
</thead>
<tbody>
<tr>
<td>æå‡å•çº¿ç¨‹æ€§èƒ½ 10%-30%</td>
<td>å¤šçº¿ç¨‹ä¸‹éœ€è¦åŒæ­¥æœºåˆ¶</td>
</tr>
<tr>
<td>æ›´å¥½çš„æµæ°´çº¿åˆ©ç”¨ç‡</td>
<td>å¢åŠ ç¼–ç¨‹å¤æ‚åº¦</td>
</tr>
<tr>
<td>å‡å°‘ç¼“å­˜æœªå‘½ä¸­</td>
<td>éœ€è¦ç†è§£ happens-before è§„åˆ™</td>
</tr>
</tbody>
</table>
<h4 id="2-3-5-jmm-çš„åº”å¯¹ï¼šå†…å­˜å±éšœ">2.3.5 JMM çš„åº”å¯¹ï¼šå†…å­˜å±éšœ</h4>
<p>JMM é€šè¿‡æ’å…¥**å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰**æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„é‡æ’åºï¼š</p>
<table>
<thead>
<tr>
<th>å±éšœç±»å‹</th>
<th>ç¦æ­¢çš„é‡æ’åº</th>
<th>å…¸å‹ä½¿ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>LoadLoad</td>
<td>Load1; LoadLoad; Load2 â†’ ç¦æ­¢ Load1 å’Œ Load2 é‡æ’</td>
<td>volatile è¯»</td>
</tr>
<tr>
<td>StoreStore</td>
<td>Store1; StoreStore; Store2 â†’ ç¦æ­¢ Store1 å’Œ Store2 é‡æ’</td>
<td>volatile å†™</td>
</tr>
<tr>
<td>LoadStore</td>
<td>Load1; LoadStore; Store2 â†’ ç¦æ­¢ Load1 å’Œ Store2 é‡æ’</td>
<td>synchronized</td>
</tr>
<tr>
<td>StoreLoad</td>
<td>Store1; StoreLoad; Load2 â†’ ç¦æ­¢ Store1 å’Œ Load2 é‡æ’</td>
<td>volatile å†™ï¼ˆå¼€é”€æœ€å¤§ï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>æ ¸å¿ƒæ´å¯Ÿ</strong>ï¼šæŒ‡ä»¤é‡æ’åºæ˜¯ç³»ç»Ÿ&quot;è‡ªç§&quot;çš„ä¼˜åŒ–â€”â€”åªè€ƒè™‘è‡ªèº«çš„æ‰§è¡Œæ•ˆç‡ï¼Œä¸é¡¾åŠå…¶ä»–çº¿ç¨‹çš„è§‚æµ‹ã€‚JMM é€šè¿‡ happens-before è§„åˆ™ä¸ºè¿™ç§&quot;è‡ªç§&quot;è¡Œä¸ºåˆ’å®šäº†è¾¹ç•Œã€‚</p>
<hr>
<h2 id="ä¸‰-happens-before-å…³ç³»">ä¸‰ã€happens-before å…³ç³»</h2>
<h3 id="3-1-ä»€ä¹ˆæ˜¯-happens-before">3.1 ä»€ä¹ˆæ˜¯ happens-before</h3>
<p>happens-before æ˜¯ JMM å®šä¹‰çš„ååºå…³ç³»ï¼ˆJLS Â§17.4.5ï¼‰ã€‚è‹¥æ“ä½œ A happens-before æ“ä½œ Bï¼Œåˆ™ A çš„ç»“æœå¯¹ B å¯è§ï¼Œä¸” A åœ¨ B ä¹‹å‰æ‰§è¡Œã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šhappens-before ä¸ç­‰äºæ—¶é—´ä¸Šçš„å…ˆåï¼Œè€Œæ˜¯æŒ‡<strong>å¯è§æ€§ä¿è¯</strong>ã€‚å¦‚æœ A ä¸åœ¨ B çš„ happens-before é“¾ä¸­ï¼Œå³ä½¿ A å®é™…å…ˆæ‰§è¡Œï¼ŒB ä¹Ÿå¯èƒ½çœ‹ä¸åˆ° A çš„ç»“æœã€‚</p>
<h3 id="3-2-happens-before-çš„å…«æ¡è§„åˆ™">3.2 happens-before çš„å…«æ¡è§„åˆ™</h3>
<table>
<thead>
<tr>
<th>è§„åˆ™</th>
<th>å†…å®¹</th>
<th>JLS å¼•ç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç¨‹åºæ¬¡åºè§„åˆ™</strong></td>
<td>å•çº¿ç¨‹å†…ï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œ happens-before åé¢çš„æ“ä½œ</td>
<td>Â§17.4.5</td>
</tr>
<tr>
<td><strong>ç›‘è§†å™¨é”å®šè§„åˆ™</strong></td>
<td>unlock æ“ä½œ happens-before åé¢å¯¹åŒä¸€é”çš„ lock æ“ä½œ</td>
<td>Â§17.4.5</td>
</tr>
<tr>
<td><strong>volatile è§„åˆ™</strong></td>
<td>volatile å†™æ“ä½œ happens-before åé¢å¯¹è¯¥å˜é‡çš„è¯»æ“ä½œ</td>
<td>Â§17.4.5</td>
</tr>
<tr>
<td><strong>çº¿ç¨‹å¯åŠ¨è§„åˆ™</strong></td>
<td>Thread.start() happens-before çº¿ç¨‹å†…çš„æ¯ä¸ªåŠ¨ä½œ</td>
<td>Â§17.4.5</td>
</tr>
<tr>
<td><strong>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™</strong></td>
<td>çº¿ç¨‹å†…æ‰€æœ‰æ“ä½œ happens-before çº¿ç¨‹ç»ˆæ­¢æ£€æµ‹</td>
<td>Â§17.4.5</td>
</tr>
<tr>
<td><strong>çº¿ç¨‹ä¸­æ–­è§„åˆ™</strong></td>
<td>interrupt() è°ƒç”¨ happens-before è¢«ä¸­æ–­çº¿ç¨‹æ£€æµ‹åˆ°ä¸­æ–­</td>
<td>Â§17.4.5</td>
</tr>
<tr>
<td><strong>å¯¹è±¡ç»ˆç»“è§„åˆ™</strong></td>
<td>æ„é€ å‡½æ•°ç»“æŸ happens-before finalize() å¼€å§‹</td>
<td>Â§17.4.5</td>
</tr>
<tr>
<td><strong>ä¼ é€’æ€§</strong></td>
<td>A happens-before B ä¸” B happens-before Cï¼Œåˆ™ A happens-before C</td>
<td>Â§17.4.5</td>
</tr>
</tbody>
</table>
<h3 id="3-3-æ¨å¯¼ç¤ºä¾‹">3.3 æ¨å¯¼ç¤ºä¾‹</h3>
<p><strong>ç¤ºä¾‹ 1ï¼šsynchronized ä¿è¯å¯è§æ€§</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (lock) &#123;<br>    x = <span class="hljs-number">1</span>;    <span class="hljs-comment">// æ“ä½œAï¼šassign â†’ store â†’ write</span><br>&#125;             <span class="hljs-comment">// æ“ä½œBï¼šunlock</span><br><br><span class="hljs-comment">// å¦ä¸€ä¸ªçº¿ç¨‹</span><br><span class="hljs-keyword">synchronized</span> (lock) &#123;  <span class="hljs-comment">// æ“ä½œCï¼šlock</span><br>    print(x);          <span class="hljs-comment">// æ“ä½œDï¼šread x</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ¨å¯¼é“¾ï¼š</p>
<ul>
<li>A happens-before Bï¼ˆç¨‹åºæ¬¡åºè§„åˆ™ï¼‰</li>
<li>B happens-before Cï¼ˆç›‘è§†å™¨é”å®šè§„åˆ™ï¼šunlock happens-before åç»­ lockï¼‰</li>
<li>C happens-before Dï¼ˆç¨‹åºæ¬¡åºè§„åˆ™ï¼‰</li>
<li>å› æ­¤ A happens-before Dï¼ˆä¼ é€’æ€§ï¼‰ï¼Œçº¿ç¨‹2 èƒ½çœ‹åˆ° x=1</li>
</ul>
<p><strong>ç¤ºä¾‹ 2ï¼švolatile çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// çº¿ç¨‹A</span><br>value = <span class="hljs-number">42</span>;           <span class="hljs-comment">// A</span><br>flag = <span class="hljs-literal">true</span>;          <span class="hljs-comment">// B (volatileå†™)</span><br><br><span class="hljs-comment">// çº¿ç¨‹B</span><br><span class="hljs-keyword">while</span> (!flag);        <span class="hljs-comment">// C (volatileè¯»)</span><br>print(value);         <span class="hljs-comment">// D</span><br></code></pre></td></tr></table></figure>
<p>æ¨å¯¼é“¾ï¼š</p>
<ul>
<li>A happens-before Bï¼ˆç¨‹åºæ¬¡åºè§„åˆ™ï¼‰</li>
<li>B happens-before Cï¼ˆvolatile è§„åˆ™ï¼‰</li>
<li>C happens-before Dï¼ˆç¨‹åºæ¬¡åºè§„åˆ™ï¼‰</li>
<li>å› æ­¤ A happens-before Dï¼Œçº¿ç¨‹B èƒ½çœ‹åˆ° value=42</li>
</ul>
<hr>
<h2 id="å››-ä¸‰å¤§ç‰¹æ€§ä¿éšœ">å››ã€ä¸‰å¤§ç‰¹æ€§ä¿éšœ</h2>
<h3 id="4-1-åŸå­æ€§-atomicity">4.1 åŸå­æ€§ï¼ˆAtomicityï¼‰</h3>
<p>JMM ä¿è¯åŸºæœ¬ç±»å‹çš„è¯»å†™æ“ä½œæ˜¯åŸå­çš„ï¼ˆlong/double åœ¨æŸäº›å¹³å°å¯èƒ½éåŸå­ï¼Œä½† JVM å®ç°é€šå¸¸ä¿è¯ï¼‰ã€‚</p>
<p><strong>åŸå­æ“ä½œç±»å‹</strong>ï¼š</p>
<ul>
<li>readã€loadã€useã€assignã€storeã€writeï¼ˆå¯¹ 32 ä½åŠä»¥ä¸‹ç±»å‹ï¼‰</li>
<li>lockã€unlock</li>
</ul>
<p><strong>éåŸå­åœºæ™¯</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// i++ ä¸æ˜¯åŸå­æ“ä½œ</span><br><span class="hljs-comment">// å­—èŠ‚ç å±‚é¢åˆ†è§£ä¸ºï¼š</span><br><span class="hljs-comment">//   getfield i      // read + load</span><br><span class="hljs-comment">//   iconst_1        </span><br><span class="hljs-comment">//   iadd            // use + assignï¼ˆè¿ç®—ï¼‰</span><br><span class="hljs-comment">//   putfield i      // store + write</span><br><br><span class="hljs-comment">// 64ä½çš„ long/double åœ¨é64ä½JVMä¸Šå¯èƒ½åˆ†ä¸¤æ¬¡è¯»å–</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> counter;  <span class="hljs-comment">// ç”¨ volatile ä¿è¯åŸå­æ€§</span><br></code></pre></td></tr></table></figure>
<h3 id="4-2-å¯è§æ€§-visibility">4.2 å¯è§æ€§ï¼ˆVisibilityï¼‰</h3>
<p>ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹åˆ°è¿™ä¸ªä¿®æ”¹ã€‚</p>
<p><strong>ä¿è¯å¯è§æ€§çš„æ–¹å¼</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>æœºåˆ¶</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>volatile</code></td>
<td>æ¯æ¬¡å†™ç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼Œæ¯æ¬¡è¯»ä»ä¸»å†…å­˜åˆ·æ–°</td>
</tr>
<tr>
<td><code>synchronized</code></td>
<td>unlock æ—¶ flush å·¥ä½œå†…å­˜åˆ°ä¸»å†…å­˜ï¼›lock æ—¶æ¸…ç©ºå·¥ä½œå†…å­˜å¹¶é‡æ–°åŠ è½½</td>
</tr>
<tr>
<td><code>final</code></td>
<td>æ­£ç¡®æ„é€ çš„å¯¹è±¡ï¼Œå…¶ final å­—æ®µå¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ï¼ˆæ— é¢å¤–åŒæ­¥æˆæœ¬ï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>volatile çš„å®ç°ç»†èŠ‚</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">shared</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">writer</span><span class="hljs-params">()</span> &#123;<br>    shared = <span class="hljs-number">1</span>;    <span class="hljs-comment">// store + write åˆ°ä¸»å†…å­˜ï¼Œå¹¶æ’å…¥å†…å­˜å±éšœ</span><br>&#125;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">local</span> <span class="hljs-operator">=</span> shared;  <span class="hljs-comment">// read + load ä»ä¸»å†…å­˜ï¼Œä½¿æœ¬åœ°ç¼“å­˜å¤±æ•ˆ</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>volatile å†™æ“ä½œåœ¨ x86 å¹³å°ä¸Šå¯¹åº” <code>lock addl $0x0</code> æŒ‡ä»¤ï¼Œèµ·åˆ°ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ol>
<li>å°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œå†™å›å†…å­˜</li>
<li>ä½¿å…¶ä»–å¤„ç†å™¨çš„è¯¥ç¼“å­˜è¡Œæ— æ•ˆ</li>
</ol>
<h3 id="4-3-æœ‰åºæ€§-ordering">4.3 æœ‰åºæ€§ï¼ˆOrderingï¼‰</h3>
<p>ç¦æ­¢ç‰¹å®šç±»å‹çš„æŒ‡ä»¤é‡æ’åºï¼Œç¡®ä¿ç¨‹åºçš„æ‰§è¡Œé¡ºåºç¬¦åˆé¢„æœŸã€‚</p>
<p><strong>å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰ç±»å‹</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>å±éšœç±»å‹</th>
<th>ç¤ºä¾‹æŒ‡ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>LoadLoad</td>
<td>Load1; LoadLoad; Load2</td>
<td>ç¦æ­¢ Load1 å’Œ Load2 é‡æ’åº</td>
</tr>
<tr>
<td>StoreStore</td>
<td>Store1; StoreStore; Store2</td>
<td>ç¦æ­¢ Store1 å’Œ Store2 é‡æ’åº</td>
</tr>
<tr>
<td>LoadStore</td>
<td>Load1; LoadStore; Store2</td>
<td>ç¦æ­¢ Load1 å’Œ Store2 é‡æ’åº</td>
</tr>
<tr>
<td>StoreLoad</td>
<td>Store1; StoreLoad; Load2</td>
<td>ç¦æ­¢ Store1 å’Œ Load2 é‡æ’åºï¼ˆå¼€é”€æœ€å¤§ï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>volatile çš„å†…å­˜å±éšœæ’å…¥ç­–ç•¥</strong>ï¼ˆJSR-133 å¢å¼ºåï¼‰ï¼š</p>
<ul>
<li>volatile å†™ï¼šå‰é¢æ’å…¥ StoreStoreï¼Œåé¢æ’å…¥ StoreLoad</li>
<li>volatile è¯»ï¼šåé¢æ’å…¥ LoadLoad å’Œ LoadStore</li>
</ul>
<p>è¿™ç¡®ä¿äº†ï¼š</p>
<ul>
<li>volatile å†™ä¹‹å‰çš„å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°åé¢</li>
<li>volatile è¯»ä¹‹åçš„è¯»/å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°å‰é¢</li>
</ul>
<hr>
<h2 id="äº”-å¯¹è±¡å†…å­˜å¸ƒå±€ä¸æŒ‡é’ˆå‹ç¼©">äº”ã€å¯¹è±¡å†…å­˜å¸ƒå±€ä¸æŒ‡é’ˆå‹ç¼©</h2>
<h3 id="5-1-å¯¹è±¡çš„å†…å­˜ç»“æ„">5.1 å¯¹è±¡çš„å†…å­˜ç»“æ„</h3>
<p>HotSpot JVM ä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚     Mark Word   â”‚  â† <span class="hljs-number">8</span> <span class="hljs-keyword">bytesï¼ˆ64ä½ </span><span class="hljs-keyword">JVMï¼‰</span><br><span class="hljs-keyword"></span>â”‚   (å¯¹è±¡å¤´ä¿¡æ¯)   â”‚<br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚   Class Pointer â”‚  â† <span class="hljs-number">4</span> <span class="hljs-keyword">bytesï¼ˆå‹ç¼©æŒ‡é’ˆï¼‰æˆ– </span><span class="hljs-number">8</span> <span class="hljs-keyword">bytes</span><br><span class="hljs-keyword"></span>â”‚   (æŒ‡å‘ç±»å…ƒæ•°æ®) â”‚<br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚    <span class="hljs-keyword">Instance </span>Dataâ”‚  â† å®ä¾‹å­—æ®µ<br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚    Padding      â”‚  â† <span class="hljs-number">8</span> å­—èŠ‚å¯¹é½å¡«å……<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br></code></pre></td></tr></table></figure>
<h3 id="5-2-mark-word-çš„ç»“æ„">5.2 Mark Word çš„ç»“æ„</h3>
<p>Mark Word æ˜¯ä¸€ä¸ªåŠ¨æ€æ•°æ®ç»“æ„ï¼Œæ ¹æ®å¯¹è±¡çŠ¶æ€å¤ç”¨å­˜å‚¨ç©ºé—´ï¼š</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">æ— é”çŠ¶æ€ï¼š<br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚      identity_hash   â”‚  age    â”‚ <span class="hljs-keyword">biased_lock_pattern </span>(<span class="hljs-number">001</span>) â”‚<br>â”‚       (<span class="hljs-number">25</span> <span class="hljs-keyword">bits) </span>     â”‚(<span class="hljs-number">4</span> <span class="hljs-keyword">bits) </span>â”‚  (<span class="hljs-number">3</span> <span class="hljs-keyword">bits) </span>                â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br><br>åå‘é”çŠ¶æ€ï¼š<br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚    thread_id     â”‚  epoch  â”‚   age    â”‚ <span class="hljs-keyword">biased_lock_pattern </span>(<span class="hljs-number">101</span>) â”‚<br>â”‚    (<span class="hljs-number">54</span> <span class="hljs-keyword">bits) </span>    â”‚(<span class="hljs-number">2</span> <span class="hljs-keyword">bits) </span>â”‚(<span class="hljs-number">4</span> <span class="hljs-keyword">bits) </span> â”‚  (<span class="hljs-number">3</span> <span class="hljs-keyword">bits) </span>                â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br><br>è½»é‡çº§é”çŠ¶æ€ï¼šæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆï¼ˆ<span class="hljs-number">62</span> <span class="hljs-keyword">bitsï¼‰+ </span>æ ‡å¿—ä½ï¼ˆ<span class="hljs-number">00</span>ï¼‰<br><br>é‡é‡çº§é”çŠ¶æ€ï¼šæŒ‡å‘äº’æ–¥é‡ï¼ˆMonitorï¼‰çš„æŒ‡é’ˆï¼ˆ<span class="hljs-number">62</span> <span class="hljs-keyword">bitsï¼‰+ </span>æ ‡å¿—ä½ï¼ˆ<span class="hljs-number">10</span>ï¼‰<br></code></pre></td></tr></table></figure>
<h3 id="5-3-æŒ‡é’ˆå‹ç¼©-compressed-oops">5.3 æŒ‡é’ˆå‹ç¼©ï¼ˆCompressed OOPsï¼‰</h3>
<p>64 ä½ JVM é»˜è®¤å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼ˆ<code>-XX:+UseCompressedOops</code>ï¼‰ï¼Œå°† 64 ä½å¼•ç”¨å‹ç¼©ä¸º 32 ä½ï¼š</p>
<ul>
<li>å †å†…å­˜ &lt; 4GBï¼šç›´æ¥ä½ç§»ï¼Œæ— éœ€è§£ç </li>
<li>4GB â‰¤ å †å†…å­˜ &lt; 32GBï¼šåŸºå€ + åç§»ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰</li>
<li>â‰¥ 32GBï¼šæ— æ³•å‹ç¼©ï¼Œå›é€€åˆ° 64 ä½æŒ‡é’ˆ</li>
</ul>
<p>è®¡ç®—å…¬å¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">è§£ç ååœ°å€ = å‹ç¼©å€¼ &lt;&lt; <span class="hljs-string">3 + heap_base</span><br></code></pre></td></tr></table></figure>
<p>å¯ç”¨å‹ç¼©æŒ‡é’ˆåï¼Œå¯¹è±¡å¤´çš„ Class Pointer ä» 8 å­—èŠ‚é™ä¸º 4 å­—èŠ‚ï¼Œæ˜¾è‘—é™ä½å†…å­˜å ç”¨ã€‚</p>
<hr>
<h2 id="å…­-ğŸ”‘-æ¨¡å¼æç‚¼">å…­ã€ğŸ”‘ æ¨¡å¼æç‚¼</h2>
<h3 id="æ¨¡å¼ä¸€ï¼šå†™åˆ·è¯»æ¸…">æ¨¡å¼ä¸€ï¼šå†™åˆ·è¯»æ¸…</h3>
<p><strong>å…¬å¼</strong>ï¼š<code>Assign â†’ Store â†’ Write (Flush) || Read â†’ Load â†’ Use (Refresh)</code></p>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>Flush è§¦å‘ç‚¹</th>
<th>Refresh è§¦å‘ç‚¹</th>
<th>æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>volatile å†™</td>
<td>å†™åç«‹å³ store+write</td>
<td>-</td>
<td>å¯¹æ‰€æœ‰åç»­è¯»è€…å¯è§</td>
</tr>
<tr>
<td>synchronized è§£é”</td>
<td>unlock å‰ flush</td>
<td>lock æ—¶ refresh</td>
<td>ä¸´ç•ŒåŒºå˜æ›´å¯¹åç»­è·å–è€…å¯è§</td>
</tr>
<tr>
<td>çº¿ç¨‹ç»ˆæ­¢</td>
<td>çº¿ç¨‹ç»“æŸ</td>
<td>join() è¿”å›</td>
<td>çº¿ç¨‹å†…æ‰€æœ‰æ“ä½œå¯¹ç­‰å¾…è€…å¯è§</td>
</tr>
</tbody>
</table>
<p><strong>æ ¸å¿ƒæ´å¯Ÿ</strong>ï¼šå¯è§æ€§é—®é¢˜çš„æœ¬è´¨æ˜¯&quot;ä½•æ—¶æŠŠå·¥ä½œå†…å­˜çš„è„é¡µåˆ·åˆ°ä¸»å†…å­˜&quot;ï¼Œä»¥åŠ&quot;ä½•æ—¶åºŸå¼ƒæœ¬åœ°ç¼“å­˜é‡æ–°åŠ è½½&quot;ã€‚happens-before è§„åˆ™å°±æ˜¯å®šä¹‰è¿™ä¸¤ä¸ªåŠ¨ä½œçš„è§¦å‘æ—¶æœºã€‚</p>
<h3 id="æ¨¡å¼äºŒï¼šé¡ºåºé”">æ¨¡å¼äºŒï¼šé¡ºåºé”</h3>
<p><strong>å…¬å¼</strong>ï¼š<code>Lock(A) â†’ { Critical Section } â†’ Unlock(A)</code> ä¸²è¡ŒåŒ–æ‰€æœ‰ä¸´ç•ŒåŒº</p>
<blockquote>
<p><strong>[æ¦‚å¿µè¾¨æ]</strong> å…³äºä¸´ç•ŒåŒºã€åŒæ­¥å—ä¸é”ä¿æŠ¤åŒºåŸŸçš„è¯¦ç»†è¾¨æï¼Œè¯·å‚é˜… <a href="https://magicliang.github.io/2026/01/19/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/">ã€Šçº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–ã€‹</a> ä¸€æ–‡ä¸­çš„&quot;ä¸´ç•ŒåŒºã€åŒæ­¥å—ä¸é”ä¿æŠ¤åŒºåŸŸ&quot;ç« èŠ‚ã€‚</p>
</blockquote>
<p><strong>å®ç°æœºåˆ¶</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// synchronized çš„å­—èŠ‚ç ï¼šmonitorenter + monitorexit</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span>;<br>  descriptor: ()V<br>  flags: ACC_PUBLIC, ACC_SYNCHRONIZED<br>  <span class="hljs-comment">// æ–¹æ³•çº§åˆ«çš„ synchronized åœ¨å¸¸é‡æ± æ·»åŠ  ACC_SYNCHRONIZED æ ‡å¿—</span><br>  <span class="hljs-comment">// JVM è¿›å…¥/é€€å‡ºæ–¹æ³•æ—¶è‡ªåŠ¨è·å–/é‡Šæ”¾ monitor</span><br>  <br><span class="hljs-comment">// ä»£ç å—çš„ synchronized</span><br><span class="hljs-keyword">synchronized</span> (obj) &#123; &#125;<br>  <span class="hljs-comment">// ç¼–è¯‘ä¸ºï¼š</span><br>  <span class="hljs-comment">// 0: aload_1</span><br>  <span class="hljs-comment">// 1: dup</span><br>  <span class="hljs-comment">// 2: astore_2        // å°† obj å­˜å…¥å±€éƒ¨å˜é‡</span><br>  <span class="hljs-comment">// 3: monitorenter    // è·å–é”</span><br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-comment">// n: aload_2</span><br>  <span class="hljs-comment">// n+1: monitorexit   // é‡Šæ”¾é”ï¼ˆæ­£å¸¸è·¯å¾„ï¼‰</span><br>  <span class="hljs-comment">// n+2: goto ...</span><br>  <span class="hljs-comment">// n+x: astore_3</span><br>  <span class="hljs-comment">// n+x+1: aload_2</span><br>  <span class="hljs-comment">// n+x+2: monitorexit // é‡Šæ”¾é”ï¼ˆå¼‚å¸¸è·¯å¾„ï¼‰</span><br></code></pre></td></tr></table></figure>
<p><strong>å…³é”®è¦ç‚¹</strong></p>
<ul>
<li>é”å¯¹è±¡æ˜¯ monitor çš„è½½ä½“ï¼Œç©ºå¯¹è±¡ä¸èƒ½ä½œä¸ºé”</li>
<li>å¼‚å¸¸é€€å‡ºæ—¶ä»ä¿è¯ monitorexit æ‰§è¡Œï¼ˆtry-finally è¯­ä¹‰ï¼‰</li>
<li>é”å‡çº§è·¯å¾„ï¼šæ— é” â†’ åå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”</li>
</ul>
<h3 id="æ¨¡å¼ä¸‰ï¼šååºä¼ é€’">æ¨¡å¼ä¸‰ï¼šååºä¼ é€’</h3>
<p><strong>å…¬å¼</strong>ï¼š<code>A â‰º B âˆ§ B â‰º C â‡’ A â‰º C</code></p>
<p><strong>æ¨ç†é“¾æ„å»ºç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafePublication</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> x;<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> y;<br>    <br>    SafePublication() &#123;<br>        x = <span class="hljs-number">1</span>;              <span class="hljs-comment">// A</span><br>        y = <span class="hljs-number">1</span>;              <span class="hljs-comment">// B (volatileå†™ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ„é€ å‡½æ•°ç»“æŸå‰çš„æœ€ååŠ¨ä½œ)</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">reader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (y == <span class="hljs-number">1</span>) &#123;       <span class="hljs-comment">// C (volatileè¯»)</span><br>            <span class="hljs-keyword">assert</span> x == <span class="hljs-number">1</span>;  <span class="hljs-comment">// D - å¿…ç„¶æˆç«‹</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ¨å¯¼ï¼š</p>
<ul>
<li>A happens-before Bï¼ˆç¨‹åºæ¬¡åºï¼‰</li>
<li>B happens-before Cï¼ˆvolatileè§„åˆ™ï¼‰</li>
<li>æ„é€ å‡½æ•°ç»“æŸ happens-before finalizeï¼ˆå¯¹è±¡ç»ˆç»“è§„åˆ™ï¼Œè¿™é‡Œéšå«æ„é€ å®Œæˆ happens-before ä»»ä½•å¼•ç”¨è·å–ï¼‰</li>
<li>å› æ­¤ A happens-before Cï¼Œè¿›è€Œ A happens-before D</li>
</ul>
<p><strong>å®è·µä»·å€¼</strong>ï¼šæ­£ç¡®ä½¿ç”¨ volatile/final/synchronized å»ºç«‹ happens-before é“¾ï¼Œå¯ä»¥åœ¨æ— é”çš„æƒ…å†µä¸‹å®ç°çº¿ç¨‹å®‰å…¨çš„å¯è§æ€§ä¿éšœã€‚</p>
<hr>
<h2 id="ä¸ƒ-ç”Ÿäº§ç¯å¢ƒå®è·µè¦ç‚¹">ä¸ƒã€ç”Ÿäº§ç¯å¢ƒå®è·µè¦ç‚¹</h2>
<h3 id="7-1-volatile-çš„ä½¿ç”¨åŸåˆ™">7.1 volatile çš„ä½¿ç”¨åŸåˆ™</h3>
<p><strong>é€‚åˆåœºæ™¯</strong></p>
<ul>
<li>çŠ¶æ€æ ‡å¿—ä½ï¼ˆå¦‚ <code>boolean running = true</code>ï¼‰</li>
<li>å•æ¬¡å†™å¤šæ¬¡è¯»çš„å…±äº«å˜é‡</li>
<li>é…åˆ synchronized å®ç°ç»†ç²’åº¦é”ï¼ˆå¦‚ StampedLock çš„ä¹è§‚è¯»ï¼‰</li>
</ul>
<p><strong>é¿å…åœºæ™¯</strong></p>
<ul>
<li>å¤åˆæ“ä½œï¼ˆi++ã€æ£€æŸ¥å†æ‰§è¡Œï¼‰</li>
<li>å¤šä¸ª volatile å˜é‡é—´çš„ä¾èµ–ï¼ˆä¸èƒ½ä¿è¯æ•´ä½“åŸå­æ€§ï¼‰</li>
</ul>
<h3 id="7-2-åŒé‡æ£€æŸ¥é”å®šçš„æ­£ç¡®å®ç°">7.2 åŒé‡æ£€æŸ¥é”å®šçš„æ­£ç¡®å®ç°</h3>
<p>Java 5 ä¹‹å‰çš„ DCL æ˜¯é”™çš„ï¼Œå› ä¸º volatile ä¸èƒ½ä¿è¯æœ‰åºæ€§ã€‚JSR-133 ä¿®å¤åï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance;  <span class="hljs-comment">// å¿…é¡» volatile</span><br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;                    <span class="hljs-comment">// ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼ˆæ— é”ï¼‰</span><br>            <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;            <span class="hljs-comment">// ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆæœ‰é”ï¼‰</span><br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();    <span class="hljs-comment">// åˆ›å»ºåˆ†ä¸ºä¸‰æ­¥ï¼š</span><br>                    <span class="hljs-comment">// 1. åˆ†é…å†…å­˜</span><br>                    <span class="hljs-comment">// 2. åˆå§‹åŒ–å¯¹è±¡</span><br>                    <span class="hljs-comment">// 3. å°†å¼•ç”¨æŒ‡å‘å†…å­˜åœ°å€</span><br>                    <span class="hljs-comment">// volatile ç¦æ­¢ 2-3 é‡æ’åºï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹çœ‹åˆ°å®Œæ•´åˆå§‹åŒ–</span><br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸ä½¿ç”¨ volatile çš„é£é™©ï¼šçº¿ç¨‹A æ‰§è¡Œåˆ°ç¬¬3æ­¥ï¼ˆå¼•ç”¨å·²èµ‹å€¼ä½†æœªåˆå§‹åŒ–ï¼‰ï¼Œçº¿ç¨‹B åˆ¤æ–­ <code>instance != null</code> ç›´æ¥è¿”å›æœªåˆå§‹åŒ–å¯¹è±¡ã€‚</p>
<h3 id="7-3-ä¼ªå…±äº«-false-sharing-é—®é¢˜">7.3 ä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰é—®é¢˜</h3>
<p>å½“ä¸¤ä¸ªç‹¬ç«‹å˜é‡ä½äºåŒä¸€ç¼“å­˜è¡Œï¼ˆé€šå¸¸ 64 å­—èŠ‚ï¼‰æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å˜é‡Aä¼šå¯¼è‡´å¦ä¸€ä¸ªçº¿ç¨‹çš„å˜é‡Bç¼“å­˜å¤±æ•ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// é”™è¯¯ç¤ºèŒƒ</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> countA;  <span class="hljs-comment">// å¯èƒ½å’Œ countB åœ¨åŒä¸€ç¼“å­˜è¡Œ</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> countB;<br>&#125;<br><br><span class="hljs-comment">// æ­£ç¡®åšæ³•ï¼šå¡«å……è‡³ç¼“å­˜è¡Œå¤§å°</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaddedCounter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> countA;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> p1, p2, p3, p4, p5, p6, p7;  <span class="hljs-comment">// 56 bytes padding</span><br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> countB;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Java 8 å¼•å…¥ <code>@Contended</code> æ³¨è§£è‡ªåŠ¨å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> &#123;<br>    <span class="hljs-meta">@Contended</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> countA;<br>    <br>    <span class="hljs-meta">@Contended</span>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> countB;<br>&#125;<br><span class="hljs-comment">// ç¼–è¯‘é€‰é¡¹ï¼š-XX:-RestrictContended</span><br></code></pre></td></tr></table></figure>
<h3 id="7-4-ç›‘æ§ä¸è¯Šæ–­">7.4 ç›‘æ§ä¸è¯Šæ–­</h3>
<p><strong>JVM å‚æ•°</strong></p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-XX:+PrintAssembly</code></td>
<td>æ‰“å° JIT ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ï¼ˆéœ€ hsdisï¼‰</td>
</tr>
<tr>
<td><code>-XX:CompileCommand=print,*ClassName.methodName</code></td>
<td>æŒ‡å®šæ–¹æ³•æ‰“å°æ±‡ç¼–</td>
</tr>
<tr>
<td><code>-XX:+UnlockDiagnosticVMOptions -XX:+LogCompilation</code></td>
<td>è®°å½•ç¼–è¯‘æ—¥å¿—</td>
</tr>
</tbody>
</table>
<p><strong>jolï¼ˆJava Object Layoutï¼‰å·¥å…·</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(ClassLayout.parseInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>()).toPrintable());<br><br><span class="hljs-comment">// è¾“å‡ºç¤ºä¾‹ï¼š</span><br>java.lang.Object object internals:<br> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE<br>      <span class="hljs-number">0</span>     <span class="hljs-number">4</span>        (object header)                           <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>      <span class="hljs-number">4</span>     <span class="hljs-number">4</span>        (object header)                           <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>      <span class="hljs-number">8</span>     <span class="hljs-number">4</span>        (object header)                           e5 <span class="hljs-number">01</span> <span class="hljs-number">00</span> f8<br>     <span class="hljs-number">12</span>     <span class="hljs-number">4</span>        (loss due to the next object alignment)<br>Instance size: <span class="hljs-number">16</span> bytes<br>Space losses: <span class="hljs-number">0</span> bytes internal + <span class="hljs-number">4</span> <span class="hljs-type">bytes</span> <span class="hljs-variable">external</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> bytes total<br></code></pre></td></tr></table></figure>
<hr>
<h2 id="å…«-æ¨¡å¼é€ŸæŸ¥è¡¨">å…«ã€æ¨¡å¼é€ŸæŸ¥è¡¨</h2>
<table>
<thead>
<tr>
<th>é‡åˆ°çš„é—®é¢˜</th>
<th>åº”ç”¨çš„æ¨¡å¼</th>
<th>å…·ä½“æ–¹æ¡ˆ</th>
<th>å…³é”®æ³¨æ„ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªä¸å¯è§</td>
<td>å†™åˆ·è¯»æ¸…</td>
<td>volatile / synchronized</td>
<td>volatile åªä¿è¯å•æ¬¡è¯»å†™å¯è§</td>
</tr>
<tr>
<td>å¤åˆæ“ä½œç»“æœé”™ä¹±</td>
<td>é¡ºåºé”</td>
<td>synchronized / Lock</td>
<td>é”ç²’åº¦å°½å¯èƒ½å°</td>
</tr>
<tr>
<td>å¤šå˜é‡é—´å¯è§æ€§æ¨ç†</td>
<td>ååºä¼ é€’</td>
<td>å»ºç«‹ happens-before é“¾</td>
<td>ç¡®ä¿é“¾æ¡å®Œæ•´ï¼Œæ— æ–­ç‚¹</td>
</tr>
<tr>
<td>å¯¹è±¡å®‰å…¨å‘å¸ƒ</td>
<td>ä¸å¯å˜å®‰å…¨</td>
<td>final + æ­£ç¡®æ„é€ </td>
<td>this å¼•ç”¨ä¸è¦åœ¨æ„é€ å‡½æ•°é€¸å‡º</td>
</tr>
<tr>
<td>é«˜å¹¶å‘ä¸‹é”ç«äº‰æ¿€çƒˆ</td>
<td>é”ä¼˜åŒ–</td>
<td>åå‘é” â†’ è½»é‡çº§é” â†’ åˆ†æ®µé”</td>
<td>JDK 15+ é»˜è®¤ç¦ç”¨åå‘é”</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html#jls-17.4">Java Language Specification, Chapter 17.4</a> - JMM å®˜æ–¹è§„èŒƒ</li>
<li><a target="_blank" rel="noopener" href="https://www.cs.umd.edu/~pugh/java/memoryModel/jsr133.pdf">JSR-133: Java Memory Model and Thread Specification</a> - å†…å­˜æ¨¡å‹ä¿®è®¢æ–‡æ¡£</li>
<li>ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹Brian Goetz ç­‰è‘—</li>
<li><a target="_blank" rel="noopener" href="https://mechanical-sympathy.blogspot.com/2011/07/false-sharing.html">Mechanical Sympathy Blog - False Sharing</a></li>
</ol>
<h2 id="3-jvm-çš„å¯¹è±¡ä¿¡æ¯">3.JVM çš„å¯¹è±¡ä¿¡æ¯</h2>
<p>â€ƒâ€ƒJava Object é™¤äº†åŸºæœ¬çš„å†…å­˜è½®å»“ä»¥å¤–ï¼Œè¿˜æœ‰ï¼š</p>
<ol>
<li>Mark Wordï¼ˆå¯¹è±¡çš„ Hash Code çš„ç¼“å­˜å€¼ã€GCæ ‡å¿—ã€GCå¹´é¾„ã€åŒæ­¥é”ç­‰ä¿¡æ¯ï¼‰ã€‚</li>
<li>Klass Pointï¼ˆæŒ‡å‘å¯¹è±¡å…ƒæ•°æ®ä¿¡æ¯çš„æŒ‡é’ˆï¼ŒæŒ‡å‘ .class  çš„æŒ‡é’ˆå—ï¼Ÿä¸æ˜¯ï¼Œæ˜¯æŒ‡å‘æ–¹æ³•åŒºçš„ç±»å‹å…ƒæ•°æ®çš„æŒ‡é’ˆã€‚.Classæ–‡ä»¶å®é™…ä¸Šæ˜¯é‚£ä¸ªåŒºåŸŸçš„å¦ä¸€ä¸ªå…¥å£äº†ã€‚ï¼‰ã€‚</li>
<li>paddingã€‚å¦‚æœå¯¹è±¡æ˜¯8ä½å¯¹é½çš„ï¼ˆä¹Ÿå°±æ˜¯æœ€é•¿æ ‡é‡ç±»å‹å¯¹é½çš„ï¼‰ï¼Œåˆ™ä¸å­˜åœ¨paddingã€‚</li>
</ol>
<h2 id="4-å†…å­˜é—´-ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜-ç›¸äº’æ“ä½œ">4.å†…å­˜é—´ï¼ˆä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ï¼‰ç›¸äº’æ“ä½œ</h2>
<p>â€ƒâ€ƒJavaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼‰å®šä¹‰äº†å…«ç§å†…å­˜æ“ä½œï¼ˆè€Œä¸æ˜¯å­—èŠ‚ç ï¼‰ã€‚è™šæ‹Ÿæœºåœ¨æ˜¯ç°å®å¿…é¡»ä¿è¯æ¯ä¸€ç§æ“ä½œéƒ½æ˜¯åŸå­çš„ã€ä¸å¯å†åˆ†çš„ï¼ˆå¯¹äº double å’Œ long ç±»å‹çš„å˜é‡æ¥è¯´ï¼Œloadã€storeã€read å’Œ write æ“ä½œåœ¨æŸäº›å¹³å°ä¸Šå¯ä»¥ä¾‹å¤–ï¼‰ï¼š</p>
<ol>
<li>lock æŠŠä¸»å†…å­˜å˜é‡ä¸ºä¸€ä¸ªçº¿ç¨‹é”å®šèµ·æ¥ã€‚</li>
<li>unlock æŠŠä¸»å†…å­˜çš„å˜é‡è§£é”ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹æ‰èƒ½é”å®šã€‚</li>
<li>read æŠŠä¸€ä¸ªå˜é‡çš„å€¼ï¼Œä»ä¸»å†…å­˜è¯»åˆ°å·¥ä½œå†…å­˜é‡Œã€‚æ˜¯ load æŒ‡ä»¤çš„å‰ç½®åŠ¨ä½œã€‚</li>
<li>load æŠŠreadå‡ºæ¥çš„å˜é‡ï¼Œæ”¾åˆ°å·¥ä½œå†…å­˜çš„å‰¯æœ¬é‡Œã€‚</li>
<li>use æŠŠå·¥ä½œå†…å­˜çš„å€¼ä¼ ç»™å·¥ä½œæ‰§è¡Œå¼•æ“ã€‚</li>
<li>assign æŠŠæ‰§è¡Œå¼•æ“é‡Œå¾—åˆ°çš„å€¼ä¼ ç»™å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ã€‚<strong>å®ƒæ˜¯ä¸€ç§å·¥ä½œå†…å­˜çš„å±€éƒ¨å†™ã€‚</strong></li>
<li>store æŠŠå·¥ä½œå†…å­˜ä¸­çš„å˜é‡çš„å€¼ä¼ é€’ç»™ä¸»å†…å­˜ã€‚</li>
</ol>
<p>â€ƒâ€ƒå®é™…ä¸Šçš„æ‰§è¡Œé¡ºåºææ€•æ˜¯ read-&gt;load-&gt;use-&gt;assign-&gt;store-&gt; writeã€‚</p>
<p>â€ƒâ€ƒå¦‚æœè¦æŠŠä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜å¤åˆ¶åˆ°å·¥ä½œå†…å­˜ï¼Œé‚£å°±è¦æŒ‰é¡ºåºåœ°æ‰§è¡Œ read å’Œload æ“ä½œï¼Œå¦‚æœè¦æŠŠå˜é‡ä»å·¥ä½œå†…å­˜åŒä¸ä¼šä¸»å†…å­˜ï¼Œå°±è¦æ‰§è¡Œ store å’Œ write æ“ä½œã€‚ JMM åªè¦æ±‚ä¸Šè¿°ä¸¤ç±»æ“ä½œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ²¡æœ‰ä¿è¯å¿…é¡»æ˜¯è¿ç»­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ read å’Œ loadä¹‹é—´ã€store å’Œ write ä¹‹é—´æ˜¯å¯æ’å…¥å…¶ä»–æŒ‡ä»¤çš„ã€‚å¦‚å¯¹ä¸»å†…å­˜çš„å˜é‡ aã€b è¿›è¡Œè®¿é—®çš„æ—¶å€™ï¼Œå¯èƒ½å‡ºç° read aã€read bã€load bã€load a çš„æ“ä½œé¡ºåºã€‚</p>
<p>â€ƒâ€ƒé™¤æ­¤ä¹‹å¤–ï¼Œ JVM è¿˜è§„å®šäº†é¢å¤–çš„æŒ‡ä»¤æ‰§è¡Œçš„ååºè§„åˆ™(æ­£å¥½ä¹Ÿæœ‰å…«æ¡)ï¼š</p>
<ul>
<li>ä¸å…è®¸ read å’Œ loadã€store å’Œ write æ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œå³ä¸å…è®¸ä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜è¯»å–äº†ä½†å·¥ä½œå†…å­˜ä¸æ¥å—ï¼Œæˆ–è€…ä»å·¥ä½œå†…å­˜å‘èµ·äº†å†™å›ä½†å·¥ä½œå†…å­˜ä¸æ¥å—çš„æƒ…å†µã€‚</li>
<li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒçš„æœ€è¿‘çš„ assign æ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­å‘ç”Ÿäº†æ”¹å˜å¿…é¡»ï¼ˆæœ€ç»ˆï¼‰æŠŠè¯¥å˜åŒ–åŒæ­¥å›ä¸»å†…å­˜é‡Œå»ã€‚</li>
<li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»çº¿ç¨‹çš„å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚</li>
<li>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­â€œè¯ç”Ÿâ€ï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆload æˆ–è€… assignï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½ use å’Œ storeæ“ä½œä¹‹å‰ï¼Œå¿…é¡»ç»è¿‡ assign å’Œ load çš„æ“ä½œã€‚</li>
<li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å®ƒè¿›è¡Œ lock æ“ä½œï¼Œä¸” lock æ“ä½œå¯ä»¥è¢«åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå¤šæ¬¡ï¼ˆå¤šç§å¯é‡å…¥é”çš„åº•å±‚æœºåˆ¶å°±åœ¨è¿™é‡Œäº†ï¼‰ã€‚è€Œä¸”åªæœ‰æ‰§è¡Œç›¸åŒæ•°é‡çš„ unlock æ“ä½œï¼Œæ‰èƒ½å½»åº•è§£é”è¯¥å˜é‡ã€‚</li>
<li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œ lock æ“ä½œï¼Œä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ load å’Œ assign æ“ä½œã€‚<strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª flush åŠ ä¸Š reloadçš„è¿‡ç¨‹ã€‚</strong></li>
<li>å¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰è¢« lock é”ä½ï¼Œåˆ™ unlock éæ³•ï¼Œåªæœ‰æœ¬çº¿ç¨‹æ‰èƒ½unlockã€‚</li>
<li>å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œunlockæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠå˜é‡åŒæ­¥å›ä¸»å†…å­˜ä¸­ï¼ˆæ‰§è¡Œ store å’Œ write æ“ä½œï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå˜é‡è¢«çº¿ç¨‹é”ä½ä»¥åï¼Œä¸æ˜¯åœ¨ä¸»å†…å­˜ä¸Šå·¥ä½œï¼Œè€Œæ˜¯åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜é‡Œè¢«ä½¿ç”¨çš„ï¼Œ<strong>è¿™ä¹Ÿå°è¯äº†ä¸Šé¢çš„å…«ç§æŒ‡ä»¤ä¸­çš„ use å¿…é¡»åœ¨ load ä¹‹åå·¥ä½œï¼Œæ‰§è¡Œå¼•æ“å¿…é¡»ä½¿ç”¨ use çš„å°è±¡</strong>ã€‚</li>
</ul>
<h2 id="5-volatileå…³é”®å­—">5.volatileå…³é”®å­—</h2>
<p>â€ƒâ€ƒvolatile å…³é”®å­—å…·æœ‰å¯è§æ€§ï¼Œä¼šä½¿å¾—æ¯æ¬¡å†™æ“ä½œï¼Œéƒ½ä¼šå¯¼è‡´å…¨flush çš„å‡ºç°ï¼ˆassignå¿…ç„¶å¯¼è‡´ store å’Œ write å›ä¸»å†…å­˜ï¼‰ï¼Œè¯»æ“ä½œå¿…é¡»read + loadè‡³å·¥ä½œå†…å­˜ï¼Œ use åˆ°æ‰§è¡Œå¼•æ“ï¼ˆè€Œä¸èƒ½åªæ˜¯useä¸Šæ¬¡ç•™åœ¨å·¥ä½œå†…å­˜é‡Œçš„å€¼ï¼‰ï¼Œå¿…ç„¶æ€»æ˜¯å¾—åˆ°æœ€æ–°çš„å€¼ï¼Œä¸ç®¡ä¸­é—´æ˜¯å¦æœ‰ä¸ä¸€è‡´çš„æš‚æ—¶æƒ…å†µå‘ç”Ÿï¼Œè¯»çš„è¯­ä¹‰å¿…ç„¶æ˜¯ä¸€è‡´æ­£ç¡®çš„ã€‚è€Œå¦‚æœæ²¡æœ‰è¿™æ¡è¯­ä¹‰ï¼Œuseå¾—åˆ°çš„å€¼ï¼Œå¯èƒ½æ˜¯ä¹‹å‰ use å’Œ assign å¾—åˆ°çš„å€¼ã€‚</p>
<p>â€ƒâ€ƒæ³¨æ„ï¼Œå¦‚æœä½¿ç”¨å­—èŠ‚ç åˆ†æå¤šçº¿ç¨‹æ“ä½œï¼Œå³ä½¿åªå‡ºç°ä¸€æ¡æŒ‡ä»¤ï¼Œä¹Ÿä¸èƒ½è®¤ä¸ºå®é™…æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤æ˜¯åŸå­åŒ–çš„ï¼Œ**ä½†å¦‚æœå‡ºç°å¤šæ¡å­—èŠ‚ç æŒ‡ä»¤ï¼Œé‚£ä¹ˆå¿…ç„¶æ“ä½œæ²¡æœ‰åŸå­æ€§ã€‚**è¿™ä¹Ÿæ˜¯ volatile ä¿®é¥°çš„å˜é‡åªæ˜¯è½»é‡çº§åŒæ­¥ï¼Œä¸èƒ½åšåˆ°çœŸæ­£äº’æ–¥åŸå­åŒ–çš„åŸå› ã€‚<strong>å®ƒåªä¿è¯äº†å¯è§æ€§ã€‚</strong></p>
<p>â€ƒâ€ƒå› æ­¤ï¼Œåªæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸å¿…ç„¶è¦ä½¿ç”¨æ ‡å‡†åŒæ­¥æœºåˆ¶ï¼š</p>
<ol>
<li>è¿œç®—ç»“æœä¸ä¾èµ–æŒ‡å®šéæ ˆä¸Šå˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½å¤Ÿç¡®ä¿å•çº¿ç¨‹ä¿®æ”¹æŒ‡å®šå˜é‡çš„å½“å‰å€¼ã€‚</li>
<li>å˜é‡ä¸éœ€è¦ä¸å…¶ä»–å˜é‡å‚ä¸åŒä¸€ä¸ªä¸å˜æ€§çº¦æŸã€‚</li>
</ol>
<p>â€ƒâ€ƒæ­¤å¤–ï¼Œvolatileå…³é”®å­—è¿˜å¯ä»¥é€šè¿‡æ’å…¥å†…å­˜å±éšœï¼ˆmemory barierï¼‰é˜»æ­¢å†…å­˜æŒ‡ä»¤é‡æ’ï¼ˆinstruction reorderï¼‰ï¼Œé˜»æ­¢ç‰¹å®šçš„èµ‹å€¼é¡ºåºè¢«æ‰“ä¹±ã€‚è¿™ç‚¹åœ¨ Java 5ä»¥å‰æ˜¯åšä¸åˆ°çš„ï¼Œä¹Ÿå°±ä¼šç»å¸¸æ€§å¯¼è‡´ Double Check Lock åœ¨ Java 5ä»¥å‰å¤±è´¥ã€‚å…·ä½“åœ°è¯´ï¼Œç›¸å…³è”çš„æ“ä½œæ˜¯ä¸å¯é‡æ’åºçš„ã€‚ç›¸å…³è”çš„read-&gt;load-&gt;use/assign-&gt;store-&gt;writeå¯ä»¥çœ‹åšæ˜¯ä¸å¯è¢«é‡æ’æ’å…¥ä¸­é—´æŒ‡ä»¤çš„ï¼Œä¸€ä¸ªæŒ‡ä»¤ read å…ˆäºå¦ä¸€ä¸ªæŒ‡ä»¤ readï¼Œé‚£ä¹ˆæ‰€æœ‰ç›¸å…³è”çš„æŒ‡ä»¤éƒ½æ˜¯å‰è€…å…ˆäºåè€…ã€‚è¿™è¢«ç§°ä¸ºâ€œçº¿ç¨‹å†…è¡¨ç°ä¸ºç©¿è¡Œè¯­ä¹‰â€ï¼ˆWithin-Thread As-If-Serial Semanticsï¼‰ã€‚</p>
<h2 id="6-javaå†…å­˜æ¨¡å‹çš„-java-çš„ç‰¹æ€§">6.Javaå†…å­˜æ¨¡å‹çš„ï¼ˆJavaï¼‰çš„ç‰¹æ€§</h2>
<h2 id="6-1-åŸå­æ€§-atomicity">6.1 åŸå­æ€§ï¼ˆAtomicityï¼‰##</h2>
<p>â€ƒâ€ƒ8ä¸ªæ“ä½œï¼Œreadã€loadã€useã€assignã€storeã€writeè¿™å…­ä¸ªæ“ä½œæ˜¯å¿…é¡»åŸå­çš„ï¼ˆ64å­—èŠ‚çš„ longã€double éåŸå­æ€§æ˜¯å¯ä»¥ç”±lock å’Œ unlock çš„æ›´å¼ºåŸå­è¯­ä¹‰åŒ…è£¹èµ·æ¥è§„é¿æ‰çš„ï¼‰ã€‚lock å’Œ unlock æ“ä½œè™½ç„¶ä¸æ˜¯å­—èŠ‚ç ï¼Œä½†å‡ ä¹åŒæ„çš„ monitoerenterå’Œmonitorexitå´æ˜¯å­—èŠ‚ç æŒ‡ä»¤ã€‚</p>
<h2 id="6-2-å¯è§æ€§-visibility">6.2 å¯è§æ€§ï¼ˆVisibilityï¼‰##</h2>
<p>â€ƒâ€ƒä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹ï¼Œç«‹åˆ»å¯ä»¥è¢«å¦ä¸€ä¸ªçº¿ç¨‹çœ‹åˆ°ï¼Œæ–¹æ³•ä¸»è¦æœ‰ä¸‰ä¸ªï¼š</p>
<ul>
<li>åŒæ­¥å—</li>
<li>final ï¼ˆfinal å¹¶ä¸æ˜¯ä¸å¯æ›´æ”¹çš„ï¼Œæ‰€ä»¥ä¾ç„¶æœ‰å·¥ä½œå†…å­˜ä¿®æ”¹åflushçš„é—®é¢˜ï¼‰</li>
<li>volatile</li>
</ul>
<h2 id="6-3-æœ‰åºæ€§-ordering">6.3 æœ‰åºæ€§ï¼ˆOrderingï¼‰##</h2>
<p>â€ƒâ€ƒvolatileå’ŒåŒæ­¥å—å¯ä»¥ä¿è¯è¿™ç‚¹ã€‚æ–¹æ³•å†…çš„æŒ‡ä»¤ä¸ä¼šè¢«é‡æ’ï¼Œæ˜¯ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„ä¸ä¼šäº§ç”Ÿç‰¹åˆ«å‰¯ä½œç”¨çš„ä¿è¯ã€‚</p>
<h2 id="6-4-volatile-å’ŒåŒæ­¥å—æ¯”è¾ƒ">6.4 volatile å’ŒåŒæ­¥å—æ¯”è¾ƒ##</h2>
<p>â€ƒâ€ƒvolatileä¸å…·æœ‰åŸå­æ€§ï¼Œå…¶ä»–åœºæ™¯volatileå’ŒåŒæ­¥å—éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p>
<h2 id="6-5-å…ˆè¡Œå‘ç”ŸåŸåˆ™-happens-before">6.5 å…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼ˆhappens-beforeï¼‰##</h2>
<p>â€ƒâ€ƒJVM ä¸ºç¨‹åºä¸­æ‰€æœ‰çš„æ“ä½œå®šä¹‰äº†ä¸€ä¸ªååºå…³ç³»ï¼ˆååºå…³ç³» Ï€ æ˜¯é›†åˆä¸Šçš„ä¸€ç§å…³ç³»ï¼Œæ®æœ‰åå¯¹ç§°ã€è‡ªåå’Œä¼ é€’å±æ€§ã€‚ä½†å¯¹äºä»»æ„ä¸¤ä¸ªå…ƒç´ xï¼Œyæ¥è¯´ï¼Œå¹¶ä¸éœ€è¦ä¸€å®šæ»¡è¶³ x Ï€ yï¼Œ y Ï€ xçš„å…³ç³»ã€‚æˆ‘ä»¬æ¯å¤©éƒ½åœ¨ä½¿ç”¨ååºå…³ç³»è¡¨è¾¾å–œå¥½ã€‚ï¼‰ï¼Œç§°ä¹‹ä¸º Happens-Beforeã€‚åªæœ‰æ“ä½œ A å’Œæ“ä½œ B ä¹‹é—´æ»¡è¶³ Happens-Before å…³ç³»ï¼Œæ‰èƒ½ä¿è¯<br>
ä¿è¯æ“ä½œ B ä¸€å®šèƒ½å¤Ÿçœ‹åˆ°æ“ä½œ A çš„ç»“æœã€‚</p>
<p>â€ƒâ€ƒHappens-Before çš„å…«æ¡åŸåˆ™åŒ…æ‹¬ï¼š</p>
<ul>
<li>ç¨‹åºé¡ºåºåŸåˆ™ï¼ˆProgram Order Ruleï¼‰ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ç¨‹åºä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œçº¿æ€§å‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œã€‚è¿™ä¸€æ¡å¹¶ä¸ç»å¯¹ï¼Œé¦–å…ˆè¦è€ƒè™‘æ§åˆ¶æµå¾ªç¯è·³è½¬çš„é—®é¢˜ï¼Œå…¶æ¬¡æ˜¯ï¼Œå¦‚æœåæ“ä½œæ— æ³•æ„ŸçŸ¥å‰æ“ä½œï¼ˆå³ä¸å­˜åœ¨ä¾èµ–å…³ç³»ï¼‰ï¼Œåˆ™æŒ‡ä»¤é‡æ’ä»ç„¶å¯èƒ½å‘ç”Ÿã€‚</li>
<li>ç›‘è§†å™¨é”å®šåŸåˆ™ï¼ˆMonitor Lock Ruleï¼‰ï¼šä¸€ä¸ª unlock æ“ä½œæ—¶é—´é¡ºåºä¸Šå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚ï¼ˆå•çº¯çš„lock æ“ä½œè¯­ä¹‰åªæä¾›äº†å¯è§æ€§ï¼Œè¿™æ¡åŸåˆ™è¿˜ä¿è¯äº†æœ‰åºæ€§ã€‚ï¼‰</li>
<li>volatile å˜é‡åŸåˆ™ï¼ˆvolatile variable ruleï¼‰ï¼šå¯¹ volatile å˜é‡çš„å†™å…¥æ“ä½œï¼Œå¿…é¡»è¦åœ¨è¯»å–æ“ä½œæ—¶é—´é¡ºåºä¹‹å‰è¿›è¡Œã€‚</li>
<li>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼ˆThread Start Ruleï¼‰ï¼šThreadå¯¹è±¡çš„ start()æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚</li>
<li>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼ˆThread Termination Ruleï¼‰ï¼šçº¿ç¨‹ä¸­æ‰€æœ‰æ“ä½œï¼Œéƒ½å…ˆè¡Œå‘ç”Ÿäºçº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ã€‚å¸¸è§ç»ˆæ­¢æ£€æµ‹æ˜¯ Thread.join() çš„è¿”å›ï¼ŒThread.isAlive()çš„è¿”å›ã€‚</li>
<li>çº¿ç¨‹ä¸­æ–­åŸåˆ™ï¼ˆThread Interruptionï¼‰ï¼šå¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹æ£€æµ‹ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿã€‚å¸¸è§æ£€æµ‹äº‹ä»¶çš„æ–¹æ³•æ˜¯ Thread.interrupted()ã€‚</li>
<li>å¯¹è±¡ç»ˆç»“åŸåˆ™ï¼ˆFinalizer Ruleï¼‰ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize()æ–¹æ³•çš„å¼€å§‹ã€‚</li>
<li>ä¼ é€’æ€§ï¼ˆTransitivityï¼‰ æ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cã€‚</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://magicliang.github.io">magicliang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://magicliang.github.io/2026/02/07/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/">https://magicliang.github.io/2026/02/07/JVM-%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JVM/">JVM</a><a class="post-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a><a class="post-meta__tags" href="/tags/%E5%86%85%E5%AD%98/">å†…å­˜</a><a class="post-meta__tags" href="/tags/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">Javaå†…å­˜æ¨¡å‹</a><a class="post-meta__tags" href="/tags/happens-before/">happens-before</a></div><div class="post-share"><div class="social-share" data-image="/img/wall-paper-112.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/01/12/Java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" title="Java å¹¶å‘ç¼–ç¨‹ç¬”è®°"><img class="cover" src="/2026/01/12/Java-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/volatile%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7%E5%BD%B1%E5%93%8D.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-12</div><div class="info-item-2">Java å¹¶å‘ç¼–ç¨‹ç¬”è®°</div></div><div class="info-2"><div class="info-item-1"> juc.xmind å†™åœ¨å‰é¢çš„è¯ å¹¶å‘ç¼–ç¨‹æœ€æ—©çš„å®è·µéƒ½åœ¨æ“ä½œç³»ç»Ÿé‡Œã€‚ ç®¡ç¨‹ ç†è®ºå’Œå®è·µä¹‹é—´æ˜¯æœ‰é¸¿æ²Ÿçš„ï¼Œè¦å¼¥åˆè¿™ç§é¸¿æ²Ÿï¼Œé€šå¸¸éœ€è¦æˆ‘ä»¬å»å­¦ä¹ åˆ«äººçš„å®è·µã€‚æ¯”å¦‚å¹¶å‘çš„æ ‡å‡†è®¾è®¡æ€æƒ³æ¥è‡ªäºæ“ä½œç³»ç»Ÿé‡Œçš„ç®¡ç¨‹ï¼ˆmonitorï¼‰ï¼Œæˆ‘ä»¬åº”å½“å­¦ä¹ ç®¡ç¨‹ï¼Œè¿›è€Œäº†è§£æ ‡å‡†çš„å¹¶å‘æ¨¡å‹-ç®¡ç†å…±äº«å˜é‡å’Œçº¿ç¨‹ï¼ˆå¹¶å‘ä»»åŠ¡ï¼‰é—´é€šä¿¡çš„åŸºæœ¬ç†è®ºæ¨¡å‹ã€‚ ä»€ä¹ˆæ˜¯ç®¡ç¨‹ ç®¡ç¨‹ï¼ˆMonitorï¼‰æ˜¯ä¸€ç§å¹¶å‘ç¼–ç¨‹çš„æŠ½è±¡æ•°æ®ç»“æ„ï¼Œç”± C.A.R. Hoare å’Œ Per Brinch Hansen åœ¨ 1970 å¹´ä»£æå‡ºã€‚å®ƒæ¯”&quot;é”&quot;çš„æ¦‚å¿µæ›´å¤§â€”â€”é”åªæ˜¯ç®¡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚ ç®¡ç¨‹çš„å®Œæ•´å®šä¹‰ï¼š 1234567891011121314151617181920212223242526272829303132â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                        ç®¡ç¨‹ï¼ˆMonitorï¼‰                               â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€...</div></div></div></a><a class="pagination-related" href="/2026/01/18/%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97/" title="æ— é”é˜Ÿåˆ—"><img class="cover" src="/2026/01/18/%E6%97%A0%E9%94%81%E9%98%9F%E5%88%97/%E8%AE%A1%E7%AE%97%E6%9C%BACPU%E4%B8%8E%E7%BC%93%E5%AD%98%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-18</div><div class="info-item-2">æ— é”é˜Ÿåˆ—</div></div><div class="info-2"><div class="info-item-1">Java ä¸€è¯»ä¸€å†™ï¼ˆSPSCï¼‰ï¼šMemory Barrier + Volatile 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657/** * Single-Producer Single-Consumer (SPSC) æ— é”ç¯å½¢é˜Ÿåˆ—ã€‚ * * &lt;p&gt;åŸç†è¯´æ˜ï¼š * - ä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ &#123;@code offer()&#125;ï¼Œä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ &#123;@code poll()&#125;ã€‚ * - ç”±äºæ²¡æœ‰å†™ç«äº‰ï¼Œæ— éœ€ CASï¼›åªéœ€ä¿è¯å†™æ“ä½œå¯¹æ¶ˆè´¹è€…å¯è§ã€‚ * - ä½¿ç”¨ä¸¤ä¸ª volatile ç´¢å¼•ï¼ˆhead/tailï¼‰å»ºç«‹ happens-before å…³ç³»ï¼š *   ç”Ÿäº§è€…å†™å…¥å…ƒç´  â†’ volatile å†™ tail â†’ æ¶ˆè´¹è€… volatile è¯» tail â†’ è¯»å–å…ƒç´ ã€‚ * - è¿™æœ¬è´¨ä¸Šåˆ©ç”¨äº† Java å†…å­˜æ¨¡å‹ä¸­çš„â€œvolatile å†™-è¯»â€å†…å­˜å±éšœï¼ˆStoreLoadï¼‰ï¼Œ *   ...</div></div></div></a><a class="pagination-related" href="/2026/01/24/Java-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AC%94%E8%AE%B0/" title="Java çº¿ç¨‹æ± ç¬”è®°"><img class="cover" src="/2026/01/24/Java-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AC%94%E8%AE%B0/ThreadPoolExecutorUML%E7%B1%BB%E5%9B%BE.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-24</div><div class="info-item-2">Java çº¿ç¨‹æ± ç¬”è®°</div></div><div class="info-2"><div class="info-item-1">ä»æ‰§è¡Œå™¨åˆ°çº¿ç¨‹æ± ï¼ˆfrom executor interface to thread pool implementationï¼‰  Pooling is the grouping together of resources (assets, equipment, personnel, effort, etc.) for the purposes of maximizing advantage or minimizing risk to the users. The term is used in finance, computing and equipment management.â€”â€”wikipedia â€œæ± åŒ–â€æ€æƒ³ä¸ä»…ä»…èƒ½åº”ç”¨åœ¨è®¡ç®—æœºé¢†åŸŸï¼Œåœ¨é‡‘èã€è®¾å¤‡ã€äººå‘˜ç®¡ç†ã€å·¥ä½œç®¡ç†ç­‰é¢†åŸŸä¹Ÿæœ‰ç›¸å…³çš„åº”ç”¨ã€‚ åœ¨è®¡ç®—æœºé¢†åŸŸä¸­çš„è¡¨ç°ä¸ºï¼šç»Ÿä¸€ç®¡ç†ITèµ„æºï¼ŒåŒ…æ‹¬æœåŠ¡å™¨ã€å­˜å‚¨ã€å’Œç½‘ç»œèµ„æºç­‰ç­‰ã€‚é€šè¿‡å…±äº«èµ„æºï¼Œä½¿ç”¨æˆ·åœ¨ä½æŠ•å…¥ä¸­è·ç›Šã€‚é™¤å»çº¿ç¨‹æ± ï¼Œè¿˜æœ‰å…¶ä»–æ¯”è¾ƒå…¸å‹çš„å‡ ç§ä½¿ç”¨ç­–ç•¥åŒ…æ‹¬ï¼š å†…å­˜æ± (Memory Pooling)ï¼šé¢„å…ˆç”³è¯·å†…å­˜ï¼Œæå‡ç”³è¯·å†…å­˜é€Ÿåº¦ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ã€‚ è¿æ¥æ± (Connection Pool...</div></div></div></a><a class="pagination-related" href="/2026/01/19/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/" title="çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–"><img class="cover" src="/2026/01/19/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/synchronized%E5%8E%9F%E7%90%86.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-19</div><div class="info-item-2">çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–</div></div><div class="info-2"><div class="info-item-1"> ç‰ˆæœ¬è¯´æ˜ï¼šæœ¬æ–‡ä¸»è¦åŸºäº JDK 6 ~ JDK 14 çš„ HotSpot è™šæ‹Ÿæœºå®ç°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä» JDK 15 å¼€å§‹ï¼Œåå‘é”å·²è¢«é»˜è®¤å…³é—­å¹¶æ ‡è®°ä¸ºåºŸå¼ƒï¼ˆJEP 374ï¼‰ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ JDK 15+ï¼Œæ–‡ä¸­å…³äºåå‘é”çš„å†…å®¹ä»…ä½œä¸ºå†å²å‚è€ƒã€‚  çº¿ç¨‹å®‰å…¨ ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ â€œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœä¸ç”¨è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸‹çš„è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹æ³•è¿›è¡Œä»»ä½•å…¶ä»–çš„åè°ƒæ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚â€ ç›¸å¯¹çš„çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥åˆ†æˆäº”ä¸ªç­‰çº§ã€‚ä½†åœ¨æ·±å…¥è®¨è®ºçº¿ç¨‹å®‰å…¨çš„åˆ†ç±»ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£ Java å†…å­˜æ¨¡å‹â€”â€”å®ƒæ˜¯ç†è§£çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ç†è®ºåŸºç¡€ã€‚ Java å†…å­˜æ¨¡å‹åŸºç¡€ Java å†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰æ˜¯ Java è¯­è¨€è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œå®šä¹‰äº†å¤šçº¿ç¨‹ç¨‹åºä¸­å…±äº«å˜é‡çš„è®¿é—®è§„åˆ™ã€‚ç†è§£ JMM æ˜¯ç†è§£çº¿ç¨‹å®‰å…¨é—®é¢˜çš„åŸºç¡€ã€‚ ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜æ¨¡å‹ï¼Ÿ ç°ä»£è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒCPU ä¸ä¸»å†…å­˜ä¹‹é—´å­˜åœ¨å·¨å¤§çš„é€Ÿåº¦å·®å¼‚ã€‚ä¸ºäº†å¼¥è¡¥è¿™ä¸€å·®è·ï¼Œç¡¬ä»¶å±‚é¢å¼•å…¥äº†å¤šçº§ç¼“å­˜ï¼ˆL1ã€L2ã€L3 Cacheï¼‰ã€‚è¿™å¸¦æ¥äº†ä¸€ä¸ªé—®...</div></div></div></a><a class="pagination-related" href="/2017/10/23/%E6%98%82%E8%B4%B5%E7%9A%84%E5%BC%82%E5%B8%B8/" title="æ˜‚è´µçš„å¼‚å¸¸"><img class="cover" src="/img/wall-paper-56.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2017-10-23</div><div class="info-item-2">æ˜‚è´µçš„å¼‚å¸¸</div></div><div class="info-2"><div class="info-item-1">æŠ›å‡ºé—®é¢˜ Joshua Bloch åœ¨ã€ŠEffective Javaã€‹çš„ Item 57 é‡Œæ˜ç¡®åœ°æåˆ°è¿‡ï¼Œä¸è¦è¯•å›¾ç”¨ Exception çš„è·³è½¬æ¥ä»£æ›¿æ­£å¸¸çš„ç¨‹åºæ§åˆ¶æµã€‚ä»–åˆ—ä¸¾äº†å¾ˆå¤šåŸå› ï¼Œä½†ç‰¹åˆ«æåˆ°äº†æŠ›å‡ºå¼‚å¸¸ä¼šä½¿å¾—æ•´ä¸ªç¨‹åºè¿è¡Œå˜æ…¢ã€‚æŠ›å‡ºå¼‚å¸¸è¿œæ¯”æ™®é€šçš„ returnã€break ç­‰æ“ä½œå¯¹æ§åˆ¶æµã€æ•°æ®æµçš„æ€§èƒ½å½±å“è¦å¤§ï¼Œå®ƒå°±åªé€‚åˆæ‹¿æ¥ä½œå¼‚å¸¸åˆ†æ”¯çš„æ§åˆ¶è¯­å¥ï¼Œè€Œä¸èƒ½æ‹¿æ¥ç¼–å†™æ­£å¸¸çš„é€»è¾‘ã€‚  Throwing exception is expensive.  è¿™å¥è¯åœ¨ Java çš„ç¨‹åºå‘˜ä¸–ç•Œé‡Œé¢å·²ç»æˆä¸ºè€ç”Ÿå¸¸è°ˆï¼Œå´å¾ˆå°‘æœ‰äººè°ˆåŠåˆ°åº•æŠ›å‡ºå¼‚å¸¸æ¯”æ­£å¸¸çš„ç¨‹åºè·³è½¬è¿”å›æ…¢åœ¨å“ªé‡Œï¼Œæœ‰å¤šæ…¢ã€‚&quot;ä¸è¦æ»¥ç”¨å¼‚å¸¸&quot;å¥½åƒä¸€ä¸ªçŒ´å­å®šå¾‹ï¼Œäººä»¬çŸ¥é“ä¸èƒ½è¿™ä¹ˆåšï¼Œå´ä¸æ˜ç™½ä¸ºä»€ä¹ˆä¸èƒ½è¿™ä¹ˆåšã€‚ æ­¤å‰è¯»äº†ä¸€ä½åŒäº‹å†™çš„å¥½æ–‡ã€ŠJavaè™šæ‹Ÿæœºæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ã€‹ï¼Œæ·±å…¥åœ°åˆ†æäº† JVM å¯¹å¼‚å¸¸è·³è½¬çš„å¤„ç†è¿‡ç¨‹ï¼šJVM ä¼šé€šè¿‡å¼‚å¸¸è¡¨çš„æœºåˆ¶ï¼Œä¼˜åŒ–å¼‚å¸¸æŠ›å‡ºå’Œæ­£å¸¸è¿”å›ä¹‹é—´çš„æ€§èƒ½å·®å¼‚ã€‚ä»…ä»ç¨‹åºè®¡æ•°å™¨çš„ç§»åŠ¨ä¸Šæ¥è®²ï¼ŒæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸å¯¹æ ˆå¸§çš„å¼¹æ ˆå¹¶ä¸æ¯”ç›´æ¥è¿”å›æ›´æ˜‚è´µã€‚å†™åœ¨å‰å¤´çš„ç»“è®ºæ˜¯ï¼š&quot;try-catch è¯­å¥å—å‡ ä¹ä¸ä¼šå½±å“ç¨‹åºè¿è¡Œæ€§èƒ½ï¼...</div></div></div></a><a class="pagination-related" href="/2017/10/30/JVM-%E4%B8%8E%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96/" title="JVM ä¸ç¼–è¯‘ä¼˜åŒ–"><img class="cover" src="/img/wall-paper-120.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2017-10-30</div><div class="info-item-2">JVM ä¸ç¼–è¯‘ä¼˜åŒ–</div></div><div class="info-2"><div class="info-item-1">Java çš„ç¼–è¯‘åˆ†æœŸï¼Œè‡³å°‘å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ˆæœ‰äº›æƒ…å†µä¸‹è¿˜æœ‰é¢å¤–çš„ç¬¬ä¸‰ç§ç¼–è¯‘è¿‡ç¨‹ï¼‰ï¼š  ç¼–è¯‘å‰ç«¯ï¼ˆå‰ç«¯ç¼–è¯‘ï¼‰ï¼šæŠŠ *.java å˜æˆ *.class æ–‡ä»¶çš„è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯æŠŠæºè¯­è¨€æ–‡ä»¶å˜æˆä¸­é—´è¯­è¨€æ–‡ä»¶çš„è¿‡ç¨‹ã€‚å…¸å‹çš„ä¾‹å­æœ‰ï¼šjavacã€Eclipse çš„ ECJ çš„å·¥ä½œè¿‡ç¨‹ã€‚ ç¼–è¯‘åç«¯ï¼ˆåç«¯ç¼–è¯‘ï¼‰ï¼šç”± JITï¼ˆJust In Time Compilerï¼‰æŠŠä¸­é—´è¯­è¨€ï¼ˆå­—èŠ‚ç ï¼‰è½¬æ¢æˆäºŒè¿›åˆ¶ç›®æ ‡ä½“ç³»ç»“æ„æœºå™¨ç çš„è¿‡ç¨‹ã€‚å…¸å‹çš„ä¾‹å­æœ‰ HotSpot çš„ C1ã€C2 ç¼–è¯‘å™¨çš„å·¥ä½œè¿‡ç¨‹ã€‚ AOTï¼ˆAhead Of Timeï¼‰ç¼–è¯‘å™¨ç›´æ¥æŠŠæºä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶ç›®æ ‡ä½“ç³»ç»“æ„æœºå™¨ç çš„è¿‡ç¨‹ã€‚  æ—©æœŸï¼ˆç¼–è¯‘ï¼‰ä¼˜åŒ– javac è‡ªä» 1.3 ç‰ˆæœ¬å·²ç»ä¸å†æ”¯æŒ -O çš„ä¼˜åŒ–äº†ã€‚æ‰€æœ‰çš„ä¼˜åŒ–ç­–ç•¥é›†ä¸­åˆ°åç«¯ç¼–è¯‘é‡Œã€‚è¿™æ ·æ²¡æœ‰ç»è¿‡ javac ç¼–è¯‘çš„ JRubyã€Jython ç¨‹åºï¼Œä¹Ÿå¯ä»¥äº«å—åˆ° JVM çš„ä¼˜åŒ–ç¦åˆ©ã€‚ javacçš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå¤§è‡´ä¸Šæ˜¯ï¼š  è§£æå’Œå¡«å……ç¬¦å·è¡¨ï¼ˆParse and Enterï¼‰ã€‚ æ³¨è§£å¤„ç†ï¼ˆAnnotation Processingï¼ŒJava 5ä»¥ååŠ å…¥çš„è¿‡ç¨‹ï¼‰ã€‚ åˆ†æä¸å­—èŠ‚ç ç”Ÿæˆï¼ˆAnalyze an...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">JVM çš„å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E6%80%BB%E8%A7%88"><span class="toc-number">1.1.</span> <span class="toc-text">æ¨¡å¼æ€»è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E4%BB%8E%E7%A1%AC%E4%BB%B6%E5%88%B0%E6%8A%BD%E8%B1%A1%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-jmm"><span class="toc-number">1.2.</span> <span class="toc-text">ä¸€ã€ä»ç¡¬ä»¶åˆ°æŠ½è±¡ï¼šä¸ºä»€ä¹ˆéœ€è¦ JMM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-cpu-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%80%A7%E8%83%BD%E9%B8%BF%E6%B2%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 CPU æ¶æ„çš„æ€§èƒ½é¸¿æ²Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE-mesi"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%B8%BA%E4%BD%95%E9%9C%80%E8%A6%81-jmm"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 ä¸ºä½•éœ€è¦ JMM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-jmm-%E6%A0%B8%E5%BF%83%E6%8A%BD%E8%B1%A1"><span class="toc-number">1.3.</span> <span class="toc-text">äºŒã€JMM æ ¸å¿ƒæŠ½è±¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%B8%BB%E5%86%85%E5%AD%98%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AD%98"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%85%AB%E7%A7%8D%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C-jls-17-4-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 å…«ç§å†…å­˜æ“ä½œï¼ˆJLS Â§17.4.1ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 æŒ‡ä»¤é‡æ’åº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E9%87%8D%E6%8E%92%E5%BA%8F%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">2.3.1 é‡æ’åºçš„æœ¬è´¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E9%87%8D%E6%8E%92%E5%BA%8F%E7%9A%84%E4%B8%89%E4%B8%AA%E5%B1%82%E6%AC%A1"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2.3.2 é‡æ’åºçš„ä¸‰ä¸ªå±‚æ¬¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E9%87%8D%E6%8E%92%E5%BA%8F%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">2.3.3 é‡æ’åºç¤ºä¾‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-4-%E9%87%8D%E6%8E%92%E5%BA%8F%E7%9A%84%E4%BB%A3%E4%BB%B7%E4%B8%8E%E6%94%B6%E7%9B%8A"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">2.3.4 é‡æ’åºçš„ä»£ä»·ä¸æ”¶ç›Š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-5-jmm-%E7%9A%84%E5%BA%94%E5%AF%B9%EF%BC%9A%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">2.3.5 JMM çš„åº”å¯¹ï¼šå†…å­˜å±éšœ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-happens-before-%E5%85%B3%E7%B3%BB"><span class="toc-number">1.4.</span> <span class="toc-text">ä¸‰ã€happens-before å…³ç³»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%BB%80%E4%B9%88%E6%98%AF-happens-before"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 ä»€ä¹ˆæ˜¯ happens-before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-happens-before-%E7%9A%84%E5%85%AB%E6%9D%A1%E8%A7%84%E5%88%99"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 happens-before çš„å…«æ¡è§„åˆ™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%8E%A8%E5%AF%BC%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 æ¨å¯¼ç¤ºä¾‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E4%B8%89%E5%A4%A7%E7%89%B9%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-number">1.5.</span> <span class="toc-text">å››ã€ä¸‰å¤§ç‰¹æ€§ä¿éšœ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%8E%9F%E5%AD%90%E6%80%A7-atomicity"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 åŸå­æ€§ï¼ˆAtomicityï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%8F%AF%E8%A7%81%E6%80%A7-visibility"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 å¯è§æ€§ï¼ˆVisibilityï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E6%9C%89%E5%BA%8F%E6%80%A7-ordering"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 æœ‰åºæ€§ï¼ˆOrderingï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%B8%8E%E6%8C%87%E9%92%88%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.6.</span> <span class="toc-text">äº”ã€å¯¹è±¡å†…å­˜å¸ƒå±€ä¸æŒ‡é’ˆå‹ç¼©</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 å¯¹è±¡çš„å†…å­˜ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-mark-word-%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 Mark Word çš„ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E6%8C%87%E9%92%88%E5%8E%8B%E7%BC%A9-compressed-oops"><span class="toc-number">1.6.3.</span> <span class="toc-text">5.3 æŒ‡é’ˆå‹ç¼©ï¼ˆCompressed OOPsï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%F0%9F%94%91-%E6%A8%A1%E5%BC%8F%E6%8F%90%E7%82%BC"><span class="toc-number">1.7.</span> <span class="toc-text">å…­ã€ğŸ”‘ æ¨¡å¼æç‚¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%80%EF%BC%9A%E5%86%99%E5%88%B7%E8%AF%BB%E6%B8%85"><span class="toc-number">1.7.1.</span> <span class="toc-text">æ¨¡å¼ä¸€ï¼šå†™åˆ·è¯»æ¸…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%BA%8C%EF%BC%9A%E9%A1%BA%E5%BA%8F%E9%94%81"><span class="toc-number">1.7.2.</span> <span class="toc-text">æ¨¡å¼äºŒï¼šé¡ºåºé”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E4%B8%89%EF%BC%9A%E5%81%8F%E5%BA%8F%E4%BC%A0%E9%80%92"><span class="toc-number">1.7.3.</span> <span class="toc-text">æ¨¡å¼ä¸‰ï¼šååºä¼ é€’</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%AE%9E%E8%B7%B5%E8%A6%81%E7%82%B9"><span class="toc-number">1.8.</span> <span class="toc-text">ä¸ƒã€ç”Ÿäº§ç¯å¢ƒå®è·µè¦ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-volatile-%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99"><span class="toc-number">1.8.1.</span> <span class="toc-text">7.1 volatile çš„ä½¿ç”¨åŸåˆ™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5%E9%94%81%E5%AE%9A%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.8.2.</span> <span class="toc-text">7.2 åŒé‡æ£€æŸ¥é”å®šçš„æ­£ç¡®å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E4%BC%AA%E5%85%B1%E4%BA%AB-false-sharing-%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.3.</span> <span class="toc-text">7.3 ä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%AF%8A%E6%96%AD"><span class="toc-number">1.8.4.</span> <span class="toc-text">7.4 ç›‘æ§ä¸è¯Šæ–­</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E6%A8%A1%E5%BC%8F%E9%80%9F%E6%9F%A5%E8%A1%A8"><span class="toc-number">1.9.</span> <span class="toc-text">å…«ã€æ¨¡å¼é€ŸæŸ¥è¡¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.10.</span> <span class="toc-text">å‚è€ƒæ–‡çŒ®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-jvm-%E7%9A%84%E5%AF%B9%E8%B1%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.11.</span> <span class="toc-text">3.JVM çš„å¯¹è±¡ä¿¡æ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%86%85%E5%AD%98%E9%97%B4-%E4%B8%BB%E5%86%85%E5%AD%98%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AD%98-%E7%9B%B8%E4%BA%92%E6%93%8D%E4%BD%9C"><span class="toc-number">1.12.</span> <span class="toc-text">4.å†…å­˜é—´ï¼ˆä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ï¼‰ç›¸äº’æ“ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-volatile%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">1.13.</span> <span class="toc-text">5.volatileå…³é”®å­—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%9A%84-java-%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-number">1.14.</span> <span class="toc-text">6.Javaå†…å­˜æ¨¡å‹çš„ï¼ˆJavaï¼‰çš„ç‰¹æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%8E%9F%E5%AD%90%E6%80%A7-atomicity"><span class="toc-number">1.15.</span> <span class="toc-text">6.1 åŸå­æ€§ï¼ˆAtomicityï¼‰##</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%8F%AF%E8%A7%81%E6%80%A7-visibility"><span class="toc-number">1.16.</span> <span class="toc-text">6.2 å¯è§æ€§ï¼ˆVisibilityï¼‰##</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%9C%89%E5%BA%8F%E6%80%A7-ordering"><span class="toc-number">1.17.</span> <span class="toc-text">6.3 æœ‰åºæ€§ï¼ˆOrderingï¼‰##</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-volatile-%E5%92%8C%E5%90%8C%E6%AD%A5%E5%9D%97%E6%AF%94%E8%BE%83"><span class="toc-number">1.18.</span> <span class="toc-text">6.4 volatile å’ŒåŒæ­¥å—æ¯”è¾ƒ##</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%85%88%E8%A1%8C%E5%8F%91%E7%94%9F%E5%8E%9F%E5%88%99-happens-before"><span class="toc-number">1.19.</span> <span class="toc-text">6.5 å…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼ˆhappens-beforeï¼‰##</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2017 - 2026 By magicliang</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">ç°¡</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/js/tw_cn.js?v=5.5.2"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="/"></script></div></body></html>